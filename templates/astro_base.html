<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç UPlanet Messenger - Nostr + IPFS</title>
    <!-- Nostr integration -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js"></script>
    <!-- Common.js with enhanced UPlanet NOSTR functions -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/common.js"></script>
    <!-- Nostr Private Messaging - Functions for encrypted direct and group messages -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.private.js"></script>
    <!-- Markdown parser for Kind 30023 -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/marked.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="{{ myIPFS }}/ipns/copylaradio.com/leaflet.css"/>
    <!-- Leaflet JavaScript -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/leaflet.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #4ade80;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
        }
        
        .subtitle {
            text-align: center;
            color: #94a3b8;
            font-size: 1.1em;
            margin-bottom: 30px;
            font-weight: 300;
        }
        
        /* Nostr Section Styles */
        .nostr-section {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #e2e8f0;
        }
        
        input, textarea, select, button {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8f0;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4ade80;
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3);
        }
        
        button:disabled {
            background: rgba(148, 163, 184, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .photo-upload {
            border: 2px dashed #4ade80;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(74, 222, 128, 0.05);
        }
        
        .photo-upload:hover {
            border-color: #22c55e;
            background: rgba(74, 222, 128, 0.1);
            transform: translateY(-2px);
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .location-info {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .location-info strong {
            display: inline-block;
            margin-right: 5px;
        }
        
        /* Tag Selection Styles */
        .tags-section {
            margin: 15px 0;
        }
        
        .tags-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .tag-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .tag-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .tag-checkbox label {
            margin: 0;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* Map Styles */
        .map-accordion {
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            overflow: hidden;
        }
        
        .map-accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .map-accordion-header:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        
        .map-toggle {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .map-toggle.expanded {
            transform: rotate(180deg);
        }
        
        .map-accordion-content {
            padding: 15px;
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .map-accordion-content.closed {
            max-height: 0;
            padding: 0 15px;
        }
        
        .map-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .coord-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .coord-input label {
            font-weight: bold;
            color: #e2e8f0;
            margin: 0;
            min-width: 30px;
            font-size: 0.8em;
        }
        
        .coord-input input {
            width: 80px;
            padding: 6px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 0.85em;
        }
        
        .map-button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s ease;
            width: auto;
        }
        
        .map-button:hover {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(74, 222, 128, 0.3);
        }
        
        .map-button.secondary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
        }
        
        .map-button.secondary:hover {
            background: linear-gradient(135deg, #4f46e5, #4338ca);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }
        
        #mini-map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            background: #f0f0f0;
            min-height: 400px;
        }
        
        /* Kind Selection Styles */
        .kind-selection {
            margin: 15px 0;
        }
        
        .kind-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .kind-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .kind-option input[type="radio"] {
            width: auto;
            margin: 0;
        }
        
        /* Auth Mode Styles */
        .auth-mode {
            margin: 15px 0;
        }
        
        .nsec-input {
            display: none;
            margin-top: 10px;
        }
        
        .nsec-input.visible {
            display: block;
        }
        
        /* Status Messages */
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .status-success {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .status-info {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: #6366f1;
        }
        
        /* Latest Message Styles */
        .reply-item {
            background: rgba(255, 255, 255, 0.03);
            border-left: 3px solid #6366f1;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .reply-item:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: #4ade80;
            transform: translateX(5px);
        }
        
        /* Markdown styles also for replies */
        .reply-item h1,
        .reply-item h2,
        .reply-item h3 {
            color: #4ade80;
            margin-top: 0.8em;
            margin-bottom: 0.4em;
        }
        
        .reply-item h1 { font-size: 1.5em; }
        .reply-item h2 { font-size: 1.3em; }
        .reply-item h3 { font-size: 1.1em; }
        
        .reply-item p {
            margin-bottom: 0.8em;
        }
        
        .reply-item code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #fbbf24;
            font-size: 0.9em;
        }
        
        .reply-item pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin-bottom: 0.8em;
        }
        
        .reply-item pre code {
            background: none;
            padding: 0;
        }
        
        .reply-item blockquote {
            border-left: 3px solid #6366f1;
            padding-left: 10px;
            margin-left: 0;
            margin-bottom: 0.8em;
            font-style: italic;
            color: #94a3b8;
        }
        
        .reply-item a {
            color: #4ade80;
            text-decoration: underline;
        }
        
        .reply-item img {
            max-width: 100%;
            border-radius: 6px;
            margin: 8px 0;
        }
        
        /* Markdown Content Styles for Kind 30023 */
        #latest-message-content h1,
        #latest-message-content h2,
        #latest-message-content h3 {
            color: #4ade80;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        
        #latest-message-content h1 { font-size: 1.8em; }
        #latest-message-content h2 { font-size: 1.5em; }
        #latest-message-content h3 { font-size: 1.2em; }
        
        #latest-message-content p {
            margin-bottom: 1em;
        }
        
        #latest-message-content ul, 
        #latest-message-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }
        
        #latest-message-content code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #fbbf24;
        }
        
        #latest-message-content pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 1em;
        }
        
        #latest-message-content pre code {
            background: none;
            padding: 0;
        }
        
        #latest-message-content blockquote {
            border-left: 4px solid #6366f1;
            padding-left: 15px;
            margin-left: 0;
            margin-bottom: 1em;
            font-style: italic;
            color: #94a3b8;
        }
        
        #latest-message-content a {
            color: #4ade80;
            text-decoration: underline;
        }
        
        #latest-message-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        #latest-message-content hr {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin: 1.5em 0;
        }
        
        #latest-message-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }
        
        #latest-message-content table th,
        #latest-message-content table td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            text-align: left;
        }
        
        #latest-message-content table th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: none;
            border-radius: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            max-width: none;
            max-height: none;
            box-shadow: none;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header h2 {
            margin: 0;
            color: #4ade80;
            font-size: 1.5em;
        }
        
        .modal-close {
            color: #e2e8f0;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #ef4444;
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 0;
            height: calc(100vh - 80px);
            overflow: hidden;
        }
        
        .modal-body iframe {
            border-radius: 0;
            background: white;
            height: 100%;
        }
        
        /* Responsive Design */
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 10px auto;
            }
            
            .tags-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .map-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            #mini-map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç UPlanet Messenger</h1>
        <p class="subtitle">Nostr + IPFS decentralized messaging</p>
        
        <!-- API Detection Info -->
        <div id="api-info" class="status-message status-info" style="display: none;">
            <strong>üîó API Configuration:</strong><br>
            <span id="api-details"></span>
        </div>
        
        <!-- Nostr Authentication Section -->
        <div class="nostr-section">
            <h3 style="margin: 0 0 15px 0;">üîê Nostr Authentication</h3>
            
            <!-- Auth Mode Selection -->
            <div class="auth-mode">
                <label>Authentication Method:</label>
                <div class="kind-options">
                    <div class="kind-option">
                        <input type="radio" id="auth-extension" name="auth-mode" value="extension" checked>
                        <label for="auth-extension">Nostr Extension</label>
                    </div>
                    <div class="kind-option">
                        <input type="radio" id="auth-nsec" name="auth-mode" value="nsec">
                        <label for="auth-nsec">Private Key (nsec)</label>
                    </div>
                </div>
                
                <div id="nsec-input-container" class="nsec-input">
                    <label for="nsec-key">Private Key (nsec...):</label>
                    <input type="password" id="nsec-key" placeholder="nsec1...">
                    <small style="color: #94a3b8;">‚ö†Ô∏è Never share your private key!</small>
                </div>
            </div>
            
            <button id="nostr-connect-btn" onclick="handleNostrConnect()">üîå Connect to Nostr</button>
            <button id="nostr-profile-btn" onclick="openNostrProfile()" style="display: none; margin-left: 10px; background: linear-gradient(135deg, #6366f1, #4f46e5);">üë§ My Profile</button>
            
            <div id="auth-status" style="margin-top: 10px;"></div>
        </div>
        
        <!-- Message Composition Section -->
        <div class="nostr-section" id="message-section" style="display: none;">
            <h3 style="margin: 0 0 15px 0;">‚úçÔ∏è Compose Message</h3>
            
            <!-- Photo Upload -->
            <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                <div id="photoUploadText">üìé Add File (Photo, Video, Audio, Cookie, etc.)</div>
                <img id="photoPreview" class="photo-preview" style="display: none;">
            </div>
            <input type="file" id="photoInput" accept="*/*" style="display: none;" onchange="handleFileUpload(event)">
            
            <!-- Upload Status -->
            <div id="uploadStatus" class="location-info" style="display: none;">
                <strong>üì§ Upload:</strong> <span id="uploadText"></span>
            </div>
            
            <!-- Message Content -->
            <div style="margin: 15px 0;">
                <label for="messageContent">Message Content:</label>
                <textarea id="messageContent" rows="4" placeholder="Your message..."></textarea>
            </div>
            
            <!-- Tags Selection -->
            <div class="tags-section">
                <label>Tags (UPlanet IA):</label>
                <div class="tags-grid">
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-bro" checked>
                        <label for="tag-bro">#BRO</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-search">
                        <label for="tag-search">#search</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-image">
                        <label for="tag-image">#image</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-video">
                        <label for="tag-video">#video</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-music">
                        <label for="tag-music">#music</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-youtube">
                        <label for="tag-youtube">#youtube</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-plantnet">
                        <label for="tag-plantnet">#plantnet</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-pierre">
                        <label for="tag-pierre">#pierre</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-amelie">
                        <label for="tag-amelie">#amelie</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-mem">
                        <label for="tag-mem">#mem</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-rec2">
                        <label for="tag-rec2">#rec2</label>
                    </div>
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag-reset">
                        <label for="tag-reset">#reset</label>
                    </div>
                </div>
            </div>
            
            <!-- Encryption Options -->
            <div class="nostr-section" style="margin: 15px 0; padding: 15px;">
                <div style="margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="encrypt-message" style="width: auto;">
                        <span>üîê Send as Private Message (Encrypted)</span>
                    </label>
                </div>
                <div id="encryption-options" style="display: none; margin-top: 15px;">
                    <div style="margin-bottom: 10px;">
                        <label class="form-label" style="font-size: 0.9em;">Recipients (select from your follows):</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button type="button" class="map-button" id="load-follows-btn" style="width: auto; padding: 8px 16px;">
                                üë• Load Follows
                            </button>
                            <button type="button" class="map-button secondary" id="add-myself-btn" style="width: auto; padding: 8px 16px;">
                                üìù Add Myself
                            </button>
                        </div>
                        <div id="contacts-list-container" style="display: none; margin-bottom: 10px;">
                            <select id="contacts-select" size="5" style="width: 100%; max-height: 150px; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: #e2e8f0;">
                                <option value="" disabled selected>Click "Load Follows" to fetch your NOSTR follows (kind 3)</option>
                            </select>
                            <button type="button" class="map-button" id="add-selected-contact-btn" style="width: 100%; margin-top: 10px; padding: 8px 16px;" disabled>
                                ‚ûï Add Selected Contact
                            </button>
                        </div>
                        <textarea id="recipients-list" rows="3" placeholder="npub1...&#10;npub1...&#10;(One recipient per line)" style="width: 100%; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: #e2e8f0; font-family: monospace; font-size: 0.85em;"></textarea>
                        <small style="color: #94a3b8; font-size: 0.85em; display: block; margin-top: 5px;">
                            Enter recipient public keys (npub format). Each recipient will be able to decrypt the message.
                        </small>
                        <div id="selected-recipients" style="display: none; margin-top: 10px;">
                            <label style="font-size: 0.9em; margin-bottom: 5px; display: block;">Selected recipients:</label>
                            <div id="selected-recipients-list" style="display: flex; flex-wrap: wrap; gap: 5px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Kind Selection -->
            <div class="kind-selection">
                <label>Event Kind:</label>
                <div class="kind-options">
                    <div class="kind-option">
                        <input type="radio" id="kind-1" name="event-kind" value="1" checked>
                        <label for="kind-1">Kind 1 (Text Note)</label>
                    </div>
                    <div class="kind-option">
                        <input type="radio" id="kind-30023" name="event-kind" value="30023">
                        <label for="kind-30023">Kind 30023 (Long-form)</label>
                    </div>
                </div>
            </div>
            
            <!-- Location Display -->
            <div id="locationInfo" class="location-info" style="display: none;">
                <strong>üìç Location:</strong> <span id="locationText"></span>
            </div>
            
            <!-- Map Accordion -->
            <div id="map-accordion" class="map-accordion">
                <div class="map-accordion-header" onclick="toggleMapAccordion()">
                    <h4 style="margin: 0; font-size: 14px; color: #e2e8f0;">üó∫Ô∏è Location Map</h4>
                    <span class="map-toggle">‚ñº</span>
                </div>
                <div class="map-accordion-content closed">
                    <div class="map-controls">
                        <div class="coord-input">
                            <label>Lat:</label>
                            <input type="number" id="lat-display" step="0.01" min="-90" max="90" value="48.86">
                        </div>
                        <div class="coord-input">
                            <label>Lon:</label>
                            <input type="number" id="lon-display" step="0.01" min="-180" max="180" value="2.35">
                        </div>
                        <button type="button" class="map-button" id="update-map">Go There</button>
                        <button type="button" class="map-button secondary" id="get-location">My Location</button>
                    </div>
                    <div id="mini-map"></div>
                    <div style="padding: 8px 0; font-size: 0.8em; color: #7f8c8d; text-align: center;">
                        üí° Click on the map to adjust your location
                    </div>
                </div>
            </div>
            
            <!-- Send Button -->
            <button id="send-message-btn" onclick="sendNostrMessage()">üöÄ Send Message</button>
        </div>
        
        <!-- Latest Message Section -->
        <div class="nostr-section" id="latest-message-section" style="display: none;">
            <h3 style="margin: 0 0 15px 0;">üì¨ Your Latest Message</h3>
            
            <div id="latest-message-container" style="background: rgba(255, 255, 255, 0.03); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                <div id="latest-message-content" style="margin-bottom: 10px; line-height: 1.6;"></div>
                <div id="latest-message-meta" style="font-size: 0.85em; color: #94a3b8;"></div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="refresh-message-btn" onclick="loadLatestMessage()">üîÑ Refresh</button>
                <button id="load-replies-btn" onclick="loadReplies()" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">üí¨ Load Replies</button>
            </div>
            
            <!-- Replies Container -->
            <div id="replies-container" style="display: none; margin-top: 20px;">
                <h4 style="color: #e2e8f0; margin-bottom: 10px;">üí¨ Replies:</h4>
                <div id="replies-list"></div>
            </div>
        </div>
        
        <!-- Nostr Profile Modal -->
        <div id="profile-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üë§ Nostr Profile</h2>
                    <span class="modal-close" onclick="closeNostrProfile()">&times;</span>
                </div>
                <div class="modal-body">
                    <iframe id="profile-iframe" src="" frameborder="0" width="100%" height="100%"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables (use common.js for: DEFAULT_RELAYS, IPFS_GATEWAY, nostrRelay, isNostrConnected, userPubkey, userNpub)
        let userPrivkey = null;
        let authMode = 'extension';
        let currentLocation = null;
        let selectedFile = null;
        let uploadedFileUrl = null;
        let miniMap = null;
        let miniMarker = null;
        let latestMessageEvent = null;
        let userHasInteractedWithMap = false;
        let selectedRecipients = new Set();
        let contactsList = [];
        
        // Auto-connect nsec (injected by upassport.sh when scanning SSSS with code 1111)
        const AUTO_CONNECT_NSEC = null;

        // Initialize API configuration using common.js
        function initializeAPIConfig() {
            // Use common.js detectUSPOTAPI (only call once, no recursion)
            if (typeof detectUSPOTAPI === 'function' && typeof window.detectUSPOTAPI === 'undefined') {
                // Call the function directly (not via window to avoid recursion)
                detectUSPOTAPI();
            } else if (typeof window.detectUSPOTAPI === 'function') {
                // If already on window, use it directly
                window.detectUSPOTAPI();
            }

            // Get API base URL from common.js
            const apiBase = typeof getAPIBaseUrl === 'function' ? getAPIBaseUrl() : 
                          (window.upassportUrl || 'https://u.copylaradio.com');
            
            // Get values from common.js
            const determinedRelay = (window.DEFAULT_RELAYS && window.DEFAULT_RELAYS[0]) || 'wss://relay.copylaradio.com';
            const ipfsGateway = window.IPFS_GATEWAY || 'https://ipfs.copylaradio.com';

            console.log(`uSPOT API Base: ${apiBase}`);
            console.log(`Default Relay: ${determinedRelay}`);
            console.log(`IPFS Gateway: ${ipfsGateway}`);
            
            // Display API info
            const apiInfo = document.getElementById('api-info');
            const apiDetails = document.getElementById('api-details');
            if (apiInfo && apiDetails) {
                apiDetails.innerHTML = `
                    Relay: <code>${determinedRelay}</code><br>
                    API: <code>${apiBase}</code><br>
                    IPFS: <code>${ipfsGateway}</code>
                `;
                apiInfo.style.display = 'block';
            }
            
            return apiBase;
        }
        
        // Get API base URL (uses common.js)
        function getUSPOTAPIBase() {
            return typeof getAPIBaseUrl === 'function' ? getAPIBaseUrl() : 
                   (window.upassportUrl || 'https://u.copylaradio.com');
        }

        // Configure marked.js for security (if available)
        if (typeof marked !== 'undefined') {
            marked.setOptions({
                breaks: true,          // GitHub Flavored Markdown line breaks
                gfm: true,             // GitHub Flavored Markdown
                headerIds: false,      // Don't generate header IDs (security)
                mangle: false,         // Don't mangle email addresses
                sanitize: false,       // We trust content from relay (authenticated users)
                smartLists: true,      // Use smarter list behavior
                smartypants: false     // Don't use smart quotes
            });
            console.log('‚úÖ marked.js configured for Markdown rendering');
        }

        // Handle auth mode change
        document.addEventListener('DOMContentLoaded', function() {
            initializeAPIConfig();
            
            // Auto-connect with nsec if provided (MULTIPASS SSSS scan with code 1111)
            if (AUTO_CONNECT_NSEC && AUTO_CONNECT_NSEC !== null && AUTO_CONNECT_NSEC.trim() !== '') {
                console.log('üîë MULTIPASS SSSS detected - Auto-connecting with nsec...');
                
                // Switch to nsec mode
                const nsecRadio = document.getElementById('auth-nsec');
                const nsecInput = document.getElementById('nsec-key');
                const nsecContainer = document.getElementById('nsec-input-container');
                
                if (nsecRadio && nsecInput && nsecContainer) {
                    // Select nsec authentication mode
                    nsecRadio.checked = true;
                    nsecContainer.classList.add('visible');
                    authMode = 'nsec';
                    
                    // Fill the nsec key
                    nsecInput.value = AUTO_CONNECT_NSEC;
                    
                    // Auto-connect after a short delay to let the UI update
                    setTimeout(() => {
                        handleNostrConnect();
                    }, 700);
                }
            }
            
            const authRadios = document.querySelectorAll('input[name="auth-mode"]');
            authRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    authMode = this.value;
                    const nsecContainer = document.getElementById('nsec-input-container');
                    if (authMode === 'nsec') {
                        nsecContainer.classList.add('visible');
                    } else {
                        nsecContainer.classList.remove('visible');
                    }
                });
            });
            
            // Map controls
            document.getElementById('update-map').addEventListener('click', function() {
                const lat = parseFloat(document.getElementById('lat-display').value) || 0;
                const lon = parseFloat(document.getElementById('lon-display').value) || 0;
                updateCoordinatesFromMap(lat, lon);
                if (miniMap) {
                    miniMap.setView([lat, lon], miniMap.getZoom());
                }
            });
            
            document.getElementById('get-location').addEventListener('click', getCurrentLocationForMap);
            
            // Initialize recipient selection
            initializeRecipientSelection();
            
            // Encryption checkbox handler
            const encryptCheckbox = document.getElementById('encrypt-message');
            const encryptionOptions = document.getElementById('encryption-options');
            if (encryptCheckbox && encryptionOptions) {
                encryptCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        encryptionOptions.style.display = 'block';
                    } else {
                        encryptionOptions.style.display = 'none';
                        selectedRecipients.clear();
                        updateSelectedRecipientsDisplay();
                    }
                });
            }
            
            // Sync display inputs
            document.getElementById('lat-display').addEventListener('change', function() {
                const lat = parseFloat(this.value) || 0;
                const lon = parseFloat(document.getElementById('lon-display').value) || 0;
                if (miniMarker) {
                    miniMarker.setLatLng([lat, lon]);
                }
                if (miniMap) {
                    miniMap.setView([lat, lon], miniMap.getZoom());
                }
                updateLocationDisplay();
            });
            
            document.getElementById('lon-display').addEventListener('change', function() {
                const lat = parseFloat(document.getElementById('lat-display').value) || 0;
                const lon = parseFloat(this.value) || 0;
                if (miniMarker) {
                    miniMarker.setLatLng([lat, lon]);
                }
                if (miniMap) {
                    miniMap.setView([lat, lon], miniMap.getZoom());
                }
                updateLocationDisplay();
            });
        });

        // Connect to Nostr (using common.js functions)
        async function handleNostrConnect() {
            const statusDiv = document.getElementById('auth-status');
            const connectBtn = document.getElementById('nostr-connect-btn');
            
            connectBtn.disabled = true;
            statusDiv.innerHTML = '<div class="status-message status-info">üîÑ Connecting...</div>';
            
            try {
                let pubkey = null;
                
                if (authMode === 'extension') {
                    // Use common.js connectNostr function
                    if (typeof connectNostr === 'function') {
                        console.log('üìå Using common.js connectNostr...');
                        pubkey = await connectNostr(true); // Force NIP-42 auth
                        
                        if (!pubkey) {
                            throw new Error("No public key returned from connectNostr");
                        }
                    } else {
                        throw new Error("common.js not loaded. Please refresh the page.");
                    }
                } else if (authMode === 'nsec') {
                    // Use private key (not supported by common.js, use direct method)
                    const nsecKey = document.getElementById('nsec-key').value.trim();
                    if (!nsecKey) {
                        throw new Error("Please enter your private key (nsec)");
                    }
                    
                    // Convert nsec to hex using nostr-tools
                    try {
                        userPrivkey = NostrTools.nip19.decode(nsecKey).data;
                        pubkey = NostrTools.getPublicKey(userPrivkey);
                        console.log("Public key from nsec:", pubkey);
                        
                        // Update NostrState for nsec mode
                        if (window.NostrState) {
                            window.NostrState.userPubkey = pubkey;
                            window.NostrState.userPrivateKey = userPrivkey;
                            if (window.syncLegacyVariables) {
                                window.syncLegacyVariables();
                            }
                        }
                        
                        // Connect to relay using RelayManager
                        if (window.RelayManager) {
                            const relayUrl = window.RelayManager.getPrimaryRelay();
                            const relay = window.RelayManager.init(relayUrl);
                            window.RelayManager.setupHandlers(
                                relay,
                                relayUrl,
                                () => {
                                    console.log('‚úÖ Connected to relay for nsec mode');
                                    if (window.NostrState) {
                                        window.NostrState.isNostrConnected = true;
                                        if (window.syncLegacyVariables) {
                                            window.syncLegacyVariables();
                                        }
                                    }
                                },
                                (error) => {
                                    console.error('‚ùå Relay error:', error);
                                },
                                () => {
                                    console.log('üîå Relay disconnected');
                                }
                            );
                            await relay.connect();
                            
                            // Send NIP-42 auth for nsec mode
                            await sendNIP42AuthForNsec();
                        } else {
                            // Fallback to direct connection
                            await connectToNostrRelayForNsec();
                            await sendNIP42AuthForNsec();
                        }
                    } catch (e) {
                        throw new Error("Invalid nsec format. Please check your private key.");
                    }
                }
                
                // Show success
                statusDiv.innerHTML = `<div class="status-message status-success">‚úÖ Connected as ${pubkey.substring(0, 8)}...${pubkey.substring(pubkey.length - 4)}</div>`;
                document.getElementById('message-section').style.display = 'block';
                connectBtn.textContent = '‚úÖ Connected';
                connectBtn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                
                // Show profile button
                document.getElementById('nostr-profile-btn').style.display = 'inline-block';
                
                // Load latest message
                await loadLatestMessage();
                
            } catch (error) {
                console.error("Connection error:", error);
                statusDiv.innerHTML = `<div class="status-message status-error">‚ùå ${error.message}</div>`;
                connectBtn.disabled = false;
            }
        }

        // Connect to Nostr relay (for nsec mode only - fallback if RelayManager not available)
        async function connectToNostrRelayForNsec() {
            const relayUrl = (window.DEFAULT_RELAYS && window.DEFAULT_RELAYS[0]) || 'wss://relay.copylaradio.com';
            
            if (window.RelayManager && window.RelayManager.isConnected()) {
                console.log('‚úÖ Reusing existing relay connection');
                return;
            }

            console.log('Connecting to relay:', relayUrl);

            try {
                if (window.RelayManager) {
                    window.RelayManager.close();
                }

                const newRelay = NostrTools.relayInit(relayUrl);
                
                // Update NostrState
                if (window.NostrState) {
                    window.NostrState.nostrRelay = newRelay;
                    if (window.syncLegacyVariables) {
                        window.syncLegacyVariables();
                    }
                }

                newRelay.on('connect', () => {
                    console.log('‚úÖ Connected to NOSTR relay:', relayUrl);
                    if (window.NostrState) {
                        window.NostrState.isNostrConnected = true;
                        if (window.syncLegacyVariables) {
                            window.syncLegacyVariables();
                        }
                    }
                });

                newRelay.on('error', (error) => {
                    console.error('‚ùå Relay connection error:', error);
                    if (window.NostrState) {
                        window.NostrState.isNostrConnected = false;
                        if (window.syncLegacyVariables) {
                            window.syncLegacyVariables();
                        }
                    }
                });

                newRelay.on('disconnect', () => {
                    console.log('üîå Relay disconnected');
                    if (window.NostrState) {
                        window.NostrState.isNostrConnected = false;
                        if (window.syncLegacyVariables) {
                            window.syncLegacyVariables();
                        }
                    }
                });

                await newRelay.connect();
                
                if (window.NostrState) {
                    window.NostrState.isNostrConnected = true;
                    if (window.syncLegacyVariables) {
                        window.syncLegacyVariables();
                    }
                }

            } catch (error) {
                console.error('Failed to connect to relay:', error);
                if (window.NostrState) {
                    window.NostrState.isNostrConnected = false;
                    if (window.syncLegacyVariables) {
                        window.syncLegacyVariables();
                    }
                }
                throw error;
            }
        }

        // Send NIP-42 authentication event (for nsec mode only)
        async function sendNIP42AuthForNsec() {
            const pubkey = window.NostrState?.userPubkey || window.userPubkey;
            const relay = window.NostrState?.nostrRelay || window.nostrRelay;
            const connected = window.NostrState?.isNostrConnected || window.isNostrConnected;
            
            if (!pubkey || !relay || !connected || !userPrivkey) {
                console.warn('Cannot send NIP-42 auth: missing requirements');
                return;
            }
            
            try {
                console.log('üìù Sending NIP-42 authentication event (nsec mode)...');
                
                const relayUrl = window.RelayManager?.getPrimaryRelay() || 
                               (window.DEFAULT_RELAYS && window.DEFAULT_RELAYS[0]) || 
                               'wss://relay.copylaradio.com';
                
                const authEvent = {
                    kind: 22242,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ['relay', relayUrl],
                        ['challenge', 'auth-' + Date.now()]
                    ],
                    content: '',
                    pubkey: pubkey
                };
                
                const signedEvent = NostrTools.finishEvent(authEvent, userPrivkey);
                
                if (!signedEvent || !signedEvent.id) {
                    console.error('‚ùå Failed to sign NIP-42 event');
                    return;
                }
                
                console.log('‚úÖ NIP-42 event signed:', signedEvent.id);
                
                await relay.publish(signedEvent);
                console.log('‚úÖ NIP-42 event published');
                
                // Also send AUTH message
                try {
                    const ws = relay._ws || relay.ws || relay.socket;
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const authMessage = JSON.stringify(['AUTH', signedEvent]);
                        ws.send(authMessage);
                        console.log('‚úÖ NIP-42 AUTH message sent');
                    }
                } catch (authError) {
                    console.warn('‚ö†Ô∏è Could not send AUTH message:', authError);
                }
                
            } catch (error) {
                console.error('‚ùå Failed to send NIP-42 auth:', error);
            }
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const preview = document.getElementById('photoPreview');
                const uploadText = document.getElementById('photoUploadText');
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        uploadText.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } else {
                    // Display file name for non-image files
                    uploadText.textContent = `üìé ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                    preview.style.display = 'none';
                    uploadText.style.display = 'block';
                }
                
                // Upload to IPFS
                uploadFileToIPFS(file);
            }
        }

        // Upload file to IPFS (using common.js uploadPhotoToIPFS if available)
        async function uploadFileToIPFS(file) {
            const uploadStatus = document.getElementById('uploadStatus');
            const uploadText = document.getElementById('uploadText');
            
            uploadStatus.style.display = 'block';
            uploadText.textContent = 'üì§ Uploading...';
            
            try {
                // Use common.js uploadPhotoToIPFS if available
                if (typeof uploadPhotoToIPFS === 'function') {
                    console.log('üì§ Using common.js uploadPhotoToIPFS...');
                    const result = await uploadPhotoToIPFS(file);
                    
                    if (result && result.url) {
                        uploadedFileUrl = result.url;
                        uploadStatus.style.background = 'rgba(74, 222, 128, 0.1)';
                        uploadText.innerHTML = `‚úÖ Uploaded: <a href="${result.url}" target="_blank" style="color: #4ade80;">${result.url.substring(0, 50)}...</a>`;
                        console.log('‚úÖ File uploaded via common.js:', result.url);
                        return;
                    }
                }
                
                // Fallback to direct API upload
                const formData = new FormData();
                formData.append('file', file);
                
                const pubkey = window.NostrState?.userPubkey || window.userPubkey;
                if (pubkey) {
                    formData.append('npub', pubkey);
                }
                
                const uploadUrl = `${getUSPOTAPIBase()}/api/fileupload`;
                console.log(`Uploading to: ${uploadUrl}`);
                
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `Upload failed: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Upload result:', result);
                
                // Construct IPFS URL using the correct IPFS gateway
                const ipfsGateway = window.IPFS_GATEWAY || 'https://ipfs.copylaradio.com';
                let fileUrl = null;
                if (result.success && result.new_cid && result.file_path) {
                    const fileName = result.file_path.split('/').pop();
                    fileUrl = `${ipfsGateway}/ipfs/${result.new_cid}/${fileName}`;
                } else if (result.url) {
                    fileUrl = result.url;
                } else if (result.ipfs_url) {
                    fileUrl = result.ipfs_url;
                }
                
                uploadStatus.style.background = 'rgba(74, 222, 128, 0.1)';
                
                // Handle special file types (cookies, config, etc.) that don't generate IPFS URLs
                if (!fileUrl && result.success) {
                    if (result.file_type === 'netscape_cookies') {
                        uploadText.innerHTML = `‚úÖ Cookie file uploaded: ${result.message}`;
                        console.log('‚úÖ Cookie file uploaded:', result.file_path);
                    } else {
                        uploadText.innerHTML = `‚úÖ File uploaded: ${result.message || result.file_path}`;
                        console.log('‚úÖ File uploaded:', result);
                    }
                    uploadedFileUrl = null; // Don't add to message content
                } else if (fileUrl) {
                    uploadedFileUrl = fileUrl;
                    uploadText.innerHTML = `‚úÖ Uploaded: <a href="${fileUrl}" target="_blank" style="color: #4ade80;">${fileUrl.substring(0, 50)}...</a>`;
                    console.log('‚úÖ File uploaded:', fileUrl);
                } else {
                    throw new Error('Failed to construct IPFS URL');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                uploadStatus.style.background = 'rgba(239, 68, 68, 0.1)';
                uploadText.textContent = `‚ùå ${error.message}`;
            }
        }

        // Send Nostr message
        async function sendNostrMessage() {
            const pubkey = window.NostrState?.userPubkey || window.userPubkey;
            const relay = window.NostrState?.nostrRelay || window.nostrRelay;
            const connected = window.NostrState?.isNostrConnected || window.isNostrConnected;
            
            if (!pubkey || !relay || !connected) {
                alert("Please connect to Nostr first");
                return;
            }
            
            const sendBtn = document.getElementById('send-message-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = "Sending...";
            
            try {
                // Check if encryption is enabled
                const isEncrypted = document.getElementById('encrypt-message')?.checked || false;
                const recipientsText = document.getElementById('recipients-list')?.value || '';
                
                // Get message content
                let content = document.getElementById('messageContent').value.trim();
                
                // Add uploaded file URL (only if it's a shareable URL)
                if (uploadedFileUrl && uploadedFileUrl !== null) {
                    content += `\n${uploadedFileUrl}`;
                }
                
                // Add location only if user has interacted with the map
                const lat = parseFloat(document.getElementById('lat-display').value) || 0;
                const lon = parseFloat(document.getElementById('lon-display').value) || 0;
                if (userHasInteractedWithMap && (lat !== 0 || lon !== 0)) {
                    content += `\nüìç Position: ${lat.toFixed(2)}, ${lon.toFixed(2)}`;
                }
                
                // Add selected tags
                const tags = [];
                const tagCheckboxes = document.querySelectorAll('.tag-checkbox input[type="checkbox"]:checked');
                tagCheckboxes.forEach(checkbox => {
                    const tagName = checkbox.id.replace('tag-', '');
                    // BRO and BOT must be uppercase for UPlanet detection
                    const displayTag = (tagName === 'bro' || tagName === 'bot') ? tagName.toUpperCase() : tagName;
                    content += ` #${displayTag}`;
                    tags.push(['t', tagName]);
                });
                
                // Add geohash tag only if user has interacted with the map
                if (userHasInteractedWithMap && (lat !== 0 || lon !== 0)) {
                    tags.push(['g', `${lat},${lon}`]);
                }
                
                // If encryption is enabled, send as private message
                if (isEncrypted) {
                    // Parse recipients
                    const recipientsList = recipientsText.split('\n')
                        .map(line => line.trim())
                        .filter(line => line && line.startsWith('npub'));
                    
                    if (recipientsList.length === 0) {
                        throw new Error('At least one recipient is required for encrypted messages');
                    }
                    
                    // Check if NostrPrivate is available
                    if (typeof window.NostrPrivate === 'undefined' || !window.NostrPrivate.sendEncryptedDirectMessage) {
                        throw new Error('NostrPrivate library not loaded. Please refresh the page.');
                    }
                    
                    // Send encrypted message to each recipient
                    const results = [];
                    for (const recipient of recipientsList) {
                        try {
                            const result = await window.NostrPrivate.sendEncryptedDirectMessage(recipient, content, {
                                useGiftWrap: false
                            });
                            results.push(result);
                            console.log('‚úÖ Encrypted message sent to:', recipient.substring(0, 8) + '...');
                        } catch (error) {
                            console.error(`‚ùå Error sending to ${recipient}:`, error);
                            // Continue with other recipients
                        }
                    }
                    
                    if (results.length === 0) {
                        throw new Error('Failed to send encrypted message to any recipient');
                    }
                    
                    alert(`‚úÖ Encrypted message sent successfully to ${results.length} recipient(s)!`);
                } else {
                    // Send as public message (original behavior)
                    // Get event kind
                    const kind = parseInt(document.querySelector('input[name="event-kind"]:checked').value);
                    
                    // Create event
                    const eventTemplate = {
                        kind: kind,
                        created_at: Math.floor(Date.now() / 1000),
                        tags: tags,
                        content: content
                    };
                    
                    // For kind 30023, add required tags
                    if (kind === 30023) {
                        eventTemplate.tags.push(['d', Date.now().toString()]);
                        eventTemplate.tags.push(['title', content.substring(0, 50)]);
                    }
                    
                    // Sign event
                    let signedEvent;
                    if (authMode === 'extension') {
                        // Use ExtensionWrapper from common.js
                        if (window.ExtensionWrapper && window.ExtensionWrapper.signEvent) {
                            signedEvent = await window.ExtensionWrapper.signEvent(eventTemplate);
                        } else if (window.nostr && typeof window.nostr.signEvent === 'function') {
                            signedEvent = await window.nostr.signEvent(eventTemplate);
                        } else {
                            throw new Error('Nostr extension not available');
                        }
                    } else {
                        signedEvent = NostrTools.finishEvent(eventTemplate, userPrivkey);
                    }
                    
                    // Publish event using common.js publishNote if available
                    if (authMode === 'extension' && typeof publishNote === 'function') {
                        console.log("Publishing event using common.js publishNote...");
                        const result = await publishNote(content, tags, kind, {
                            silent: false,
                            timeout: 10000
                        });
                        if (!result.success) {
                            throw new Error(result.errors.join(', ') || 'Failed to publish');
                        }
                    } else {
                        // Fallback to direct publish
                        console.log("Publishing event directly...");
                        const currentRelay = window.NostrState?.nostrRelay || window.nostrRelay;
                        if (currentRelay) {
                            await currentRelay.publish(signedEvent);
                        } else {
                            throw new Error('Relay not connected');
                        }
                    }
                    
                    alert("‚úÖ Message sent successfully!");
                }
                
                // Reset form
                document.getElementById('messageContent').value = '';
                document.getElementById('photoInput').value = '';
                document.getElementById('photoPreview').style.display = 'none';
                document.getElementById('photoUploadText').style.display = 'block';
                document.getElementById('photoUploadText').textContent = 'üìé Add File (Photo, Video, Audio, Cookie, etc.)';
                document.getElementById('uploadStatus').style.display = 'none';
                selectedFile = null;
                uploadedFileUrl = null;
                userHasInteractedWithMap = false;
                
                // Reset encryption
                if (isEncrypted) {
                    document.getElementById('encrypt-message').checked = false;
                    document.getElementById('encryption-options').style.display = 'none';
                    document.getElementById('recipients-list').value = '';
                    selectedRecipients.clear();
                    updateSelectedRecipientsDisplay();
                }
                
                // Uncheck all tags except #BRO
                document.querySelectorAll('.tag-checkbox input[type="checkbox"]').forEach(cb => {
                    if (cb.id !== 'tag-bro') cb.checked = false;
                });
                
                // Reload latest message
                await loadLatestMessage();
                
            } catch (error) {
                console.error("Send error:", error);
                alert(`‚ùå Failed to send message: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = "üöÄ Send Message";
            }
        }

        // Load latest message from user
        async function loadLatestMessage() {
            const pubkey = window.NostrState?.userPubkey || window.userPubkey;
            const relay = window.NostrState?.nostrRelay || window.nostrRelay;
            const connected = window.NostrState?.isNostrConnected || window.isNostrConnected;
            
            if (!pubkey || !relay || !connected) {
                console.warn('Cannot load messages: not connected');
                return;
            }
            
            try {
                console.log('üì• Loading latest message from:', pubkey.substring(0, 8));
                
                const filter = {
                    authors: [pubkey],
                    kinds: [1, 30023],
                    limit: 1
                };
                
                let messageFound = false;
                
                const sub = relay.sub([filter]);
                
                sub.on('event', (event) => {
                    console.log('üì® Received event:', event);
                    latestMessageEvent = event;
                    displayLatestMessage(event);
                    messageFound = true;
                });
                
                sub.on('eose', () => {
                    console.log('‚úÖ End of subscription');
                    sub.unsub();
                    
                    if (messageFound) {
                        document.getElementById('latest-message-section').style.display = 'block';
                    } else {
                        console.log('‚ÑπÔ∏è No messages found');
                    }
                });
                
            } catch (error) {
                console.error('‚ùå Error loading message:', error);
            }
        }

        // Display latest message
        function displayLatestMessage(event) {
            const contentDiv = document.getElementById('latest-message-content');
            const metaDiv = document.getElementById('latest-message-meta');
            
            let content = event.content;
            
            // Check if it's a Long-form Article (Kind 30023)
            if (event.kind === 30023) {
                // Use marked.js to render Markdown
                if (typeof marked !== 'undefined') {
                    // Parse Markdown (marked.js is already configured globally)
                    content = marked.parse(content);
                    console.log('üìù Rendered Markdown content for Kind 30023');
                } else {
                    console.warn('‚ö†Ô∏è marked.js not loaded, displaying raw content');
                    // Fallback to basic formatting
                    content = content.replace(/\n/g, '<br>');
                }
            } else {
                // Kind 1: Simple text formatting
                // Convert URLs to links
                content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: #4ade80; text-decoration: underline;">$1</a>');
                
                // Highlight hashtags
                content = content.replace(/#(\w+)/g, '<span style="color: #6366f1; font-weight: 600;">#$1</span>');
                
                // Replace newlines with <br>
                content = content.replace(/\n/g, '<br>');
            }
            
            contentDiv.innerHTML = content;
            
            // Display metadata
            const date = new Date(event.created_at * 1000);
            const kindLabel = event.kind === 1 ? 'Text Note' : 'Long-form Article';
            
            // Extract title from tags for Kind 30023
            let title = '';
            if (event.kind === 30023 && event.tags) {
                const titleTag = event.tags.find(tag => tag[0] === 'title');
                if (titleTag && titleTag[1]) {
                    title = ` | <strong>Title:</strong> ${titleTag[1]}`;
                }
            }
            
            metaDiv.innerHTML = `
                <strong>Kind:</strong> ${kindLabel} (${event.kind})${title} |
                <strong>Date:</strong> ${date.toLocaleString()} |
                <strong>Event ID:</strong> ${event.id.substring(0, 8)}...
            `;
            
            // Reset replies
            document.getElementById('replies-container').style.display = 'none';
            document.getElementById('replies-list').innerHTML = '';
            
            console.log('‚úÖ Message displayed');
        }

        // Load replies to latest message
        async function loadReplies() {
            const relay = window.NostrState?.nostrRelay || window.nostrRelay;
            const connected = window.NostrState?.isNostrConnected || window.isNostrConnected;
            
            if (!latestMessageEvent || !relay || !connected) {
                alert('No message loaded to fetch replies for');
                return;
            }
            
            const btn = document.getElementById('load-replies-btn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading...';
            
            try {
                console.log('üì• Loading replies for event:', latestMessageEvent.id);
                
                const filter = {
                    kinds: [1],
                    '#e': [latestMessageEvent.id],
                    limit: 50
                };
                
                const repliesList = document.getElementById('replies-list');
                repliesList.innerHTML = '<div style="text-align: center; padding: 10px;">üîÑ Loading replies...</div>';
                document.getElementById('replies-container').style.display = 'block';
                
                const replies = [];
                const sub = relay.sub([filter]);
                
                sub.on('event', (event) => {
                    console.log('üí¨ Reply received:', event);
                    replies.push(event);
                });
                
                sub.on('eose', () => {
                    console.log('‚úÖ End of replies subscription');
                    sub.unsub();
                    
                    if (replies.length === 0) {
                        repliesList.innerHTML = '<div style="text-align: center; padding: 10px; color: #94a3b8;">No replies yet</div>';
                    } else {
                        // Sort by date (oldest first)
                        replies.sort((a, b) => a.created_at - b.created_at);
                        displayReplies(replies);
                    }
                    
                    btn.disabled = false;
                    btn.textContent = 'üí¨ Load Replies';
                });
                
            } catch (error) {
                console.error('‚ùå Error loading replies:', error);
                alert(`Failed to load replies: ${error.message}`);
                btn.disabled = false;
                btn.textContent = 'üí¨ Load Replies';
            }
        }

        // Display replies
        function displayReplies(replies) {
            const repliesList = document.getElementById('replies-list');
            repliesList.innerHTML = '';
            
            if (replies.length === 0) {
                repliesList.innerHTML = '<div style="text-align: center; padding: 10px; color: #94a3b8;">No replies yet</div>';
                return;
            }
            
            replies.forEach((reply, index) => {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'reply-item';
                
                // Format content based on kind
                let content = reply.content;
                
                if (reply.kind === 30023 && typeof marked !== 'undefined') {
                    // Render Markdown for Long-form replies
                    content = marked.parse(content);
                } else {
                    // Simple formatting for Kind 1
                    content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: #4ade80; text-decoration: underline;">$1</a>');
                    content = content.replace(/#(\w+)/g, '<span style="color: #6366f1; font-weight: 600;">#$1</span>');
                    content = content.replace(/\n/g, '<br>');
                }
                
                const date = new Date(reply.created_at * 1000);
                const kindLabel = reply.kind === 30023 ? ' (Long-form)' : '';
                
                replyDiv.innerHTML = `
                    <div style="margin-bottom: 8px; line-height: 1.6;">${content}</div>
                    <div style="font-size: 0.8em; color: #94a3b8;">
                        <strong>From:</strong> ${reply.pubkey.substring(0, 8)}...${reply.pubkey.substring(reply.pubkey.length - 4)}${kindLabel} |
                        <strong>Date:</strong> ${date.toLocaleString()}
                    </div>
                `;
                
                repliesList.appendChild(replyDiv);
            });
            
            console.log(`‚úÖ Displayed ${replies.length} replies`);
        }

        // Map functions
        function toggleMapAccordion() {
            const accordionContent = document.querySelector('.map-accordion-content');
            const mapToggle = document.querySelector('.map-toggle');
            const isClosed = accordionContent.classList.contains('closed');
            
            if (isClosed) {
                accordionContent.classList.remove('closed');
                mapToggle.classList.add('expanded');
                setTimeout(() => {
                    const lat = parseFloat(document.getElementById('lat-display').value) || 48.86;
                    const lon = parseFloat(document.getElementById('lon-display').value) || 2.35;
                    initializeMiniMap(lat, lon);
                }, 100);
            } else {
                accordionContent.classList.add('closed');
                mapToggle.classList.remove('expanded');
            }
        }

        function initializeMiniMap(lat = 0, lon = 0) {
            console.log('Initializing map:', lat, lon);
            
            if (miniMap) {
                miniMap.remove();
            }
            
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded');
                return;
            }
            
            const mapContainer = document.getElementById('mini-map');
            if (!mapContainer) {
                console.error('Map container not found');
                return;
            }
            
            try {
                miniMap = L.map('mini-map').setView([lat, lon], 10);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(miniMap);

                miniMarker = L.marker([lat, lon], {
                    draggable: true
                }).addTo(miniMap);

                miniMap.on('click', function(e) {
                    userHasInteractedWithMap = true;
                    updateCoordinatesFromMap(e.latlng.lat, e.latlng.lng);
                });

                miniMarker.on('dragend', function(e) {
                    userHasInteractedWithMap = true;
                    updateCoordinatesFromMap(e.target.getLatLng().lat, e.target.getLatLng().lng);
                });
                
                setTimeout(() => {
                    if (miniMap) {
                        miniMap.invalidateSize();
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }

        function updateCoordinatesFromMap(lat, lon) {
            const roundedLat = Math.round(lat * 100) / 100;
            const roundedLon = Math.round(lon * 100) / 100;

            document.getElementById('lat-display').value = roundedLat.toFixed(2);
            document.getElementById('lon-display').value = roundedLon.toFixed(2);

            if (miniMarker) {
                miniMarker.setLatLng([roundedLat, roundedLon]);
            }

            currentLocation = { latitude: roundedLat, longitude: roundedLon };
            updateLocationDisplay();
        }

        function updateLocationDisplay() {
            const lat = parseFloat(document.getElementById('lat-display').value) || 0;
            const lon = parseFloat(document.getElementById('lon-display').value) || 0;
            
            if (lat !== 0 || lon !== 0) {
                const locationText = document.getElementById('locationText');
                const locationInfo = document.getElementById('locationInfo');
                
                locationText.textContent = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
                locationInfo.style.display = 'block';
            }
        }

        function getCurrentLocationForMap() {
            if (navigator.geolocation) {
                const btn = document.getElementById('get-location');
                btn.textContent = 'Getting...';
                btn.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = Math.round(position.coords.latitude * 100) / 100;
                        const lon = Math.round(position.coords.longitude * 100) / 100;

                        userHasInteractedWithMap = true;
                        updateCoordinatesFromMap(lat, lon);
                        if (miniMap) {
                            miniMap.setView([lat, lon], 13);
                        }
                        
                        btn.textContent = 'My Location';
                        btn.disabled = false;
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        btn.textContent = 'My Location';
                        btn.disabled = false;
                        alert('Failed to get location');
                    }
                );
            }
        }
        
        // Open Nostr Profile Modal
        function openNostrProfile() {
            const pubkey = window.NostrState?.userPubkey || window.userPubkey;
            if (!pubkey) {
                alert("Please connect to Nostr first");
                return;
            }
            
            // Build profile URL with hex pubkey using detected IPFS gateway
            const ipfsGateway = window.IPFS_GATEWAY || 'https://ipfs.copylaradio.com';
            const profileURL = `${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${pubkey}`;
            
            console.log("Opening profile:", profileURL);
            
            // Set iframe src and show modal
            document.getElementById('profile-iframe').src = profileURL;
            document.getElementById('profile-modal').classList.add('active');
        }
        
        // Close Nostr Profile Modal
        function closeNostrProfile() {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('active');
            
            // Clear iframe src to stop loading
            setTimeout(() => {
                document.getElementById('profile-iframe').src = '';
            }, 300);
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('profile-modal');
            if (event.target === modal) {
                closeNostrProfile();
            }
        }
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('profile-modal');
                if (modal.classList.contains('active')) {
                    closeNostrProfile();
                }
            }
        });
        
        // Initialize recipient selection
        function initializeRecipientSelection() {
            const loadFollowsBtn = document.getElementById('load-follows-btn');
            const addMyselfBtn = document.getElementById('add-myself-btn');
            const contactsSelect = document.getElementById('contacts-select');
            const addSelectedBtn = document.getElementById('add-selected-contact-btn');
            const contactsContainer = document.getElementById('contacts-list-container');
            
            if (!loadFollowsBtn || !contactsSelect || !addSelectedBtn) {
                console.warn('‚ö†Ô∏è Recipient selection UI elements not found');
                return;
            }
            
            // Load follows button
            loadFollowsBtn.addEventListener('click', async () => {
                await loadNostrFollows();
            });
            
            // Add myself button
            if (addMyselfBtn) {
                addMyselfBtn.addEventListener('click', () => {
                    addMyselfAsRecipient();
                });
            }
            
            // Contact selection
            contactsSelect.addEventListener('change', (e) => {
                addSelectedBtn.disabled = !e.target.value;
            });
            
            // Add selected contact
            addSelectedBtn.addEventListener('click', () => {
                const selectedOption = contactsSelect.options[contactsSelect.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    const npub = selectedOption.value;
                    const name = selectedOption.text;
                    addRecipient(npub, name);
                }
            });
            
            // Double-click to add contact
            contactsSelect.addEventListener('dblclick', () => {
                if (!addSelectedBtn.disabled) {
                    addSelectedBtn.click();
                }
            });
        }
        
        // Load NOSTR follows
        async function loadNostrFollows() {
            const loadBtn = document.getElementById('load-follows-btn');
            const contactsSelect = document.getElementById('contacts-select');
            const contactsContainer = document.getElementById('contacts-list-container');
            
            const pubkey = window.NostrState?.userPubkey || window.userPubkey;
            if (!pubkey) {
                alert('Please connect to NOSTR first to load your follows.');
                return;
            }
            
            try {
                loadBtn.disabled = true;
                loadBtn.textContent = 'üîÑ Loading...';
                
                // Ensure NOSTR connection using common.js
                if (typeof ensureNostrConnection === 'function') {
                    await ensureNostrConnection();
                }
                
                // Check if fetchUserFollowsWithMetadata is available
                if (typeof fetchUserFollowsWithMetadata !== 'function') {
                    throw new Error('fetchUserFollowsWithMetadata function not available. Make sure common.js is loaded.');
                }
                
                console.log('üì° Fetching NOSTR follows (kind 3) for:', pubkey.substring(0, 16) + '...');
                
                // Fetch follows with metadata using common.js
                const follows = await fetchUserFollowsWithMetadata(pubkey, {
                    timeout: 5000,
                    includeProfiles: true
                });
                
                console.log('‚úÖ Loaded', follows.length, 'follows');
                
                if (follows.length === 0) {
                    alert('No follows found. You can follow users on NOSTR to see them here.');
                    contactsSelect.innerHTML = '<option value="" disabled>No follows found</option>';
                    contactsContainer.style.display = 'block';
                    loadBtn.disabled = false;
                    loadBtn.textContent = 'üë• Load Follows';
                    return;
                }
                
                // Populate contacts list
                contactsList = follows.map(follow => ({
                    npub: follow.npub,
                    name: follow.name || follow.display_name || 'Unknown',
                    email: follow.email || '',
                    picture: follow.picture || '',
                    mutual: false
                }));
                
                // Update select dropdown
                contactsSelect.innerHTML = '';
                contactsList.forEach(contact => {
                    const option = document.createElement('option');
                    option.value = contact.npub;
                    const displayName = contact.name || contact.email || contact.npub.substring(0, 16) + '...';
                    option.textContent = `${displayName}${contact.email ? ` (${contact.email})` : ''}`;
                    option.dataset.name = contact.name || '';
                    option.dataset.email = contact.email || '';
                    contactsSelect.appendChild(option);
                });
                
                // Show container
                contactsContainer.style.display = 'block';
                
                console.log(`‚úÖ Loaded ${follows.length} follow${follows.length !== 1 ? 's' : ''} from your NOSTR follow list (kind 3)`);
                
            } catch (error) {
                console.error('‚ùå Error loading NOSTR follows:', error);
                alert(`Failed to load follows: ${error.message}`);
                contactsSelect.innerHTML = '<option value="" disabled>Error loading follows</option>';
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = 'üë• Load Follows';
            }
        }
        
        // Add myself as recipient
        function addMyselfAsRecipient() {
            const pubkey = window.NostrState?.userPubkey || window.userPubkey;
            if (!pubkey) {
                alert('Please connect to NOSTR first to add yourself as recipient.');
                return;
            }
            
            // Convert hex to npub using common.js function
            let myNpub = pubkey;
            if (pubkey.length === 64 && /^[0-9a-fA-F]{64}$/.test(pubkey)) {
                // It's hex, need to convert to npub
                if (typeof hexToNpub === 'function') {
                    try {
                        myNpub = hexToNpub(pubkey);
                    } catch (e) {
                        console.error('‚ùå Error converting hex to npub:', e);
                        alert('Could not convert your pubkey to npub format. Please enter it manually.');
                        return;
                    }
                } else if (typeof NostrTools !== 'undefined' && NostrTools.nip19) {
                    try {
                        myNpub = NostrTools.nip19.npubEncode(pubkey);
                    } catch (e) {
                        console.error('‚ùå Error converting hex to npub:', e);
                        alert('Could not convert your pubkey to npub format. Please enter it manually.');
                        return;
                    }
                } else {
                    alert('hexToNpub function not available. Please enter your npub manually.');
                    return;
                }
            } else if (!pubkey.startsWith('npub1')) {
                alert('Invalid pubkey format. Expected hex or npub.');
                return;
            }
            
            // Add to recipients list
            addRecipient(myNpub, 'Myself');
        }
        
        // Add recipient
        function addRecipient(npub, name) {
            if (selectedRecipients.has(npub)) {
                alert('This recipient is already added.');
                return;
            }
            
            selectedRecipients.add(npub);
            
            // Add to textarea
            const recipientsTextarea = document.getElementById('recipients-list');
            if (recipientsTextarea) {
                const currentValue = recipientsTextarea.value.trim();
                const newValue = currentValue ? `${currentValue}\n${npub}` : npub;
                recipientsTextarea.value = newValue;
            }
            
            // Update display
            updateSelectedRecipientsDisplay();
            
            console.log('‚úÖ Added recipient:', name || npub.substring(0, 8) + '...');
        }
        
        // Remove recipient
        function removeRecipient(npub) {
            selectedRecipients.delete(npub);
            
            // Remove from textarea
            const recipientsTextarea = document.getElementById('recipients-list');
            if (recipientsTextarea) {
                const lines = recipientsTextarea.value.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && line !== npub);
                recipientsTextarea.value = lines.join('\n');
            }
            
            // Update display
            updateSelectedRecipientsDisplay();
        }
        
        // Update selected recipients display
        function updateSelectedRecipientsDisplay() {
            const selectedContainer = document.getElementById('selected-recipients');
            const selectedList = document.getElementById('selected-recipients-list');
            
            if (selectedContainer && selectedList) {
                selectedList.innerHTML = '';
                
                if (selectedRecipients.size === 0) {
                    selectedContainer.style.display = 'none';
                    return;
                }
                
                selectedContainer.style.display = 'block';
                
                selectedRecipients.forEach(npub => {
                    const badge = document.createElement('span');
                    badge.style.cssText = 'display: inline-flex; align-items: center; gap: 5px; padding: 4px 8px; background: rgba(74, 222, 128, 0.2); border: 1px solid rgba(74, 222, 128, 0.4); border-radius: 12px; font-size: 0.85em;';
                    badge.innerHTML = `
                        ${npub.substring(0, 8)}...
                        <span style="cursor: pointer; color: #ef4444; font-weight: bold;" onclick="removeRecipient('${npub}')">√ó</span>
                    `;
                    badge.dataset.npub = npub;
                    selectedList.appendChild(badge);
                });
            }
        }
        
        // Make removeRecipient available globally
        window.removeRecipient = removeRecipient;
    </script>
</body>
</html>
