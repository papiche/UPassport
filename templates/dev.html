<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astroport.ONE - Web3 Developer Platform</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="{{ myIPFS }}/ipns/copylaradio.com/fonts/bootstrap-icons.css">
    
    <style>
        :root {
            --primary: #059669;
            --secondary: #10b981;
            --dark: #1a202c;
            --light: #f7fafc;
            --code-bg: #2d3748;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .hero {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            color: white;
            padding: 4rem 0 2rem 0;
            margin-bottom: 2rem;
        }
        
        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .hero .lead {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .module-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .module-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .module-icon {
            font-size: 2.5rem;
            margin-right: 1rem;
            color: var(--primary);
        }
        
        .module-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }
        
        .test-area {
            background: #f7fafc;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .result-box {
            background: #1a202c;
            color: #48bb78;
            font-family: 'Monaco', 'Menlo', monospace;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            min-height: 60px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-indicator.connected {
            background: #48bb78;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.disconnected {
            background: #cbd5e0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .code-example {
            background: var(--code-bg);
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }
        
        .code-example .comment {
            color: #718096;
        }
        
        .code-example .keyword {
            color: #90cdf4;
        }
        
        .code-example .string {
            color: #9ae6b4;
        }
        
        .btn-test {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
            color: white;
        }
        
        .badge-tech {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            display: inline-block;
        }
        
        .file-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .file-type-btn {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-type-btn:hover {
            border-color: var(--primary);
            background: rgba(5, 150, 105, 0.05);
        }
        
        .file-type-btn.active {
            border-color: var(--primary);
            background: rgba(5, 150, 105, 0.1);
        }
        
        .user-info {
            background: rgba(5, 150, 105, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }
        
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .chat-message {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }
        
        .chat-message .author {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .chat-message .author a {
            color: var(--bs-info);
            text-decoration: none;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .chat-message .author a:hover {
            color: var(--bs-primary);
            text-decoration: underline;
            transform: translateX(2px);
        }
        
        .chat-message .author a i {
            font-size: 1.1rem;
        }
        
        .chat-message .content {
            margin-top: 0.25rem;
        }
        
        .chat-message .time {
            font-size: 0.75rem;
            color: #718096;
            margin-top: 0.25rem;
        }
        
        .footer {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            color: white;
            padding: 2rem 0;
            margin-top: 4rem;
        }
        
        /* Fixed connection indicator */
        .connection-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.25rem;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .connection-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }
        
        .connection-badge.authenticated {
            border-color: #059669;
            background: rgba(5, 150, 105, 0.2);
        }
        
        .connection-badge.connected-not-auth {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }
        
        .connection-badge.disconnected {
            border-color: #cbd5e0;
            background: rgba(107, 114, 128, 0.2);
        }
        
        .connection-badge .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e0;
        }
        
        .connection-badge.authenticated .status-dot {
            background: #059669;
            animation: pulse 2s infinite;
        }
        
        .connection-badge.connected-not-auth .status-dot {
            background: #f59e0b;
            animation: pulse-warning 2s infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .connection-badge .status-text {
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .connection-badge .user-npub {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            font-family: monospace;
        }
        
        .connection-badge .btn-connect {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .connection-badge .btn-connect:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }
        
        .connection-badge .btn-profile {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .connection-badge .btn-profile:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Connection status panel (expandable) */
        .connection-panel {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(26, 32, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            z-index: 999;
            min-width: 320px;
            max-width: 400px;
            display: none;
            animation: slideDown 0.3s ease;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        .connection-panel.show {
            display: block;
        }
        
        /* Connection level colors */
        .connection-panel.level-disconnected {
            background: rgba(107, 114, 128, 0.95);  /* Gray - Not connected */
            border-color: rgba(156, 163, 175, 0.3);
        }
        
        .connection-panel.level-public {
            background: rgba(59, 130, 246, 0.95);  /* Blue - Public read only */
            border-color: rgba(96, 165, 250, 0.5);
        }
        
        .connection-panel.level-partial {
            background: rgba(245, 158, 11, 0.95);  /* Orange - Connected but not authenticated */
            border-color: rgba(251, 191, 36, 0.5);
        }
        
        .connection-panel.level-full {
            background: rgba(16, 185, 129, 0.95);  /* Green - Fully authenticated */
            border-color: rgba(52, 211, 153, 0.5);
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .connection-step {
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid transparent;
        }
        
        .connection-step.pending {
            border-left-color: #cbd5e0;
        }
        
        .connection-step.in-progress {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .connection-step.success {
            border-left-color: #059669;
            background: rgba(5, 150, 105, 0.1);
        }
        
        .connection-step.error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .connection-step .step-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .connection-step .step-icon {
            font-size: 1.2rem;
        }
        
        .connection-step .step-title {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .connection-step .step-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-left: 1.7rem;
        }
        
        .connection-step .step-action {
            margin-left: 1.7rem;
            margin-top: 0.5rem;
        }
        
        .connection-step .step-action button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .connection-step .step-action button:hover {
            background: var(--secondary);
        }
        
        .connection-step .step-action button:disabled {
            background: rgba(107, 114, 128, 0.5);
            cursor: not-allowed;
        }
        
        .connection-badge-clickable {
            cursor: pointer;
        }
        
        /* GPS badge hover effect */
        #gpsInfo:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        
        #gpsInfo:active {
            transform: scale(0.98);
        }
        
        /* Collapsible modules */
        .module-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background-color 0.2s;
        }
        
        .module-header:hover {
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
        }
        
        .collapse-icon {
            margin-left: auto;
            transition: transform 0.3s ease;
            color: var(--primary);
            font-size: 1.2rem;
        }
        
        .module-header[aria-expanded="true"] .collapse-icon i::before {
            content: "\f285"; /* bi-chevron-up */
        }
        
        .module-header[aria-expanded="false"] .collapse-icon i::before {
            content: "\f282"; /* bi-chevron-down */
        }
        
        .collapse {
            transition: height 0.3s ease;
        }
        
        /* Tab Styles */
        .nav-tabs {
            border-bottom: 2px solid #e2e8f0;
        }
        
        .nav-tabs .nav-link {
            color: #64748b;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s;
        }
        
        .nav-tabs .nav-link:hover {
            color: var(--primary);
            border-bottom-color: rgba(5, 150, 105, 0.3);
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary);
            background: transparent;
            border-bottom-color: var(--primary);
            font-weight: 600;
        }
        
        .tab-content {
            padding: 2rem 0;
        }
        
        .tab-pane {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Code block improvements */
        pre code {
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        /* Card improvements */
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <!-- Fixed Connection Indicator -->
    <div id="connectionBadge" class="connection-badge disconnected connection-badge-clickable" onclick="toggleConnectionPanel()">
        <div class="status-dot"></div>
        <div class="d-flex flex-column" id="connectionBadgeContent">
            <span class="status-text">Not Connected</span>
        </div>
        <button class="btn-connect" onclick="event.stopPropagation(); testMultipassLogin()" id="connectBtn">
            <i class="bi bi-key"></i> Connect
        </button>
    </div>
    
    <!-- Connection Status Panel (expandable) -->
    <div id="connectionPanel" class="connection-panel level-disconnected">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
            <h6 id="panelTitle" style="color: white; margin: 0;">
                <i class="bi bi-circle-fill" id="panelStatusIcon" style="font-size: 0.6rem; margin-right: 0.5rem;"></i>
                Connection Status
            </h6>
            <button onclick="toggleConnectionPanel()" style="background: none; border: none; color: white; cursor: pointer; margin-left: auto;">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <!-- Step 1: Public Read (NOSTR Relay) -->
        <div id="step1" class="connection-step pending">
            <div class="step-header">
                <span class="step-icon">üåê</span>
                <span class="step-title">1. Public Read</span>
            </div>
            <div class="step-description" id="step1-desc">NOSTR Relay - Read public events</div>
            <div class="step-action">
                <button onclick="manualConnectRelay()" id="step1-btn">Connect to Relay</button>
            </div>
        </div>
        
        <!-- Step 2: Personal Read/Write (NIP-42 Authentication) -->
        <div id="step2" class="connection-step pending">
            <div class="step-header">
                <span class="step-icon">üîê</span>
                <span class="step-title">2. Personal Read/Write</span>
            </div>
            <div class="step-description" id="step2-desc">NIP-42 Auth - API personal read + write uDRIVE</div>
            <div class="step-action">
                <button onclick="testMultipassLogin()" id="step2-btn" disabled>Connect with MULTIPASS</button>
            </div>
        </div>
    </div>
    
    <!-- Hero Section -->
    <div class="hero">
        <div class="container text-center">
            <h1><i class="bi bi-code-square"></i> Astroport.ONE Developer Platform</h1>
            <p class="lead">
                Build decentralized applications with MULTIPASS authentication, IPFS storage, and NOSTR social features
            </p>
            <p class="mt-3">
                <span class="status-indicator" id="nostrStatus"></span>
                <span id="connectionStatus">Checking connection...</span>
            </p>
            <p class="mt-3">
                <a href="/dev?console=1" class="btn btn-light btn-sm">
                    <i class="bi bi-terminal"></i> Open NOSTR Console
                </a>
            </p>
        </div>
    </div>

    <div class="container">
        <!-- Main Content with Tabs -->
        <div class="module-card">
            <div class="mb-4">
                <h2 class="mb-3"><i class="bi bi-book"></i> Developer Guide</h2>
                <p class="lead text-muted">Learn how to build decentralized applications with Astroport.ONE step by step</p>
            </div>
            
            <!-- Bootstrap Tabs -->
            <ul class="nav nav-tabs mb-4" id="devTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="intro-tab" data-bs-toggle="tab" data-bs-target="#intro" type="button" role="tab">
                        <i class="bi bi-house-door"></i> Introduction
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="libraries-tab" data-bs-toggle="tab" data-bs-target="#libraries" type="button" role="tab">
                        <i class="bi bi-box-seam"></i> Libraries
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="architecture-tab" data-bs-toggle="tab" data-bs-target="#architecture" type="button" role="tab">
                        <i class="bi bi-diagram-3"></i> Event Architecture
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="smartcontracts-tab" data-bs-toggle="tab" data-bs-target="#smartcontracts" type="button" role="tab">
                        <i class="bi bi-cpu"></i> Smart Contracts
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="examples-tab" data-bs-toggle="tab" data-bs-target="#examples" type="button" role="tab">
                        <i class="bi bi-code-slash"></i> Examples
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab">
                        <i class="bi bi-file-text"></i> API Reference
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="devTabsContent">
                <!-- Tab 1: Introduction -->
                <div class="tab-pane fade show active" id="intro" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <h3><i class="bi bi-rocket-takeoff"></i> Welcome to Astroport.ONE</h3>
                            <p class="lead">Build decentralized applications 10x faster with NOSTR, IPFS, and Web3 technologies.</p>
                            
                            <div class="alert alert-info">
                                <h5><i class="bi bi-lightbulb"></i> Why Astroport.ONE?</h5>
                                <p class="mb-0">Traditional web development requires months to build authentication, file storage, and social features. With Astroport.ONE, you get all of this in <strong>days</strong> instead of months.</p>
                            </div>
                            
                            <h4 class="mt-4"><i class="bi bi-list-check"></i> What You'll Learn</h4>
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <strong>Libraries:</strong> Understand common.js, nostr.private.js and their specific use cases</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <strong>Event Architecture:</strong> Learn to separate events from their processing (CSS revolution analogy)</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <strong>Smart Contracts:</strong> How Astroport stations execute your events automatically</li>
                                <li class="mb-2"><i class="bi bi-check-circle text-success"></i> <strong>Best Practices:</strong> Build scalable, maintainable decentralized applications</li>
                            </ul>
                            
                            <h4 class="mt-4"><i class="bi bi-speedometer2"></i> Quick Start (3 Steps)</h4>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Step 1: Include Libraries</h5>
                                    <pre class="bg-dark text-light p-3 rounded"><code>&lt;script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js"&gt;&lt;/script&gt;
&lt;script src="{{ myIPFS }}/ipns/copylaradio.com/common.js"&gt;&lt;/script&gt;</code></pre>
                                    <div class="mt-2">
                                        <a href="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-download"></i> nostr.bundle.js
                                        </a>
                                        <a href="{{ myIPFS }}/ipns/copylaradio.com/common.js" target="_blank" class="btn btn-sm btn-outline-success ms-2">
                                            <i class="bi bi-download"></i> common.js
                                        </a>
                                        <a href="{{ myIPFS }}/ipns/copylaradio.com/@common.js" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                            <i class="bi bi-code-square"></i> View Source
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Step 2: Connect User</h5>
                                    <pre class="bg-dark text-light p-3 rounded"><code>const pubkey = await connectNostr();</code></pre>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Step 3: Publish Events</h5>
                                    <pre class="bg-dark text-light p-3 rounded"><code>await publishNote('Hello Web3!');</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Key Concepts</h5>
                                </div>
                                <div class="card-body">
                                    <h6><i class="bi bi-shield-check"></i> MULTIPASS</h6>
                                    <p class="small">Decentralized identity with NOSTR keys. No passwords, no central database.</p>
                                    
                                    <h6 class="mt-3"><i class="bi bi-cloud"></i> IPFS Storage</h6>
                                    <p class="small">Files stored on IPFS with automatic metadata tracking (SHA256).</p>
                                    
                                    <h6 class="mt-3"><i class="bi bi-broadcast"></i> NOSTR Events</h6>
                                    <p class="small">Cryptographically signed events published to decentralized relays.</p>
                                    
                                    <h6 class="mt-3"><i class="bi bi-cpu"></i> Smart Contracts</h6>
                                    <p class="small">Astroport stations automatically process your events according to predefined rules.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 2: Libraries -->
                <div class="tab-pane fade" id="libraries" role="tabpanel">
                    <h3><i class="bi bi-box-seam"></i> Core Libraries</h3>
                    <p class="lead">Understanding which library to use and when</p>
                    
                    <div class="row mt-4">
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="bi bi-file-code"></i> common.js</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Purpose:</strong> Public NOSTR operations and client-side utilities</p>
                                    <p><strong>When to use:</strong> For all public-facing features in your application</p>
                                    
                                    <div class="mb-3">
                                        <strong>üì¶ Library Links:</strong>
                                        <ul class="list-unstyled mt-2">
                                            <li>
                                                <a href="{{ myIPFS }}/ipns/copylaradio.com/common.js" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-download"></i> common.js
                                                </a>
                                                <a href="{{ myIPFS }}/ipns/copylaradio.com/@common.js" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                                    <i class="bi bi-link-45deg"></i> View Source
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <h6 class="mt-3">Key Functions:</h6>
                                    <ul class="small">
                                        <li><code>connectNostr()</code> - Connect to NOSTR wallet</li>
                                        <li><code>publishNote()</code> - Publish public notes (kind 1)</li>
                                        <li><code>uploadPhotoToIPFS()</code> - Upload files to IPFS</li>
                                        <li><code>sendLike()</code> - Send reactions (kind 7)</li>
                                        <li><code>hexToNpub()</code> / <code>npubToHex()</code> - Format conversion</li>
                                        <li><code>fetchUserFollowsWithMetadata()</code> - Get user network</li>
                                    </ul>
                                    
                                    <div class="alert alert-info mt-3 mb-0 small">
                                        <strong>üí° Tip:</strong> Use common.js for everything users can see or interact with publicly.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <div class="card h-100 border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i class="bi bi-lock"></i> nostr.private.js</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Purpose:</strong> Private/encrypted operations and sensitive data</p>
                                    <p><strong>When to use:</strong> For encrypted messages, private keys, sensitive operations</p>
                                    
                                    <div class="mb-3">
                                        <strong>üì¶ Library Links:</strong>
                                        <ul class="list-unstyled mt-2">
                                            <li>
                                                <a href="{{ myIPFS }}/ipns/copylaradio.com/nostr.private.js" target="_blank" class="btn btn-sm btn-outline-warning">
                                                    <i class="bi bi-download"></i> nostr.private.js
                                                </a>
                                                <a href="{{ myIPFS }}/ipns/copylaradio.com/@nostr.private.js" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                                    <i class="bi bi-link-45deg"></i> View Source
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <h6 class="mt-3">Key Functions:</h6>
                                    <ul class="small">
                                        <li><code>encryptDM()</code> - Encrypt direct messages (NIP-04)</li>
                                        <li><code>decryptDM()</code> - Decrypt received messages</li>
                                        <li><code>signEvent()</code> - Sign events with private key</li>
                                        <li><code>generateKeys()</code> - Generate new keypairs</li>
                                    </ul>
                                    
                                    <div class="alert alert-warning mt-3 mb-0 small">
                                        <strong>‚ö†Ô∏è Security:</strong> Only use nostr.private.js when you need encryption or private key operations. Never expose private keys in client code.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4 border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-question-circle"></i> Which Library Should I Use?</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Use Case</th>
                                            <th>Library</th>
                                            <th>Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>User authentication</td>
                                            <td><code>common.js</code></td>
                                            <td>Public operation, uses NIP-07 extension</td>
                                        </tr>
                                        <tr>
                                            <td>Publishing posts</td>
                                            <td><code>common.js</code></td>
                                            <td>Public content, no encryption needed</td>
                                        </tr>
                                        <tr>
                                            <td>File uploads</td>
                                            <td><code>common.js</code></td>
                                            <td>Public IPFS storage with metadata</td>
                                        </tr>
                                        <tr>
                                            <td>Direct messages</td>
                                            <td><code>nostr.private.js</code></td>
                                            <td>Requires encryption (NIP-04)</td>
                                        </tr>
                                        <tr>
                                            <td>Private keys</td>
                                            <td><code>nostr.private.js</code></td>
                                            <td>Sensitive operations only</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-download"></i> Download & Include Libraries</h5>
                        </div>
                        <div class="card-body">
                            <h6>Required Dependencies:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <strong>NostrTools Bundle:</strong>
                                    <a href="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="bi bi-download"></i> nostr.bundle.js
                                    </a>
                                    <span class="text-muted small ms-2">(Required for common.js)</span>
                                </li>
                            </ul>
                            
                            <h6 class="mt-3">Core Libraries:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <strong>common.js:</strong>
                                    <a href="{{ myIPFS }}/ipns/copylaradio.com/common.js" target="_blank" class="btn btn-sm btn-outline-success ms-2">
                                        <i class="bi bi-download"></i> Download
                                    </a>
                                    <a href="{{ myIPFS }}/ipns/copylaradio.com/@common.js" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                        <i class="bi bi-code-square"></i> View Source
                                    </a>
                                </li>
                                <li class="mb-2">
                                    <strong>nostr.private.js:</strong>
                                    <a href="{{ myIPFS }}/ipns/copylaradio.com/nostr.private.js" target="_blank" class="btn btn-sm btn-outline-warning ms-2">
                                        <i class="bi bi-download"></i> Download
                                    </a>
                                    <a href="{{ myIPFS }}/ipns/copylaradio.com/@nostr.private.js" target="_blank" class="btn btn-sm btn-outline-secondary ms-2">
                                        <i class="bi bi-code-square"></i> View Source
                                    </a>
                                </li>
                            </ul>
                            
                            <h6 class="mt-3">Include in Your HTML:</h6>
                            <pre class="bg-dark text-light p-3 rounded"><code>&lt;!-- Required: NostrTools Bundle --&gt;
&lt;script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js"&gt;&lt;/script&gt;

&lt;!-- Core Library: Public Operations --&gt;
&lt;script src="{{ myIPFS }}/ipns/copylaradio.com/common.js"&gt;&lt;/script&gt;

&lt;!-- Optional: Private/Encrypted Operations --&gt;
&lt;script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.private.js"&gt;&lt;/script&gt;</code></pre>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 3: Event Architecture -->
                <div class="tab-pane fade" id="architecture" role="tabpanel">
                    <h3><i class="bi bi-diagram-3"></i> Event-Driven Architecture</h3>
                    <p class="lead">The CSS Revolution: Separating Events from Processing</p>
                    
                    <div class="alert alert-primary">
                        <h5><i class="bi bi-lightbulb"></i> The Core Principle</h5>
                        <p class="mb-0">Just like CSS separated style from content in 1996, Astroport.ONE separates <strong>events</strong> from their <strong>processing</strong>. This allows your events to be processed by any Astroport station according to smart contract rules.</p>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card border-danger">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">‚ùå Traditional Approach</h5>
                                </div>
                                <div class="card-body">
                                    <pre class="bg-dark text-light p-3 rounded small"><code>// Everything coupled together
app.post('/upload', 
  authenticate(),
  validate(),
  saveToDB(),
  processFile(),
  notifyUsers()
);</code></pre>
                                    <p class="mt-3 small"><strong>Problem:</strong> 6 months of infrastructure development, hard to scale, vendor lock-in</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">‚úÖ Astroport.ONE Approach</h5>
                                </div>
                                <div class="card-body">
                                    <pre class="bg-dark text-light p-3 rounded small"><code>// Event separated from processing
const event = {
  kind: 21,  // Video upload
  content: videoData,
  tags: [['url', ipfsUrl]]
};

await publishToNostr(event);
// Smart contracts handle the rest</code></pre>
                                    <p class="mt-3 small"><strong>Result:</strong> 1 week of development, scalable, interoperable</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Event Flow Architecture</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="p-3 bg-light rounded">
                                        <i class="bi bi-code-square" style="font-size: 2rem; color: var(--primary);"></i>
                                        <h6 class="mt-2">1. Your App</h6>
                                        <p class="small">Creates NOSTR events</p>
                                    </div>
                                </div>
                                <div class="col-md-1 text-center align-self-center">
                                    <i class="bi bi-arrow-right" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="col-md-3">
                                    <div class="p-3 bg-light rounded">
                                        <i class="bi bi-broadcast" style="font-size: 2rem; color: var(--primary);"></i>
                                        <h6 class="mt-2">2. NOSTR Relay</h6>
                                        <p class="small">Stores events</p>
                                    </div>
                                </div>
                                <div class="col-md-1 text-center align-self-center">
                                    <i class="bi bi-arrow-right" style="font-size: 1.5rem;"></i>
                                </div>
                                <div class="col-md-3">
                                    <div class="p-3 bg-light rounded">
                                        <i class="bi bi-cpu" style="font-size: 2rem; color: var(--primary);"></i>
                                        <h6 class="mt-2">3. Astroport Station</h6>
                                        <p class="small">Smart contracts process events</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4 border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="bi bi-list-check"></i> Why Separate Events from Processing?</h5>
                        </div>
                        <div class="card-body">
                            <ul>
                                <li><strong>Interoperability:</strong> Your events work with any Astroport-compatible application</li>
                                <li><strong>Scalability:</strong> Multiple stations can process the same events in parallel</li>
                                <li><strong>Maintainability:</strong> Update processing logic without changing event structure</li>
                                <li><strong>Flexibility:</strong> Different stations can apply different rules to the same events</li>
                                <li><strong>Future-proof:</strong> New features can be added via smart contracts without app changes</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-code-square"></i> Identifying Your Events</h5>
                        </div>
                        <div class="card-body">
                            <p>To enable smart contract processing, you need to identify different event types in your application:</p>
                            
                            <h6 class="mt-3">Event Kinds (NOSTR Standard)</h6>
                            <ul class="small">
                                <li><code>kind: 1</code> - Text notes (posts, comments)</li>
                                <li><code>kind: 7</code> - Reactions (likes, emojis)</li>
                                <li><code>kind: 21</code> - Short videos (NIP-71)</li>
                                <li><code>kind: 22</code> - Long videos (NIP-71)</li>
                                <li><code>kind: 1063</code> - File uploads (NIP-94)</li>
                                <li><code>kind: 42</code> - Channel messages (NIP-28)</li>
                                <li><code>kind: 1111</code> - Comments on URLs (NIP-22)</li>
                            </ul>
                            
                            <h6 class="mt-3">Custom Event Tags</h6>
                            <p class="small">Use tags to add context that smart contracts can use:</p>
                            <pre class="bg-dark text-light p-3 rounded small"><code>const event = {
  kind: 1,
  content: "My post",
  tags: [
    ['t', 'myapp'],           // Topic/category
    ['g', '48.86,2.35'],     // Geolocation
    ['r', 'https://...'],     // Reference URL
    ['p', 'pubkey'],          // Reference pubkey
    ['custom', 'value']       // Custom data
  ]
};</code></pre>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 4: Smart Contracts -->
                <div class="tab-pane fade" id="smartcontracts" role="tabpanel">
                    <h3><i class="bi bi-cpu"></i> Astroport Smart Contracts</h3>
                    <p class="lead">How Astroport stations automatically process your events</p>
                    
                    <div class="alert alert-success">
                        <h5><i class="bi bi-check-circle"></i> What Are Smart Contracts?</h5>
                        <p class="mb-0">Smart contracts are executable rules that run on Astroport stations. They automatically process NOSTR events according to predefined logic, without requiring manual intervention.</p>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="bi bi-play-circle"></i> How It Works</h5>
                                </div>
                                <div class="card-body">
                                    <ol>
                                        <li class="mb-2"><strong>Your app publishes an event</strong> to a NOSTR relay</li>
                                        <li class="mb-2"><strong>Astroport station subscribes</strong> to events matching certain criteria</li>
                                        <li class="mb-2"><strong>Smart contract executes</strong> when matching event is found</li>
                                        <li class="mb-2"><strong>Result is published</strong> as a new event or stored in database</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Example Use Cases</h5>
                                </div>
                                <div class="card-body">
                                    <ul>
                                        <li><strong>File Processing:</strong> Automatically generate thumbnails for uploaded images</li>
                                        <li><strong>Notifications:</strong> Send alerts when users are mentioned</li>
                                        <li><strong>Analytics:</strong> Track engagement metrics automatically</li>
                                        <li><strong>Moderation:</strong> Filter content based on rules</li>
                                        <li><strong>Payments:</strong> Process ·∫êen transactions</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-code-square"></i> Example: Video Upload Smart Contract</h5>
                        </div>
                        <div class="card-body">
                            <p>When you publish a video upload event (kind 21), a smart contract automatically:</p>
                            
                            <pre class="bg-dark text-light p-3 rounded"><code>// Your app publishes this event
const videoEvent = {
  kind: 21,
  content: "My video",
  tags: [
    ['url', '/ipfs/QmXXX'],
    ['title', 'My Video Title'],
    ['thumbnail', '/ipfs/QmYYY']
  ]
};

// Smart contract on Astroport station automatically:
// 1. Validates the event structure
// 2. Checks IPFS file exists
// 3. Generates additional thumbnails if needed
// 4. Updates video database
// 5. Notifies subscribers
// 6. Processes payment if required</code></pre>
                            
                            <div class="alert alert-info mt-3">
                                <strong>üí° Key Point:</strong> You don't need to write the smart contract yourself. Astroport stations come with pre-built smart contracts for common operations. You just need to publish the right event structure.
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4 border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Important: Event Structure Matters</h5>
                        </div>
                        <div class="card-body">
                            <p>Smart contracts rely on event structure to know how to process them. Make sure your events follow NOSTR standards:</p>
                            
                            <ul>
                                <li><strong>Use correct event kinds:</strong> Follow NIP standards (NIP-94 for files, NIP-71 for videos, etc.)</li>
                                <li><strong>Include required tags:</strong> Smart contracts look for specific tags to extract data</li>
                                <li><strong>Validate before publishing:</strong> Use <code>hexToNpub()</code> and validation functions from common.js</li>
                                <li><strong>Document your custom tags:</strong> If you add custom tags, document them for other developers</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 5: Examples -->
                <div class="tab-pane fade" id="examples" role="tabpanel">
                    <h3><i class="bi bi-code-slash"></i> Practical Examples</h3>
                    <p class="lead">Real-world code examples you can use in your applications</p>
                    
                    <!-- NOSTR Console Section -->
                    <div class="card mt-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-terminal"></i> NOSTR Console - Real-time Event Monitor</h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Access:</strong> <a href="/dev?console=1" class="btn btn-sm btn-primary" target="_blank">
                                <i class="bi bi-terminal"></i> Open NOSTR Console
                            </a></p>
                            
                            <h6 class="mt-3"><i class="bi bi-info-circle"></i> What is it?</h6>
                            <p>The NOSTR Console is a powerful real-time event monitoring tool that displays all NOSTR events from the last 48 hours, similar to a browser's network console. It's perfect for debugging, monitoring, and understanding NOSTR event flows.</p>
                            
                            <h6 class="mt-3"><i class="bi bi-list-check"></i> Features</h6>
                            <ul>
                                <li><strong>Real-time Monitoring:</strong> Automatically connects to the relay and displays events as they arrive</li>
                                <li><strong>All Event Kinds:</strong> Monitors all NOSTR event kinds (0, 1, 3, 4, 5, 6, 7, and more)</li>
                                <li><strong>Powerful Filtering:</strong>
                                    <ul>
                                        <li>Filter by <code>kind</code> (0=Metadata, 1=Text Note, 3=Contacts, etc.)</li>
                                        <li>Filter by <code>pubkey</code> (hex or npub format)</li>
                                        <li>Filter by tags (<code>#e</code>, <code>#p</code>, <code>#t</code>, <code>#g</code>, etc.)</li>
                                        <li>Filter by geohash</li>
                                        <li>Isolate your own events</li>
                                    </ul>
                                </li>
                                <li><strong>Event Inspection:</strong> Click any event to see detailed JSON view with signature, tags, and content</li>
                                <li><strong>Quick Actions:</strong> Copy event ID, follow pubkey, or filter replies</li>
                                <li><strong>Connection Status:</strong> Detailed connection information with relay URL and authentication status</li>
                            </ul>
                            
                            <h6 class="mt-3"><i class="bi bi-gear"></i> How it Works</h6>
                            <p>The console uses <code>common.js</code> to connect to the relay and subscribes to events from the last 48 hours using multiple filters:</p>
                            <pre class="bg-dark text-light p-3 rounded mt-2"><code>// The console automatically subscribes to:
- Regular events (kinds 0-7)
- Parameterized replaceable events (kinds 10000-10009)
- Other common event types
- All within the last 48 hours

// Uses window.nostrRelay from common.js
const subscription = window.nostrRelay.sub(filters);
subscription.on('event', (event) => {
    // Events are displayed in real-time
});
subscription.on('eose', () => {
    // End of stored events
});</code></pre>
                            
                            <h6 class="mt-3"><i class="bi bi-lightbulb"></i> Use Cases</h6>
                            <ul>
                                <li><strong>Debugging:</strong> See what events your application is publishing</li>
                                <li><strong>Monitoring:</strong> Track events from specific users or tags</li>
                                <li><strong>Learning:</strong> Understand NOSTR event structure and content</li>
                                <li><strong>Testing:</strong> Verify that your events are being published correctly</li>
                                <li><strong>Discovery:</strong> Find interesting events and users on the relay</li>
                            </ul>
                            
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle"></i> <strong>Tip:</strong> The console automatically connects when <code>common.js</code> is loaded. Click the status indicator to see detailed connection information.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Example 1: Authentication -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-shield-check"></i> Example 1: User Authentication</h5>
                        </div>
                        <div class="card-body">
                            <pre class="bg-dark text-light p-3 rounded"><code>// Include libraries
&lt;script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js"&gt;&lt;/script&gt;
&lt;script src="{{ myIPFS }}/ipns/copylaradio.com/common.js"&gt;&lt;/script&gt;

// Connect user
async function login() {
  try {
    const pubkey = await connectNostr(true); // true = force NIP-42 auth
    console.log('User connected:', pubkey);
    
    // Convert to npub for display
    const npub = hexToNpub(pubkey);
    console.log('User npub:', npub);
    
    return pubkey;
  } catch (error) {
    console.error('Login failed:', error);
  }
}</code></pre>
                        </div>
                    </div>
                    
                    <!-- Example 2: Publishing Events -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-send"></i> Example 2: Publishing a Post</h5>
                        </div>
                        <div class="card-body">
                            <pre class="bg-dark text-light p-3 rounded"><code>// Publish a simple text post
async function publishPost(content) {
  const event = await publishNote(content);
  console.log('Post published:', event.id);
  return event;
}

// Publish a post with tags (for smart contract processing)
async function publishPostWithTags(content, tags) {
  const event = await publishNote(content, tags);
  console.log('Post with tags published:', event.id);
  return event;
}

// Example: Post with geolocation
await publishPostWithTags('Hello from Paris!', [
  ['g', '48.86,2.35'],  // Geolocation tag
  ['t', 'travel']        // Topic tag
]);</code></pre>
                        </div>
                    </div>
                    
                    <!-- Example 3: File Upload -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-cloud-upload"></i> Example 3: File Upload</h5>
                        </div>
                        <div class="card-body">
                            <pre class="bg-dark text-light p-3 rounded"><code>// Upload a file to IPFS
async function uploadFile(file) {
  // Upload to IPFS (automatically creates metadata)
  const result = await uploadPhotoToIPFS(file);
  
  console.log('File uploaded:', result.cid);
  console.log('IPFS URL:', result.ipfs_url);
  console.log('Metadata:', result.info);
  
  // The event is automatically published to NOSTR
  // Smart contracts will process it automatically
  
  return result;
}

// Handle file input
document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (file) {
    const result = await uploadFile(file);
    console.log('Upload complete:', result);
  }
});</code></pre>
                        </div>
                    </div>
                    
                    <!-- Example 4: Event Subscription -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-broadcast"></i> Example 4: Subscribing to Events</h5>
                        </div>
                        <div class="card-body">
                            <pre class="bg-dark text-light p-3 rounded"><code>// Subscribe to events from a specific user
async function subscribeToUser(pubkey) {
  // Connect to relay first
  await connectToRelay();
  
  // Subscribe to user's posts
  const sub = window.nostrRelay.sub([{
    kinds: [1],  // Text notes
    authors: [pubkey],
    limit: 10
  }]);
  
  sub.on('event', (event) => {
    console.log('New post:', event.content);
    // Process the event in your app
    displayPost(event);
  });
  
  return sub;
}

// Subscribe to events with specific tags (for smart contract results)
async function subscribeToTaggedEvents(tag) {
  await connectToRelay();
  
  const sub = window.nostrRelay.sub([{
    kinds: [1],
    '#t': [tag],  // Events with this tag
    limit: 50
  }]);
  
  sub.on('event', (event) => {
    // Smart contract may have added additional tags
    console.log('Event with tag:', event);
  });
  
  return sub;
}</code></pre>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 6: API Reference -->
                <div class="tab-pane fade" id="api" role="tabpanel">
                    <h3><i class="bi bi-file-text"></i> API Reference</h3>
                    <p class="lead">Complete reference for common.js functions</p>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><code>connectNostr(forceAuth = false)</code></h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Description:</strong> Connect to NOSTR wallet and optionally authenticate with NIP-42</p>
                            <p><strong>Parameters:</strong></p>
                            <ul>
                                <li><code>forceAuth</code> (boolean, optional): If true, forces NIP-42 authentication</li>
                            </ul>
                            <p><strong>Returns:</strong> Promise resolving to user's hex pubkey</p>
                            <pre class="bg-dark text-light p-3 rounded mt-3"><code>const pubkey = await connectNostr(true);</code></pre>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><code>publishNote(content, additionalTags = [], kind = 1, options = {})</code></h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Description:</strong> Publish a NOSTR note event</p>
                            <p><strong>Parameters:</strong></p>
                            <ul>
                                <li><code>content</code> (string): Note content</li>
                                <li><code>additionalTags</code> (array, optional): Additional tags for the event</li>
                                <li><code>kind</code> (number, optional): Event kind (default: 1)</li>
                                <li><code>options</code> (object, optional): Additional options</li>
                            </ul>
                            <p><strong>Returns:</strong> Promise resolving to published event</p>
                            <pre class="bg-dark text-light p-3 rounded mt-3"><code>const event = await publishNote('Hello!', [['t', 'greeting']]);</code></pre>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><code>uploadPhotoToIPFS(file)</code></h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Description:</strong> Upload a file to IPFS and publish metadata to NOSTR</p>
                            <p><strong>Parameters:</strong></p>
                            <ul>
                                <li><code>file</code> (File): File object from input</li>
                            </ul>
                            <p><strong>Returns:</strong> Promise resolving to upload result with CID, IPFS URL, and metadata</p>
                            <pre class="bg-dark text-light p-3 rounded mt-3"><code>const result = await uploadPhotoToIPFS(file);
console.log(result.cid, result.ipfs_url, result.info);</code></pre>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><code>hexToNpub(hex)</code> / <code>npubToHex(npub)</code></h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Description:</strong> Convert between hex and npub (bech32) formats</p>
                            <p><strong>Parameters:</strong></p>
                            <ul>
                                <li><code>hex</code> (string): 64-character hex pubkey</li>
                                <li><code>npub</code> (string): bech32-encoded npub</li>
                            </ul>
                            <p><strong>Returns:</strong> Converted string or null if invalid</p>
                            <pre class="bg-dark text-light p-3 rounded mt-3"><code>const npub = hexToNpub('60c1133d148ae0d2c4b42506fb4abacac903032680b178010c942bd538643f78');
const hex = npubToHex(npub);</code></pre>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><code>sendLike(eventId, authorPubkey, content = "+")</code></h5>
                        </div>
                        <div class="card-body">
                            <p><strong>Description:</strong> Send a reaction (like) to an event (NIP-25)</p>
                            <p><strong>Parameters:</strong></p>
                            <ul>
                                <li><code>eventId</code> (string): ID of the event to react to</li>
                                <li><code>authorPubkey</code> (string): Author's pubkey</li>
                                <li><code>content</code> (string, optional): Reaction content (default: "+")</li>
                            </ul>
                            <p><strong>Returns:</strong> Promise resolving to published reaction event</p>
                            <pre class="bg-dark text-light p-3 rounded mt-3"><code>await sendLike(eventId, authorPubkey, '‚ù§Ô∏è');</code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Keep existing test modules below tabs -->
        <!-- Module 1: MULTIPASS Authentication -->
        <div class="module-card">
            <div class="module-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#module1Content" aria-expanded="true">
                <div class="module-icon"><i class="bi bi-person-badge"></i></div>
                <div style="flex: 1;">
                    <h2 class="module-title">1. MULTIPASS Authentication</h2>
                    <div>
                        <span class="badge-tech">NOSTR</span>
                        <span class="badge-tech">NIP-07</span>
                        <span class="badge-tech">NIP-42</span>
                    </div>
                </div>
                <div class="collapse-icon">
                    <i class="bi bi-chevron-up"></i>
                </div>
            </div>
            
            <div id="module1Content" class="collapse show">
            
            <p class="lead">Enable decentralized login with NOSTR keys. No passwords, no email, no central database.</p>
            
            <div class="test-area">
                <h5><i class="bi bi-play-circle"></i> Test Authentication</h5>
                
                <div class="alert alert-info mb-3">
                    <h6 class="mb-2"><i class="bi bi-info-circle"></i> How Authentication Works</h6>
                    <ol class="mb-0 small">
                        <li><strong>MULTIPASS Account:</strong> You need a MULTIPASS account registered on this relay</li>
                        <li><strong>Connect:</strong> Click the button below to connect your NOSTR wallet</li>
                        <li><strong>Authenticate:</strong> Your extension will automatically send a NIP-42 event (kind 22242)</li>
                        <li><strong>Relay Acceptance:</strong> The relay accepts your NIP-42 event if you have MULTIPASS</li>
                        <li><strong>Verify:</strong> The system checks for recent authentication (valid 24h)</li>
                        <li><strong>Upload:</strong> Once authenticated, you can upload files securely</li>
                    </ol>
                    <div class="alert alert-warning mt-2 mb-0">
                        <small><strong>‚ö†Ô∏è Important:</strong> If you don't have a MULTIPASS account yet, 
                        <a href="/g1" class="alert-link">create one here</a> first. Without MULTIPASS, 
                        the relay will reject your authentication events.</small>
                    </div>
                </div>
                
                <button class="btn btn-test w-100 mt-2" onclick="testMultipassLogin()">
                    <i class="bi bi-key"></i> Connect with MULTIPASS
                </button>
                <div class="result-box" id="authResult">Click button to test authentication...</div>
                
                <div id="userInfo" style="display:none;" class="user-info mt-3">
                    <strong><i class="bi bi-person-check"></i> Connected:</strong><br>
                    <small>npub: <code id="userNpub"></code></small><br>
                    <small>hex: <code id="userHex"></code></small><br><br>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <a href="#" onclick="viewProfile()" class="btn btn-sm btn-success">
                            <i class="bi bi-person-circle"></i> View My Profile
                        </a>
                        <button id="didStatusBtn" class="btn btn-sm btn-outline-secondary" onclick="checkDIDDocument()">
                            <i class="bi bi-file-earmark-text"></i> <span id="didBtnText">Check DID</span>
                        </button>
                        <button id="udriveBtn" class="btn btn-sm btn-outline-primary" style="display:none;" onclick="openUDrive()">
                            <i class="bi bi-cloud"></i> <span id="udriveBtnText">Open uDRIVE</span>
                        </button>
                        <span id="gpsInfo" class="badge bg-success ms-2" style="display:none; cursor:pointer; transition: all 0.2s;" title="Click to join UMAP chat at your location">
                            <i class="bi bi-geo-alt-fill"></i> <span id="gpsCoords">--</span>
                            <i class="bi bi-chat-dots ms-1" style="font-size: 0.8rem;"></i>
                        </span>
                    </div>
                    <div id="didInfo" class="alert alert-info mt-2" style="display:none;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong><i class="bi bi-shield-check"></i> DID Document (kind 30800)</strong>
                                <div id="didDetails" class="small mt-1"></div>
                            </div>
                            <button class="btn btn-sm btn-link" onclick="refreshDIDDocument()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="code-example mt-3">
<span class="comment">// Simple integration example</span>
<span class="keyword">async function</span> connectMultipass() {
    <span class="comment">// Load common.js from IPFS</span>
    <span class="keyword">const</span> script = document.createElement(<span class="string">'script'</span>);
    script.src = <span class="string">'{{ myIPFS }}/ipns/copylaradio.com/common.js'</span>;
    document.head.appendChild(script);
    
    <span class="comment">// Connect to NOSTR</span>
    <span class="keyword">const</span> pubkey = <span class="keyword">await</span> connectNostr();
    console.log(<span class="string">'Connected:'</span>, pubkey);
    
    <span class="comment">// Use authenticated user</span>
    <span class="keyword">return</span> pubkey;
}
            </div>
            </div> <!-- End module1Content collapse -->
        </div>

        <!-- Module 2: File Publishing -->
        <div class="module-card">
            <div class="module-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#module2Content" aria-expanded="false">
                <div class="module-icon"><i class="bi bi-cloud-upload"></i></div>
                <div style="flex: 1;">
                    <h2 class="module-title">2. Decentralized File Publishing</h2>
                    <div>
                        <span class="badge-tech">IPFS</span>
                        <span class="badge-tech">NIP-94</span>
                        <span class="badge-tech">NIP-71 (videos)</span>
                        <span class="badge-tech">SHA256 tracking</span>
                    </div>
                </div>
                <div class="collapse-icon">
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
            
            <div id="module2Content" class="collapse">
            
            <p class="lead">Upload files to IPFS and publish metadata on NOSTR. View recent uploads from the community.</p>
            
            <div class="test-area">

                <h5><i class="bi bi-file-earmark-arrow-up"></i> Upload File Test</h5>
                
                <div class="file-type-grid">
                    <div class="file-type-btn" onclick="selectFileType('image')">
                        <i class="bi bi-image" style="font-size:2rem;color:var(--primary);"></i>
                        <div class="mt-2">Image</div>
                        <small class="text-muted">NIP-94, kind 1063</small>
                    </div>
                    <div class="file-type-btn" onclick="selectFileType('video')">
                        <i class="bi bi-camera-video" style="font-size:2rem;color:var(--primary);"></i>
                        <div class="mt-2">Video</div>
                        <small class="text-muted">NIP-71, kind 21/22</small>
                    </div>
                    <div class="file-type-btn" onclick="selectFileType('audio')">
                        <i class="bi bi-music-note-beamed" style="font-size:2rem;color:var(--primary);"></i>
                        <div class="mt-2">Audio</div>
                        <small class="text-muted">NIP-94, kind 1063</small>
                    </div>
                    <div class="file-type-btn" onclick="selectFileType('document')">
                        <i class="bi bi-file-earmark-text" style="font-size:2rem;color:var(--primary);"></i>
                        <div class="mt-2">Document</div>
                        <small class="text-muted">NIP-94, kind 1063</small>
                    </div>
                </div>
                
                <input type="file" id="fileInput" class="form-control mt-3" style="display:none;" onchange="uploadFile()">
                <button class="btn btn-test w-100 mt-2" onclick="document.getElementById('fileInput').click()">
                    <i class="bi bi-upload"></i> Select & Upload File
                </button>
                
                <div class="result-box" id="uploadResult">Select a file type above and upload...</div>
                
                <div id="uploadLinks" style="display:none;" class="mt-3">
                    <h6><i class="bi bi-link-45deg"></i> Published Links:</h6>
                    <div class="alert alert-success">
                        <strong>IPFS URL:</strong><br>
                        <a href="#" id="ipfsLink" target="_blank" class="text-break"></a><br><br>
                        <strong>NOSTR Event ID:</strong><br>
                        <code id="nostrEventId" class="text-break"></code><br><br>
                        <strong>Info.json (metadata):</strong><br>
                        <a href="#" id="infoLink" target="_blank" class="text-break"></a>
                    </div>
                </div>

                <h5><i class="bi bi-grid-3x2"></i> Recent Uploads</h5>
                <div id="recentUploads" class="row g-2 mb-3">
                    <div class="col-12 text-center text-muted">
                        <i class="bi bi-arrow-clockwise"></i> Loading recent files and videos...
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary mb-3" onclick="loadRecentUploads()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            
            <div class="code-example mt-3">
<span class="comment">// File upload with automatic metadata</span>
<span class="keyword">async function</span> uploadToIPFS(file, npub) {
    <span class="keyword">const</span> formData = <span class="keyword">new</span> FormData();
    formData.append(<span class="string">'file'</span>, file);
    formData.append(<span class="string">'npub'</span>, npub);
    
    <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(<span class="string">'/api/fileupload'</span>, {
        method: <span class="string">'POST'</span>,
        body: formData
    });
    
    <span class="keyword">const</span> result = <span class="keyword">await</span> response.json();
    <span class="comment">// Returns: { cid, thumbnail_ipfs, info, fileName }</span>
    
    <span class="keyword">return</span> result;
}
            </div>
            </div> <!-- End module2Content collapse -->
        </div>

        <!-- Module 3: Social Interactions -->
        <div class="module-card">
            <div class="module-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#module3Content" aria-expanded="false">
                <div class="module-icon"><i class="bi bi-heart"></i></div>
                <div style="flex: 1;">
                    <h2 class="module-title">3. Social Interactions</h2>
                    <div>
                        <span class="badge-tech">NIP-25</span>
                        <span class="badge-tech">Reactions</span>
                        <span class="badge-tech">Comments</span>
                    </div>
                </div>
                <div class="collapse-icon">
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
            
            <div id="module3Content" class="collapse">
            
            <p class="lead">Add likes, reactions, comments, and shares to any content or URL. Comments and shares are linked to this page.</p>
            
            <div class="test-area">
                <h5><i class="bi bi-hand-thumbs-up"></i> Comments & Shares for this Page</h5>
                
                <div id="pageInteractions" class="mb-3">
                    <div class="text-center text-muted">
                        <i class="bi bi-arrow-clockwise"></i> Loading interactions...
                    </div>
                </div>
                
                <button class="btn btn-sm btn-outline-secondary mb-3" onclick="loadPageInteractions()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                
                <h5><i class="bi bi-pencil-square"></i> Test Actions</h5>
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="testComment()">
                        <i class="bi bi-chat"></i> Post Comment
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="testShare()">
                        <i class="bi bi-share"></i> Share Page
                    </button>
                </div>
                
                <div class="result-box" style="min-height:100px;" id="socialResult">Use buttons above to post comments or share this page...</div>
                
                <div class="alert alert-info mt-2">
                    <small><i class="bi bi-info-circle"></i> Note: Likes require an event ID. Comments and shares are attached to the current page URL.</small>
                </div>
            </div>
            
            <div class="code-example mt-3">
<span class="comment">// Send a like (NIP-25 reaction)</span>
<span class="keyword">async function</span> sendLike(eventId, authorPubkey) {
    <span class="comment">// Uses common.js function</span>
    <span class="keyword">const</span> result = <span class="keyword">await</span> sendLike(eventId, authorPubkey, <span class="string">"+"</span>);
    <span class="keyword">return</span> result;
}

<span class="comment">// Post a comment</span>
<span class="keyword">async function</span> postComment(content, url) {
    <span class="keyword">const</span> result = <span class="keyword">await</span> postComment(content, url);
    <span class="keyword">return</span> result;
}

<span class="comment">// Share to user's feed</span>
<span class="keyword">async function</span> shareContent(url, message) {
    <span class="keyword">const</span> result = <span class="keyword">await</span> shareCurrentPage(message);
    <span class="keyword">return</span> result;
}
            </div>
            </div> <!-- End module3Content collapse -->
        </div>

        <!-- Module 4: Real-time Chat -->
        <div class="module-card">
            <div class="module-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#module4Content" aria-expanded="false">
                <div class="module-icon"><i class="bi bi-chat-dots"></i></div>
                <div style="flex: 1;">
                    <h2 class="module-title">4. Real-time Messaging</h2>
                    <div>
                        <span class="badge-tech">NIP-01</span>
                        <span class="badge-tech">WebSocket</span>
                        <span class="badge-tech">Live Chat</span>
                    </div>
                </div>
                <div class="collapse-icon">
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
            
            <div id="module4Content" class="collapse">
            
            <p class="lead">Add real-time chat to any page. Messages are stored on NOSTR relays using NIP-28 (Public Chat Channels).</p>
            
            <div class="test-area">
                <h5><i class="bi bi-chat-square-text"></i> UMAP Chat Room</h5>
                
                <div class="mb-2">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-secondary">
                            <i class="bi bi-geo-alt"></i> UMAP: <span id="currentUMAP">0.00, 0.00</span>
                        </span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showUMAPSelector()">
                            <i class="bi bi-pencil"></i> Change
                        </button>
                        <span class="badge bg-info ms-auto" title="Active users in this UMAP channel">
                            <i class="bi bi-people-fill"></i> <span id="channelUsersCount">0</span>
                        </span>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="text-center text-muted">
                        <i class="bi bi-arrow-clockwise"></i> Loading messages...
                    </div>
                </div>
                
                <div class="input-group mt-2">
                    <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                    <button class="btn btn-test" onclick="sendChatMessage()">
                        <i class="bi bi-send"></i> Send
                    </button>
                </div>
                
                <small class="text-muted">
                    Geographic chat room using NIP-28 (kind 42 - Public Channel)
                    <br>Channel ID: <code id="channelId">UMAP_0.00_0.00</code>
                </small>
            </div>
            
            <div class="code-example mt-3">
<span class="comment">// Subscribe to real-time messages</span>
<span class="keyword">async function</span> subscribeToChat(hashtag) {
    <span class="keyword">const</span> relay = <span class="keyword">await</span> connectToRelay();
    
    <span class="keyword">const</span> sub = relay.sub([{
        kinds: [1],
        <span class="string">"#t"</span>: [hashtag],
        limit: 50
    }]);
    
    sub.on(<span class="string">'event'</span>, event => {
        displayChatMessage(event);
    });
}

<span class="comment">// Send message</span>
<span class="keyword">async function</span> sendMessage(content, hashtag) {
    <span class="keyword">await</span> publishNote(content, [[<span class="string">"t"</span>, hashtag]]);
}
            </div>
            </div> <!-- End module4Content collapse -->
        </div>

        <!-- Module 5: Developer Examples -->
        <div class="module-card">
            <div class="module-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#module5Content" aria-expanded="false">
                <div class="module-icon"><i class="bi bi-code-slash"></i></div>
                <div style="flex: 1;">
                    <h2 class="module-title">5. Integration Examples</h2>
                    <div>
                        <span class="badge-tech">Templates</span>
                        <span class="badge-tech">Examples</span>
                        <span class="badge-tech">Docs</span>
                    </div>
                </div>
                <div class="collapse-icon">
                    <i class="bi bi-chevron-down"></i>
                </div>
            </div>
            
            <div id="module5Content" class="collapse">
            
            <p class="lead">Explore existing applications and learn from their implementation.</p>
            
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card p-3 mb-3">
                        <h5><i class="bi bi-youtube"></i> NostrTube</h5>
                        <p class="text-muted small">Decentralized video platform with IPFS storage and NOSTR social features.</p>
                        <a href="/youtube?html=1" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> View Demo
                        </a>
                        <a href="#" onclick="showCode('youtube')" class="btn btn-sm btn-link">
                            <i class="bi bi-code"></i> View Code
                        </a>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card p-3 mb-3">
                        <h5><i class="bi bi-play-circle"></i> Theater Mode</h5>
                        <p class="text-muted small">Immersive video player with live comments and reactions.</p>
                        <a href="/theater" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> View Demo
                        </a>
                        <a href="#" onclick="showCode('theater')" class="btn btn-sm btn-link">
                            <i class="bi bi-code"></i> View Code
                        </a>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card p-3 mb-3">
                        <h5><i class="bi bi-collection-play"></i> Playlists</h5>
                        <p class="text-muted small">Manage video playlists stored on NOSTR (NIP-51).</p>
                        <a href="/playlist" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> View Demo
                        </a>
                        <a href="#" onclick="showCode('playlist')" class="btn btn-sm btn-link">
                            <i class="bi bi-code"></i> View Code
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-3">
                <h6><i class="bi bi-book"></i> Documentation & Resources</h6>
                <ul class="mb-0">
                    <li><strong>File Contract:</strong> NIP-94 (images, audio, documents) and NIP-71 (videos)</li>
                    <li><strong>Common.js API:</strong> <code>{{ myIPFS }}/ipns/copylaradio.com/common.js</code></li>
                    <li><strong>Developer Guide:</strong> <a href="https://github.com/papiche/Astroport.ONE/blob/master/docs/README.NostrTube.DEV.md" target="_blank">NostrTube Developer Documentation</a></li>
                    <li><strong>Source Code Examples:</strong>
                        <ul>
                            <li><a href="https://github.com/papiche/UPassport/blob/main/templates/youtube.html" target="_blank">youtube.html</a> - Video platform</li>
                            <li><a href="https://github.com/papiche/UPassport/blob/main/templates/theater-modal.html" target="_blank">theater-modal.html</a> - Theater mode</li>
                            <li><a href="https://github.com/papiche/UPassport/blob/main/templates/playlist-manager.html" target="_blank">playlist-manager.html</a> - Playlist manager</li>
                        </ul>
                    </li>
                    <li><strong>GitHub Repository:</strong> <a href="https://github.com/papiche/Astroport.ONE" target="_blank">Astroport.ONE</a></li>
                    <li><strong>NOSTR NIPs:</strong> <a href="https://github.com/nostr-protocol/nips" target="_blank">Protocol Specifications</a></li>
                </ul>
            </div>
            </div> <!-- End module5Content collapse -->
        </div>

        <!-- Quick Start -->
        <div class="module-card bg-light">
            <h3><i class="bi bi-rocket-takeoff"></i> Quick Start for Developers</h3>
            <p>Add MULTIPASS authentication to your website in 3 steps:</p>
            
            <div class="code-example">
<span class="comment">&lt;!-- 1. Include common.js --&gt;</span>
&lt;script src=<span class="string">"{{ myIPFS }}/ipns/copylaradio.com/common.js"</span>&gt;&lt;/script&gt;

<span class="comment">&lt;!-- 2. Add login button --&gt;</span>
&lt;button onclick=<span class="string">"loginWithMultipass()"</span>&gt;Connect with MULTIPASS&lt;/button&gt;

<span class="comment">&lt;!-- 3. Use the authenticated user --&gt;</span>
&lt;script&gt;
<span class="keyword">async function</span> loginWithMultipass() {
    <span class="keyword">const</span> pubkey = <span class="keyword">await</span> connectNostr();
    console.log(<span class="string">'User connected:'</span>, pubkey);
    
    <span class="comment">// Now you can use all NOSTR features</span>
    <span class="keyword">await</span> publishNote(<span class="string">'Hello from my app!'</span>);
    <span class="keyword">await</span> uploadPhotoToIPFS(file);
    <span class="keyword">await</span> sendLike(eventId, authorPubkey);
}
&lt;/script&gt;
            </div>
            
            <h4 class="mt-4"><i class="bi bi-shield-check"></i> Secure File Upload (NIP-42 Authentication)</h4>
            <p>Ensure proper authentication before uploading to prevent 403 errors:</p>
            
            <div class="alert alert-info mb-3">
                <h6><i class="bi bi-diagram-3"></i> Authentication Flow</h6>
                <pre class="mb-0" style="background: white; border: 1px solid #ddd; padding: 10px; font-size: 0.75rem; line-height: 1.3;">
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Browser    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ NOSTR Wallet ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ    Relay     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ   Backend    ‚îÇ
‚îÇ  (Connect)   ‚îÇ     ‚îÇ  (NIP-42)    ‚îÇ     ‚îÇ (MULTIPASS)  ‚îÇ     ‚îÇ   (Verify)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      Step 1:              Step 2:              Step 3:              Step 4:
  Click Connect      Send kind 22242      Check MULTIPASS    Check recent event
                     auth event           Accept/Reject       24h window

‚úÖ SUCCESS: User can upload files
‚ùå FAILURE: Create MULTIPASS account first (/g1)
                </pre>
            </div>
            
            <div class="code-example">
<span class="comment">// Method 1: Automatic authentication check (recommended)</span>
<span class="keyword">async function</span> uploadFile(file) {
    <span class="comment">// uploadPhotoToIPFS now automatically checks authentication</span>
    <span class="keyword">const</span> result = <span class="keyword">await</span> uploadPhotoToIPFS(file);
    console.log(<span class="string">'Uploaded to IPFS:'</span>, result.ipfs_url);
}

<span class="comment">// Method 2: Manual authentication check</span>
<span class="keyword">async function</span> uploadWithManualCheck(file) {
    <span class="comment">// Verify authentication before upload</span>
    <span class="keyword">const</span> isAuth = <span class="keyword">await</span> ensureAuthentication({
        forceCheck: <span class="keyword">true</span>,  <span class="comment">// Force API verification</span>
        showUI: <span class="keyword">true</span>        <span class="comment">// Show user notifications</span>
    });
    
    <span class="keyword">if</span> (!isAuth) {
        console.error(<span class="string">'Authentication failed'</span>);
        <span class="keyword">return</span>;
    }
    
    <span class="keyword">const</span> result = <span class="keyword">await</span> uploadPhotoToIPFS(file);
    console.log(<span class="string">'Upload successful!'</span>, result);
}

<span class="comment">// Method 3: Check authentication status via API</span>
<span class="keyword">async function</span> checkAuth() {
    <span class="keyword">const</span> status = <span class="keyword">await</span> verifyAuthenticationWithAPI(userPubkey);
    console.log(<span class="string">'Auth status:'</span>, status);
    <span class="comment">// Returns: { auth_verified: true/false, message: "...", ... }</span>
}
            </div>
            
            <div class="alert alert-info mt-3">
                <h6><i class="bi bi-info-circle"></i> Authentication Best Practices</h6>
                <ul class="mb-0">
                    <li><strong>MULTIPASS Required:</strong> The relay only accepts NIP-42 events from registered MULTIPASS accounts</li>
                    <li><strong>NIP-42 Events:</strong> Authentication requires kind 22242 events on the relay</li>
                    <li><strong>24-Hour Validity:</strong> Auth events are valid for 24 hours</li>
                    <li><strong>Automatic Verification:</strong> <code>uploadPhotoToIPFS()</code> now checks auth automatically</li>
                    <li><strong>Manual Checks:</strong> Use <code>ensureAuthentication()</code> for custom workflows</li>
                    <li><strong>Test API:</strong> Use <code>/api/test-nostr?npub=YOUR_KEY</code> to verify auth status</li>
                    <li><strong>Relay Policy:</strong> Users without MULTIPASS or not in amisOfAmis.txt are rejected by default</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container text-center">
            <p class="mb-2">
                <strong>Astroport.ONE Developer Platform</strong>
            </p>
            <p class="mb-2">
                Build with NOSTR, IPFS, and Web3 technologies
            </p>
            <p>
                <a href="https://github.com/papiche/Astroport.ONE" class="text-white me-3" target="_blank">
                    <i class="bi bi-github"></i> GitHub
                </a>
                <a href="/health" class="text-white" target="_blank">
                    <i class="bi bi-heart-pulse"></i> System Status
                </a>
            </p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.bundle.min.js"></script>
    <!-- NostrTools Bundle (required for common.js) -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js"></script>
    <!-- Common.js for NOSTR functions -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/common.js"></script>
    
    <script>
        // App namespace to avoid conflicts with common.js
        window.AstroportDemo = {
            userPubkey: null,
            userNpub: null,
            relayConnected: false,
            chatSubscription: null,
            likeCount: 0,
            selectedFileType: null
        };
        
        // Initialize collapse handlers for module sections
        function initCollapseHandlers() {
            // Get all module headers
            const moduleHeaders = document.querySelectorAll('.module-header[data-bs-toggle="collapse"]');
            
            moduleHeaders.forEach(header => {
                const targetId = header.getAttribute('data-bs-target');
                const collapseElement = document.querySelector(targetId);
                const icon = header.querySelector('.collapse-icon i');
                
                if (!collapseElement) return;
                
                // Update icon on collapse events
                collapseElement.addEventListener('show.bs.collapse', function() {
                    header.setAttribute('aria-expanded', 'true');
                    if (icon) {
                        icon.classList.remove('bi-chevron-down');
                        icon.classList.add('bi-chevron-up');
                    }
                });
                
                collapseElement.addEventListener('hide.bs.collapse', function() {
                    header.setAttribute('aria-expanded', 'false');
                    if (icon) {
                        icon.classList.remove('bi-chevron-up');
                        icon.classList.add('bi-chevron-down');
                    }
                });
            });
            
            console.log('[UI] Initialized', moduleHeaders.length, 'collapsible modules');
        }
        
        // Check NOSTR connection on load
        window.addEventListener('load', async () => {
            console.log('[LOAD] Page loaded, initializing...');
            
            // Initialize collapsible module handlers
            initCollapseHandlers();
            
            // Initialize connection panel with default state
            updateConnectionPanel(false, false);
            
            await checkConnection();
            await loadChatMessages();
            await loadRecentUploads();
            await loadPageInteractions();
            
            // Check if user is already connected (from previous session)
            if (typeof window.nostr !== 'undefined') {
                try {
                    const pubkey = await window.nostr.getPublicKey();
                    if (pubkey) {
                        AstroportDemo.userPubkey = pubkey;
                        if (typeof window.NostrTools !== 'undefined') {
                            AstroportDemo.userNpub = window.NostrTools.nip19.npubEncode(pubkey);
                        }
                        updateConnectionBadge(true);
                        console.log('[AUTH] User already connected:', pubkey.substring(0, 16) + '...');
                        
                        // Check authentication in background
                        setTimeout(async () => {
                            console.log('[AUTH] Checking authentication status in background...');
                            const authCheck = await fetch('/api/test-nostr', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: new URLSearchParams({
                                    'npub': pubkey
                                })
                            });
                            
                            if (authCheck.ok) {
                                const authResult = await authCheck.json();
                                if (!authResult.auth_verified) {
                                    console.warn('[AUTH] ‚ö†Ô∏è User connected but not authenticated. NIP-42 event required.');
                                    // Update badge and panel to show partial connection
                                    updateConnectionBadge(true, false); // connected but not authenticated
                                    updateConnectionPanel(true, false); // Enable "Verify" button
                                    // Show subtle notification
                                    const authResultDiv = document.getElementById('authResult');
                                    if (authResultDiv) {
                                        authResultDiv.textContent = '‚ö†Ô∏è You are connected but need to authenticate.\n';
                                        authResultDiv.textContent += 'Click "Connect with MULTIPASS" to send authentication event.\n';
                                        authResultDiv.textContent += 'This is required for file uploads.';
                                    }
                                } else {
                                    console.log('[AUTH] ‚úÖ User authenticated and ready to upload');
                                    updateConnectionBadge(true, true); // connected and authenticated
                                    updateConnectionPanel(true, true); // Mark as fully authenticated
                                    const authResultDiv = document.getElementById('authResult');
                                    if (authResultDiv) {
                                        authResultDiv.textContent = '‚úÖ Connected and authenticated! You can upload files.';
                                    }
                                }
                            }
                        }, 1000);
                    }
                } catch (e) {
                    console.log('[AUTH] No previous connection found');
                }
            }
        });
        
        async function checkConnection() {
            try {
                console.log('[CONNECTION] Checking NOSTR connection...');
                const statusEl = document.getElementById('nostrStatus');
                const textEl = document.getElementById('connectionStatus');
                
                textEl.textContent = 'Checking NOSTR connection...';
                
                // Try to connect to relay
                if (typeof connectToRelay === 'function') {
                    console.log('[CONNECTION] connectToRelay function found, connecting...');
                    await connectToRelay();
                    statusEl.classList.add('connected');
                    textEl.textContent = 'NOSTR relay connected';
                    AstroportDemo.relayConnected = true;
                    console.log('[CONNECTION] ‚úÖ Connected to relay:', window.nostrRelay);
                } else {
                    console.warn('[CONNECTION] ‚ö†Ô∏è connectToRelay function not available yet');
                    statusEl.classList.add('disconnected');
                    textEl.textContent = 'NOSTR functions loading...';
                }
            } catch (error) {
                console.error('[CONNECTION] ‚ùå Connection check failed:', error);
                document.getElementById('nostrStatus').classList.add('disconnected');
                document.getElementById('connectionStatus').textContent = 'Connection error';
            }
        }
        
        // View user profile
        async function viewProfile() {
            if (!AstroportDemo.userPubkey) {
                alert('Please connect first');
                return;
            }
            
            console.log('[PROFILE] Opening profile viewer for:', AstroportDemo.userPubkey);
            const ipfsGateway = '{{ myIPFS }}';
            const profileUrl = `${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${AstroportDemo.userPubkey}`;
            window.open(profileUrl, '_blank');
        }
        
        // Check DID Document (kind 30800)
        async function checkDIDDocument() {
            if (!AstroportDemo.userPubkey) {
                alert('Please connect first');
                return;
            }
            
            const didBtn = document.getElementById('didStatusBtn');
            const didBtnText = document.getElementById('didBtnText');
            const didInfo = document.getElementById('didInfo');
            const didDetails = document.getElementById('didDetails');
            
            try {
                didBtnText.textContent = 'Checking...';
                didBtn.disabled = true;
                
                console.log('[DID] Fetching DID document (kind 30800) for:', AstroportDemo.userPubkey);
                
                // Check if relay is connected
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[DID] Connecting to relay...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                    }
                }
                
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    // Subscribe to kind 30800 DID document events with d tag "did"
                    const sub = window.nostrRelay.sub([{
                        kinds: [30800], // NIP-101: DID Document
                        authors: [AstroportDemo.userPubkey],
                        "#d": ["did"], // d tag identifies the DID document
                        limit: 1
                    }]);
                    
                    let didFound = false;
                    
                    sub.on('event', event => {
                        console.log('[DID] üìÑ Found DID document:', event);
                        didFound = true;
                        displayDIDInfo(event);
                        sub.unsub();
                    });
                    
                    sub.on('eose', () => {
                        if (!didFound) {
                            console.log('[DID] ‚ö†Ô∏è No DID document found');
                            didBtnText.textContent = 'No DID Found';
                            didBtn.classList.remove('btn-outline-secondary');
                            didBtn.classList.add('btn-outline-warning');
                            didDetails.innerHTML = `
                                <span class="text-warning">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    No DID document (kind 30800) found for this profile.
                                </span><br>
                                <small class="text-muted">
                                    Create a MULTIPASS account at <a href="/g1" target="_blank">/g1</a> to get your DID document.
                                </small>
                            `;
                            didInfo.style.display = 'block';
                            didInfo.classList.remove('alert-info');
                            didInfo.classList.add('alert-warning');
                        }
                        sub.unsub();
                        didBtn.disabled = false;
                    });
                    
                    // Timeout after 5 seconds
                    setTimeout(() => {
                        if (!didFound) {
                            sub.unsub();
                            didBtn.disabled = false;
                            if (didBtnText.textContent === 'Checking...') {
                                didBtnText.textContent = 'Check DID';
                            }
                        }
                    }, 5000);
                } else {
                    throw new Error('Relay not available');
                }
            } catch (error) {
                console.error('[DID] ‚ùå Error checking DID:', error);
                didBtnText.textContent = 'Check Failed';
                didBtn.classList.remove('btn-outline-secondary');
                didBtn.classList.add('btn-outline-danger');
                didDetails.innerHTML = `
                    <span class="text-danger">
                        <i class="bi bi-x-circle"></i> Error: ${error.message}
                    </span>
                `;
                didInfo.style.display = 'block';
                didInfo.classList.remove('alert-info');
                didInfo.classList.add('alert-danger');
                didBtn.disabled = false;
            }
        }
        
        // Display DID Document Information
        function displayDIDInfo(event) {
            const didBtn = document.getElementById('didStatusBtn');
            const didBtnText = document.getElementById('didBtnText');
            const didInfo = document.getElementById('didInfo');
            const didDetails = document.getElementById('didDetails');
            
            try {
                // Parse DID document from event content
                const didDoc = JSON.parse(event.content);
                
                // Update button to show success
                didBtnText.textContent = 'DID Found ‚úì';
                didBtn.classList.remove('btn-outline-secondary', 'btn-outline-warning', 'btn-outline-danger');
                didBtn.classList.add('btn-outline-success');
                
                // Extract key information
                const didId = didDoc.id || 'N/A';
                const created = didDoc.metadata?.created ? new Date(didDoc.metadata.created).toLocaleString() : 'Unknown';
                const updated = didDoc.metadata?.updated ? new Date(didDoc.metadata.updated).toLocaleString() : 'Unknown';
                const contractStatus = didDoc.metadata?.contractStatus || 'unknown';
                const storageQuota = didDoc.metadata?.storageQuota || 'N/A';
                const services = didDoc.service?.length || 0;
                const verificationMethods = didDoc.verificationMethod?.length || 0;
                
                // Check for MULTIPASS wallet
                const multipassWallet = didDoc.metadata?.multipassWallet?.g1pub || 'N/A';
                
                // Check for ZEN Card wallet
                const zencardWallet = didDoc.metadata?.zencardWallet?.g1pub || 'N/A';
                
                // Check for WoT verification
                const wotMember = didDoc.metadata?.wotDuniterMember?.g1pub || null;
                
                // Build display HTML
                let html = `
                    <div class="small">
                        <strong>DID ID:</strong> <code class="small">${didId.substring(0, 40)}...</code><br>
                        <strong>Status:</strong> <span class="badge bg-primary">${contractStatus}</span><br>
                        <strong>Storage:</strong> ${storageQuota}<br>
                        <strong>Created:</strong> ${created}<br>
                        <strong>Updated:</strong> ${updated}<br>
                        <strong>Services:</strong> ${services} endpoint(s)<br>
                        <strong>Keys:</strong> ${verificationMethods} verification method(s)<br>
                `;
                
                if (multipassWallet !== 'N/A') {
                    html += `<strong>MULTIPASS:</strong> <code class="small">${multipassWallet.substring(0, 12)}...</code><br>`;
                }
                
                if (zencardWallet !== 'N/A') {
                    html += `<strong>ZEN Card:</strong> <code class="small">${zencardWallet.substring(0, 12)}...</code><br>`;
                }
                
                if (wotMember) {
                    html += `<strong>WoT Member:</strong> <span class="badge bg-success"><i class="bi bi-check-circle"></i> Verified</span><br>`;
                }
                
                html += `
                        <div class="mt-2">
                            <a href="#" onclick="viewFullDIDDocument(); return false;" class="btn btn-xs btn-outline-primary">
                                <i class="bi bi-file-code"></i> View Full Document
                            </a>
                            <a href="https://www.w3.org/TR/did-core/" target="_blank" class="btn btn-xs btn-outline-secondary">
                                <i class="bi bi-book"></i> W3C DID Spec
                            </a>
                        </div>
                    </div>
                `;
                
                didDetails.innerHTML = html;
                didInfo.style.display = 'block';
                didInfo.classList.remove('alert-warning', 'alert-danger');
                didInfo.classList.add('alert-info');
                
                // Store DID document for later use
                AstroportDemo.userDID = didDoc;
                AstroportDemo.userDIDEvent = event;
                
            } catch (error) {
                console.error('[DID] Error parsing DID document:', error);
                didDetails.innerHTML = `
                    <span class="text-danger">
                        <i class="bi bi-x-circle"></i> Error parsing DID document: ${error.message}
                    </span>
                `;
                didInfo.style.display = 'block';
                didInfo.classList.remove('alert-info');
                didInfo.classList.add('alert-danger');
            }
        }
        
        // View Full DID Document
        function viewFullDIDDocument() {
            if (!AstroportDemo.userDID) {
                alert('No DID document loaded');
                return;
            }
            
            // Create a modal or new window to display the full JSON
            const didJson = JSON.stringify(AstroportDemo.userDID, null, 2);
            const win = window.open('', '_blank', 'width=800,height=600');
            win.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DID Document - ${AstroportDemo.userDID.id}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; background: #1a1a1a; color: #e0e0e0; }
                        pre { background: #2a2a2a; padding: 20px; border-radius: 8px; overflow-x: auto; }
                        .header { margin-bottom: 20px; }
                        .badge { font-size: 0.9rem; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h2><i class="bi bi-file-earmark-text"></i> DID Document</h2>
                            <p class="lead">Decentralized Identifier (W3C DID Core v1.1)</p>
                            <span class="badge bg-primary">Kind 30800</span>
                            <span class="badge bg-success">NIP-101</span>
                            <span class="badge bg-info">Event ID: ${AstroportDemo.userDIDEvent.id.substring(0, 16)}...</span>
                        </div>
                        <pre><code>${escapeHtml(didJson)}</code></pre>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${didJson.replace(/'/g, "\\'")}'); alert('Copied to clipboard!');">
                                <i class="bi bi-clipboard"></i> Copy JSON
                            </button>
                            <a href="https://www.w3.org/TR/did-core/" target="_blank" class="btn btn-secondary">
                                <i class="bi bi-book"></i> W3C DID Specification
                            </a>
                            <a href="https://github.com/nostr-protocol/nips/blob/master/README.md" target="_blank" class="btn btn-secondary">
                                <i class="bi bi-file-text"></i> NOSTR NIPs
                            </a>
                        </div>
                    </div>
                </body>
                </html>
            `);
            win.document.close();
        }
        
        // Refresh DID Document
        async function refreshDIDDocument() {
            const didInfo = document.getElementById('didInfo');
            didInfo.style.display = 'none';
            
            const didBtn = document.getElementById('didStatusBtn');
            const didBtnText = document.getElementById('didBtnText');
            didBtnText.textContent = 'Check DID';
            didBtn.classList.remove('btn-outline-success', 'btn-outline-warning', 'btn-outline-danger');
            didBtn.classList.add('btn-outline-secondary');
            
            await checkDIDDocument();
        }
        
        // Check NOSTR Profile (kind 0) and extract uDRIVE link
        async function checkNostrProfile() {
            if (!AstroportDemo.userPubkey) {
                console.warn('[PROFILE] No pubkey available');
                return null;
            }
            
            try {
                console.log('[PROFILE] Fetching NOSTR profile (kind 0) for:', AstroportDemo.userPubkey);
                
                // Check if relay is connected
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[PROFILE] Connecting to relay...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                    }
                }
                
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    // Subscribe to kind 0 profile metadata events
                    const sub = window.nostrRelay.sub([{
                        kinds: [0], // Profile metadata
                        authors: [AstroportDemo.userPubkey],
                        limit: 1
                    }]);
                    
                    return new Promise((resolve) => {
                        let profileFound = false;
                        
                        sub.on('event', event => {
                            console.log('[PROFILE] üìá Found profile:', event);
                            profileFound = true;
                            
                            try {
                                // Parse profile metadata
                                const metadata = JSON.parse(event.content);
                                console.log('[PROFILE] Metadata:', metadata);
                                
                                // Extract tags with identity information
                                const tags = event.tags || [];
                                const identities = {};
                                
                                tags.forEach(tag => {
                                    if (tag[0] === 'i' && tag[1]) {
                                        // Split only on the FIRST colon to handle URLs correctly
                                        const colonIndex = tag[1].indexOf(':');
                                        if (colonIndex > 0) {
                                            const key = tag[1].substring(0, colonIndex);
                                            const value = tag[1].substring(colonIndex + 1);
                                            identities[key] = value;
                                        }
                                    }
                                });
                                
                                console.log('[PROFILE] Identities found:', identities);
                                
                                // Store profile data
                                AstroportDemo.userProfile = {
                                    metadata: metadata,
                                    identities: identities,
                                    event: event
                                };
                                
                                resolve(identities);
                            } catch (error) {
                                console.error('[PROFILE] Error parsing profile:', error);
                                resolve(null);
                            }
                            
                            sub.unsub();
                        });
                        
                        sub.on('eose', () => {
                            if (!profileFound) {
                                console.log('[PROFILE] ‚ö†Ô∏è No profile found');
                                resolve(null);
                            }
                            sub.unsub();
                        });
                        
                        // Timeout after 5 seconds
                        setTimeout(() => {
                            if (!profileFound) {
                                sub.unsub();
                                resolve(null);
                            }
                        }, 5000);
                    });
                } else {
                    console.warn('[PROFILE] Relay not available');
                    return null;
                }
            } catch (error) {
                console.error('[PROFILE] ‚ùå Error checking profile:', error);
                return null;
            }
        }
        
        // Open uDRIVE from profile data
        async function openUDrive() {
            const udriveBtn = document.getElementById('udriveBtn');
            const udriveBtnText = document.getElementById('udriveBtnText');
            
            try {
                udriveBtnText.textContent = 'Opening...';
                udriveBtn.disabled = true;
                
                // Check if we already have profile data
                let identities = AstroportDemo.userProfile?.identities;
                
                if (!identities) {
                    console.log('[UDRIVE] Fetching profile data...');
                    identities = await checkNostrProfile();
                }
                
                if (!identities) {
                    alert('Could not retrieve profile data. Please try again.');
                    return;
                }
                
                // Look for IPNS vault link
                let ipnsVault = identities.ipns_vault;
                let ipfsGw = identities.ipfs_gw || '{{ myIPFS }}';
                const email = identities.email;
                
                console.log('[UDRIVE] Raw identities:', identities);
                console.log('[UDRIVE] ipfs_gw from profile:', identities.ipfs_gw);
                console.log('[UDRIVE] Template myIPFS:', '{{ myIPFS }}');
                console.log('[UDRIVE] ipns_vault from profile:', identities.ipns_vault);
                
                // Clean up ipnsVault - remove leading /ipns/ if present
                if (ipnsVault && ipnsVault.startsWith('/ipns/')) {
                    ipnsVault = ipnsVault.substring(6); // Remove "/ipns/"
                    console.log('[UDRIVE] Cleaned ipnsVault (removed /ipns/):', ipnsVault);
                }
                
                // Clean up ipfsGw
                // If ipfsGw is just "http" or looks incomplete, use template default
                if (!ipfsGw || ipfsGw === 'http' || ipfsGw === 'https' || ipfsGw.length < 10) {
                    console.log('[UDRIVE] ipfs_gw invalid, using template default');
                    ipfsGw = '{{ myIPFS }}';
                }
                
                // Remove trailing slashes
                ipfsGw = ipfsGw.replace(/\/+$/, '');
                
                // Ensure ipfsGw starts with http:// or https://
                if (!ipfsGw.startsWith('http://') && !ipfsGw.startsWith('https://')) {
                    ipfsGw = 'http://' + ipfsGw;
                }
                
                console.log('[UDRIVE] Final ipfsGw:', ipfsGw);
                console.log('[UDRIVE] Final ipnsVault:', ipnsVault);
                
                if (!ipnsVault) {
                    alert('No uDRIVE link found in your profile.\n\nMake sure your profile includes an "ipns_vault" tag.\nCreate a MULTIPASS at /g1 to get your uDRIVE.');
                    return;
                }
                
                if (!email) {
                    alert('No email found in your profile.\n\nThe email is required to build the uDRIVE path.\nMake sure your profile includes an "email" tag.');
                    return;
                }
                
                // Build uDRIVE URL: IPFS_GW/ipns/VAULT/EMAIL/APP/uDRIVE
                const udriveUrl = `${ipfsGw}/ipns/${ipnsVault}/${email}/APP/uDRIVE`;
                console.log('[UDRIVE] Final URL:', udriveUrl);
                
                // Open in new tab
                window.open(udriveUrl, '_blank');
                
                udriveBtnText.textContent = 'Open uDRIVE';
                
            } catch (error) {
                console.error('[UDRIVE] Error:', error);
                alert(`Error opening uDRIVE: ${error.message}`);
                udriveBtnText.textContent = 'Open uDRIVE';
            } finally {
                udriveBtn.disabled = false;
            }
        }
        
        // Check and show uDRIVE button after connection
        async function checkAndShowUDriveButton() {
            const udriveBtn = document.getElementById('udriveBtn');
            
            try {
                console.log('[UDRIVE] Checking for uDRIVE link...');
                const identities = await checkNostrProfile();
                
                if (identities && identities.ipns_vault) {
                    console.log('[UDRIVE] ‚úÖ uDRIVE link found:', identities.ipns_vault);
                    udriveBtn.style.display = 'inline-block';
                } else {
                    console.log('[UDRIVE] ‚ö†Ô∏è No uDRIVE link in profile');
                    udriveBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('[UDRIVE] Error checking uDRIVE:', error);
                udriveBtn.style.display = 'none';
            }
        }
        
        // Check and show GPS coordinates after connection
        async function checkAndShowGPS() {
            const gpsInfo = document.getElementById('gpsInfo');
            const gpsCoords = document.getElementById('gpsCoords');
            
            if (!AstroportDemo.userPubkey) {
                console.log('[GPS] No user pubkey, skipping GPS check');
                return;
            }
            
            try {
                console.log('[GPS] Fetching GPS coordinates from /api/myGPS...');
                
                const gpsResponse = await fetch(`/api/myGPS?npub=${AstroportDemo.userPubkey}`);
                
                if (gpsResponse.ok) {
                    const gpsData = await gpsResponse.json();
                    
                    if (gpsData.success && gpsData.coordinates) {
                        console.log('[GPS] ‚úÖ GPS coordinates retrieved:', gpsData.umap_key);
                        
                        // Display GPS coordinates
                        gpsCoords.textContent = gpsData.umap_key;
                        gpsInfo.style.display = 'inline-block';
                        gpsInfo.title = `üìç Your GPS location: ${gpsData.umap_key}\nüí¨ Click to join UMAP chat at your location`;
                        
                        // Make it clickable to change UMAP chat
                        gpsInfo.style.cursor = 'pointer';
                        gpsInfo.onclick = () => {
                            console.log('[GPS] Switching UMAP chat to user location:', gpsData.umap_key);
                            // Close the badge to show we're switching
                            const notification = document.createElement('div');
                            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                            notification.style.top = '80px';
                            notification.style.right = '20px';
                            notification.style.zIndex = '9998';
                            notification.innerHTML = `
                                <i class="bi bi-check-circle"></i> Switching to your UMAP chat (${gpsData.umap_key})...
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 3000);
                            
                            selectUMAP(gpsData.coordinates.lat, gpsData.coordinates.lon, gpsData.umap_key);
                        };
                    } else {
                        console.log('[GPS] No valid GPS data received');
                        gpsInfo.style.display = 'none';
                    }
                } else if (gpsResponse.status === 403) {
                    console.log('[GPS] GPS access denied (authentication required)');
                    gpsInfo.style.display = 'none';
                } else if (gpsResponse.status === 404) {
                    console.log('[GPS] GPS coordinates not found for this user');
                    gpsInfo.style.display = 'none';
                } else {
                    console.warn('[GPS] GPS fetch failed with status:', gpsResponse.status);
                    gpsInfo.style.display = 'none';
                }
            } catch (error) {
                console.warn('[GPS] Error fetching GPS coordinates:', error);
                gpsInfo.style.display = 'none';
            }
        }
        
        async function testMultipassLogin() {
            const resultEl = document.getElementById('authResult');
            const userInfoEl = document.getElementById('userInfo');
            
            try {
                resultEl.textContent = 'üîÑ Connecting to NOSTR...\n';
                
                // Connect using common.js with forceAuth = true to send NIP-42 event
                console.log('[AUTH] Connecting with forced NIP-42 authentication...');
                AstroportDemo.userPubkey = await connectNostr(true); // Force NIP-42 auth
                
                if (!AstroportDemo.userPubkey) {
                    throw new Error('No public key returned');
                }
                
                resultEl.textContent += '‚úÖ Connected successfully!\n\n';
                resultEl.textContent += `Public Key (hex):\n${AstroportDemo.userPubkey}\n\n`;
                
                // Convert to npub if possible
                if (typeof window.NostrTools !== 'undefined') {
                    AstroportDemo.userNpub = window.NostrTools.nip19.npubEncode(AstroportDemo.userPubkey);
                    resultEl.textContent += `Public Key (npub):\n${AstroportDemo.userNpub}\n`;
                }
                
                // Wait a bit for NIP-42 event to be sent and processed
                resultEl.textContent += '\n‚è≥ Sending authentication event (NIP-42)...\n';
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Verify authentication was successful
                resultEl.textContent += '\nüîç Verifying authentication...\n';
                const authCheck = await fetch('/api/test-nostr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'npub': AstroportDemo.userPubkey
                    })
                });
                
                if (authCheck.ok) {
                    const authResult = await authCheck.json();
                    if (authResult.auth_verified) {
                        resultEl.textContent += '‚úÖ Authentication verified! You can now upload files.\n';
                        updateConnectionBadge(true, true); // Fully authenticated
                    } else {
                        resultEl.textContent += '‚ö†Ô∏è Authentication pending. Please try again in a moment.\n';
                        updateConnectionBadge(true, false); // Connected but not authenticated
                    }
                } else {
                    updateConnectionBadge(true, false); // Connected but verification failed
                }
                
                // Show user info
                document.getElementById('userNpub').textContent = AstroportDemo.userNpub || 'N/A';
                document.getElementById('userHex').textContent = AstroportDemo.userPubkey;
                userInfoEl.style.display = 'block';
                
                // Update fixed connection badge
                updateConnectionBadge(true);
                
                // Auto-check DID document in background
                setTimeout(() => {
                    console.log('[AUTH] Auto-checking DID document...');
                    checkDIDDocument().catch(err => {
                        console.warn('[AUTH] Could not auto-check DID:', err);
                    });
                }, 1000);
                
                // Auto-check and show uDRIVE button
                setTimeout(() => {
                    console.log('[AUTH] Checking for uDRIVE link...');
                    checkAndShowUDriveButton().catch(err => {
                        console.warn('[AUTH] Could not check uDRIVE:', err);
                    });
                    
                    // Also check and show GPS coordinates
                    console.log('[AUTH] Checking for GPS coordinates...');
                    checkAndShowGPS().catch(err => {
                        console.warn('[AUTH] Could not check GPS:', err);
                    });
                }, 1500);
                
            } catch (error) {
                resultEl.textContent = '‚ùå Connection failed\n\n';
                resultEl.textContent += `Error: ${error.message}\n\n`;
                resultEl.textContent += 'Make sure you have a NOSTR extension installed (nos2x, Alby, etc.)';
                console.error('Auth error:', error);
                
                // Update badge to show error
                updateConnectionBadge(false);
            }
        }
        
        // Update the fixed connection badge
        // authenticated: true/false - wallet connected
        // authVerified: true/false/undefined - NIP-42 authentication status
        function updateConnectionBadge(authenticated, authVerified) {
            const badge = document.getElementById('connectionBadge');
            const content = document.getElementById('connectionBadgeContent');
            const connectBtn = document.getElementById('connectBtn');
            
            // Clear all state classes
            badge.classList.remove('authenticated', 'connected-not-auth', 'disconnected');
            
            if (authenticated && AstroportDemo.userPubkey) {
                const npubShort = AstroportDemo.userNpub 
                    ? AstroportDemo.userNpub.substring(0, 12) + '...' 
                    : AstroportDemo.userPubkey.substring(0, 8) + '...';
                
                if (authVerified === true) {
                    // Fully authenticated (wallet connected + NIP-42 verified)
                    badge.classList.add('authenticated');
                    content.innerHTML = `
                        <span class="status-text">‚úÖ Authenticated</span>
                        <span class="user-npub">${npubShort}</span>
                    `;
                } else if (authVerified === false) {
                    // Connected but not authenticated (wallet connected, no NIP-42)
                    badge.classList.add('connected-not-auth');
                    content.innerHTML = `
                        <span class="status-text">‚ö†Ô∏è Not Authenticated</span>
                        <span class="user-npub">${npubShort}</span>
                    `;
                } else {
                    // Connected, auth status unknown
                    badge.classList.add('connected-not-auth');
                    content.innerHTML = `
                        <span class="status-text">Connected</span>
                        <span class="user-npub">${npubShort}</span>
                    `;
                }
                
                // Replace connect button with profile button
                if (connectBtn) {
                    connectBtn.outerHTML = `
                        <button class="btn-profile" onclick="event.stopPropagation(); viewProfile()">
                            <i class="bi bi-person-circle"></i> Profile
                        </button>
                    `;
                }
            } else {
                // Not connected at all
                badge.classList.add('disconnected');
                content.innerHTML = `
                    <span class="status-text">Not Connected</span>
                `;
                
                // Restore connect button if it was replaced
                if (!connectBtn) {
                    const btnProfile = badge.querySelector('.btn-profile');
                    if (btnProfile) {
                        btnProfile.outerHTML = `
                            <button class="btn-connect" onclick="event.stopPropagation(); testMultipassLogin()" id="connectBtn">
                                <i class="bi bi-key"></i> Connect
                            </button>
                        `;
                    }
                }
            }
            
            // Update the connection panel steps based on state
            updateConnectionPanel(authenticated, authVerified);
        }
        
        // Toggle connection panel visibility
        function toggleConnectionPanel() {
            const panel = document.getElementById('connectionPanel');
            panel.classList.toggle('show');
        }
        
        // Update connection panel steps (simplified: 2 steps)
        function updateConnectionPanel(authenticated, authVerified) {
            const panel = document.getElementById('connectionPanel');
            const panelTitle = document.getElementById('panelTitle');
            const panelStatusIcon = document.getElementById('panelStatusIcon');
            
            // Step 1: Relay connection (Public Read)
            const relayConnected = typeof nostrRelay !== 'undefined' && nostrRelay !== null;
            if (relayConnected) {
                updateStep(1, 'success', 'Connected to relay - Public events readable');
            } else {
                updateStep(1, 'pending', 'NOSTR Relay - Read public events');
            }
            
            // Step 2: NIP-42 Authentication (Personal Read/Write)
            if (authVerified === true) {
                // Fully authenticated
                updateStep(2, 'success', 'Authenticated - API personal read + write uDRIVE ‚úì');
            } else if (authenticated && authVerified === false) {
                // Connected but not verified
                updateStep(2, 'error', 'Not authenticated - Click "Connect with MULTIPASS" to retry');
            } else if (authenticated && authVerified === null) {
                // Verifying...
                updateStep(2, 'in-progress', 'Verifying authentication...');
            } else {
                // Not connected at all
                updateStep(2, 'pending', 'NIP-42 Auth - API personal read + write uDRIVE');
            }
            
            // Enable/disable buttons
            document.getElementById('step1-btn').disabled = relayConnected;
            
            // Step 2 button: 
            // - Enabled if relay connected AND (not authenticated OR not verified)
            // - Disabled if already fully authenticated
            const step2Enabled = relayConnected && authVerified !== true;
            document.getElementById('step2-btn').disabled = !step2Enabled;
            
            // Update panel color based on connection level
            // Remove all level classes first
            panel.classList.remove('level-disconnected', 'level-public', 'level-partial', 'level-full');
            
            // Determine level and update UI
            let levelTitle = 'Connection Status';
            let iconColor = '#9ca3af';  // gray
            
            if (!relayConnected) {
                // Level 0: Not connected at all
                panel.classList.add('level-disconnected');
                levelTitle = '‚ö´ Disconnected';
                iconColor = '#9ca3af';  // gray
            } else if (authVerified === true) {
                // Level 3: Fully authenticated (relay + NIP-42)
                panel.classList.add('level-full');
                levelTitle = 'üü¢ Full Access';
                iconColor = '#10b981';  // green
            } else if (authenticated && authVerified === false) {
                // Level 2: Connected but not authenticated (relay + wallet, no NIP-42)
                panel.classList.add('level-partial');
                levelTitle = 'üü† Partial Access';
                iconColor = '#f59e0b';  // orange
            } else {
                // Level 1: Only relay connected (public read)
                panel.classList.add('level-public');
                levelTitle = 'üîµ Public Read';
                iconColor = '#3b82f6';  // blue
            }
            
            // Update title and icon
            if (panelTitle) {
                panelTitle.innerHTML = `<i class="bi bi-circle-fill" style="font-size: 0.6rem; margin-right: 0.5rem; color: ${iconColor};"></i>${levelTitle}`;
            }
        }
        
        // Update individual step
        function updateStep(stepNum, state, description) {
            const step = document.getElementById(`step${stepNum}`);
            const desc = document.getElementById(`step${stepNum}-desc`);
            
            // Remove all state classes
            step.classList.remove('pending', 'in-progress', 'success', 'error');
            
            // Add new state class
            step.classList.add(state);
            
            // Update description
            if (desc) {
                desc.textContent = description;
            }
        }
        
        // Manual actions for each step
        async function manualConnectRelay() {
            console.log('[PANEL] Manual relay connection requested');
            updateStep(1, 'in-progress', 'Connecting to relay...');
            
            try {
                if (typeof connectToRelay === 'function') {
                    await connectToRelay();
                    updateStep(1, 'success', 'Connected to relay - Public events readable');
                    updateConnectionPanel(false, undefined);
                } else {
                    throw new Error('connectToRelay function not found');
                }
            } catch (error) {
                console.error('[PANEL] Relay connection failed:', error);
                updateStep(1, 'error', 'Connection failed: ' + error.message);
            }
        }
        
        function selectFileType(type) {
            AstroportDemo.selectedFileType = type;
            
            // Update UI
            document.querySelectorAll('.file-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.file-type-btn').classList.add('active');
            
            document.getElementById('uploadResult').textContent = `üìÅ ${type.toUpperCase()} selected. Click "Select & Upload File" to continue...`;
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const resultEl = document.getElementById('uploadResult');
            const linksEl = document.getElementById('uploadLinks');
            
            if (!file) {
                resultEl.textContent = '‚ùå No file selected';
                return;
            }
            
            if (!AstroportDemo.userPubkey && !AstroportDemo.userNpub) {
                resultEl.textContent = '‚ùå Please connect with MULTIPASS first';
                return;
            }
            
            try {
                resultEl.textContent = `üîÑ Uploading ${file.name}...\n`;
                resultEl.textContent += `Size: ${(file.size / 1024 / 1024).toFixed(2)} MB\n`;
                resultEl.textContent += `Type: ${file.type}\n\n`;
                
                // Verify authentication before upload
                resultEl.textContent += 'üîê Verifying authentication...\n';
                const authCheck = await fetch('/api/test-nostr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'npub': AstroportDemo.userPubkey || AstroportDemo.userNpub
                    })
                });
                
                if (!authCheck.ok) {
                    throw new Error('Authentication verification failed');
                }
                
                const authResult = await authCheck.json();
                console.log('[AUTH] Authentication check result:', authResult);
                
                if (!authResult.auth_verified) {
                    // Auto-retry authentication instead of showing error
                    resultEl.textContent += '‚ö†Ô∏è No recent NIP-42 event found\n';
                    resultEl.textContent += 'üîÑ Sending authentication event automatically...\n\n';
                    
                    console.log('[UPLOAD] Auto-sending NIP-42 authentication...');
                    
                    try {
                        // Force NIP-42 authentication
                        if (typeof connectNostr === 'function') {
                            await connectNostr(true); // true = force NIP-42 auth
                            
                            // Wait longer for relay to process authentication
                            resultEl.textContent += '‚è≥ Waiting for relay to process authentication...\n';
                            await new Promise(resolve => setTimeout(resolve, 3000)); // Increased from 2s to 3s
                            
                            // Verify again with multiple retries
                            resultEl.textContent += 'üîç Verifying authentication...\n';
                            
                            let authVerified = false;
                            let lastError = null;
                            
                            // Try 3 times with 1s delay between each attempt
                            for (let attempt = 1; attempt <= 3; attempt++) {
                                try {
                                    const recheckAuth = await fetch('/api/test-nostr', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/x-www-form-urlencoded',
                                        },
                                        body: new URLSearchParams({
                                            'npub': AstroportDemo.userPubkey || AstroportDemo.userNpub
                                        })
                                    });
                                    
                                    if (recheckAuth.ok) {
                                        const recheckResult = await recheckAuth.json();
                                        if (recheckResult.auth_verified) {
                                            authVerified = true;
                                            resultEl.textContent += `‚úÖ Authentication successful! (attempt ${attempt}/3)\n\n`;
                                            updateConnectionBadge(true, true); // Update badge
                                            break;
                                        } else {
                                            lastError = 'Authentication not yet verified on relay';
                                            if (attempt < 3) {
                                                resultEl.textContent += `   Attempt ${attempt}/3 - waiting...\n`;
                                                await new Promise(resolve => setTimeout(resolve, 1000));
                                            }
                                        }
                                    } else {
                                        lastError = `HTTP ${recheckAuth.status}`;
                                        if (attempt < 3) {
                                            await new Promise(resolve => setTimeout(resolve, 1000));
                                        }
                                    }
                                } catch (e) {
                                    lastError = e.message;
                                    if (attempt < 3) {
                                        await new Promise(resolve => setTimeout(resolve, 1000));
                                    }
                                }
                            }
                            
                            if (!authVerified) {
                                throw new Error(`Authentication verification failed after 3 attempts: ${lastError}`);
                            }
                        } else {
                            throw new Error('connectNostr function not available');
                        }
                    } catch (authError) {
                        console.error('[UPLOAD] Auto-authentication failed:', authError);
                        resultEl.textContent += `‚ùå Authentication failed: ${authError.message}\n\n`;
                        
                        // Show detailed help
                        if (authResult.status === 'partial' && authResult.relay_connected) {
                            resultEl.textContent += '‚ö†Ô∏è Possible causes:\n';
                            resultEl.textContent += '   1. You need a MULTIPASS account (create at /g1)\n';
                            resultEl.textContent += '   2. The relay rejected your NIP-42 event\n';
                            resultEl.textContent += '   3. Your NOSTR extension blocked the request\n\n';
                        }
                        
                        resultEl.textContent += 'üëâ Please click "Connect with MULTIPASS" button above and try again.';
                        
                        // Update badge to show not authenticated
                        updateConnectionBadge(true, false);
                        
                        return;
                    }
                } else {
                    resultEl.textContent += '‚úÖ Authentication verified!\n\n';
                }
                
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                formData.append('npub', AstroportDemo.userNpub || AstroportDemo.userPubkey);
                
                // Upload to API
                resultEl.textContent += 'üì§ Uploading to IPFS...\n';
                const response = await fetch('/api/fileupload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${response.statusText} - ${errorText}`);
                }
                
                const result = await response.json();
                
                resultEl.textContent += '‚úÖ Upload successful!\n\n';
                resultEl.textContent += `üì¶ IPFS CID: ${result.new_cid || result.cid}\n\n`;
                
                if (result.thumbnail_ipfs) {
                    resultEl.textContent += `üñºÔ∏è Thumbnail: ${result.thumbnail_ipfs}\n`;
                }
                if (result.gifanim_ipfs) {
                    resultEl.textContent += `üé¨ Animated GIF: ${result.gifanim_ipfs}\n`;
                }
                if (result.info) {
                    resultEl.textContent += `üìã Info.json: ${result.info}\n`;
                }
                
                // Show links
                const gateway = '{{ myIPFS }}';
                const ipfsUrl = `${gateway}/ipfs/${result.new_cid || result.cid}/${result.fileName || file.name}`;
                const infoUrl = result.info ? `${gateway}/ipfs/${result.info}` : '#';
                
                document.getElementById('ipfsLink').href = ipfsUrl;
                document.getElementById('ipfsLink').textContent = ipfsUrl;
                document.getElementById('infoLink').href = infoUrl;
                document.getElementById('infoLink').textContent = infoUrl;
                document.getElementById('nostrEventId').textContent = result.event_id || 'Not yet published';
                
                linksEl.style.display = 'block';
                
                // If video, prompt for title/description and publish to NOSTR via /webcam
                if (result.file_type === 'video' || file.type.startsWith('video/')) {
                    console.log('[UPLOAD] Video detected, prompting for metadata...');
                    resultEl.textContent += '\nüìπ Video detected! Publishing to NOSTR...\n';
                    
                    // Show modal or prompt for title and description
                    await publishVideoToNostr(result, file);
                } else {
                    // Non-video files are already published from backend
                    resultEl.textContent += '\n‚úÖ File published to NOSTR!\n';
                    // Reload uploads after a delay
                    setTimeout(() => loadRecentUploads(), 2000);
                }
                
            } catch (error) {
                resultEl.textContent = `‚ùå Upload failed\n\n${error.message}`;
                console.error('Upload error:', error);
            }
        }
        
        // Publish video to NOSTR via /webcam endpoint
        async function publishVideoToNostr(uploadResult, originalFile) {
            const resultEl = document.getElementById('uploadResult');
            
            try {
                // Prompt user for title and description
                const defaultTitle = uploadResult.fileName || originalFile.name;
                const title = prompt('üìù Video Title:', defaultTitle) || defaultTitle;
                const description = prompt('üìù Video Description (optional):') || '';
                
                if (!title) {
                    resultEl.textContent += '‚ö†Ô∏è Video published to IPFS but NOT to NOSTR (no title provided)\n';
                    setTimeout(() => loadRecentUploads(), 2000);
                    return;
                }
                
                resultEl.textContent += `\nüì§ Publishing to NOSTR with title: "${title}"\n`;
                
                // Prepare form data for /webcam endpoint
                const formData = new FormData();
                formData.append('player', AstroportDemo.userNpub || AstroportDemo.userPubkey);
                formData.append('ipfs_cid', uploadResult.new_cid || uploadResult.cid);
                formData.append('title', title);
                formData.append('description', description);
                formData.append('npub', AstroportDemo.userNpub || AstroportDemo.userPubkey);
                formData.append('publish_nostr', 'true');
                
                // Add optional metadata if available
                if (uploadResult.thumbnail_ipfs) {
                    formData.append('thumbnail_ipfs', uploadResult.thumbnail_ipfs);
                }
                if (uploadResult.gifanim_ipfs) {
                    formData.append('gifanim_ipfs', uploadResult.gifanim_ipfs);
                }
                if (uploadResult.info) {
                    formData.append('info_cid', uploadResult.info);
                }
                
                // Get file hash and metadata from info.json (REQUIRED per UPlanet_FILE_CONTRACT.md)
                let fileHash = '';
                let uploadChain = '';
                let duration = '';
                let videoDimensions = '';
                let mimeType = '';
                
                if (uploadResult.info) {
                    try {
                        const gateway = '{{ myIPFS }}';
                        const infoResponse = await fetch(`${gateway}/ipfs/${uploadResult.info}`);
                        if (infoResponse.ok) {
                            const infoData = await infoResponse.json();
                            
                            // REQUIRED: file_hash
                            if (infoData.file && infoData.file.hash) {
                                fileHash = infoData.file.hash;
                                formData.append('file_hash', fileHash);
                            }
                            
                            // OPTIONAL: provenance and metadata
                            if (infoData.provenance && infoData.provenance.upload_chain) {
                                uploadChain = infoData.provenance.upload_chain;
                                formData.append('upload_chain', uploadChain);
                            }
                            if (infoData.media && infoData.media.duration) {
                                duration = infoData.media.duration;
                                formData.append('duration', duration);
                            }
                            if (infoData.media && infoData.media.dimensions) {
                                videoDimensions = infoData.media.dimensions;
                                formData.append('video_dimensions', videoDimensions);
                            }
                            if (infoData.file && infoData.file.type) {
                                mimeType = infoData.file.type;
                                formData.append('mime_type', mimeType);
                            }
                        }
                    } catch (e) {
                        console.warn('[VIDEO] Could not load info.json:', e);
                    }
                }
                
                // Validate REQUIRED parameters per UPlanet_FILE_CONTRACT.md
                if (!uploadResult.info) {
                    throw new Error('Missing required parameter: info_cid');
                }
                if (!fileHash) {
                    throw new Error('Missing required parameter: file_hash (could not read from info.json)');
                }
                if (!title) {
                    throw new Error('Missing required parameter: title');
                }
                
                resultEl.textContent += `‚úÖ All required parameters validated\n`;
                
                // Call /webcam endpoint
                const webcamResponse = await fetch('/webcam', {
                    method: 'POST',
                    body: formData
                });
                
                if (!webcamResponse.ok) {
                    throw new Error(`Failed to publish to NOSTR: ${webcamResponse.statusText}`);
                }
                
                // Parse HTML response or check for success
                const responseText = await webcamResponse.text();
                
                if (responseText.includes('success') || responseText.includes('Event ID')) {
                    resultEl.textContent += '‚úÖ Video published to NOSTR successfully!\n';
                    
                    // Try to extract event ID from response
                    const eventIdMatch = responseText.match(/Event ID:\s*([a-f0-9]{64})/i);
                    if (eventIdMatch) {
                        const eventId = eventIdMatch[1];
                        resultEl.textContent += `üìù Event ID: ${eventId.substring(0, 16)}...\n`;
                        document.getElementById('nostrEventId').textContent = eventId;
                    }
                    
                    // Reload uploads to show the new video event
                    setTimeout(() => loadRecentUploads(), 2000);
                } else {
                    throw new Error('Unexpected response from /webcam endpoint');
                }
                
            } catch (error) {
                console.error('[VIDEO] Failed to publish to NOSTR:', error);
                resultEl.textContent += `\n‚ö†Ô∏è Video uploaded to IPFS but NOSTR publication failed: ${error.message}\n`;
                resultEl.textContent += 'üí° You can manually publish it later.\n';
                
                // Still reload uploads to show the IPFS upload
                setTimeout(() => loadRecentUploads(), 2000);
            }
        }
        
        
        async function testComment() {
            const resultEl = document.getElementById('socialResult');
            
            if (!AstroportDemo.userPubkey) {
                showCommentModal(false); // Show modal with auth required message
                return;
            }
            
            // Show comment modal
            showCommentModal(true);
        }
        
        // Show/hide comment modal
        function showCommentModal(isAuthenticated) {
            const modal = document.getElementById('commentModal');
            const authWarning = document.getElementById('commentAuthWarning');
            const commentForm = document.getElementById('commentForm');
            
            if (isAuthenticated) {
                authWarning.style.display = 'none';
                commentForm.style.display = 'block';
                document.getElementById('commentInput').value = ''; // Clear input
                document.getElementById('commentInput').focus(); // Focus on input
            } else {
                authWarning.style.display = 'block';
                commentForm.style.display = 'none';
            }
            
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent background scroll
        }
        
        function closeCommentModal() {
            const modal = document.getElementById('commentModal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scroll
        }
        
        async function submitComment() {
            const commentInput = document.getElementById('commentInput');
            const submitBtn = document.getElementById('submitCommentBtn');
            const comment = commentInput.value.trim();
            
            if (!comment) {
                commentInput.classList.add('is-invalid');
                return;
            }
            
            commentInput.classList.remove('is-invalid');
            
            try {
                // Disable button and show loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-arrow-clockwise spinner-border spinner-border-sm"></i> Publishing...';
                
                console.log('[COMMENT] Publishing comment:', comment);
                
                // Publish comment using NIP-22 (kind 1111) for comments on URLs
                if (typeof publishNote === 'function') {
                    await publishNote(comment, [['r', window.location.href]], 1111);
                    console.log('[COMMENT] ‚úÖ Comment published (kind 1111)');
                    
                    // Success feedback
                    submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Published!';
                    submitBtn.classList.remove('btn-primary');
                    submitBtn.classList.add('btn-success');
                    
                    // Close modal after 1 second
                    setTimeout(() => {
                        closeCommentModal();
                        // Reset button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-send"></i> Publish Comment';
                        submitBtn.classList.remove('btn-success');
                        submitBtn.classList.add('btn-primary');
                        
                        // Reload interactions
                        loadPageInteractions();
                    }, 1000);
                } else {
                    throw new Error('publishNote function not available');
                }
                
            } catch (error) {
                console.error('[COMMENT] ‚ùå Error:', error);
                
                // Error feedback
                submitBtn.innerHTML = '<i class="bi bi-x-circle"></i> Error';
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-danger');
                
                alert('Failed to publish comment: ' + error.message);
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-send"></i> Publish Comment';
                    submitBtn.classList.remove('btn-danger');
                    submitBtn.classList.add('btn-primary');
                }, 2000);
            }
        }
        
        async function testShare() {
            const resultEl = document.getElementById('socialResult');
            
            if (!AstroportDemo.userPubkey) {
                resultEl.textContent = '‚ùå Please connect with MULTIPASS first';
                return;
            }
            
            try {
                console.log('[SHARE] Sharing page...');
                resultEl.textContent = 'üîÑ Sharing to your feed...\n\n';
                
                const shareMessage = 'Check out this Astroport.ONE developer platform! ' + window.location.href;
                
                // Share using common.js - post as note with URL reference
                if (typeof publishNote === 'function') {
                    await publishNote(shareMessage, [['r', window.location.href]]);
                    console.log('[SHARE] ‚úÖ Shared successfully');
                    resultEl.textContent += '‚úÖ Shared to your NOSTR feed!\n\n';
                    resultEl.textContent += 'Your followers can now see this content.';
                    
                    // Reload interactions after a delay
                    setTimeout(() => loadPageInteractions(), 1000);
                } else {
                    console.error('[SHARE] ‚ùå publishNote not available');
                    resultEl.textContent += '‚ùå publishNote function not available';
                }
                
            } catch (error) {
                console.error('[SHARE] ‚ùå Error:', error);
                resultEl.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        // UMAP Chat Configuration
        const UMAPChat = {
            currentUMAP: { lat: 0.00, lon: 0.00 },
            channelId: '',       // Event ID of kind 30312 (if exists) or fallback string
            umapDID: null,       // Full ORE Meeting Space event (kind 30312)
            umapHex: null,       // UMAP's hex pubkey from geolinks API
            subscription: null,
            activeUsers: new Set(),  // Track unique pubkeys
            initialized: false  // Track if already initialized
        };
        
        // Initialize UMAP chat
        async function initUMAPChat() {
            // Prevent double initialization
            if (UMAPChat.initialized) {
                console.log('[CHAT] ‚è≠Ô∏è UMAP chat already initialized, skipping');
                return;
            }
            
            console.log('[CHAT] Initializing UMAP chat system...');
            
            // Try to get UMAP from user's GPS coordinates (requires NIP-42 auth)
            if (AstroportDemo.userPubkey) {
                try {
                    console.log('[CHAT] Fetching user GPS coordinates from /api/myGPS...');
                    
                    const gpsResponse = await fetch(`/api/myGPS?npub=${AstroportDemo.userPubkey}`);
                    
                    if (gpsResponse.ok) {
                        const gpsData = await gpsResponse.json();
                        
                        if (gpsData.success && gpsData.coordinates) {
                            console.log('[CHAT] ‚úÖ GPS coordinates retrieved:', gpsData.coordinates);
                            console.log('[CHAT] UMAP key:', gpsData.umap_key);
                            
                            // Update UMAP to user's location
                            UMAPChat.currentUMAP = {
                                lat: gpsData.coordinates.lat,
                                lon: gpsData.coordinates.lon
                            };
                            
                            // Fetch UMAP DID for user's location
                            await fetchUMAPDIDForChat(UMAPChat.currentUMAP.lat, UMAPChat.currentUMAP.lon);
                            updateUMAPChatUI();
                            
                            console.log('[CHAT] Initialized with user location:', gpsData.umap_key);
                            return;
                        } else {
                            console.warn('[CHAT] GPS data received but invalid format:', gpsData);
                        }
                    } else if (gpsResponse.status === 403) {
                        console.log('[CHAT] GPS access denied (authentication required)');
                    } else if (gpsResponse.status === 404) {
                        console.log('[CHAT] GPS coordinates not found for this user');
                    } else {
                        console.warn('[CHAT] GPS fetch failed with status:', gpsResponse.status);
                    }
                } catch (error) {
                    console.warn('[CHAT] Error fetching GPS coordinates:', error);
                }
            }
            
            // Fallback: Use default UMAP (0.00, 0.00)
            console.log('[CHAT] Using default UMAP (0.00, 0.00)');
            UMAPChat.currentUMAP = { lat: 0.00, lon: 0.00 };
            
            // Fetch the UMAP DID for this geographic cell
            await fetchUMAPDIDForChat(UMAPChat.currentUMAP.lat, UMAPChat.currentUMAP.lon);
            
            // Update UI
            updateUMAPChatUI();
            
            // Mark as initialized
            UMAPChat.initialized = true;
            console.log('[CHAT] ‚úÖ UMAP chat initialization complete');
        }
        
        // Fetch UMAP ORE Meeting Space (kind 30312) for a specific geographic coordinate
        async function fetchUMAPDIDForChat(lat, lon) {
            console.log(`[CHAT] Fetching UMAP ORE Space for coordinates: ${lat.toFixed(2)}, ${lon.toFixed(2)}`);
            
            try {
                // Step 1: Get UMAP HEX from /api/umap/geolinks
                console.log('[CHAT] Step 1: Fetching UMAP hex from geolinks API...');
                const geolinksResponse = await fetch(`/api/umap/geolinks?lat=${lat}&lon=${lon}`);
                
                if (!geolinksResponse.ok) {
                    console.warn('[CHAT] Failed to fetch geolinks:', geolinksResponse.status);
                    UMAPChat.channelId = `UMAP_${lat.toFixed(2)}_${lon.toFixed(2)}`;
                    return;
                }
                
                const geolinksData = await geolinksResponse.json();
                const umapHex = geolinksData.umaps?.here;
                
                if (!umapHex) {
                    console.warn('[CHAT] No UMAP hex found in geolinks response');
                    UMAPChat.channelId = `UMAP_${lat.toFixed(2)}_${lon.toFixed(2)}`;
                    return;
                }
                
                console.log('[CHAT] ‚úÖ Found UMAP hex:', umapHex);
                
                // Store UMAP hex as the primary reference
                UMAPChat.umapHex = umapHex;
                
                // Step 2: Search for ORE Meeting Space (kind 30312) by author (UMAP's pubkey)
                console.log('[CHAT] Step 2: Searching for ORE Meeting Space (kind 30312) by author...');
                
                // Ensure relay connection
                let currentRelay = window.nostrRelay;
                if (!currentRelay) {
                    console.log('[CHAT] Connecting to relay...');
                    await connectToRelay();
                    currentRelay = window.nostrRelay;
                }
                
                if (!currentRelay) {
                    console.warn('[CHAT] ‚ö†Ô∏è No relay available');
                    // Use UMAP hex as channelId (it's the deterministic UMAP DID pubkey)
                    UMAPChat.channelId = umapHex;
                    console.log('[CHAT] Using UMAP hex as channel reference:', umapHex.substring(0, 8) + '...');
                    return;
                }
                
                const oreSpaces = await new Promise((resolve) => {
                    const filter = {
                        kinds: [30312],         // ORE Meeting Space
                        authors: [umapHex],     // Filter by UMAP's pubkey
                        limit: 1
                    };
                    
                    const results = [];
                    const sub = currentRelay.sub([filter]);
                    const timeout = setTimeout(() => {
                        sub.unsub();
                        resolve(results);
                    }, 5000);
                    
                    sub.on('event', (event) => {
                        console.log('[CHAT] üìç Found ORE Meeting Space event:', event.id.substring(0, 8) + '...');
                        results.push(event);
                    });
                    
                    sub.on('eose', () => {
                        clearTimeout(timeout);
                        sub.unsub();
                        resolve(results);
                    });
                });
                
                if (oreSpaces.length > 0) {
                    const oreSpace = oreSpaces[0];
                    UMAPChat.umapDID = oreSpace;
                    
                    // Use the event ID as channel ID (ORE Meeting Space reference)
                    UMAPChat.channelId = oreSpace.id;
                    
                    console.log('[CHAT] ‚úÖ Found ORE Meeting Space for UMAP');
                    console.log('[CHAT] Using ORE Space event ID as channel:', oreSpace.id.substring(0, 8) + '...');
                } else {
                    console.log('[CHAT] ‚ö†Ô∏è No ORE Meeting Space found for UMAP hex:', umapHex);
                    // Use UMAP hex as channelId (it's the deterministic UMAP DID pubkey)
                    UMAPChat.channelId = umapHex;
                    console.log('[CHAT] Using UMAP hex as channel reference:', umapHex.substring(0, 8) + '...');
                }
                
            } catch (error) {
                console.error('[CHAT] Error fetching UMAP ORE Space:', error);
                // If we have umapHex, use it; otherwise fallback to string
                if (UMAPChat.umapHex) {
                    UMAPChat.channelId = UMAPChat.umapHex;
                } else {
                    UMAPChat.channelId = `UMAP_${lat.toFixed(2)}_${lon.toFixed(2)}`;
                }
            }
        }
        
        // Update UMAP chat UI
        function updateUMAPChatUI() {
            const currentUMAPEl = document.getElementById('currentUMAP');
            const channelIdEl = document.getElementById('channelId');
            const usersCountEl = document.getElementById('channelUsersCount');
            
            if (currentUMAPEl) {
                currentUMAPEl.textContent = `${UMAPChat.currentUMAP.lat.toFixed(2)}, ${UMAPChat.currentUMAP.lon.toFixed(2)}`;
            }
            
            if (channelIdEl) {
                const ipfsGateway = window.ipfsGateway || 'http://127.0.0.1:8080';
                
                if (UMAPChat.umapDID) {
                    // Show ORE Meeting Space channel with event ID
                    const shortEventId = UMAPChat.channelId.substring(0, 8) + '...';
                    const profileUrl = `${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${UMAPChat.umapHex}`;
                    
                    channelIdEl.innerHTML = `
                        ORE Space: ${shortEventId} | 
                        <a href="${profileUrl}" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           title="View UMAP profile: ${UMAPChat.umapHex}"
                           style="color: var(--bs-success); text-decoration: none; font-weight: 600;">
                            <i class="bi bi-globe"></i> UMAP Profile
                        </a>
                    `;
                } else if (UMAPChat.umapHex) {
                    // Show UMAP hex (no ORE space yet)
                    const shortHex = UMAPChat.umapHex.substring(0, 8) + '...';
                    const profileUrl = `${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${UMAPChat.umapHex}`;
                    
                    channelIdEl.innerHTML = `
                        UMAP: ${shortHex} (no ORE) | 
                        <a href="${profileUrl}" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           title="View UMAP profile: ${UMAPChat.umapHex}"
                           style="color: var(--bs-info); text-decoration: none; font-weight: 600;">
                            <i class="bi bi-globe"></i> UMAP Profile
                        </a>
                    `;
                } else {
                    // Show fallback generic ID
                    channelIdEl.textContent = UMAPChat.channelId + ' (fallback)';
                }
            }
            
            // Update users count
            if (usersCountEl) {
                const userCount = UMAPChat.activeUsers.size;
                usersCountEl.textContent = userCount;
                usersCountEl.title = `${userCount} unique user${userCount !== 1 ? 's' : ''} in this UMAP`;
                console.log('[CHAT] üë• Active users count:', userCount);
            }
            
            console.log('[CHAT] Initialized UMAP chat:', UMAPChat);
        }
        
        async function loadChatMessages() {
            const messagesEl = document.getElementById('chatMessages');
            
            // Initialize UMAP if not done yet
            if (!UMAPChat.initialized) {
                await initUMAPChat();
            }
            
            // Reset active users count for new channel
            UMAPChat.activeUsers.clear();
            updateUMAPChatUI();
            
            try {
                console.log('[CHAT] Loading UMAP chat messages...');
                console.log('[CHAT] Channel ID:', UMAPChat.channelId);
                console.log('[CHAT] nostrRelay available:', typeof window.nostrRelay !== 'undefined');
                console.log('[CHAT] isNostrConnected:', window.isNostrConnected);
                
                // Wait for relay connection if needed
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[CHAT] Waiting for relay connection...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                        console.log('[CHAT] Relay connected');
                    }
                }
                
                // Unsubscribe from previous subscription
                if (UMAPChat.subscription) {
                    console.log('[CHAT] Closing previous subscription');
                    UMAPChat.subscription.unsub();
                }
                
                // Subscribe to NIP-28 channel messages (kind 42)
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    console.log('[CHAT] Subscribing to NIP-28 channel messages (kind 42)...');
                    console.log('[CHAT] Channel filter:', UMAPChat.channelId);
                    
                    // Build subscription filter based on available channel info
                    const umapKey = `${UMAPChat.currentUMAP.lat.toFixed(2)},${UMAPChat.currentUMAP.lon.toFixed(2)}`;
                    const filter = {
                        kinds: [42],  // NIP-28: Public channel message
                        "#g": [umapKey],  // Filter by geolocation (always present)
                        limit: 50
                    };
                    
                    // Determine what type of channel reference we have
                    const channelIdIsEventId = UMAPChat.channelId && UMAPChat.channelId.length === 64 && 
                                               UMAPChat.umapDID !== null;
                    
                    if (channelIdIsEventId) {
                        // We have an ORE Meeting Space - filter by 'e' tag
                        filter["#e"] = [UMAPChat.channelId];
                        console.log('[CHAT] Filtering by ORE Space event ID:', UMAPChat.channelId.substring(0, 8) + '...');
                    } else if (UMAPChat.umapHex && UMAPChat.umapHex.length === 64) {
                        // No ORE space, but we have UMAP hex - filter by 'p' tag (pubkey)
                        filter["#p"] = [UMAPChat.umapHex];
                        console.log('[CHAT] Filtering by UMAP hex (pubkey):', UMAPChat.umapHex.substring(0, 8) + '...');
                    } else {
                        console.log('[CHAT] Filtering by geolocation only (no UMAP reference)');
                    }
                    
                    console.log('[CHAT] Subscription filter:', filter);
                    const sub = window.nostrRelay.sub([filter]);
                    
                    sub.on('event', event => {
                        console.log('[CHAT] üì® New channel message received:', event);
                        
                        // Track unique user
                        if (event.pubkey) {
                            UMAPChat.activeUsers.add(event.pubkey);
                            updateUMAPChatUI();  // Update count in real-time
                        }
                        
                        displayChatMessage(event);
                    });
                    
                    sub.on('eose', () => {
                        console.log('[CHAT] ‚úÖ End of stored events');
                        console.log('[CHAT] üë• Total unique users found:', UMAPChat.activeUsers.size);
                        
                        if (messagesEl.innerHTML.includes('Loading messages')) {
                            messagesEl.innerHTML = `<div class="text-center text-muted">
                                <i class="bi bi-chat"></i> No messages yet in this UMAP.
                                <br>Be the first to send one!
                            </div>`;
                        }
                        
                        // Final update of user count
                        updateUMAPChatUI();
                    });
                    
                    UMAPChat.subscription = sub;
                    AstroportDemo.chatSubscription = sub;
                    console.log('[CHAT] Subscription created for channel:', UMAPChat.channelId);
                } else {
                    console.warn('[CHAT] ‚ö†Ô∏è Relay not available');
                    messagesEl.innerHTML = '<div class="text-center text-muted">Connect to NOSTR to view messages</div>';
                }
            } catch (error) {
                console.error('[CHAT] ‚ùå Error loading chat:', error);
                messagesEl.innerHTML = '<div class="text-center text-muted">Error loading chat</div>';
            }
        }
        
        function displayChatMessage(event) {
            const messagesEl = document.getElementById('chatMessages');
            
            // Clear loading message
            if (messagesEl.innerHTML.includes('Loading messages')) {
                messagesEl.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            const authorShort = event.pubkey ? event.pubkey.substring(0, 8) + '...' : 'Unknown';
            const time = new Date(event.created_at * 1000).toLocaleTimeString();
            
            // Get IPFS gateway from window config (set in common.js)
            const ipfsGateway = window.ipfsGateway || 'http://127.0.0.1:8080';
            
            // Create profile viewer URL
            const profileViewerUrl = event.pubkey ? 
                `${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${event.pubkey}` : 
                '#';
            
            messageDiv.innerHTML = `
                <div class="author">
                    <a href="${profileViewerUrl}" 
                       target="_blank" 
                       rel="noopener noreferrer" 
                       title="View profile for ${event.pubkey || 'Unknown'}"
                       style="color: var(--bs-info); text-decoration: none; transition: all 0.2s;">
                        <i class="bi bi-person-circle"></i> ${authorShort}
                    </a>
                </div>
                <div class="content">${escapeHtml(event.content)}</div>
                <div class="time">${time}</div>
            `;
            
            messagesEl.insertBefore(messageDiv, messagesEl.firstChild);
            
            // Keep only last 10 messages
            while (messagesEl.children.length > 10) {
                messagesEl.removeChild(messagesEl.lastChild);
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            if (!AstroportDemo.userPubkey) {
                alert('Please connect with MULTIPASS first');
                return;
            }
            
            // Ensure UMAP is initialized
            if (!UMAPChat.initialized) {
                await initUMAPChat();
            }
            
            try {
                console.log('[CHAT] Sending message to channel:', UMAPChat.channelId);
                console.log('[CHAT] Message content:', content);
                
                // Publish NIP-28 channel message (kind 42)
                if (typeof publishNote === 'function') {
                    // Build tags based on whether we have a valid channel ID (event ID from ORE space)
                    const tags = [
                        ["g", `${UMAPChat.currentUMAP.lat.toFixed(2)},${UMAPChat.currentUMAP.lon.toFixed(2)}`]  // Geolocation (required)
                    ];
                    
                    // Determine if channelId is an event ID (64 hex chars) or UMAP hex
                    const channelIdIsEventId = UMAPChat.channelId && UMAPChat.channelId.length === 64 && 
                                               UMAPChat.umapDID !== null;
                    
                    if (channelIdIsEventId) {
                        // We have an ORE Meeting Space - reference it with 'e' tag
                        tags.unshift(["e", UMAPChat.channelId, "", "root"]);  // Channel reference
                        console.log('[CHAT] Using ORE Space event ID:', UMAPChat.channelId.substring(0, 8) + '...');
                    } else if (UMAPChat.umapHex && UMAPChat.umapHex.length === 64) {
                        // No ORE space yet, but we have the UMAP hex - use it as 'p' tag (pubkey reference)
                        tags.push(["p", UMAPChat.umapHex]);  // UMAP DID pubkey
                        console.log('[CHAT] Using UMAP hex as pubkey reference:', UMAPChat.umapHex.substring(0, 8) + '...');
                    } else {
                        console.log('[CHAT] No valid UMAP reference, using geolocation-only tags');
                    }
                    
                    // Use publishNote from common.js (will need to support kind parameter)
                    // For now, we'll use nostr.signEvent directly
                    if (typeof window.nostr !== 'undefined') {
                        const event = {
                            kind: 42,  // NIP-28: Channel message
                            created_at: Math.floor(Date.now() / 1000),
                            tags: tags,
                            content: content
                        };
                        
                        const signedEvent = await window.nostr.signEvent(event);
                        console.log('[CHAT] Event signed:', signedEvent);
                        
                        // Publish to relay
                        if (window.nostrRelay) {
                            await window.nostrRelay.publish(signedEvent);
                            console.log('[CHAT] ‚úÖ Message sent successfully to UMAP channel');
                            
                            // Add current user to active users
                            if (AstroportDemo.userPubkey) {
                                UMAPChat.activeUsers.add(AstroportDemo.userPubkey);
                                updateUMAPChatUI();
                            }
                            
                            input.value = '';
                        } else {
                            throw new Error('Relay not connected');
                        }
                    } else {
                        throw new Error('NOSTR extension not available');
                    }
                } else {
                    console.error('[CHAT] ‚ùå publishNote function not available');
                    alert('Chat function not loaded yet');
                }
            } catch (error) {
                console.error('[CHAT] ‚ùå Error sending message:', error);
                alert('Error sending message: ' + error.message);
            }
        }
        
        // Show UMAP selector dialog with list of existing UMAP DIDs
        async function showUMAPSelector() {
            console.log('[CHAT] Opening UMAP selector...');
            
            try {
                // Fetch existing UMAP DIDs (kind 30800 with type: UMAPGeographicCell)
                if (!window.nostrRelay) {
                    await connectToRelay();
                }
                
                console.log('[CHAT] Fetching existing UMAP DIDs from relay...');
                
                // Create a modal/dialog for UMAP selection
                const modal = createUMAPSelectorModal();
                document.body.appendChild(modal);
                
                // Show loading state
                const listEl = modal.querySelector('#umapList');
                const myLocationEl = modal.querySelector('#myLocationSection');
                listEl.innerHTML = '<div class="text-center p-3"><i class="bi bi-arrow-clockwise spinner-border spinner-border-sm"></i> Loading UMAPs...</div>';
                
                // Step 1: Try to get user's GPS location
                let userGPS = null;
                if (AstroportDemo.userPubkey) {
                    try {
                        console.log('[CHAT] Fetching user GPS from /api/myGPS...');
                        const gpsResponse = await fetch(`/api/myGPS?npub=${AstroportDemo.userPubkey}`);
                        if (gpsResponse.ok) {
                            const gpsData = await gpsResponse.json();
                            if (gpsData.success && gpsData.coordinates) {
                                userGPS = {
                                    lat: gpsData.coordinates.lat,
                                    lon: gpsData.coordinates.lon,
                                    umap_key: gpsData.umap_key
                                };
                                console.log('[CHAT] ‚úÖ User GPS found:', userGPS.umap_key);
                                
                                // Display user's location section
                                myLocationEl.innerHTML = `
                                    <div class="alert alert-info mb-3">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-geo-alt-fill text-primary me-2" style="font-size: 1.5rem;"></i>
                                            <div class="flex-grow-1">
                                                <strong>üìç My Location (from GPS)</strong>
                                                <br>
                                                <small class="text-muted">
                                                    <i class="bi bi-pin-map"></i> ${userGPS.umap_key}
                                                </small>
                                            </div>
                                            <button class="btn btn-primary btn-sm" onclick="selectUMAP(${userGPS.lat}, ${userGPS.lon}, '${userGPS.umap_key}')">
                                                <i class="bi bi-chat-dots"></i> Join
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } catch (e) {
                        console.warn('[CHAT] Could not fetch user GPS:', e);
                    }
                }
                
                // If no GPS found, hide the section
                if (!userGPS) {
                    myLocationEl.style.display = 'none';
                }
                
                // Step 2: Fetch UMAP DIDs (kind 30312)
                const umapDIDs = [];
                
                // Search for ORE Meeting Space events (kind 30312) which contain UMAP info
                // These are created by ore_system.py when activating ORE mode
                const sub = window.nostrRelay.sub([{
                    kinds: [30312],  // ORE Meeting Space (Persistent Geographic Space)
                    limit: 100       // Get up to 100 to find UMAPs
                }]);
                
                sub.on('event', event => {
                    try {
                        // Extract geolocation from tags
                        const gTag = event.tags.find(t => t[0] === 'g');
                        if (!gTag || !gTag[1]) return;
                        
                        const coords = gTag[1].split(',');
                        if (coords.length !== 2) return;
                        
                        const lat = parseFloat(coords[0]);
                        const lon = parseFloat(coords[1]);
                        
                        if (isNaN(lat) || isNaN(lon)) return;
                        
                        // Extract additional metadata from tags
                        const roomTag = event.tags.find(t => t[0] === 'room');
                        const vdoUrlTag = event.tags.find(t => t[0] === 'vdo_url');
                        const didTag = event.tags.find(t => t[0] === 'did');
                        const plantsTag = event.tags.find(t => t[0] === 'plants');
                        const speciesTag = event.tags.find(t => t[0] === 'species');
                        
                        const geoKey = `${lat.toFixed(2)},${lon.toFixed(2)}`;
                        const roomName = roomTag ? roomTag[1] : `UMAP ${geoKey}`;
                        const plantsCount = plantsTag ? parseInt(plantsTag[1]) || 0 : 0;
                        const speciesCount = speciesTag ? parseInt(speciesTag[1]) || 0 : 0;
                        
                        // Check if this is the user's current location
                        const isMyLocation = userGPS && 
                            Math.abs(lat - userGPS.lat) < 0.01 && 
                            Math.abs(lon - userGPS.lon) < 0.01;
                        
                        umapDIDs.push({
                            eventId: event.id,
                            pubkey: event.pubkey,
                            lat: lat,
                            lon: lon,
                            geoKey: geoKey,
                            name: roomName,
                            description: `ORE Space - ${plantsCount} observations, ${speciesCount} species`,
                            createdAt: event.created_at,
                            vdoUrl: vdoUrlTag ? vdoUrlTag[1] : null,
                            did: didTag ? didTag[1] : null,
                            biodiversity: {
                                plants: plantsCount,
                                species: speciesCount
                            },
                            isMyLocation: isMyLocation
                        });
                        
                        console.log('[CHAT] Found ORE UMAP (kind 30312):', geoKey, 'Event ID:', event.id.substring(0, 8) + '...', `Biodiversity: ${plantsCount} plants, ${speciesCount} species`);
                    } catch (e) {
                        console.warn('[CHAT] Error parsing ORE Meeting Space:', e);
                    }
                });
                
                sub.on('eose', () => {
                    console.log('[CHAT] Found', umapDIDs.length, 'UMAP DIDs');
                    sub.unsub();
                    
                    // Sort: user's location first, then by most recent
                    umapDIDs.sort((a, b) => {
                        if (a.isMyLocation && !b.isMyLocation) return -1;
                        if (!a.isMyLocation && b.isMyLocation) return 1;
                        return b.createdAt - a.createdAt;
                    });
                    
                    // Limit to 10 most recent (after prioritizing user's location)
                    const displayUMAPs = umapDIDs.slice(0, 10);
                    
                    // Display UMAPs
                    if (displayUMAPs.length === 0) {
                        listEl.innerHTML = `
                            <div class="text-center p-3 text-muted">
                                <i class="bi bi-inbox"></i>
                                <p class="mb-0">No ORE UMAP spaces found on this relay</p>
                                <small>You can enter coordinates manually below</small>
                            </div>
                        `;
                    } else {
                        listEl.innerHTML = displayUMAPs.map(umap => `
                            <div class="umap-item ${umap.isMyLocation ? 'umap-item-highlight' : ''}" onclick="selectUMAP(${umap.lat}, ${umap.lon}, '${umap.geoKey}')">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-${umap.isMyLocation ? 'geo-alt-fill text-primary' : 'globe text-success'} me-2 mt-1" style="font-size: 1.2rem;"></i>
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>${umap.name}${umap.isMyLocation ? ' üìç' : ''}</strong>
                                                <br>
                                                <small class="text-muted">
                                                    <i class="bi bi-pin-map"></i> ${umap.geoKey}
                                                </small>
                                            </div>
                                            ${umap.vdoUrl ? `
                                                <a href="${umap.vdoUrl}" target="_blank" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();" title="Join VDO.ninja room">
                                                    <i class="bi bi-camera-video"></i>
                                                </a>
                                            ` : ''}
                                        </div>
                                        ${umap.biodiversity && (umap.biodiversity.plants > 0 || umap.biodiversity.species > 0) ? `
                                            <div class="mt-1">
                                                <small class="badge bg-success">
                                                    <i class="bi bi-flower1"></i> ${umap.biodiversity.species} species
                                                </small>
                                                <small class="badge bg-info ms-1">
                                                    <i class="bi bi-eye"></i> ${umap.biodiversity.plants} observations
                                                </small>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <i class="bi bi-chevron-right text-muted ms-2"></i>
                                </div>
                            </div>
                        `).join('');
                    }
                });
                
            } catch (error) {
                console.error('[CHAT] Error loading UMAP selector:', error);
                alert('Error loading UMAPs: ' + error.message);
            }
        }
        
        // Create UMAP selector modal
        function createUMAPSelectorModal() {
            const modal = document.createElement('div');
            modal.id = 'umapSelectorModal';
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-map"></i> Select UMAP Chat Room
                            </h5>
                            <button type="button" class="btn-close" onclick="closeUMAPSelector()"></button>
                        </div>
                        <div class="modal-body">
                            <!-- My Location Section (GPS) -->
                            <div id="myLocationSection">
                                <!-- Will be populated if GPS available -->
                            </div>
                            
                            <!-- Available ORE Meeting Spaces -->
                            <div class="mb-3">
                                <h6><i class="bi bi-globe"></i> Available ORE Spaces</h6>
                            </div>
                            <div id="umapList" class="umap-list">
                                <!-- UMAP items will be inserted here -->
                            </div>
                            
                            <hr>
                            
                            <div class="manual-input">
                                <h6><i class="bi bi-pencil"></i> Manual Entry</h6>
                                <p class="small text-muted">Enter coordinates manually (format: lat, lon)</p>
                                <div class="input-group">
                                    <input type="text" 
                                           id="manualCoords" 
                                           class="form-control" 
                                           placeholder="48.86, 2.35 or 0.00, 0.00 for global"
                                           value="${UMAPChat.currentUMAP.lat.toFixed(2)}, ${UMAPChat.currentUMAP.lon.toFixed(2)}">
                                    <button class="btn btn-primary" onclick="selectManualUMAP()">
                                        <i class="bi bi-check-lg"></i> Go
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add CSS for UMAP items
            if (!document.getElementById('umapSelectorStyles')) {
                const style = document.createElement('style');
                style.id = 'umapSelectorStyles';
                style.textContent = `
                    .umap-list {
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    .umap-item {
                        padding: 12px;
                        border: 1px solid #dee2e6;
                        border-radius: 6px;
                        margin-bottom: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                    }
                    .umap-item:hover {
                        background-color: #f8f9fa;
                        border-color: #0d6efd;
                        transform: translateX(4px);
                    }
                    .umap-item-highlight {
                        background-color: #e7f3ff;
                        border-color: #0d6efd;
                        border-width: 2px;
                    }
                    .umap-item-highlight:hover {
                        background-color: #d0e7ff;
                    }
                    .manual-input {
                        padding: 12px;
                        background-color: #f8f9fa;
                        border-radius: 6px;
                    }
                `;
                document.head.appendChild(style);
            }
            
            return modal;
        }
        
        // Select a UMAP from the list
        async function selectUMAP(lat, lon, geoKey) {
            console.log('[CHAT] Selected UMAP:', geoKey);
            
            // Close modal
            closeUMAPSelector();
            
            // Update UMAP
            UMAPChat.currentUMAP = { lat, lon };
            await fetchUMAPDIDForChat(lat, lon);
            
            console.log('[CHAT] Switching to UMAP:', geoKey);
            
            // Update UI
            document.getElementById('currentUMAP').textContent = geoKey;
            document.getElementById('channelId').textContent = UMAPChat.channelId;
            
            // Reload messages for new channel
            const messagesEl = document.getElementById('chatMessages');
            messagesEl.innerHTML = '<div class="text-center text-muted"><i class="bi bi-arrow-clockwise"></i> Loading messages...</div>';
            
            await loadChatMessages();
        }
        
        // Select manual coordinates
        async function selectManualUMAP() {
            const input = document.getElementById('manualCoords').value.trim();
            
            if (!input) {
                alert('Please enter coordinates');
                return;
            }
            
            const parts = input.split(',').map(p => p.trim());
            if (parts.length !== 2) {
                alert('Invalid format! Use: lat, lon (example: 48.86, 2.35)');
                return;
            }
            
            let newLat = parseFloat(parts[0]);
            let newLon = parseFloat(parts[1]);
            
            // Validate coordinates
            if (isNaN(newLat) || isNaN(newLon) || 
                newLat < -90 || newLat > 90 || 
                newLon < -180 || newLon > 180) {
                alert('Invalid coordinates!\nLatitude: -90 to 90\nLongitude: -180 to 180');
                return;
            }
            
            // Round to 2 decimals (UMAP precision)
            newLat = Math.round(newLat * 100) / 100;
            newLon = Math.round(newLon * 100) / 100;
            
            await selectUMAP(newLat, newLon, `${newLat.toFixed(2)},${newLon.toFixed(2)}`);
        }
        
        // Close UMAP selector modal
        function closeUMAPSelector() {
            const modal = document.getElementById('umapSelectorModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Load recent file uploads (NIP-94 and NIP-71)
        async function loadRecentUploads() {
            const uploadsEl = document.getElementById('recentUploads');
            
            try {
                console.log('[UPLOADS] Loading recent uploads...');
                
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[UPLOADS] Waiting for relay...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                    }
                }
                
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    console.log('[UPLOADS] Fetching NIP-94 (kind 1063) and NIP-71 (kinds 21, 22) events...');
                    
                    const sub = window.nostrRelay.sub([{
                        kinds: [1063, 21, 22], // NIP-94 (files with info.json), NIP-71 (videos: 21=short, 22=long)
                        limit: 50 // Get more events to have enough of each type
                    }]);
                    
                    const events = [];
                    
                    sub.on('event', event => {
                        console.log('[UPLOADS] üì¶ Received event (kind', event.kind + '):', event);
                        events.push(event);
                    });
                    
                    sub.on('eose', () => {
                        console.log('[UPLOADS] ‚úÖ Loaded', events.length, 'total events');
                        displayRecentUploads(events);
                        sub.unsub();
                    });
                } else {
                    console.warn('[UPLOADS] ‚ö†Ô∏è Relay not available');
                    uploadsEl.innerHTML = '<div class="col-12 text-center text-muted">Relay not connected</div>';
                }
            } catch (error) {
                console.error('[UPLOADS] ‚ùå Error loading uploads:', error);
                uploadsEl.innerHTML = '<div class="col-12 text-center text-muted">Error loading files</div>';
            }
        }
        
        function displayRecentUploads(events) {
            const uploadsEl = document.getElementById('recentUploads');
            
            if (events.length === 0) {
                uploadsEl.innerHTML = '<div class="col-12 text-center text-muted">No recent uploads found</div>';
                return;
            }
            
            // Separate events by type
            const fileEvents = []; // kind 1063 (NIP-94: all files with info.json metadata)
            const shortVideoEvents = []; // kind 21 (NIP-71: short videos)
            const longVideoEvents = []; // kind 22 (NIP-71: long videos)
            
            events.forEach(event => {
                if (event.kind === 1063) fileEvents.push(event);
                else if (event.kind === 21) shortVideoEvents.push(event);
                else if (event.kind === 22) longVideoEvents.push(event);
            });
            
            console.log('[UPLOADS] Categorized events:');
            console.log('  - Files/NIP-94 (1063):', fileEvents.length, '(images, audio, documents, videos)');
            console.log('  - Short videos/NIP-71 (21):', shortVideoEvents.length);
            console.log('  - Long videos/NIP-71 (22):', longVideoEvents.length);
            
            // Take only 3 most recent of each type
            const selectedEvents = [
                ...fileEvents.slice(0, 3),
                ...shortVideoEvents.slice(0, 3),
                ...longVideoEvents.slice(0, 3)
            ];
            
            console.log('[UPLOADS] Displaying', selectedEvents.length, 'events total (max 3 per type)');
            
            if (selectedEvents.length === 0) {
                uploadsEl.innerHTML = '<div class="col-12 text-center text-muted">No recent uploads found</div>';
                return;
            }
            
            uploadsEl.innerHTML = '';
            
            // Get IPFS gateway from global or use default
            const ipfsGateway = '{{ myIPFS }}';
            
            selectedEvents.forEach(event => {
                // Extract file info from tags
                let fileUrl = '';
                let fileName = 'Unknown';
                let fileType = '';
                let typeLabel = '';
                let gifanimUrl = '';
                let thumbnailUrl = '';
                
                if (event.tags) {
                    const urlTag = event.tags.find(t => t[0] === 'url');
                    const nameTag = event.tags.find(t => t[0] === 'name' || t[0] === 'title');
                    const typeTag = event.tags.find(t => t[0] === 'm' || t[0] === 'type');
                    const gifanimTag = event.tags.find(t => t[0] === 'gifanim' || t[0] === 'gif');
                    const thumbnailTag = event.tags.find(t => t[0] === 'thumbnail' || t[0] === 'thumb');
                    
                    if (urlTag && urlTag[1]) {
                        fileUrl = urlTag[1];
                        // Add IPFS gateway if URL starts with /ipfs/
                        if (fileUrl.startsWith('/ipfs/')) {
                            fileUrl = ipfsGateway + fileUrl;
                        }
                    }
                    if (nameTag && nameTag[1]) fileName = nameTag[1];
                    if (typeTag && typeTag[1]) fileType = typeTag[1];
                    if (gifanimTag && gifanimTag[1]) {
                        gifanimUrl = gifanimTag[1];
                        if (gifanimUrl.startsWith('/ipfs/')) {
                            gifanimUrl = ipfsGateway + gifanimUrl;
                        }
                    }
                    if (thumbnailTag && thumbnailTag[1]) {
                        thumbnailUrl = thumbnailTag[1];
                        if (thumbnailUrl.startsWith('/ipfs/')) {
                            thumbnailUrl = ipfsGateway + thumbnailUrl;
                        }
                    }
                }
                
                // Determine icon and type label based on kind and file type
                let icon = 'bi-file-earmark';
                let clickAction = '';
                let previewHtml = '';
                
                if (event.kind === 21 || event.kind === 22) {
                    // Video events (NIP-71) ‚Üí Open in theater mode
                    icon = event.kind === 21 ? 'bi-camera-video-fill' : 'bi-film';
                    typeLabel = event.kind === 21 ? 'Short Video' : 'Long Video';
                    clickAction = `window.open('/theater?video=${event.id}', '_blank')`;
                    
                    // Use gifanim if available, otherwise thumbnail, otherwise icon
                    if (gifanimUrl) {
                        previewHtml = `<img src="${gifanimUrl}" alt="Preview" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                    } else if (thumbnailUrl) {
                        previewHtml = `<img src="${thumbnailUrl}" alt="Thumbnail" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                    } else {
                        previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                    }
                } else if (event.kind === 1063) {
                    // NIP-94 with info.json metadata (SHA256 hash tracking)
                    if (fileType.startsWith('image/')) {
                        icon = 'bi-image';
                        typeLabel = 'Image';
                        previewHtml = `<img src="${fileUrl}" alt="Image" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                    } else if (fileType.startsWith('video/')) {
                        icon = 'bi-camera-video';
                        typeLabel = 'Video';
                        clickAction = `window.open('/theater?video=${event.id}', '_blank')`;
                        if (gifanimUrl) {
                            previewHtml = `<img src="${gifanimUrl}" alt="Preview" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                        } else if (thumbnailUrl) {
                            previewHtml = `<img src="${thumbnailUrl}" alt="Thumbnail" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                        } else {
                            previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                        }
                    } else if (fileType.startsWith('audio/')) {
                        icon = 'bi-music-note-beamed';
                        typeLabel = 'Audio';
                        previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                    } else if (fileType.startsWith('text/') || fileType === 'application/pdf') {
                        icon = 'bi-file-earmark-text';
                        typeLabel = 'Document';
                        previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                    } else {
                        icon = 'bi-file-earmark';
                        typeLabel = 'File';
                        previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                    }
                    
                    // Default action: open file in new tab
                    if (!clickAction) {
                        clickAction = `window.open('${fileUrl}', '_blank')`;
                    }
                }
                
                // Default preview if not set
                if (!previewHtml) {
                    previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                }
                
                const authorShort = event.pubkey ? event.pubkey.substring(0, 8) + '...' : 'Unknown';
                const profileUrl = `${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${event.pubkey}`;
                
                const cardHtml = `
                    <div class="col-md-4 col-sm-6">
                        <div class="card p-2" style="cursor:pointer;" onclick="${clickAction}">
                            <div class="text-center mb-2">
                                ${previewHtml}
                            </div>
                            <h6 class="text-truncate" title="${fileName}">${fileName}</h6>
                            <small class="text-muted d-block">
                                <span class="badge bg-secondary">${typeLabel}</span> 
                                <span class="badge bg-info">kind ${event.kind}</span>
                            </small>
                            <small class="text-muted">
                                <i class="bi bi-person"></i> <a href="${profileUrl}" onclick="event.stopPropagation(); return true;" target="_blank">${authorShort}</a>
                            </small>
                        </div>
                    </div>
                `;
                
                uploadsEl.innerHTML += cardHtml;
            });
        }
        
        // Load page interactions (comments and shares)
        async function loadPageInteractions() {
            const interactionsEl = document.getElementById('pageInteractions');
            
            try {
                console.log('[INTERACTIONS] Loading page interactions...');
                
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[INTERACTIONS] Waiting for relay...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                    }
                }
                
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    const pageUrl = window.location.href;
                    console.log('[INTERACTIONS] Fetching interactions for:', pageUrl);
                    
                    const sub = window.nostrRelay.sub([{
                        kinds: [1111], // NIP-22: Comments on URLs
                        "#r": [pageUrl], // Referenced URL
                        limit: 20
                    }]);
                    
                    const events = [];
                    
                    sub.on('event', event => {
                        console.log('[INTERACTIONS] üí¨ Received interaction:', event);
                        events.push(event);
                    });
                    
                    sub.on('eose', () => {
                        console.log('[INTERACTIONS] ‚úÖ Loaded', events.length, 'interactions');
                        displayPageInteractions(events);
                        sub.unsub();
                    });
                } else {
                    console.warn('[INTERACTIONS] ‚ö†Ô∏è Relay not available');
                    interactionsEl.innerHTML = '<div class="text-center text-muted">Relay not connected</div>';
                }
            } catch (error) {
                console.error('[INTERACTIONS] ‚ùå Error loading interactions:', error);
                interactionsEl.innerHTML = '<div class="text-center text-muted">Error loading interactions</div>';
            }
        }
        
        function displayPageInteractions(events) {
            const interactionsEl = document.getElementById('pageInteractions');
            
            if (events.length === 0) {
                interactionsEl.innerHTML = '<div class="text-center text-muted">No comments or shares yet. Be the first!</div>';
                return;
            }
            
            interactionsEl.innerHTML = '';
            
            events.forEach(event => {
                const authorShort = event.pubkey ? event.pubkey.substring(0, 8) + '...' : 'Unknown';
                const time = new Date(event.created_at * 1000).toLocaleString();
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                const ipfsGateway = '{{ myIPFS }}';
                messageDiv.innerHTML = `
                    <div class="author">
                        <a href="#" onclick="window.open('${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${event.pubkey}', '_blank'); return false;">${authorShort}</a>
                    </div>
                    <div class="content">${escapeHtml(event.content)}</div>
                    <div class="time">${time}</div>
                `;
                
                interactionsEl.appendChild(messageDiv);
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showCode(template) {
            const urls = {
                'youtube': 'https://github.com/papiche/UPassport/blob/main/templates/youtube.html',
                'theater': 'https://github.com/papiche/UPassport/blob/main/templates/theater-modal.html',
                'playlist': 'https://github.com/papiche/UPassport/blob/main/templates/playlist-manager.html'
            };
            
            window.open(urls[template], '_blank');
        }
        
        // Expose functions to global scope for onclick attributes
        window.testMultipassLogin = testMultipassLogin;
        window.viewProfile = viewProfile;
        window.selectFileType = selectFileType;
        window.uploadFile = uploadFile;
        window.testComment = testComment;
        window.showCommentModal = showCommentModal;
        window.closeCommentModal = closeCommentModal;
        window.submitComment = submitComment;
        window.testShare = testShare;
        window.sendChatMessage = sendChatMessage;
        window.loadRecentUploads = loadRecentUploads;
        window.loadPageInteractions = loadPageInteractions;
        window.showCode = showCode;
        
        // Expose new common.js functions globally for easy testing
        window.verifyAuthenticationWithAPI = typeof verifyAuthenticationWithAPI !== 'undefined' ? verifyAuthenticationWithAPI : null;
        window.ensureAuthentication = typeof ensureAuthentication !== 'undefined' ? ensureAuthentication : null;
    </script>
    
    <!-- Comment Modal -->
    <div id="commentModal" class="comment-modal" style="display: none;">
        <div class="comment-modal-overlay" onclick="closeCommentModal()"></div>
        <div class="comment-modal-content">
            <div class="comment-modal-header">
                <h5><i class="bi bi-chat-square-text"></i> Post a Comment</h5>
                <button class="btn-close-modal" onclick="closeCommentModal()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <!-- Auth Warning (shown when not authenticated) -->
            <div id="commentAuthWarning" class="alert alert-warning" style="display: none;">
                <i class="bi bi-shield-lock"></i>
                <strong>Authentication Required</strong>
                <p class="mb-2">You need to connect with MULTIPASS to post comments.</p>
                <button class="btn btn-sm btn-warning" onclick="closeCommentModal(); document.getElementById('connectBtn').click();">
                    <i class="bi bi-plug"></i> Connect Now
                </button>
            </div>
            
            <!-- Comment Form (shown when authenticated) -->
            <div id="commentForm" style="display: none;">
                <div class="comment-modal-body">
                    <div class="mb-3">
                        <label for="commentInput" class="form-label">Your comment</label>
                        <textarea 
                            id="commentInput" 
                            class="form-control" 
                            rows="4" 
                            placeholder="Share your thoughts..."
                            onkeydown="if(event.key==='Enter' && event.ctrlKey) submitComment()"></textarea>
                        <div class="invalid-feedback">
                            Please enter a comment
                        </div>
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i> Press Ctrl+Enter to submit
                        </small>
                    </div>
                    
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-broadcast"></i>
                        <small>This comment will be published to NOSTR (kind 1111 - NIP-22) and linked to this page URL.</small>
                    </div>
                </div>
                
                <div class="comment-modal-footer">
                    <button class="btn btn-secondary" onclick="closeCommentModal()">
                        <i class="bi bi-x-circle"></i> Cancel
                    </button>
                    <button id="submitCommentBtn" class="btn btn-primary" onclick="submitComment()">
                        <i class="bi bi-send"></i> Publish Comment
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* Comment Modal Styles */
        .comment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .comment-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }
        
        .comment-modal-content {
            position: relative;
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .comment-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #dee2e6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .comment-modal-header h5 {
            margin: 0;
            font-weight: 600;
            color: white;
        }
        
        .btn-close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn-close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .comment-modal-body {
            padding: 24px;
        }
        
        .comment-modal-body textarea {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            font-size: 15px;
            transition: border-color 0.2s;
        }
        
        .comment-modal-body textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .comment-modal-body textarea.is-invalid {
            border-color: #dc3545;
        }
        
        .comment-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid #dee2e6;
            background: #f8f9fa;
        }
        
        .comment-modal-footer .btn {
            padding: 10px 20px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .comment-modal-footer .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .comment-modal-footer .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .comment-modal-content {
                background: #1a1a1a;
                color: #e0e0e0;
            }
            
            .comment-modal-header {
                border-bottom-color: #333;
            }
            
            .comment-modal-body textarea {
                background: #2a2a2a;
                border-color: #444;
                color: #e0e0e0;
            }
            
            .comment-modal-footer {
                background: #222;
                border-top-color: #333;
            }
        }
    </style>
</body>
</html>
