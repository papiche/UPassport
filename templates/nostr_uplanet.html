<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/x-icon" href="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1">
    <title>UPlanet - SCIC Cooperative Project Proposals</title>
    <script src="https://ipfs.copylaradio.com/ipfs/QmQLQ5WdCEc7mpKw5rhUujUU1URKweei4Bb4esyVNd9Atx/G1PalPay_fichiers/jquery-3.6.3.min.js"></script>
    <!-- Import nostr-tools (includes SimplePool) -->
    <script src="https://ipfs.copylaradio.com/ipns/copylaradio.com/nostr.bundle.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://ipfs.copylaradio.com/ipns/copylaradio.com/leaflet.css"/>
    <!-- Leaflet JavaScript -->
    <script src="https://ipfs.copylaradio.com/ipns/copylaradio.com/leaflet.js"></script>
    <style>
        /* Basic styles */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 15px; background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); color: #e0e0e0; display: flex; flex-direction: column; min-height: 100vh; box-sizing: border-box; }
        .container { background: linear-gradient(145deg, #2a2a3a, #1e1e2e); padding: 25px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); width: 100%; max-width: 500px; margin: 20px auto; box-sizing: border-box; border: 1px solid rgba(76, 175, 80, 0.2); }
        h1 { background: linear-gradient(to right, #4CAF50, #45a049, #66bb6a); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8em; text-align: center; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #cccccc; }
        textarea { width: 100%; height: 100px; padding: 10px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #555; border-radius: 4px; background-color: #333; color: #e0e0e0; font-size: 1em; }
        button, .button-like { display: block; width: 100%; padding: 15px 20px; background: linear-gradient(145deg, #4CAF50, #45a049); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em; text-align: center; margin-bottom: 15px; transition: all 0.3s ease; box-sizing: border-box; font-weight: bold; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }
        button:hover, .button-like:hover { background: linear-gradient(145deg, #45a049, #4CAF50); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4); }
        button:disabled { background: linear-gradient(145deg, #555, #444); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
        .button-like { background: linear-gradient(145deg, #2196F3, #1976D2); }
        .button-like:hover { background: linear-gradient(145deg, #1976D2, #2196F3); }
        input[type="file"] { display: none; }
        #imagePreview { display: none; max-width: 100%; height: auto; margin-top: 15px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #444; }
        #status { margin-top: 15px; font-weight: bold; text-align: center; padding: 10px; border-radius: 4px; background-color: #333; min-height: 20px; color: #ccc; word-wrap: break-word; }
        .spinner { display: none; width: 40px; height: 40px; margin: 20px auto; border: 4px solid #555; border-top: 4px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .warning {
    background: linear-gradient(to right, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
    color: #ffffff; /* Change la couleur du texte pour qu'il soit lisible sur le d√©grad√© */
    border: 1px solid #ffcc00;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
    text-align: center;
    font-weight: bold;
    -webkit-background-clip: text; /* Pour s'assurer que le texte est color√© par le d√©grad√© */
    -webkit-text-fill-color: transparent; /* Rend le texte transparent pour que le d√©grad√© soit visible */
}

        details { background-color: #333; padding: 5px; border-radius: 4px; margin-top: 15px;}
        details summary { cursor: pointer; color: #aaa; font-size: 0.9em; }
        #debug-info { margin-top: 10px; border: 1px dashed #555; padding: 10px; font-size: 0.8em; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto; background-color: #222; color: #bbb; }
        #relay-list { font-size: 0.8em; margin-top: 5px; max-height: 100px; overflow-y: auto; padding-left: 15px; color: #aaa; }
        #relay-list li { margin-bottom: 3px; }

        /* Profile & Message Area Styles */
        #profile-display { display: flex; align-items: center; padding: 10px; margin-bottom: 15px; background-color: #383838; border-radius: 5px; min-height: 50px; color: #ccc; font-size: 0.9em; }
        #profile-display img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; border: 1px solid #555; object-fit: cover; }
        #profile-info { display: flex; flex-direction: column; }
        #profile-info span { display: block; }
        #profile-info .profile-name { font-weight: bold; color: #eee; }
        #profile-info .profile-nip05 { font-size: 0.85em; color: #aaa; }
        #message-section { margin-top: 20px; padding: 15px; background-color: #333; border-radius: 5px; display: none; }
        #message-section h2 { margin-top: 0; font-size: 1.1em; color: #ddd; border-bottom: 1px solid #555; padding-bottom: 5px;}
        #message-navigation { display: flex; justify-content: space-between; margin-bottom: 15px; }
        #message-navigation button { width: auto; padding: 8px 12px; font-size: 0.9em; background-color: #555; flex-grow: 1; margin: 0 5px; } /* Style nav buttons */
        #message-navigation button:first-child { margin-left: 0; }
        #message-navigation button:last-child { margin-right: 0; }
        #message-navigation button:hover:not(:disabled) { background-color: #666; }
        #last-message-area, #replies-area { margin-top: 10px; }
        .message-item, .reply-item { background-color: #2a2a2a; border: 1px solid #444; padding: 10px; border-radius: 4px; margin-bottom: 10px; word-wrap: break-word; }
        .message-content img, .reply-content img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 5px; }
        .reply-author { font-size: 0.85em; color: #aaa; margin-bottom: 5px; }
        .reply-author code { background-color: #444; padding: 1px 3px; border-radius: 3px;}
        .reply-content { font-size: 0.95em; color: #ddd;}
        #replies-list { padding-left: 0; list-style: none; }
        /* Location Tumbler Styles */
        #location-controls {
             border: 1px solid #444;
             border-radius: 5px;
             padding: 10px;
             background-color: #282828; /* Slightly different bg */
        }
        .coord-control {
            text-align: center; /* Center the label */
        }
        .coord-control > div {
             justify-content: center; /* Center the selects horizontally */
        }
        .tumbler {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding: 6px 2px;
            border: 1px solid #555;
            background-color: #404040;
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            font-weight: bold;
            border-radius: 3px;
            margin: 0 1px;
            text-align: center;
            cursor: pointer;
            min-width: 24px;
            max-width: 32px;
        }
        .tumbler:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        .tumbler-dot {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0 2px;
            align-self: center; /* Vertically align the dot */
            color: #aaa;
        }
        #location-status {
             min-height: 1.1em; /* Prevent layout jump */
             cursor: pointer;
             padding: 8px;
             border-radius: 4px;
             transition: background-color 0.3s ease;
        }
        #location-status:hover {
             background-color: #383838;
        }

        /* Map accordion styles */
        .map-accordion {
            margin-top: 10px;
            border: 1px solid #444;
            border-radius: 5px;
            background-color: #333;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease;
        }
        .map-accordion.open {
            max-height: 500px;
        }
        .map-accordion-content {
            padding: 15px;
        }
        .map-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .coord-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .coord-input label {
            font-weight: bold;
            color: #cccccc;
            margin: 0;
            min-width: 30px;
            font-size: 0.8em;
        }
        .coord-input input {
            width: 70px;
            padding: 6px;
            border: 1px solid #555;
            border-radius: 3px;
            font-size: 0.85em;
            background-color: #404040;
            color: #e0e0e0;
        }
        .coord-input input:focus {
            border-color: #4CAF50;
            outline: none;
        }
        .map-button {
            padding: 6px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s ease;
        }
        .map-button:hover {
            background-color: #45a049;
        }
        .map-button.secondary {
            background-color: #2196F3;
        }
        .map-button.secondary:hover {
            background-color: #1976D2;
        }
        #mini-map {
            height: 250px;
            width: 100%;
            border-radius: 4px;
            border: 1px solid #555;
        }

        /* Ajout de media queries pour le responsive */
        @media screen and (max-width: 480px) {
            .container {
                padding: 10px;
                margin: 10px auto;
            }

            #location-controls {
                margin-bottom: 10px;
            }

            #location-values {
                flex-direction: column;
                gap: 10px;
            }

            .coord-control {
                width: 100%;
            }

            .coord-control > div {
                justify-content: center;
                flex-wrap: wrap;
                gap: 2px;
            }

            .tumbler {
                padding: 4px 1px;
                font-size: 0.85em;
                min-width: 22px;
                max-width: 28px;
            }

            .tumbler-dot {
                font-size: 1em;
                margin: 0 1px;
            }

            .map-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .coord-input {
                justify-content: center;
            }
        }

        /* Ajustements pour les √©crans tr√®s petits */
        @media screen and (max-width: 320px) {
            .tumbler {
                padding: 3px 1px;
                font-size: 0.8em;
                min-width: 20px;
                max-width: 24px;
            }
        }

        .tag-button {
            padding: 8px 12px;
            background: linear-gradient(145deg, #444, #333);
            color: #fff;
            border: 1px solid #555;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex: 1;
            max-width: 150px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .tag-button:hover {
            background: linear-gradient(145deg, #555, #444);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .tag-button.active {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            border-color: #66bb6a;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        /* Enhanced Message Styles (inspired by nostr_profile_viewer.html) */
        .message-item {
            background: linear-gradient(145deg, #2a2a3a, #1e1e2e);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .message-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            border-color: rgba(76, 175, 80, 0.4);
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .profile-section {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .profile-pic-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: white;
            border: 2px solid rgba(76, 175, 80, 0.3);
        }
        
        .profile-pic-placeholder img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .profile-name {
            font-weight: bold;
            color: #4CAF50;
            font-size: 1em;
        }
        
        .profile-pubkey {
            font-size: 0.8em;
            color: #aaa;
            font-family: monospace;
            word-break: break-all;
        }
        .message-content {
            line-height: 1.6;
            color: #e0e0e0;
            margin-bottom: 15px;
            word-wrap: break-word;
        }
        .message-metadata {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(76, 175, 80, 0.1);
        }
        .project-counter {
            color: #4CAF50;
            font-weight: bold;
        }
        .project-id {
            color: #2196F3;
            font-family: monospace;
        }
        .project-date {
            color: #FF9800;
        }

        /* Heart/Like button styles */
        .heart-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-right: 10px;
            margin-top: 5px;
            padding: 5px;
            transition: all 0.2s ease;
            color: #555;
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.3);
        }
        .heart-button:hover {
            color: #f44;
            text-shadow: 0 0 5px #f44;
            transform: scale(1.1);
        }
        .heart-button.liked {
            color: #f44;
            text-shadow: 0 0 8px #f44;
        }
        .heart-button.loading {
            color: #4CAF50;
            text-shadow: 0 0 5px #4CAF50;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Media Styles */
        .media-container {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .media-link {
            color: #4CAF50;
            text-decoration: underline;
            font-size: 0.9em;
        }
        .message-image {
            max-width: 150px;
            height: auto;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .message-image:hover {
            transform: scale(1.05);
        }
        .message-video, .message-audio {
            max-width: 150px;
            height: auto;
            border: 1px solid #444;
            border-radius: 4px;
        }

        /* Enhanced Reply Styles */
        .reply-item {
            background: rgba(0,0,0,0.1);
            border: 1px solid rgba(76, 175, 80, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .reply-item:hover {
            background: rgba(0,0,0,0.15);
            border-color: rgba(76, 175, 80, 0.2);
        }
        .reply-author {
            font-size: 0.9em;
            color: #4CAF50;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .reply-content {
            font-size: 0.95em;
            color: #ddd;
            line-height: 1.5;
        }

        /* Modal styles */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            border: 3px solid #4CAF50;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            animation-name: zoom;
            animation-duration: 0.6s;
        }

        .image-modal-content img,
        .image-modal-content video,
        .image-modal-content audio {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 5px;
        }

        @keyframes zoom {
            from {transform:scale(0)}
            to {transform:scale(1)}
        }

        .image-modal-close {
            position: absolute;
            top: -40px;
            right: -40px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
            background: rgba(0,0,0,0.9);
        }

        /* Message Slider Styles */
        .message-slider {
            background: linear-gradient(145deg, #2a2a3a, #1e1e2e);
            border: 1px solid rgba(76, 175, 80, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
        }
        
        .slider-header h3 {
            margin: 0;
            color: #4CAF50;
            font-size: 1.2em;
        }
        
        .slider-info {
            font-size: 0.9em;
            color: #aaa;
            font-weight: bold;
        }
        
        .slider-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .slider-btn {
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slider-btn:hover:not(:disabled) {
            background: linear-gradient(145deg, #45a049, #4CAF50);
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .slider-btn:disabled {
            background: linear-gradient(145deg, #555, #444);
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .slider-indicators {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .slider-indicator {
            background: none;
            border: none;
            color: #555;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px;
        }
        
        .slider-indicator:hover {
            color: #4CAF50;
            transform: scale(1.2);
        }
        
        .slider-indicator.active {
            color: #4CAF50;
            text-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
        }

        /* Mode toggle buttons responsive styling */
        #mode-toggle, #n2-mode-toggle {
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        #mode-toggle:hover, #n2-mode-toggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        #n2-mode-toggle {
            background: linear-gradient(145deg, #9C27B0, #7B1FA2) !important;
        }
        
        #n2-mode-toggle:hover {
            background: linear-gradient(145deg, #7B1FA2, #9C27B0) !important;
        }

        /* Profile Modal Styles */
        .profile-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
            padding: 20px;
        }

        .profile-modal-content {
            position: relative;
            width: 90%;
            height: 90%;
            border-radius: 8px;
            border: 3px solid #9C27B0;
            box-shadow: 0 0 20px rgba(156, 39, 176, 0.8);
            background-color: #1a1a2e;
            display: flex;
            flex-direction: column;
        }

        .profile-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(156, 39, 176, 0.3);
            background: linear-gradient(145deg, #2a2a3a, #1e1e2e);
        }

        .profile-modal-title {
            color: #9C27B0;
            font-size: 1.2em;
            font-weight: bold;
            margin: 0;
        }

        .profile-modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: #f1f1f1;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            background: rgba(156, 39, 176, 0.7);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .profile-modal-close:hover,
        .profile-modal-close:focus {
            color: #bbb;
            background: rgba(156, 39, 176, 0.9);
        }

        .profile-modal-iframe {
            flex: 1;
            width: 100%;
            border: none;
            border-radius: 0 0 5px 5px;
        }

        .profile-modal-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9C27B0;
            font-size: 1.1em;
        }

        .profile-modal-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #f44336;
            font-size: 1.1em;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="nsec-warning" class="warning">
             üåç UPlanet SCIC Cooperative üåç
        </div>
        <script>
        document.getElementById('nsec-warning').addEventListener('click', function() {
            history.go(-1);
        });
        </script>
        <div id="profile-display"><span>Loading profile...</span></div>

        <!-- Wallet Balance Display -->
        <div id="wallet-balance" style="margin: 15px 0; padding: 10px; background-color: #282828; border-radius: 5px; border: 1px solid #444;">
            <div style="display: flex; justify-content: space-around; gap: 10px;">
                <div class="balance-item" style="text-align: center; flex: 1;">
                    <div style="font-size: 0.9em; color: #aaa;">G1 Balance</div>
                    <div id="g1-balance" style="font-size: 1.2em; color: #4CAF50; font-weight: bold;">0 G1</div>
                </div>
                <div class="balance-item" style="text-align: center; flex: 1;">
                    <div style="font-size: 0.9em; color: #aaa;">Zen Balance</div>
                    <div id="zen-balance" style="font-size: 1.2em; color: #2196F3; font-weight: bold;">0 ZEN</div>
                </div>
            </div>
        </div>
        <button id="connectButton" disabled>Connect with Nostr</button>

        <label for="message">Project Proposal:</label>
        <textarea id="message" placeholder="Describe your uplanet project for the SCIC cooperative..."></textarea>
        <div id="tag-buttons" style="display: flex; gap: 5px; margin: 5px 0 15px 0; justify-content: center;">
            <button type="button" class="tag-button main-tag" data-tag="#BRO">ü§ñ IA</button>
            <button type="button" class="tag-button" data-tag="#uplanet">üí≠ UPlanet Project</button>
        </div>
        <label for="imageInput" class="button-like">üì∏ Photo</label>
        <input type="file" id="imageInput" accept="image/*">
        <img id="imagePreview" src="#" alt="Image Preview"/>
        <button id="postButton" disabled>üå± Propose Project</button>
        <div class="spinner" id="loadingSpinner"></div>
        <div id="status">Initializing UPlanet SCIC Cooperative...</div>

        <!-- Location Adjustment UI -->
        <div id="location-controls" style="margin-bottom: 15px; display: none;">
            <div id="location-values" style="display: flex; justify-content: space-around; background-color: #333; padding: 8px; border-radius: 5px; gap: 10px;">
                <!-- Latitude -->
                <div class="coord-control">
                    <label for="lat-sign" style="font-size: 0.8em; display: block; text-align: center; margin-bottom: 3px;">Latitude</label>
                    <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 2px;">
                        <select id="lat-sign" class="tumbler">
                            <option value="N">N</option>
                            <option value="S">S</option>
                        </select>
                        <select id="lat-deg1" class="tumbler"></select>
                        <select id="lat-deg0" class="tumbler"></select>
                        <span class="tumbler-dot">.</span>
                        <select id="lat-frac1" class="tumbler"></select>
                        <select id="lat-frac0" class="tumbler"></select>
                    </div>
                </div>
                <!-- Longitude -->
                <div class="coord-control">
                    <label for="lon-sign" style="font-size: 0.8em; display: block; text-align: center; margin-bottom: 3px;">Longitude</label>
                    <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 2px;">
                        <select id="lon-sign" class="tumbler">
                            <option value="E">E</option>
                            <option value="W">W</option>
                        </select>
                        <select id="lon-deg2" class="tumbler"></select>
                        <select id="lon-deg1" class="tumbler"></select>
                        <select id="lon-deg0" class="tumbler"></select>
                        <span class="tumbler-dot">.</span>
                        <select id="lon-frac1" class="tumbler"></select>
                        <select id="lon-frac0" class="tumbler"></select>
                    </div>
                </div>
            </div>
            <div id="location-status" style="font-size: 0.8em; text-align: center; margin-top: 5px; color: #aaa;">Fetching location...</div>
            
            <!-- Map Accordion -->
            <div id="map-accordion" class="map-accordion">
                <div class="map-accordion-content">
                    <div class="map-controls">
                        <div class="coord-input">
                            <label>Lat:</label>
                            <input type="number" id="lat-display" step="0.01" min="-90" max="90">
                        </div>
                        <div class="coord-input">
                            <label>Lon:</label>
                            <input type="number" id="lon-display" step="0.01" min="-180" max="180">
                        </div>
                        <button type="button" class="map-button" id="update-map">Y aller</button>
                        <button type="button" class="map-button secondary" id="get-location">Ma position</button>
                    </div>
                    <div id="mini-map"></div>
                    <div style="padding: 8px 0; font-size: 0.8em; color: #aaa; text-align: center;">
                        üí° Cliquez sur la carte pour ajuster votre position
                    </div>
                </div>
            </div>
        </div>
        <!-- Project Proposals Section -->
        <div id="message-section">
            <!-- Mode Toggle Buttons -->
            <div style="margin-bottom: 15px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button id="mode-toggle" style="background: linear-gradient(145deg, #2196F3, #1976D2); padding: 8px 16px; font-size: 0.9em; border-radius: 6px; border: none; color: white; cursor: pointer; transition: all 0.3s ease;">
                    üåç Mode UMAP (Zones voisines)
                </button>
                <button id="n2-mode-toggle" style="background: linear-gradient(145deg, #9C27B0, #7B1FA2); padding: 8px 16px; font-size: 0.9em; border-radius: 6px; border: none; color: white; cursor: pointer; transition: all 0.3s ease;">
                    üåê Mode N2 (R√©seau personnel)
                </button>
            </div>
            <!-- Navigation Buttons -->
            <div id="message-navigation">
                <button id="older-button" disabled> < </button>
                <button id="refresh-button">___</button>
                <button id="newer-button" disabled> > </button>
            </div>
            <div id="last-message-area">Loading project proposals...</div>
            <div id="replies-area">
                <h3>Community Feedback</h3>
                <ul id="replies-list"><li>Select a project to see community feedback...</li></ul>
            </div>
        </div>

        <details>
            <summary>Show Relays & Debug</summary>
            <div id="relay-list-container" style="margin-top: 10px;">
                <span style="font-size: 0.9em; color: #bbb;">Publishing to:</span>
                <ul id="relay-list"><li>Loading relays...</li></ul>
            </div>
            <div id="debug-info"></div>
        </details>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="profile-modal">
        <div class="profile-modal-content">
            <div class="profile-modal-header">
                <h3 class="profile-modal-title">üåê Profile Viewer</h3>
                <span class="profile-modal-close">&times;</span>
            </div>
            <div id="profileModalContent" class="profile-modal-loading">
                Loading profile...
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        // Architecture de domaine Astroport :
        // - ipfs.domain.tld ou IP:8080 sert l'application (passerelle IPFS)
        // - u.domain.tld ou IP:54321 est l'API qui contr√¥le les acc√®s (page actuelle)
        // - wss://relay.domain.tld ou IP:7777 est le relai NOSTR
        // - La page actuelle se charge depuis u.domain.tld (:54321) et charge les profils depuis ipfs.domain.tld (:8080)
        
        const userNsec = ''; // Leave empty for extension
        const MESSAGES_PER_PAGE = 10; // How many messages to fetch at once
        let manualLocationSet = false; // Flag to track if UI is populated
        // --- Global Variables ---
        let debugInfo = '';
        let nostrExtensionAvailable = false;
        let privateKeyHex = null;
        let publicKey = '';
        let userProfile = null;
        let fetchedMessages = []; // Store the batch of fetched messages
        let currentMessageIndex = 0; // Index of the currently displayed message
        let pool = null;
        let selectedImageDataUrl = null;
        let currentLatitude = null;
        let currentLongitude = null;
        let umapMode = false; // Mode UMAP activ√© ou non
        let n2Mode = false; // Mode N2 activ√© ou non
        const DEFAULT_RELAYS = [getRelayURL(), 'wss://relay.copylaradio.com'];
        let allRelaysToPublish = [...DEFAULT_RELAYS];

        // Global media collection for navigation
        window.mediaCollection = [];
        window.currentMediaIndex = 0;

        // --- Helper Functions ---
        function log(message) { console.log(message); const ts = new Date().toLocaleTimeString(); debugInfo += `[${ts}] ${message}\n`; const lines = debugInfo.split('\n'); if (lines.length > 150) debugInfo = lines.slice(-150).join('\n'); $('#debug-info').text(debugInfo); const el = document.getElementById('debug-info'); if (el) el.scrollTop = el.scrollHeight; }

        // Helper function to get Nostr extension (works in iframe)
        function getNostrExtension() {
            // First try current window
            if (window.nostr) {
                return window.nostr;
            }
            
            // If in iframe, try parent window
            try {
                if (window.self !== window.top && window.parent && window.parent.nostr) {
                    return window.parent.nostr;
                }
                
                // Try top window
                if (window.top && window.top.nostr) {
                    return window.top.nostr;
                }
            } catch (e) {
                // Cross-origin iframe - can't access parent
                console.warn('Cannot access parent window nostr (cross-origin):', e);
            }
            
            return null;
        }
        function updateStatus(message, isError = false, isSuccess = false) { log(`Status Update: ${message}`); const el = $('#status'); el.text(message); let bg = '#333', fg = '#ccc'; if (isError) { bg = '#5c3a3a'; fg = '#ff6b6b'; } else if (isSuccess) { bg = '#3a5c3a'; fg = '#90ee90'; } el.css({ 'background-color': bg, 'color': fg }); }
        function showLoading(show) { $('#loadingSpinner').toggle(show); $('#postButton').prop('disabled', show || !publicKey); }
        function getRelayURL() { 
            const currentUrl = new URL(window.location.href);
            
            // If we're on port 54321, return immediately
            if (currentUrl.port === '54321') {
                return `ws://${currentUrl.hostname}:7777`;
            }
            
            // Si on est sur l'API u., calculer le relai NOSTR
            if (currentUrl.hostname.startsWith('u.')) {
                let relayHostname = currentUrl.hostname.replace('u.', 'relay.');
                   
                return `wss://${relayHostname}`;
            }
            
            // Fallback pour les autres cas
            return 'wss://relay.copylaradio.com';
        }

        // Utility function to get IPFS URL based on domain architecture
        function getIPFSUrl(route) {
            const currentUrl = new URL(window.location.href);
            
            // If we're on port 54321, return immediately
            if (currentUrl.port === '54321') {
                return `http://${currentUrl.hostname}:8080${route}`;
            }
            
            // If we're on u. API, calculate IPFS gateway
            if (currentUrl.hostname.startsWith('u.')) {
                let ipfsHostname = currentUrl.hostname.replace('u.', 'ipfs.');
                return `https://${ipfsHostname}${route}`;
            }
            
            // Fallback for other cases
            return `https://ipfs.copylaradio.com${route}`;
        }

        function updateRelayListUI() { 
            const l = $('#relay-list').empty(); 
            
            // Afficher l'architecture de domaine actuelle
            const currentUrl = new URL(window.location.href);
            const domainInfo = $('<li>').html(`<strong>üåê Current Domain:</strong> ${currentUrl.hostname}:${currentUrl.port}`).appendTo(l);
            
            // Afficher les relais calcul√©s
            if (allRelaysToPublish.length > 0) {
                allRelaysToPublish.forEach((r, index) => { 
                    const li = $('<li>').text(r); 
                    if (r === getRelayURL()) { 
                        li.prepend('üéØ Primary Relay: '); 
                        li.css('color', '#4CAF50');
                    } else if (r === userProfile?.source) { 
                        li.prepend('üìå Source: '); 
                        li.css('color', '#2196F3');
                    } else {
                        li.prepend('üîó Relay: ');
                    }
                    li.appendTo(l); 
                }); 
            }
            
            log(`UI updated: ${allRelaysToPublish.length} relays.`);
        }



        // --- Nostr Interaction Functions ---
        function getNostrPool() { if (!pool) { if (typeof NostrTools?.SimplePool !== 'function') { const m = "Error: NostrTools.SimplePool undef/not func!"; log(m); console.error(m, "NostrTools:", NostrTools); updateStatus(m, true); throw new Error(m); } try { log("Init SimplePool..."); pool = new NostrTools.SimplePool({ getTimeout: 6000, listTimeout: 6000 }); if (typeof pool?.list !== 'function' || typeof pool?.get !== 'function') { log("Error: Pool missing methods."); console.error("Bad pool:", pool); pool = null; throw new Error("Pool invalid."); } log("Pool init OK."); } catch (e) { log(`Pool init error: ${e.message}`); console.error("Pool Init Details:", e); updateStatus("Fail pool init.", true); throw e; } } if (!pool) { const m = "Error: Pool null after init."; log(m); updateStatus("Relay pool N/A.", true); throw new Error(m); } return pool; }
        async function fetchProfileAndRelays(pubkey) {
            log(`Fetching profile/relays for ${pubkey.slice(0,10)}...`);
            let nostrPool;
            try {
                nostrPool = getNostrPool();
            } catch (e) {
                log("Pool fail in fetchProfileRelays.");
                return {};
            }

            let profileEv = null;
            let relayEv = null;
            let userRelays = [];
            let userProfile = {};
            let profileSource = '';

            try {
                // Fetch from each relay individually to track the source
                for (const relay of DEFAULT_RELAYS) {
                    try {
                        const events = await nostrPool.list([relay], [
                            { kinds: [0], authors: [pubkey], limit: 1 }
                        ]);
                        
                        if (events.length > 0) {
                            const event = events[0];
                            if (!profileEv || event.created_at > profileEv.created_at) {
                                profileEv = event;
                                profileSource = relay;
                                log(`Profile from relay: ${profileSource}`);
                                
                                // Extract additional fields from tags
                                if (event.tags) {
                                    event.tags.forEach(tag => {
                                        if (tag[0] === 'i') {
                                            const [type, value] = tag[1].split(':');
                                            switch(type) {
                                                case 'g1pub':
                                                    userProfile.g1_address = value;
                                                    log(`Found G1 address: ${value}`);
                                                    break;
                                                case 'g1pubv2':
                                                    userProfile.g1_address_v2 = value;
                                                    log(`Found G1 address v2: ${value}`);
                                                    break;
                                                case 'zencard':
                                                    userProfile.zen_address = value;
                                                    log(`Found Zen address: ${value}`);
                                                    break;
                                                case 'github':
                                                    userProfile.github = value;
                                                    break;
                                                case 'twitter':
                                                    userProfile.twitter = value;
                                                    break;
                                                case 'mastodon':
                                                    userProfile.mastodon = value;
                                                    break;
                                                case 'telegram':
                                                    userProfile.telegram = value;
                                                    break;
                                                case 'ipfs_gw':
                                                    userProfile.ipfs_gw = value;
                                                    break;
                                                case 'ipns_vault':
                                                    userProfile.ipns_vault = value;
                                                    break;
                                                case 'tw_feed':
                                                    userProfile.tw_feed = value;
                                                    break;
                                            }
                                        }
                                    });
                                }
                            }
                        }
                    } catch (e) {
                        log(`Error fetching from ${relay}: ${e.message}`);
                    }
                }

                // Now fetch relay list
                const relayEvents = await nostrPool.list(DEFAULT_RELAYS, [
                    { kinds: [10002], authors: [pubkey], limit: 1 }
                ]);

                if (relayEvents.length > 0) {
                    relayEv = relayEvents[0];
                    log(`Relay list event: ${relayEv.id}`);
                    userRelays = relayEv.tags
                        .filter(t => t[0] === 'r' && typeof t[1] === 'string' && t[1].startsWith('wss://'))
                        .map(t => t[1]);
                    log(`Extracted ${userRelays.length} relays.`);
                }

                if (profileEv) {
                    log(`Profile event: ${profileEv.id}`);
                    try {
                        const parsedContent = JSON.parse(profileEv.content);
                        userProfile = { ...userProfile, ...parsedContent }; // Merge with existing profile data
                        userProfile.source = profileSource; // Add source to profile data
                        log(`Profile data: ${JSON.stringify(userProfile, null, 2)}`);
                    } catch (e) {
                        log(`Profile parse error: ${e.message}`);
                        userProfile = {};
                    }
                }

                const dyn = getRelayURL();
                const comb = new Set([...DEFAULT_RELAYS, dyn, ...userRelays]);
                allRelaysToPublish = [...comb];
                updateRelayListUI();
                
                // Render profile first
                renderProfile(pubkey, userProfile);
                
                // Then check wallet balances if addresses are available
                if (userProfile.g1_address || userProfile.g1_address_v2) {
                    log("Checking G1 wallet balances...");
                    await checkG1Balances(userProfile);
                }
                
                return userProfile;
            } catch (e) {
                log(`Error fetching profile/relays: ${e}`);
                updateStatus('Error fetching profile/relay.', true);
                return {};
            }
        }

        // Fonction pour v√©rifier les soldes G1 et calculer ZEN
        async function checkG1Balances(profileData) {
            try {
                let g1Balance = 0;
                
                if (profileData.g1_address) {
                    const response = await fetch(`/check_balance?g1pub=${profileData.g1_address}`);
                    const data = await response.json();
                    const balance = parseFloat(data.balance) || 0;
                    $('#g1-balance-v1').text(`${balance} G1`);
                    $('#g1-balance').text(`${balance} G1`); // Update main balance display
                    g1Balance = balance; // Use this balance for ZEN calculation
                }
                if (profileData.g1_address_v2) {
                    const response = await fetch(`/check_balance?g1pub=${profileData.g1_address_v2}`);
                    const data = await response.json();
                    const balance = parseFloat(data.balance) || 0;
                    $('#g1-balance-v2').text(`${balance} G1`);
                    // Use V2 balance for ZEN calculation if V1 is not available
                    if (!profileData.g1_address) {
                        g1Balance = balance;
                    }
                }
                
                // Calculate ZEN balance using the formula: (G1_BALANCE - 1) * 10
                const zenBalance = Math.floor((g1Balance - 1) * 10);
                $('#zen-balance').text(`${zenBalance} ZEN`);
                
            } catch (error) {
                log(`Error checking G1 balances: ${error.message}`);
                $('#g1-balance-v1, #g1-balance-v2').text('Error loading balance');
                $('#g1-balance').text('Error loading balance');
                $('#zen-balance').text('Error');
            }
        }

        function renderProfile(pubkey, profileData) {
            const div = $('#profile-display').empty();
            const defPic = 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1';
            const pic = profileData?.picture || defPic;
            const name = profileData?.display_name || profileData?.name || pubkey.slice(0, 16);
            const nip05 = profileData?.nip05 || '';
            const source = profileData?.source || 'unknown';

            // Cr√©ation de la structure du profil
            const profileContainer = $('<div>').addClass('profile-container')
                .css('cursor', 'pointer')
                .attr('title', 'Click to view full profile')
                .on('click', function() {
                    openProfileModal(pubkey, name);
                })
                .appendTo(div);
            
            // Add clickable indicator to main profile
            $('<div>').addClass('profile-click-indicator')
                .html('üîç')
                .css({
                    'position': 'absolute',
                    'top': '15px',
                    'right': '15px',
                    'font-size': '1em',
                    'color': '#9C27B0',
                    'opacity': '0.8',
                    'z-index': '10'
                })
                .appendTo(profileContainer);
            
            // Image et info de base
            const basicInfo = $('<div>').addClass('profile-basic-info').appendTo(profileContainer);
            $('<img>').attr('src', pic).on('error', function() {
                $(this).attr('src', defPic);
            }).appendTo(basicInfo);
            
            const infoDiv = $('<div>').addClass('profile-info').appendTo(basicInfo);
            $('<span>').addClass('profile-name').text(name).appendTo(infoDiv);
            if (nip05) $('<span>').addClass('profile-nip05').text(nip05).appendTo(infoDiv);

            // Section des portefeuilles G1
            if (profileData.g1_address || profileData.g1_address_v2) {
                const walletSection = $('<div>').addClass('wallet-section').appendTo(profileContainer);
                const g1Wallet = $('<div>').addClass('wallet-info').appendTo(walletSection);
                
                $('<div>').addClass('wallet-label').text('G1 Wallets').appendTo(g1Wallet);
                
                if (profileData.g1_address) {
                    const v1Wallet = $('<div>').addClass('wallet-version').appendTo(g1Wallet);
                    $('<div>').addClass('wallet-address')
                        .text(`V1: ${profileData.g1_address}`)
                        .appendTo(v1Wallet);
                    $('<div>').addClass('wallet-balance')
                        .html('<span class="balance-label">Balance:</span> <span id="g1-balance-v1" class="balance-amount">Loading...</span>')
                        .appendTo(v1Wallet);
                }
                
                if (profileData.g1_address_v2) {
                    const v2Wallet = $('<div>').addClass('wallet-version').appendTo(g1Wallet);
                    $('<div>').addClass('wallet-address')
                        .text(`V2: ${profileData.g1_address_v2}`)
                        .appendTo(v2Wallet);
                    $('<div>').addClass('wallet-balance')
                        .html('<span class="balance-label">Balance:</span> <span id="g1-balance-v2" class="balance-amount">Loading...</span>')
                        .appendTo(v2Wallet);
                }
            }

            // Ajout des styles CSS
            $('<style>').text(`
                .profile-container {
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    padding: 15px;
                    background: #232733;
                    border-radius: 8px;
                    transition: all 0.3s ease;
                }
                .profile-container:hover {
                    background: #2a2f3a;
                    transform: translateY(-2px);
                    box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
                }
                .profile-basic-info {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                }
                .wallet-section {
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                    margin-top: 10px;
                }
                .wallet-info {
                    background: #1e2533;
                    padding: 15px;
                    border-radius: 6px;
                }
                .wallet-label {
                    font-weight: bold;
                    color: #4CAF50;
                    margin-bottom: 10px;
                    font-size: 1.1em;
                }
                .wallet-version {
                    background: #2a2f3a;
                    padding: 10px;
                    border-radius: 4px;
                    margin-bottom: 10px;
                }
                .wallet-address {
                    font-family: monospace;
                    font-size: 0.9em;
                    color: #b8c6e0;
                    word-break: break-all;
                    margin: 5px 0;
                }
                .wallet-balance {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-top: 5px;
                    padding-top: 5px;
                    border-top: 1px solid #333;
                }
                .balance-label {
                    color: #b8c6e0;
                }
                .balance-amount {
                    color: #4CAF50;
                    font-weight: bold;
                }
                #g1-balance, #zen-balance {
                    font-size: 1.2em;
                    font-weight: bold;
                    color: #4CAF50;
                }
            `).appendTo('head');
        }

        // --- Location UI Helper Functions ---

        // Populate a select dropdown with numbers
        function populateSelect(selectId, start, end) {
            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = ''; // Clear existing options
            for (let i = start; i <= end; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i.toString().padStart(end.toString().length > 1 && i < 10 ? end.toString().length : 1, '0'); // Pad with 0 if needed (e.g., 0-9 -> 0,1..9; 0-10 -> 00,01..10)
                select.appendChild(option);
            }
        }

        // Populate all location selects with default ranges
        function initializeLocationSelects() {
            populateSelect('lat-deg1', 0, 9);
            populateSelect('lat-deg0', 0, 9);
            populateSelect('lat-frac1', 0, 9);
            populateSelect('lat-frac0', 0, 9);

            populateSelect('lon-deg2', 0, 1);
            populateSelect('lon-deg1', 0, 9);
            populateSelect('lon-deg0', 0, 9);
            populateSelect('lon-frac1', 0, 9);
            populateSelect('lon-frac0', 0, 9);

            // Add change listener to longitude hundreds digit to restrict next digit
            $('#lon-deg2').on('change', function() {
                const hundreds = parseInt($(this).val(), 10);
                const lonDeg1Select = $('#lon-deg1');
                const currentLonDeg1 = parseInt(lonDeg1Select.val() || '0', 10);
                lonDeg1Select.empty(); // Clear options

                let maxTens = 9;
                if (hundreds === 1) {
                    maxTens = 8; // Max longitude is 180
                }

                for (let i = 0; i <= maxTens; i++) {
                    $('<option>').val(i).text(i).appendTo(lonDeg1Select);
                }
                // Try to restore previous value if valid, else set to 0
                lonDeg1Select.val(currentLonDeg1 <= maxTens ? currentLonDeg1 : '0');
                lonDeg1Select.trigger('change'); // Trigger change for the next digit
            });

             // Add change listener to longitude tens digit to restrict units digit if hundreds is 1
             $('#lon-deg1').on('change', function() {
                 const hundreds = parseInt($('#lon-deg2').val(), 10);
                 const tens = parseInt($(this).val(), 10);
                 const lonDeg0Select = $('#lon-deg0');
                 const currentLonDeg0 = parseInt(lonDeg0Select.val() || '0', 10);
                 lonDeg0Select.empty(); // Clear options

                 let maxUnits = 9;
                 if (hundreds === 1 && tens === 8) {
                     maxUnits = 0; // Max longitude is 180.00
                 }

                 for (let i = 0; i <= maxUnits; i++) {
                     $('<option>').val(i).text(i).appendTo(lonDeg0Select);
                 }
                 // Try to restore previous value if valid, else set to 0
                 lonDeg0Select.val(currentLonDeg0 <= maxUnits ? currentLonDeg0 : '0');
             });


            // Add change listener to latitude tens digit to restrict next digit (max 90)
            $('#lat-deg1').on('change', function() {
                const tens = parseInt($(this).val(), 10);
                const latDeg0Select = $('#lat-deg0');
                const currentLatDeg0 = parseInt(latDeg0Select.val() || '0', 10);
                 latDeg0Select.empty();

                 let maxUnits = 9;
                 if (tens === 9) {
                     maxUnits = 0; // Max latitude is 90
                 }
                for (let i = 0; i <= maxUnits; i++) {
                    $('<option>').val(i).text(i).appendTo(latDeg0Select);
                }
                latDeg0Select.val(currentLatDeg0 <= maxUnits ? currentLatDeg0 : '0');

                // If 90 is selected, force fractions to 0
                if (tens === 9 && maxUnits === 0) {
                    $('#lat-frac1').val('0').prop('disabled', true);
                    $('#lat-frac0').val('0').prop('disabled', true);
                } else {
                     $('#lat-frac1').prop('disabled', false);
                     $('#lat-frac0').prop('disabled', false);
                }
            });

            // Initial population based on default tens value (0)
            $('#lat-deg1').trigger('change');
            $('#lon-deg2').trigger('change'); // This will trigger the chain for lon-deg1 change
        }


        // Update the location UI selects based on numeric lat/lon
        function updateLocationUI(latitude, longitude) {
            if (latitude == null || longitude == null) {
                log("Cannot update location UI: Invalid coordinates.");
                 $('#location-status').text('Location unavailable.');
                // Optionally set UI to 0.00 N, 0.00 E
                $('#lat-sign').val('N');
                $('#lat-deg1').val(0); $('#lat-deg0').val(0);
                $('#lat-frac1').val(0); $('#lat-frac0').val(0);
                $('#lon-sign').val('E');
                $('#lon-deg2').val(0); $('#lon-deg1').val(0); $('#lon-deg0').val(0);
                $('#lon-frac1').val(0); $('#lon-frac0').val(0);
                $('#lat-deg1').trigger('change'); // Update constraints
                $('#lon-deg2').trigger('change'); // Update constraints
                 manualLocationSet = true;
                $('#location-controls').show();
                return;
            }

            log(`Updating Location UI: Lat ${latitude.toFixed(6)}, Lon ${longitude.toFixed(6)}`);

            // Latitude
            const latAbs = Math.abs(latitude);
            const latDeg = Math.floor(latAbs);
            const latFrac = Math.round((latAbs - latDeg) * 100); // Get 2 decimal places

            $('#lat-sign').val(latitude >= 0 ? 'N' : 'S');
            $('#lat-deg1').val(Math.floor(latDeg / 10) % 10);
            $('#lat-deg0').val(latDeg % 10);
            $('#lat-frac1').val(Math.floor(latFrac / 10) % 10);
            $('#lat-frac0').val(latFrac % 10);

            // Longitude
            const lonAbs = Math.abs(longitude);
            const lonDeg = Math.floor(lonAbs);
            const lonFrac = Math.round((lonAbs - lonDeg) * 100); // Get 2 decimal places

            $('#lon-sign').val(longitude >= 0 ? 'E' : 'W');
            $('#lon-deg2').val(Math.floor(lonDeg / 100) % 10);
            $('#lon-deg1').val(Math.floor(lonDeg / 10) % 10);
            $('#lon-deg0').val(lonDeg % 10);
            $('#lon-frac1').val(Math.floor(lonFrac / 10) % 10);
            $('#lon-frac0').val(lonFrac % 10);

            // Trigger change events to ensure constraints (like 180 deg) are applied correctly
            $('#lat-deg1').trigger('change');
            $('#lon-deg2').trigger('change'); // This triggers lon-deg1 check too


            $('#location-status').text(`Location Acquired: ${latitude.toFixed(2)}, ${longitude.toFixed(2)}`);
            manualLocationSet = true; // Mark UI as populated
            $('#location-controls').show(); // Show the controls
        }

        // Read the adjusted location from the UI selects
        function readLocationFromUI() {
            if (!manualLocationSet) {
                 log("Location UI not initialized, cannot read values.");
                 return null; // Or throw error, or return default? Returning null is safest.
            }

            // Latitude
            const latSign = $('#lat-sign').val() === 'N' ? 1 : -1;
            const latDeg1 = parseInt($('#lat-deg1').val(), 10);
            const latDeg0 = parseInt($('#lat-deg0').val(), 10);
            const latFrac1 = parseInt($('#lat-frac1').val(), 10);
            const latFrac0 = parseInt($('#lat-frac0').val(), 10);
            const latitude = latSign * (latDeg1 * 10 + latDeg0 + (latFrac1 * 10 + latFrac0) / 100.0);

            // Longitude
            const lonSign = $('#lon-sign').val() === 'E' ? 1 : -1;
            const lonDeg2 = parseInt($('#lon-deg2').val(), 10);
            const lonDeg1 = parseInt($('#lon-deg1').val(), 10);
            const lonDeg0 = parseInt($('#lon-deg0').val(), 10);
            const lonFrac1 = parseInt($('#lon-frac1').val(), 10);
            const lonFrac0 = parseInt($('#lon-frac0').val(), 10);
            const longitude = lonSign * (lonDeg2 * 100 + lonDeg1 * 10 + lonDeg0 + (lonFrac1 * 10 + lonFrac0) / 100.0);

             // Validate ranges (redundant due to select limits, but good practice)
             const finalLat = Math.max(-90, Math.min(90, latitude));
             const finalLon = Math.max(-180, Math.min(180, longitude));


            log(`Read Location from UI: Lat ${finalLat.toFixed(2)}, Lon ${finalLon.toFixed(2)}`);
            return { latitude: finalLat, longitude: finalLon };
        }
        // Fetch and display a batch of project proposals
        async function fetchAndDisplayMessages(pubkey, useUmapMode = false, useN2Mode = false) {
            log(`Fetching batch of project proposals (limit ${MESSAGES_PER_PAGE}) for ${pubkey.slice(0, 10)}... ${useUmapMode ? '(UMAP mode)' : ''} ${useN2Mode ? '(N2 mode)' : ''}`);
            $('#message-section').show();
            const messageArea = $('#last-message-area').html('<i>Loading project proposals...</i>');
            const repliesList = $('#replies-list').empty().html('<li><i>Select a message...</i></li>');
            $('#older-button').prop('disabled', true);
            $('#newer-button').prop('disabled', true);
            fetchedMessages = []; // Clear previous batch
            currentMessageIndex = 0;

            let nostrPool;
            try {
                nostrPool = getNostrPool();
            } catch (e) {
                log("Failed to get Nostr pool in fetchAndDisplayMessages.");
                messageArea.html('<i>Error initializing relay pool.</i>');
                return;
            }

            try {
                let events = [];
                
                if (useUmapMode && currentLatitude !== null && currentLongitude !== null) {
                    // Mode UMAP: r√©cup√©rer les messages des UMAPs voisines
                    log("Mode UMAP activ√© - r√©cup√©ration des messages des zones voisines");
                    
                    // R√©cup√©rer les liens g√©ographiques des UMAPs
                    const geolinks = await fetchUmapGeolinks(currentLatitude, currentLongitude);
                    
                    if (geolinks) {
                        // R√©cup√©rer les messages des UMAPs voisines
                        events = await fetchUmapMessages(geolinks);
                    } else {
                        log("Impossible de r√©cup√©rer les liens UMAP, fallback vers les messages utilisateur");
                        events = await nostrPool.list(allRelaysToPublish, [{
                            kinds: [1],
                            authors: [pubkey],
                            limit: MESSAGES_PER_PAGE
                        }]);
                    }
                } else if (useN2Mode) {
                    // Mode N2: r√©cup√©rer les messages du r√©seau personnel
                    log("Mode N2 activ√© - r√©cup√©ration des messages du r√©seau personnel");
                    
                    // R√©cup√©rer le r√©seau N2 de l'utilisateur
                    const n2Data = await fetchN2Network(pubkey);
                    
                    if (n2Data) {
                        // R√©cup√©rer les messages du r√©seau N2
                        events = await fetchN2Messages(n2Data);
                    } else {
                        log("Impossible de r√©cup√©rer le r√©seau N2, fallback vers les messages utilisateur");
                        events = await nostrPool.list(allRelaysToPublish, [{
                            kinds: [1],
                            authors: [pubkey],
                            limit: MESSAGES_PER_PAGE
                        }]);
                    }
                } else {
                    // Mode normal: r√©cup√©rer les messages de l'utilisateur connect√©
                    log("Mode normal - r√©cup√©ration des messages utilisateur");
                    events = await nostrPool.list(allRelaysToPublish, [{
                        kinds: [1],
                        authors: [pubkey],
                        limit: MESSAGES_PER_PAGE
                    }]);
                }

                if (events.length > 0) {
                    log(`Fetched ${events.length} project proposals.`);
                    // Sort newest first
                    fetchedMessages = events.sort((a, b) => b.created_at - a.created_at);
                    
                    // Create slider if in UMAP or N2 mode and multiple messages
                    if ((useUmapMode || useN2Mode) && fetchedMessages.length > 1) {
                        createMessageSlider();
                    }
                    
                    displayMessageAtIndex(0); // Display the first (newest) project
                } else {
                    log('No project proposals found.');
                    messageArea.html('<i>No project proposals found.</i>');
                    $('#replies-list').empty().html('<li><i>N/A</i></li>');
                    // Keep buttons disabled
                }
            } catch (error) {
                log(`Error fetching project proposals: ${error}`);
                console.error("Fetch Project Proposals Error Details:", error);
                messageArea.html('<i>Error loading project proposals.</i>');
                $('#replies-list').empty().html('<li><i>Error loading community feedback.</i></li>');
            }
        }

        // Display message at a specific index and update controls
        function displayMessageAtIndex(index) {
             log(`Displaying project proposal at index: ${index}`);
             const messageArea = $('#last-message-area');
             const repliesList = $('#replies-list');

             if (index < 0 || index >= fetchedMessages.length) {
                 log(`Index ${index} out of bounds (0-${fetchedMessages.length - 1}).`);
                 messageArea.html(`<i>Invalid project proposal index: ${index}</i>`);
                 repliesList.empty().html('<li><i>N/A</i></li>');
                 // Update button states based on potential valid range
                 $('#newer-button').prop('disabled', fetchedMessages.length === 0 || currentMessageIndex <= 0);
                 $('#older-button').prop('disabled', fetchedMessages.length === 0 || currentMessageIndex >= fetchedMessages.length - 1);
                 return;
             }

             currentMessageIndex = index;
             const currentMessage = fetchedMessages[currentMessageIndex];
             renderMessage(messageArea, currentMessage);
             fetchAndDisplayReplies(currentMessage.id); // Fetch community feedback for the current project

             // Update navigation buttons
             $('#newer-button').prop('disabled', currentMessageIndex <= 0);
             $('#older-button').prop('disabled', currentMessageIndex >= fetchedMessages.length - 1);
             log(`Navigation updated: Newer ${$('#newer-button').prop('disabled')}, Older ${$('#older-button').prop('disabled')}`);
             
             // Update slider state if in UMAP or N2 mode
             if ((umapMode || n2Mode) && fetchedMessages.length > 1) {
                 updateSliderState();
             }
        }

        // Render a single project proposal with enhanced styling
        function renderMessage(container, event) {
            container.empty();
            
            const item = $('<div>').addClass('message-item').appendTo(container);
            
            // Create message header with profile info and like button
            const messageHeader = $('<div>').addClass('message-header').appendTo(item);
            
            // Profile section - make it clickable
            const profileSection = $('<div>').addClass('profile-section')
                .css('cursor', 'pointer')
                .attr('title', 'Click to view full profile')
                .on('click', function() {
                    const profileName = $(this).find('.profile-name').text();
                    openProfileModal(event.pubkey, profileName);
                })
                .appendTo(messageHeader);
            
            // Profile picture (placeholder for now, will be loaded)
            const profilePic = $('<div>').addClass('profile-pic-placeholder')
                .html('üë§')
                .appendTo(profileSection);
            
            // Profile info
            const profileInfo = $('<div>').addClass('profile-info').appendTo(profileSection);
            $('<div>').addClass('profile-name').text(`Author ${event.pubkey.slice(0, 8)}...`).appendTo(profileInfo);
            $('<div>').addClass('profile-pubkey').text(event.pubkey).appendTo(profileInfo);
            
            // Add clickable indicator
            $('<div>').addClass('profile-click-indicator')
                .html('üîç')
                .css({
                    'position': 'absolute',
                    'top': '5px',
                    'right': '5px',
                    'font-size': '0.8em',
                    'color': '#9C27B0',
                    'opacity': '0.7'
                })
                .appendTo(profileSection);
            
            // Like button
            const likeButton = $('<button>').addClass('heart-button').html('‚ô°')
                .attr('title', 'Like this project')
                .on('click', function() {
                    likeProject(event.id, event.pubkey, this);
                })
                .appendTo(messageHeader);
            
            // Load profile data for this author
            loadProfileForMessage(event.pubkey, profileSection);
            
            // Message content container
            const contentDiv = $('<div>').addClass('message-content').appendTo(item);
            
            // Process content with enhanced media detection and link handling
            const lines = event.content.split('\n');
            let hasMedia = false;
            
            lines.forEach((line, i) => {
                const trimmed = line.trim();
                
                // Enhanced media detection
                if (/\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)$/i.test(trimmed)) {
                    hasMedia = true;
                    const mediaContainer = $('<div>').addClass('media-container').appendTo(contentDiv);
                    $('<img>').attr('src', trimmed)
                        .addClass('message-image')
                        .attr('alt', 'Project image')
                        .on('click', function() {
                            openImageModal(trimmed);
                        })
                        .appendTo(mediaContainer);
                    $('<a>').attr({href: trimmed, target: '_blank'})
                        .addClass('media-link')
                        .text(trimmed)
                        .appendTo(mediaContainer);
                } else if (/\.(mp4|webm|ogg|mov|avi|mkv)$/i.test(trimmed)) {
                    hasMedia = true;
                    const mediaContainer = $('<div>').addClass('media-container').appendTo(contentDiv);
                    const video = $('<video>').addClass('message-video')
                        .attr('controls', true)
                        .attr('preload', 'metadata')
                        .on('click', function() {
                            openMediaModal(window.mediaCollection.length);
                        })
                        .appendTo(mediaContainer);
                    $('<source>').attr('src', trimmed).appendTo(video);
                    $('<a>').attr({href: trimmed, target: '_blank'})
                        .addClass('media-link')
                        .text(trimmed)
                        .appendTo(mediaContainer);
                } else if (/\.(mp3|wav|ogg|flac|aac|m4a)$/i.test(trimmed)) {
                    hasMedia = true;
                    const mediaContainer = $('<div>').addClass('media-container').appendTo(contentDiv);
                    const audio = $('<audio>').addClass('message-audio')
                        .attr('controls', true)
                        .attr('preload', 'metadata')
                        .on('click', function() {
                            openMediaModal(window.mediaCollection.length);
                        })
                        .appendTo(mediaContainer);
                    $('<a>').attr({href: trimmed, target: '_blank'})
                        .addClass('media-link')
                        .text(trimmed)
                        .appendTo(mediaContainer);
                } else if (/^https?:\/\//.test(trimmed)) {
                    $('<a>').attr({href: trimmed, target: '_blank'})
                        .text(trimmed)
                        .appendTo(contentDiv);
                } else {
                    contentDiv.append(document.createTextNode(line));
                }
                
                if (i < lines.length - 1) contentDiv.append('<br>');
            });
            
            // Enhanced metadata footer
            const metadataDiv = $('<div>').addClass('message-metadata').appendTo(item);
            const date = new Date(event.created_at * 1000);
            const projectNumber = currentMessageIndex + 1;
            const totalProjects = fetchedMessages.length;
            
            metadataDiv.html(`
                <span class="project-counter">üå± Project ${projectNumber}/${totalProjects}</span> ‚Ä¢ 
                <span class="project-id">ID: ${event.id.slice(0,10)}...</span> ‚Ä¢ 
                <span class="project-date">üìÖ ${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
            `);
        }

        // Fetch and display community feedback
        async function fetchAndDisplayReplies(eventId) {
            log(`Fetching community feedback for project ${eventId.slice(0, 10)}...`);
            const list = $('#replies-list').empty().html('<li><i>Loading community feedback...</i></li>');
            
            if (!eventId) {
                list.html('<li><i>No parent ID.</i></li>');
                return;
            }
            
            let nostrPool;
            try {
                nostrPool = getNostrPool();
            } catch (e) {
                log("Pool fail in fetchReplies.");
                list.html('<li><i>Relay pool error.</i></li>');
                return;
            }
            
            try {
                log("Pool object before list call in fetchReplies:", nostrPool);
                console.dir(nostrPool);
                const replies = await nostrPool.list(allRelaysToPublish, [{ kinds: [1], '#e': [eventId], limit: 20 }]);
                
                if (replies.length > 0) {
                    log(`Found ${replies.length} community feedback items.`);
                    list.empty();
                    replies.sort((a, b) => a.created_at - b.created_at).forEach(r => renderReply(list, r));
                } else {
                    log('No community feedback found.');
                    list.html('<li><i>No community feedback yet.</i></li>');
                }
            } catch (e) {
                log(`Error fetching community feedback: ${e}`);
                list.html('<li><i>Error loading community feedback.</i></li>');
            }
        }

        // Render a single community feedback with enhanced styling
        function renderReply(list, event) {
            const item = $('<li>').addClass('reply-item').appendTo(list);
            
            // Author info with enhanced styling - make it clickable
            const authorP = $('<p>').addClass('reply-author')
                .css('cursor', 'pointer')
                .attr('title', 'Click to view full profile')
                .on('click', function() {
                    openProfileModal(event.pubkey, `Author ${event.pubkey.slice(0, 8)}...`);
                })
                .appendTo(item);
            authorP.append('üí¨ Feedback by: ');
            $('<code>').text(event.pubkey.slice(0, 10) + '...').appendTo(authorP);
            authorP.append(` üìÖ ${new Date(event.created_at * 1000).toLocaleDateString()} ${new Date(event.created_at * 1000).toLocaleTimeString()}`);
            
            // Content with enhanced media handling
            const contentDiv = $('<div>').addClass('reply-content').appendTo(item);
            const lines = event.content.split('\n');
            
            lines.forEach((line, i) => {
                const trimmed = line.trim();
                
                // Enhanced media detection
                if (/\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)$/i.test(trimmed)) {
                    const mediaContainer = $('<div>').addClass('media-container').appendTo(contentDiv);
                    $('<img>').attr('src', trimmed)
                        .addClass('message-image')
                        .attr('alt', 'Reply image')
                        .on('click', function() {
                            openImageModal(trimmed);
                        })
                        .appendTo(mediaContainer);
                    $('<a>').attr({href: trimmed, target: '_blank'})
                        .addClass('media-link')
                        .text(trimmed)
                        .appendTo(mediaContainer);
                } else if (/^https?:\/\//.test(trimmed)) {
                    $('<a>').attr({href: trimmed, target: '_blank'})
                        .text(trimmed)
                        .appendTo(contentDiv);
                } else {
                    contentDiv.append(document.createTextNode(line));
                }
                
                if (i < lines.length - 1) contentDiv.append('<br>');
            });
        }

        // checkNostrExtension, connectToNostr
        function checkNostrExtension() { log('Checking extension...'); if (typeof window.nostr !== 'undefined') { nostrExtensionAvailable = true; log('Extension OK.'); $('#connectButton').prop('disabled', false).text('Connect'); updateStatus('Extension ready.'); } else { nostrExtensionAvailable = false; log('Extension fail.'); $('#connectButton').prop('disabled', true).text('Extension Needed'); updateStatus('Extension not found or NSEC needed.', true); } }
        async function connectToNostr() { 
            if (!nostrExtensionAvailable) return; 
            log('Connecting via extension...'); 
            updateStatus('Connecting extension...'); 
            $('#connectButton').prop('disabled', true); 
            try { 
                publicKey = await window.nostr.getPublicKey(); 
                log(`Ext connected. Pubkey: ${publicKey.slice(0, 10)}...`); 
                $('#connectButton').hide(); 
                $('#postButton').prop('disabled', false); 
                updateStatus(`Ext Connected! ${publicKey.slice(0, 10)}...`, false, true); 
                
                // Mettre √† jour la liste des relais bas√©e sur l'architecture de domaine
                updateRelayListFromDomain();
                
                await fetchProfileAndRelays(publicKey); 
                await fetchAndDisplayMessages(publicKey, umapMode, n2Mode); 
            } catch (e) { 
                log(`Ext connection fail: ${e.message || e}`); 
                updateStatus(`Ext connect failed.`, true); 
                $('#connectButton').prop('disabled', false).show(); 
                publicKey = ''; 
            } 
        }

        // handleImageSelection, getLocation, uploadImageNip96, publishToRelay
        function handleImageSelection(event) { const f = event.target.files[0]; if (f) { log(`Image selected: ${f.name}, size: ${f.size}`); const r = new FileReader(); r.onload = (e) => { selectedImageDataUrl = e.target.result; $('#imagePreview').attr('src', selectedImageDataUrl).show(); log('Preview updated.'); }; r.onerror = (e) => { log(`File read error: ${e}`); updateStatus('Error reading image.', true); selectedImageDataUrl = null; $('#imagePreview').hide().attr('src', '#'); }; r.readAsDataURL(f); } else { log('No image selected.'); selectedImageDataUrl = null; $('#imagePreview').hide().attr('src', '#'); } }
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    const m = "Geolocation unsupported.";
                    log(m);
                    updateStatus(m, true);
                    return reject(m);
                }
                log('Requesting location...');
                updateStatus('Getting location...');
                navigator.geolocation.getCurrentPosition(
                    (p) => {
                        currentLatitude = p.coords.latitude;
                        currentLongitude = p.coords.longitude;
                        log(`Location: Lat ${currentLatitude.toFixed(6)}, Lon ${currentLongitude.toFixed(6)}`);
                        // updateStatus(`Location: ${currentLatitude.toFixed(2)}, ${currentLongitude.toFixed(2)}`); // Replaced by updateLocationUI status
                        updateLocationUI(currentLatitude, currentLongitude);
                        resolve({ latitude: currentLatitude, longitude: currentLongitude });
                    },
                    (e) => {
                        log(`Location error: ${e.message} (Code: ${e.code})`);
                        const m = ["Permission denied.", "Position unavailable.", "Timeout."][e.code-1] || "Location error.";
                        updateStatus(m, true); // Keep general status update
                        updateLocationUI(null, null);
                        reject(m);
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
                );
            });
        }

        function uploadImageNip96(imageDataBase64) { return new Promise(async (resolve, reject) => { log("NIP-96 Upload start..."); const server = 'https://g1sms.fr'; const wk = `${server}/.well-known/nostr/nip96.json`; try { const cfg = await $.ajax({ url: wk, dataType: 'json' }); const ep = cfg.api_url; if (!ep) throw new Error("No api_url"); log(`NIP-96 EP: ${ep}`); const bs = atob(imageDataBase64.split(',')[1]); const mime = imageDataBase64.split(',')[0].split(':')[1].split(';')[0]; const ab = new ArrayBuffer(bs.length); const ia = new Uint8Array(ab); for (let i=0; i<bs.length; i++) ia[i]=bs.charCodeAt(i); const blob = new Blob([ab],{type:mime}); const file = new File([blob],`mobile-${Date.now()}.png`,{type:mime}); const fd = new FormData(); fd.append('file', file); log(`Uploading to ${ep}...`); const r = await $.ajax({ url: ep, type: 'POST', data: fd, processData: false, contentType: false }); log("NIP-96 Resp:", r); if (r?.status === "success" && r.nip94_event?.tags) { const ut = r.nip94_event.tags.find(t => t[0] === 'url'); const url = ut?.[1]; const tags = r.nip94_event.tags; const size = r.fileSize; if (url) { log(`Upload OK: ${url}, Size: ${size||'N/A'}`); resolve({ uploadedFileURL: url, nip94Tags: tags, fileSize: size }); } else throw new Error("No URL tag."); } else throw new Error(r?.message || "Invalid NIP-96 response."); } catch (e) { let m = e?.message || 'Unknown upload error'; if (e?.responseJSON?.message) m = e.responseJSON.message; else if (e?.statusText) m = `HTTP ${e.status}: ${e.statusText}`; log(`NIP-96 Err: ${m}`); console.error("NIP-96 Details:", e); reject(`Upload fail: ${m}`); } }); }
        async function publishToRelay(relayUrl, signedEvent) { return new Promise((resolve) => { log(`Publish to ${relayUrl}`); let ws = null; let timer = null; try { ws = new WebSocket(relayUrl); const close = (ok, msg) => { clearTimeout(timer); if (ws?.readyState === WebSocket.OPEN) ws.close(); log(msg); resolve(ok); }; ws.onopen = () => { log(`Connected ${relayUrl}. Send.`); ws.send(JSON.stringify(['EVENT', signedEvent])); timer = setTimeout(() => close(true, `Sent ${relayUrl}, no OK/Notice.`), 3000); }; ws.onmessage = (ev) => { try { const m = JSON.parse(ev.data); if (m[0]==='OK' && m[1]===signedEvent.id) close(true, `OK ${relayUrl}: ${m[1].slice(0,8)}...`); else if (m[0]==='NOTICE') { log(`NOTICE ${relayUrl}: ${m[1]}`); clearTimeout(timer); timer = setTimeout(() => close(true, `NOTICE ${relayUrl}, closing.`), 500); } } catch (e) { log(`Msg parse err ${relayUrl}: ${e.message}`); } }; ws.onerror = (e) => close(false, `Error ${relayUrl}: ${e.message || 'Unknown'}`); ws.onclose = (e) => { log(`Closed ${relayUrl}. Code: ${e.code}`); if (timer) { clearTimeout(timer); resolve(false); } }; timer = setTimeout(() => close(false, `Timeout ${relayUrl}`), 7000); } catch (e) { log(`Connect err ${relayUrl}: ${e.message}`); resolve(false); } }); }

        // postNostrEvent
        async function postNostrEvent() {
            if (!publicKey) { updateStatus("Not connected.", true); return; }
            const msg = $('#message').val().trim();
            if (!msg && !selectedImageDataUrl) { updateStatus("Need project description or image.", true); return; }

            showLoading(true);
            updateStatus("Reading location from UI...");

            const adjustedLocation = readLocationFromUI();

            // Check if location is available from UI
            if (!adjustedLocation) {
                updateStatus("Location not available or not set. Cannot post.", true);
                log("Post aborted: Location UI did not provide valid coordinates.");
                showLoading(false);
                return; // Stop posting if location isn't set in the UI
            }

            const lat = adjustedLocation.latitude.toFixed(2); // Use adjusted value
            const lon = adjustedLocation.longitude.toFixed(2); // Use adjusted value

            updateStatus("Preparing project proposal...");
            log(`Using adjusted location: Lat ${lat}, Lon ${lon}`);

            try {
                // The rest of the function remains largely the same,
                // but uses the lat/lon derived from readLocationFromUI()

                let content = msg;
                let tags = [
                    ['application', 'UPlanet'],
                    ['latitude', lat],      // Use adjusted lat
                    ['longitude', lon],     // Use adjusted lon
                    ['g', `${adjustedLocation.latitude.toFixed(6)};${adjustedLocation.longitude.toFixed(6)}`] // Use higher precision 'g' tag if desired
                    // Consider adding ['geohash', geohashValue] if you implement geohashing
                ];

                if (selectedImageDataUrl) {
                    updateStatus("Uploading image...");
                    try {
                        const up = await uploadImageNip96(selectedImageDataUrl);
                        content += `\n${up.uploadedFileURL}`;
                        if (up.nip94Tags) tags = tags.concat(up.nip94Tags.filter(t => Array.isArray(t) && t.length >= 2));
                        if (up.fileSize != null) tags.push(['fileSize', String(up.fileSize)]);
                        updateStatus("Image uploaded.", false, true);
                    } catch (e) {
                        updateStatus(`Upload failed: ${e}. Posting text only.`, true);
                        // Continue without image, location is still set
                    }
                }

                const event = { kind: 1, pubkey: publicKey, created_at: Math.floor(Date.now() / 1000), tags: tags, content: content };
                log("Unsigned event:"); console.log(JSON.stringify(event, null, 2));

                let signedEvent = null;

                if (privateKeyHex) {
                    log("Attempting local signing with NSEC..."); // More specific log
                    try {
                        if (typeof NostrTools === 'undefined' || typeof NostrTools.getEventHash !== 'function' || typeof NostrTools.getSignature !== 'function') {
                            throw new Error("NostrTools crypto functions missing or not loaded!");
                        }
                        // It's generally safer to work with a copy if you modify it,
                        // but in this case, modifying the original 'event' and assigning it works.
                        // Let's stick to the original method but add checks.
                        event.id = NostrTools.getEventHash(event);
                        if (!event.id) throw new Error("Failed to generate event hash.");

                        event.sig = NostrTools.getSignature(event, privateKeyHex);
                         if (!event.sig) throw new Error("Failed to generate signature.");

                        signedEvent = event; // Assign the fully signed event object

                        if (!signedEvent || !signedEvent.id || !signedEvent.sig) {
                            // Double-check after assignment
                            throw new Error("Signed event object is incomplete after signing.");
                        }

                        log(`Signed locally. ID: ${signedEvent.id}`);
                        updateStatus("Signed. Publishing project proposal...");

                    } catch (signError) {
                        log(`Local signing error: ${signError.message}`);
                        console.error("Local Signing Error Details:", signError);
                        updateStatus(`Local signing error: ${signError.message}`, true);
                        showLoading(false); // Stop loading
                        return; // Exit the function, don't proceed to publish
                    }

                } else if (window.nostr) {
                    updateStatus("Confirm in extension...");
                    log("Requesting signature via extension...");
                    try {
                         signedEvent = await window.nostr.signEvent(event);
                         if (!signedEvent || !signedEvent.id || !signedEvent.sig) {
                             throw new Error("Extension returned incomplete signed event.");
                         }
                         log(`Signed via extension. ID: ${signedEvent.id}`);
                         updateStatus("Signed. Publishing project proposal...");
                    } catch (extSignError) {
                        log(`Extension signing error: ${extSignError.message}`);
                        console.error("Extension Signing Error Details:", extSignError);
                        updateStatus(`Extension signing error: ${extSignError.message}`, true);
                        showLoading(false); // Stop loading
                        $('#connectButton').prop('disabled', false).show(); // Re-enable connect button maybe?
                        return; // Exit the function
                    }
                } else {
                     // This case should ideally not be reached if init logic is correct
                    log("Error: Cannot sign event - No private key and no extension available.");
                    updateStatus("Cannot sign event: No key/extension.", true);
                    showLoading(false);
                    return; // Exit
                    // Old: throw new Error("Cannot sign.");
                }

                // --- Crucial Check ---
                if (!signedEvent) {
                    log("Error: signedEvent is null or undefined before publishing. Aborting.");
                    updateStatus("Failed to prepare event for publishing.", true);
                    showLoading(false);
                    return; // Exit explicitly if signing failed somehow
                }
                // --- End Crucial Check ---
                log(`Publishing project proposal to ${allRelaysToPublish.length} relays...`);
                updateRelayListUI();
                let success = 0;
                const results = await Promise.all(allRelaysToPublish.map(r => publishToRelay(r, signedEvent)));
                success = results.filter(Boolean).length;
                log(`Published. Success: ${success}/${allRelaysToPublish.length}`);

                if (success > 0) {
                    updateStatus(`Project proposal published to ${success}/${allRelaysToPublish.length}. ID: ${signedEvent.id.slice(0,10)}...`, false, true);
                    $('#message').val('');
                    $('#imageInput').val('');
                    $('#imagePreview').hide().attr('src', '#');
                    selectedImageDataUrl = null;
                    log("Scheduling project proposals refresh...");
                    setTimeout(() => { log("Refreshing project proposals..."); fetchAndDisplayMessages(publicKey, umapMode, n2Mode); }, 4000);
                } else {
                    updateStatus(`Failed to publish project proposal to any relays.`, true);
                }
            } catch (e) {
                log(`Post error: ${e?.message || e}`); console.error("Post Details:", e);
                updateStatus(`Error: ${e?.message || 'Unknown error'}`, true);
            } finally {
                showLoading(false);
            }
        }
        // --- UMAP Geolinks Functions ---
        async function fetchUmapGeolinks(lat, lon) {
            try {
                log(`Fetching UMAP geolinks for coordinates: (${lat}, ${lon})`);
                updateStatus("R√©cup√©ration des UMAPs voisines...");
                
                const response = await fetch(`/api/umap/geolinks?lat=${lat}&lon=${lon}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "Erreur lors de la r√©cup√©ration des liens UMAP");
                }
                
                log(`UMAP geolinks r√©cup√©r√©s: ${data.total_adjacent} UMAPs adjacentes`);
                updateStatus(`UMAPs voisines r√©cup√©r√©es: ${data.total_adjacent} zones`, false, true);
                
                return data.geolinks;
                
            } catch (error) {
                log(`Erreur lors de la r√©cup√©ration des liens UMAP: ${error.message}`);
                updateStatus(`Erreur liens UMAP: ${error.message}`, true);
                return null;
            }
        }

        async function fetchUmapMessages(geolinks) {
            if (!geolinks) {
                log("Impossible de r√©cup√©rer les messages UMAP: geolinks manquant");
                return [];
            }
            
            let nostrPool;
            try {
                nostrPool = getNostrPool();
            } catch (e) {
                log("Impossible d'obtenir le pool NOSTR pour les messages UMAP");
                return [];
            }
            
            try {
                log("R√©cup√©ration des messages des UMAPs voisines...");
                updateStatus("R√©cup√©ration des messages des zones voisines...");
                
                // Extraire toutes les cl√©s hex des UMAPs (exclure 'here' si n√©cessaire)
                const umapKeys = Object.values(geolinks).filter(key => key && key.length === 64);
                
                if (umapKeys.length === 0) {
                    log("Aucune cl√© UMAP valide trouv√©e");
                    return [];
                }
                
                log(`R√©cup√©ration des messages de ${umapKeys.length} UMAPs`);
                
                // R√©cup√©rer les messages de toutes les UMAPs en parall√®le
                const events = await nostrPool.list(allRelaysToPublish, [{
                    kinds: [1],
                    authors: umapKeys,
                    limit: 50  // Limite par UMAP
                }]);
                
                if (events.length > 0) {
                    log(`R√©cup√©r√© ${events.length} messages des UMAPs voisines`);
                    updateStatus(`${events.length} messages r√©cup√©r√©s des zones voisines`, false, true);
                    
                    // Trier par date (plus r√©cent en premier)
                    return events.sort((a, b) => b.created_at - a.created_at);
                } else {
                    log("Aucun message trouv√© dans les UMAPs voisines");
                    updateStatus("Aucun message dans les zones voisines", false, true);
                    return [];
                }
                
            } catch (error) {
                log(`Erreur lors de la r√©cup√©ration des messages UMAP: ${error.message}`);
                updateStatus(`Erreur messages UMAP: ${error.message}`, true);
                return [];
            }
        }

        // --- Like Project Function ---
        async function likeProject(messageId, authorPubkey, heartButton) {
            const nostr = getNostrExtension();
            if (!nostr) {
                alert("Nostr extension (NOSTR Connect, Alby, nos2x) not detected.");
                return;
            }

            try {
                // Show loading state
                heartButton.classList.add('loading');
                const originalContent = heartButton.innerHTML;
                heartButton.innerHTML = '‚ô°';
                heartButton.disabled = true;

                const userPublicKey = await nostr.getPublicKey();
                const relayUrl = await getRelayURL();

                // Create like event (kind 7 - reaction)
                const likeEvent = {
                    kind: 7,
                    pubkey: userPublicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ["e", messageId], // Reference to the liked event
                        ["p", authorPubkey] // Reference to the author's pubkey
                    ],
                    content: "‚ô•" // The reaction content
                };

                const signedEvent = await nostr.signEvent(likeEvent);
                const relay = nostrTools.relayInit(relayUrl);
                await relay.connect();
                await relay.publish(signedEvent);
                relay.close();

                // Success state
                heartButton.classList.remove('loading');
                heartButton.classList.add('liked');
                heartButton.innerHTML = '‚ô•';
                heartButton.title = 'Liked!';
                
                // Keep the liked state - don't reset
                heartButton.disabled = false;

            } catch (error) {
                console.error("Error during like action:", error);
                
                // Error state
                heartButton.classList.remove('loading');
                heartButton.innerHTML = originalContent;
                heartButton.disabled = false;
                
                alert(`Error liking project: ${error.message || error}`);
            }
        }

        // --- Image Modal Functions ---
        function openImageModal(imageUrl) {
            // Create modal if it doesn't exist
            let modal = document.getElementById('imageModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'imageModal';
                modal.className = 'image-modal';
                modal.innerHTML = `
                    <div class="image-modal-content">
                        <span class="image-modal-close">&times;</span>
                        <img id="modalImage" src="" alt="Full size image" onerror="this.style.display='none'; this.parentElement.innerHTML='<p style=\'color: white; text-align: center; padding: 20px;\'>Failed to load image</p>'">
                    </div>
                `;
                document.body.appendChild(modal);
                
                // Close modal on click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal || e.target.className === 'image-modal-close') {
                        modal.style.display = 'none';
                    }
                });
                
                // Close modal on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && modal.style.display === 'flex') {
                        modal.style.display = 'none';
                    }
                });
            }
            
            // Show image in modal
            const modalImage = document.getElementById('modalImage');
            modalImage.style.display = 'block';
            modalImage.src = imageUrl;
            modal.style.display = 'flex';
            
            // Add loading state
            modalImage.onload = function() {
                this.style.opacity = '1';
            };
            modalImage.onerror = function() {
                this.style.display = 'none';
                this.parentElement.innerHTML = '<p style="color: white; text-align: center; padding: 20px;">Failed to load image</p>';
            };
            modalImage.style.opacity = '0.7';
        }

        function openMediaModal(mediaIndex) {
            // Simple media modal for now - can be enhanced later
            const media = window.mediaCollection[mediaIndex];
            if (media) {
                openImageModal(media.url);
            }
        }

        // --- Profile Loading Function ---
        async function loadProfileForMessage(pubkey, profileSection) {
            try {
                const nostrPool = getNostrPool();
                const profileEvents = await nostrPool.list(allRelaysToPublish, [
                    { kinds: [0], authors: [pubkey], limit: 1 }
                ]);
                
                if (profileEvents.length > 0) {
                    const profileEvent = profileEvents[0];
                    let profileData = {};
                    
                    try {
                        profileData = JSON.parse(profileEvent.content);
                    } catch (e) {
                        console.log('Profile parse error:', e);
                    }
                    
                    // Update profile section
                    const profilePic = profileSection.find('.profile-pic-placeholder');
                    const profileInfo = profileSection.find('.profile-info');
                    const profileName = profileInfo.find('.profile-name');
                    const profilePubkey = profileInfo.find('.profile-pubkey');
                    
                    // Update profile picture
                    if (profileData.picture) {
                        profilePic.html(`<img src="${profileData.picture}" alt="Profile" onerror="this.parentElement.innerHTML='üë§'">`);
                    }
                    
                    // Update profile name
                    const displayName = profileData.display_name || profileData.name || `Author ${pubkey.slice(0, 8)}...`;
                    profileName.text(displayName);
                    
                    // Update pubkey (shortened)
                    profilePubkey.text(`${pubkey.slice(0, 8)}...${pubkey.slice(-8)}`);
                    
                }
            } catch (error) {
                console.log('Error loading profile for message:', error);
            }
        }

        // --- Slider Navigation Functions ---
        function createMessageSlider() {
            const sliderContainer = $('#message-section');
            
            // Remove existing slider if any
            sliderContainer.find('.message-slider').remove();
            
            if (fetchedMessages.length <= 1) {
                return; // No need for slider with 1 or 0 messages
            }
            
            const slider = $('<div>').addClass('message-slider').appendTo(sliderContainer);
            
            // Slider header with dynamic title based on mode
            const sliderHeader = $('<div>').addClass('slider-header').appendTo(slider);
            let sliderTitle = 'üåç UMAP Projects';
            if (n2Mode) {
                sliderTitle = 'üåê N2 Network Projects';
            } else if (umapMode) {
                sliderTitle = 'üåç UMAP Projects';
            }
            $('<h3>').text(sliderTitle).appendTo(sliderHeader);
            
            // Slider controls
            const sliderControls = $('<div>').addClass('slider-controls').appendTo(slider);
            
            const prevBtn = $('<button>').addClass('slider-btn prev-btn')
                .html('‚Äπ')
                .on('click', () => navigateSlider(-1))
                .appendTo(sliderControls);
            
            const nextBtn = $('<button>').addClass('slider-btn next-btn')
                .html('‚Ä∫')
                .on('click', () => navigateSlider(1))
                .appendTo(sliderControls);
            
            // Slider indicators
            const indicators = $('<div>').addClass('slider-indicators').appendTo(slider);
            
            fetchedMessages.forEach((_, index) => {
                const indicator = $('<button>').addClass('slider-indicator')
                    .html('‚óè')
                    .on('click', () => goToSliderIndex(index))
                    .appendTo(indicators);
            });
            
            // Update slider state
            updateSliderState();
        }
        
        function updateSliderState() {
            const slider = $('.message-slider');
            if (slider.length === 0) return;
            
            const prevBtn = slider.find('.prev-btn');
            const nextBtn = slider.find('.next-btn');
            const indicators = slider.find('.slider-indicator');
            
            // Update button states
            prevBtn.prop('disabled', currentMessageIndex <= 0);
            nextBtn.prop('disabled', currentMessageIndex >= fetchedMessages.length - 1);
            
            // Update indicators
            indicators.removeClass('active');
            indicators.eq(currentMessageIndex).addClass('active');
            
            // Update slider info
            const info = slider.find('.slider-info');
            if (info.length === 0) {
                $('<div>').addClass('slider-info')
                    .html(`<span>${currentMessageIndex + 1} / ${fetchedMessages.length}</span>`)
                    .appendTo(slider.find('.slider-header'));
            } else {
                info.html(`<span>${currentMessageIndex + 1} / ${fetchedMessages.length}</span>`);
            }
        }
        
        function navigateSlider(direction) {
            const newIndex = currentMessageIndex + direction;
            if (newIndex >= 0 && newIndex < fetchedMessages.length) {
                displayMessageAtIndex(newIndex);
                updateSliderState();
            }
        }
        
        function goToSliderIndex(index) {
            if (index >= 0 && index < fetchedMessages.length) {
                displayMessageAtIndex(index);
                updateSliderState();
            }
        }

        // --- Mode Toggle Functions ---
        function toggleUmapMode() {
            umapMode = !umapMode;
            n2Mode = false; // Disable N2 mode when enabling UMAP mode
            const umapButton = $('#mode-toggle');
            const n2Button = $('#n2-mode-toggle');
            
            if (umapMode) {
                umapButton.text('üë§ Mode Utilisateur').css('background', 'linear-gradient(145deg, #FF9800, #F57C00)');
                n2Button.text('üåê Mode N2 (R√©seau personnel)').css('background', 'linear-gradient(145deg, #9C27B0, #7B1FA2)');
                log("Mode UMAP activ√© - affichage des messages des zones voisines");
                updateStatus("Mode UMAP activ√© - zones voisines", false, true);
            } else {
                umapButton.text('üåç Mode UMAP (Zones voisines)').css('background', 'linear-gradient(145deg, #2196F3, #1976D2)');
                log("Mode utilisateur activ√© - affichage des messages personnels");
                updateStatus("Mode utilisateur activ√©", false, true);
                
                // Remove slider when switching to user mode
                $('.message-slider').remove();
            }
            
            // Recharger les messages avec le nouveau mode
            if (publicKey) {
                fetchAndDisplayMessages(publicKey, umapMode, n2Mode);
            }
        }

        function toggleN2Mode() {
            n2Mode = !n2Mode;
            umapMode = false; // Disable UMAP mode when enabling N2 mode
            const umapButton = $('#mode-toggle');
            const n2Button = $('#n2-mode-toggle');
            
            if (n2Mode) {
                n2Button.text('üë§ Mode Utilisateur').css('background', 'linear-gradient(145deg, #FF9800, #F57C00)');
                umapButton.text('üåç Mode UMAP (Zones voisines)').css('background', 'linear-gradient(145deg, #2196F3, #1976D2)');
                log("Mode N2 activ√© - affichage des messages du r√©seau personnel");
                updateStatus("Mode N2 activ√© - r√©seau personnel", false, true);
            } else {
                n2Button.text('üåê Mode N2 (R√©seau personnel)').css('background', 'linear-gradient(145deg, #9C27B0, #7B1FA2)');
                log("Mode utilisateur activ√© - affichage des messages personnels");
                updateStatus("Mode utilisateur activ√©", false, true);
                
                // Remove slider when switching to user mode
                $('.message-slider').remove();
            }
            
            // Recharger les messages avec le nouveau mode
            if (publicKey) {
                fetchAndDisplayMessages(publicKey, umapMode, n2Mode);
            }
        }

        // --- Initialization ---
        async function initializeApp() {
            log('initializeApp called.');
            
            // Mettre √† jour la liste des relais bas√©e sur l'architecture de domaine
            updateRelayListFromDomain();
            
            if (userNsec) {
                log("NSEC provided. Init local key.");
                 if (typeof NostrTools === 'undefined') { updateStatus("Error: NostrTools unloaded.", true); log("Fatal: NostrTools missing."); return; }
                try {
                    const decoded = NostrTools.nip19.decode(userNsec);
                    if (decoded.type !== 'nsec' || !decoded.data) throw new Error('Invalid NSEC format');
                    privateKeyHex = decoded.data; publicKey = NostrTools.getPublicKey(privateKeyHex);
                    log(`Init NSEC OK. Pubkey: ${publicKey.slice(0, 10)}...`); updateStatus(`Using NSEC key. Pubkey: ${publicKey.slice(0, 10)}...`, false, true);
                    $('#connectButton').hide(); $('#postButton').prop('disabled', false);
                    await fetchProfileAndRelays(publicKey);
                    await fetchAndDisplayMessages(publicKey, umapMode, n2Mode); // Fetch initial batch with current mode
                } catch (e) {
                    log(`Error initializing NSEC: ${e.message}. Falling back.`); updateStatus('Error NSEC. Trying extension...', true);
                    privateKeyHex = null; publicKey = '';
                    updateStatus("Checking extension (fallback)...");
                    setTimeout(() => { log("Executing delayed check (fallback)."); checkNostrExtension(); }, 500);
                }
            } else {
                log("No NSEC. Scheduling extension check..."); updateStatus("Checking extension...");
                setTimeout(() => { log("Executing delayed check."); checkNostrExtension(); }, 500);
            }
            updateRelayListUI();
        }

        $(document).ready(function() {
            log('Document ready.');

            // Add tag button click handlers
            $('.tag-button').on('click', function() {
                const tag = $(this).data('tag');
                const textarea = $('#message');
                const currentText = textarea.val();
                
                // Toggle the tag
                if (currentText.includes(tag)) {
                    // Remove the tag if it exists
                    textarea.val(currentText.replace(tag + ' ', '').replace(' ' + tag, ''));
                    $(this).removeClass('active');
                } else {
                    // Add the tag if it doesn't exist
                    textarea.val(currentText + (currentText ? ' ' : '') + tag + ' ');
                    $(this).addClass('active');
                }
            });

            // Check for existing tags when textarea changes
            $('#message').on('input', function() {
                const text = $(this).val();
                $('.tag-button').each(function() {
                    const tag = $(this).data('tag');
                    const isActive = text.includes(tag);
                    $(this).toggleClass('active', isActive);
                });
            });

            initializeLocationSelects();

            log("Requesting initial location for UI...");
            getLocation().catch(err => {
                log(`Initial getLocation failed: ${err}. UI will show defaults/error state.`);
            });

            // Setup common event listeners immediately
            $('#connectButton').on('click', connectToNostr);
            $('#imageInput').on('change', handleImageSelection);
            $('#postButton').on('click', postNostrEvent);
            $('#mode-toggle').on('click', toggleUmapMode);
            $('#n2-mode-toggle').on('click', toggleN2Mode);
            
            // Map accordion event listeners
            $('#location-status').on('click', toggleMapAccordion);
            $('#update-map').on('click', function() {
                const lat = parseFloat($('#lat-display').val()) || 0;
                const lon = parseFloat($('#lon-display').val()) || 0;
                
                updateCoordinatesFromMap(lat, lon);
                if (miniMap) {
                    miniMap.setView([lat, lon], miniMap.getZoom());
                }
            });
            $('#get-location').on('click', getCurrentLocationForMap);
            
            // Profile modal event listeners
            $(document).on('click', '.profile-modal-close', closeProfileModal);
            $(document).on('click', '#profileModal', function(e) {
                if (e.target === this) {
                    closeProfileModal();
                }
            });
            
            // Close profile modal on escape key
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && $('#profileModal').is(':visible')) {
                    closeProfileModal();
                }
            });

            $('#refresh-button').on('click', () => {
                if (publicKey) {
                    log("Refresh button clicked.");
                    updateStatus("Refreshing project proposals...");
                    fetchAndDisplayMessages(publicKey, umapMode, n2Mode);
                } else {
                    log("Refresh clicked, but no public key.");
                    updateStatus("Please connect first.", true);
                }
            });

            $('#older-button').on('click', () => {
                log("Older button clicked.");
                                 if (currentMessageIndex < fetchedMessages.length - 1) {
                     displayMessageAtIndex(currentMessageIndex + 1);
                 } else {
                     log("Already at the oldest fetched project proposal.");
                 }
            });
            $('#newer-button').on('click', () => {
                 log("Newer button clicked.");
                 if (currentMessageIndex > 0) {
                     displayMessageAtIndex(currentMessageIndex - 1);
                 } else {
                     log("Already at the newest fetched project proposal.");
                 }
            });
            $('#debug-info').hide(); $('details summary').on('click', () => setTimeout(() => log(`Debug visibility: ${$('#debug-info').is(':visible')}`), 0));

            // --- Conditional Initialization ---
            if (userNsec) {
                log("NSEC configured. Waiting for NostrTools..."); updateStatus("Loading crypto library...");
                let attempts = 0; const maxAttempts = 50; const intervalId = setInterval(() => { attempts++; if (typeof NostrTools !== 'undefined') { clearInterval(intervalId); log("NostrTools library loaded."); initializeApp(); } else if (attempts >= maxAttempts) { clearInterval(intervalId); log("Error: NostrTools timeout."); updateStatus("Error loading crypto library.", true); } else { /* log(`Waiting NostrTools... (${attempts})`); */ } }, 100);
            } else {
                log("No NSEC configured. Initializing normally."); initializeApp();
            }
        });

        // Map variables
        let miniMap;
        let miniMarker;

        // Initialize mini map
        function initializeMiniMap(lat = 0, lon = 0) {
            if (miniMap) {
                miniMap.remove();
            }
            
            miniMap = L.map('mini-map').setView([lat, lon], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(miniMap);

            // Add marker
            miniMarker = L.marker([lat, lon], {
                draggable: true
            }).addTo(miniMap);

            // Handle map click
            miniMap.on('click', function(e) {
                const clickedLat = Math.round(e.latlng.lat * 100) / 100;
                const clickedLon = Math.round(e.latlng.lng * 100) / 100;
                updateCoordinatesFromMap(clickedLat, clickedLon);
            });

            // Handle marker drag
            miniMarker.on('dragend', function(e) {
                const markerLat = Math.round(e.target.getLatLng().lat * 100) / 100;
                const markerLon = Math.round(e.target.getLatLng().lng * 100) / 100;
                updateCoordinatesFromMap(markerLat, markerLon);
            });
        }

        // Update coordinates from map to all UI elements
        function updateCoordinatesFromMap(lat, lon) {
            const roundedLat = Math.round(lat * 100) / 100;
            const roundedLon = Math.round(lon * 100) / 100;

            // Update display inputs in map
            $('#lat-display').val(roundedLat.toFixed(2));
            $('#lon-display').val(roundedLon.toFixed(2));

            // Update marker position
            if (miniMarker) {
                miniMarker.setLatLng([roundedLat, roundedLon]);
            }

            // Update current coordinates
            currentLatitude = roundedLat;
            currentLongitude = roundedLon;

            // Update location UI (tumblers)
            updateLocationUI(roundedLat, roundedLon);

            log(`Map coordinates updated: ${roundedLat.toFixed(2)}, ${roundedLon.toFixed(2)}`);
        }

        // Toggle map accordion
        function toggleMapAccordion() {
            const accordion = $('#map-accordion');
            const isOpen = accordion.hasClass('open');
            
            if (isOpen) {
                accordion.removeClass('open');
                log('Map accordion closed');
            } else {
                accordion.addClass('open');
                log('Map accordion opened');
                
                // Initialize map if not already done or refresh it
                setTimeout(() => {
                    const lat = currentLatitude || 0;
                    const lon = currentLongitude || 0;
                    initializeMiniMap(lat, lon);
                    
                    // Update display inputs
                    $('#lat-display').val(lat.toFixed(2));
                    $('#lon-display').val(lon.toFixed(2));
                    
                    // Refresh map size after accordion animation
                    setTimeout(() => {
                        if (miniMap) {
                            miniMap.invalidateSize();
                        }
                    }, 350);
                }, 50);
            }
        }

        // Get current location for mini map
        function getCurrentLocationForMap() {
            if (navigator.geolocation) {
                $('#get-location').text('Localisation...').prop('disabled', true);
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = Math.round(position.coords.latitude * 100) / 100;
                        const lon = Math.round(position.coords.longitude * 100) / 100;

                        updateCoordinatesFromMap(lat, lon);
                        if (miniMap) {
                            miniMap.setView([lat, lon], 13);
                        }
                        
                        $('#get-location').text('Ma position').prop('disabled', false);
                    },
                    function(error) {
                        let errorMessage;
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "G√©olocalisation refus√©e.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "Position indisponible.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "D√©lai d√©pass√©.";
                                break;
                            default:
                                errorMessage = "Erreur g√©olocalisation.";
                        }
                        log(`Geolocation error: ${errorMessage}`);
                        $('#get-location').text('Ma position').prop('disabled', false);
                    }
                );
            } else {
                log("Geolocation not supported by browser");
            }
        }

        // --- N2 Network Functions ---
        async function fetchN2Network(pubkey) {
            try {
                log(`Fetching N2 network for user: ${pubkey.slice(0,10)}...`);
                updateStatus("R√©cup√©ration du r√©seau N2 personnel...");
                
                const response = await fetch(`/api/getN2?hex=${pubkey}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "Erreur lors de la r√©cup√©ration du r√©seau N2");
                }
                
                log(`R√©seau N2 r√©cup√©r√©: ${data.total_n2 || 0} connexions`);
                updateStatus(`R√©seau N2 r√©cup√©r√©: ${data.total_n2 || 0} connexions`, false, true);
                
                return data;
                
            } catch (error) {
                log(`Erreur lors de la r√©cup√©ration du r√©seau N2: ${error.message}`);
                updateStatus(`Erreur r√©seau N2: ${error.message}`, true);
                return null;
            }
        }

        async function fetchN2Messages(n2Data) {
            if (!n2Data || !n2Data.connections) {
                log("Impossible de r√©cup√©rer les messages N2: donn√©es r√©seau manquantes");
                return [];
            }
            
            let nostrPool;
            try {
                nostrPool = getNostrPool();
            } catch (e) {
                log("Impossible d'obtenir le pool NOSTR pour les messages N2");
                return [];
            }
            
            try {
                log("R√©cup√©ration des messages du r√©seau N2...");
                updateStatus("R√©cup√©ration des messages du r√©seau personnel...");
                
                // Extraire toutes les cl√©s hex des connexions N2
                // L'API retourne les connexions dans n2Data.connections
                const n2Keys = Object.values(n2Data.connections).filter(key => key && key.length === 64);
                
                if (n2Keys.length === 0) {
                    log("Aucune cl√© N2 valide trouv√©e");
                    return [];
                }
                
                log(`R√©cup√©ration des messages de ${n2Keys.length} connexions N2`);
                
                // R√©cup√©rer les messages de toutes les connexions N2 en parall√®le
                const events = await nostrPool.list(allRelaysToPublish, [{
                    kinds: [1],
                    authors: n2Keys,
                    limit: 50  // Limite par connexion
                }]);
                
                if (events.length > 0) {
                    log(`R√©cup√©r√© ${events.length} messages du r√©seau N2`);
                    updateStatus(`${events.length} messages r√©cup√©r√©s du r√©seau personnel`, false, true);
                    
                    // Trier par date (plus r√©cent en premier)
                    return events.sort((a, b) => b.created_at - a.created_at);
                } else {
                    log("Aucun message trouv√© dans le r√©seau N2");
                    updateStatus("Aucun message dans le r√©seau personnel", false, true);
                    return [];
                }
                
            } catch (error) {
                log(`Erreur lors de la r√©cup√©ration des messages N2: ${error.message}`);
                updateStatus(`Erreur messages N2: ${error.message}`, true);
                return [];
            }
        }

        // --- Profile Modal Functions ---
        function openProfileModal(pubkey, profileName = '') {
            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileModalContent');
            
            if (!modal || !content) {
                log('Profile modal elements not found');
                return;
            }
            
            // Show modal
            modal.style.display = 'block';
            
            // Update title with profile name if available
            const title = document.querySelector('.profile-modal-title');
            if (title) {
                title.textContent = `üåê ${profileName || 'Profile Viewer'}`;
            }
            
            // Show loading state
            content.innerHTML = '<div class="profile-modal-loading">Loading profile from IPFS...</div>';
            
            // Construct IPFS URL based on current domain architecture
            // Current page is loaded from u.domain.tld:54321
            // Profile viewer should be loaded from ipfs.domain.tld:8080
            const ipfsUrl = getIPFSUrl(`/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${pubkey}`);
            
            log(`Loading profile from IPFS gateway: ${ipfsUrl}`);
            
            // Create iframe to load the profile
            const iframe = document.createElement('iframe');
            iframe.className = 'profile-modal-iframe';
            iframe.src = ipfsUrl;
            iframe.title = `Profile of ${profileName || pubkey.slice(0, 8)}...`;
            
            // Handle iframe load events
            iframe.onload = function() {
                content.innerHTML = '';
                content.appendChild(iframe);
                log(`Profile loaded from IPFS: ${ipfsUrl}`);
            };
            
            iframe.onerror = function() {
                content.innerHTML = `
                    <div class="profile-modal-error">
                        <div>
                            <h4>‚ùå Failed to load profile</h4>
                            <p>Could not load profile from IPFS gateway.</p>
                            <p><strong>Public Key:</strong> ${pubkey}</p>
                            <p><strong>URL:</strong> <a href="${ipfsUrl}" target="_blank" style="color: #9C27B0;">${ipfsUrl}</a></p>
                            <button onclick="openProfileModal('${pubkey}', '${profileName}')" style="background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                                üîÑ Retry
                            </button>
                        </div>
                    </div>
                `;
                log(`Failed to load profile from IPFS: ${ipfsUrl}`);
            };
            
            // Set timeout for loading
            setTimeout(() => {
                if (content.querySelector('.profile-modal-loading')) {
                    content.innerHTML = `
                        <div class="profile-modal-error">
                            <div>
                                <h4>‚è∞ Loading timeout</h4>
                                <p>Profile is taking too long to load.</p>
                                <p><strong>Public Key:</strong> ${pubkey}</p>
                                <p><strong>URL:</strong> <a href="${ipfsUrl}" target="_blank" style="color: #9C27B0;">${ipfsUrl}</a></p>
                                <button onclick="openProfileModal('${pubkey}', '${profileName}')" style="background: #9C27B0; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                                    üîÑ Retry
                                </button>
                            </div>
                        </div>
                    `;
                    log(`Profile loading timeout: ${ipfsUrl}`);
                }
            }, 15000); // 15 second timeout
        }

        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.style.display = 'none';
                // Clear content when closing
                const content = document.getElementById('profileModalContent');
                if (content) {
                    content.innerHTML = '<div class="profile-modal-loading">Loading profile...</div>';
                }
            }
        }

        // Sync display inputs with tumbler changes
        $('#lat-display, #lon-display').on('change', function() {
            const lat = parseFloat($('#lat-display').val()) || 0;
            const lon = parseFloat($('#lon-display').val()) || 0;
            
            if (miniMarker) {
                miniMarker.setLatLng([lat, lon]);
            }
            if (miniMap) {
                miniMap.setView([lat, lon], miniMap.getZoom());
            }
        });

        // Fonction pour mettre √† jour dynamiquement la liste des relais
        function updateRelayListFromDomain() {
            const currentRelay = getRelayURL();
            const fallbackRelay = 'wss://relay.copylaradio.com';
            
            // Mettre √† jour la liste des relais par d√©faut
            DEFAULT_RELAYS.length = 0;
            DEFAULT_RELAYS.push(currentRelay, fallbackRelay);
            
            // Mettre √† jour la liste compl√®te des relais
            allRelaysToPublish = [...DEFAULT_RELAYS];
            
            log(`Relay list updated from domain: ${currentRelay} (primary), ${fallbackRelay} (fallback)`);
            
            // Mettre √† jour l'interface utilisateur
            updateRelayListUI();
        }
    </script>
</body>
</html>
