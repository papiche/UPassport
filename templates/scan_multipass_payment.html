<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/x-icon" href="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé´ MULTIPASS Payment Terminal</title>
    <script src="https://ipfs.copylaradio.com/ipfs/QmQLQ5WdCEc7mpKw5rhUujUU1URKweei4Bb4esyVNd9Atx/G1PalPay_fichiers/jquery-3.6.3.min.js"></script>
    <script src="https://ipfs.copylaradio.com/ipfs/QmQLQ5WdCEc7mpKw5rhUujUU1URKweei4Bb4esyVNd9Atx/G1PalPay_fichiers/instascan.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #FFF;
        }

        h1 {
            background: linear-gradient(to right, #ff6b6b, #ffa500, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 10px;
        }

        h2 {
            color: #ffd700;
            font-size: 1.2em;
            text-align: center;
            margin: 10px 0;
        }

        .description {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            max-width: 600px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .scanner-keypad-container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 20px;
            width: 100%;
            max-width: 600px;
        }

        #preview {
            flex: 1;
            max-width: 250px;
            height: auto;
            border: 3px solid #4fc3f7;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.5);
        }

        .payment-form {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            min-width: 300px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ffd700;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1em;
            box-sizing: border-box;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: 2px solid #4fc3f7;
        }

        .zen-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zen-input-wrapper {
            flex: 1;
            position: relative;
        }

        .zen-symbol {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-weight: bold;
            font-size: 1.2em;
        }

        #submitButton {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #submitButton:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        #submitButton:active {
            transform: translateY(0);
        }

        .spinner {
            margin-top: 20px;
            display: none;
            width: 200px;
            height: 200px;
            position: relative;
        }

        .planet {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            animation: orbit 4s linear infinite, colorChange 4s linear infinite;
        }

        .planet1 { animation-delay: 0s; }
        .planet2 { animation-delay: 1s; }
        .planet3 { animation-delay: 2s; }
        .planet4 { animation-delay: 3s; }

        @keyframes orbit {
            0% { transform: rotate(0deg) translateX(60px) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(60px) rotate(-360deg); }
        }

        @keyframes colorChange {
            0% { background-color: #ff6b6b; }
            25% { background-color: #feca57; }
            50% { background-color: #48dbfb; }
            75% { background-color: #ff9ff3; }
            100% { background-color: #ff6b6b; }
        }

        .result-container {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .result-frame {
            width: 80%;
            height: 80%;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        #result-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .result-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }

        .result-button {
            padding: 5px 10px;
            background-color: #FF8C42;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .result-button:hover {
            background-color: #E57A35;
        }

        .footnote {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
        }

        .numeric-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 150px;
            padding: 10px;
            border-radius: 10px;
            background-color: rgba(236, 239, 241, 0.9);
        }

        .keypad-button {
            padding: 15px;
            font-size: 1.5em;
            color: #333;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .keypad-button:hover {
            background-color: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .keypad-button:active {
            transform: scale(0.95);
        }

        .info-box {
            background-color: rgba(255, 215, 0, 0.2);
            border-left: 4px solid #ffd700;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.85em;
        }

        .wallet-info {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
        }

        /* Adaptation pour les petits √©crans */
        @media (max-width: 500px) {
            .scanner-keypad-container {
                flex-direction: column;
                align-items: center;
            }

            #preview {
                width: 100%;
                max-width: 100%;
            }

            .numeric-keypad {
                max-width: 100%;
            }

            .payment-form {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>üé´ MULTIPASS Payment Terminal</h1>
    <h2>Source: _EMAIL_</h2>
    
    <div class="description">
        <p><strong>üí∞ Pay with your MULTIPASS</strong></p>
        <p>MULTIPASS wallets contain ·∫êEN (stored in ~/.zen/game/nostr/)</p>
        <p>Scan destination MULTIPASS or enter G1 address</p>
    </div>

    <div class="wallet-info">
        <strong>üìç Source G1:</strong> _G1SOURCE_<br>
        <strong>üíé Available:</strong> _ZEN_ ·∫êen
    </div>

    <div class="scanner-keypad-container">
        <div style="flex: 1;">
            <div id="scan-result" style="margin: 20px 0; font-size: 1em; color: #ffd700; text-align: center;">
                üì∏ Scan destination QR Code
            </div>
            
            <form id="qr-form" class="payment-form">
                <div class="form-group">
                    <label for="zen">üí∞ Amount (·∫êen):</label>
                    <div class="zen-input-container">
                        <div class="zen-input-wrapper">
                            <input type="number" id="zen" name="zen" value="" min="0" step="0.01" placeholder="0.00" required>
                            <span class="zen-symbol">·∫ê</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="g1dest">üéØ Destination (G1 Address or Email):</label>
                    <input type="text" id="g1dest" name="g1dest" placeholder="Scan QR or enter address" required>
                </div>

                <input type="hidden" id="g1source" name="g1source" value="_G1SOURCE_">
                
                <div class="info-box">
                    ‚ÑπÔ∏è <strong>Note:</strong> ZEN Cards (in ~/.zen/game/players/) are for accounting social shares only. MULTIPASS wallets hold the actual ·∫êEN for payments.
                </div>

                <button type="submit" id="submitButton">üí∏ Send Payment</button>
            </form>

            <video id="preview"></video>
        </div>

        <div class="numeric-keypad" id="numeric-keypad">
            <div class="keypad-button">1</div>
            <div class="keypad-button">2</div>
            <div class="keypad-button">3</div>
            <div class="keypad-button">4</div>
            <div class="keypad-button">5</div>
            <div class="keypad-button">6</div>
            <div class="keypad-button">7</div>
            <div class="keypad-button">8</div>
            <div class="keypad-button">9</div>
            <div class="keypad-button">‚Üê</div>
            <div class="keypad-button">0</div>
            <div class="keypad-button">C</div>
            <div class="keypad-button">.</div>
        </div>
    </div>

    <div class="spinner" id="loadingSpinner">
        <div class="planet planet1"></div>
        <div class="planet planet2"></div>
        <div class="planet planet3"></div>
        <div class="planet planet4"></div>
    </div>

    _TW_

    <div class="footnote">
        üé´ MULTIPASS Payment Terminal v2.0 | ·∫êEN Payments via ~/.zen/game/nostr/
    </div>

    <div class="result-container">
        <div class="result-frame">
            <iframe id="result-iframe"></iframe>
            <div class="result-controls">
                <button class="result-button" id="close-result">‚úï Close</button>
                <button class="result-button" id="open-new-tab">‚Üó Open</button>
            </div>
        </div>
    </div>

    <script>
    $(document).ready(function() {
        // Toggle numeric keypad visibility
        $('#preview').click(function() {
            $('#numeric-keypad').toggle();
        });

        // Initialize submit button style
        $('#submitButton').css('background', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');

        // Add click event to each keypad button
        $('.keypad-button').click(function() {
            let currentVal = $('#zen').val();
            const key = $(this).text();

            if (key === '‚Üê') { // Backspace key
                $('#zen').val(currentVal.slice(0, -1));
            } else if (key === 'C') { // Clear key
                $('#zen').val('');
            } else if (key === '.') { // Decimal point
                if (!currentVal.includes('.')) {
                    $('#zen').val(currentVal + key);
                }
            } else { // Number keys
                $('#zen').val(currentVal + key);
            }
        });

        // QR Scanner configuration
        let opts = {
          continuous: true,
          video: document.getElementById('preview'),
          mirror: false,
          captureImage: false,
          backgroundScan: false,
          refractoryPeriod: 5000,
          scanPeriod: 1
        };

        // Initialize scanner
        let scanner = new Instascan.Scanner(opts);
        scanner.addListener('scan', function (content) {
            document.getElementById("g1dest").value = content;
            let truncatedContent = content.length > 32 ? content.substring(0, 32) + "..." : content;
            document.getElementById("scan-result").innerHTML = "‚úÖ Scanned: " + truncatedContent;
        });

        // Start camera if available
        Instascan.Camera.getCameras().then(function (cameras) {
            if (cameras.length > 0) {
                scanner.start(cameras[0]);
            } else {
                console.error('No cameras found.');
                document.getElementById("scan-result").innerHTML = "‚ö†Ô∏è No camera found - enter destination manually";
            }
        }).catch(function (e) {
            console.error(e);
            document.getElementById("scan-result").innerHTML = "‚ö†Ô∏è Camera error - enter destination manually";
        });

        // Form submission handler
        $('#qr-form').submit(function(e) {
            e.preventDefault();
            
            // Validate amount
            const zenAmount = parseFloat($('#zen').val());
            if (isNaN(zenAmount) || zenAmount <= 0) {
                alert('‚ö†Ô∏è Please enter a valid amount greater than 0');
                return;
            }

            // Validate destination
            const destination = $('#g1dest').val().trim();
            if (destination.length === 0) {
                alert('‚ö†Ô∏è Please scan a QR code or enter a destination address');
                return;
            }

            $('#loadingSpinner').show();
            $('#submitButton').prop('disabled', true).text('‚è≥ Processing...');

            const serverUrl = '/zen_send';
            $.ajax({
                url: serverUrl,
                type: 'POST',
                data: $(this).serialize(),
                success: function(response) {
                    window.parent.postMessage('eraseParametre', '*');
                    $('#loadingSpinner').hide();
                    $('#submitButton').prop('disabled', false).text('üí∏ Send Payment');
                    
                    // Display result
                    $('#result-iframe').attr('srcdoc', response);
                    $('.result-container').css('display', 'flex');
                    
                    // Reset form on success
                    $('#zen').val('');
                    $('#g1dest').val('');
                    $('#scan-result').html('üì∏ Scan destination QR Code');
                },
                error: function(xhr, status, error) {
                    $('#loadingSpinner').hide();
                    $('#submitButton').prop('disabled', false).text('üí∏ Send Payment');
                    alert('‚ùå Payment failed: ' + (xhr.responseJSON?.error || error || 'Unknown error'));
                }
            });
        });

        // Result controls
        $('#close-result').click(function() {
            $('.result-container').hide();
        });

        $('#open-new-tab').click(function() {
            var response = $('#result-iframe').attr('srcdoc');
            var newTab = window.open();
            newTab.document.write(response);
            newTab.document.close();
        });
    });
    </script>
</body>
</html>

