<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <link rel="icon" type="image/x-icon" href="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1">
    <title>ü§ñ #BRO Terminal</title>
    <script src="/earth/jquery-3.6.3.min.js"></script>
    <script src="/earth/nostr.bundle.js"></script>
    <link rel="stylesheet" href="/earth/leaflet.css"/>
    <script src="/earth/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-void: #0a0a0f;
            --bg-panel: #12141a;
            --bg-input: #1a1d24;
            --bg-hover: #22262f;
            --text-primary: #e0e6ed;
            --text-dim: #5a6270;
            --accent-cyan: #00d4ff;
            --accent-green: #00ff88;
            --accent-orange: #ff9500;
            --accent-purple: #9966ff;
            --accent-red: #ff4466;
            --border: rgba(0, 212, 255, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg-void);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }

        /* === TOP BAR === */
        .top-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-cyan);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .logo:hover { opacity: 0.8; }

        .profile-mini {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            padding: 3px 8px;
            background: var(--bg-input);
            border-radius: 12px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .profile-mini img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--border);
        }

        .profile-mini .name {
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-dim);
        }

        .profile-mini.connected .name { color: var(--accent-green); }

        .btn-connect {
            padding: 4px 10px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 10px;
            color: var(--bg-void);
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-connect:hover { opacity: 0.9; }
        .btn-connect:disabled { background: var(--bg-hover); color: var(--text-dim); }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .status-dot.offline { background: var(--accent-red); animation: none; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* === SERVICE TABS === */
        .service-bar {
            display: flex;
            gap: 2px;
            padding: 4px 6px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            flex-shrink: 0;
        }

        .service-bar::-webkit-scrollbar { display: none; }

        .svc-btn {
            padding: 4px 8px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .svc-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .svc-btn.active {
            background: var(--bg-input);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        /* === CHAT AREA === */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chat-area::-webkit-scrollbar { width: 4px; }
        .chat-area::-webkit-scrollbar-track { background: var(--bg-panel); }
        .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .msg {
            padding: 8px 10px;
            background: var(--bg-panel);
            border-radius: 6px;
            border-left: 2px solid var(--text-dim);
            font-size: 0.8rem;
            line-height: 1.4;
            max-width: 95%;
        }

        .msg.user {
            border-left-color: var(--accent-cyan);
            align-self: flex-end;
        }

        .msg.bot {
            border-left-color: var(--accent-green);
            background: linear-gradient(90deg, rgba(0,255,136,0.05), transparent);
        }

        .msg-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            font-size: 0.65rem;
            color: var(--text-dim);
        }

        .msg-header .tag {
            padding: 1px 4px;
            background: var(--bg-hover);
            border-radius: 2px;
            font-size: 0.6rem;
        }

        .msg-header .tag.video { color: var(--accent-red); }
        .msg-header .tag.image { color: var(--accent-purple); }
        .msg-header .tag.music { color: var(--accent-orange); }
        .msg-header .tag.search { color: var(--accent-green); }

        .msg-content { word-break: break-word; }

        .msg-content a {
            color: var(--accent-cyan);
            text-decoration: none;
        }

        .msg-content a:hover { text-decoration: underline; }

        .msg-media {
            margin-top: 6px;
            border-radius: 4px;
            overflow: hidden;
            background: var(--bg-void);
        }

        .msg-media img, .msg-media video {
            max-width: 100%;
            max-height: 200px;
            display: block;
        }

        .msg-media audio { width: 100%; height: 32px; }

        .msg-time {
            font-size: 0.6rem;
            color: var(--text-dim);
            margin-top: 4px;
            text-align: right;
        }

        .msg-nav {
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 6px;
        }

        .msg-nav button {
            padding: 4px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .msg-nav button:hover:not(:disabled) {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .msg-nav button:disabled { opacity: 0.3; }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-size: 0.8rem;
            text-align: center;
            padding: 20px;
        }

        .empty-state .icon { font-size: 2rem; margin-bottom: 8px; opacity: 0.5; }

        /* === INPUT AREA === */
        .input-area {
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 8px;
            flex-shrink: 0;
        }

        .input-options {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .opt-btn {
            padding: 3px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.65rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .opt-btn:hover { border-color: var(--accent-cyan); color: var(--text-primary); }
        .opt-btn.active { background: var(--accent-cyan); color: var(--bg-void); border-color: var(--accent-cyan); }
        .opt-btn.warn.active { background: var(--accent-orange); border-color: var(--accent-orange); }

        .input-row {
            display: flex;
            gap: 6px;
        }

        .input-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #messageInput {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            resize: none;
            min-height: 40px;
            max-height: 120px;
        }

        #messageInput:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        #messageInput::placeholder { color: var(--text-dim); }

        .btn-send {
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            border-radius: 6px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            align-self: flex-end;
        }

        .btn-send:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-send:disabled { background: var(--bg-hover); color: var(--text-dim); transform: none; }

        .hint {
            font-size: 0.6rem;
            color: var(--text-dim);
            padding: 2px 0;
        }

        /* === IMAGE PREVIEW === */
        .img-preview-wrap {
            display: none;
            position: relative;
            margin-bottom: 6px;
        }

        .img-preview-wrap.visible { display: block; }

        .img-preview-wrap img {
            max-height: 80px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .img-preview-wrap .remove {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: var(--accent-red);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.7rem;
            cursor: pointer;
            line-height: 1;
        }

        /* === SETTINGS PANEL === */
        .settings-panel {
            display: none;
            padding: 8px;
            background: var(--bg-input);
            border-top: 1px solid var(--border);
        }

        .settings-panel.open { display: block; }

        .settings-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.7rem;
        }

        .settings-row label {
            color: var(--text-dim);
            min-width: 60px;
        }

        .settings-row input[type="number"] {
            width: 60px;
            padding: 3px 6px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.7rem;
        }

        .settings-row input:focus { outline: none; border-color: var(--accent-cyan); }

        .toggle-switch {
            position: relative;
            width: 32px;
            height: 18px;
            background: var(--bg-panel);
            border-radius: 9px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch.on { background: var(--accent-cyan); }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: var(--text-primary);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle-switch.on::after { transform: translateX(14px); }

        /* === LIGHTBOX === */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .lightbox.active { display: flex; }

        .lightbox img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .lightbox-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
        }

        /* === SUB-OPTIONS (video mode, etc.) === */
        .sub-options {
            display: none;
            gap: 4px;
            margin-left: auto;
        }

        .sub-options.visible { display: flex; }

        .sub-opt {
            padding: 2px 6px;
            background: var(--bg-hover);
            border: 1px solid transparent;
            border-radius: 3px;
            color: var(--text-dim);
            font-size: 0.6rem;
            cursor: pointer;
        }

        .sub-opt:hover { border-color: var(--border); }
        .sub-opt.active { border-color: var(--accent-cyan); color: var(--accent-cyan); }

        /* === LOADING === */
        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .loading.visible { display: flex; }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-hover);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* === HIDDEN === */
        .hidden { display: none !important; }

        /* === MAP MINI === */
        #mini-map {
            height: 120px;
            border-radius: 4px;
            margin-top: 6px;
        }
    </style>
</head>
<body>
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="logo" onclick="history.go(-1)">ü§ñ #BRO</div>
        <div class="status-dot offline" id="statusDot"></div>
        <div class="profile-mini" id="profileMini">
            <img src="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1" id="profileImg">
            <span class="name" id="profileName">Non connect√©</span>
        </div>
        <button class="btn-connect" id="btnConnect">Connecter</button>
    </div>

    <!-- SERVICE BAR -->
    <div class="service-bar">
        <button class="svc-btn active" data-svc="chat">üí¨ Chat</button>
        <button class="svc-btn" data-svc="image">üñºÔ∏è Image</button>
        <button class="svc-btn" data-svc="video">üé¨ Vid√©o</button>
        <button class="svc-btn" data-svc="music">üéµ Musique</button>
        <button class="svc-btn" data-svc="search">üîç Search</button>
        <button class="svc-btn" data-svc="nature">üåø Nature</button>
        <button class="svc-btn" data-svc="memory">üß† M√©moire</button>
    </div>

    <!-- CHAT AREA -->
    <div class="chat-area" id="chatArea">
        <div class="empty-state" id="emptyState">
            <div class="icon">ü§ñ</div>
            <div>Connectez-vous pour dialoguer avec votre ASTROBOT</div>
            <div style="margin-top:8px;font-size:0.7rem;">Votre assistant IA r√©pond en votre nom</div>
        </div>
    </div>

    <!-- MESSAGE NAV -->
    <div class="msg-nav hidden" id="msgNav">
        <button id="btnOlder">‚óÄ Ancien</button>
        <button id="btnRefresh">‚Üª</button>
        <button id="btnNewer">R√©cent ‚ñ∂</button>
    </div>

    <!-- INPUT AREA -->
    <div class="input-area">
        <!-- Options row -->
        <div class="input-options">
            <button class="opt-btn active" id="btnConversation" title="Mode conversation: BRO r√©pond en votre nom (√©ph√©m√®re 1h)">
                üí¨ Conversation
            </button>
            <button class="opt-btn" id="btnPublic" title="Mode public: message permanent sur votre fil">
                üì¢ Public
            </button>
            <label class="opt-btn" for="imgInput" id="btnImage" title="Joindre une image">
                üì∑
            </label>
            <input type="file" id="imgInput" accept="image/*" style="display:none;">
            <button class="opt-btn" id="btnLocation" title="Activer/d√©sactiver la localisation">
                üìç
            </button>
            <button class="opt-btn" id="btnSettings" title="Param√®tres">
                ‚öôÔ∏è
            </button>
            <!-- Sub-options for video -->
            <div class="sub-options" id="videoOpts">
                <button class="sub-opt active" data-mode="t2v">T2V</button>
                <button class="sub-opt" data-mode="i2v">I2V</button>
            </div>
        </div>

        <!-- Image preview -->
        <div class="img-preview-wrap" id="imgPreviewWrap">
            <img id="imgPreview" src="#">
            <button class="remove" onclick="clearImage()">√ó</button>
        </div>

        <!-- Input row -->
        <div class="input-row">
            <div class="input-main">
                <textarea id="messageInput" placeholder="Tapez votre message..." rows="1"></textarea>
                <div class="hint" id="serviceHint">üí¨ Posez une question ou discutez avec votre IA</div>
            </div>
            <button class="btn-send" id="btnSend" disabled>ENVOYER</button>
        </div>

        <!-- Loading -->
        <div class="loading" id="loadingBar">
            <div class="spinner"></div>
            <span id="loadingText">Envoi en cours...</span>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-row">
            <label>Latitude</label>
            <input type="number" id="latInput" step="0.01" min="-90" max="90" value="0">
            <label>Longitude</label>
            <input type="number" id="lonInput" step="0.01" min="-180" max="180" value="0">
            <button class="opt-btn" id="btnGeolocate">üìç Ma position</button>
        </div>
        <div class="settings-row">
            <label>Localisation</label>
            <div class="toggle-switch on" id="toggleLocation"></div>
            <span style="color:var(--text-dim);font-size:0.65rem;">Requis pour #BRO</span>
        </div>
        <div id="mapContainer" style="display:none;">
            <div id="mini-map"></div>
        </div>
    </div>

    <!-- Lightbox -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
        <img id="lightboxImg" src="#">
    </div>

    <script>
        // === CONFIG ===
        const DEFAULT_RELAYS = ['wss://relay.copylaradio.com', 'ws://127.0.0.1:7777'];
        const MESSAGES_PER_PAGE = 10;

        // === STATE ===
        let publicKey = '';
        let privateKeyHex = null;
        let pool = null;
        let allRelays = [...DEFAULT_RELAYS];
        let userProfile = null;
        let messages = [];
        let msgIndex = 0;
        let currentService = 'chat';
        let videoMode = 't2v';
        let isConversation = true; // Default: conversation mode (ephemeral)
        let locationEnabled = true;
        let currentLat = null;
        let currentLon = null;
        let selectedImage = null;
        let miniMap = null;

        // === ELEMENTS ===
        const $statusDot = $('#statusDot');
        const $profileMini = $('#profileMini');
        const $profileImg = $('#profileImg');
        const $profileName = $('#profileName');
        const $btnConnect = $('#btnConnect');
        const $chatArea = $('#chatArea');
        const $emptyState = $('#emptyState');
        const $msgNav = $('#msgNav');
        const $messageInput = $('#messageInput');
        const $btnSend = $('#btnSend');
        const $loadingBar = $('#loadingBar');
        const $loadingText = $('#loadingText');
        const $serviceHint = $('#serviceHint');
        const $imgPreviewWrap = $('#imgPreviewWrap');
        const $imgPreview = $('#imgPreview');
        const $settingsPanel = $('#settingsPanel');
        const $videoOpts = $('#videoOpts');

        // === SERVICE HINTS ===
        const serviceHints = {
            chat: 'üí¨ Posez une question ou discutez avec votre IA',
            image: 'üñºÔ∏è D√©crivez l\'image √† g√©n√©rer (Stable Diffusion)',
            video: 'üé¨ D√©crivez la sc√®ne vid√©o (Wan2.2 AI)',
            music: 'üéµ Style musical: "jazz piano 80bpm" ou ajoutez #parole',
            search: 'üîç Recherche web avec Perplexica',
            nature: 'üåø Joignez une photo pour identifier plantes/animaux',
            memory: 'üß† #mem pour voir, #reset pour effacer'
        };

        // === INIT ===
        $(document).ready(function() {
            checkExtension();
            getLocation();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Connect
            $btnConnect.on('click', connectWallet);

            // Service tabs
            $('.svc-btn').on('click', function() {
                switchService($(this).data('svc'));
            });

            // Mode toggle
            $('#btnConversation').on('click', () => setMode(true));
            $('#btnPublic').on('click', () => setMode(false));

            // Video sub-options
            $('.sub-opt').on('click', function() {
                videoMode = $(this).data('mode');
                $('.sub-opt').removeClass('active');
                $(this).addClass('active');
            });

            // Image input
            $('#imgInput').on('change', handleImageSelect);

            // Location toggle
            $('#btnLocation').on('click', function() {
                locationEnabled = !locationEnabled;
                $(this).toggleClass('active', locationEnabled);
                $('#toggleLocation').toggleClass('on', locationEnabled);
            });

            // Settings
            $('#btnSettings').on('click', function() {
                $settingsPanel.toggleClass('open');
                $(this).toggleClass('active');
                if ($settingsPanel.hasClass('open') && !miniMap) {
                    initMiniMap();
                }
            });

            $('#toggleLocation').on('click', function() {
                locationEnabled = !locationEnabled;
                $(this).toggleClass('on', locationEnabled);
                $('#btnLocation').toggleClass('active', locationEnabled);
            });

            $('#btnGeolocate').on('click', getLocation);

            // Send
            $btnSend.on('click', sendMessage);
            $messageInput.on('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            $messageInput.on('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Navigation
            $('#btnOlder').on('click', () => navigateMsg(1));
            $('#btnNewer').on('click', () => navigateMsg(-1));
            $('#btnRefresh').on('click', () => fetchMessages());

            // Lightbox
            $('#lightbox').on('click', function(e) {
                if (e.target.id === 'lightbox') closeLightbox();
            });
            $(document).on('keydown', e => { if (e.key === 'Escape') closeLightbox(); });
        }

        // === WALLET ===
        function checkExtension() {
            if (typeof window.nostr !== 'undefined') {
                $btnConnect.prop('disabled', false);
            } else {
                $btnConnect.text('Extension?').prop('disabled', true);
            }
        }

        async function connectWallet() {
            try {
                $btnConnect.prop('disabled', true).text('...');
                publicKey = await window.nostr.getPublicKey();
                $statusDot.removeClass('offline');
                $profileMini.addClass('connected');
                $btnConnect.hide();
                $btnSend.prop('disabled', false);
                await fetchProfile();
                await fetchMessages();
            } catch (e) {
                console.error('Connect error:', e);
                $btnConnect.prop('disabled', false).text('R√©essayer');
                $statusDot.addClass('offline');
            }
        }

        async function fetchProfile() {
            const pool = getPool();
            try {
                for (const relay of DEFAULT_RELAYS) {
                    const events = await pool.list([relay], [{ kinds: [0], authors: [publicKey], limit: 1 }]);
                    if (events.length > 0) {
                        userProfile = JSON.parse(events[0].content);
                        $profileImg.attr('src', userProfile.picture || $profileImg.attr('src'));
                        $profileName.text(userProfile.display_name || userProfile.name || publicKey.slice(0, 8));
                        break;
                    }
                }
            } catch (e) {
                console.error('Profile fetch error:', e);
            }
        }

        // === MESSAGES ===
        async function fetchMessages() {
            if (!publicKey) return;
            const pool = getPool();
            try {
                const events = await pool.list(allRelays, [{
                    kinds: [1],
                    authors: [publicKey],
                    limit: MESSAGES_PER_PAGE
                }]);
                messages = events.sort((a, b) => b.created_at - a.created_at);
                msgIndex = 0;
                renderMessages();
            } catch (e) {
                console.error('Fetch error:', e);
            }
        }

        function renderMessages() {
            $emptyState.addClass('hidden');
            $msgNav.removeClass('hidden');
            $chatArea.empty();

            if (messages.length === 0) {
                $emptyState.removeClass('hidden');
                $msgNav.addClass('hidden');
                return;
            }

            const msg = messages[msgIndex];
            renderSingleMessage(msg, true);
            fetchReplies(msg.id);
            updateNavButtons();
        }

        function renderSingleMessage(event, isUser) {
            const tags = extractTags(event.content);
            const expiration = getExpiration(event);
            const mediaUrls = extractMediaUrls(event.content);
            let text = cleanContent(event.content, mediaUrls);

            const $msg = $('<div>').addClass('msg').addClass(isUser ? 'user' : 'bot');
            
            // Header
            const $header = $('<div>').addClass('msg-header');
            $header.append($('<span>').text(isUser ? 'üë§ Vous' : 'ü§ñ BRO'));
            if (expiration) {
                $header.append($('<span>').addClass('tag').text(`‚è±Ô∏è ${formatExpiry(expiration)}`));
            }
            tags.forEach(t => {
                $header.append($('<span>').addClass('tag ' + t).text('#' + t));
            });
            $msg.append($header);

            // Content
            const $content = $('<div>').addClass('msg-content').html(linkify(text));
            $msg.append($content);

            // Media
            mediaUrls.forEach(url => {
                const type = detectMediaType(url);
                if (type) {
                    const $media = $('<div>').addClass('msg-media');
                    if (type === 'image' || type === 'gif') {
                        $media.append($('<img>').attr('src', url).on('click', () => openLightbox(url)));
                    } else if (type === 'video') {
                        $media.append($('<video controls>').attr('src', url));
                    } else if (type === 'audio') {
                        $media.append($('<audio controls>').attr('src', url));
                    }
                    $msg.append($media);
                }
            });

            // Time
            $msg.append($('<div>').addClass('msg-time').text(
                `${msgIndex + 1}/${messages.length} ‚Ä¢ ${new Date(event.created_at * 1000).toLocaleString()}`
            ));

            $chatArea.append($msg);
        }

        async function fetchReplies(eventId) {
            const pool = getPool();
            try {
                const replies = await pool.list(allRelays, [{ kinds: [1], '#e': [eventId], limit: 10 }]);
                replies.sort((a, b) => a.created_at - b.created_at);
                replies.forEach(r => renderSingleMessage(r, false));
                $chatArea.scrollTop($chatArea[0].scrollHeight);

                // Auto-refresh if no replies yet
                if (replies.length === 0) {
                    setTimeout(() => {
                        if (messages[msgIndex]?.id === eventId) fetchReplies(eventId);
                    }, 5000);
                }
            } catch (e) {
                console.error('Replies error:', e);
            }
        }

        function navigateMsg(delta) {
            const newIdx = msgIndex + delta;
            if (newIdx >= 0 && newIdx < messages.length) {
                msgIndex = newIdx;
                renderMessages();
            }
        }

        function updateNavButtons() {
            $('#btnOlder').prop('disabled', msgIndex >= messages.length - 1);
            $('#btnNewer').prop('disabled', msgIndex <= 0);
        }

        // === SEND ===
        async function sendMessage() {
            if (!publicKey) return;
            const text = $messageInput.val().trim();
            if (!text && !selectedImage) return;

            showLoading(true, 'Envoi...');

            try {
                let content = buildContent(text);
                let tags = [['application', 'UPlanet']];

                // Location
                if (locationEnabled && currentLat !== null) {
                    tags.push(['latitude', currentLat.toFixed(2)]);
                    tags.push(['longitude', currentLon.toFixed(2)]);
                    tags.push(['g', `${currentLat.toFixed(6)};${currentLon.toFixed(6)}`]);
                }

                // Conversation mode (ephemeral)
                if (isConversation) {
                    const expiry = Math.floor(Date.now() / 1000) + 3600;
                    tags.push(['expiration', expiry.toString()]);
                }

                // Image upload
                if (selectedImage) {
                    showLoading(true, 'Upload image...');
                    try {
                        const result = await uploadNip96(selectedImage);
                        content += '\n' + result.url;
                        if (result.tags) tags = tags.concat(result.tags);
                    } catch (e) {
                        console.error('Upload error:', e);
                    }
                }

                const event = {
                    kind: 1,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: tags,
                    content: content
                };

                showLoading(true, 'Signature...');
                const signed = await window.nostr.signEvent(event);

                showLoading(true, 'Publication...');
                let success = 0;
                await Promise.all(allRelays.map(async (r) => {
                    if (await publishToRelay(r, signed)) success++;
                }));

                if (success > 0) {
                    $messageInput.val('').css('height', 'auto');
                    clearImage();
                    setTimeout(fetchMessages, 3000);
                }
            } catch (e) {
                console.error('Send error:', e);
            } finally {
                showLoading(false);
            }
        }

        function buildContent(text) {
            let prefix = '#BRO ';
            switch (currentService) {
                case 'image': prefix += '#image '; break;
                case 'video': prefix += '#video '; break;
                case 'music': prefix += '#music '; break;
                case 'search': prefix += '#search '; break;
                case 'nature': prefix += '#plantnet '; break;
                case 'memory': return text.includes('#') ? text : '#BRO #mem';
            }
            return prefix + text;
        }

        // === UI HELPERS ===
        function switchService(svc) {
            currentService = svc;
            $('.svc-btn').removeClass('active');
            $(`.svc-btn[data-svc="${svc}"]`).addClass('active');
            $serviceHint.text(serviceHints[svc] || '');
            $videoOpts.toggleClass('visible', svc === 'video');
            
            // Show image button for relevant services
            const needsImage = ['nature', 'video'].includes(svc) && (svc === 'nature' || videoMode === 'i2v');
            $('#btnImage').toggleClass('active', needsImage);
        }

        function setMode(conversation) {
            isConversation = conversation;
            $('#btnConversation').toggleClass('active', conversation);
            $('#btnPublic').toggleClass('active warn', !conversation);
        }

        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    selectedImage = ev.target.result;
                    $imgPreview.attr('src', selectedImage);
                    $imgPreviewWrap.addClass('visible');
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            selectedImage = null;
            $imgPreview.attr('src', '#');
            $imgPreviewWrap.removeClass('visible');
            $('#imgInput').val('');
        }

        function showLoading(show, text) {
            $loadingBar.toggleClass('visible', show);
            $loadingText.text(text || '');
            $btnSend.prop('disabled', show || !publicKey);
        }

        function openLightbox(src) {
            $('#lightboxImg').attr('src', src);
            $('#lightbox').addClass('active');
        }

        function closeLightbox() {
            $('#lightbox').removeClass('active');
        }

        // === LOCATION ===
        function getLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    $('#latInput').val(currentLat.toFixed(2));
                    $('#lonInput').val(currentLon.toFixed(2));
                    $('#btnLocation').addClass('active');
                    if (miniMap) updateMapMarker();
                },
                () => { locationEnabled = false; $('#btnLocation').removeClass('active'); },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function initMiniMap() {
            const lat = currentLat || 0;
            const lon = currentLon || 0;
            $('#mapContainer').show();
            miniMap = L.map('mini-map').setView([lat, lon], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
            miniMap.marker = L.marker([lat, lon], { draggable: true }).addTo(miniMap);
            miniMap.marker.on('dragend', (e) => {
                const p = e.target.getLatLng();
                currentLat = p.lat;
                currentLon = p.lng;
                $('#latInput').val(currentLat.toFixed(2));
                $('#lonInput').val(currentLon.toFixed(2));
            });
            miniMap.on('click', (e) => {
                currentLat = e.latlng.lat;
                currentLon = e.latlng.lng;
                miniMap.marker.setLatLng([currentLat, currentLon]);
                $('#latInput').val(currentLat.toFixed(2));
                $('#lonInput').val(currentLon.toFixed(2));
            });
        }

        function updateMapMarker() {
            if (miniMap && miniMap.marker) {
                miniMap.marker.setLatLng([currentLat, currentLon]);
                miniMap.setView([currentLat, currentLon], 10);
            }
        }

        // === UTILS ===
        function getPool() {
            if (!pool) {
                pool = new NostrTools.SimplePool({ getTimeout: 5000 });
            }
            return pool;
        }

        function detectMediaType(url) {
            const l = url.toLowerCase();
            if (/\.(jpg|jpeg|png|webp)(\?|$)/i.test(l)) return 'image';
            if (/\.gif(\?|$)/i.test(l)) return 'gif';
            if (/\.(mp4|webm|mov)(\?|$)/i.test(l)) return 'video';
            if (/\.(mp3|wav|ogg|m4a)(\?|$)/i.test(l)) return 'audio';
            if (/ipfs/i.test(l)) {
                if (/video_|\.mp4|\.webm/i.test(l)) return 'video';
                if (/audio_|\.mp3|\.wav/i.test(l)) return 'audio';
                if (/\.gif/i.test(l)) return 'gif';
                return 'image';
            }
            return null;
        }

        function extractTags(content) {
            const tags = [];
            if (/#image/i.test(content)) tags.push('image');
            if (/#video/i.test(content)) tags.push('video');
            if (/#music/i.test(content)) tags.push('music');
            if (/#search/i.test(content)) tags.push('search');
            if (/#plantnet|#inventory/i.test(content)) tags.push('nature');
            return tags;
        }

        function extractMediaUrls(content) {
            const regex = /(https?:\/\/[^\s<>"]+)/gi;
            const urls = content.match(regex) || [];
            return urls.filter(u => detectMediaType(u));
        }

        function cleanContent(content, mediaUrls) {
            let text = content;
            mediaUrls.forEach(u => { text = text.replace(u, ''); });
            text = text.replace(/#(BRO|BOT|image|video|music|search|plantnet|inventory|mem|reset)\s*/gi, '');
            return text.trim();
        }

        function linkify(text) {
            return text.replace(/(https?:\/\/[^\s<>"]+)/gi, '<a href="$1" target="_blank">$1</a>');
        }

        function getExpiration(event) {
            if (!event.tags) return null;
            const t = event.tags.find(t => t[0] === 'expiration');
            return t ? parseInt(t[1], 10) : null;
        }

        function formatExpiry(ts) {
            const rem = ts - Math.floor(Date.now() / 1000);
            if (rem <= 0) return 'Expir√©';
            const m = Math.floor(rem / 60);
            return m < 60 ? `${m}min` : `${Math.floor(m/60)}h`;
        }

        async function uploadNip96(dataUrl) {
            const res = await fetch('/.well-known/nostr/nip96.json');
            const cfg = await res.json();
            const api = cfg.api_url;
            const dl = cfg.download_url || '';

            const b64 = dataUrl.split(',')[1];
            const mime = dataUrl.split(',')[0].split(':')[1].split(';')[0];
            const bin = atob(b64);
            const arr = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
            const blob = new Blob([arr], { type: mime });
            const file = new File([blob], `img-${Date.now()}.png`, { type: mime });

            const fd = new FormData();
            fd.append('file', file);

            const r = await fetch(api, { method: 'POST', body: fd });
            const data = await r.json();

            if (data.status === 'success' && data.nip94_event?.tags) {
                let url = data.nip94_event.tags.find(t => t[0] === 'url')?.[1];
                if (url?.startsWith('/ipfs/') && dl) {
                    url = dl.replace(/\/$/, '') + url;
                }
                return { url, tags: data.nip94_event.tags.filter(t => t[0] !== 'url') };
            }
            throw new Error('Upload failed');
        }

        async function publishToRelay(url, event) {
            return new Promise((resolve) => {
                try {
                    const ws = new WebSocket(url);
                    const timeout = setTimeout(() => { ws.close(); resolve(false); }, 5000);
                    ws.onopen = () => ws.send(JSON.stringify(['EVENT', event]));
                    ws.onmessage = (e) => {
                        try {
                            const m = JSON.parse(e.data);
                            if (m[0] === 'OK' && m[1] === event.id) {
                                clearTimeout(timeout);
                                ws.close();
                                resolve(true);
                            }
                        } catch {}
                    };
                    ws.onerror = () => { clearTimeout(timeout); resolve(false); };
                } catch { resolve(false); }
            });
        }
    </script>
</body>
</html>
