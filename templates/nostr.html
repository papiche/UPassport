<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/x-icon" href="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1">
    <title>UPlanet NOSTR Geo Messaging</title>
    <script src="https://ipfs.copylaradio.com/ipfs/QmQLQ5WdCEc7mpKw5rhUujUU1URKweei4Bb4esyVNd9Atx/G1PalPay_fichiers/jquery-3.6.3.min.js"></script>
    <!-- Import nostr-tools (includes SimplePool) -->
    <script src="https://ipfs.copylaradio.com/ipfs/QmXEmaPRUaGcvhuyeG99mHHNyP43nn8GtNeuDok8jdpG4a/nostr.bundle.js"></script>
    <style>
        /* Basic styles */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 15px; background-color: #1a1a1a; color: #e0e0e0; display: flex; flex-direction: column; min-height: 100vh; box-sizing: border-box; }
        .container { background-color: #2a2a2a; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); width: 100%; max-width: 500px; margin: 20px auto; box-sizing: border-box; }
        h1 { background: linear-gradient(to right, #ff6b6b, #ffa500, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.8em; text-align: center; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #cccccc; }
        textarea { width: 100%; height: 100px; padding: 10px; margin-bottom: 15px; box-sizing: border-box; border: 1px solid #555; border-radius: 4px; background-color: #333; color: #e0e0e0; font-size: 1em; }
        button, .button-like { display: block; width: 100%; padding: 12px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; text-align: center; margin-bottom: 10px; transition: background-color 0.3s ease; box-sizing: border-box; }
        button:hover, .button-like:hover { background-color: #45a049; }
        button:disabled { background-color: #555; cursor: not-allowed; opacity: 0.6; }
        .button-like { background-color: #2196F3; }
        .button-like:hover { background-color: #1976D2; }
        input[type="file"] { display: none; }
        #imagePreview { display: none; max-width: 100%; height: auto; margin-top: 15px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #444; }
        #status { margin-top: 15px; font-weight: bold; text-align: center; padding: 10px; border-radius: 4px; background-color: #333; min-height: 20px; color: #ccc; word-wrap: break-word; }
        .spinner { display: none; width: 40px; height: 40px; margin: 20px auto; border: 4px solid #555; border-top: 4px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .warning { color: #ffcc00; background-color: #4d3d00; border: 1px solid #ffcc00; padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; font-weight: bold; }
        details { background-color: #333; padding: 5px; border-radius: 4px; margin-top: 15px;}
        details summary { cursor: pointer; color: #aaa; font-size: 0.9em; }
        #debug-info { margin-top: 10px; border: 1px dashed #555; padding: 10px; font-size: 0.8em; white-space: pre-wrap; word-wrap: break-word; max-height: 200px; overflow-y: auto; background-color: #222; color: #bbb; }
        #relay-list { font-size: 0.8em; margin-top: 5px; max-height: 100px; overflow-y: auto; padding-left: 15px; color: #aaa; }
        #relay-list li { margin-bottom: 3px; }

        /* Profile & Message Area Styles */
        #profile-display { display: flex; align-items: center; padding: 10px; margin-bottom: 15px; background-color: #383838; border-radius: 5px; min-height: 50px; color: #ccc; font-size: 0.9em; }
        #profile-display img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; border: 1px solid #555; object-fit: cover; }
        #profile-info { display: flex; flex-direction: column; }
        #profile-info span { display: block; }
        #profile-info .profile-name { font-weight: bold; color: #eee; }
        #profile-info .profile-nip05 { font-size: 0.85em; color: #aaa; }
        #message-section { margin-top: 20px; padding: 15px; background-color: #333; border-radius: 5px; display: none; }
        #message-section h2 { margin-top: 0; font-size: 1.1em; color: #ddd; border-bottom: 1px solid #555; padding-bottom: 5px;}
        #message-navigation { display: flex; justify-content: space-between; margin-bottom: 15px; }
        #message-navigation button { width: auto; padding: 8px 12px; font-size: 0.9em; background-color: #555; flex-grow: 1; margin: 0 5px; } /* Style nav buttons */
        #message-navigation button:first-child { margin-left: 0; }
        #message-navigation button:last-child { margin-right: 0; }
        #message-navigation button:hover:not(:disabled) { background-color: #666; }
        #last-message-area, #replies-area { margin-top: 10px; }
        .message-item, .reply-item { background-color: #2a2a2a; border: 1px solid #444; padding: 10px; border-radius: 4px; margin-bottom: 10px; word-wrap: break-word; }
        .message-content img, .reply-content img { max-width: 100%; height: auto; border-radius: 4px; margin-top: 5px; }
        .reply-author { font-size: 0.85em; color: #aaa; margin-bottom: 5px; }
        .reply-author code { background-color: #444; padding: 1px 3px; border-radius: 3px;}
        .reply-content { font-size: 0.95em; color: #ddd;}
        #replies-list { padding-left: 0; list-style: none; }
        .back-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }

        .back-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>UPlanet Geo Message</h1>
        <button class="back-button" id="back-button">&lt;</button>
        <script>
        document.getElementById('back-button').addEventListener('click', function() {
            window.location.href = '/scan';
        });
        </script>
        <div id="profile-display"><span>Loading profile...</span></div>
        <div id="nsec-warning" class="warning" style="display: none;">
             ‚ö†Ô∏è WARNING: You are publishing message on UPlanet
        </div>
        <button id="connectButton" disabled>Connect with Nostr</button>
        <label for="message">Message:</label>
        <textarea id="message" placeholder="Write your message here..."></textarea>
        <label for="imageInput" class="button-like">üì∏ Select Photo</label>
        <input type="file" id="imageInput" accept="image/*">
        <img id="imagePreview" src="#" alt="Image Preview"/>
        <button id="postButton" disabled>üìç Post with Location</button>
        <div class="spinner" id="loadingSpinner"></div>
        <div id="status">Initializing...</div>

        <!-- Message Section -->
        <div id="message-section">
            <h2>Notes Feed</h2>
            <!-- Navigation Buttons -->
            <div id="message-navigation">
                <button id="older-button" disabled> < </button>
                <button id="refresh-button">___</button>
                <button id="newer-button" disabled> > </button>
            </div>
            <div id="last-message-area">Loading messages...</div>
            <div id="replies-area">
                <h3>Replies</h3>
                <ul id="replies-list"><li>Select a message to see replies...</li></ul>
            </div>
        </div>

        <details>
            <summary>Show Relays & Debug</summary>
            <div id="relay-list-container" style="margin-top: 10px;">
                <span style="font-size: 0.9em; color: #bbb;">Publishing to:</span>
                <ul id="relay-list"><li>Loading relays...</li></ul>
            </div>
            <div id="debug-info"></div>
        </details>
    </div>

    <script>
        // --- Configuration ---
        const userNsec = ''; // Leave empty for extension
        const MESSAGES_PER_PAGE = 10; // How many messages to fetch at once

        // --- Global Variables ---
        let debugInfo = '';
        let nostrExtensionAvailable = false;
        let privateKeyHex = null;
        let publicKey = '';
        let userProfile = null;
        let fetchedMessages = []; // Store the batch of fetched messages
        let currentMessageIndex = 0; // Index of the currently displayed message
        let pool = null;
        let selectedImageDataUrl = null;
        let currentLatitude = null;
        let currentLongitude = null;
        const DEFAULT_RELAYS = ['wss://relay.copylaradio.com', 'ws://127.0.0.1:7777'];
        let allRelaysToPublish = [...DEFAULT_RELAYS];

        // --- Helper Functions ---
        function log(message) { console.log(message); const ts = new Date().toLocaleTimeString(); debugInfo += `[${ts}] ${message}\n`; const lines = debugInfo.split('\n'); if (lines.length > 150) debugInfo = lines.slice(-150).join('\n'); $('#debug-info').text(debugInfo); const el = document.getElementById('debug-info'); if (el) el.scrollTop = el.scrollHeight; }
        function updateStatus(message, isError = false, isSuccess = false) { log(`Status Update: ${message}`); const el = $('#status'); el.text(message); let bg = '#333', fg = '#ccc'; if (isError) { bg = '#5c3a3a'; fg = '#ff6b6b'; } else if (isSuccess) { bg = '#3a5c3a'; fg = '#90ee90'; } el.css({ 'background-color': bg, 'color': fg }); }
        function showLoading(show) { $('#loadingSpinner').toggle(show); $('#postButton').prop('disabled', show || !publicKey); }
        function getRelayURL() { const u = new URL(window.location.href); let r = u.hostname.replace(/^u\./, 'relay.'); if (u.port === '54321' || ['localhost', '127.0.0.1'].includes(u.hostname)) return `ws://127.0.0.1:7777`; return `wss://${r}`; }
        function updateRelayListUI() { const l = $('#relay-list').empty(); if (allRelaysToPublish.length > 0) allRelaysToPublish.forEach(r => $('<li>').text(r).appendTo(l)); else $('<li>').text("No relays configured!").appendTo(l); log(`UI updated: ${allRelaysToPublish.length} relays.`); }

        // --- Nostr Interaction Functions ---
        function getNostrPool() { if (!pool) { if (typeof NostrTools?.SimplePool !== 'function') { const m = "Error: NostrTools.SimplePool undef/not func!"; log(m); console.error(m, "NostrTools:", NostrTools); updateStatus(m, true); throw new Error(m); } try { log("Init SimplePool..."); pool = new NostrTools.SimplePool({ getTimeout: 6000, listTimeout: 6000 }); if (typeof pool?.list !== 'function' || typeof pool?.get !== 'function') { log("Error: Pool missing methods."); console.error("Bad pool:", pool); pool = null; throw new Error("Pool invalid."); } log("Pool init OK."); } catch (e) { log(`Pool init error: ${e.message}`); console.error("Pool Init Details:", e); updateStatus("Fail pool init.", true); throw e; } } if (!pool) { const m = "Error: Pool null after init."; log(m); updateStatus("Relay pool N/A.", true); throw new Error(m); } return pool; }
        async function fetchProfileAndRelays(pubkey) { log(`Fetching profile/relays for ${pubkey.slice(0,10)}...`); let nostrPool; try { nostrPool = getNostrPool(); } catch (e) { log("Pool fail in fetchProfileRelays."); return {}; } let profileEv = null, relayEv = null, userRelays = []; try { log("Pool obj before list:", nostrPool); console.dir(nostrPool); const evs = await nostrPool.list(DEFAULT_RELAYS, [{ kinds: [0], authors: [pubkey], limit: 1 }, { kinds: [10002], authors: [pubkey], limit: 1 }]); evs.forEach(e => { if (e.kind === 0 && (!profileEv || e.created_at > profileEv.created_at)) profileEv = e; if (e.kind === 10002 && (!relayEv || e.created_at > relayEv.created_at)) relayEv = e; }); if (profileEv) { log(`Profile ev: ${profileEv.id}`); try { userProfile = JSON.parse(profileEv.content); } catch (e) { log(`Profile parse err: ${e.message}`); userProfile = {}; } } else { log(`No profile ev.`); userProfile = {}; } if (relayEv) { log(`Relay list ev: ${relayEv.id}`); userRelays = relayEv.tags.filter(t => t[0] === 'r' && typeof t[1] === 'string' && t[1].startsWith('wss://')).map(t => t[1]); log(`Extracted ${userRelays.length} relays.`); } else log(`No relay list ev.`); } catch (e) { log(`Error fetching profile/relays: ${e}`); console.error("Fetch Profile/Relay Err:", e); updateStatus('Error fetch profile/relay.', true); userProfile = {}; } const dyn = getRelayURL(); const comb = new Set([...DEFAULT_RELAYS, dyn, ...userRelays]); allRelaysToPublish = [...comb]; updateRelayListUI(); renderProfile(pubkey, userProfile); return userProfile; }
        function renderProfile(pubkey, profileData) { const div = $('#profile-display').empty(); const defPic = 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1'; const pic = profileData?.picture || defPic; const name = profileData?.display_name || profileData?.name || pubkey.slice(0, 16); const nip05 = profileData?.nip05 || ''; $('<img>').attr('src', pic).on('error', function() { $(this).attr('src', defPic); }).appendTo(div); const infoDiv = $('<div>').attr('id', 'profile-info').appendTo(div); $('<span>').addClass('profile-name').text(name).appendTo(infoDiv); if (nip05) $('<span>').addClass('profile-nip05').text(nip05).appendTo(infoDiv); }

        // Fetch and display a batch of messages
        async function fetchAndDisplayMessages(pubkey) {
            log(`Fetching batch of messages (limit ${MESSAGES_PER_PAGE}) for ${pubkey.slice(0, 10)}...`);
            $('#message-section').show();
            const messageArea = $('#last-message-area').html('<i>Loading messages...</i>');
            const repliesList = $('#replies-list').empty().html('<li><i>Select a message...</i></li>');
            $('#older-button').prop('disabled', true);
            $('#newer-button').prop('disabled', true);
            fetchedMessages = []; // Clear previous batch
            currentMessageIndex = 0;

            let nostrPool;
             try {
                 nostrPool = getNostrPool();
             } catch (e) {
                 log("Failed to get Nostr pool in fetchAndDisplayMessages.");
                 messageArea.html('<i>Error initializing relay pool.</i>');
                 return;
             }

            try {
                log("Pool object before list call in fetchAndDisplayMessages:", nostrPool);
                console.dir(nostrPool);

                const events = await nostrPool.list(allRelaysToPublish, [{
                    kinds: [1],
                    authors: [pubkey],
                    limit: MESSAGES_PER_PAGE
                }]);

                if (events.length > 0) {
                    log(`Fetched ${events.length} messages.`);
                    // Sort newest first
                    fetchedMessages = events.sort((a, b) => b.created_at - a.created_at);
                    displayMessageAtIndex(0); // Display the first (newest) message
                } else {
                    log('No messages found for this user.');
                    messageArea.html('<i>No messages found.</i>');
                     $('#replies-list').empty().html('<li><i>N/A</i></li>');
                     // Keep buttons disabled
                }
            } catch (error) {
                log(`Error fetching messages: ${error}`);
                console.error("Fetch Messages Error Details:", error);
                messageArea.html('<i>Error loading messages.</i>');
                 $('#replies-list').empty().html('<li><i>Error loading replies.</i></li>');
            }
        }

        // Display message at a specific index and update controls
        function displayMessageAtIndex(index) {
             log(`Displaying message at index: ${index}`);
             const messageArea = $('#last-message-area');
             const repliesList = $('#replies-list');

             if (index < 0 || index >= fetchedMessages.length) {
                 log(`Index ${index} out of bounds (0-${fetchedMessages.length - 1}).`);
                 messageArea.html(`<i>Invalid message index: ${index}</i>`);
                 repliesList.empty().html('<li><i>N/A</i></li>');
                 // Update button states based on potential valid range
                 $('#newer-button').prop('disabled', fetchedMessages.length === 0 || currentMessageIndex <= 0);
                 $('#older-button').prop('disabled', fetchedMessages.length === 0 || currentMessageIndex >= fetchedMessages.length - 1);
                 return;
             }

             currentMessageIndex = index;
             const currentMessage = fetchedMessages[currentMessageIndex];
             renderMessage(messageArea, currentMessage);
             fetchAndDisplayReplies(currentMessage.id); // Fetch replies for the current message

             // Update navigation buttons
             $('#newer-button').prop('disabled', currentMessageIndex <= 0);
             $('#older-button').prop('disabled', currentMessageIndex >= fetchedMessages.length - 1);
             log(`Navigation updated: Newer ${$('#newer-button').prop('disabled')}, Older ${$('#older-button').prop('disabled')}`);
        }

        // Render a single message
        function renderMessage(container, event) { container.empty(); const item = $('<div>').addClass('message-item').appendTo(container); const contentDiv = $('<div>').addClass('message-content').appendTo(item); const lines = event.content.split('\n'); lines.forEach((line, i) => { const trimmed = line.trim(); if (/\.(jpg|jpeg|png|gif|webp)$/i.test(trimmed)) $('<img>').attr('src', trimmed).appendTo(contentDiv); else if (/^https?:\/\//.test(trimmed)) $('<a>').attr({href: trimmed, target: '_blank'}).text(trimmed).appendTo(contentDiv); else contentDiv.append(document.createTextNode(line)); if (i < lines.length - 1) contentDiv.append('<br>'); }); $('<div>').css({fontSize:'0.8em',color:'#888',marginTop:'5px'}).text(`Note ${currentMessageIndex + 1}/${fetchedMessages.length} | ID: ${event.id.slice(0,10)}... At: ${new Date(event.created_at*1000).toLocaleString()}`).appendTo(item); }

        // Fetch and display replies
        async function fetchAndDisplayReplies(eventId) {
            log(`Fetching replies for event ${eventId.slice(0, 10)}...`);
            const list = $('#replies-list').empty().html('<li><i>Loading replies...</i></li>'); if (!eventId) { list.html('<li><i>No parent ID.</i></li>'); return; }
            let nostrPool; try { nostrPool = getNostrPool(); } catch (e) { log("Pool fail in fetchReplies."); list.html('<li><i>Relay pool error.</i></li>'); return; }
            try { log("Pool object before list call in fetchReplies:", nostrPool); console.dir(nostrPool); const replies = await nostrPool.list(allRelaysToPublish, [{ kinds: [1], '#e': [eventId], limit: 20 }]); if (replies.length > 0) { log(`Found ${replies.length} replies.`); list.empty(); replies.sort((a, b) => a.created_at - b.created_at).forEach(r => renderReply(list, r)); } else { log('No replies found.'); list.html('<li><i>No replies yet.</i></li>'); } } catch (e) { log(`Error fetching replies: ${e}`); list.html('<li><i>Error loading replies.</i></li>'); }
        }

        // Render a single reply
        function renderReply(list, event) { const item = $('<li>').addClass('reply-item').appendTo(list); const authorP = $('<p>').addClass('reply-author').appendTo(item); authorP.append('Reply by: '); $('<code>').text(event.pubkey.slice(0, 10) + '...').appendTo(authorP); authorP.append(` at ${new Date(event.created_at * 1000).toLocaleTimeString()}`); const contentDiv = $('<div>').addClass('reply-content').appendTo(item); const lines = event.content.split('\n'); lines.forEach((line, i) => { const trimmed = line.trim(); if (/\.(jpg|jpeg|png|gif|webp)$/i.test(trimmed)) $('<img>').attr('src', trimmed).appendTo(contentDiv); else if (/^https?:\/\//.test(trimmed)) $('<a>').attr({href: trimmed, target: '_blank'}).text(trimmed).appendTo(contentDiv); else contentDiv.append(document.createTextNode(line)); if (i < lines.length - 1) contentDiv.append('<br>'); }); }

        // checkNostrExtension, connectToNostr
        function checkNostrExtension() { log('Checking extension...'); if (typeof window.nostr !== 'undefined') { nostrExtensionAvailable = true; log('Extension OK.'); $('#connectButton').prop('disabled', false).text('Connect'); updateStatus('Extension ready.'); } else { nostrExtensionAvailable = false; log('Extension fail.'); $('#connectButton').prop('disabled', true).text('Extension Needed'); updateStatus('Extension not found or NSEC needed.', true); } }
        async function connectToNostr() { if (!nostrExtensionAvailable) return; log('Connecting via extension...'); updateStatus('Connecting extension...'); $('#connectButton').prop('disabled', true); try { publicKey = await window.nostr.getPublicKey(); log(`Ext connected. Pubkey: ${publicKey.slice(0, 10)}...`); $('#connectButton').hide(); $('#postButton').prop('disabled', false); updateStatus(`Ext Connected! ${publicKey.slice(0, 10)}...`, false, true); await fetchProfileAndRelays(publicKey); await fetchAndDisplayMessages(publicKey); } catch (e) { log(`Ext connection fail: ${e.message || e}`); updateStatus(`Ext connect failed.`, true); $('#connectButton').prop('disabled', false).show(); publicKey = ''; } }

        // handleImageSelection, getLocation, uploadImageNip96, publishToRelay
        function handleImageSelection(event) { const f = event.target.files[0]; if (f) { log(`Image selected: ${f.name}, size: ${f.size}`); const r = new FileReader(); r.onload = (e) => { selectedImageDataUrl = e.target.result; $('#imagePreview').attr('src', selectedImageDataUrl).show(); log('Preview updated.'); }; r.onerror = (e) => { log(`File read error: ${e}`); updateStatus('Error reading image.', true); selectedImageDataUrl = null; $('#imagePreview').hide().attr('src', '#'); }; r.readAsDataURL(f); } else { log('No image selected.'); selectedImageDataUrl = null; $('#imagePreview').hide().attr('src', '#'); } }
        function getLocation() { return new Promise((resolve, reject) => { if (!navigator.geolocation) { const m = "Geolocation unsupported."; log(m); updateStatus(m, true); return reject(m); } log('Requesting location...'); updateStatus('Getting location...'); navigator.geolocation.getCurrentPosition( (p) => { currentLatitude = p.coords.latitude; currentLongitude = p.coords.longitude; log(`Location: Lat ${currentLatitude.toFixed(6)}, Lon ${currentLongitude.toFixed(6)}`); updateStatus(`Location: ${currentLatitude.toFixed(2)}, ${currentLongitude.toFixed(2)}`); resolve({ latitude: currentLatitude, longitude: currentLongitude }); }, (e) => { log(`Location error: ${e.message} (Code: ${e.code})`); const m = ["Permission denied.", "Position unavailable.", "Timeout."][e.code-1] || "Location error."; updateStatus(m, true); reject(m); }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 } ); }); }
        function uploadImageNip96(imageDataBase64) { return new Promise(async (resolve, reject) => { log("NIP-96 Upload start..."); const server = 'https://g1sms.fr'; const wk = `${server}/.well-known/nostr/nip96.json`; try { const cfg = await $.ajax({ url: wk, dataType: 'json' }); const ep = cfg.api_url; if (!ep) throw new Error("No api_url"); log(`NIP-96 EP: ${ep}`); const bs = atob(imageDataBase64.split(',')[1]); const mime = imageDataBase64.split(',')[0].split(':')[1].split(';')[0]; const ab = new ArrayBuffer(bs.length); const ia = new Uint8Array(ab); for (let i=0; i<bs.length; i++) ia[i]=bs.charCodeAt(i); const blob = new Blob([ab],{type:mime}); const file = new File([blob],`mobile-${Date.now()}.png`,{type:mime}); const fd = new FormData(); fd.append('file', file); log(`Uploading to ${ep}...`); const r = await $.ajax({ url: ep, type: 'POST', data: fd, processData: false, contentType: false }); log("NIP-96 Resp:", r); if (r?.status === "success" && r.nip94_event?.tags) { const ut = r.nip94_event.tags.find(t => t[0] === 'url'); const url = ut?.[1]; const tags = r.nip94_event.tags; const size = r.fileSize; if (url) { log(`Upload OK: ${url}, Size: ${size||'N/A'}`); resolve({ uploadedFileURL: url, nip94Tags: tags, fileSize: size }); } else throw new Error("No URL tag."); } else throw new Error(r?.message || "Invalid NIP-96 response."); } catch (e) { let m = e?.message || 'Unknown upload error'; if (e?.responseJSON?.message) m = e.responseJSON.message; else if (e?.statusText) m = `HTTP ${e.status}: ${e.statusText}`; log(`NIP-96 Err: ${m}`); console.error("NIP-96 Details:", e); reject(`Upload fail: ${m}`); } }); }
        async function publishToRelay(relayUrl, signedEvent) { return new Promise((resolve) => { log(`Publish to ${relayUrl}`); let ws = null; let timer = null; try { ws = new WebSocket(relayUrl); const close = (ok, msg) => { clearTimeout(timer); if (ws?.readyState === WebSocket.OPEN) ws.close(); log(msg); resolve(ok); }; ws.onopen = () => { log(`Connected ${relayUrl}. Send.`); ws.send(JSON.stringify(['EVENT', signedEvent])); timer = setTimeout(() => close(true, `Sent ${relayUrl}, no OK/Notice.`), 3000); }; ws.onmessage = (ev) => { try { const m = JSON.parse(ev.data); if (m[0]==='OK' && m[1]===signedEvent.id) close(true, `OK ${relayUrl}: ${m[1].slice(0,8)}...`); else if (m[0]==='NOTICE') { log(`NOTICE ${relayUrl}: ${m[1]}`); clearTimeout(timer); timer = setTimeout(() => close(true, `NOTICE ${relayUrl}, closing.`), 500); } } catch (e) { log(`Msg parse err ${relayUrl}: ${e.message}`); } }; ws.onerror = (e) => close(false, `Error ${relayUrl}: ${e.message || 'Unknown'}`); ws.onclose = (e) => { log(`Closed ${relayUrl}. Code: ${e.code}`); if (timer) { clearTimeout(timer); resolve(false); } }; timer = setTimeout(() => close(false, `Timeout ${relayUrl}`), 7000); } catch (e) { log(`Connect err ${relayUrl}: ${e.message}`); resolve(false); } }); }

        // postNostrEvent
        async function postNostrEvent() { if (!publicKey) { updateStatus("Not connected.", true); return; } const msg = $('#message').val().trim(); if (!msg && !selectedImageDataUrl) { updateStatus("Need message or image.", true); return; } showLoading(true); updateStatus("Starting post..."); try { const loc = await getLocation(); const lat = loc.latitude.toFixed(2); const lon = loc.longitude.toFixed(2); let content = msg; let tags = [['application', 'UPlanet'], ['latitude', lat], ['longitude', lon], ['g', `${lat};${lon}`]]; if (selectedImageDataUrl) { updateStatus("Uploading image..."); try { const up = await uploadImageNip96(selectedImageDataUrl); content += `\n${up.uploadedFileURL}`; if (up.nip94Tags) tags = tags.concat(up.nip94Tags.filter(t => Array.isArray(t) && t.length >= 2)); if (up.fileSize != null) tags.push(['fileSize', String(up.fileSize)]); updateStatus("Image uploaded.", false, true); } catch (e) { updateStatus(`Upload failed: ${e}. Posting text only.`, true); } } const event = { kind: 1, pubkey: publicKey, created_at: Math.floor(Date.now() / 1000), tags: tags, content: content }; log("Unsigned event:"); console.log(JSON.stringify(event, null, 2)); let signedEvent; if (privateKeyHex) { if (typeof NostrTools === 'undefined') throw new Error("NostrTools missing."); log("Signing locally..."); updateStatus("Signing locally..."); event.id = NostrTools.getEventHash(event); event.sig = NostrTools.getSignature(event, privateKeyHex); signedEvent = event; log(`Signed locally. ID: ${signedEvent.id}`); updateStatus("Signed. Publishing..."); } else if (window.nostr) { updateStatus("Confirm in extension..."); log("Requesting signature via extension..."); signedEvent = await window.nostr.signEvent(event); log(`Signed via extension. ID: ${signedEvent.id}`); updateStatus("Signed. Publishing..."); } else throw new Error("Cannot sign."); log(`Publishing to ${allRelaysToPublish.length} relays...`); updateRelayListUI(); let success = 0; const results = await Promise.all(allRelaysToPublish.map(r => publishToRelay(r, signedEvent))); success = results.filter(Boolean).length; log(`Published. Success: ${success}/${allRelaysToPublish.length}`); if (success > 0) { updateStatus(`Published to ${success}/${allRelaysToPublish.length}. ID: ${signedEvent.id.slice(0,10)}...`, false, true); $('#message').val(''); $('#imageInput').val(''); $('#imagePreview').hide().attr('src', '#'); selectedImageDataUrl = null; log("Scheduling message refresh..."); /* Refresh message list after delay */ setTimeout(() => { log("Refreshing messages..."); fetchAndDisplayMessages(publicKey); }, 4000); } else updateStatus(`Failed to publish to any relays.`, true); } catch (e) { log(`Post error: ${e?.message || e}`); console.error("Post Details:", e); updateStatus(`Error: ${e?.message || 'Unknown error'}`, true); } finally { showLoading(false); } }

        // --- Initialization ---
        async function initializeApp() {
            log('initializeApp called.');
            if (userNsec) {
                log("NSEC provided. Init local key.");
                 if (typeof NostrTools === 'undefined') { updateStatus("Error: NostrTools unloaded.", true); log("Fatal: NostrTools missing."); return; }
                try {
                    const decoded = NostrTools.nip19.decode(userNsec);
                    if (decoded.type !== 'nsec' || !decoded.data) throw new Error('Invalid NSEC format');
                    privateKeyHex = decoded.data; publicKey = NostrTools.getPublicKey(privateKeyHex);
                    log(`Init NSEC OK. Pubkey: ${publicKey.slice(0, 10)}...`); updateStatus(`Using NSEC key. Pubkey: ${publicKey.slice(0, 10)}...`, false, true);
                    $('#connectButton').hide(); $('#postButton').prop('disabled', false);
                    await fetchProfileAndRelays(publicKey);
                    await fetchAndDisplayMessages(publicKey); // Fetch initial batch
                } catch (e) {
                    log(`Error initializing NSEC: ${e.message}. Falling back.`); updateStatus('Error NSEC. Trying extension...', true);
                    privateKeyHex = null; publicKey = ''; $('#nsec-warning').hide();
                    updateStatus("Checking extension (fallback)...");
                    setTimeout(() => { log("Executing delayed check (fallback)."); checkNostrExtension(); }, 500);
                }
            } else {
                log("No NSEC. Scheduling extension check..."); $('#nsec-warning').hide(); updateStatus("Checking extension...");
                setTimeout(() => { log("Executing delayed check."); checkNostrExtension(); }, 500);
            }
            updateRelayListUI();
        }

        $(document).ready(function() {
            log('Document ready.');
            // Setup common event listeners immediately
            $('#connectButton').on('click', connectToNostr);
            $('#imageInput').on('change', handleImageSelection);
            $('#postButton').on('click', postNostrEvent);
            $('#refresh-button').on('click', () => {
                if (publicKey) {
                    log("Refresh button clicked.");
                    updateStatus("Refreshing messages...");
                    fetchAndDisplayMessages(publicKey);
                } else {
                    log("Refresh clicked, but no public key.");
                    updateStatus("Please connect first.", true);
                }
            });
            $('#older-button').on('click', () => {
                log("Older button clicked.");
                if (currentMessageIndex < fetchedMessages.length - 1) {
                    displayMessageAtIndex(currentMessageIndex + 1);
                } else {
                    log("Already at the oldest fetched message.");
                    // TODO: Implement fetching older messages (pagination) if needed
                }
            });
            $('#newer-button').on('click', () => {
                 log("Newer button clicked.");
                 if (currentMessageIndex > 0) {
                     displayMessageAtIndex(currentMessageIndex - 1);
                 } else {
                     log("Already at the newest fetched message.");
                 }
            });
            $('#debug-info').hide(); $('details summary').on('click', () => setTimeout(() => log(`Debug visibility: ${$('#debug-info').is(':visible')}`), 0));

            // --- Conditional Initialization ---
            if (userNsec) {
                log("NSEC configured. Waiting for NostrTools..."); updateStatus("Loading crypto library...");
                let attempts = 0; const maxAttempts = 50; const intervalId = setInterval(() => { attempts++; if (typeof NostrTools !== 'undefined') { clearInterval(intervalId); log("NostrTools library loaded."); initializeApp(); } else if (attempts >= maxAttempts) { clearInterval(intervalId); log("Error: NostrTools timeout."); updateStatus("Error loading crypto library.", true); } else { /* log(`Waiting NostrTools... (${attempts})`); */ } }, 100);
            } else {
                log("No NSEC configured. Initializing normally."); initializeApp();
            }
        });
    </script>
</body>
</html>
