<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <link rel="icon" type="image/x-icon" href="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1">
    <title>ü§ñ #BRO Terminal</title>
    <script src="/earth/jquery-3.6.3.min.js"></script>
    <script src="/earth/nostr.bundle.js"></script>
    <script src="/earth/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="/earth/bootstrap.min.css"/>
    <link rel="stylesheet" href="/earth/leaflet.css"/>
    <script src="/earth/leaflet.js"></script>
    <!-- YouTube Enhancements for advanced Tube features -->
    <script src="/earth/youtube.enhancements.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-void: #0a0a0f;
            --bg-panel: #12141a;
            --bg-input: #1a1d24;
            --bg-hover: #22262f;
            --text-primary: #e0e6ed;
            --text-dim: #5a6270;
            --accent-cyan: #00d4ff;
            --accent-green: #00ff88;
            --accent-orange: #ff9500;
            --accent-purple: #9966ff;
            --accent-red: #ff4466;
            --border: rgba(0, 212, 255, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg-void);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }

        /* === TOP BAR === */
        .top-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .top-bar.with-banner {
            background-size: cover;
            background-position: center;
            min-height: 50px;
        }

        .top-bar.with-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to right, rgba(10, 10, 15, 0.9), rgba(10, 10, 15, 0.6), rgba(10, 10, 15, 0.9));
            z-index: 0;
        }

        .top-bar > * {
            position: relative;
            z-index: 1;
        }

        /* ZEN Balance display */
        .zen-balance {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 212, 255, 0.1));
            border: 1px solid var(--accent-green);
            border-radius: 12px;
            font-size: 0.7rem;
            color: var(--accent-green);
            font-weight: 600;
            margin-left: auto;
            white-space: nowrap;
        }

        .zen-balance .zen-icon {
            font-size: 0.8rem;
        }

        .zen-balance .zen-amount {
            color: var(--text-primary);
        }

        .zen-balance .zencard-icon {
            margin-left: 4px;
            color: var(--accent-purple);
            font-size: 0.9rem;
            cursor: help;
        }

        .zen-balance.loading {
            opacity: 0.6;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-cyan);
            cursor: pointer;
        }

        .profile-mini {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            padding: 3px 8px;
            background: var(--bg-input);
            border-radius: 12px;
            font-size: 0.7rem;
        }

        .profile-mini img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--border);
        }

        .profile-mini .name {
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-dim);
        }

        .profile-mini.connected .name { color: var(--accent-green); }

        .btn-connect {
            padding: 4px 10px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 10px;
            color: var(--bg-void);
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-connect:disabled { background: var(--bg-hover); color: var(--text-dim); }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .status-dot.offline { background: var(--accent-red); animation: none; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* === SERVICE TABS === */
        .service-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        /* Main tabs */
        .svc-tab {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            color: var(--text-dim);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .svc-tab:hover { 
            background: var(--bg-hover); 
            color: var(--text-primary); 
        }

        .svc-tab.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 255, 136, 0.1));
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        .dropdown-arrow {
            font-size: 0.6rem;
            margin-left: 4px;
            transition: transform 0.2s;
        }

        .svc-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* Dropdown container */
        .svc-dropdown {
            position: relative;
        }

        .svc-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px;
            display: none;
            flex-direction: column;
            gap: 2px;
            min-width: 140px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .svc-dropdown.open .svc-dropdown-menu {
            display: flex;
        }

        .svc-sub {
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.15s;
        }

        .svc-sub:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .svc-sub.active {
            background: rgba(0, 212, 255, 0.15);
            color: var(--accent-cyan);
        }

        .svc-sub .svc-count {
            margin-left: auto;
            padding: 2px 6px;
            background: var(--bg-hover);
            border-radius: 10px;
            font-size: 0.6rem;
            color: var(--accent-cyan);
        }

        /* Tab count badge */
        .svc-tab[data-count]:not([data-count=""])::after {
            content: attr(data-count);
            margin-left: 6px;
            padding: 1px 5px;
            background: var(--accent-cyan);
            color: var(--bg-void);
            border-radius: 8px;
            font-size: 0.55rem;
            font-weight: 700;
        }

        /* Add button */
        .svc-btn.add-btn {
            padding: 6px 10px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            color: var(--bg-void);
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            margin-left: auto;
            transition: all 0.2s;
        }

        .svc-btn.add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        }

        /* Compact on small screens */
        @media (max-width: 420px) {
            .svc-tab {
                padding: 6px 10px;
                font-size: 0.65rem;
            }
            .svc-btn.add-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
        }

        .svc-btn .count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-purple);
            color: white;
            font-size: 0.5rem;
            padding: 1px 4px;
            border-radius: 6px;
            min-width: 14px;
            text-align: center;
        }

        /* === MAIN CONTENT WITH NAV ARROWS === */
        .main-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* Navigation arrows on sides */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 80px;
            background: linear-gradient(90deg, rgba(0,212,255,0.1), rgba(0,212,255,0.3));
            border: none;
            color: var(--accent-cyan);
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
                justify-content: center;
            transition: all 0.2s;
        }

        .nav-arrow:hover { background: linear-gradient(90deg, rgba(0,212,255,0.2), rgba(0,212,255,0.5)); }
        .nav-arrow:disabled { opacity: 0.2; cursor: default; }

        .nav-arrow.left {
            left: 0;
            border-radius: 0 8px 8px 0;
        }

        .nav-arrow.right {
            right: 0;
            border-radius: 8px 0 0 8px;
        }

        /* Chat area between arrows */
        .chat-wrapper {
            flex: 1;
            display: flex;
                flex-direction: column;
            margin: 0 45px;
            overflow: hidden;
            transition: margin 0.2s;
        }

        /* Flux mode - full width, no arrows */
        .main-content.flux-mode .chat-wrapper {
            margin: 0 10px;
        }

        .main-content.flux-mode .nav-arrow {
            display: none;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
                gap: 8px;
            }

        .chat-area::-webkit-scrollbar { width: 4px; }
        .chat-area::-webkit-scrollbar-track { background: var(--bg-panel); }
        .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* Flux mode - vertical feed styling */
        .main-content.flux-mode .chat-area {
            gap: 12px;
            padding: 12px;
        }

        .main-content.flux-mode .msg {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .main-content.flux-mode .msg-counter {
            display: none;
        }

        /* Message counter */
        .msg-counter {
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-dim);
            padding: 4px;
            background: var(--bg-panel);
            border-radius: 4px;
            margin-bottom: 6px;
        }

        .msg {
            padding: 10px 12px;
            background: var(--bg-panel);
            border-radius: 8px;
            border-left: 3px solid var(--text-dim);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .msg.user { border-left-color: var(--accent-cyan); }
        .msg.bot {
            border-left-color: var(--accent-green);
            background: linear-gradient(90deg, rgba(0,255,136,0.05), transparent);
        }

        .msg-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .msg-header .tag {
            padding: 2px 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            font-size: 0.6rem;
        }

        .msg-header .tag.video { color: var(--accent-red); }
        .msg-header .tag.image { color: var(--accent-purple); }
        .msg-header .tag.music { color: var(--accent-orange); }
        .msg-header .tag.search { color: var(--accent-green); }

        .msg-content { word-break: break-word; }
        .msg-content a { color: var(--accent-cyan); text-decoration: none; }
        .msg-content a:hover { text-decoration: underline; }

        .msg-media {
            margin-top: 8px;
            border-radius: 6px;
            overflow: hidden;
            background: var(--bg-void);
        }

        .msg-media img, .msg-media video {
            max-width: 100%;
            max-height: 250px;
            display: block;
            cursor: pointer;
        }

        .msg-media audio { width: 100%; height: 36px; }

        .msg-time {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 6px;
            text-align: right;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
                justify-content: center;
            color: var(--text-dim);
            font-size: 0.85rem;
            text-align: center;
            padding: 20px;
        }

        .empty-state .icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; }

        /* === INPUT SECTION (below chat) === */
        .input-section {
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 10px;
            flex-shrink: 0;
        }

        .input-options {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .opt-btn {
            padding: 4px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s;
        }

        .opt-btn:hover { border-color: var(--accent-cyan); color: var(--text-primary); }
        .opt-btn.active { background: var(--accent-cyan); color: var(--bg-void); border-color: var(--accent-cyan); }
        .opt-btn.warn.active { background: var(--accent-orange); border-color: var(--accent-orange); }

        .sub-options {
            display: none;
            gap: 4px;
            margin-left: auto;
        }

        .sub-options.visible { display: flex; }

        .sub-opt {
            padding: 3px 8px;
            background: var(--bg-hover);
            border: 1px solid transparent;
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 0.65rem;
            cursor: pointer;
        }

        .sub-opt:hover { border-color: var(--border); }
        .sub-opt.active { border-color: var(--accent-cyan); color: var(--accent-cyan); }

        .img-preview-wrap {
            display: none;
            position: relative;
            margin-bottom: 8px;
        }

        .img-preview-wrap.visible { display: inline-block; }

        .img-preview-wrap img {
            max-height: 60px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .img-preview-wrap .remove {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: var(--accent-red);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            line-height: 1;
        }

        .input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            padding: 12px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            resize: none;
            min-height: 50px;
            max-height: 150px;
        }

        #messageInput:focus { outline: none; border-color: var(--accent-cyan); }
        #messageInput::placeholder { color: var(--text-dim); }

        .btn-send {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-send:hover { opacity: 0.9; }
        .btn-send:disabled { background: var(--bg-hover); color: var(--text-dim); }

        .hint {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 6px;
        }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px;
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .loading.visible { display: flex; }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-hover);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* === SETTINGS === */
        .settings-panel {
            display: none;
            padding: 10px;
            background: var(--bg-input);
            border-top: 1px solid var(--border);
        }

        .settings-panel.open { display: block; }

        .settings-row {
                    display: flex;
                    align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.7rem;
            flex-wrap: wrap;
        }

        .settings-row label { color: var(--text-dim); }

        .settings-row input[type="number"] {
            width: 70px;
            padding: 4px 6px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
                    border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.7rem;
        }

        .toggle-switch {
            width: 32px;
            height: 18px;
            background: var(--bg-panel);
            border-radius: 9px;
            cursor: pointer;
            position: relative;
        }

        .toggle-switch.on { background: var(--accent-cyan); }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle-switch.on::after { transform: translateX(14px); }

        #mini-map { height: 100px; border-radius: 4px; margin-top: 8px; }

        /* === LIGHTBOX === */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
                    align-items: center;
        }

        .lightbox.active { display: flex; }
        .lightbox img { max-width: 95%; max-height: 95%; object-fit: contain; }

        .lightbox-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hidden { display: none !important; }

        /* === TUBE MODE === */
        .tube-panel {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow: hidden;
        }

        .tube-panel.active { display: flex; }

        .tube-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .tube-header h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            margin: 0;
        }

        .tube-filters {
            display: flex;
            gap: 6px;
            margin-left: auto;
            align-items: center;
        }

        .tube-filter-btn {
            padding: 4px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .tube-filter-btn:hover { border-color: var(--accent-cyan); color: var(--text-primary); }
        .tube-filter-btn.active { background: var(--accent-cyan); color: var(--bg-void); border-color: var(--accent-cyan); }

        .tube-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Friends sidebar */
        .friends-sidebar {
            width: 140px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .friends-sidebar.collapsed { width: 0; border: none; overflow: hidden; }

        .friends-header {
            padding: 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.7rem;
        }

        .friend-item:hover { background: var(--bg-hover); }
        .friend-item.selected { background: rgba(0,212,255,0.15); border: 1px solid var(--accent-cyan); }
        .friend-item.all { color: var(--accent-cyan); font-weight: 600; }

        .friend-item img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid var(--border);
            object-fit: cover;
        }

        .friend-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-primary);
        }

        .friend-item .count {
            font-size: 0.55rem;
            color: var(--text-dim);
            background: var(--bg-input);
            padding: 1px 4px;
            border-radius: 6px;
        }

        /* Video grid */
        .video-grid-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        @media (max-width: 600px) {
            .video-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
            .friends-sidebar { width: 100px; }
        }

        .video-card {
            background: var(--bg-panel);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .video-card:hover { border-color: var(--accent-cyan); transform: translateY(-2px); }

        .video-thumbnail {
            position: relative;
            aspect-ratio: 16/9;
            background: var(--bg-void);
            overflow: hidden;
        }

        .video-thumbnail img.thumb-static {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.2s;
        }

        .video-thumbnail .thumb-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 2rem;
            background: var(--bg-panel);
            color: var(--text-dim);
        }

        .video-thumbnail img.gifanim {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1;
        }

        .video-card:hover .video-thumbnail img.gifanim {
            opacity: 1;
        }

        .video-card:hover .video-thumbnail img.thumb-static {
            opacity: 0;
        }

        .video-thumbnail .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: white;
            text-shadow: 0 2px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
        }

        .video-card:hover .video-thumbnail .play-icon { opacity: 1; }

        .video-thumbnail .duration {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6rem;
        }

        .video-thumbnail .badge-ai {
            position: absolute;
            top: 4px;
            left: 4px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            color: white;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 0.55rem;
            font-weight: 600;
        }

        .video-info {
            padding: 8px;
        }

        .video-info .title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .video-info .meta {
            font-size: 0.6rem;
            color: var(--text-dim);
                    display: flex;
            gap: 6px;
            align-items: center;
        }

        .video-info .meta .author {
                    display: flex;
                    align-items: center;
            gap: 3px;
        }

        .video-info .meta .author img {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .tube-empty {
                    display: flex;
                    flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-dim);
            text-align: center;
        }

        .tube-empty .icon { font-size: 2rem; opacity: 0.4; margin-bottom: 8px; }

        .tube-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            color: var(--text-dim);
        }

        .tube-loading .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toggle friends sidebar on mobile */
        .toggle-friends {
            display: none;
            padding: 4px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 0.7rem;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            .toggle-friends { display: block; }
        }

        /* Theater modal for Tube */
        .theater-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1100;
            display: none;
            flex-direction: column;
        }

        .theater-backdrop.active { display: flex; }

        .theater-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 10;
        }

        .theater-video {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
            min-height: 0; /* Important for flex shrinking */
        }

        .theater-video video {
            max-width: 100%;
            max-height: calc(100vh - 220px); /* Leave space for info panel */
            width: auto;
            height: auto;
            border-radius: 8px;
            object-fit: contain;
        }

        .theater-info {
            padding: 12px 15px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            max-height: 35vh;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .theater-info h4 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .theater-info .meta {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Theater actions bar */
        .theater-actions {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .theater-action-btn {
                    display: flex;
                    align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-dim);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theater-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-cyan);
        }

        .theater-action-btn.active {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        .theater-action-btn .icon { font-size: 1rem; }
        .theater-action-btn .count { color: var(--text-primary); }

        /* Theater comments section */
        .theater-comments {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-void);
            border-radius: 8px;
        }

        .theater-comment {
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
        }

        .theater-comment:last-child { border-bottom: none; }
        .theater-comment .author { color: var(--accent-cyan); font-weight: 600; }
        .theater-comment .text { color: var(--text-primary); margin-left: 6px; }

        .theater-comment-form {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .theater-comment-form input {
            flex: 1;
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 0.75rem;
        }

        .theater-comment-form button {
            padding: 6px 12px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 16px;
            color: var(--bg-void);
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
        }

        /* Friends list scroll */
        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .friends-list::-webkit-scrollbar {
            width: 4px;
        }

        .friends-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .friends-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- TOP BAR -->
    <div class="top-bar" id="topBar">
        <div class="logo" onclick="history.go(-1)">ü§ñ #BRO</div>
        <div class="status-dot offline" id="statusDot"></div>
        <div class="profile-mini" id="profileMini">
            <img src="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1" id="profileImg">
            <span class="name" id="profileName">Non connect√©</span>
        </div>
        <div class="zen-balance" id="zenBalance" style="display:none;">
            <span class="zen-icon">·∫ê</span>
            <span class="zen-amount" id="zenAmount">---</span>
            <span class="zencard-icon" id="zencardIcon" style="display:none;" title="ZEN Card disponible">üí≥</span>
        </div>
        <button class="btn-connect" id="btnConnect">Connecter</button>
    </div>

    <!-- SERVICE TABS - 3 main tabs -->
    <div class="service-bar">
        <button class="svc-tab active" data-svc="flux">üìã Flux</button>
        <div class="svc-dropdown">
            <button class="svc-tab" data-svc="ia" id="iaTab">ü§ñ IA <span class="dropdown-arrow">‚ñº</span></button>
            <div class="svc-dropdown-menu" id="iaMenu">
                <button class="svc-sub" data-svc="image">üñºÔ∏è Image</button>
                <button class="svc-sub" data-svc="video">üé¨ Vid√©o</button>
                <button class="svc-sub" data-svc="music">üéµ Musique</button>
                <button class="svc-sub" data-svc="search">üîç Search</button>
                <button class="svc-sub" data-svc="nature">üåø Nature</button>
            </div>
        </div>
        <button class="svc-tab" data-svc="tube">üì∫ TUBE</button>
        <button class="svc-btn add-btn" id="btnAddVideo" title="Ajouter une vid√©o">‚ûï</button>
    </div>

    <!-- MAIN CONTENT WITH SIDE ARROWS -->
    <div class="main-content">
        <button class="nav-arrow left" id="btnPrev" disabled>‚óÄ</button>
        
        <div class="chat-wrapper">
            <div class="chat-area" id="chatArea">
                <div class="empty-state" id="emptyState">
                    <div class="icon">ü§ñ</div>
                    <div>Connectez-vous pour dialoguer</div>
                    <div style="margin-top:6px;font-size:0.7rem;">Votre ASTROBOT r√©pond en votre nom</div>
                </div>
            </div>
        </div>

        <button class="nav-arrow right" id="btnNext" disabled>‚ñ∂</button>
    </div>

    <!-- TUBE PANEL -->
    <div class="tube-panel" id="tubePanel">
        <div class="tube-header">
            <h3>üì∫ NostrTube</h3>
            <div class="tube-filters">
                <button class="tube-filter-btn active" data-filter="all">Tous</button>
                <button class="tube-filter-btn" data-filter="ai">ü§ñ IA</button>
                <button class="tube-filter-btn" data-filter="nostr">üì° NostrTube</button>
                <button class="toggle-friends" id="toggleFriends">üë•</button>
            </div>
        </div>
        <div class="tube-content">
            <div class="friends-sidebar" id="friendsSidebar">
                <div class="friends-header">
                    <span>üë• Amis</span>
                    <span id="friendsCount">0</span>
                </div>
                <div class="friends-list" id="friendsList">
                    <div class="friend-item all selected" data-pubkey="all">
                        <span class="name">üåê Tous les flux</span>
                    </div>
                    <!-- Friends will be loaded here -->
                </div>
            </div>
            <div class="video-grid-container">
                <div class="video-grid" id="videoGrid">
                    <div class="tube-empty">
                        <div class="icon">üì∫</div>
                        <div>Connectez-vous pour voir les vid√©os</div>
                        <div style="font-size:0.7rem;margin-top:6px;">Vid√©os IA g√©n√©r√©es + NostrTube</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- THEATER MODAL FOR TUBE -->
    <div class="theater-backdrop" id="theaterBackdrop">
        <button class="theater-close" onclick="closeTheater()">√ó</button>
        <div class="theater-video">
            <video id="theaterVideo" controls autoplay></video>
        </div>
        <div class="theater-info">
            <h4 id="theaterTitle">Video Title</h4>
            <div class="meta" id="theaterMeta"></div>
            
            <!-- Actions bar -->
            <div class="theater-actions">
                <button class="theater-action-btn" id="btnLike" onclick="toggleLike()">
                    <span class="icon">üëç</span>
                    <span class="count" id="likeCount">0</span>
                </button>
                <button class="theater-action-btn" id="btnDislike" onclick="toggleDislike()">
                    <span class="icon">üëé</span>
                    <span class="count" id="dislikeCount">0</span>
                </button>
                <button class="theater-action-btn" id="btnBookmark" onclick="toggleBookmark()">
                    <span class="icon">üîñ</span>
                    <span>Sauvegarder</span>
                </button>
                <button class="theater-action-btn" id="btnShare" onclick="shareVideo()">
                    <span class="icon">üì§</span>
                    <span>Partager</span>
                </button>
                <button class="theater-action-btn" id="btnShowComments" onclick="toggleComments()">
                    <span class="icon">üí¨</span>
                    <span class="count" id="commentCount">0</span>
                </button>
            </div>
            
            <!-- Comments section -->
            <div class="theater-comments" id="theaterComments" style="display:none;">
                <div id="commentsList"></div>
                <div class="theater-comment-form">
                    <input type="text" id="commentInput" placeholder="Ajouter un commentaire...">
                    <button onclick="postVideoCommentAction()">Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- INPUT SECTION -->
    <div class="input-section">
        <div class="input-options">
            <button class="opt-btn active" id="btnConversation" title="BRO r√©pond en votre nom (√©ph√©m√®re 1h)">üí¨ Conversation</button>
            <button class="opt-btn" id="btnPublic" title="Message permanent">üì¢ Public</button>
            <label class="opt-btn" for="imgInput">üì∑</label>
            <input type="file" id="imgInput" accept="image/*" style="display:none;">
            <button class="opt-btn" id="btnLocation">üìç</button>
            <button class="opt-btn" id="btnSettings">‚öôÔ∏è</button>
            <div class="sub-options" id="videoOpts">
                <button class="sub-opt active" data-mode="t2v">T2V</button>
                <button class="sub-opt" data-mode="i2v">I2V</button>
            </div>
        </div>

        <div class="img-preview-wrap" id="imgPreviewWrap">
            <img id="imgPreview" src="#">
            <button class="remove" onclick="clearImage()">√ó</button>
        </div>

        <div class="input-row">
            <textarea id="messageInput" placeholder="Tapez votre message..." rows="2"></textarea>
            <button class="btn-send" id="btnSend" disabled>ENVOYER</button>
        </div>

        <div class="hint" id="serviceHint">üí¨ Posez une question ou discutez avec votre IA</div>

        <div class="loading" id="loadingBar">
            <div class="spinner"></div>
            <span id="loadingText">Envoi...</span>
        </div>
    </div>

    <!-- SETTINGS -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-row">
            <label>üìç Localisation</label>
            <div class="toggle-switch on" id="toggleLocation"></div>
            <label>Lat:</label>
            <input type="number" id="latInput" step="0.01" value="0">
            <label>Lon:</label>
            <input type="number" id="lonInput" step="0.01" value="0">
            <button class="opt-btn" id="btnGeolocate">Ma position</button>
        </div>
        <div id="mapContainer" style="display:none;"><div id="mini-map"></div></div>
    </div>

    <!-- LIGHTBOX -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
        <img id="lightboxImg" src="#">
    </div>

    <!-- DEBUG -->
    <details style="position:fixed;bottom:0;left:0;right:0;background:var(--bg-panel);border-top:1px solid var(--border);max-height:120px;overflow-y:auto;font-size:0.6rem;z-index:100;">
        <summary style="padding:3px 8px;cursor:pointer;color:var(--text-dim);">üîß Debug</summary>
        <div id="debugLog" style="padding:4px;font-family:monospace;white-space:pre-wrap;color:var(--accent-cyan);"></div>
    </details>

    <script>
        // === CONFIG ===
        const DEFAULT_RELAYS = ['wss://relay.copylaradio.com', 'ws://127.0.0.1:7777'];
        const MESSAGES_PER_PAGE = 50;

        // === STATE ===
        let publicKey = '';
        let pool = null;
        let allRelays = [...DEFAULT_RELAYS];
        let userProfile = null;
        let allMessages = [];  // All fetched messages
        let filteredMessages = [];  // Messages filtered by service
        let msgIndex = 0;
        let currentTheaterVideo = null;  // Current video in theater mode
        let theaterLiked = false;
        let theaterDisliked = false;
        let theaterBookmarked = false;
        let currentService = 'all';
        let currentInputService = 'chat';
        let videoMode = 't2v';
        let isConversation = true;
        let locationEnabled = true;
        let currentLat = null;
        let currentLon = null;
        let selectedImage = null;
        let miniMap = null;

        // === LOGGING ===
        let debugLog = '';
        function log(msg) {
            const ts = new Date().toLocaleTimeString();
            const line = `[${ts}] ${msg}`;
            console.log(line);
            debugLog += line + '\n';
            const lines = debugLog.split('\n');
            if (lines.length > 50) debugLog = lines.slice(-50).join('\n');
            $('#debugLog').text(debugLog).scrollTop($('#debugLog')[0]?.scrollHeight || 0);
        }

        // === INIT ===
        $(document).ready(function() {
            log('Document ready');
            let attempts = 0;
            const checkLib = setInterval(() => {
                attempts++;
                if (typeof NostrTools !== 'undefined' && NostrTools.SimplePool) {
                    clearInterval(checkLib);
                    log('NostrTools OK');
                    init();
                } else if (attempts > 50) {
                    clearInterval(checkLib);
                    log('ERROR: NostrTools failed');
                    $('#btnConnect').text('Erreur').prop('disabled', true);
                }
            }, 100);
        });

        function init() {
            checkExtension();
            getLocation();
            setupEvents();
        }

        function setupEvents() {
            $('#btnConnect').on('click', connectWallet);

            // Main tabs click handler
            $('.svc-tab').on('click', function(e) {
                const svc = $(this).data('svc');
                
                // Handle IA dropdown toggle
                if (svc === 'ia') {
                    e.stopPropagation();
                    $('.svc-dropdown').toggleClass('open');
                return;
            }

                // Close dropdown when clicking other tabs
                $('.svc-dropdown').removeClass('open');
                
                // Update active state
                currentService = svc === 'flux' ? 'all' : svc;
                $('.svc-tab').removeClass('active');
                $('.svc-sub').removeClass('active');
                $(this).addClass('active');
                
                // Handle Tube mode switching
                if (svc === 'tube') {
                    $('.main-content').hide();
                    $('#tubePanel').addClass('active');
                    $('.input-section').hide();
                    loadTubeVideos();
                } else {
                    $('#tubePanel').removeClass('active');
                    $('.main-content').show();
                    $('.input-section').show();
                    filterAndDisplayMessages();
                    updateInputHint('chat');
                }
                $('#videoOpts').removeClass('visible');
            });

            // IA submenu click handler
            $('.svc-sub').on('click', function(e) {
                e.stopPropagation();
                const svc = $(this).data('svc');
                currentService = svc;
                currentInputService = svc;
                
                // Update active states
                $('.svc-tab').removeClass('active');
                $('#iaTab').addClass('active');
                $('.svc-sub').removeClass('active');
                $(this).addClass('active');
                
                // Close dropdown
                $('.svc-dropdown').removeClass('open');
                
                // Show main content
                $('#tubePanel').removeClass('active');
                $('.main-content').show();
                $('.input-section').show();
                filterAndDisplayMessages();
                updateInputHint(svc);
                
                // Show video options if video service
                $('#videoOpts').toggleClass('visible', svc === 'video');
            });

            // Close dropdown when clicking outside
            $(document).on('click', function() {
                $('.svc-dropdown').removeClass('open');
            });

            // Add video button - opens webcam page
            $('#btnAddVideo').on('click', openWebcamUpload);

            // Mode toggle
            $('#btnConversation').on('click', () => setMode(true));
            $('#btnPublic').on('click', () => setMode(false));

            // Video sub-options
            $('.sub-opt').on('click', function() {
                videoMode = $(this).data('mode');
                $('.sub-opt').removeClass('active');
                $(this).addClass('active');
            });

            // Image
            $('#imgInput').on('change', handleImageSelect);

            // Location
            $('#btnLocation').on('click', function() {
                locationEnabled = !locationEnabled;
                $(this).toggleClass('active', locationEnabled);
                $('#toggleLocation').toggleClass('on', locationEnabled);
            });

            $('#toggleLocation').on('click', function() {
                locationEnabled = !locationEnabled;
                $(this).toggleClass('on', locationEnabled);
                $('#btnLocation').toggleClass('active', locationEnabled);
            });

            // Settings
            $('#btnSettings').on('click', function() {
                $('#settingsPanel').toggleClass('open');
                $(this).toggleClass('active');
                if ($('#settingsPanel').hasClass('open') && !miniMap) initMiniMap();
            });

            $('#btnGeolocate').on('click', getLocation);

            // Navigation arrows
            $('#btnPrev').on('click', () => navigate(-1));
            $('#btnNext').on('click', () => navigate(1));

            // Send
            $('#btnSend').on('click', sendMessage);
            $('#messageInput').on('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            }).on('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });

            // Lightbox
            $('#lightbox').on('click', e => { if (e.target.id === 'lightbox') closeLightbox(); });
            $(document).on('keydown', e => { if (e.key === 'Escape') { closeLightbox(); closeTheater(); }});

            // Tube events
            setupTubeEvents();
        }

        // === TUBE MODE ===
        let tubeVideos = [];
        let filteredTubeVideos = [];
        let friendsList = [];
        let selectedFriend = 'all';
        let tubeFilter = 'all';
        let profileCache = {};

        function setupTubeEvents() {
            // Tube filter buttons
            $('.tube-filter-btn').on('click', function() {
                tubeFilter = $(this).data('filter');
                $('.tube-filter-btn').removeClass('active');
                $(this).addClass('active');
                filterTubeVideos();
            });

            // Friends toggle (mobile)
            $('#toggleFriends').on('click', function() {
                $('#friendsSidebar').toggleClass('collapsed');
            });

            // Friend selection
            $(document).on('click', '.friend-item', function() {
                selectedFriend = $(this).data('pubkey');
                $('.friend-item').removeClass('selected');
                $(this).addClass('selected');
                filterTubeVideos();
            });

            // Theater close
            $('#theaterBackdrop').on('click', function(e) {
                if (e.target.id === 'theaterBackdrop') closeTheater();
            });
        }

        async function loadTubeVideos() {
            if (!publicKey) {
                $('#videoGrid').html(`
                    <div class="tube-empty">
                        <div class="icon">üîí</div>
                        <div>Connectez-vous pour voir les vid√©os</div>
                    </div>
                `);
                return;
            }

            log('Loading Tube videos...');
            $('#videoGrid').html('<div class="tube-loading"><div class="spinner"></div>Chargement des vid√©os...</div>');

            tubeVideos = [];
            const p = getPool();

            try {
                // 1. Load AI-generated videos from user's messages (#video tag)
                const userVideoMessages = await p.list(allRelays, [{
                    kinds: [1],
                    authors: [publicKey],
                    '#t': ['video'],
                    limit: 50
                }]);

                // Also get replies to user messages (AI responses with videos)
                const userMessages = await p.list(allRelays, [{
                    kinds: [1],
                    authors: [publicKey],
                    limit: 100
                }]);

                const userMsgIds = userMessages.map(m => m.id);
                let aiReplies = [];
                if (userMsgIds.length > 0) {
                    aiReplies = await p.list(allRelays, [{
                        kinds: [1],
                        '#e': userMsgIds,
                        limit: 200
                    }]);
                }

                // Filter AI replies that contain video URLs
                const aiVideoReplies = aiReplies.filter(r => {
                    const urls = extractMediaUrls(r.content);
                    return urls.some(u => detectMediaType(u) === 'video');
                });

                // Convert to video format
                [...userVideoMessages, ...aiVideoReplies].forEach(event => {
                    const video = convertMessageToVideo(event, true);
                    if (video) tubeVideos.push(video);
                });

                // 2. Load NostrTube videos (kinds 21, 22)
                const nostrtubeVideos = await p.list(allRelays, [{
                    kinds: [21, 22],
                    limit: 100
                }]);

                nostrtubeVideos.forEach(event => {
                    const video = extractNostrTubeVideo(event);
                    if (video) tubeVideos.push(video);
                });

                // 3. Load friends list
                await loadFriendsList();

                // Sort by date
                tubeVideos.sort((a, b) => b.created_at - a.created_at);

                log(`Loaded ${tubeVideos.length} videos (${userVideoMessages.length + aiVideoReplies.length} AI, ${nostrtubeVideos.length} NostrTube)`);
                
                filterTubeVideos();

            } catch (e) {
                log(`Tube error: ${e.message}`);
                $('#videoGrid').html(`
                    <div class="tube-empty">
                        <div class="icon">‚ùå</div>
                        <div>Erreur de chargement</div>
                        <div style="font-size:0.7rem">${e.message}</div>
                    </div>
                `);
            }
        }

        function convertMessageToVideo(event, isAI) {
            const urls = extractMediaUrls(event.content);
            let videoUrl = urls.find(u => detectMediaType(u) === 'video');
            if (!videoUrl) return null;

            // Normalize IPFS URLs (u. -> ipfs.)
            videoUrl = normalizeIpfsUrl(videoUrl);
            let thumbnailUrl = normalizeIpfsUrl(urls.find(u => detectMediaType(u) === 'image') || '');

            // Extract title from content
            let title = cleanContent(event.content, urls);
            if (title.length > 80) title = title.substring(0, 80) + '...';
            if (!title) title = isAI ? 'Vid√©o IA g√©n√©r√©e' : 'Vid√©o';

            return {
                id: event.id,
                title: title,
                videoUrl: videoUrl,
                thumbnailUrl: thumbnailUrl,
                gifanimUrl: '', // AI videos don't have animated thumbnails
                authorId: event.pubkey,
                created_at: event.created_at,
                isAI: isAI,
                type: 'ai',
                duration: 0,
                kind: 1 // Kind 1 for AI video messages
            };
        }

        function extractNostrTubeVideo(event) {
            // Extract from NIP-71 format (including IPFS extension)
            const titleTag = event.tags.find(t => t[0] === 'title');
            const urlTag = event.tags.find(t => t[0] === 'url' || t[0] === 'r');
            const imageTag = event.tags.find(t => t[0] === 'image' || t[0] === 'thumb');
            const gifanimTag = event.tags.find(t => t[0] === 'gifanim' || t[0] === 'gif');
            const durationTag = event.tags.find(t => t[0] === 'duration');
            const imetaTag = event.tags.find(t => t[0] === 'imeta');
            
            // NIP-71 IPFS Extension: CID-only tags
            const thumbnailIpfsTag = event.tags.find(t => t[0] === 'thumbnail_ipfs');
            const gifanimIpfsTag = event.tags.find(t => t[0] === 'gifanim_ipfs');

            let videoUrl = urlTag ? urlTag[1] : '';
            let thumbnailUrl = imageTag ? imageTag[1] : '';
            let gifanimUrl = gifanimTag ? gifanimTag[1] : '';
            let duration = durationTag ? parseInt(durationTag[1]) : 0;

            // Parse imeta tag if available
            if (imetaTag) {
                imetaTag.forEach((item, idx) => {
                    if (idx === 0) return;
                    if (typeof item === 'string') {
                        if (item.startsWith('url ')) videoUrl = videoUrl || item.substring(4).trim();
                        if (item.startsWith('image ')) thumbnailUrl = thumbnailUrl || item.substring(6).trim();
                        if (item.startsWith('gifanim ') || item.startsWith('gif ')) gifanimUrl = gifanimUrl || item.substring(item.indexOf(' ') + 1).trim();
                        if (item.startsWith('duration ')) duration = duration || parseFloat(item.substring(9).trim());
                    }
                });
            }
            
            // Use CID-only tags as fallback (NIP-71 IPFS Extension)
            if (!thumbnailUrl && thumbnailIpfsTag && thumbnailIpfsTag[1]) {
                thumbnailUrl = thumbnailIpfsTag[1]; // Will be normalized below
            }
            if (!gifanimUrl && gifanimIpfsTag && gifanimIpfsTag[1]) {
                gifanimUrl = gifanimIpfsTag[1]; // Will be normalized below
            }

            // Also check for URL in content
            if (!videoUrl) {
                const urls = extractMediaUrls(event.content);
                videoUrl = urls.find(u => detectMediaType(u) === 'video') || '';
            }

            if (!videoUrl) return null;

            // Normalize IPFS URLs: handles u.->ipfs., relative paths, and CID-only
            videoUrl = normalizeIpfsUrl(videoUrl);
            thumbnailUrl = normalizeIpfsUrl(thumbnailUrl);
            gifanimUrl = normalizeIpfsUrl(gifanimUrl);

            return {
                id: event.id,
                title: titleTag ? titleTag[1] : 'NostrTube Video',
                videoUrl: videoUrl,
                thumbnailUrl: thumbnailUrl,
                gifanimUrl: gifanimUrl,
                authorId: event.pubkey,
                created_at: event.created_at,
                isAI: false,
                type: 'nostr',
                duration: duration,
                kind: event.kind
            };
        }

        async function loadFriendsList() {
            if (!publicKey) return;

            const p = getPool();
            try {
                // Get contact list (kind 3)
                const contacts = await p.list(allRelays, [{
                    kinds: [3],
                    authors: [publicKey],
                    limit: 1
                }]);

                if (contacts.length > 0) {
                    friendsList = contacts[0].tags
                        .filter(t => t[0] === 'p')
                        .map(t => t[1]);
                    
                    log(`Loaded ${friendsList.length} friends`);
                    $('#friendsCount').text(friendsList.length);
                    renderFriendsList();
                }
             } catch (e) {
                log(`Friends error: ${e.message}`);
            }
        }

        async function renderFriendsList() {
            const $list = $('#friendsList');
            
            // Count videos per friend first
            const videoCounts = {};
            tubeVideos.forEach(v => {
                videoCounts[v.authorId] = (videoCounts[v.authorId] || 0) + 1;
            });
            
            // My video count
            const myVideoCount = videoCounts[publicKey] || 0;
            
            $list.html(`
                <div class="friend-item all ${selectedFriend === 'all' ? 'selected' : ''}" data-pubkey="all">
                    <span class="name">üåê Tous</span>
                    <span class="count">${tubeVideos.length}</span>
                </div>
                ${myVideoCount > 0 ? `
                <div class="friend-item ${selectedFriend === publicKey ? 'selected' : ''}" data-pubkey="${publicKey}">
                    <img src="${userProfile?.picture || 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1'}">
                    <span class="name">üì± Moi</span>
                    <span class="count">${myVideoCount}</span>
                </div>
                ` : ''}
            `);

            // Only show friends who have published videos
            const friendsWithVideos = friendsList.filter(pubkey => (videoCounts[pubkey] || 0) > 0);
            
            for (const pubkey of friendsWithVideos.slice(0, 30)) { // Limit to 30
                const profile = await getProfile(pubkey);
                const count = videoCounts[pubkey];
                
                $list.append(`
                    <div class="friend-item ${selectedFriend === pubkey ? 'selected' : ''}" data-pubkey="${pubkey}">
                        <img src="${profile?.picture || 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1'}" 
                             onerror="this.src='https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1'">
                        <span class="name">${profile?.display_name || profile?.name || pubkey.slice(0, 8)}</span>
                        <span class="count">${count}</span>
                    </div>
                `);
            }
            
            // Update friends count to show only those with videos
            $('#friendsCount').text(friendsWithVideos.length);
        }

        async function getProfile(pubkey) {
            if (profileCache[pubkey]) return profileCache[pubkey];

            const p = getPool();
            try {
                const events = await p.list([allRelays[0]], [{
                    kinds: [0],
                    authors: [pubkey],
                    limit: 1
                }]);
                if (events.length > 0) {
                    const profile = JSON.parse(events[0].content);
                    // Normalize IPFS URLs in profile
                    if (profile.picture) profile.picture = normalizeIpfsUrl(profile.picture);
                    if (profile.banner) profile.banner = normalizeIpfsUrl(profile.banner);
                    profileCache[pubkey] = profile;
                    return profile;
                }
            } catch (e) {}
            return null;
        }

        function filterTubeVideos() {
            filteredTubeVideos = tubeVideos.filter(v => {
                // Filter by type
                if (tubeFilter === 'ai' && v.type !== 'ai') return false;
                if (tubeFilter === 'nostr' && v.type !== 'nostr') return false;

                // Filter by friend
                if (selectedFriend !== 'all') {
                    if (v.authorId !== selectedFriend) return false;
                }

                return true;
            });

            renderVideoGrid();
        }

        function renderVideoGrid() {
            const $grid = $('#videoGrid');
            
            if (filteredTubeVideos.length === 0) {
                $grid.html(`
                    <div class="tube-empty">
                        <div class="icon">üì≠</div>
                        <div>Aucune vid√©o trouv√©e</div>
                        <div style="font-size:0.7rem;margin-top:6px;">
                            ${tubeFilter === 'ai' ? 'G√©n√©rez des vid√©os avec #BRO #video' : ''}
                            ${tubeFilter === 'nostr' ? 'Aucune vid√©o NostrTube disponible' : ''}
                        </div>
                    </div>
                `);
                 return;
             }

            $grid.html(filteredTubeVideos.map(v => renderVideoCard(v)).join(''));
        }

        function renderVideoCard(video) {
            const thumbnail = video.thumbnailUrl || '';
            const gifanim = video.gifanimUrl || '';
            const authorName = profileCache[video.authorId]?.display_name || 
                              profileCache[video.authorId]?.name || 
                              video.authorId.slice(0, 8);
            const authorPic = profileCache[video.authorId]?.picture || 
                             'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1';
            const date = formatRelativeDate(video.created_at);
            const duration = video.duration ? formatDuration(video.duration) : '';
            const hasThumb = thumbnail && (thumbnail.startsWith('http') || thumbnail.startsWith('/'));
            const hasGif = gifanim && (gifanim.startsWith('http') || gifanim.startsWith('/'));

            return `
                <div class="video-card" onclick="openVideoTheater('${video.id}')">
                    <div class="video-thumbnail">
                        ${hasThumb ? 
                            `<img class="thumb-static" src="${thumbnail}" onerror="this.style.display='none'">`
                            : `<div class="thumb-placeholder">üé¨</div>`
                        }
                        ${hasGif ? `<img class="gifanim" src="${gifanim}" onerror="this.style.display='none'">` : ''}
                        <span class="play-icon">‚ñ∂</span>
                        ${video.type === 'ai' ? '<span class="badge-ai">ü§ñ IA</span>' : ''}
                        ${duration ? `<span class="duration">${duration}</span>` : ''}
                    </div>
                    <div class="video-info">
                        <div class="title">${escapeHtml(video.title)}</div>
                        <div class="meta">
                            <div class="author">
                                <img src="${authorPic}" onerror="this.style.display='none'">
                                <span>${escapeHtml(authorName)}</span>
                            </div>
                            <span>‚Ä¢</span>
                            <span>${date}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateVideoPlaceholder(type) {
            return type === 'ai' ? 'ü§ñ' : 'üì∫';
        }

        async function openVideoTheater(videoId) {
            const video = tubeVideos.find(v => v.id === videoId);
            if (!video) return;

            currentTheaterVideo = video;
            theaterLiked = false;
            theaterDisliked = false;
            theaterBookmarked = false;

            $('#theaterVideo').attr('src', video.videoUrl);
            $('#theaterTitle').text(video.title);
            
            const authorName = profileCache[video.authorId]?.display_name || 
                              profileCache[video.authorId]?.name || 
                              video.authorId.slice(0, 8);
            const date = new Date(video.created_at * 1000).toLocaleString();
            
            $('#theaterMeta').html(`
                <span>${video.type === 'ai' ? 'ü§ñ IA Generated' : 'üì∫ NostrTube'}</span>
                <span>‚Ä¢</span>
                <span>Par ${escapeHtml(authorName)}</span>
                <span>‚Ä¢</span>
                <span>${date}</span>
            `);

            // Reset UI
            $('#btnLike, #btnDislike, #btnBookmark').removeClass('active');
            $('#likeCount, #dislikeCount, #commentCount').text('0');
            $('#commentsList').html('');
            $('#theaterComments').hide();

            $('#theaterBackdrop').addClass('active');
            $('body').css('overflow', 'hidden');

            // Load interactions (async)
            loadVideoInteractions(video);
        }

        function closeTheater() {
            $('#theaterBackdrop').removeClass('active');
            $('#theaterVideo')[0]?.pause();
            $('body').css('overflow', '');
            currentTheaterVideo = null;
        }

        // Load likes, dislikes, comments for current video
        async function loadVideoInteractions(video) {
            if (!video) return;
            const p = getPool();
            
            try {
                // Fetch reactions (kind 7)
                const reactions = await p.list(allRelays, [{
                    kinds: [7],
                    '#e': [video.id],
                    limit: 100
                }]);
                
                let likes = 0, dislikes = 0;
                reactions.forEach(r => {
                    if (r.content === '+' || r.content === 'üëç' || r.content === '‚ù§Ô∏è') {
                        likes++;
                        if (r.pubkey === publicKey) {
                            theaterLiked = true;
                            $('#btnLike').addClass('active');
                        }
                    } else if (r.content === '-' || r.content === 'üëé') {
                        dislikes++;
                        if (r.pubkey === publicKey) {
                            theaterDisliked = true;
                            $('#btnDislike').addClass('active');
                        }
                    }
                });
                
                $('#likeCount').text(likes);
                $('#dislikeCount').text(dislikes);
                
                // Fetch comments (kind 1 or 1111 referencing video)
                const comments = await p.list(allRelays, [{
                    kinds: [1, 1111],
                    '#e': [video.id],
                    limit: 50
                }]);
                
                $('#commentCount').text(comments.length);
                
                // Sort by date and render
                comments.sort((a, b) => a.created_at - b.created_at);
                const commentsHtml = await Promise.all(comments.map(async c => {
                    const profile = await getProfile(c.pubkey);
                    const name = profile?.display_name || profile?.name || c.pubkey.slice(0, 8);
                    return `<div class="theater-comment">
                        <span class="author">${escapeHtml(name)}:</span>
                        <span class="text">${escapeHtml(c.content)}</span>
                    </div>`;
                }));
                $('#commentsList').html(commentsHtml.join(''));
                
                // Check bookmark (kind 10002 or kind 30001)
                const bookmarks = await p.list(allRelays, [{
                    kinds: [30001],
                    authors: [publicKey],
                    '#d': ['videos'],
                    limit: 1
                }]);
                
                if (bookmarks.length > 0) {
                    const bookmarkTags = bookmarks[0].tags.filter(t => t[0] === 'e');
                    if (bookmarkTags.some(t => t[1] === video.id)) {
                        theaterBookmarked = true;
                        $('#btnBookmark').addClass('active');
                    }
                }
                
            } catch (e) {
                log(`Error loading interactions: ${e.message}`);
            }
        }

        // Toggle like reaction
        async function toggleLike() {
            if (!publicKey || !currentTheaterVideo) {
                showNotification('Connectez-vous d\'abord pour liker', 'connect');
                return;
            }
            
            try {
                const event = {
                    kind: 7,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ['e', currentTheaterVideo.id],
                        ['p', currentTheaterVideo.authorId]
                    ],
                    content: theaterLiked ? '' : '+'
                };
                
                const signed = await window.nostr.signEvent(event);
                await Promise.all(allRelays.map(r => publishToRelay(r, signed)));
                
                theaterLiked = !theaterLiked;
                $('#btnLike').toggleClass('active', theaterLiked);
                const count = parseInt($('#likeCount').text()) + (theaterLiked ? 1 : -1);
                $('#likeCount').text(Math.max(0, count));
                
                log(theaterLiked ? 'Liked' : 'Unliked');
                    } catch (e) {
                log(`Like error: ${e.message}`);
            }
        }

        // Toggle dislike reaction
        async function toggleDislike() {
            if (!publicKey || !currentTheaterVideo) {
                showNotification('Connectez-vous d\'abord pour r√©agir', 'connect');
                return;
            }
            
            try {
                const event = {
                    kind: 7,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ['e', currentTheaterVideo.id],
                        ['p', currentTheaterVideo.authorId]
                    ],
                    content: theaterDisliked ? '' : '-'
                };
                
                const signed = await window.nostr.signEvent(event);
                await Promise.all(allRelays.map(r => publishToRelay(r, signed)));
                
                theaterDisliked = !theaterDisliked;
                $('#btnDislike').toggleClass('active', theaterDisliked);
                const count = parseInt($('#dislikeCount').text()) + (theaterDisliked ? 1 : -1);
                $('#dislikeCount').text(Math.max(0, count));
                
                log(theaterDisliked ? 'Disliked' : 'Un-disliked');
            } catch (e) {
                log(`Dislike error: ${e.message}`);
            }
        }

        // Toggle bookmark
        async function toggleBookmark() {
            if (!publicKey || !currentTheaterVideo) {
                showNotification('Connectez-vous d\'abord pour sauvegarder', 'connect');
                return;
            }
            
            try {
                // Fetch existing bookmarks list
                const p = getPool();
                const existing = await p.list(allRelays, [{
                    kinds: [30001],
                    authors: [publicKey],
                    '#d': ['videos'],
                    limit: 1
                }]);
                
                let tags = [['d', 'videos']];
                if (existing.length > 0) {
                    tags = existing[0].tags.filter(t => t[0] !== 'e' || t[1] !== currentTheaterVideo.id);
                }
                
                if (!theaterBookmarked) {
                    tags.push(['e', currentTheaterVideo.id, '', 'mention']);
                }
                
                const event = {
                    kind: 30001,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags,
                    content: 'My saved videos'
                };
                
                const signed = await window.nostr.signEvent(event);
                await Promise.all(allRelays.map(r => publishToRelay(r, signed)));
                
                theaterBookmarked = !theaterBookmarked;
                $('#btnBookmark').toggleClass('active', theaterBookmarked);
                
                log(theaterBookmarked ? 'Bookmarked' : 'Removed from bookmarks');
            } catch (e) {
                log(`Bookmark error: ${e.message}`);
            }
        }

        // Share video
        function shareVideo() {
            if (!currentTheaterVideo) return;
            
            const shareUrl = `${window.location.origin}/theater?video=${currentTheaterVideo.id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: currentTheaterVideo.title,
                    url: shareUrl
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    log('Link copied to clipboard');
                    showNotification('Lien copi√© dans le presse-papier!', 'success');
                });
            }
        }

        // Toggle comments section
        function toggleComments() {
            $('#theaterComments').toggle();
        }

        // Post comment on video
        async function postVideoCommentAction() {
            if (!publicKey || !currentTheaterVideo) {
                showNotification('Connectez-vous d\'abord pour commenter', 'connect');
                return;
            }
            
            const content = $('#commentInput').val().trim();
            if (!content) return;
            
            try {
                const event = {
                    kind: 1111,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ['e', currentTheaterVideo.id, allRelays[0], 'root'],
                        ['p', currentTheaterVideo.authorId],
                        ['k', currentTheaterVideo.kind?.toString() || '21']
                    ],
                    content
                };
                
                const signed = await window.nostr.signEvent(event);
                await Promise.all(allRelays.map(r => publishToRelay(r, signed)));
                
                // Add to UI
                const profile = userProfile || {};
                const name = profile.display_name || profile.name || publicKey.slice(0, 8);
                $('#commentsList').append(`
                    <div class="theater-comment">
                        <span class="author">${escapeHtml(name)}:</span>
                        <span class="text">${escapeHtml(content)}</span>
                    </div>
                `);
                
                const count = parseInt($('#commentCount').text()) + 1;
                $('#commentCount').text(count);
                $('#commentInput').val('');
                
                log('Comment posted');
            } catch (e) {
                log(`Comment error: ${e.message}`);
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return '';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return m > 60 ? `${Math.floor(m/60)}h ${m%60}m` : `${m}:${s.toString().padStart(2, '0')}`;
        }

        function formatRelativeDate(timestamp) {
            const now = Math.floor(Date.now() / 1000);
            const diff = now - timestamp;
            if (diff < 60) return 'maintenant';
            if (diff < 3600) return `${Math.floor(diff / 60)}min`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}j`;
            return new Date(timestamp * 1000).toLocaleDateString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Show Bootstrap notification modal
        function showNotification(message, type = 'info', title = null) {
            const icons = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'error': '‚ùå',
                'connect': 'üîå'
            };
            const titles = {
                'info': 'Information',
                'success': 'Succ√®s',
                'warning': 'Attention',
                'error': 'Erreur',
                'connect': 'Connexion requise'
            };
            
            $('#notificationIcon').text(icons[type] || icons.info);
            $('#notificationTitle').text(title || titles[type] || titles.info);
            $('#notificationMessage').text(message);
            
            // Style the OK button based on type
            const $btn = $('#notificationModal .modal-footer button');
            if (type === 'error') {
                $btn.css('background', 'var(--accent-red)');
            } else if (type === 'success') {
                $btn.css('background', 'var(--accent-green)');
            } else if (type === 'warning') {
                $btn.css('background', 'var(--accent-orange)');
                } else {
                $btn.css('background', 'var(--accent-cyan)');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
            modal.show();
        }

        // Get IPFS gateway URL based on current domain/relay
        // Follows Astroport convention: ipfs.{domain} for gateways
        function getIpfsGateway() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            // Localhost: use local IPFS gateway
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://127.0.0.1:8080';
            }
            
            // Production: derive ipfs.{domain} from current hostname
            // e.g., u.copylaradio.com -> ipfs.copylaradio.com
            // e.g., ipfs.copylaradio.com -> ipfs.copylaradio.com
            // e.g., relay.copylaradio.com -> ipfs.copylaradio.com
            let baseDomain = hostname;
            
            // Remove common subdomains (u., ipfs., relay., www.)
            baseDomain = baseDomain.replace(/^(u\.|ipfs\.|relay\.|www\.)/i, '');
            
            return `${protocol}//ipfs.${baseDomain}`;
        }

        // Normalize IPFS URLs: convert various formats to full gateway URLs
        // Handles:
        // 1. u.{domain} -> ipfs.{domain} (e.g., https://u.copylaradio.com/ipfs/... -> https://ipfs.copylaradio.com/ipfs/...)
        // 2. Relative paths: /ipfs/Qm... or /ipns/... -> {gateway}/ipfs/Qm...
        // 3. CID-only: Qm... or bafy... -> {gateway}/ipfs/Qm...
        // 4. Existing full URLs with correct gateway: pass through
        function normalizeIpfsUrl(url) {
            if (!url) return url;
            
            url = url.trim();
            
            // Already a full URL
            if (url.startsWith('http://') || url.startsWith('https://')) {
                // Replace u.{domain} with ipfs.{domain}
                url = url.replace(/^(https?:\/\/)u\.([^\/]+)(\/ipfs\/|\/ipns\/)/i, '$1ipfs.$2$3');
                return url;
            }
            
            const gateway = getIpfsGateway();
            
            // Relative path: /ipfs/... or /ipns/...
            if (url.startsWith('/ipfs/') || url.startsWith('/ipns/')) {
                return `${gateway}${url}`;
            }
            
            // CID-only format: starts with Qm (CIDv0) or bafy/bafk (CIDv1)
            // Also handle potential filename after CID: Qm.../filename.mp4
            if (/^(Qm[1-9A-HJ-NP-Za-km-z]{44}|baf[yk][a-zA-Z2-7]{50,})/i.test(url)) {
                // Check if it's a CID with filename
                const parts = url.split('/');
                const cid = parts[0];
                const rest = parts.slice(1).join('/');
                if (rest) {
                    return `${gateway}/ipfs/${cid}/${rest}`;
                }
                return `${gateway}/ipfs/${url}`;
            }
            
            // Return as-is if we can't determine format
            return url;
        }

        // === WALLET ===
        function checkExtension() {
            if (typeof window.nostr !== 'undefined') {
                log('Extension found');
                $('#btnConnect').prop('disabled', false);
                } else {
                log('No extension');
                $('#btnConnect').text('Extension?').prop('disabled', true);
                setTimeout(() => {
                    if (typeof window.nostr !== 'undefined') {
                        $('#btnConnect').prop('disabled', false).text('Connecter');
                    }
                }, 1000);
            }
        }

        async function connectWallet() {
            log('Connecting...');
            try {
                $('#btnConnect').prop('disabled', true).text('...');
                publicKey = await window.nostr.getPublicKey();
                log(`Connected: ${publicKey.slice(0,12)}...`);
                $('#statusDot').removeClass('offline');
                $('#profileMini').addClass('connected');
                $('#btnConnect').hide();
                $('#btnSend').prop('disabled', false);
                await fetchProfile();
                await fetchMessages();
                } catch (e) {
                log(`ERROR: ${e.message}`);
                $('#btnConnect').prop('disabled', false).text('R√©essayer');
            }
        }

        async function fetchProfile() {
            const p = getPool();
            for (const relay of DEFAULT_RELAYS) {
                try {
                    const events = await p.list([relay], [{ kinds: [0], authors: [publicKey], limit: 1 }]);
                    if (events.length) {
                        const event = events[0];
                        userProfile = JSON.parse(event.content);
                        
                        // Normalize IPFS URLs in profile
                        if (userProfile.picture) userProfile.picture = normalizeIpfsUrl(userProfile.picture);
                        if (userProfile.banner) userProfile.banner = normalizeIpfsUrl(userProfile.banner);
                        
                        // Extract additional fields from event tags (g1pub, zencard)
                        if (event.tags && Array.isArray(event.tags)) {
                            event.tags.forEach(tag => {
                                if (tag.length >= 2 && tag[0] === 'i') {
                                    const value = tag[1];
                                    if (value.startsWith('g1pub:')) {
                                        userProfile.g1pub = value.substring(6);
                                    } else if (value.startsWith('zencard:')) {
                                        userProfile.zencard = value.substring(8);
                                    }
                                }
                            });
                        }
                        
                        // Update profile display
                        $('#profileImg').attr('src', userProfile.picture || $('#profileImg').attr('src'));
                        $('#profileName').text(userProfile.display_name || userProfile.name || publicKey.slice(0, 8));
                        log(`Profile: ${userProfile.name || userProfile.display_name}`);
                        
                        // Update header with banner if available
                        updateHeaderWithBanner(userProfile);
                        
                        // Fetch and display ZEN balance
                        fetchAndDisplayZenBalance(userProfile);
                        
                        break;
                    }
                } catch (e) { log(`Profile error: ${e.message}`); }
            }
        }

        // Update header with user's banner
        function updateHeaderWithBanner(profile) {
            const $topBar = $('#topBar');
            if (profile.banner) {
                const bannerUrl = normalizeIpfsUrl(profile.banner);
                $topBar.addClass('with-banner');
                $topBar.css('background-image', `url('${bannerUrl}')`);
                log(`Banner set: ${bannerUrl.substring(0, 50)}...`);
            } else {
                $topBar.removeClass('with-banner');
                $topBar.css('background-image', 'none');
            }
        }

        // Get API server URL (ipfs. -> u.)
        function getApiServerUrl() {
            const url = new URL(window.location.href);
            let hostname = url.hostname.replace(/^ipfs\./, 'u.');
            let port = url.port;
            if (port === '8080') port = '54321';
            const protocol = url.protocol;
            return port ? `${protocol}//${hostname}:${port}` : `${protocol}//${hostname}`;
        }

        // Check ZEN balance for a g1pub
        async function checkZenBalance(g1pub) {
            try {
                const apiUrl = getApiServerUrl();
                const response = await fetch(`${apiUrl}/check_balance?g1pub=${g1pub}`, { timeout: 5000 });
                
                if (!response.ok) return null;
                
                const data = await response.json();
                if (data.balance && data.g1pub) {
                    const g1Balance = parseFloat(data.balance);
                    const zenBalance = Math.floor((g1Balance - 1) * 10);
                    return { g1Balance, zenBalance, g1pub: data.g1pub };
                }
                return null;
            } catch (error) {
                log(`Balance check error: ${error.message}`);
                return null;
            }
        }

        // Fetch and display ZEN balance
        async function fetchAndDisplayZenBalance(profile) {
            const $zenBalance = $('#zenBalance');
            const $zenAmount = $('#zenAmount');
            const $zencardIcon = $('#zencardIcon');
            
            // Show loading state
            $zenBalance.show().addClass('loading');
            $zenAmount.text('...');
            
            let totalZen = 0;
            let hasZenCard = false;
            
            // Check g1pub balance
            if (profile.g1pub) {
                const g1pubParts = profile.g1pub.split(':');
                const mainPub = g1pubParts[0]; // Use first part (MULTIPASS)
                
                const balance = await checkZenBalance(mainPub);
                if (balance) {
                    totalZen = balance.zenBalance;
                    log(`ZEN Balance: ${totalZen} ·∫êEN`);
                }
            }
            
            // Check ZenCard
            if (profile.zencard && profile.zencard !== 'None' && profile.zencard.trim() !== '') {
                hasZenCard = true;
                log(`ZenCard found: ${profile.zencard.substring(0, 8)}...`);
            }
            
            // Update display
            $zenBalance.removeClass('loading');
            $zenAmount.text(totalZen > 0 ? `${totalZen} ·∫êEN` : '0 ·∫êEN');
            
            if (hasZenCard) {
                $zencardIcon.show();
            } else {
                $zencardIcon.hide();
            }
        }

        // === MESSAGES ===
        async function fetchMessages() {
            if (!publicKey) return;
            log('Fetching messages...');
            const p = getPool();
            try {
                const events = await p.list(allRelays, [{
                    kinds: [1],
                    authors: [publicKey],
                    limit: MESSAGES_PER_PAGE
                }]);
                allMessages = events.sort((a, b) => b.created_at - a.created_at);
                log(`Got ${allMessages.length} messages`);
                updateServiceCounts();
                filterAndDisplayMessages();
            } catch (e) {
                log(`Fetch error: ${e.message}`);
            }
        }

        function updateServiceCounts() {
            const counts = { all: allMessages.length, chat: 0, image: 0, video: 0, music: 0, search: 0, nature: 0, ia: 0 };
            allMessages.forEach(m => {
                const tags = extractTags(m.content);
                if (tags.includes('image')) { counts.image++; counts.ia++; }
                else if (tags.includes('video')) { counts.video++; counts.ia++; }
                else if (tags.includes('music')) { counts.music++; counts.ia++; }
                else if (tags.includes('search')) { counts.search++; counts.ia++; }
                else if (tags.includes('nature')) { counts.nature++; counts.ia++; }
                else counts.chat++;
            });
            
            // Update badges on main tabs
            $('.svc-tab[data-svc="flux"]').attr('data-count', counts.all || '');
            $('.svc-tab[data-svc="ia"]').attr('data-count', counts.ia || '');
            
            // Update badges on IA submenu
            Object.keys(counts).forEach(svc => {
                const btn = $(`.svc-sub[data-svc="${svc}"]`);
                btn.find('.svc-count').remove();
                if (counts[svc] > 0) {
                    btn.append(`<span class="svc-count">${counts[svc]}</span>`);
                }
            });
        }

        function filterAndDisplayMessages() {
            if (currentService === 'all') {
                // Flux mode - all messages
                filteredMessages = [...allMessages];
                 } else {
                filteredMessages = allMessages.filter(m => {
                    const tags = extractTags(m.content);
                    if (currentService === 'chat') {
                        return !tags.includes('image') && !tags.includes('video') && 
                               !tags.includes('music') && !tags.includes('search') && !tags.includes('nature');
                    }
                    return tags.includes(currentService);
                });
            }
            msgIndex = 0;
            
            // Toggle flux mode UI
            if (currentService === 'all') {
                $('.main-content').addClass('flux-mode');
                renderFluxFeed();
            } else {
                $('.main-content').removeClass('flux-mode');
                renderCurrentMessage();
            }
        }

        // Render all messages as vertical infinite scroll feed
        function renderFluxFeed() {
            const $chat = $('#chatArea').empty();
            $('#emptyState').addClass('hidden');

            if (filteredMessages.length === 0) {
                $chat.append($('#emptyState').removeClass('hidden').clone());
                updateNavButtons();
                return;
            }

            // Render all messages vertically
            filteredMessages.forEach((msg, idx) => {
                const rendered = renderMessage(msg, idx);
                $chat.append(rendered);
            });

            // Scroll to top
            $chat.scrollTop(0);
            updateNavButtons();
        }

        function renderCurrentMessage() {
            const $chat = $('#chatArea').empty();
            $('#emptyState').addClass('hidden');

            if (filteredMessages.length === 0) {
                $chat.append($('#emptyState').removeClass('hidden').clone());
                updateNavButtons();
                return;
            }

            // Counter for navigation mode
            $chat.append(`<div class="msg-counter">${msgIndex + 1} / ${filteredMessages.length}</div>`);

            const msg = filteredMessages[msgIndex];
            renderMessage(msg, true);
            fetchReplies(msg.id);
            updateNavButtons();
        }

        function renderMessage(event, isUser) {
            const tags = extractTags(event.content);
            const expiration = getExpiration(event);
            const mediaUrls = extractMediaUrls(event.content);
            let text = cleanContent(event.content, mediaUrls);

            const $msg = $('<div>').addClass('msg').addClass(isUser ? 'user' : 'bot');
            
            const $header = $('<div>').addClass('msg-header');
            $header.append($('<span>').text(isUser ? 'üë§ Vous' : 'ü§ñ BRO'));
            if (expiration) $header.append($('<span>').addClass('tag').text(`‚è±Ô∏è ${formatExpiry(expiration)}`));
            tags.forEach(t => $header.append($('<span>').addClass('tag ' + t).text('#' + t)));
            $msg.append($header);

            $msg.append($('<div>').addClass('msg-content').html(linkify(text)));

            mediaUrls.forEach(url => {
                const type = detectMediaType(url);
                if (type) {
                    const $media = $('<div>').addClass('msg-media');
                    if (type === 'image' || type === 'gif') {
                        $media.append($('<img>').attr('src', url).on('click', () => openLightbox(url)));
                    } else if (type === 'video') {
                        $media.append($('<video controls>').attr('src', url));
                    } else if (type === 'audio') {
                        $media.append($('<audio controls>').attr('src', url));
                    }
                    $msg.append($media);
                }
            });

            $msg.append($('<div>').addClass('msg-time').text(new Date(event.created_at * 1000).toLocaleString()));
            $('#chatArea').append($msg);
        }

        async function fetchReplies(eventId) {
            const p = getPool();
            try {
                const replies = await p.list(allRelays, [{ kinds: [1], '#e': [eventId], limit: 10 }]);
                replies.sort((a, b) => a.created_at - b.created_at);
                replies.forEach(r => renderMessage(r, false));
                $('#chatArea').scrollTop($('#chatArea')[0].scrollHeight);
                if (replies.length === 0) {
                    setTimeout(() => {
                        if (filteredMessages[msgIndex]?.id === eventId) fetchReplies(eventId);
                    }, 5000);
                }
            } catch (e) { log(`Replies error: ${e.message}`); }
        }

        function navigate(delta) {
            const newIdx = msgIndex + delta;
            if (newIdx >= 0 && newIdx < filteredMessages.length) {
                msgIndex = newIdx;
                renderCurrentMessage();
            }
        }

        function updateNavButtons() {
            $('#btnPrev').prop('disabled', msgIndex <= 0);
            $('#btnNext').prop('disabled', msgIndex >= filteredMessages.length - 1);
        }

        // === SEND ===
        async function sendMessage() {
            if (!publicKey) return;
            const text = $('#messageInput').val().trim();
            if (!text && !selectedImage) return;

            showLoading(true, 'Envoi...');
            try {
                let content = buildContent(text);
                let tags = [['application', 'UPlanet']];

                if (locationEnabled && currentLat !== null) {
                    tags.push(['latitude', currentLat.toFixed(2)], ['longitude', currentLon.toFixed(2)]);
                    tags.push(['g', `${currentLat.toFixed(6)};${currentLon.toFixed(6)}`]);
                }

                if (isConversation) {
                    tags.push(['expiration', (Math.floor(Date.now() / 1000) + 3600).toString()]);
                }

                if (selectedImage) {
                    showLoading(true, 'Upload...');
                    try {
                        const result = await uploadNip96(selectedImage);
                        content += '\n' + result.url;
                        if (result.tags) tags = tags.concat(result.tags);
                    } catch (e) { log(`Upload error: ${e.message}`); }
                }

                const event = {
                    kind: 1,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags,
                    content
                };

                showLoading(true, 'Signature...');
                const signed = await window.nostr.signEvent(event);

                showLoading(true, 'Publication...');
                let success = 0;
                await Promise.all(allRelays.map(async r => { if (await publishToRelay(r, signed)) success++; }));

                if (success > 0) {
                    log(`Published to ${success} relays`);
                    $('#messageInput').val('').css('height', 'auto');
                    clearImage();
                    setTimeout(fetchMessages, 3000);
                }
            } catch (e) {
                log(`Send error: ${e.message}`);
            } finally {
                showLoading(false);
            }
        }

        function buildContent(text) {
            let prefix = '#BRO ';
            const svc = currentInputService;
            if (svc === 'image') prefix += '#image ';
            else if (svc === 'video') prefix += '#video ';
            else if (svc === 'music') prefix += '#music ';
            else if (svc === 'search') prefix += '#search ';
            else if (svc === 'nature') prefix += '#plantnet ';
            return prefix + text;
        }

        // === UI ===
        function updateInputHint(svc) {
            const hints = {
                chat: 'üí¨ Posez une question √† votre IA',
                image: 'üñºÔ∏è D√©crivez l\'image √† g√©n√©rer',
                video: 'üé¨ D√©crivez la sc√®ne vid√©o',
                music: 'üéµ Style: "jazz piano 80bpm"',
                search: 'üîç Recherche web',
                nature: 'üåø Joignez une photo √† identifier'
            };
            $('#serviceHint').text(hints[svc] || hints.chat);
        }

        function setMode(conversation) {
            isConversation = conversation;
            $('#btnConversation').toggleClass('active', conversation);
            $('#btnPublic').toggleClass('active warn', !conversation);
        }

        // Open webcam upload page
        function openWebcamUpload() {
            if (!publicKey) {
                log('Please connect to NOSTR first');
                showNotification('Connectez-vous d\'abord √† NOSTR pour ajouter une vid√©o', 'connect');
                return;
            }
            window.open('/webcam', '_blank');
        }

        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => {
                    selectedImage = ev.target.result;
                    $('#imgPreview').attr('src', selectedImage);
                    $('#imgPreviewWrap').addClass('visible');
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            selectedImage = null;
            $('#imgPreview').attr('src', '#');
            $('#imgPreviewWrap').removeClass('visible');
            $('#imgInput').val('');
        }

        function showLoading(show, text) {
            $('#loadingBar').toggleClass('visible', show);
            $('#loadingText').text(text || '');
            $('#btnSend').prop('disabled', show || !publicKey);
        }

        function openLightbox(src) {
            $('#lightboxImg').attr('src', src);
            $('#lightbox').addClass('active');
        }

        function closeLightbox() { $('#lightbox').removeClass('active'); }

        // === LOCATION ===
        function getLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                pos => {
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    $('#latInput').val(currentLat.toFixed(2));
                    $('#lonInput').val(currentLon.toFixed(2));
                    $('#btnLocation').addClass('active');
                    log(`Location: ${currentLat.toFixed(2)}, ${currentLon.toFixed(2)}`);
                },
                () => { locationEnabled = false; $('#btnLocation').removeClass('active'); },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function initMiniMap() {
            const lat = currentLat || 0, lon = currentLon || 0;
            $('#mapContainer').show();
            miniMap = L.map('mini-map').setView([lat, lon], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
            miniMap.marker = L.marker([lat, lon], { draggable: true }).addTo(miniMap);
            miniMap.marker.on('dragend', e => {
                const p = e.target.getLatLng();
                currentLat = p.lat; currentLon = p.lng;
                $('#latInput').val(currentLat.toFixed(2));
                $('#lonInput').val(currentLon.toFixed(2));
            });
        }

        // === UTILS ===
        function getPool() {
            if (!pool) pool = new NostrTools.SimplePool({ getTimeout: 6000, listTimeout: 6000 });
            return pool;
        }

        function detectMediaType(url) {
            const l = url.toLowerCase();
            if (/\.(jpg|jpeg|png|webp)(\?|$)/i.test(l)) return 'image';
            if (/\.gif(\?|$)/i.test(l)) return 'gif';
            if (/\.(mp4|webm|mov)(\?|$)/i.test(l)) return 'video';
            if (/\.(mp3|wav|ogg|m4a)(\?|$)/i.test(l)) return 'audio';
            if (/ipfs/i.test(l)) {
                if (/video_|\.mp4|\.webm/i.test(l)) return 'video';
                if (/audio_|\.mp3|\.wav/i.test(l)) return 'audio';
                if (/\.gif/i.test(l)) return 'gif';
                return 'image';
            }
            return null;
        }

        function extractTags(content) {
            const tags = [];
            if (/#image/i.test(content)) tags.push('image');
            if (/#video/i.test(content)) tags.push('video');
            if (/#music/i.test(content)) tags.push('music');
            if (/#search/i.test(content)) tags.push('search');
            if (/#plantnet|#inventory/i.test(content)) tags.push('nature');
            return tags;
        }

        function extractMediaUrls(content) {
            // Extract full URLs (http/https)
            const httpUrls = content.match(/(https?:\/\/[^\s<>"]+)/gi) || [];
            
            // Extract relative IPFS paths (/ipfs/Qm... or /ipns/...)
            const ipfsPaths = content.match(/(\/ipfs\/[^\s<>"]+|\/ipns\/[^\s<>"]+)/gi) || [];
            
            // Combine and normalize all URLs
            return [...httpUrls, ...ipfsPaths]
                .filter(u => detectMediaType(u))
                .map(u => normalizeIpfsUrl(u)); // Normalize to full gateway URLs
        }

        function cleanContent(content, mediaUrls) {
            let text = content;
            // Remove normalized URLs from display
            mediaUrls.forEach(u => { text = text.replace(u, ''); });
            // Also remove original IPFS paths (before normalization)
            text = text.replace(/(\/ipfs\/[^\s<>"]+|\/ipns\/[^\s<>"]+)/gi, '');
            text = text.replace(/(https?:\/\/[^\s<>"]+\.(mp4|webm|mp3|wav|ogg|jpg|jpeg|png|gif|webp|avif)([^\s<>"]*)?)/gi, '');
            return text.replace(/#(BRO|BOT|image|video|music|search|plantnet|inventory|mem|reset)\s*/gi, '').trim();
        }

        function linkify(text) {
            return text.replace(/(https?:\/\/[^\s<>"]+)/gi, '<a href="$1" target="_blank">$1</a>');
        }

        function getExpiration(event) {
            const t = event.tags?.find(t => t[0] === 'expiration');
            return t ? parseInt(t[1], 10) : null;
        }

        function formatExpiry(ts) {
            const rem = ts - Math.floor(Date.now() / 1000);
            if (rem <= 0) return 'Expir√©';
            const m = Math.floor(rem / 60);
            return m < 60 ? `${m}min` : `${Math.floor(m/60)}h`;
        }

        async function uploadNip96(dataUrl) {
            const res = await fetch('/.well-known/nostr/nip96.json');
            const cfg = await res.json();
            const b64 = dataUrl.split(',')[1];
            const mime = dataUrl.split(',')[0].split(':')[1].split(';')[0];
            const bin = atob(b64);
            const arr = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
            const file = new File([new Blob([arr], { type: mime })], `img-${Date.now()}.png`, { type: mime });
            const fd = new FormData();
            fd.append('file', file);
            const r = await fetch(cfg.api_url, { method: 'POST', body: fd });
            const data = await r.json();
            if (data.status === 'success' && data.nip94_event?.tags) {
                let url = data.nip94_event.tags.find(t => t[0] === 'url')?.[1];
                if (url?.startsWith('/ipfs/') && cfg.download_url) url = cfg.download_url.replace(/\/$/, '') + url;
                return { url, tags: data.nip94_event.tags.filter(t => t[0] !== 'url') };
            }
            throw new Error('Upload failed');
        }

        async function publishToRelay(url, event) {
            return new Promise(resolve => {
                try {
                    const ws = new WebSocket(url);
                    const timeout = setTimeout(() => { ws.close(); resolve(false); }, 5000);
                    ws.onopen = () => ws.send(JSON.stringify(['EVENT', event]));
                    ws.onmessage = e => {
                        try {
                            const m = JSON.parse(e.data);
                            if (m[0] === 'OK' && m[1] === event.id) { clearTimeout(timeout); ws.close(); resolve(true); }
                        } catch {}
                    };
                    ws.onerror = () => { clearTimeout(timeout); resolve(false); };
                } catch { resolve(false); }
            });
        }
    </script>

    <!-- NOTIFICATION MODAL (Bootstrap) -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content" style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px;">
                <div class="modal-header" style="border-bottom: 1px solid var(--border); padding: 12px 16px;">
                    <h6 class="modal-title" id="notificationModalLabel" style="color: var(--accent-cyan); font-family: 'Orbitron', sans-serif; font-size: 0.85rem;">
                        <span id="notificationIcon">‚ÑπÔ∏è</span> <span id="notificationTitle">Notification</span>
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="font-size: 0.7rem;"></button>
                </div>
                <div class="modal-body" style="padding: 16px; color: var(--text-primary); font-size: 0.8rem;">
                    <p id="notificationMessage" style="margin: 0;"></p>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border); padding: 10px 16px;">
                    <button type="button" class="btn btn-sm" data-bs-dismiss="modal" 
                            style="background: var(--accent-cyan); color: var(--bg-void); border: none; border-radius: 6px; font-size: 0.75rem; padding: 6px 16px;">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
