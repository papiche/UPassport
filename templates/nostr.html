<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="icon" type="image/x-icon" href="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1">
    <title>ðŸ¤– #BRO Terminal</title>
    <script src="/earth/jquery-3.6.3.min.js"></script>
    <script src="/earth/nostr.bundle.js"></script>
    <script src="/earth/common.js"></script>
    <script src="/earth/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="/earth/bootstrap.min.css"/>
    <link rel="stylesheet" href="/earth/leaflet.css"/>
    <script src="/earth/leaflet.js"></script>
    <!-- YouTube Enhancements for advanced Tube features -->
    <script src="/earth/youtube.enhancements.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-void: #0a0a0f;
            --bg-panel: #12141a;
            --bg-input: #1a1d24;
            --bg-hover: #22262f;
            --text-primary: #e0e6ed;
            --text-dim: #5a6270;
            --accent-cyan: #00d4ff;
            --accent-green: #00ff88;
            --accent-orange: #ff9500;
            --accent-purple: #9966ff;
            --accent-red: #ff4466;
            --border: rgba(0, 212, 255, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; min-height: 100vh; min-height: 100dvh; }

        body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg-void);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
        }

        /* Responsive: mobile-first adjustments */
        @media (max-width: 767.98px) {
            .top-bar { padding: 6px 8px; gap: 6px; flex-wrap: wrap; }
            .top-bar .logo { font-size: 0.85rem; }
            .profile-mini .name { max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .zen-balance { font-size: 0.65rem; padding: 2px 6px; }
            .topbar-services { margin-left: 4px; }
            .topbar-service-btn { width: 28px; height: 28px; font-size: 0.95rem; }
            .btn-connect { padding: 4px 10px; font-size: 0.75rem; }
            .service-bar { padding: 4px 6px; gap: 4px; flex-wrap: wrap; }
            .svc-tab { padding: 6px 10px; font-size: 0.8rem; }
            .flux-tag-cloud { padding: 4px 6px; gap: 4px; }
            .tag-cloud-pill { padding: 2px 6px; font-size: 0.65rem; }
            .main-content .chat-wrapper { margin-left: 36px; margin-right: 36px; }
            .main-content.flux-mode .chat-wrapper { margin-left: 6px; margin-right: 6px; }
            .nav-arrow { width: 32px; height: 60px; font-size: 1.2rem; }
            .chat-area { padding: 8px; gap: 6px; }
            .msg { padding: 8px 10px; font-size: 0.8rem; }
            .input-section { padding: 8px; }
            .input-options { gap: 4px; margin-bottom: 6px; }
            .opt-btn { padding: 3px 8px; font-size: 0.65rem; }
            .input-row { gap: 6px; }
            #messageInput { padding: 10px 12px; min-height: 44px; font-size: 16px; }
            .btn-send { padding: 10px 14px; font-size: 0.75rem; }
        }
        @media (min-width: 768px) {
            .main-content .chat-wrapper { margin-left: 45px; margin-right: 45px; }
            .main-content.flux-mode .chat-wrapper { margin-left: 12px; margin-right: 12px; }
        }
        /* Fullscreen input on small screens: safe area and close button */
        @media (max-width: 767.98px) {
            .input-section.input-section-fullscreen { padding: 12px env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); padding-top: 48px; }
            .input-section-fullscreen .input-fullscreen-close { top: 12px; right: 12px; }
        }

        /* === TOP BAR === */
        .top-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .top-bar.with-banner {
            background-size: 100% 100%;
            background-position: center;
            background-repeat: no-repeat;
            min-height: 50px;
            height: auto;
        }

        .top-bar.with-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to right, rgba(10, 10, 15, 0.85), rgba(10, 10, 15, 0.5), rgba(10, 10, 15, 0.85));
            z-index: 0;
        }

        .top-bar > * {
            position: relative;
            z-index: 1;
        }

        /* ZEN Balance display */
        .zen-balance {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 212, 255, 0.1));
            border: 1px solid var(--accent-green);
            border-radius: 12px;
            font-size: 0.7rem;
            color: var(--accent-green);
            font-weight: 600;
            margin-left: auto;
            white-space: nowrap;
        }

        .zen-balance .zen-icon {
            font-size: 0.8rem;
        }

        .zen-balance .zen-amount {
            color: var(--text-primary);
        }

        .zen-balance .zencard-icon {
            margin-left: 4px;
            color: var(--accent-purple);
            font-size: 0.9rem;
            cursor: help;
        }

        .zen-balance.loading {
            opacity: 0.6;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Topbar Service Buttons (uDRIVE, UMAP) */
        .topbar-services {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 8px;
        }

        .topbar-service-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--bg-input), var(--bg-panel));
            border: 1px solid var(--border);
            border-radius: 8px;
            text-decoration: none;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .topbar-service-btn:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
            transform: scale(1.1);
        }

        #topbarUdrive:hover {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            border-color: #4CAF50;
        }

        #topbarUmap:hover {
            background: linear-gradient(135deg, #2196F3, #1565C0);
            border-color: #2196F3;
        }

        #topbarCrowdfunding {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2));
            border-color: #22c55e;
        }

        #topbarCrowdfunding:hover {
            background: linear-gradient(135deg, #22c55e, #10b981);
            border-color: #22c55e;
        }

        .crowdfunding-link:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(16, 185, 129, 0.25)) !important;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }

        /* SociÃ©taire Status Badge */
        .societaire-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.6rem;
            font-weight: 600;
            margin-left: 4px;
        }

        .societaire-badge.constellation {
            background: linear-gradient(135deg, rgba(147, 112, 219, 0.4), rgba(255, 165, 0, 0.3));
            border: 1px solid #9370db;
            color: #dda0dd;
            box-shadow: 0 0 8px rgba(147, 112, 219, 0.3);
        }

        .societaire-badge.satellite {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 165, 0, 0.2));
            border: 1px solid var(--accent-gold, #ffd700);
            color: #ffd700;
        }

        .societaire-badge.member {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 165, 0, 0.2));
            border: 1px solid var(--accent-gold, #ffd700);
            color: #ffd700;
        }

        .societaire-badge.visitor {
            background: linear-gradient(135deg, rgba(128, 128, 128, 0.2), rgba(100, 100, 100, 0.1));
            border: 1px solid var(--border);
            color: var(--text-dim);
        }

        /* DID Profile Panel */
        .did-panel {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 280px;
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            z-index: 200;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .did-panel.visible {
            display: block;
        }

        .did-panel h4 {
            font-size: 0.75rem;
            color: var(--accent-cyan);
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .did-panel .did-section {
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .did-panel .did-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .did-panel .did-label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .did-panel .did-value {
            font-size: 0.7rem;
            color: var(--text-primary);
            word-break: break-all;
        }

        .did-panel .did-value.highlight {
            color: var(--accent-green);
            font-weight: 600;
        }

        .did-panel .did-value.warning {
            color: var(--accent-gold, #ffd700);
        }

        .did-panel .services-list {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .did-panel .service-tag {
            padding: 2px 6px;
            background: var(--bg-input);
            border-radius: 4px;
            font-size: 0.55rem;
            color: var(--accent-cyan);
        }

        /* Auth Badge */
        .auth-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.6rem;
            font-weight: 600;
        }

        .auth-badge.pending {
            background: rgba(255, 165, 0, 0.2);
            border: 1px solid var(--accent-orange);
            color: var(--accent-orange);
        }

        .auth-badge.authenticated {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .auth-badge.failed {
            background: rgba(255, 68, 102, 0.2);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
        }

        /* Service Links in DID Panel */
        .did-panel .service-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(153, 102, 255, 0.1));
            border: 1px solid var(--accent-cyan);
            border-radius: 6px;
            color: var(--accent-cyan);
            text-decoration: none;
            font-size: 0.65rem;
            transition: all 0.2s;
            width: 100%;
            justify-content: center;
        }

        .did-panel .service-link:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.3), rgba(153, 102, 255, 0.2));
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
        }

        .did-panel .service-link .icon {
            font-size: 0.8rem;
        }

        /* Hidden service sections */
        .did-panel .hidden-service {
            display: none !important;
        }

        .did-panel .hidden-service.visible {
            display: block !important;
        }

        /* Societaire Warning Banner */
        .societaire-warning {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.2), rgba(255, 100, 0, 0.1));
            border: 1px solid var(--accent-gold, #ffa500);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.65rem;
            color: var(--accent-gold, #ffa500);
            margin-bottom: 8px;
    text-align: center;
        }

        .societaire-warning.constellation-warning {
            background: linear-gradient(135deg, rgba(147, 112, 219, 0.2), rgba(255, 165, 0, 0.1));
            border: 1px solid #9370db;
            color: #dda0dd;
        }

        .societaire-warning a {
            color: var(--accent-cyan);
            text-decoration: underline;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--accent-cyan);
            cursor: pointer;
        }

        .profile-mini {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            padding: 3px 8px;
            background: var(--bg-input);
            border-radius: 12px;
            font-size: 0.7rem;
        }

        .profile-mini img {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--border);
        }

        .profile-mini .name {
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-dim);
        }

        .profile-mini.connected .name { color: var(--accent-green); }

        .btn-connect {
            padding: 4px 10px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 10px;
            color: var(--bg-void);
            font-family: inherit;
            font-size: 0.7rem;
            font-weight: 700;
            cursor: pointer;
        }

        .btn-connect:disabled { background: var(--bg-hover); color: var(--text-dim); }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .status-dot.offline { background: var(--accent-red); animation: none; }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* === SERVICE TABS === */
        .service-bar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        /* Main tabs */
        .svc-tab {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            color: var(--text-dim);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .svc-tab:hover { 
            background: var(--bg-hover); 
            color: var(--text-primary); 
        }

        .svc-tab.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 255, 136, 0.1));
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.3);
        }

        .dropdown-arrow {
            font-size: 0.6rem;
            margin-left: 4px;
            transition: transform 0.2s;
        }

        .svc-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* Dropdown container */
        .svc-dropdown {
            position: relative;
        }

        .svc-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px;
            display: none;
            flex-direction: column;
            gap: 2px;
            min-width: 140px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .svc-dropdown.open .svc-dropdown-menu {
            display: flex;
        }

        .svc-sub {
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            text-align: left;
            transition: all 0.15s;
        }

        .svc-sub:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .svc-sub.active {
            background: rgba(0, 212, 255, 0.15);
            color: var(--accent-cyan);
        }

        .svc-sub .svc-count {
            margin-left: auto;
            padding: 2px 6px;
            background: var(--bg-hover);
            border-radius: 10px;
            font-size: 0.6rem;
            color: var(--accent-cyan);
        }

        /* Tab count badge */
        .svc-tab[data-count]:not([data-count=""])::after {
            content: attr(data-count);
            margin-left: 6px;
            padding: 1px 5px;
            background: var(--accent-cyan);
            color: var(--bg-void);
            border-radius: 8px;
            font-size: 0.55rem;
            font-weight: 700;
        }

        /* Add button */
        .svc-btn.add-btn {
            padding: 6px 10px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
            color: var(--bg-void);
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            margin-left: auto;
            transition: all 0.2s;
        }

        .svc-btn.add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.4);
        }

        /* Compact on small screens */
        @media (max-width: 420px) {
            .svc-tab {
                padding: 6px 10px;
                font-size: 0.65rem;
            }
            .svc-btn.add-btn {
                padding: 5px 8px;
                font-size: 0.7rem;
            }
        }

        .svc-btn .count {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--accent-purple);
            color: white;
            font-size: 0.5rem;
            padding: 1px 4px;
            border-radius: 6px;
            min-width: 14px;
            text-align: center;
        }

        /* N/NÂ² filter (p21 vs p2p) - visible when N or NÂ² tab active */
        .n-feed-filter-wrap {
            display: inline-flex;
            align-items: center;
        }
        .n-feed-filter-select {
            padding: 4px 8px;
            font-size: 0.7rem;
            font-family: inherit;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
        }
        .n-feed-filter-select:hover {
            border-color: var(--accent-cyan);
        }

        /* Tag cloud below message list (Flux): tags extracted from displayed messages */
        .flux-tag-cloud {
            flex-shrink: 0;
            padding: 6px 10px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            max-width: 100%;
            min-height: 0;
        }
        .tag-cloud-label {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-right: 4px;
        }
        .tag-cloud-pill {
            padding: 3px 8px;
            font-size: 0.7rem;
            font-family: inherit;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-dim);
            cursor: pointer;
        }
        .tag-cloud-pill:hover {
            border-color: var(--accent-cyan);
            color: var(--text-primary);
        }
        .tag-cloud-pill.active {
            background: rgba(0, 212, 255, 0.15);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }
        .input-tag-icons { display: inline-flex; align-items: center; gap: 2px; }
        .input-tag-btn { min-width: 28px; }
        .input-tag-btn.active { border-color: var(--accent-cyan); color: var(--accent-cyan); }

        /* Blog feed: article cards (kind 30023) */
        .blog-article-card {
            padding: 12px;
            background: var(--bg-panel);
            border-radius: 10px;
            border-left: 3px solid var(--accent-cyan);
            margin-bottom: 8px;
        }
        .blog-article-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        .blog-article-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border);
        }
        .blog-article-meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .blog-article-author {
            font-size: 0.75rem;
            color: var(--accent-cyan);
            cursor: pointer;
        }
        .blog-article-author:hover { text-decoration: underline; }
        .blog-article-date {
            font-size: 0.65rem;
            color: var(--text-dim);
        }
        .blog-article-title {
            font-size: 0.95rem;
            margin: 0 0 6px 0;
            color: var(--text-primary);
        }
        .blog-article-preview {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin: 0 0 8px 0;
            line-height: 1.4;
        }
        .blog-article-view-btn {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--accent-cyan);
            cursor: pointer;
        }
        .blog-article-view-btn:hover {
            border-color: var(--accent-cyan);
            background: rgba(0, 212, 255, 0.1);
        }

        /* === MAIN CONTENT WITH NAV ARROWS === */
        .main-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        /* Navigation arrows on sides */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 80px;
            background: linear-gradient(90deg, rgba(0,212,255,0.1), rgba(0,212,255,0.3));
            border: none;
            color: var(--accent-cyan);
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
                justify-content: center;
            transition: all 0.2s;
        }

        .nav-arrow:hover { background: linear-gradient(90deg, rgba(0,212,255,0.2), rgba(0,212,255,0.5)); }
        .nav-arrow:disabled { opacity: 0.2; cursor: default; }

        .nav-arrow.left {
            left: 0;
            border-radius: 0 8px 8px 0;
        }

        .nav-arrow.right {
            right: 0;
            border-radius: 8px 0 0 8px;
        }

        /* Chat area between arrows */
        .chat-wrapper {
            flex: 1;
            display: flex;
                flex-direction: column;
            margin: 0 45px;
            overflow: hidden;
            transition: margin 0.2s;
        }

        /* Flux mode - full width, no arrows */
        .main-content.flux-mode .chat-wrapper {
            margin: 0 10px;
        }

        .main-content.flux-mode .nav-arrow {
            display: none;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
             padding: 10px;
            display: flex;
            flex-direction: column;
                gap: 8px;
            }

        .chat-area::-webkit-scrollbar { width: 4px; }
        .chat-area::-webkit-scrollbar-track { background: var(--bg-panel); }
        .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* Flux mode - vertical feed styling */
        .main-content.flux-mode .chat-area {
            gap: 12px;
            padding: 12px;
        }

        .main-content.flux-mode .msg {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .main-content.flux-mode .msg-counter {
            display: none;
        }

        /* Message counter */
        .msg-counter {
            text-align: center;
            font-size: 0.65rem;
            color: var(--text-dim);
            padding: 4px;
            background: var(--bg-panel);
            border-radius: 4px;
            margin-bottom: 6px;
        }

        /* N / NÂ² feed: message card with author avatar + name (clickable) */
        .n-feed-msg {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-panel);
            border-radius: 10px;
            border-left: 3px solid var(--accent-cyan);
            font-size: 0.85rem;
        }
        .n-feed-author {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            transition: opacity 0.15s;
        }
        .n-feed-author:hover { opacity: 0.85; color: var(--accent-cyan); }
        .n-feed-author img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid var(--border);
        }
        .n-feed-author .name {
            font-size: 0.7rem;
            max-width: 72px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }
        .n-feed-body { flex: 1; min-width: 0; }
        .n-feed-body .msg-content { word-break: break-word; margin-bottom: 4px; white-space: pre-line; }
        .n-feed-body .msg-content.markdown-content h1, .n-feed-body .msg-content.markdown-content h2, .n-feed-body .msg-content.markdown-content h3 { margin: 0.5em 0 0.25em; font-size: 1em; }
        .n-feed-body .msg-content.markdown-content pre { background: var(--bg-input); padding: 8px; border-radius: 6px; overflow-x: auto; font-size: 0.8em; margin: 6px 0; }
        .n-feed-body .msg-content.markdown-content code { background: var(--bg-input); padding: 2px 4px; border-radius: 4px; font-size: 0.9em; }
        .n-feed-body .msg-content.markdown-content a { color: var(--accent-cyan); }
        .n-feed-body .msg-content.markdown-content blockquote { border-left: 3px solid var(--accent-cyan); padding-left: 8px; margin: 4px 0; color: var(--text-dim); }
        .n-feed-body .msg-time { font-size: 0.65rem; color: var(--text-dim); }
        .n-feed-via { display: flex; align-items: center; gap: 4px; margin-bottom: 6px; flex-wrap: wrap; }
        .n-feed-via-label { font-size: 0.65rem; color: var(--text-dim); margin-right: 4px; }
        .n-feed-via .via-avatar { width: 20px; height: 20px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); cursor: pointer; }
        .n-feed-via .via-avatar:hover { opacity: 0.9; }
        .n-feed-reply-btn {
            margin-top: 6px;
            padding: 4px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 0.7rem;
            cursor: pointer;
            transition: color 0.15s, border-color 0.15s;
        }
        .n-feed-reply-btn:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); }
        .n-feed-actions { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
        .reply-to-hint {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            margin-bottom: 6px;
            background: var(--bg-input);
            border: 1px solid var(--accent-cyan);
            border-radius: 6px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }
        .reply-to-hint.visible { display: flex; }
        .reply-to-hint .cancel-reply { margin-left: auto; padding: 2px 8px; cursor: pointer; color: var(--accent-cyan); }
        .reply-to-hint .cancel-reply:hover { text-decoration: underline; }

        .msg {
            padding: 10px 12px;
            background: var(--bg-panel);
            border-radius: 8px;
            border-left: 3px solid var(--text-dim);
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .msg.user { border-left-color: var(--accent-cyan); }
        .msg.bot {
            border-left-color: var(--accent-green);
            background: linear-gradient(90deg, rgba(0,255,136,0.05), transparent);
        }

        .msg-header-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 6px;
            vertical-align: middle;
            border: 1px solid var(--border);
        }
        .msg-header .msg-author-link {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }
        .msg-header .msg-author-link:hover { color: var(--accent-cyan); text-decoration: underline; }
        .msg-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .msg-header .tag {
            padding: 2px 6px;
            background: var(--bg-hover);
            border-radius: 3px;
            font-size: 0.6rem;
        }

        .msg-header .tag.video { color: var(--accent-red); }
        .msg-header .tag.image { color: var(--accent-purple); }
        .msg-header .tag.music { color: var(--accent-orange); }
        .msg-header .tag.search { color: var(--accent-green); }
        .msg-header .tag.nature { color: #4CAF50; }
        .msg-header .tag.generic { color: var(--accent-cyan); opacity: 0.8; }

        .msg-delete-btn {
            margin-left: auto;
            padding: 2px 6px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 0.75rem;
            cursor: pointer;
            transition: color 0.15s, border-color 0.15s;
        }
        .msg-delete-btn:hover {
            color: var(--accent-red);
            border-color: var(--accent-red);
        }

        .msg-copy-btn {
            margin-left: 4px;
            padding: 2px 6px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 0.75rem;
            cursor: pointer;
            transition: color 0.15s, border-color 0.15s;
        }
        .msg-copy-btn:hover {
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        .msg-content { word-break: break-word; white-space: pre-line; }
        .msg-content a { color: var(--accent-cyan); text-decoration: none; }
        .msg-content a:hover { text-decoration: underline; }

        .msg-media {
            margin-top: 8px;
            border-radius: 6px;
            overflow: hidden;
            background: var(--bg-void);
        }

        .msg-media img, .msg-media video {
            max-width: 100%;
            max-height: 250px;
            display: block;
            cursor: pointer;
        }

        .msg-media audio { width: 100%; height: 36px; }

        /* Webpage preview styles */
        .msg-media.webpage-preview {
            background: var(--bg-panel);
            border: 1px solid var(--border);
        }

        .webpage-frame {
            position: relative;
            width: 100%;
            height: 180px;
            overflow: hidden;
        }

        .webpage-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
            pointer-events: none;
            transform: scale(0.8);
            transform-origin: top left;
            width: 125%;
            height: 125%;
        }

        .webpage-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
             cursor: pointer;
        }

        .webpage-overlay:hover {
            opacity: 1;
        }

        .webpage-overlay span {
            background: var(--accent-cyan);
            color: var(--bg-void);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .webpage-link {
            display: block;
            padding: 8px 12px;
            color: var(--accent-cyan);
            font-size: 0.75rem;
            text-decoration: none;
            background: var(--bg-input);
            border-top: 1px solid var(--border);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .webpage-link:hover {
            background: var(--bg-hover);
            text-decoration: underline;
        }

        .webpage-link span {
            margin-right: 6px;
        }

        .msg-time {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 6px;
            text-align: right;
        }

        .msg-links {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-input);
            border-radius: 6px;
            border-left: 2px solid var(--accent-cyan);
        }

        .msg-links a {
            color: var(--accent-cyan);
            text-decoration: none;
            font-size: 0.75rem;
            word-break: break-all;
        }

        .msg-links a:hover {
            text-decoration: underline;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
                justify-content: center;
            color: var(--text-dim);
            font-size: 0.85rem;
            text-align: center;
            padding: 20px;
        }

        .empty-state .icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; }

        /* === INPUT SECTION (below chat) === */
        .input-section {
            position: relative;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 10px;
            flex-shrink: 0;
            transition: box-shadow 0.2s;
        }
        /* Fullscreen input zone */
        .input-section.input-section-fullscreen {
            position: fixed;
            inset: 0;
            z-index: 9998;
            display: flex;
            flex-direction: column;
            padding: 12px;
            background: var(--bg-panel);
            border: none;
            box-shadow: 0 0 0 2px var(--accent-cyan);
        }
        .input-section-fullscreen .input-row { flex: 1; display: flex; flex-direction: column; align-items: stretch; min-height: 0; }
        .input-section-fullscreen #messageInput { flex: 1; min-height: 120px; max-height: none; resize: none; }
        .input-section-fullscreen .input-fullscreen-close {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 36px;
            height: 36px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .input-section-fullscreen .input-fullscreen-close:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); }
        .btn-input-fullscreen {
            padding: 12px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 1rem;
            cursor: pointer;
            flex-shrink: 0;
        }
        .btn-input-fullscreen:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }

        .input-options {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .opt-btn {
            padding: 4px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s;
        }

        .opt-btn:hover { border-color: var(--accent-cyan); color: var(--text-primary); }
        .opt-btn.active { background: var(--accent-cyan); color: var(--bg-void); border-color: var(--accent-cyan); }
        .opt-btn.warn.active { background: var(--accent-orange); border-color: var(--accent-orange); }

        .sub-options {
            display: none;
            gap: 4px;
            margin-left: auto;
            align-items: center;
        }

        .sub-options.visible { display: flex; }

        .sub-opt {
            padding: 3px 8px;
            background: var(--bg-hover);
            border: 1px solid transparent;
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 0.65rem;
            cursor: pointer;
        }

        .sub-opt:hover { border-color: var(--border); }
        .sub-opt.active { border-color: var(--accent-cyan); color: var(--accent-cyan); }

        /* I2V Image input buttons */
        .i2v-btns {
            display: none;
            gap: 4px;
            align-items: center;
            margin-left: 4px;
            padding-left: 4px;
            border-left: 1px solid var(--border);
        }

        .i2v-btns.visible { display: flex; }

        .i2v-btn {
            padding: 3px 6px;
            background: var(--bg-hover);
            border: 1px solid var(--accent-purple);
            border-radius: 4px;
            color: var(--accent-purple);
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .i2v-btn:hover {
            background: var(--accent-purple);
            color: var(--bg-void);
        }

        .i2v-btn.has-image {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--bg-void);
        }

        .i2v-required {
            font-size: 0.6rem;
            color: var(--accent-orange);
            margin-left: 4px;
        }

        .i2v-required.ok { color: var(--accent-green); }

        .img-preview-wrap {
            display: none;
            position: relative;
            margin-bottom: 8px;
        }

        .img-preview-wrap.visible { display: inline-block; }

        .img-preview-wrap img {
            max-height: 60px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .img-preview-wrap .remove {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 20px;
            height: 20px;
            background: var(--accent-red);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            line-height: 1;
        }

        .input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        #messageInput {
            flex: 1;
            padding: 12px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            resize: none;
            min-height: 50px;
            max-height: 150px;
        }

        #messageInput:focus { outline: none; border-color: var(--accent-cyan); }
        #messageInput::placeholder { color: var(--text-dim); }

        .btn-send {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-send:hover { opacity: 0.9; }
        .btn-send:disabled { background: var(--bg-hover); color: var(--text-dim); }

        .hint {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 6px;
        }

        .bro-commands-help {
            font-size: 0.65rem;
            color: var(--text-dim);
            margin-top: 4px;
        }
        .bro-commands-help summary {
            cursor: pointer;
            color: var(--accent-cyan);
        }
        .bro-commands-help ul {
            margin: 4px 0 0 12px;
            padding-left: 8px;
        }
        .bro-commands-help li {
            margin: 2px 0;
        }
        .bro-commands-help code {
            background: var(--bg-hover);
            padding: 1px 4px;
            border-radius: 4px;
            color: var(--accent-green);
        }

        /* BRO radial menu (long-press) */
        .bro-radial-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(10, 10, 15, 0.85);
            align-items: center;
            justify-content: center;
        }
        .bro-radial-overlay.visible {
            display: flex;
        }
        .bro-radial-circle {
            position: relative;
            width: 280px;
            height: 280px;
        }
        .bro-radial-center {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 52px;
            height: 52px;
            margin-left: -26px;
            margin-top: -26px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 2;
        }
        .bro-radial-ring {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 0;
            height: 0;
            pointer-events: none;
        }
        .bro-radial-ring .bro-radial-item {
            pointer-events: auto;
        }
        .bro-radial-item {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 48px;
            height: 48px;
            margin-left: -24px;
            margin-top: -24px;
            border-radius: 50%;
            background: var(--bg-panel);
            border: 2px solid var(--accent-cyan);
            color: var(--accent-green);
            font-size: 0.6rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, background 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
        }
        .bro-radial-item:hover {
            background: var(--accent-cyan);
            color: var(--bg-void);
            z-index: 1;
        }
        /* Inner ring: 9 items at 65px radius, first at top (-90deg) */
        .bro-radial-ring-inner .bro-radial-item:nth-child(1) { transform: rotate(-90deg) translateY(-65px) rotate(90deg); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(2) { transform: rotate(-50deg) translateY(-65px) rotate(50deg); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(3) { transform: rotate(-10deg) translateY(-65px) rotate(10deg); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(4) { transform: rotate(30deg) translateY(-65px) rotate(-30deg); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(5) { transform: rotate(70deg) translateY(-65px) rotate(-70deg); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(6) { transform: rotate(110deg) translateY(-65px) rotate(-110deg); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(7) { transform: rotate(150deg) translateY(-65px) rotate(-150deg); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(8) { transform: rotate(190deg) translateY(-65px) rotate(-190deg); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(9) { transform: rotate(230deg) translateY(-65px) rotate(-230deg); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(1):hover { transform: rotate(-90deg) translateY(-65px) rotate(90deg) scale(1.12); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(2):hover { transform: rotate(-50deg) translateY(-65px) rotate(50deg) scale(1.12); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(3):hover { transform: rotate(-10deg) translateY(-65px) rotate(10deg) scale(1.12); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(4):hover { transform: rotate(30deg) translateY(-65px) rotate(-30deg) scale(1.12); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(5):hover { transform: rotate(70deg) translateY(-65px) rotate(-70deg) scale(1.12); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(6):hover { transform: rotate(110deg) translateY(-65px) rotate(-110deg) scale(1.12); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(7):hover { transform: rotate(150deg) translateY(-65px) rotate(-150deg) scale(1.12); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(8):hover { transform: rotate(190deg) translateY(-65px) rotate(-190deg) scale(1.12); }
        .bro-radial-ring-inner .bro-radial-item:nth-child(9):hover { transform: rotate(230deg) translateY(-65px) rotate(-230deg) scale(1.12); }
        /* Outer ring: 9 items at 105px radius */
        .bro-radial-ring-outer .bro-radial-item:nth-child(1) { transform: rotate(-90deg) translateY(-105px) rotate(90deg); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(2) { transform: rotate(-50deg) translateY(-105px) rotate(50deg); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(3) { transform: rotate(-10deg) translateY(-105px) rotate(10deg); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(4) { transform: rotate(30deg) translateY(-105px) rotate(-30deg); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(5) { transform: rotate(70deg) translateY(-105px) rotate(-70deg); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(6) { transform: rotate(110deg) translateY(-105px) rotate(-110deg); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(7) { transform: rotate(150deg) translateY(-105px) rotate(-150deg); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(8) { transform: rotate(190deg) translateY(-105px) rotate(-190deg); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(9) { transform: rotate(230deg) translateY(-105px) rotate(-230deg); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(1):hover { transform: rotate(-90deg) translateY(-105px) rotate(90deg) scale(1.12); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(2):hover { transform: rotate(-50deg) translateY(-105px) rotate(50deg) scale(1.12); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(3):hover { transform: rotate(-10deg) translateY(-105px) rotate(10deg) scale(1.12); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(4):hover { transform: rotate(30deg) translateY(-105px) rotate(-30deg) scale(1.12); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(5):hover { transform: rotate(70deg) translateY(-105px) rotate(-70deg) scale(1.12); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(6):hover { transform: rotate(110deg) translateY(-105px) rotate(-110deg) scale(1.12); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(7):hover { transform: rotate(150deg) translateY(-105px) rotate(-150deg) scale(1.12); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(8):hover { transform: rotate(190deg) translateY(-105px) rotate(-190deg) scale(1.12); }
        .bro-radial-ring-outer .bro-radial-item:nth-child(9):hover { transform: rotate(230deg) translateY(-105px) rotate(-230deg) scale(1.12); }

        .loading {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px;
            color: var(--text-dim);
            font-size: 0.75rem;
        }

        .loading.visible { display: flex; }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-hover);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* === SETTINGS === */
        .settings-panel {
            display: none;
                padding: 10px;
            background: var(--bg-input);
            border-top: 1px solid var(--border);
        }

        .settings-panel.open { display: block; }

        .settings-row {
                    display: flex;
                    align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.7rem;
            flex-wrap: wrap;
        }

        .settings-row label { color: var(--text-dim); }

        .settings-row input[type="number"] {
            width: 70px;
            padding: 4px 6px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
                    border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.7rem;
        }

        .toggle-switch {
            width: 32px;
            height: 18px;
            background: var(--bg-panel);
            border-radius: 9px;
            cursor: pointer;
            position: relative;
        }

        .toggle-switch.on { background: var(--accent-cyan); }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle-switch.on::after { transform: translateX(14px); }

        #mini-map { height: 100px; border-radius: 4px; margin-top: 8px; }

        /* === LIGHTBOX === */
        .lightbox {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .lightbox.active { display: flex; }

        /* === MODAL Z-INDEX HIERARCHY === */
        /* Camera modal: above lightbox */
        .camera-modal {
            z-index: 1100 !important;
        }

        /* Notification modal: above everything */
        #notificationModal {
            z-index: 1200 !important;
        }

        #notificationModal .modal-backdrop,
        .modal-backdrop {
            z-index: 1150 !important;
        }
        .lightbox img { max-width: 95%; max-height: 95%; object-fit: contain; }

        .lightbox-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hidden { display: none !important; }

        /* === TUBE MODE (Tube uses same area as Flux/N/NÂ² inside .main-content) === */
        .main-content .tube-panel {
            display: none;
            flex: 1 1 0%;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
            margin: 0 45px;
        }
        .main-content.tube-mode .tube-panel {
            display: flex !important;
        }
        .main-content.tube-mode .chat-wrapper { display: none !important; }
        .main-content.tube-mode .nav-arrow { display: none !important; }
        .main-content.tube-mode .tube-panel { margin: 0 10px; }

        /* When Tube is active, input can be toggled; floating button to expand input */
        .tube-input-toggle {
            position: fixed;
            bottom: 12px;
            right: 12px;
            z-index: 100;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--accent-cyan);
            color: var(--bg-void);
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s, background 0.2s;
        }
        body.tube-mode .tube-input-toggle { display: flex; }
        body.tube-mode .tube-input-toggle.collapsed { display: none !important; }
        .tube-input-toggle:hover { background: var(--accent-cyan); filter: brightness(1.1); transform: scale(1.05); }
        /* When input is visible in Tube mode, show collapse icon on input section */
        .input-section.tube-input-visible .input-collapse-btn { display: flex !important; }
        .input-section .input-collapse-btn {
            display: none;
            position: absolute;
            top: 6px;
            right: 6px;
            width: 32px;
            height: 32px;
            align-items: center;
            justify-content: center;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            z-index: 5;
            font-size: 1rem;
        }
        .input-collapse-btn:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); }

        .tube-header {
            display: flex;
            align-items: center;
                gap: 10px;
            padding: 8px 12px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .tube-header h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            color: var(--accent-cyan);
            margin: 0;
        }

        .tube-filters {
            display: flex;
            gap: 6px;
            margin-left: auto;
            align-items: center;
        }

        .tube-filter-btn {
            padding: 4px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-dim);
            font-family: inherit;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .tube-filter-btn:hover { border-color: var(--accent-cyan); color: var(--text-primary); }
        .tube-filter-btn.active { background: var(--accent-cyan); color: var(--bg-void); border-color: var(--accent-cyan); }

        .filter-sep {
            color: var(--border);
            font-size: 0.7rem;
            padding: 0 2px;
        }

        @media (max-width: 700px) {
            .tube-filters {
                flex-wrap: wrap;
                gap: 4px;
            }
            .filter-sep { display: none; }
            .tube-filter-btn { font-size: 0.6rem; padding: 3px 6px; }
        }

        .tube-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Friends sidebar */
        .friends-sidebar {
            width: 140px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
        }

        .friends-sidebar.collapsed { width: 0; border: none; overflow: hidden; }

        .friends-header {
            padding: 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
            color: var(--text-dim);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.7rem;
        }

        .friend-item:hover { background: var(--bg-hover); }
        .friend-item.selected { background: rgba(0,212,255,0.15); border: 1px solid var(--accent-cyan); }
        .friend-item.all { color: var(--accent-cyan); font-weight: 600; }

        .friend-item img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 1px solid var(--border);
            object-fit: cover;
        }

        .friend-item .name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-primary);
        }

        .friend-item .count {
            font-size: 0.55rem;
            color: var(--text-dim);
            background: var(--bg-input);
            padding: 1px 4px;
            border-radius: 6px;
        }

        /* Video grid */
        .video-grid-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
        }

        @media (max-width: 600px) {
            .video-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
            .friends-sidebar { width: 100px; }
        }

        .video-card {
            background: var(--bg-panel);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .video-card:hover { border-color: var(--accent-cyan); transform: translateY(-2px); }

        .video-thumbnail {
            position: relative;
            aspect-ratio: 16/9;
            background: var(--bg-void);
            overflow: hidden;
        }

        .video-thumbnail img.thumb-static {
                width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.2s;
            }

        .video-thumbnail .thumb-placeholder {
            display: flex;
            align-items: center;
                justify-content: center;
            height: 100%;
            font-size: 2rem;
            background: var(--bg-panel);
            color: var(--text-dim);
        }

        .video-thumbnail img.gifanim {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1;
        }

        .video-card:hover .video-thumbnail img.gifanim {
            opacity: 1;
        }

        .video-card:hover .video-thumbnail img.thumb-static {
            opacity: 0;
        }

        .video-thumbnail .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: white;
            text-shadow: 0 2px 6px rgba(0,0,0,0.5);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 2;
        }

        .video-card:hover .video-thumbnail .play-icon { opacity: 1; }

        .video-thumbnail .duration {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6rem;
        }

        .video-thumbnail .badge-ai {
            position: absolute;
            top: 4px;
            left: 4px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            color: white;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 0.55rem;
            font-weight: 600;
        }

        .video-thumbnail .badge-source {
            position: absolute;
            top: 4px;
            right: 4px;
            color: white;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 0.55rem;
            font-weight: 600;
        }

        .video-thumbnail .badge-source.youtube {
            background: linear-gradient(135deg, #ff0000, #cc0000);
        }

        .video-thumbnail .badge-source.serie {
            background: linear-gradient(135deg, #9c27b0, #673ab7);
        }

        .video-thumbnail .badge-source.film {
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }

        .video-info {
            padding: 8px;
        }

        .video-info .title {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .video-info .meta {
            font-size: 0.6rem;
            color: var(--text-dim);
                    display: flex;
            gap: 6px;
            align-items: center;
        }

        .video-info .meta .author {
                    display: flex;
                    align-items: center;
            gap: 3px;
        }

        .video-info .meta .author img {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        /* Profile Banner for Video Cards */
        .video-author-banner {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: linear-gradient(135deg, var(--bg-input), var(--bg-panel));
            border-bottom: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .video-author-banner.with-banner {
            background-size: cover;
            background-position: center;
        }

        .video-author-banner.with-banner::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(10, 10, 15, 0.9), rgba(10, 10, 15, 0.7));
            z-index: 0;
        }

        .video-author-banner > * {
            position: relative;
            z-index: 1;
        }

        .video-author-banner .author-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--accent-cyan);
            object-fit: cover;
            flex-shrink: 0;
        }

        .video-author-banner .author-details {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .video-author-banner .author-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-author-banner .author-nip05 {
            font-size: 0.55rem;
            color: var(--accent-cyan);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .video-author-banner .author-nip05::before {
            content: 'âœ“ ';
            color: var(--accent-green);
        }

        .video-author-banner .author-pubkey {
            font-size: 0.5rem;
            color: var(--text-dim);
            font-family: monospace;
        }

        .video-card:hover .video-author-banner {
            background-color: var(--bg-hover);
        }

        .tube-empty {
                    display: flex;
                flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--text-dim);
            text-align: center;
        }

        .tube-empty .icon { font-size: 2rem; opacity: 0.4; margin-bottom: 8px; }

        .tube-loading {
            display: flex;
            align-items: center;
                justify-content: center;
            padding: 30px;
            color: var(--text-dim);
        }

        .tube-loading .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toggle friends sidebar on mobile */
        .toggle-friends {
            display: none;
            padding: 4px 8px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 0.7rem;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            .toggle-friends { display: block; }
        }

        /* Theater modal for Tube */
        .theater-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1100;
            display: none;
            flex-direction: column;
        }

        .theater-backdrop.active { display: flex; }

        .theater-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 10;
        }

        .theater-video {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
            min-height: 0; /* Important for flex shrinking */
        }

        .theater-video video {
            max-width: 100%;
            max-height: calc(100vh - 220px); /* Leave space for info panel */
            width: auto;
            height: auto;
            border-radius: 8px;
            object-fit: contain;
        }

        .theater-info {
            padding: 12px 15px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            max-height: 35vh;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .theater-info h4 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .theater-info .meta {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* Theater Author Banner */
        .theater-author-banner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            margin: -12px -15px 12px -15px;
            background: linear-gradient(135deg, var(--bg-input), var(--bg-void));
            border-bottom: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .theater-author-banner.with-banner {
            background-size: cover;
            background-position: center;
        }

        .theater-author-banner.with-banner::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(10, 10, 15, 0.95), rgba(10, 10, 15, 0.75));
            z-index: 0;
        }

        .theater-author-banner > * {
            position: relative;
            z-index: 1;
        }

        .theater-author-banner .author-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-cyan);
            flex-shrink: 0;
        }

        .theater-author-banner .author-details {
            flex: 1;
            min-width: 0;
        }

        .theater-author-banner .author-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theater-author-banner .author-nip05 {
            font-size: 0.8rem;
            color: var(--accent-cyan);
        }

        .theater-author-banner .author-nip05::before {
            content: 'âœ“ ';
            color: var(--accent-green);
        }

        .theater-author-banner .author-pubkey {
            font-size: 0.7rem;
            color: var(--text-dim);
            font-family: monospace;
        }

        /* Theater actions bar */
        .theater-actions {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            flex-wrap: wrap;
        }

        .theater-action-btn {
                    display: flex;
                    align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-dim);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .theater-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--accent-cyan);
        }

        .theater-action-btn.follow-btn {
            background: var(--accent-green);
            color: var(--bg-void);
            border-color: var(--accent-green);
        }

        .theater-action-btn.follow-btn:hover {
            background: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        .theater-action-btn.follow-btn.following {
            background: var(--bg-hover);
            color: var(--text-dim);
            border-color: var(--border);
        }

        .theater-action-btn.active {
            background: rgba(0, 212, 255, 0.2);
            color: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }

        .theater-action-btn .icon { font-size: 1rem; }
        .theater-action-btn .count { color: var(--text-primary); }

        /* Theater comments section */
        .theater-comments {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-void);
            border-radius: 8px;
        }

        .theater-comment {
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
        }

        .theater-comment:last-child { border-bottom: none; }
        .theater-comment .author { color: var(--accent-cyan); font-weight: 600; }
        .theater-comment .text { color: var(--text-primary); margin-left: 6px; }

        .theater-comment-form {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .theater-comment-form input {
            flex: 1;
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 0.75rem;
        }

        .theater-comment-form button {
            padding: 6px 12px;
            background: var(--accent-cyan);
            border: none;
            border-radius: 16px;
            color: var(--bg-void);
            font-weight: 600;
            font-size: 0.75rem;
            cursor: pointer;
        }

        /* Friends list scroll */
        .friends-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .friends-list::-webkit-scrollbar {
            width: 4px;
        }

        .friends-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .friends-list::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        /* UMAP Chat Modal */
        .chat-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-modal-backdrop.active {
            display: flex;
        }

        .chat-modal {
            width: 100%;
            max-width: 600px;
            height: 80vh;
            max-height: 700px;
            background: var(--bg-panel);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .chat-modal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--bg-input), var(--bg-void));
            border-bottom: 1px solid var(--border);
        }

        .chat-modal-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .chat-modal-room {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            font-family: monospace;
        }

        .chat-modal-close {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 8px;
            line-height: 1;
        }

        .chat-modal-close:hover {
            color: var(--accent-red);
        }

        .chat-modal iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: var(--bg-void);
        }

        /* Profile viewer modal (Nostr profile) */
        .profile-viewer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }
        .profile-viewer-backdrop.active {
            display: flex;
        }
        .profile-viewer-modal {
            width: 100%;
            max-width: 900px;
            height: 85vh;
            max-height: 800px;
            background: var(--bg-panel);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .profile-viewer-modal .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .profile-viewer-modal .modal-header .modal-title { font-size: 0.9rem; color: var(--accent-cyan); }
        .profile-viewer-modal .modal-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }
        .profile-viewer-modal .modal-close:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); }
        .profile-viewer-modal iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: var(--bg-void);
        }

        /* Message viewer modal (nostr_message_viewer.html on IPFS gateway) */
        .message-viewer-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }
        .message-viewer-backdrop.active { display: flex; }
        .message-viewer-modal {
            width: 100%;
            max-width: 900px;
            height: 85vh;
            max-height: 800px;
            background: var(--bg-panel);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .message-viewer-modal .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .message-viewer-modal .modal-header .modal-title { font-size: 0.9rem; color: var(--accent-cyan); }
        .message-viewer-modal .modal-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }
        .message-viewer-modal .modal-close:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); }
        .message-viewer-modal iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: var(--bg-void);
        }
        /* URL modal: open external links in iframe instead of new tab */
        .url-modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(0,0,0,0.75);
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .url-modal-backdrop.active { display: flex; }
        .url-modal {
            width: 100%;
            max-width: 95vw;
            height: 90vh;
            max-height: 900px;
            background: var(--bg-panel);
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .url-modal .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .url-modal .modal-title {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            max-width: calc(100% - 50px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .url-modal .modal-close {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
        }
        .url-modal .modal-close:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); }
        .url-modal iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: var(--bg-void);
        }
        .msg-view-btn {
            padding: 2px 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-dim);
            font-size: 0.7rem;
            cursor: pointer;
            margin-left: 4px;
        }
        .msg-view-btn:hover { color: var(--accent-cyan); border-color: var(--accent-cyan); }

        .profile-name-link {
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }
        .profile-name-link:hover { text-decoration: underline; color: var(--accent-cyan); }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- TOP BAR -->
    <div class="top-bar d-flex align-items-center flex-wrap" id="topBar">
        <div class="logo" onclick="location.reload()" title="Reload application">ðŸ¤– #BRO</div>
        <div class="status-dot offline" id="statusDot"></div>
        <div class="profile-mini" id="profileMini" style="cursor:pointer;" onclick="toggleDidPanel()">
            <img src="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1" id="profileImg">
            <a href="#" id="profileNameLink" class="profile-name-link name" title="Open profile in modal" onclick="event.preventDefault();event.stopPropagation();openProfileViewerModal();"><span id="profileName">Non connectÃ©</span></a>
            <span class="societaire-badge visitor" id="societaireBadge" style="display:none;">ðŸ‘¤ Visiteur</span>
        </div>
        <div class="zen-balance" id="zenBalance" style="display:none;">
            <span class="zen-icon">áº</span>
            <span class="zen-amount" id="zenAmount">---</span>
            <span class="zencard-icon" id="zencardIcon" style="display:none;" title="ZEN Card disponible">ðŸ’³</span>
        </div>
        <!-- Quick access buttons for uDRIVE and UMAP -->
        <div class="topbar-services" id="topbarServices">
            <a href="#" id="topbarUdrive" class="topbar-service-btn" target="_blank" title="Mon espace uDRIVE" style="display:none;">
                ðŸ“‚
            </a>
            <a href="#" id="topbarUmap" class="topbar-service-btn" target="_blank" title="UMAP Chat" style="display:none;">
                ðŸ—ºï¸
            </a>
            <a href="/earth/crowdfunding.html" id="topbarCrowdfunding" class="topbar-service-btn crowdfunding" target="_blank" title="ðŸŒ³ Crowdfunding des Communs">
                ðŸŒ³
            </a>
        </div>
        <button class="btn-connect" id="btnConnect">Connecter</button>
        <!-- DID Profile Panel -->
        <div class="did-panel" id="didPanel">
            <h4>ðŸ“‹ IdentitÃ© DÃ©centralisÃ©e (DID)</h4>
            <div class="did-section">
                <div class="did-label">Statut</div>
                <div class="did-value" id="didContractStatus">---</div>
            </div>
            <div class="did-section">
                <div class="did-label">Type de Jetons</div>
                <div class="did-value" id="didTokenTypes">---</div>
            </div>
            <div class="did-section">
                <div class="did-label">Quota Stockage</div>
                <div class="did-value" id="didStorageQuota">---</div>
            </div>
            <div class="did-section">
                <div class="did-label">Services</div>
                <div class="did-value services-list" id="didServices">---</div>
            </div>
            <div class="did-section">
                <div class="did-label">DID (kind 30800)</div>
                <div class="did-value" id="didIdentifier" style="font-size:0.55rem;color:var(--text-dim);">---</div>
            </div>
            <div class="did-section">
                <div class="did-label">Station Astroport</div>
                <div class="did-value" id="didAstroport">---</div>
            </div>
            <div class="did-section">
                <div class="did-label">Authentification</div>
                <div class="did-value" id="didAuthStatus">
                    <span class="auth-badge pending">â³ Non vÃ©rifiÃ©</span>
                </div>
            </div>
            <!-- uDRIVE Section -->
            <div class="did-section hidden-service" id="didUdriveSection">
                <div class="did-label">ðŸ“ uDRIVE</div>
                <div class="did-value">
                    <a href="#" id="didUdriveLink" target="_blank" class="service-link">
                        <span class="icon">ðŸ“‚</span> Ouvrir mon espace
                    </a>
                </div>
            </div>
            <!-- UMAP Chat Section -->
            <div class="did-section hidden-service" id="didUmapSection">
                <div class="did-label">ðŸ’¬ UMAP Chat</div>
                <div class="did-value">
                    <a href="#" id="didUmapLink" target="_blank" class="service-link">
                        <span class="icon">ðŸ—ºï¸</span> <span id="didUmapCoords">Chat local</span>
                    </a>
                </div>
            </div>
            <!-- Crowdfunding Section -->
            <div class="did-section" style="text-align:center;padding-top:8px;margin-top:4px;border-top:1px dashed var(--accent-green);">
                <a href="/earth/crowdfunding.html" target="_blank" class="crowdfunding-link" style="display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.1));border:1px solid var(--accent-green);border-radius:8px;color:var(--accent-green);font-size:0.7rem;text-decoration:none;transition:all 0.2s;" title="Financez les Communs">
                    ðŸŒ³ Crowdfunding des Communs
                </a>
            </div>
        </div>
    </div>

    <!-- SERVICE TABS - 3 main tabs -->
    <div class="service-bar">
        <button class="svc-tab active" data-svc="flux">ðŸ“‹ Flux</button>
        <button class="svc-tab" data-svc="n" title="Messages from friends">N</button>
        <button class="svc-tab" data-svc="n2" title="Messages from friends of friends">NÂ²</button>
        <button class="svc-tab" data-svc="blog" title="Long-form articles (kind 30023)">ðŸ“ Blog</button>
        <span class="n-feed-filter-wrap" id="nFeedFilterWrap" style="display:none;">
            <select id="nFeedFilterSelect" class="n-feed-filter-select" title="N/NÂ² filter: unidirectional (p21) or reciprocal (p2p)">
                <option value="p21">p21</option>
                <option value="p2p">p2p</option>
            </select>
        </span>
        <button class="svc-tab" data-svc="tube">ðŸ“º TUBE</button>
        <button class="svc-btn add-btn" id="btnAddVideo" title="Ajouter une vidÃ©o">âž•</button>
            </div>

    <!-- MAIN CONTENT WITH SIDE ARROWS (Flux/N/NÂ² and Tube share this same area) -->
    <div class="main-content flex-grow-1 d-flex overflow-hidden" id="mainContent">
        <button class="nav-arrow left" id="btnPrev" disabled>â—€</button>
        
        <div class="chat-wrapper">
            <div class="chat-area" id="chatArea">
                <div class="empty-state" id="emptyState">
                    <div class="icon">ðŸ¤–</div>
                    <div>Connectez-vous pour dialoguer</div>
                    <div style="margin-top:6px;font-size:0.7rem;">Votre ASTROBOT rÃ©pond en votre nom</div>
        </div>
            </div>
            <div class="flux-tag-cloud" id="fluxTagCloud" style="display:none;"></div>
        </div>

        <!-- TUBE PANEL (same space as chat-wrapper when Tube tab is active) -->
        <div class="tube-panel" id="tubePanel">
        <div class="tube-header">
            <h3>ðŸ“º NostrTube</h3>
            <div class="tube-filters">
                <button class="tube-filter-btn active" data-filter="all">Tous</button>
                <button class="tube-filter-btn" data-filter="ai">ðŸ¤– IA</button>
                <button class="tube-filter-btn" data-filter="nostr">ðŸ“¡ Nostr</button>
                <span class="filter-sep">|</span>
                <button class="tube-filter-btn" data-filter="short">âš¡ Courts</button>
                <button class="tube-filter-btn" data-filter="long">ðŸŽ¬ Longs</button>
                <span class="filter-sep">|</span>
                <button class="tube-filter-btn" data-filter="youtube">ðŸ“º YouTube</button>
                <button class="tube-filter-btn" data-filter="serie">ðŸŽ­ SÃ©ries</button>
                <button class="tube-filter-btn" data-filter="film">ðŸŽ¬ Films</button>
                <span class="filter-sep">|</span>
                <button class="tube-filter-btn" data-filter="uplanet">ðŸŒ UPlanet</button>
                <button class="tube-filter-btn" data-filter="standard">ðŸ“º Standard</button>
                <button class="toggle-friends" id="toggleFriends">ðŸ‘¥</button>
        </div>
        </div>
        <div class="tube-content">
            <div class="friends-sidebar" id="friendsSidebar">
                <div class="friends-header">
                    <span>ðŸ‘¥ Amis</span>
                    <span id="friendsCount">0</span>
                </div>
                <div class="friends-list" id="friendsList">
                    <div class="friend-item all selected" data-pubkey="all">
                        <span class="name">ðŸŒ Tous les flux</span>
                    </div>
                    <!-- Friends will be loaded here -->
                </div>
            </div>
            <div class="video-grid-container">
                <div class="video-grid" id="videoGrid">
                    <div class="tube-empty">
                        <div class="icon">ðŸ“º</div>
                        <div>Connectez-vous pour voir les vidÃ©os</div>
                        <div style="font-size:0.7rem;margin-top:6px;">VidÃ©os IA gÃ©nÃ©rÃ©es + NostrTube</div>
                    </div>
                </div>
            </div>
        </div>
        <button type="button" class="tube-input-toggle collapsed" id="tubeInputToggle" title="Show message input">ðŸ’¬</button>
        </div>

        <button class="nav-arrow right" id="btnNext" disabled>â–¶</button>
    </div>

    <!-- THEATER MODAL FOR TUBE -->
    <div class="theater-backdrop" id="theaterBackdrop">
        <button class="theater-close" onclick="closeTheater()">Ã—</button>
        <div class="theater-video">
            <video id="theaterVideo" controls autoplay></video>
                    </div>
        <div class="theater-info">
            <!-- Author Profile Banner -->
            <div class="theater-author-banner" id="theaterAuthorBanner">
                <img class="author-avatar" id="theaterAuthorAvatar" src="https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1">
                <div class="author-details">
                    <div class="author-name" id="theaterAuthorName">Author</div>
                    <div class="author-nip05" id="theaterAuthorNip05"></div>
                </div>
            </div>
            <h4 id="theaterTitle">Video Title</h4>
            <div class="meta" id="theaterMeta"></div>
            
            <!-- Actions bar -->
            <div class="theater-actions">
                <button class="theater-action-btn follow-btn" id="btnFollow" onclick="followAuthor()" style="display:none;">
                    <span class="icon">âž•</span>
                    <span>Suivre</span>
                </button>
                <button class="theater-action-btn" id="btnLike" onclick="toggleLike()">
                    <span class="icon">ðŸ‘</span>
                    <span class="count" id="likeCount">0</span>
                </button>
                <button class="theater-action-btn" id="btnDislike" onclick="toggleDislike()">
                    <span class="icon">ðŸ‘Ž</span>
                    <span class="count" id="dislikeCount">0</span>
                </button>
                <button class="theater-action-btn" id="btnBookmark" onclick="toggleBookmark()">
                    <span class="icon">ðŸ”–</span>
                    <span>Sauvegarder</span>
                </button>
                <button class="theater-action-btn" id="btnShare" onclick="shareVideo()">
                    <span class="icon">ðŸ“¤</span>
                    <span>Partager</span>
                </button>
                <button class="theater-action-btn" id="btnShowComments" onclick="toggleComments()">
                    <span class="icon">ðŸ’¬</span>
                    <span class="count" id="commentCount">0</span>
                </button>
                </div>
            
            <!-- Comments section -->
            <div class="theater-comments" id="theaterComments" style="display:none;">
                <div id="commentsList"></div>
                <div class="theater-comment-form">
                    <input type="text" id="commentInput" placeholder="Ajouter un commentaire...">
                    <button onclick="postVideoCommentAction()">Envoyer</button>
                    </div>
                </div>
            </div>
    </div>

    <!-- UMAP CHAT MODAL -->
    <div class="chat-modal-backdrop" id="chatModalBackdrop">
        <div class="chat-modal">
            <div class="chat-modal-header">
                <span class="chat-modal-title">ðŸ—ºï¸ UMAP Chat</span>
                <span class="chat-modal-room" id="chatModalRoom"></span>
                <button class="chat-modal-close" onclick="closeChatModal()">Ã—</button>
            </div>
            <iframe id="chatModalFrame" src="" frameborder="0"></iframe>
        </div>
    </div>

    <!-- PROFILE VIEWER MODAL -->
    <div class="profile-viewer-backdrop" id="profileViewerBackdrop">
        <div class="profile-viewer-modal">
            <div class="modal-header">
                <span class="modal-title">ðŸ‘¤ Nostr Profile</span>
                <button type="button" class="modal-close" onclick="closeProfileViewerModal()">Ã—</button>
            </div>
            <iframe id="profileViewerFrame" src="" frameborder="0" title="Nostr Profile Viewer"></iframe>
        </div>
    </div>

    <!-- MESSAGE VIEWER MODAL (markdown / blog via earth/nostr_message_viewer.html) -->
    <div class="message-viewer-backdrop" id="messageViewerBackdrop">
        <div class="message-viewer-modal">
            <div class="modal-header">
                <span class="modal-title">ðŸ“„ Message</span>
                <button type="button" class="modal-close" onclick="closeMessageViewerModal()">Ã—</button>
            </div>
            <iframe id="messageViewerFrame" src="" frameborder="0" title="Nostr Message Viewer"></iframe>
        </div>
    </div>

    <!-- URL MODAL (open links in iframe instead of new tab) -->
    <div class="url-modal-backdrop" id="urlModalBackdrop">
        <div class="url-modal">
            <div class="modal-header">
                <span class="modal-title" id="urlModalTitle">ðŸ”— Link</span>
                <button type="button" class="modal-close" onclick="closeUrlModal()">Ã—</button>
            </div>
            <iframe id="urlModalFrame" src="" frameborder="0" title="External link"></iframe>
        </div>
    </div>

    <!-- INPUT SECTION -->
    <div class="input-section" id="inputSection">
        <button type="button" class="input-collapse-btn" id="inputCollapseBtn" title="Collapse message input (replier)">â–¼</button>
        <button type="button" class="input-fullscreen-close d-none" id="inputFullscreenClose" title="Exit fullscreen">âœ•</button>
        <div class="input-options">
            <button class="opt-btn active" id="btnConversation" title="BRO rÃ©pond en votre nom (Ã©phÃ©mÃ¨re 10s)">ðŸ’¬ </button>
            <button class="opt-btn" id="btnPublic" title="Message permanent">ðŸ“¢ </button>
            <span class="input-tag-icons" id="inputTagIcons">
                <button type="button" class="opt-btn input-tag-btn active" data-tag="chat" title="Chat (no tag)">Tous</button>
                <button type="button" class="opt-btn input-tag-btn" data-tag="image" title="Add #image">ðŸ–¼ï¸</button>
                <button type="button" class="opt-btn input-tag-btn" data-tag="video" title="Add #video">ðŸŽ¬</button>
                <button type="button" class="opt-btn input-tag-btn" data-tag="music" title="Add #music">ðŸŽµ</button>
                <button type="button" class="opt-btn input-tag-btn" data-tag="search" title="Add #search">ðŸ”</button>
                <button type="button" class="opt-btn input-tag-btn" data-tag="nature" title="Add #plantnet">ðŸŒ¿</button>
            </span>
            <label class="opt-btn" for="imgInput">ðŸ“·</label>
            <input type="file" id="imgInput" accept="image/*" style="display:none;">
            <button class="opt-btn" id="btnLocation">ðŸ“</button>
            <button class="opt-btn" id="btnSettings">âš™ï¸</button>
            <div class="sub-options" id="videoOpts">
                <div class="societaire-warning" id="videoT2vWarning" style="display:none;">
                    âš ï¸ T2V accÃ¨s - <a href="javascript:void(0)" onclick="showSocietaireInfo()">En savoir plus</a>
                        </div>
                <div class="societaire-warning constellation-warning" id="videoI2vWarning" style="display:none;">
                    ðŸŒŸ I2V Niveau Constellation - <a href="javascript:void(0)" onclick="showConstellationInfo()">Upgrade</a>
                        </div>
                <button class="sub-opt active" data-mode="t2v" title="Text-to-Video (Satellite+)">â­ T2V</button>
                <button class="sub-opt" data-mode="i2v" title="Image-to-Video (Constellation)">ðŸŒŸ I2V</button>
                <div class="i2v-btns" id="i2vBtns">
                    <label class="i2v-btn" for="i2vImgInput" title="SÃ©lectionner une image">ðŸ“ Fichier</label>
                    <input type="file" id="i2vImgInput" accept="image/*" style="display:none;">
                    <button class="i2v-btn" id="btnI2vCamera" title="Capturer une photo">ðŸ“¸ Photo</button>
                    <span class="i2v-required" id="i2vStatus">âš ï¸ Image requise</span>
                    </div>
                    </div>
                </div>

        <div class="img-preview-wrap" id="imgPreviewWrap">
            <img id="imgPreview" src="#">
            <button class="remove" onclick="clearImage()">Ã—</button>
            </div>

        <div class="reply-to-hint" id="replyToHint">
            <span class="reply-to-text">Replying to <strong id="replyToName"></strong></span>
            <button type="button" class="cancel-reply" id="cancelReplyBtn">Cancel</button>
        </div>

        <div class="input-row" id="inputRowBroZone">
            <textarea id="messageInput" placeholder="Tapez votre message..." rows="2"></textarea>
            <div class="input-row-btns d-flex gap-1 align-items-end flex-shrink-0">
                <button type="button" class="btn-input-fullscreen" id="btnInputFullscreen" title="Fullscreen input">â›¶</button>
                <button class="btn-send" id="btnSend" disabled>ENVOYER</button>
            </div>
        </div>

        <!-- BRO radial menu (long-press on input) - tags from UPlanet_IA_Responder.sh -->
        <div class="bro-radial-overlay" id="broRadialOverlay">
            <div class="bro-radial-circle">
                <div class="bro-radial-center" title="BRO commands">BRO</div>
                <div class="bro-radial-ring bro-radial-ring-inner">
                    <button type="button" class="bro-radial-item" data-tag="#url" title="Include link content">#url</button>
                    <button type="button" class="bro-radial-item" data-tag="#status" title="Services status">#status</button>
                    <button type="button" class="bro-radial-item" data-tag="#whoami" title="Your pubkey &amp; KNAME">#whoami</button>
                    <button type="button" class="bro-radial-item" data-tag="#help" title="BRO tags summary">#help</button>
                    <button type="button" class="bro-radial-item" data-tag="#search" title="Perplexica search">#search</button>
                    <button type="button" class="bro-radial-item" data-tag="#image" title="Generate image (ComfyUI)">#image</button>
                    <button type="button" class="bro-radial-item" data-tag="#video" title="Generate video (ComfyUI)">#video</button>
                    <button type="button" class="bro-radial-item" data-tag="#music" title="Generate music (ComfyUI)">#music</button>
                    <button type="button" class="bro-radial-item" data-tag="#youtube" title="Download video / #mp3 for audio">#youtube</button>
                </div>
                <div class="bro-radial-ring bro-radial-ring-outer">
                    <button type="button" class="bro-radial-item" data-tag="#mem" title="Conversation memory">#mem</button>
                    <button type="button" class="bro-radial-item" data-tag="#rec" title="Save to memory">#rec</button>
                    <button type="button" class="bro-radial-item" data-tag="#rec2" title="Auto-save bot response">#rec2</button>
                    <button type="button" class="bro-radial-item" data-tag="#reset" title="Clear memory">#reset</button>
                    <button type="button" class="bro-radial-item" data-tag="#pierre" title="TTS voice Pierre">#pierre</button>
                    <button type="button" class="bro-radial-item" data-tag="#amelie" title="TTS voice AmÃ©lie">#amelie</button>
                    <button type="button" class="bro-radial-item" data-tag="#plantnet" title="Plant recognition (image)">#plantnet</button>
                    <button type="button" class="bro-radial-item" data-tag="#cookie" title="Cookie workflow">#cookie</button>
                    <button type="button" class="bro-radial-item" data-tag="#inventory" title="Inventory (image)">#inventory</button>
                </div>
            </div>
        </div>

        <div class="hint" id="serviceHint">ðŸ’¬ Posez une question ou discutez avec votre IA</div>
        <details class="bro-commands-help" id="broCommandsHelp">
            <summary>BRO commands (long-press input for radial menu)</summary>
            <ul>
                <li><strong>Meta:</strong> <code>#url</code> link content | <code>#status</code> services | <code>#whoami</code> identity | <code>#help</code></li>
                <li><strong>Search &amp; media:</strong> <code>#search</code> | <code>#image</code> | <code>#video</code> | <code>#music</code> | <code>#youtube</code> [#mp3]</li>
                <li><strong>Memory:</strong> <code>#mem</code> [#1..#12] | <code>#rec</code> | <code>#rec2</code> | <code>#reset</code></li>
                <li><strong>Voice (TTS):</strong> <code>#pierre</code> | <code>#amelie</code></li>
                <li><strong>Tools:</strong> <code>#plantnet</code> [image] | <code>#cookie</code> &lt;workflow&gt; | <code>#inventory</code> [image]</li>
            </ul>
        </details>

        <div class="loading" id="loadingBar">
            <div class="spinner"></div>
            <span id="loadingText">Envoi...</span>
            </div>
            </div>

    <!-- SETTINGS -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-row">
            <label>ðŸ“ Localisation</label>
            <div class="toggle-switch on" id="toggleLocation"></div>
            <label>Lat:</label>
            <input type="number" id="latInput" step="0.01" value="0">
            <label>Lon:</label>
            <input type="number" id="lonInput" step="0.01" value="0">
            <button class="opt-btn" id="btnGeolocate">Ma position</button>
        </div>
        <div id="mapContainer" style="display:none;"><div id="mini-map"></div></div>
        <div class="settings-row" style="justify-content:center;padding-top:8px;border-top:1px solid var(--border);margin-top:8px;">
            <a href="/earth/crowdfunding.html" style="color:var(--text-dim);font-size:0.7rem;text-decoration:none;opacity:0.7;" title="Crowdfunding des Communs">ðŸŒ³ Crowdfunding des Communs</a>
            </div>
        </div>

    <!-- LIGHTBOX -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close" onclick="closeLightbox()">Ã—</button>
        <img id="lightboxImg" src="#">
            </div>

    <!-- DEBUG -->
    <details style="position:fixed;bottom:0;left:0;right:0;background:var(--bg-panel);border-top:1px solid var(--border);max-height:120px;overflow-y:auto;font-size:0.6rem;z-index:100;">
        <summary style="padding:3px 8px;cursor:pointer;color:var(--text-dim);">ðŸ”§ Debug</summary>
        <div id="debugLog" style="padding:4px;font-family:monospace;white-space:pre-wrap;color:var(--accent-cyan);"></div>
        </details>

    <script>
        // === CONFIG ===
        // Use DEFAULT_RELAYS from common.js (auto-detected from hostname)
        // common.js provides: DEFAULT_RELAYS, nostrRelay, connectToRelay(), connectNostr(), publishNote(), etc.
        const MESSAGES_PER_PAGE = 50;
        
        // Wait for common.js to initialize and get relays
        function getAllRelays() {
            // Use common.js DEFAULT_RELAYS if available, otherwise fallback
            if (typeof window.DEFAULT_RELAYS !== 'undefined' && window.DEFAULT_RELAYS.length > 0) {
                return window.DEFAULT_RELAYS;
            }
            return ['wss://relay.copylaradio.com', 'ws://127.0.0.1:7777'];
        }

        // === STATE ===
        let publicKey = '';
        let pool = null;
        let allRelays = [];  // Will be set from common.js DEFAULT_RELAYS
        let userProfile = null;
        let allMessages = [];  // All fetched messages
        let filteredMessages = [];  // Messages filtered by service
        let msgIndex = 0;
        let currentTheaterVideo = null;  // Current video in theater mode
        let theaterLiked = false;
        let theaterDisliked = false;
        let theaterBookmarked = false;
        let currentService = 'all';
        let fluxTagFilter = 'all'; // all | chat | image | video | music | search | nature (Flux view only)
        let currentInputService = 'chat';
        let lastRenderedService = null;  // used to preserve scroll when re-rendering same view
        let pendingReplyTo = null;  // { eventId, authorPubkey, authorName } when replying to N/NÂ² message
        let videoMode = 't2v';
        let isConversation = true;
        let locationEnabled = true;
        let currentLat = null;
        let currentLon = null;
        let selectedImage = null;
        let miniMap = null;

        // === LOGGING ===
        let debugLog = '';
        function log(msg) {
            const ts = new Date().toLocaleTimeString();
            const line = `[${ts}] ${msg}`;
            console.log(line);
            debugLog += line + '\n';
            const lines = debugLog.split('\n');
            if (lines.length > 50) debugLog = lines.slice(-50).join('\n');
            $('#debugLog').text(debugLog).scrollTop($('#debugLog')[0]?.scrollHeight || 0);
        }

        // === INIT ===
        $(document).ready(function() {
            log('Document ready');
            let attempts = 0;
            const checkLib = setInterval(() => {
                attempts++;
                // Wait for both NostrTools and common.js to be ready
                const nostrReady = typeof NostrTools !== 'undefined' && NostrTools.SimplePool;
                const commonReady = typeof window.DEFAULT_RELAYS !== 'undefined';
                
                if (nostrReady && commonReady) {
                    clearInterval(checkLib);
                    allRelays = getAllRelays();
                    log(`Libraries OK â†’ Relay: ${allRelays[0]}`);
                    init();
                } else if (nostrReady && attempts > 20) {
                    // common.js might not be loaded, use fallback
                    clearInterval(checkLib);
                    allRelays = getAllRelays();
                    log(`NostrTools OK (common.js timeout) â†’ Relay: ${allRelays[0]}`);
                    init();
                } else if (attempts > 50) {
                    clearInterval(checkLib);
                    log('ERROR: NostrTools failed');
                    $('#btnConnect').text('Erreur').prop('disabled', true);
                }
            }, 100);
        });

        function init() {
            checkExtension();
            getLocation();
            setupEvents();
            if (currentService === 'all') $('#fluxTagCloud').show();
        }

        function setupEvents() {
            $('#btnConnect').on('click', connectWallet);

            // Main tabs click handler
            $('.svc-tab').on('click', function(e) {
                const svc = $(this).data('svc');
                currentService = svc === 'flux' ? 'all' : svc;
                $('.svc-tab').removeClass('active');
                $(this).addClass('active');

                if (svc === 'tube') {
                    $('#fluxTagCloud').hide();
                    $('#nFeedFilterWrap').show();
                    $('#nFeedFilterSelect').val(nFeedFilter);
                    $('.main-content').addClass('tube-mode').show();
                    $('#tubePanel').addClass('active');
                    $('.input-section').hide().removeClass('tube-input-visible');
                    $('body').addClass('tube-mode');
                    $('#tubeInputToggle').removeClass('collapsed');
                    loadTubeVideos();
                } else if (svc === 'n' || svc === 'n2') {
                    $('#fluxTagCloud').hide();
                    $('#nFeedFilterWrap').show();
                    $('#nFeedFilterSelect').val(nFeedFilter);
                    $('#tubePanel').removeClass('active');
                    $('.main-content').removeClass('tube-mode').show().addClass('flux-mode');
                    $('body').removeClass('tube-mode');
                    $('#inputSection').removeClass('tube-input-visible');
                    $('#tubeInputToggle').addClass('collapsed');
                    $('.input-section').show();
                    fetchNFeed(svc);
                    updateInputHint('chat');
                } else if (svc === 'blog') {
                    $('#fluxTagFilterWrap').hide();
                    $('#nFeedFilterWrap').show();
                    $('#nFeedFilterSelect').val(nFeedFilter);
                    $('#tubePanel').removeClass('active');
                    $('.main-content').removeClass('tube-mode').show().addClass('flux-mode');
                    $('body').removeClass('tube-mode');
                    $('#inputSection').removeClass('tube-input-visible');
                    $('#tubeInputToggle').addClass('collapsed');
                    $('.input-section').show();
                    fetchBlogFeed();
                    updateInputHint('chat');
                } else {
                    // Flux: tag cloud below list (no filter bar in service bar)
                    $('#nFeedFilterWrap').hide();
                    $('#fluxTagCloud').show();
                    $('#tubePanel').removeClass('active');
                    $('.main-content').removeClass('tube-mode').show().addClass('flux-mode');
                    $('body').removeClass('tube-mode');
                    $('#inputSection').removeClass('tube-input-visible');
                    $('#tubeInputToggle').addClass('collapsed');
                    $('.input-section').show();
                    filterAndDisplayMessages();
                    updateFluxTagCloud();
                    updateInputHint(currentInputService === 'chat' ? 'chat' : currentInputService);
                    if (currentInputService === 'video') {
                        $('#videoOpts').addClass('visible');
                        updateVideoAccessWarnings();
                    } else {
                        $('#videoOpts').removeClass('visible');
                    }
                }
            });

            // N/NÂ² and Tube filter (p21 vs p2p): on change, refresh current feed
            $('#nFeedFilterSelect').on('change', function() {
                nFeedFilter = $(this).val();
                if (currentService === 'n' || currentService === 'n2') {
                    fetchNFeed(currentService);
                } else if (currentService === 'tube') {
                    loadTubeVideos();
                } else if (currentService === 'blog') {
                    fetchBlogFeed();
                }
            });

            // Input section tag icons: set tag to add to next message (currentInputService)
            $(document).on('click', '.input-tag-btn', function(e) {
                e.preventDefault();
                const tag = $(this).data('tag');
                currentInputService = tag;
                $('.input-tag-btn').removeClass('active');
                $(this).addClass('active');
                updateInputHint(tag === 'chat' ? 'chat' : tag);
                if (tag === 'video') {
                    $('#videoOpts').addClass('visible');
                    updateVideoAccessWarnings();
                } else {
                    $('#videoOpts').removeClass('visible');
                }
            });

            // Add video button - opens webcam page
            $('#btnAddVideo').on('click', openWebcamUpload);

            // Mode toggle
            $('#btnConversation').on('click', () => setMode(true));
            $('#btnPublic').on('click', () => setMode(false));

            // Video sub-options (T2V / I2V)
            $('.sub-opt').on('click', function() {
                videoMode = $(this).data('mode');
                $('.sub-opt').removeClass('active');
                $(this).addClass('active');
                
                // Show/hide I2V image buttons
                if (videoMode === 'i2v') {
                    $('#i2vBtns').addClass('visible');
                    updateI2vStatus();
                } else {
                    $('#i2vBtns').removeClass('visible');
                }
                
                // Update hint to reflect mode
                updateInputHint('video');
                
                // Update access warnings based on tier and mode
                updateVideoAccessWarnings();
            });
            
            // I2V image file input
            $('#i2vImgInput').on('change', handleI2vImageSelect);
            
            // I2V camera capture button
            $('#btnI2vCamera').on('click', openI2vCamera);

            // Image
            $('#imgInput').on('change', handleImageSelect);

            // Location
            $('#btnLocation').on('click', function() {
                locationEnabled = !locationEnabled;
                $(this).toggleClass('active', locationEnabled);
                $('#toggleLocation').toggleClass('on', locationEnabled);
            });

            $('#toggleLocation').on('click', function() {
                locationEnabled = !locationEnabled;
                $(this).toggleClass('on', locationEnabled);
                $('#btnLocation').toggleClass('active', locationEnabled);
            });

            // Settings
            $('#btnSettings').on('click', function() {
                $('#settingsPanel').toggleClass('open');
                $(this).toggleClass('active');
                if ($('#settingsPanel').hasClass('open') && !miniMap) initMiniMap();
            });

            $('#btnGeolocate').on('click', getLocation);

            // Navigation arrows
            $('#btnPrev').on('click', () => navigate(-1));
            $('#btnNext').on('click', () => navigate(1));

            // Send
            $('#btnSend').on('click', sendMessage);
            $('#messageInput').on('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            }).on('input', function() {
                const maxH = $('#inputSection').hasClass('input-section-fullscreen') ? 9999 : 150;
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, maxH) + 'px';
            });

            // Fullscreen input zone
            $('#btnInputFullscreen').on('click', function() {
                $('#inputSection').addClass('input-section-fullscreen');
                $('#inputFullscreenClose').removeClass('d-none');
                $('#messageInput').focus();
            });
            $('#inputFullscreenClose').on('click', function() {
                $('#inputSection').removeClass('input-section-fullscreen');
                $('#inputFullscreenClose').addClass('d-none');
            });
            $('#cancelReplyBtn').on('click', clearReplyTo);
            $(document).on('keydown', function(e) {
                if (e.key === 'Escape' && $('#inputSection').hasClass('input-section-fullscreen')) {
                    $('#inputSection').removeClass('input-section-fullscreen');
                    $('#inputFullscreenClose').addClass('d-none');
                }
            });

            // BRO radial menu: long-press on input to show, select tag to insert
            (function() {
                const BRO_LONG_PRESS_MS = 500;
                let broLongPressTimer = null;

                function showBroRadial() {
                    if (!isConversation) return;
                    $('#broRadialOverlay').addClass('visible');
                }
                function hideBroRadial() {
                    $('#broRadialOverlay').removeClass('visible');
                }
                function insertBroTag(tag) {
                    const el = document.getElementById('messageInput');
                    const start = el.selectionStart, end = el.selectionEnd;
                    const text = el.value;
                    const insert = (text && start > 0 && !/^\s/.test(text.slice(start - 1)) && !/^\s/.test(tag)) ? ' ' + tag : tag;
                    el.value = text.slice(0, start) + insert + text.slice(end);
                    el.selectionStart = el.selectionEnd = start + insert.length;
                    el.focus();
                }

                function clearBroTimer() {
                    if (broLongPressTimer) {
                        clearTimeout(broLongPressTimer);
                        broLongPressTimer = null;
                    }
                }

                $('#messageInput').on('mousedown touchstart', function(e) {
                    if (!isConversation) return;
                    clearBroTimer();
                    broLongPressTimer = setTimeout(function() {
                        broLongPressTimer = null;
                        e.preventDefault();
                        showBroRadial();
                    }, BRO_LONG_PRESS_MS);
                });
                $('#messageInput').on('mouseup mouseleave touchend touchcancel', function() {
                    clearBroTimer();
                });

                $('#inputRowBroZone').on('mousedown touchstart', function(e) {
                    if (!isConversation || $(e.target).closest('#messageInput').length || $(e.target).closest('.btn-send').length) return;
                    clearBroTimer();
                    broLongPressTimer = setTimeout(function() {
                        broLongPressTimer = null;
                        e.preventDefault();
                        showBroRadial();
                    }, BRO_LONG_PRESS_MS);
                });
                $('#inputRowBroZone').on('mouseup mouseleave touchend touchcancel', function() {
                    clearBroTimer();
                });

                $('#broRadialOverlay').on('click', function(e) {
                    if (e.target.id === 'broRadialOverlay') hideBroRadial();
                });
                $('.bro-radial-item').on('click', function(e) {
                    e.stopPropagation();
                    const tag = $(this).data('tag');
                    if (tag) insertBroTag(tag);
                    hideBroRadial();
                });
                $(document).on('keydown', function(e) {
                    if (e.key === 'Escape' && $('#broRadialOverlay').hasClass('visible')) {
                        hideBroRadial();
                    }
                });
            })();

            // Lightbox
            $('#lightbox').on('click', e => { if (e.target.id === 'lightbox') closeLightbox(); });
            $(document).on('keydown', e => { if (e.key === 'Escape') { closeLightbox(); closeTheater(); closeChatModal(); closeProfileViewerModal(); closeMessageViewerModal(); closeUrlModal(); }});
            
            // Chat modal close on backdrop click
            $('#chatModalBackdrop').on('click', function(e) {
                if (e.target.id === 'chatModalBackdrop') closeChatModal();
            });
            $('#urlModalBackdrop').on('click', function(e) {
                if (e.target.id === 'urlModalBackdrop') closeUrlModal();
            });
            // Open links in modal instead of new tab (chat area and webpage preview)
            $(document).on('click', '#chatArea a[href^="http"]', function(e) {
                e.preventDefault();
                openUrlModal($(this).attr('href'));
            });
            $(document).on('click', '.webpage-overlay', function(e) {
                e.preventDefault();
                const url = $(this).data('url');
                if (url) openUrlModal(url);
            });
            $('#profileViewerBackdrop').on('click', function(e) {
                if (e.target.id === 'profileViewerBackdrop') closeProfileViewerModal();
            });

            // Tube events
            setupTubeEvents();
        }

        // === TUBE MODE ===
        let tubeVideos = [];
        let filteredTubeVideos = [];
        let friendsList = [];
        let tubeEffectiveFriends = []; // friendsList or p2p-filtered (reciprocal) for Tube sidebar
        let selectedFriend = 'all';
        let tubeFilter = 'all';
        let profileCache = {};
        let nFeedFilter = 'p21'; // p21 = unidirectional, p2p = reciprocal follows

        function setupTubeEvents() {
            // Tube filter buttons
            $('.tube-filter-btn').on('click', function() {
                tubeFilter = $(this).data('filter');
                $('.tube-filter-btn').removeClass('active');
                $(this).addClass('active');
                filterTubeVideos();
            });

            // Friends toggle (mobile)
            $('#toggleFriends').on('click', function() {
                $('#friendsSidebar').toggleClass('collapsed');
            });

            // Friend selection
            $(document).on('click', '.friend-item', function() {
                selectedFriend = $(this).data('pubkey');
                $('.friend-item').removeClass('selected');
                $(this).addClass('selected');
                filterTubeVideos();
            });

            // Theater close
            $('#theaterBackdrop').on('click', function(e) {
                if (e.target.id === 'theaterBackdrop') closeTheater();
            });

            // Tube mode: show message input (floating button)
            $('#tubeInputToggle').on('click', function() {
                $('.input-section').show();
                $('#inputSection').addClass('tube-input-visible');
                $('#tubeInputToggle').addClass('collapsed');
            });

            // Tube mode: collapse message input (replier)
            $('#inputCollapseBtn').on('click', function() {
                $('#inputSection').removeClass('tube-input-visible');
                $('.input-section').hide();
                $('#tubeInputToggle').removeClass('collapsed');
            });
        }

        async function loadTubeVideos() {
            if (!publicKey) {
                $('#videoGrid').html(`
                    <div class="tube-empty">
                        <div class="icon">ðŸ”’</div>
                        <div>Connectez-vous pour voir les vidÃ©os</div>
                    </div>
                `);
                return;
            }

            log('Loading Tube videos...');
            $('#videoGrid').html('<div class="tube-loading"><div class="spinner"></div>Chargement des vidÃ©os...</div>');

            tubeVideos = [];
            const p = getPool();

            try {
                // 1. Load AI-generated videos from user's messages (#video tag)
                const userVideoMessages = await p.list(allRelays, [{
                    kinds: [1],
                    authors: [publicKey],
                    '#t': ['video'],
                    limit: 50
                }]);

                // Also get replies to user messages (AI responses with videos)
                const userMessages = await p.list(allRelays, [{
                    kinds: [1],
                    authors: [publicKey],
                    limit: 100
                }]);

                const userMsgIds = userMessages.map(m => m.id);
                let aiReplies = [];
                if (userMsgIds.length > 0) {
                    aiReplies = await p.list(allRelays, [{
                        kinds: [1],
                        '#e': userMsgIds,
                        limit: 200
                    }]);
                }

                // Filter AI replies that contain video URLs
                const aiVideoReplies = aiReplies.filter(r => {
                    const urls = extractMediaUrls(r.content);
                    return urls.some(u => detectMediaType(u) === 'video');
                });

                // Convert to video format
                [...userVideoMessages, ...aiVideoReplies].forEach(event => {
                    const video = convertMessageToVideo(event, true);
                    if (video) tubeVideos.push(video);
                });

                // 2. Load NostrTube videos (kinds 21, 22)
                const nostrtubeVideos = await p.list(allRelays, [{
                    kinds: [21, 22],
                    limit: 100
                }]);

                nostrtubeVideos.forEach(event => {
                    const video = extractNostrTubeVideo(event);
                    if (video) tubeVideos.push(video);
                });

                // 3. Load friends list
                await loadFriendsList();

                // Apply p2p/p21 filter for Tube: effective list = friends (p21) or reciprocal only (p2p)
                if (nFeedFilter === 'p2p' && friendsList.length > 0 && allRelays && allRelays.length > 0) {
                    try {
                        const contactEvents = await p.list(allRelays.slice(0, 3), [{
                            kinds: [3],
                            authors: friendsList,
                            limit: friendsList.length * 2
                        }]);
                        const reciprocalSet = new Set();
                        contactEvents.forEach(ev => {
                            const hasMe = ev.tags && ev.tags.some(t => t[0] === 'p' && t[1] === publicKey);
                            if (hasMe) reciprocalSet.add(ev.pubkey);
                        });
                        tubeEffectiveFriends = friendsList.filter(a => reciprocalSet.has(a));
                    } catch (e) {
                        tubeEffectiveFriends = [...friendsList];
                    }
                } else {
                    tubeEffectiveFriends = [...(friendsList || [])];
                }

                // Sort by date
                tubeVideos.sort((a, b) => b.created_at - a.created_at);

                log(`Loaded ${tubeVideos.length} videos (${userVideoMessages.length + aiVideoReplies.length} AI, ${nostrtubeVideos.length} NostrTube)`);
                
                // Preload profiles for all video authors
                await preloadVideoAuthorProfiles();
                
                filterTubeVideos();

                    } catch (e) {
                log(`Tube error: ${e.message}`);
                $('#videoGrid').html(`
                    <div class="tube-empty">
                        <div class="icon">âŒ</div>
                        <div>Erreur de chargement</div>
                        <div style="font-size:0.7rem">${e.message}</div>
                    </div>
                `);
            }
        }

        function convertMessageToVideo(event, isAI) {
            const urls = extractMediaUrls(event.content);
            let videoUrl = urls.find(u => detectMediaType(u) === 'video');
            if (!videoUrl) return null;

            // Normalize IPFS URLs (u. -> ipfs.)
            videoUrl = normalizeIpfsUrl(videoUrl);
            let thumbnailUrl = normalizeIpfsUrl(urls.find(u => detectMediaType(u) === 'image') || '');

            // Extract title from content
            let title = cleanContent(event.content, urls);
            if (title.length > 80) title = title.substring(0, 80) + '...';
            if (!title) title = isAI ? 'VidÃ©o IA gÃ©nÃ©rÃ©e' : 'VidÃ©o';

            // Check if UPlanet (AI videos from BRO are always UPlanet)
            const isUPlanet = isAI || event.tags.some(t => 
                (t[0] === 'application' && t[1] === 'UPlanet')
            );

            return {
                id: event.id,
                title: title,
                videoUrl: videoUrl,
                thumbnailUrl: thumbnailUrl,
                gifanimUrl: '', // AI videos don't have animated thumbnails
                authorId: event.pubkey,
                created_at: event.created_at,
                isAI: isAI,
                type: 'ai',
                duration: 0,
                kind: 1, // Kind 1 for AI video messages
                isUPlanet: isUPlanet,
                isShort: true, // AI videos are typically short
                sourceType: 'webcam' // AI videos default to webcam source
            };
        }

        function extractNostrTubeVideo(event) {
            // Extract from NIP-71 format (including IPFS extension)
            const titleTag = event.tags.find(t => t[0] === 'title');
            const urlTag = event.tags.find(t => t[0] === 'url' || t[0] === 'r');
            const imageTag = event.tags.find(t => t[0] === 'image' || t[0] === 'thumb');
            const gifanimTag = event.tags.find(t => t[0] === 'gifanim' || t[0] === 'gif');
            const durationTag = event.tags.find(t => t[0] === 'duration');
            const imetaTag = event.tags.find(t => t[0] === 'imeta');
            
            // NIP-71 IPFS Extension: CID-only tags
            const thumbnailIpfsTag = event.tags.find(t => t[0] === 'thumbnail_ipfs');
            const gifanimIpfsTag = event.tags.find(t => t[0] === 'gifanim_ipfs');

            let videoUrl = urlTag ? urlTag[1] : '';
            let thumbnailUrl = imageTag ? imageTag[1] : '';
            let gifanimUrl = gifanimTag ? gifanimTag[1] : '';
            let duration = durationTag ? parseInt(durationTag[1]) : 0;

            // Parse imeta tag if available
            if (imetaTag) {
                imetaTag.forEach((item, idx) => {
                    if (idx === 0) return;
                    if (typeof item === 'string') {
                        if (item.startsWith('url ')) videoUrl = videoUrl || item.substring(4).trim();
                        if (item.startsWith('image ')) thumbnailUrl = thumbnailUrl || item.substring(6).trim();
                        if (item.startsWith('gifanim ') || item.startsWith('gif ')) gifanimUrl = gifanimUrl || item.substring(item.indexOf(' ') + 1).trim();
                        if (item.startsWith('duration ')) duration = duration || parseFloat(item.substring(9).trim());
                    }
                });
            }
            
            // Use CID-only tags as fallback (NIP-71 IPFS Extension)
            if (!thumbnailUrl && thumbnailIpfsTag && thumbnailIpfsTag[1]) {
                thumbnailUrl = thumbnailIpfsTag[1]; // Will be normalized below
            }
            if (!gifanimUrl && gifanimIpfsTag && gifanimIpfsTag[1]) {
                gifanimUrl = gifanimIpfsTag[1]; // Will be normalized below
            }

            // Also check for URL in content
            if (!videoUrl) {
                const urls = extractMediaUrls(event.content);
                videoUrl = urls.find(u => detectMediaType(u) === 'video') || '';
            }

            if (!videoUrl) return null;

            // Normalize IPFS URLs: handles u.->ipfs., relative paths, and CID-only
            videoUrl = normalizeIpfsUrl(videoUrl);
            thumbnailUrl = normalizeIpfsUrl(thumbnailUrl);
            gifanimUrl = normalizeIpfsUrl(gifanimUrl);

            // Check if UPlanet video (has application: UPlanet tag)
            const isUPlanet = event.tags.some(t => 
                (t[0] === 'application' && t[1] === 'UPlanet') ||
                (t[0] === 't' && t[1] === 'UPlanet')
            );

            // Extract source type from "i" tag with "source:" prefix (film, serie, youtube, webcam)
            let sourceType = 'webcam'; // Default
            const sourceTag = event.tags.find(t => t[0] === 'i' && t[1]?.startsWith('source:'));
            if (sourceTag) {
                sourceType = sourceTag[1].replace('source:', '');
            } else {
                // Fallback: check for t tags (film, serie)
                if (event.tags.some(t => t[0] === 't' && t[1] === 'film')) sourceType = 'film';
                else if (event.tags.some(t => t[0] === 't' && t[1] === 'serie')) sourceType = 'serie';
                else if (event.tags.some(t => t[0] === 't' && t[1] === 'youtube')) sourceType = 'youtube';
                // Check for YouTube URL tag
                else if (event.tags.some(t => t[0] === 'youtube_url')) sourceType = 'youtube';
            }

            return {
                id: event.id,
                title: titleTag ? titleTag[1] : 'NostrTube Video',
                videoUrl: videoUrl,
                thumbnailUrl: thumbnailUrl,
                gifanimUrl: gifanimUrl,
                authorId: event.pubkey,
                created_at: event.created_at,
                isAI: false,
                type: 'nostr',
                duration: duration,
                kind: event.kind,
                isUPlanet: isUPlanet,
                isShort: event.kind === 22 || duration <= 60,
                sourceType: sourceType
            };
        }

        async function loadFriendsList() {
            if (!publicKey) return;

            const p = getPool();
            try {
                // Get contact list (kind 3)
                const contacts = await p.list(allRelays, [{
                    kinds: [3],
                    authors: [publicKey],
                    limit: 1
                }]);

                if (contacts.length > 0) {
                    friendsList = contacts[0].tags
                        .filter(t => t[0] === 'p')
                        .map(t => t[1]);
                    
                    log(`Loaded ${friendsList.length} friends`);
                    $('#friendsCount').text(friendsList.length);
                    renderFriendsList();
                }
             } catch (e) {
                log(`Friends error: ${e.message}`);
            }
        }

        async function renderFriendsList() {
            const $list = $('#friendsList');
            
            // Count videos per friend first
            const videoCounts = {};
            tubeVideos.forEach(v => {
                videoCounts[v.authorId] = (videoCounts[v.authorId] || 0) + 1;
            });
            
            // My video count
            const myVideoCount = videoCounts[publicKey] || 0;
            
            $list.html(`
                <div class="friend-item all ${selectedFriend === 'all' ? 'selected' : ''}" data-pubkey="all">
                    <span class="name">ðŸŒ Tous</span>
                    <span class="count">${tubeVideos.length}</span>
                </div>
                ${myVideoCount > 0 ? `
                <div class="friend-item ${selectedFriend === publicKey ? 'selected' : ''}" data-pubkey="${publicKey}">
                    <img src="${userProfile?.picture || 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1'}">
                    <span class="name">ðŸ“± Moi</span>
                    <span class="count">${myVideoCount}</span>
                </div>
                ` : ''}
            `);

            // Only show (effective) friends who have published videos (p21 = all follows, p2p = reciprocal)
            const effectiveList = tubeEffectiveFriends.length ? tubeEffectiveFriends : (friendsList || []);
            const friendsWithVideos = effectiveList.filter(pubkey => pubkey !== publicKey && (videoCounts[pubkey] || 0) > 0);
            
            for (const pubkey of friendsWithVideos.slice(0, 30)) { // Limit to 30 (exclude self, already shown as "Moi")
                const profile = await getProfile(pubkey);
                const count = videoCounts[pubkey];
                
                $list.append(`
                    <div class="friend-item ${selectedFriend === pubkey ? 'selected' : ''}" data-pubkey="${pubkey}">
                        <img src="${profile?.picture || 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1'}" 
                             onerror="this.src='https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1'">
                        <span class="name">${profile?.display_name || profile?.name || pubkey.slice(0, 8)}</span>
                        <span class="count">${count}</span>
                    </div>
                `);
            }
            
            // Update friends count to show only those with videos (effective list)
            $('#friendsCount').text(friendsWithVideos.length);
        }

        async function getProfile(pubkey) {
            if (profileCache[pubkey]) return profileCache[pubkey];

            const p = getPool();
            try {
                const relays = (allRelays && allRelays.length) ? allRelays.slice(0, 3) : [];
                if (relays.length === 0) return null;
                const events = await p.list(relays, [{
                    kinds: [0],
                    authors: [pubkey],
                    limit: 1
                }]);
                if (events.length > 0) {
                    const profile = JSON.parse(events[0].content);
                    // Normalize IPFS URLs in profile
                    if (profile.picture) profile.picture = normalizeIpfsUrl(profile.picture);
                    if (profile.banner) profile.banner = normalizeIpfsUrl(profile.banner);
                    profileCache[pubkey] = profile;
                    return profile;
                }
            } catch (e) {}
            return null;
        }

        // Preload profiles for all video authors (batch loading for performance)
        async function preloadVideoAuthorProfiles() {
            const uniqueAuthors = [...new Set(tubeVideos.map(v => v.authorId).filter(Boolean))];
            const missingAuthors = uniqueAuthors.filter(a => !profileCache[a]);
            
            if (missingAuthors.length === 0) {
                log(`All ${uniqueAuthors.length} author profiles already cached`);
                return;
            }
            
            log(`Preloading ${missingAuthors.length}/${uniqueAuthors.length} author profiles...`);
            
            const p = getPool();
            try {
                // Batch fetch all missing profiles at once
                const events = await p.list(allRelays.slice(0, 3), [{
                    kinds: [0],
                    authors: missingAuthors,
                    limit: missingAuthors.length * 2
                }]);
                
                log(`Received ${events.length} profile events`);
                
                events.forEach(event => {
                    try {
                        const profile = JSON.parse(event.content);
                        if (profile.picture) profile.picture = normalizeIpfsUrl(profile.picture);
                        if (profile.banner) profile.banner = normalizeIpfsUrl(profile.banner);
                        profileCache[event.pubkey] = profile;
                    } catch (e) {
                        console.warn('Profile parse error:', e);
                    }
                });
                
                const loadedCount = Object.keys(profileCache).length;
                log(`âœ… Loaded ${events.length} profiles (cache now has ${loadedCount} entries)`);
            } catch (e) {
                log(`âŒ Profile preload error: ${e.message}`);
                console.error('Profile preload error:', e);
            }
        }

        function filterTubeVideos() {
            filteredTubeVideos = tubeVideos.filter(v => {
                // Filter by video type (AI vs Nostr)
                if (tubeFilter === 'ai' && v.type !== 'ai') return false;
                if (tubeFilter === 'nostr' && v.type !== 'nostr') return false;
                
                // Filter by duration (short = kind 22 or â‰¤60s, long = kind 21 or >60s)
                if (tubeFilter === 'short' && !v.isShort) return false;
                if (tubeFilter === 'long' && v.isShort) return false;
                
                // Filter by source type (youtube, serie, film)
                if (tubeFilter === 'youtube' && v.sourceType !== 'youtube') return false;
                if (tubeFilter === 'serie' && v.sourceType !== 'serie') return false;
                if (tubeFilter === 'film' && v.sourceType !== 'film') return false;
                
                // Filter by platform (UPlanet vs standard Nostr)
                if (tubeFilter === 'uplanet' && !v.isUPlanet) return false;
                if (tubeFilter === 'standard' && v.isUPlanet) return false;

                // Filter by friend
                if (selectedFriend !== 'all') {
                    if (v.authorId !== selectedFriend) return false;
                }

                return true;
            });

            renderVideoGrid();
        }

        function renderVideoGrid() {
            const $grid = $('#videoGrid');
            
            if (filteredTubeVideos.length === 0) {
                const emptyHints = {
                    'ai': 'GÃ©nÃ©rez des vidÃ©os avec #BRO #video',
                    'nostr': 'Aucune vidÃ©o NostrTube disponible',
                    'short': 'Aucune vidÃ©o courte (â‰¤60s) trouvÃ©e',
                    'long': 'Aucune vidÃ©o longue (>60s) trouvÃ©e',
                    'youtube': 'Aucune vidÃ©o YouTube archivÃ©e trouvÃ©e',
                    'serie': 'Aucune sÃ©rie trouvÃ©e',
                    'film': 'Aucun film trouvÃ©',
                    'uplanet': 'Aucune vidÃ©o UPlanet trouvÃ©e',
                    'standard': 'Aucune vidÃ©o Nostr standard trouvÃ©e'
                };
                $grid.html(`
                    <div class="tube-empty">
                        <div class="icon">ðŸ“­</div>
                        <div>Aucune vidÃ©o trouvÃ©e</div>
                        <div style="font-size:0.7rem;margin-top:6px;">
                            ${emptyHints[tubeFilter] || ''}
                        </div>
                    </div>
                `);
                 return;
             }

            $grid.html(filteredTubeVideos.map(v => renderVideoCard(v)).join(''));
        }

        function renderVideoCard(video) {
            const thumbnail = video.thumbnailUrl || '';
            const gifanim = video.gifanimUrl || '';
            const profile = profileCache[video.authorId] || {};
            const authorName = profile.display_name || profile.name || video.authorId?.slice(0, 8) || 'Unknown';
            const authorPic = profile.picture || 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1';
            const authorBanner = profile.banner || '';
            const authorNip05 = profile.nip05 || '';
            const authorAbout = profile.about || '';
            const date = formatRelativeDate(video.created_at);
            const duration = video.duration ? formatDuration(video.duration) : '';
            const hasThumb = thumbnail && (thumbnail.startsWith('http') || thumbnail.startsWith('/'));
            const hasGif = gifanim && (gifanim.startsWith('http') || gifanim.startsWith('/'));
            const hasBanner = authorBanner && (authorBanner.startsWith('http') || authorBanner.startsWith('/'));
            const shortPubkey = video.authorId ? (video.authorId.slice(0, 8) + '...' + video.authorId.slice(-4)) : '???';
            
            // Debug log for first few videos
            if (tubeVideos.indexOf(video) < 3) {
                console.log(`[VideoCard] ${video.title?.slice(0,20)}... author=${video.authorId?.slice(0,8)}, profile=`, profile);
            }

            return `
                <div class="video-card" onclick="openVideoTheater('${video.id}')">
                    <div class="video-author-banner ${hasBanner ? 'with-banner' : ''}" 
                         ${hasBanner ? `style="background-image: url('${authorBanner}')"` : ''}>
                        <img class="author-avatar" src="${authorPic}" onerror="this.src='https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1'">
                        <div class="author-details">
                            <div class="author-name">${escapeHtml(authorName)}</div>
                            ${authorNip05 ? `<div class="author-nip05">${escapeHtml(authorNip05)}</div>` : 
                                           `<div class="author-pubkey">${shortPubkey}</div>`}
                        </div>
                    </div>
                    <div class="video-thumbnail">
                        ${hasThumb ? 
                            `<img class="thumb-static" src="${thumbnail}" onerror="this.style.display='none'">`
                            : `<div class="thumb-placeholder">ðŸŽ¬</div>`
                        }
                        ${hasGif ? `<img class="gifanim" src="${gifanim}" onerror="this.style.display='none'">` : ''}
                        <span class="play-icon">â–¶</span>
                        ${video.type === 'ai' ? '<span class="badge-ai">ðŸ¤– IA</span>' : ''}
                        ${video.sourceType === 'youtube' ? '<span class="badge-source youtube">ðŸ“º YT</span>' : ''}
                        ${video.sourceType === 'serie' ? '<span class="badge-source serie">ðŸŽ­ SÃ©rie</span>' : ''}
                        ${video.sourceType === 'film' ? '<span class="badge-source film">ðŸŽ¬ Film</span>' : ''}
                        ${duration ? `<span class="duration">${duration}</span>` : ''}
                    </div>
                    <div class="video-info">
                        <div class="title">${escapeHtml(video.title)}</div>
                        <div class="meta">
                            <span>${date}</span>
                            ${video.type === 'ai' ? '<span>â€¢</span><span>ðŸ¤– GÃ©nÃ©rÃ© par IA</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateVideoPlaceholder(type) {
            return type === 'ai' ? 'ðŸ¤–' : 'ðŸ“º';
        }

        async function openVideoTheater(videoId) {
            const video = tubeVideos.find(v => v.id === videoId);
            if (!video) return;

            currentTheaterVideo = video;
            theaterLiked = false;
            theaterDisliked = false;
            theaterBookmarked = false;

            $('#theaterVideo').attr('src', video.videoUrl);
            $('#theaterTitle').text(video.title);
            
            // Populate author profile banner
            const profile = profileCache[video.authorId] || {};
            const authorName = profile.display_name || profile.name || video.authorId?.slice(0, 8) || 'Unknown';
            const authorPic = profile.picture || 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1';
            const authorBanner = profile.banner || '';
            const authorNip05 = profile.nip05 || '';
            const shortPubkey = video.authorId ? (video.authorId.slice(0, 8) + '...' + video.authorId.slice(-4)) : '';
            
            // Update theater author banner
            const $banner = $('#theaterAuthorBanner');
            if (authorBanner && authorBanner.startsWith('http')) {
                $banner.addClass('with-banner').css('background-image', `url('${authorBanner}')`);
            } else {
                $banner.removeClass('with-banner').css('background-image', '');
            }
            $('#theaterAuthorAvatar').attr('src', authorPic);
            $('#theaterAuthorName').text(authorName);
            
            // Show NIP-05 or pubkey
            const $nip05 = $('#theaterAuthorNip05');
            if (authorNip05) {
                $nip05.removeClass('author-pubkey').addClass('author-nip05').text(authorNip05);
            } else {
                $nip05.removeClass('author-nip05').addClass('author-pubkey').text(shortPubkey);
            }
            
            const date = new Date(video.created_at * 1000).toLocaleString();
            
            $('#theaterMeta').html(`
                <span>${video.type === 'ai' ? 'ðŸ¤– IA Generated' : 'ðŸ“º NostrTube'}</span>
                <span>â€¢</span>
                <span>${date}</span>
            `);

            // Reset UI
            $('#btnLike, #btnDislike, #btnBookmark').removeClass('active');
            $('#likeCount, #dislikeCount, #commentCount').text('0');
            $('#commentsList').html('');
            $('#theaterComments').hide();
            
            // Show follow button if not already following and not own video
            const isOwnVideo = video.authorId === publicKey;
            const isFollowing = friendsList.includes(video.authorId);
            if (!isOwnVideo && !isFollowing) {
                $('#btnFollow').show().removeClass('following').html('<span class="icon">âž•</span><span>Suivre</span>');
            } else if (!isOwnVideo && isFollowing) {
                $('#btnFollow').show().addClass('following').html('<span class="icon">âœ“</span><span>Suivi</span>');
            } else {
                $('#btnFollow').hide();
            }

            $('#theaterBackdrop').addClass('active');
            $('body').css('overflow', 'hidden');

            // Load interactions (async)
            loadVideoInteractions(video);
        }

        function closeTheater() {
            $('#theaterBackdrop').removeClass('active');
            $('#theaterVideo')[0]?.pause();
            $('body').css('overflow', '');
            currentTheaterVideo = null;
        }

        // UMAP Chat Modal
        function openChatModal(room) {
            const chatUrl = `/chat?room=${encodeURIComponent(room)}&embed=1`;
            console.log('[ChatModal] Opening:', chatUrl);
            
            $('#chatModalRoom').text(room);
            $('#chatModalFrame').attr('src', chatUrl);
            $('#chatModalBackdrop').addClass('active');
            $('body').css('overflow', 'hidden');
            
            log(`ðŸ’¬ Chat ouvert: ${room}`);
        }

        function closeChatModal() {
            $('#chatModalBackdrop').removeClass('active');
            $('#chatModalFrame').attr('src', '');
            $('body').css('overflow', '');
        }

        // Load likes, dislikes, comments for current video
        async function loadVideoInteractions(video) {
            if (!video) return;
            const p = getPool();
            
            try {
                // Fetch reactions (kind 7)
                const reactions = await p.list(allRelays, [{
                    kinds: [7],
                    '#e': [video.id],
                    limit: 100
                }]);
                
                let likes = 0, dislikes = 0;
                reactions.forEach(r => {
                    if (r.content === '+' || r.content === 'ðŸ‘' || r.content === 'â¤ï¸') {
                        likes++;
                        if (r.pubkey === publicKey) {
                            theaterLiked = true;
                            $('#btnLike').addClass('active');
                        }
                    } else if (r.content === '-' || r.content === 'ðŸ‘Ž') {
                        dislikes++;
                        if (r.pubkey === publicKey) {
                            theaterDisliked = true;
                            $('#btnDislike').addClass('active');
                        }
                    }
                });
                
                $('#likeCount').text(likes);
                $('#dislikeCount').text(dislikes);
                
                // Fetch comments (kind 1 or 1111 referencing video)
                const comments = await p.list(allRelays, [{
                    kinds: [1, 1111],
                    '#e': [video.id],
                    limit: 50
                }]);
                
                $('#commentCount').text(comments.length);
                
                // Sort by date and render
                comments.sort((a, b) => a.created_at - b.created_at);
                const commentsHtml = await Promise.all(comments.map(async c => {
                    const profile = await getProfile(c.pubkey);
                    const name = profile?.display_name || profile?.name || c.pubkey.slice(0, 8);
                    return `<div class="theater-comment">
                        <span class="author">${escapeHtml(name)}:</span>
                        <span class="text">${escapeHtml(c.content)}</span>
                    </div>`;
                }));
                $('#commentsList').html(commentsHtml.join(''));
                
                // Check bookmark (kind 10002 or kind 30001)
                const bookmarks = await p.list(allRelays, [{
                    kinds: [30001],
                    authors: [publicKey],
                    '#d': ['videos'],
                    limit: 1
                }]);
                
                if (bookmarks.length > 0) {
                    const bookmarkTags = bookmarks[0].tags.filter(t => t[0] === 'e');
                    if (bookmarkTags.some(t => t[1] === video.id)) {
                        theaterBookmarked = true;
                        $('#btnBookmark').addClass('active');
                    }
                }
                
            } catch (e) {
                log(`Error loading interactions: ${e.message}`);
            }
        }

        // Toggle like reaction
        async function toggleLike() {
            if (!publicKey || !currentTheaterVideo) {
                showNotification('Connectez-vous d\'abord pour liker', 'connect');
                return;
            }
            
            try {
                const event = {
                    kind: 7,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ['e', currentTheaterVideo.id],
                        ['p', currentTheaterVideo.authorId]
                    ],
                    content: theaterLiked ? '' : '+'
                };
                
                const signed = await window.nostr.signEvent(event);
                await Promise.all(allRelays.map(r => publishToRelay(r, signed)));
                
                theaterLiked = !theaterLiked;
                $('#btnLike').toggleClass('active', theaterLiked);
                const count = parseInt($('#likeCount').text()) + (theaterLiked ? 1 : -1);
                $('#likeCount').text(Math.max(0, count));
                
                log(theaterLiked ? 'Liked' : 'Unliked');
                    } catch (e) {
                log(`Like error: ${e.message}`);
            }
        }

        // Toggle dislike reaction
        async function toggleDislike() {
            if (!publicKey || !currentTheaterVideo) {
                showNotification('Connectez-vous d\'abord pour rÃ©agir', 'connect');
                return;
            }
            
            try {
                const event = {
                    kind: 7,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ['e', currentTheaterVideo.id],
                        ['p', currentTheaterVideo.authorId]
                    ],
                    content: theaterDisliked ? '' : '-'
                };
                
                const signed = await window.nostr.signEvent(event);
                await Promise.all(allRelays.map(r => publishToRelay(r, signed)));
                
                theaterDisliked = !theaterDisliked;
                $('#btnDislike').toggleClass('active', theaterDisliked);
                const count = parseInt($('#dislikeCount').text()) + (theaterDisliked ? 1 : -1);
                $('#dislikeCount').text(Math.max(0, count));
                
                log(theaterDisliked ? 'Disliked' : 'Un-disliked');
            } catch (e) {
                log(`Dislike error: ${e.message}`);
            }
        }

        // Toggle bookmark
        async function toggleBookmark() {
            if (!publicKey || !currentTheaterVideo) {
                showNotification('Connectez-vous d\'abord pour sauvegarder', 'connect');
                return;
            }
            
            try {
                // Fetch existing bookmarks list
                const p = getPool();
                const existing = await p.list(allRelays, [{
                    kinds: [30001],
                    authors: [publicKey],
                    '#d': ['videos'],
                    limit: 1
                }]);
                
                let tags = [['d', 'videos']];
                if (existing.length > 0) {
                    tags = existing[0].tags.filter(t => t[0] !== 'e' || t[1] !== currentTheaterVideo.id);
                }
                
                if (!theaterBookmarked) {
                    tags.push(['e', currentTheaterVideo.id, '', 'mention']);
                }
                
                const event = {
                    kind: 30001,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags,
                    content: 'My saved videos'
                };
                
                const signed = await window.nostr.signEvent(event);
                await Promise.all(allRelays.map(r => publishToRelay(r, signed)));
                
                theaterBookmarked = !theaterBookmarked;
                $('#btnBookmark').toggleClass('active', theaterBookmarked);
                
                log(theaterBookmarked ? 'Bookmarked' : 'Removed from bookmarks');
            } catch (e) {
                log(`Bookmark error: ${e.message}`);
            }
        }

        // Share video
        function shareVideo() {
            if (!currentTheaterVideo) return;
            
            const shareUrl = `${window.location.origin}/theater?video=${currentTheaterVideo.id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: currentTheaterVideo.title,
                    url: shareUrl
                }).catch(() => {});
                } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    log('Link copied to clipboard');
                    showNotification('Lien copiÃ© dans le presse-papier!', 'success');
                });
            }
        }

        // Follow video author
        async function followAuthor() {
            if (!publicKey || !currentTheaterVideo) {
                showNotification('Connectez-vous d\'abord pour suivre', 'connect');
                return;
            }
            
            const authorPubkey = currentTheaterVideo.authorId;
            
            // Check if already following
            if (friendsList.includes(authorPubkey)) {
                showNotification('Vous suivez dÃ©jÃ  cet auteur', 'info');
                return;
            }

            try {
                const p = getPool();
                
                // Fetch current contact list (kind 3)
                const contactEvents = await p.list(allRelays, [{
                    kinds: [3],
                    authors: [publicKey],
                    limit: 1
                }]);
                
                // Build existing contacts
                let existingContacts = [];
                if (contactEvents.length > 0) {
                    existingContacts = contactEvents[0].tags.filter(t => t[0] === 'p');
                }
                
                // Add new contact if not already present
                if (!existingContacts.some(t => t[1] === authorPubkey)) {
                    existingContacts.push(['p', authorPubkey]);
                }
                
                // Create new contact list event
                const event = {
                    kind: 3,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: existingContacts,
                    content: contactEvents.length > 0 ? contactEvents[0].content : ''
                };
                
                const signed = await window.nostr.signEvent(event);
                
                // Publish to relays
                let success = 0;
                await Promise.all(allRelays.map(async r => {
                    if (await publishToRelay(r, signed)) success++;
                }));
                
                if (success > 0) {
                    // Update local friendsList
                    friendsList.push(authorPubkey);
                    
                    // Update UI
                    $('#btnFollow').addClass('following').html('<span class="icon">âœ“</span><span>Suivi</span>');
                    
                    // Get author name for notification
                    const authorName = profileCache[authorPubkey]?.display_name || 
                                      profileCache[authorPubkey]?.name || 
                                      authorPubkey.slice(0, 8);
                    
                    log(`Now following ${authorName}`);
                    showNotification(`Vous suivez maintenant ${authorName}`, 'success', 'Suivi');
                    
                    // Refresh friends list in sidebar
                    renderFriendsList();
                } else {
                    showNotification('Erreur lors du suivi', 'error');
                }
            } catch (e) {
                log(`Follow error: ${e.message}`);
                showNotification('Erreur: ' + e.message, 'error');
            }
        }

        // Toggle comments section
        function toggleComments() {
            $('#theaterComments').toggle();
        }

        // Post comment on video
        async function postVideoCommentAction() {
            if (!publicKey || !currentTheaterVideo) {
                showNotification('Connectez-vous d\'abord pour commenter', 'connect');
                 return;
             }

            const content = $('#commentInput').val().trim();
            if (!content) return;
            
            try {
                const event = {
                    kind: 1111,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ['e', currentTheaterVideo.id, allRelays[0], 'root'],
                        ['p', currentTheaterVideo.authorId],
                        ['k', currentTheaterVideo.kind?.toString() || '21']
                    ],
                    content
                };
                
                const signed = await window.nostr.signEvent(event);
                await Promise.all(allRelays.map(r => publishToRelay(r, signed)));
                
                // Add to UI
                const profile = userProfile || {};
                const name = profile.display_name || profile.name || publicKey.slice(0, 8);
                $('#commentsList').append(`
                    <div class="theater-comment">
                        <span class="author">${escapeHtml(name)}:</span>
                        <span class="text">${escapeHtml(content)}</span>
                    </div>
                `);
                
                const count = parseInt($('#commentCount').text()) + 1;
                $('#commentCount').text(count);
                $('#commentInput').val('');
                
                log('Comment posted');
            } catch (e) {
                log(`Comment error: ${e.message}`);
            }
        }

        function formatDuration(seconds) {
            if (!seconds) return '';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return m > 60 ? `${Math.floor(m/60)}h ${m%60}m` : `${m}:${s.toString().padStart(2, '0')}`;
        }

        function formatRelativeDate(timestamp) {
            const now = Math.floor(Date.now() / 1000);
            const diff = now - timestamp;
            if (diff < 60) return 'maintenant';
            if (diff < 3600) return `${Math.floor(diff / 60)}min`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}j`;
            return new Date(timestamp * 1000).toLocaleDateString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Show Bootstrap notification modal
        function showNotification(message, type = 'info', title = null) {
            const icons = {
                'info': 'â„¹ï¸',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ',
                'connect': 'ðŸ”Œ'
            };
            const titles = {
                'info': 'Information',
                'success': 'SuccÃ¨s',
                'warning': 'Attention',
                'error': 'Erreur',
                'connect': 'Connexion requise'
            };
            
            $('#notificationIcon').text(icons[type] || icons.info);
            $('#notificationTitle').text(title || titles[type] || titles.info);
            $('#notificationMessage').html(message);
            
            // Style the OK button based on type
            const $btn = $('#notificationModal .modal-footer button');
            if (type === 'error') {
                $btn.css('background', 'var(--accent-red)');
            } else if (type === 'success') {
                $btn.css('background', 'var(--accent-green)');
            } else if (type === 'warning') {
                $btn.css('background', 'var(--accent-orange)');
                } else {
                $btn.css('background', 'var(--accent-cyan)');
            }
            
            const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
            modal.show();
        }

        // Get public key as hex (for profile viewer URL)
        function getPublicKeyHex() {
            if (!publicKey) return '';
            if (/^[0-9a-f]{64}$/i.test(publicKey)) return publicKey;
            if (typeof NostrTools !== 'undefined' && NostrTools.nip19 && publicKey.startsWith('npub')) {
                try {
                    const decoded = NostrTools.nip19.decode(publicKey);
                    if (decoded && decoded.data) return decoded.data;
                } catch (e) { log(`nip19 decode error: ${e.message}`); }
            }
            return publicKey;
        }

        // Open Nostr profile viewer in modal (gateway from common.js / getIpfsGateway)
        // If pubkeyArg is provided, open that profile; otherwise open current user's profile
        function openProfileViewerModal(pubkeyArg) {
            const targetPubkey = (pubkeyArg && pubkeyArg.length) ? pubkeyArg : publicKey;
            if (!targetPubkey) {
                showNotification('Connect first to view profile', 'info');
                return;
            }
            let hex = targetPubkey;
            if (!/^[0-9a-f]{64}$/i.test(targetPubkey) && typeof NostrTools !== 'undefined' && NostrTools.nip19 && targetPubkey.startsWith('npub')) {
                try {
                    const decoded = NostrTools.nip19.decode(targetPubkey);
                    if (decoded && decoded.data) hex = decoded.data;
                } catch (e) {}
            }
            const gateway = getIpfsGateway();
            const profileViewerPath = '/ipns/copylaradio.com/nostr_profile_viewer.html';
            const url = `${gateway}${profileViewerPath}?hex=${encodeURIComponent(hex)}&origin=${encodeURIComponent(hex)}`;
            $('#profileViewerFrame').attr('src', url);
            $('#profileViewerBackdrop').addClass('active');
        }

        function closeProfileViewerModal() {
            $('#profileViewerBackdrop').removeClass('active');
            $('#profileViewerFrame').attr('src', '');
        }

        // Open message viewer in modal (earth/nostr_message_viewer.html on IPFS gateway)
        function openMessageViewerModal(eventId) {
            if (!eventId) return;
            const gateway = getIpfsGateway();
            const messageViewerPath = '/ipns/copylaradio.com/nostr_message_viewer.html';
            const url = `${gateway}${messageViewerPath}?id=${encodeURIComponent(eventId)}`;
            $('#messageViewerFrame').attr('src', url);
            $('#messageViewerBackdrop').addClass('active');
        }

        function closeMessageViewerModal() {
            $('#messageViewerBackdrop').removeClass('active');
            $('#messageViewerFrame').attr('src', '');
        }

        // Open external URL in modal (iframe) instead of new tab
        function openUrlModal(url) {
            if (!url || !url.trim()) return;
            const u = url.trim();
            $('#urlModalTitle').text(u.length > 60 ? u.substring(0, 60) + 'â€¦' : u).attr('title', u);
            $('#urlModalFrame').attr('src', u);
            $('#urlModalBackdrop').addClass('active');
        }
        function closeUrlModal() {
            $('#urlModalBackdrop').removeClass('active');
            $('#urlModalFrame').attr('src', '');
        }

        // Get IPFS gateway URL - use common.js IPFS_GATEWAY if available
        function getIpfsGateway() {
            // Use common.js gateway if available
            if (typeof window.IPFS_GATEWAY !== 'undefined' && window.IPFS_GATEWAY) {
                return window.IPFS_GATEWAY;
            }
            
            // Fallback: derive from hostname
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://127.0.0.1:8080';
            }
            
            // Remove common subdomains (u., ipfs., relay., www.)
            const baseDomain = hostname.replace(/^(u\.|ipfs\.|relay\.|www\.)/i, '');
            return `${protocol}//ipfs.${baseDomain}`;
        }

        // Normalize IPFS URLs: convert various formats to full gateway URLs
        // Handles:
        // 1. u.{domain}/ipfs/... -> ipfs.{domain}/ipfs/... (only for IPFS paths)
        // 2. Relative paths: /ipfs/Qm... or /ipns/... -> {gateway}/ipfs/Qm...
        // 3. CID-only: Qm... or bafy... -> {gateway}/ipfs/Qm...
        // 4. Already complete URLs (ipfs.*, gateway.*, etc.): pass through unchanged
        function normalizeIpfsUrl(url) {
            if (!url) return url;
            
            url = url.trim();
            
            // Already a full URL
            if (url.startsWith('http://') || url.startsWith('https://')) {
                // If URL already has an IPFS gateway (ipfs.*, gateway.*, dweb.*), don't modify
                if (/^https?:\/\/(ipfs\.|gateway\.|dweb\.)/i.test(url)) {
                    return url; // Already a proper gateway URL
                }
                
                // Only replace u.{domain} with ipfs.{domain} for IPFS/IPNS paths
                if (/\/ipfs\/|\/ipns\//i.test(url)) {
                    url = url.replace(/^(https?:\/\/)u\.([^\/]+)(\/ipfs\/|\/ipns\/)/i, '$1ipfs.$2$3');
                }
                return url;
            }
            
            const gateway = getIpfsGateway();
            
            // Relative path: /ipfs/... or /ipns/...
            if (url.startsWith('/ipfs/') || url.startsWith('/ipns/')) {
                return `${gateway}${url}`;
            }
            
            // CID-only format: starts with Qm (CIDv0) or bafy/bafk (CIDv1)
            // Also handle potential filename after CID: Qm.../filename.mp4
            if (/^(Qm[1-9A-HJ-NP-Za-km-z]{44}|baf[yk][a-zA-Z2-7]{50,})/i.test(url)) {
                // Check if it's a CID with filename
                const parts = url.split('/');
                const cid = parts[0];
                const rest = parts.slice(1).join('/');
                if (rest) {
                    return `${gateway}/ipfs/${cid}/${rest}`;
                }
                return `${gateway}/ipfs/${url}`;
            }
            
            // Return as-is if we can't determine format
            return url;
        }

        // === WALLET ===
        function checkExtension() {
            if (typeof window.nostr !== 'undefined') {
                log('Extension found');
                $('#btnConnect').prop('disabled', false);
                } else {
                log('No extension');
                $('#btnConnect').text('Extension?').prop('disabled', true);
                setTimeout(() => {
                    if (typeof window.nostr !== 'undefined') {
                        $('#btnConnect').prop('disabled', false).text('Connecter');
                    }
                }, 1000);
            }
        }

        async function connectWallet() {
            log('Connecting with NIP-42...');
            try {
                $('#btnConnect').prop('disabled', true).text('...');
                updateAuthBadge('pending', 'â³ Connexion...');
                
                // Use common.js connectNostr with NIP-42 auth
                if (typeof connectNostr === 'function') {
                    publicKey = await connectNostr(true); // Force NIP-42 auth
                    log(`Connected via common.js: ${publicKey.slice(0,12)}...`);
                } else {
                    // Fallback to direct extension call
                    publicKey = await window.nostr.getPublicKey();
                    log(`Connected (fallback): ${publicKey.slice(0,12)}...`);
                }
                
                $('#statusDot').removeClass('offline');
                $('#profileMini').addClass('connected');
                $('#btnConnect').hide();
                $('#btnSend').prop('disabled', false);
                
                // Fetch profile and DID
                await fetchProfile();
                await fetchDidDocument();
                
                // Verify NIP-42 authentication
                await verifyAndShowAuth();
                
                // Fetch user services (uDRIVE, UMAP)
                await fetchUserServices();
                
                // Finally fetch messages
                await fetchMessages();
                
            } catch (e) {
                log(`ERROR: ${e.message}`);
                updateAuthBadge('failed', 'âŒ Ã‰chec');
                $('#btnConnect').prop('disabled', false).text('RÃ©essayer');
            }
        }
        
        // Update auth badge display
        function updateAuthBadge(status, text) {
            const $badge = $('#didAuthStatus .auth-badge');
            $badge.removeClass('pending authenticated failed').addClass(status);
            $badge.text(text);
        }
        
        // Verify NIP-42 authentication with API
        async function verifyAndShowAuth() {
            if (!publicKey) return;
            
            updateAuthBadge('pending', 'â³ VÃ©rification...');
            
            try {
                // Use common.js verifyAuthenticationWithAPI if available
                if (typeof verifyAuthenticationWithAPI === 'function') {
                    const authResult = await verifyAuthenticationWithAPI(publicKey);
                    
                    if (authResult && authResult.auth_verified) {
                        log('âœ… NIP-42 authenticated');
                        updateAuthBadge('authenticated', 'âœ… AuthentifiÃ© (NIP-42)');
                        return true;
                    } else {
                        log('âš ï¸ NIP-42 not verified');
                        updateAuthBadge('pending', 'âš ï¸ Non vÃ©rifiÃ©');
                        return false;
                    }
                } else {
                    // No API available, assume connected
                    updateAuthBadge('authenticated', 'âœ… ConnectÃ©');
                    return true;
                }
            } catch (e) {
                log(`Auth check error: ${e.message}`);
                updateAuthBadge('pending', 'âš ï¸ VÃ©rification Ã©chouÃ©e');
                return false;
            }
        }
        
        // Fetch user services (uDRIVE, UMAP GPS)
        async function fetchUserServices() {
            if (!publicKey) {
                log('âš ï¸ fetchUserServices: no publicKey');
                return;
            }
            
            log('Fetching user services...');
            console.log('[Services] Starting fetch for pubkey:', publicKey.slice(0, 12));
            
            // ==================== uDRIVE ====================
            log('ðŸ“ [uDRIVE] Starting fetch...');
            try {
                if (typeof fetchUserUDriveInfo === 'function') {
                    console.log('[uDRIVE] Calling fetchUserUDriveInfo...');
                    const udriveInfo = await fetchUserUDriveInfo(publicKey);
                    console.log('[uDRIVE] Result:', udriveInfo);
                    
                    if (udriveInfo && udriveInfo.ipnsVault) {
                        log(`âœ… uDRIVE found: ${udriveInfo.ipnsVault.substring(0, 12)}...`);
                        
                        // Build uDRIVE URL
                        const gateway = getIpfsGateway();
                        console.log('[uDRIVE] Gateway:', gateway);
                        console.log('[uDRIVE] buildUDriveUrl available:', typeof buildUDriveUrl === 'function');
                        console.log('[uDRIVE] email available:', !!udriveInfo.email, udriveInfo.email);
                        let udriveUrl;
                        
                        try {
                            if (typeof buildUDriveUrl === 'function' && udriveInfo.email) {
                                console.log('[uDRIVE] Calling buildUDriveUrl...');
                                udriveUrl = buildUDriveUrl(udriveInfo.ipnsVault, udriveInfo.email);
                                console.log('[uDRIVE] buildUDriveUrl returned:', udriveUrl);
                            } else {
                                console.log('[uDRIVE] Fallback: direct IPNS URL');
                                udriveUrl = `${gateway}/ipns/${udriveInfo.ipnsVault}`;
                            }
                        } catch (urlErr) {
                            console.error('[uDRIVE] buildUDriveUrl error:', urlErr.message, urlErr);
                            log(`âš ï¸ [uDRIVE] URL build error: ${urlErr.message}`);
                            udriveUrl = `${gateway}/ipns/${udriveInfo.ipnsVault}`;
                            console.log('[uDRIVE] Using fallback URL:', udriveUrl);
                        }
                        
                        console.log('[uDRIVE] Final URL:', udriveUrl);
                        
                        if (!udriveUrl) {
                            console.error('[uDRIVE] No URL generated!');
                            return;
                        }
                        
                        // Show uDRIVE in DID panel
                        const $udriveSection = $('#didUdriveSection');
                        $udriveSection.removeClass('hidden-service').css('display', 'block');
                        $('#didUdriveLink').attr('href', udriveUrl);
                        
                        // Show uDRIVE button in top bar
                        $('#topbarServices').show();
                        $('#topbarUdrive').attr('href', udriveUrl).show();
                        
                        console.log('[uDRIVE] âœ… Button added to topbar');
                        log(`âœ… uDRIVE: ${udriveUrl.substring(0, 40)}...`);
                    } else {
                        log('ðŸ“ [uDRIVE] No IPNS vault found');
                        console.log('[uDRIVE] udriveInfo incomplete:', udriveInfo);
                    }
                } else {
                    log('âš ï¸ [uDRIVE] fetchUserUDriveInfo not available');
                }
            } catch (e) {
                log(`âŒ [uDRIVE] Error: ${e.message}`);
                console.error('[uDRIVE] Exception:', e);
            }
            
            // ==================== GPS/UMAP ====================
            log('ðŸ—ºï¸ [GPS] Starting fetch...');
            const gpsUrl = `/api/myGPS?npub=${publicKey}`;
            console.log('[GPS] Fetching:', gpsUrl);
            
            try {
                const gpsResponse = await fetch(gpsUrl);
                console.log('[GPS] Response status:', gpsResponse.status);
                
                if (gpsResponse.ok) {
                    const gpsData = await gpsResponse.json();
                    console.log('[GPS] Response data:', gpsData);
                    
                    if (gpsData.success && gpsData.coordinates) {
                        const umapKey = gpsData.umap_key || `${gpsData.coordinates.lat.toFixed(2)},${gpsData.coordinates.lon.toFixed(2)}`;
                        log(`âœ… UMAP found: ${umapKey}`);
                        
                        // Build UMAP chat URL (format: /chat?room=lat,lon)
                        const umapChatUrl = `/chat?room=${encodeURIComponent(umapKey)}`;
                        console.log('[GPS] UMAP URL:', umapChatUrl);
                        
                        // Show UMAP in DID panel (opens modal)
                        const $umapSection = $('#didUmapSection');
                        $umapSection.removeClass('hidden-service').css('display', 'block');
                        $('#didUmapLink')
                            .attr('href', '#')
                            .attr('data-room', umapKey)
                            .on('click', function(e) {
                                e.preventDefault();
                                openChatModal(umapKey);
                            });
                        $('#didUmapCoords').text(`Chat ${umapKey}`);
                        
                        // Show UMAP button in top bar (opens modal)
                        $('#topbarServices').show();
                        $('#topbarUmap')
                            .attr('href', '#')
                            .attr('data-room', umapKey)
                            .on('click', function(e) {
                                e.preventDefault();
                                openChatModal(umapKey);
                            })
                            .show();
                        
                        console.log('[GPS] âœ… Button added to topbar');
                        log(`âœ… UMAP: ${umapKey}`);
                        
                        // Store for later use
                        window.userUmapKey = umapKey;
                        window.userGpsData = gpsData;
                    } else {
                        log('ðŸ—ºï¸ [GPS] No coordinates in response');
                        console.log('[GPS] Response missing data:', { success: gpsData.success, hasCoords: !!gpsData.coordinates });
                    }
                } else if (gpsResponse.status === 403) {
                    log('ðŸ—ºï¸ [GPS] 403 - Auth required (connect to your home relay)');
                } else if (gpsResponse.status === 404) {
                    log('ðŸ—ºï¸ [GPS] 404 - Not registered on this relay');
                } else {
                    log(`ðŸ—ºï¸ [GPS] API returned ${gpsResponse.status}`);
                    const errorText = await gpsResponse.text().catch(() => '');
                    console.log('[GPS] Error response:', errorText);
                }
            } catch (e) {
                log(`âŒ [GPS] Error: ${e.message}`);
                console.error('[GPS] Exception:', e);
            }
            
            // ==================== Summary ====================
            const udriveVisible = $('#didUdriveSection').css('display') !== 'none';
            const umapVisible = $('#didUmapSection').css('display') !== 'none';
            console.log('[Services] Summary - uDRIVE visible:', udriveVisible, ', UMAP visible:', umapVisible);
            
            if (!udriveVisible && !umapVisible && publicKey) {
                log('â„¹ï¸ Services not available - try connecting to your home relay');
            }
        }

        async function fetchProfile() {
            const p = getPool();
            for (const relay of allRelays) {
                try {
                    const events = await p.list([relay], [{ kinds: [0], authors: [publicKey], limit: 1 }]);
                    if (events.length) {
                        const event = events[0];
                        userProfile = JSON.parse(event.content);
                        
                        // Normalize IPFS URLs in profile
                        if (userProfile.picture) userProfile.picture = normalizeIpfsUrl(userProfile.picture);
                        if (userProfile.banner) userProfile.banner = normalizeIpfsUrl(userProfile.banner);
                        
                        // Extract additional fields from event tags (g1pub, zencard)
                        if (event.tags && Array.isArray(event.tags)) {
                            event.tags.forEach(tag => {
                                if (tag.length >= 2 && tag[0] === 'i') {
                                    const value = tag[1];
                                    if (value.startsWith('g1pub:')) {
                                        userProfile.g1pub = value.substring(6);
                                    } else if (value.startsWith('zencard:')) {
                                        userProfile.zencard = value.substring(8);
                                    }
                                }
                            });
                        }
                        
                        // Update profile display
                        $('#profileImg').attr('src', userProfile.picture || $('#profileImg').attr('src'));
                        $('#profileName').text(userProfile.display_name || userProfile.name || publicKey.slice(0, 8));
                        log(`Profile: ${userProfile.name || userProfile.display_name}`);
                        
                        // Update header with banner if available
                        updateHeaderWithBanner(userProfile);
                        
                        // Fetch and display ZEN balance
                        fetchAndDisplayZenBalance(userProfile);
                        
                        break;
                    }
                } catch (e) { log(`Profile error: ${e.message}`); }
            }
        }

        // Update header with user's banner
        function updateHeaderWithBanner(profile) {
            const $topBar = $('#topBar');
            if (profile.banner) {
                const bannerUrl = normalizeIpfsUrl(profile.banner);
                $topBar.addClass('with-banner');
                $topBar.css('background-image', `url('${bannerUrl}')`);
                log(`Banner set: ${bannerUrl.substring(0, 50)}...`);
            } else {
                $topBar.removeClass('with-banner');
                $topBar.css('background-image', 'none');
            }
        }

        // Get API server URL (ipfs. -> u.)
        function getApiServerUrl() {
            const url = new URL(window.location.href);
            let hostname = url.hostname.replace(/^ipfs\./, 'u.');
            let port = url.port;
            if (port === '8080') port = '54321';
            const protocol = url.protocol;
            return port ? `${protocol}//${hostname}:${port}` : `${protocol}//${hostname}`;
        }

        // Check ZEN balance for a g1pub
        async function checkZenBalance(g1pub) {
            try {
                const apiUrl = getApiServerUrl();
                const response = await fetch(`${apiUrl}/check_balance?g1pub=${g1pub}`, { timeout: 5000 });
                
                if (!response.ok) return null;
                
                const data = await response.json();
                if (data.balance && data.g1pub) {
                    const g1Balance = parseFloat(data.balance);
                    const zenBalance = Math.floor((g1Balance - 1) * 10);
                    return { g1Balance, zenBalance, g1pub: data.g1pub };
                }
                return null;
            } catch (error) {
                log(`Balance check error: ${error.message}`);
                return null;
            }
        }

        // Fetch and display ZEN balance
        async function fetchAndDisplayZenBalance(profile) {
            const $zenBalance = $('#zenBalance');
            const $zenAmount = $('#zenAmount');
            const $zencardIcon = $('#zencardIcon');
            
            // Show loading state
            $zenBalance.show().addClass('loading');
            $zenAmount.text('...');
            
            let totalZen = 0;
            let hasZenCard = false;
            
            // Check g1pub balance
            if (profile.g1pub) {
                const g1pubParts = profile.g1pub.split(':');
                const mainPub = g1pubParts[0]; // Use first part (MULTIPASS)
                
                const balance = await checkZenBalance(mainPub);
                if (balance) {
                    totalZen = balance.zenBalance;
                    log(`ZEN Balance: ${totalZen} áºEN`);
                }
            }
            
            // Check ZenCard
            if (profile.zencard && profile.zencard !== 'None' && profile.zencard.trim() !== '') {
                hasZenCard = true;
                log(`ZenCard found: ${profile.zencard.substring(0, 8)}...`);
            }
            
            // Update display
            $zenBalance.removeClass('loading');
            $zenAmount.text(totalZen > 0 ? `${totalZen} áºEN` : '0 áºEN');
            
            if (hasZenCard) {
                $zencardIcon.show();
                } else {
                $zencardIcon.hide();
            }
        }

        // === DID DOCUMENT (kind 30800) ===
        let userDid = null;
        
        // Fetch DID document (kind 30800 - NIP-101)
        async function fetchDidDocument() {
            if (!publicKey) return null;
            
            const p = getPool();
            log('Fetching DID document (kind 30800)...');
            
            for (const relay of allRelays) {
                try {
                    const events = await p.list([relay], [{
                        kinds: [30800],
                        authors: [publicKey],
                        '#d': ['did'],
                        limit: 1
                    }]);
                    
                    if (events.length > 0) {
                        const event = events[0];
                        try {
                            userDid = JSON.parse(event.content);
                            log(`DID found: ${userDid.id ? userDid.id.substring(0, 30) + '...' : 'unknown'}`);
                            updateDidDisplay(userDid);
                            updateSocietaireBadge(userDid);
                            return userDid;
            } catch (e) {
                            log(`DID parse error: ${e.message}`);
                        }
                    }
                } catch (e) {
                    log(`DID fetch error: ${e.message}`);
                }
            }
            
            log('No DID document found');
            updateSocietaireBadge(null);
            return null;
        }

        // Check if user is a sociÃ©taire based on DID contractStatus (Satellite or higher)
        function isSocietaireFromDid(did) {
            if (!did || !did.metadata || !did.metadata.contractStatus) return false;
            
            const status = did.metadata.contractStatus;
            return status.includes('cooperative_member') ||
                   status.includes('infrastructure_contributor') ||
                   status.includes('cooperative_treasury_contributor') ||
                   status.includes('cooperative_rnd_contributor') ||
                   status.includes('cooperative_assets_contributor');
        }

        // Check if user is CONSTELLATION tier (highest tier - I2V access)
        function isConstellationFromDid(did) {
            if (!did || !did.metadata || !did.metadata.contractStatus) return false;
            
            const status = did.metadata.contractStatus;
            return status.includes('cooperative_member_constellation') ||
                   status.includes('infrastructure_contributor');
        }

        // Get the tier level: 'constellation', 'satellite', or 'visitor'
        function getTierFromDid(did) {
            if (!did || !did.metadata || !did.metadata.contractStatus) return 'visitor';
            
            const status = did.metadata.contractStatus;
            if (status.includes('cooperative_member_constellation') || 
                status.includes('infrastructure_contributor')) {
                return 'constellation';
            }
            if (status.includes('cooperative_member_satellite') ||
                status.includes('cooperative_treasury_contributor') ||
                status.includes('cooperative_rnd_contributor') ||
                status.includes('cooperative_assets_contributor')) {
                return 'satellite';
            }
            return 'visitor';
        }

        // Update societaire badge display - differentiate Satellite vs Constellation
        function updateSocietaireBadge(did) {
            const $badge = $('#societaireBadge');
            const tier = getTierFromDid(did);
            
            $badge.removeClass('visitor member constellation satellite');
            
            if (tier === 'constellation') {
                $badge.addClass('member constellation');
                $badge.html('ðŸŒŸ Constellation');
                $badge.attr('title', 'Membre Constellation - AccÃ¨s complet (T2V + I2V)');
            } else if (tier === 'satellite') {
                $badge.addClass('member satellite');
                $badge.html('â­ Satellite');
                $badge.attr('title', 'Membre Satellite - AccÃ¨s T2V (Text-to-Video)');
                } else {
                $badge.addClass('visitor');
                $badge.html('ðŸ‘¤ Visiteur');
                $badge.attr('title', 'AccÃ¨s limitÃ© - Devenez sociÃ©taire pour dÃ©bloquer toutes les fonctionnalitÃ©s');
            }
            
            $badge.show();
        }

        // Update DID panel display
        function updateDidDisplay(did) {
            if (!did) {
                $('#didContractStatus').text('Non trouvÃ©');
                $('#didTokenTypes').text('---');
                $('#didStorageQuota').text('---');
                $('#didServices').text('---');
                $('#didIdentifier').text('---');
                $('#didAstroport').text('---');
                return;
            }
            
            const meta = did.metadata || {};
            
            // Contract Status
            const statusMap = {
                'active_rental': 'ðŸŽ« MULTIPASS (Location)',
                'cooperative_member_satellite': 'â­ SociÃ©taire Satellite',
                'cooperative_member_constellation': 'ðŸŒŸ SociÃ©taire Constellation',
                'infrastructure_contributor': 'ðŸ—ï¸ Contributeur Infrastructure',
                'cooperative_treasury_contributor': 'ðŸ’° Contributeur TrÃ©sorerie',
                'cooperative_rnd_contributor': 'ðŸ”¬ Contributeur R&D',
                'cooperative_assets_contributor': 'ðŸ“¦ Contributeur Assets',
                'new_multipass': 'ðŸ†• Nouveau MULTIPASS',
                'new_user': 'ðŸ‘¤ Nouvel utilisateur'
            };
            const statusText = statusMap[meta.contractStatus] || meta.contractStatus || '---';
            const $status = $('#didContractStatus');
            $status.text(statusText);
            
            if (isSocietaireFromDid(did)) {
                $status.addClass('highlight').removeClass('warning');
            } else {
                $status.addClass('warning').removeClass('highlight');
            }
            
            // Token Types
            const tokenTypes = meta.tokenTypes || [];
            const tokenIcons = {
                'ZENCARD': 'ðŸ’³ ZenCard',
                'ZENCOIN': 'ðŸª™ ZenCoin'
            };
            const tokenText = tokenTypes.map(t => tokenIcons[t] || t).join(', ') || '---';
            $('#didTokenTypes').text(tokenText);
            
            // Storage Quota
            const quota = meta.storageQuota || '---';
            const $quota = $('#didStorageQuota');
            $quota.text(quota);
            if (quota === '128GB') {
                $quota.addClass('highlight');
            } else {
                $quota.removeClass('highlight');
            }
            
            // Services
            const services = meta.services || '';
            if (services) {
                const serviceList = services.split('+').map(s => s.trim());
                $('#didServices').html(serviceList.map(s => `<span class="service-tag">${s}</span>`).join(''));
            } else {
                $('#didServices').text('---');
            }
            
            // DID Identifier
            if (did.id) {
                const shortDid = did.id.length > 50 ? did.id.substring(0, 50) + '...' : did.id;
                $('#didIdentifier').text(shortDid);
            } else {
                $('#didIdentifier').text('---');
            }
            
            // Astroport Station
            const station = meta.astroportStation?.ipns || meta.astroport || '---';
            if (station && station !== '---') {
                const shortStation = station.length > 30 ? station.substring(0, 30) + '...' : station;
                $('#didAstroport').text(shortStation);
            } else {
                $('#didAstroport').text('---');
            }
        }

        // Toggle DID panel visibility
        function toggleDidPanel() {
            const $panel = $('#didPanel');
            $panel.toggleClass('visible');
            
            // Close on click outside
            if ($panel.hasClass('visible')) {
                setTimeout(() => {
                    $(document).one('click', function(e) {
                        if (!$(e.target).closest('#didPanel, #profileMini').length) {
                            $panel.removeClass('visible');
                        }
                    });
                }, 100);
            }
        }

        // Show societaire information modal (for T2V access)
        function showSocietaireInfo() {
            const ipfsGateway = getIpfsGateway();
            showNotification(`
                <h5>â­ AccÃ¨s SociÃ©taire Satellite</h5>
                <p>Le mode <strong>Text-to-Video (T2V)</strong> est rÃ©servÃ© aux membres de la coopÃ©rative.</p>
                <h6>ðŸ“Š Niveaux d'accÃ¨s #video :</h6>
                <ul style="text-align:left; font-size:0.8rem; margin: 8px 0;">
                    <li>â­ <strong>Satellite</strong> : Text-to-Video (T2V)</li>
                    <li>ðŸŒŸ <strong>Constellation</strong> : T2V + Image-to-Video (I2V)</li>
                </ul>
                <h6>Avantages sociÃ©taires :</h6>
                <ul style="text-align:left; font-size:0.8rem; margin: 8px 0;">
                    <li>ðŸ§  Slots mÃ©moire 1-12 (#mem)</li>
                    <li>ðŸ“ 128 Go de stockage NextCloud</li>
                    <li>ðŸ—³ï¸ Droit de vote sur les Ã©volutions</li>
                </ul>
                <p style="margin-top: 12px;">
                    <a href="https://opencollective.com/uplanet-zero" target="_blank" class="btn btn-sm btn-primary">
                        Devenir sociÃ©taire
                    </a>
                </p>
            `);
        }

        // Show constellation upgrade information (for I2V access)
        function showConstellationInfo() {
            const ipfsGateway = getIpfsGateway();
            const tier = getTierFromDid(userDid);
            
            let currentTierMsg = '';
            if (tier === 'satellite') {
                currentTierMsg = `<p style="color: #ffd700;">âœ… Vous Ãªtes <strong>Satellite</strong> - AccÃ¨s T2V activÃ©</p>`;
            }
            
            showNotification(`
                <h5>ðŸŒŸ AccÃ¨s Constellation</h5>
                <p>Le mode <strong>Image-to-Video (I2V)</strong> nÃ©cessite le niveau Constellation.</p>
                ${currentTierMsg}
                <h6>ðŸ“Š Comparatif des niveaux :</h6>
                <table style="width:100%; font-size:0.75rem; margin: 8px 0;">
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td></td>
                        <td style="text-align:center;">â­ Satellite</td>
                        <td style="text-align:center;">ðŸŒŸ Constellation</td>
                    </tr>
                    <tr>
                        <td>Text-to-Video</td>
                        <td style="text-align:center;">âœ…</td>
                        <td style="text-align:center;">âœ…</td>
                    </tr>
                    <tr>
                        <td>Image-to-Video</td>
                        <td style="text-align:center;">âŒ</td>
                        <td style="text-align:center;">âœ…</td>
                    </tr>
                    <tr>
                        <td>Services IA+</td>
                        <td style="text-align:center;">âŒ</td>
                        <td style="text-align:center;">âœ…</td>
                    </tr>
                </table>
                <p style="margin-top: 12px;">
                    <a href="https://opencollective.com/uplanet-zero/contribute/proprio-128-go-71400" target="_blank" class="btn btn-sm btn-primary">
                        Upgrade vers Constellation
                    </a>
                </p>
            `);
        }

        // Update video access warnings based on user tier and current video mode
        function updateVideoAccessWarnings() {
            const tier = getTierFromDid(userDid);
            
            // Hide all warnings first
            $('#videoT2vWarning').hide();
            $('#videoI2vWarning').hide();
            
            if (tier === 'visitor') {
                // Non-societaire: show T2V warning (no access to any video)
                $('#videoT2vWarning').show();
            } else if (tier === 'satellite' && videoMode === 'i2v') {
                // Satellite trying I2V: show constellation warning
                $('#videoI2vWarning').show();
            }
            // Constellation users: no warnings needed
        }

        // === MESSAGES ===
        // Ensure mute list (NIP-51 kind 10000) is loaded for filtering. Use common.js if available, else fetch here.
        async function ensureMuteListLoaded() {
            if (typeof loadMuteList === 'function') {
                await loadMuteList();
                return;
            }
            if (!publicKey) {
                window.mutedPubkeys = window.mutedPubkeys || new Set();
                return;
            }
            try {
                const p = getPool();
                const events = await p.list(allRelays || [], [{ kinds: [10000], authors: [publicKey], limit: 1 }]);
                const ev = events && events[0];
                const list = (ev && ev.tags) ? ev.tags.filter(t => t[0] === 'p' && t[1]).map(t => t[1]) : [];
                window.mutedPubkeys = new Set(list);
            } catch (e) {
                window.mutedPubkeys = window.mutedPubkeys || new Set();
            }
        }

        async function fetchMessages() {
            if (!publicKey) return;
            log('Fetching messages...');
            if (typeof loadMuteList === 'function') await loadMuteList();
            const p = getPool();
            try {
                const events = await p.list(allRelays, [{
                    kinds: [1],
                    authors: [publicKey],
                    limit: MESSAGES_PER_PAGE
                }]);
                const muted = typeof getMutedPubkeys === 'function' ? getMutedPubkeys() : new Set();
                allMessages = events.filter(e => !muted.has(e.pubkey)).sort((a, b) => b.created_at - a.created_at);
                allMessages.forEach(m => { m._tags = extractTags(m.content); });
                log(`Got ${allMessages.length} messages${muted.size ? ` (muted ${muted.size} authors)` : ''}`);
                updateServiceCounts();
                filterAndDisplayMessages();
            } catch (e) {
                log(`Fetch error: ${e.message}`);
            }
        }

        // N: messages from friends. NÂ²: messages from friends of friends.
        // Exclude "Vous" (self) messages, or only show self when replying to N/NÂ² (we exclude all self for simplicity).
        async function fetchNFeed(mode) {
            if (!publicKey) {
                $('#chatArea').empty().append($('#emptyState').removeClass('hidden').clone());
                return;
            }
            const $chat = $('#chatArea').empty();
            $('#emptyState').addClass('hidden');
            $chat.append('<div class="n-feed-loading" style="padding:20px;text-align:center;color:var(--text-dim);">Loading...</div>');

            try {
                if (!friendsList || friendsList.length === 0) {
                    await loadFriendsList();
                }
                const friendsCount = (friendsList || []).length;
                const p = getPool();
                let authors = [];
                let fofToFriends = {}; // NÂ²: map FoF pubkey -> array of friend pubkeys who follow them
                if (mode === 'n') {
                    authors = [...(friendsList || [])];
                } else if (mode === 'n2') {
                    const meAndFriends = new Set([publicKey, ...(friendsList || [])]);
                    const fof = new Set();
                    const friendPubkeys = (friendsList || []).slice(0, 50);
                    const contactsResults = await Promise.all(
                        friendPubkeys.map(friendPubkey => p.list(allRelays, [{ kinds: [3], authors: [friendPubkey], limit: 1 }]))
                    );
                    contactsResults.forEach((contacts, i) => {
                        const friendPubkey = friendPubkeys[i];
                        if (contacts && contacts.length > 0) {
                            contacts[0].tags.filter(t => t[0] === 'p').forEach(t => {
                                if (t[1] && !meAndFriends.has(t[1])) {
                                    fof.add(t[1]);
                                    if (!fofToFriends[t[1]]) fofToFriends[t[1]] = [];
                                    fofToFriends[t[1]].push(friendPubkey);
                                }
                            });
                        }
                    });
                    authors = [...fof];
                }
                // p2p filter: keep only authors whose kind 3 contains publicKey (reciprocal follow)
                if (nFeedFilter === 'p2p' && authors.length > 0 && allRelays && allRelays.length > 0) {
                    try {
                        const contactEvents = await p.list(allRelays.slice(0, 3), [{
                            kinds: [3],
                            authors: authors,
                            limit: authors.length * 2
                        }]);
                        const reciprocalSet = new Set();
                        contactEvents.forEach(ev => {
                            const hasMe = ev.tags && ev.tags.some(t => t[0] === 'p' && t[1] === publicKey);
                            if (hasMe) reciprocalSet.add(ev.pubkey);
                        });
                        authors = authors.filter(a => reciprocalSet.has(a));
                        if (mode === 'n2' && fofToFriends) {
                            const newFof = {};
                            authors.forEach(a => { if (fofToFriends[a]) newFof[a] = fofToFriends[a]; });
                            fofToFriends = newFof;
                        }
                    } catch (e) {}
                }
                const peopleCount = authors.length;
                if (authors.length === 0) {
                    $chat.empty().append('<div class="empty-state" style="padding:20px;text-align:center;color:var(--text-dim);">' +
                        (mode === 'n' ? 'No friends yet. Follow people to see their messages here.' : 'No friends of friends to show.') + '</div>');
                    updateNFeedTabCount(mode, 0, peopleCount);
                    return;
                }
                await ensureMuteListLoaded();
                const events = await p.list(allRelays, [{
                    kinds: [1],
                    authors: authors.slice(0, 100),
                    limit: 150
                }]);
                const muted = (typeof getMutedPubkeys === 'function' ? getMutedPubkeys() : null) || window.mutedPubkeys || new Set();
                // Exclude self and muted authors
                const filtered = events.filter(e => e.pubkey !== publicKey && !muted.has(e.pubkey));
                filtered.sort((a, b) => b.created_at - a.created_at);
                $chat.find('.n-feed-loading').remove();
                renderNFeedView(filtered, mode, fofToFriends);
                updateNFeedTabCount(mode, filtered.length, peopleCount);
            } catch (e) {
                log(`N feed error: ${e.message}`);
                $chat.find('.n-feed-loading').remove();
                $chat.append('<div class="empty-state" style="padding:20px;text-align:center;color:var(--accent-red);">Error: ' + (e.message || 'Failed to load') + '</div>');
                updateNFeedTabCount(mode, 0, mode === 'n' ? (friendsList || []).length : 0);
            }
        }

        function updateNFeedTabCount(mode, messageCount, peopleCount) {
            const $tab = $(`.svc-tab[data-svc="${mode}"]`);
            if (!$tab.length) return;
            const people = peopleCount != null ? peopleCount : 0;
            const label = mode === 'n' ? `N (${people})` : `NÂ² (${people})`;
            $tab.html(`${label} <span class="svc-count">${messageCount != null ? messageCount : 0}</span>`);
        }

        // Blog: long-form articles (kind 30023) from friends, with p21/p2p filter
        function getArticleTitle(ev) {
            if (!ev.tags || !Array.isArray(ev.tags)) return 'Untitled';
            const titleTag = ev.tags.find(t => t[0] === 'title' && t[1]);
            if (titleTag) return titleTag[1];
            const dTag = ev.tags.find(t => t[0] === 'd' && t[1]);
            return (dTag && dTag[1]) ? dTag[1] : 'Untitled';
        }

        async function fetchBlogFeed() {
            if (!publicKey) {
                $('#chatArea').empty().append($('#emptyState').removeClass('hidden').clone());
                return;
            }
            const $chat = $('#chatArea').empty();
            $('#emptyState').addClass('hidden');
            $chat.append('<div class="n-feed-loading" style="padding:20px;text-align:center;color:var(--text-dim);">Loading...</div>');
            try {
                if (!friendsList || friendsList.length === 0) await loadFriendsList();
                const p = getPool();
                let authors = [...(friendsList || [])];
                if (nFeedFilter === 'p2p' && authors.length > 0 && allRelays && allRelays.length > 0) {
                    try {
                        const contactEvents = await p.list(allRelays.slice(0, 3), [{ kinds: [3], authors: authors, limit: authors.length * 2 }]);
                        const reciprocalSet = new Set();
                        contactEvents.forEach(ev => {
                            const hasMe = ev.tags && ev.tags.some(t => t[0] === 'p' && t[1] === publicKey);
                            if (hasMe) reciprocalSet.add(ev.pubkey);
                        });
                        authors = authors.filter(a => reciprocalSet.has(a));
                    } catch (e) {}
                }
                const peopleCount = authors.length;
                if (authors.length === 0) {
                    $chat.empty().append('<div class="empty-state" style="padding:20px;text-align:center;color:var(--text-dim);">No friends yet, or no reciprocal follows. Follow people to see their blog posts here.</div>');
                    updateBlogTabCount(0, peopleCount);
                    return;
                }
                await ensureMuteListLoaded();
                const events = await p.list(allRelays, [{ kinds: [30023], authors: authors.slice(0, 100), limit: 80 }]);
                const muted = (typeof getMutedPubkeys === 'function' ? getMutedPubkeys() : null) || window.mutedPubkeys || new Set();
                const filtered = events.filter(e => e.pubkey !== publicKey && !muted.has(e.pubkey));
                filtered.sort((a, b) => b.created_at - a.created_at);
                $chat.find('.n-feed-loading').remove();
                renderBlogView(filtered);
                updateBlogTabCount(filtered.length, peopleCount);
            } catch (e) {
                log(`Blog feed error: ${e.message}`);
                $chat.find('.n-feed-loading').remove();
                $chat.append('<div class="empty-state" style="padding:20px;text-align:center;color:var(--text-dim);">Error: ' + (e.message || 'Failed to load') + '</div>');
                updateBlogTabCount(0, (friendsList || []).length);
            }
        }

        function updateBlogTabCount(articleCount, peopleCount) {
            const $tab = $('.svc-tab[data-svc="blog"]');
            if (!$tab.length) return;
            const people = peopleCount != null ? peopleCount : 0;
            $tab.html(`ðŸ“ Blog (${people}) <span class="svc-count">${articleCount != null ? articleCount : 0}</span>`);
        }

        async function renderBlogView(events) {
            const $chat = $('#chatArea').empty();
            $('#emptyState').addClass('hidden');
            if (events.length === 0) {
                $chat.append('<div class="empty-state" style="padding:20px;text-align:center;color:var(--text-dim);">No blog articles from this feed yet.</div>');
                return;
            }
            const defaultAvatar = 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1';
            const uniquePubkeys = [...new Set(events.map(e => e.pubkey).filter(Boolean))];
            const missingPubkeys = uniquePubkeys.filter(pk => !profileCache[pk]);
            if (missingPubkeys.length > 0 && allRelays && allRelays.length > 0) {
                try {
                    const pool = getPool();
                    const profileEvents = await pool.list(allRelays.slice(0, 3), [{ kinds: [0], authors: missingPubkeys, limit: missingPubkeys.length * 2 }]);
                    profileEvents.forEach(ev => {
                        try {
                            const profile = JSON.parse(ev.content);
                            if (profile.picture) profile.picture = normalizeIpfsUrl(profile.picture);
                            if (profile.banner) profile.banner = normalizeIpfsUrl(profile.banner);
                            profileCache[ev.pubkey] = profile;
                        } catch (e) {}
                    });
                } catch (e) {}
            }
            for (const ev of events) {
                const profile = profileCache[ev.pubkey] || null;
                const avatarUrl = profile?.picture ? normalizeIpfsUrl(profile.picture) : defaultAvatar;
                const name = profile?.display_name || profile?.name || ev.pubkey.slice(0, 8);
                const title = getArticleTitle(ev);
                const content = ev.content || '';
                const preview = content.replace(/\s+/g, ' ').trim().slice(0, 150);
                const dateStr = new Date(ev.created_at * 1000).toLocaleString();
                const $card = $('<div class="blog-article-card"></div>');
                $card.append(`
                    <div class="blog-article-header">
                        <img class="blog-article-avatar" src="${avatarUrl}" alt="" onerror="this.src='${defaultAvatar}'">
                        <div class="blog-article-meta">
                            <span class="blog-article-author">${$('<div>').text(name).html()}</span>
                            <span class="blog-article-date">${dateStr}</span>
                        </div>
                    </div>
                    <h3 class="blog-article-title">${$('<div>').text(title).html()}</h3>
                    ${preview ? `<p class="blog-article-preview">${$('<div>').text(preview + (content.length > 150 ? 'â€¦' : '')).html()}</p>` : ''}
                    <button type="button" class="blog-article-view-btn">ðŸ“„ View</button>
                `);
                $card.find('.blog-article-author').on('click', function(e) { e.preventDefault(); openProfileViewerModal(ev.pubkey); });
                $card.find('.blog-article-view-btn').on('click', function(e) { e.preventDefault(); openMessageViewerModal(ev.id); });
                $chat.append($card);
            }
        }

        // Render markdown when content looks like md; use /earth marked.min.js if available
        function renderMarkdownContent(content) {
            if (!content || !content.trim()) return { html: '', isMarkdown: false };
            const looksLikeMd = /#{1,6}\s|(\*\*|__).*\1|^```|^\s*[-*+]\s|^\s*\d+\.\s/m.test(content);
            if (looksLikeMd && typeof marked !== 'undefined') {
                try {
                    if (marked.setOptions) marked.setOptions({ gfm: true, breaks: true });
                    return { html: marked.parse(content), isMarkdown: true };
                } catch (e) { return { html: $('<div>').text(content).html(), isMarkdown: false }; }
            }
            return { html: $('<div>').text(content).html(), isMarkdown: false };
        }

        async function renderNFeedView(events, mode, fofToFriends) {
            const $chat = $('#chatArea').empty();
            $('#emptyState').addClass('hidden');
            const defaultAvatar = 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1';
            // Batch-load missing profiles before render
            const uniquePubkeys = [...new Set(events.map(e => e.pubkey).filter(Boolean))];
            const missingPubkeys = uniquePubkeys.filter(pk => !profileCache[pk]);
            if (missingPubkeys.length > 0 && allRelays && allRelays.length > 0) {
                try {
                    const pool = getPool();
                    const profileEvents = await pool.list(allRelays.slice(0, 3), [{
                        kinds: [0],
                        authors: missingPubkeys,
                        limit: missingPubkeys.length * 2
                    }]);
                    profileEvents.forEach(ev => {
                        try {
                            const profile = JSON.parse(ev.content);
                            if (profile.picture) profile.picture = normalizeIpfsUrl(profile.picture);
                            if (profile.banner) profile.banner = normalizeIpfsUrl(profile.banner);
                            profileCache[ev.pubkey] = profile;
                        } catch (e) {}
                    });
                } catch (e) {}
            }
            for (const event of events) {
                const profile = profileCache[event.pubkey] || null;
                const avatarUrl = profile?.picture ? normalizeIpfsUrl(profile.picture) : defaultAvatar;
                const name = profile?.display_name || profile?.name || event.pubkey.slice(0, 8);
                const viaFriends = (mode === 'n2' && fofToFriends && fofToFriends[event.pubkey]) ? fofToFriends[event.pubkey] : [];
                $chat.append(renderMessage(event, event.pubkey === publicKey, {
                    authorLabel: name,
                    authorAvatar: avatarUrl,
                    viaFriends: viaFriends,
                    showReplyButton: true
                }));
            }
            // Load via-avatar images asynchronously (optional)
            $chat.find('.via-avatar').each(function() {
                const $img = $(this);
                const pk = $img.attr('data-pubkey');
                if (pk) getProfile(pk).then(function(profile) {
                    if (profile?.picture) $img.attr('src', normalizeIpfsUrl(profile.picture)).attr('title', profile?.display_name || profile?.name || pk.slice(0, 8));
                });
            });
            $chat.find('.via-avatar').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const pk = $(this).attr('data-pubkey');
                if (pk) openProfileViewerModal(pk);
            });
        }

        function setReplyTo(eventId, authorPubkey, authorName) {
            pendingReplyTo = { eventId, authorPubkey, authorName: authorName || authorPubkey.slice(0, 8) };
            $('#replyToName').text(pendingReplyTo.authorName);
            $('#replyToHint').addClass('visible');
            $('#messageInput').focus();
            if (!isConversation) setMode(true);
        }

        function clearReplyTo() {
            pendingReplyTo = null;
            $('#replyToHint').removeClass('visible');
        }

        function updateServiceCounts() {
            const counts = { all: allMessages.length, chat: 0, image: 0, video: 0, music: 0, search: 0, nature: 0, ia: 0 };
            allMessages.forEach(m => {
                const tags = m._tags || extractTags(m.content);
                const isFromSelf = m.pubkey === publicKey;
                if (tags.includes('image')) { if (!isFromSelf) { counts.image++; counts.ia++; } }
                else if (tags.includes('video')) { if (!isFromSelf) { counts.video++; counts.ia++; } }
                else if (tags.includes('music')) { if (!isFromSelf) { counts.music++; counts.ia++; } }
                else if (tags.includes('search')) { if (!isFromSelf) { counts.search++; counts.ia++; } }
                else if (tags.includes('nature')) { if (!isFromSelf) { counts.nature++; counts.ia++; } }
                else counts.chat++;
            });
            
            // Update badge on Flux tab
            $('.svc-tab[data-svc="flux"]').attr('data-count', counts.all || '');
        }

        function filterAndDisplayMessages() {
            if (currentService !== 'all') {
                return; // N, NÂ², Tube: do not update main chat area (they have their own feed)
            }
            const muted = typeof getMutedPubkeys === 'function' ? getMutedPubkeys() : new Set();
            const withoutMuted = muted.size ? allMessages.filter(m => !muted.has(m.pubkey)) : allMessages;
            // Flux mode: filter by fluxTagFilter (all | chat | image | video | music | search | nature)
            if (fluxTagFilter === 'all') {
                filteredMessages = [...withoutMuted];
            } else {
                const tagLower = (fluxTagFilter + '').toLowerCase();
                filteredMessages = withoutMuted.filter(m => {
                    const tags = m._tags || extractTags(m.content);
                    return tags.some(t => (t + '').toLowerCase() === tagLower);
                });
            }
            msgIndex = 0;
            const scrollToTop = (lastRenderedService !== currentService);
            $('.main-content').addClass('flux-mode');
            renderFluxFeed(scrollToTop);
            lastRenderedService = currentService;
            updateFluxTagCloud();
        }

        function updateFluxTagCloud() {
            const $cloud = $('#fluxTagCloud');
            if (!$cloud.length || currentService !== 'all') return;
            const tagCounts = {};
            filteredMessages.forEach(m => {
                const tags = m._tags || extractTags(m.content);
                tags.forEach(t => {
                    const lower = t.toLowerCase();
                    tagCounts[lower] = (tagCounts[lower] || 0) + 1;
                });
            });
            const tags = Object.keys(tagCounts).sort((a, b) => tagCounts[b] - tagCounts[a]);
            const currentFilterLower = (fluxTagFilter + '').toLowerCase();
            let html = '<span class="tag-cloud-label">Tags:</span> <button type="button" class="tag-cloud-pill' + (fluxTagFilter === 'all' ? ' active' : '') + '" data-flux-tag="all">Tous</button>';
            tags.forEach(t => {
                const tagClass = getTagClass(t);
                const safeTag = (t + '').replace(/"/g, '&quot;');
                const isActive = (t + '').toLowerCase() === currentFilterLower;
                html += '<button type="button" class="tag-cloud-pill tag-' + tagClass + (isActive ? ' active' : '') + '" data-flux-tag="' + safeTag + '">#' + $('<div>').text(t).html() + '</button>';
            });
            $cloud.html(html);
            $cloud.find('.tag-cloud-pill').on('click', function() {
                const tag = $(this).data('flux-tag');
                fluxTagFilter = tag;
                filterAndDisplayMessages();
            });
        }

        // Render all messages as vertical infinite scroll feed
        function renderFluxFeed(scrollToTop) {
            const $chat = $('#chatArea');
            const el = $chat[0];
            const wasFlux = (lastRenderedService === 'all');
            const savedScrollTop = (wasFlux && el) ? el.scrollTop : 0;
            const savedScrollHeight = (wasFlux && el) ? el.scrollHeight : 0;

            $chat.empty();
            $('#emptyState').addClass('hidden');

            if (filteredMessages.length === 0) {
                $chat.append($('#emptyState').removeClass('hidden').clone());
                updateNavButtons();
                return;
            }

            // Render all messages vertically (isUser = author is current user)
            filteredMessages.forEach((msg) => {
                const rendered = renderMessage(msg, msg.pubkey === publicKey);
                $chat.append(rendered);
            });

            // Restore scroll: top when switching into flux, else preserve position
            if (scrollToTop !== false) {
                $chat.scrollTop(0);
            } else if (el && savedScrollHeight > 0) {
                const newHeight = el.scrollHeight;
                const maxScroll = Math.max(0, newHeight - el.clientHeight);
                $chat.scrollTop(Math.min(savedScrollTop, maxScroll));
            }
            updateNavButtons();
        }

        function renderCurrentMessage() {
            const $chat = $('#chatArea').empty();
            $('#emptyState').addClass('hidden');

            if (filteredMessages.length === 0) {
                $chat.append($('#emptyState').removeClass('hidden').clone());
                updateNavButtons();
                return;
            }

            // Counter for navigation mode
            $chat.append(`<div class="msg-counter">${msgIndex + 1} / ${filteredMessages.length}</div>`);

            const msg = filteredMessages[msgIndex];
            $chat.append(renderMessage(msg, msg.pubkey === publicKey));
            fetchReplies(msg.id);
            updateNavButtons();
        }

        function renderMessage(event, isUser, opts) {
            opts = opts || {};
            const tags = extractTags(event.content);
            const expiration = getExpiration(event);
            
            // Extract media from content AND from event tags (imeta, url, thumb, etc.)
            const contentMediaUrls = extractMediaUrls(event.content);
            const tagMediaUrls = extractMediaFromTags(event.tags);
            
            // Combine and deduplicate media URLs
            const allMediaUrls = [...new Set([...contentMediaUrls, ...tagMediaUrls])];
            
            // Extract ALL URLs from content (not just media) for cleaning
            const allContentUrls = event.content.match(/(https?:\/\/[^\s<>"]+)/gi) || [];
            
            // Clean content: remove ALL URLs and hashtags
            let text = cleanContentFull(event.content, allContentUrls);
            // Copyable content: displayed text, or raw content when cleaned is empty (e.g. only #tags or URL)
            const copyContent = (text && text.trim()) ? text.trim() : (event.content || '').trim();

            const $msg = $('<div>').addClass('msg').addClass(isUser ? 'user' : 'bot').attr('data-copy-content', copyContent);
            
            const $header = $('<div>').addClass('msg-header');
            if (opts.authorAvatar) {
                const $avatar = $('<img>').addClass('msg-header-avatar').attr('src', opts.authorAvatar).attr('alt', opts.authorLabel || '').on('error', function() { $(this).attr('src', 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1'); });
                if (event.pubkey && !isUser) {
                    const $a = $('<a>').addClass('msg-author-link').attr('href', '#').attr('title', 'Open profile');
                    $a.append($avatar);
                    $a.on('click', function(e) { e.preventDefault(); e.stopPropagation(); openProfileViewerModal(event.pubkey); });
                    $header.append($a);
                } else {
                    $header.append($avatar);
                }
            }
            const authorText = isUser ? 'ðŸ‘¤ Vous' : (opts.authorLabel || 'ðŸ¤– BRO');
            if (event.pubkey && !isUser && opts.authorLabel) {
                const $authorLink = $('<a>').addClass('msg-author-link').attr('href', '#').attr('title', 'Open profile').text(authorText);
                $authorLink.on('click', function(e) { e.preventDefault(); e.stopPropagation(); openProfileViewerModal(event.pubkey); });
                $header.append($authorLink);
            } else {
                $header.append($('<span>').text(authorText));
            }
            if (expiration) $header.append($('<span>').addClass('tag').text(`â±ï¸ ${formatExpiry(expiration)}`));
            // Display all hashtags with appropriate styling
            tags.forEach(t => {
                const tagClass = getTagClass(t);
                $header.append($('<span>').addClass('tag ' + tagClass).text('#' + t));
            });
            // Copy button: insert message content into draft
            const $copyBtn = $('<button type="button" class="msg-copy-btn" title="Copy to draft">ðŸ“‹</button>');
            $copyBtn.on('click', function(e) { e.stopPropagation(); copyMessageToDraft($msg); });
            $header.append($copyBtn);
            // View button: open message in nostr_message_viewer modal (markdown/blog rendering)
            if (event.id) {
                const $viewBtn = $('<button type="button" class="msg-view-btn" title="View in message viewer">ðŸ“„</button>');
                $viewBtn.on('click', function(e) { e.stopPropagation(); openMessageViewerModal(event.id); });
                $header.append($viewBtn);
            }
            // Reply button (N/NÂ² feed)
            if (opts.showReplyButton && event.pubkey) {
                const replyName = opts.authorLabel || event.pubkey.slice(0, 8);
                const $replyBtn = $('<button type="button" class="msg-view-btn n-feed-reply-btn" title="Reply">â†© Reply</button>');
                $replyBtn.on('click', function(e) { e.stopPropagation(); setReplyTo(event.id, event.pubkey, replyName); });
                $header.append($replyBtn);
            }
            // Delete button: show for any message authored by current user (including BRO replies signed with user identity)
            if (event.pubkey === publicKey && event.id) {
                const $delBtn = $('<button type="button" class="msg-delete-btn" title="Delete (kind 5)">ðŸ—‘</button>').attr('data-event-id', event.id);
                $delBtn.on('click', function(e) { e.stopPropagation(); deleteMessage(event.id); });
                $header.append($delBtn);
            }
            $msg.append($header);
            // NÂ² "via" line (friends who follow this author)
            if (opts.viaFriends && opts.viaFriends.length > 0) {
                const defaultAvatar = 'https://ipfs.copylaradio.com/ipfs/QmQRq211EMmQJ7QE44FrVZt8EMF7JJWnayDXHyKzes4pX1';
                const $via = $('<div>').addClass('n-feed-via');
                $via.append($('<span>').addClass('n-feed-via-label').text('via'));
                opts.viaFriends.slice(0, 8).forEach(function(friendPubkey) {
                    const $viaImg = $('<img>').addClass('via-avatar').attr('data-pubkey', friendPubkey).attr('src', defaultAvatar).attr('title', friendPubkey.slice(0, 8));
                    $via.append($viaImg);
                });
                $msg.append($via);
            }

            // Display cleaned text (no URLs in text)
            if (text) {
                $msg.append($('<div>').addClass('msg-content').text(text));
            }

            // Display media from all sources (content + tags)
            const displayedUrls = new Set();
            allMediaUrls.forEach(originalUrl => {
                const normalizedUrl = normalizeIpfsUrl(originalUrl);
                // Avoid duplicates with different formats
                const urlKey = normalizedUrl.replace(/^https?:\/\/[^\/]+/, '');
                if (displayedUrls.has(urlKey)) return;
                displayedUrls.add(urlKey);
                
                const type = detectMediaType(originalUrl);
                if (type) {
                    const $media = $('<div>').addClass('msg-media');
                    if (type === 'image' || type === 'gif') {
                        $media.append($('<img>').attr('src', normalizedUrl).on('click', () => openLightbox(normalizedUrl)));
                    } else if (type === 'video') {
                        $media.append($('<video controls>').attr('src', normalizedUrl));
                    } else if (type === 'audio') {
                        $media.append($('<audio controls>').attr('src', normalizedUrl));
                    } else if (type === 'webpage') {
                        // Webpage preview with iframe (open in modal, not new tab)
                        const safeUrl = normalizedUrl.replace(/&/g, '&amp;').replace(/"/g, '&quot;');
                        $media.addClass('webpage-preview');
                        $media.append(`
                            <div class="webpage-frame">
                                <iframe src="${normalizedUrl}" sandbox="allow-scripts allow-same-origin" loading="lazy"></iframe>
                                <div class="webpage-overlay" data-url="${safeUrl}" title="Open in modal">
                                    <span>ðŸ”— Ouvrir</span>
                                </div>
                            </div>
                            <a href="${normalizedUrl}" class="webpage-link" title="Open in modal">
                                <span>ðŸŒ</span> ${originalUrl.length > 60 ? originalUrl.substring(0, 60) + '...' : originalUrl}
                            </a>
                        `);
                    }
                    $msg.append($media);
                }
            });
            
            // Display non-media links as a separate section
            const nonMediaUrls = allContentUrls.filter(u => !detectMediaType(u));
            if (nonMediaUrls.length > 0) {
                const $links = $('<div>').addClass('msg-links');
                nonMediaUrls.forEach(url => {
                    $links.append($('<a>').attr('href', url).text('ðŸ”— ' + (url.length > 50 ? url.substring(0, 50) + '...' : url)));
                });
                $msg.append($links);
            }

            $msg.append($('<div>').addClass('msg-time').text(new Date(event.created_at * 1000).toLocaleString()));
            return $msg;
        }
        
        // Extract media URLs from event tags (imeta, url, thumb, image, etc.)
        function extractMediaFromTags(tags) {
            if (!tags || !Array.isArray(tags)) return [];
            
            const mediaUrls = [];
            tags.forEach(tag => {
                if (tag.length < 2) return;
                const tagType = tag[0].toLowerCase();
                
                // imeta tags contain media info
                if (tagType === 'imeta') {
                    // Parse imeta format: ["imeta", "url ...", "m ...", "dim ...", "blurhash ...", "thumb ..."]
                    tag.slice(1).forEach(field => {
                        if (field.startsWith('url ')) {
                            mediaUrls.push(field.substring(4).trim());
                        } else if (field.startsWith('thumb ')) {
                            mediaUrls.push(field.substring(6).trim());
                        }
                    });
                }
                // Direct URL tags
                else if (tagType === 'url' || tagType === 'thumb' || tagType === 'image' || tagType === 'video') {
                    mediaUrls.push(tag[1]);
                }
                // r tags often contain URLs
                else if (tagType === 'r' && /^https?:\/\//i.test(tag[1])) {
                    const type = detectMediaType(tag[1]);
                    if (type) mediaUrls.push(tag[1]);
                }
            });
            
            return mediaUrls;
        }
        
        // Clean content: remove ALL URLs and ALL hashtags (hashtags displayed in header)
        function cleanContentFull(content, allUrls) {
            let text = content;
            
            // Remove all provided URLs
            allUrls.forEach(u => { 
                const escaped = u.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                text = text.replace(new RegExp(escaped, 'gi'), '');
            });
            
            // Remove IPFS paths
            text = text.replace(/(\/ipfs\/[^\s<>"]+|\/ipns\/[^\s<>"]+)/gi, '');
            
            // Remove ALL hashtags (they are displayed in the header)
            text = text.replace(/#[a-zA-Z0-9_Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§]+\s*/gi, '');
            
            // Clean up trailing emojis (like ðŸŽ¥ ðŸ”—)
            text = text.replace(/[ðŸŽ¥ðŸ”—ðŸ“¸ðŸŽµðŸŽ¬ðŸ–¼ï¸]+\s*$/g, '');
            
            // Collapse multiple spaces per line but preserve newlines (for pre-line display)
            return text.split(/\n/).map(function(line) { return line.replace(/\s+/g, ' ').trim(); }).join('\n').trim();
        }

        async function fetchReplies(eventId) {
            const p = getPool();
            try {
                const replies = await p.list(allRelays, [{ kinds: [1], '#e': [eventId], limit: 10 }]);
                replies.sort((a, b) => a.created_at - b.created_at);
                replies.forEach(r => $('#chatArea').append(renderMessage(r, r.pubkey === publicKey)));
                $('#chatArea').scrollTop($('#chatArea')[0].scrollHeight);
                if (replies.length === 0) {
                    setTimeout(() => {
                        if (filteredMessages[msgIndex]?.id === eventId) fetchReplies(eventId);
                    }, 5000);
                }
            } catch (e) { log(`Replies error: ${e.message}`); }
        }

        function navigate(delta) {
            const newIdx = msgIndex + delta;
            if (newIdx >= 0 && newIdx < filteredMessages.length) {
                msgIndex = newIdx;
                renderCurrentMessage();
            }
        }

        function updateNavButtons() {
            $('#btnPrev').prop('disabled', msgIndex <= 0);
            $('#btnNext').prop('disabled', msgIndex >= filteredMessages.length - 1);
        }

        // === SEND ===
        async function sendMessage() {
            if (!publicKey) return;
            const text = $('#messageInput').val().trim();
            if (!text && !selectedImage) return;
            
            // I2V mode requires an image
            if (currentInputService === 'video' && videoMode === 'i2v' && !selectedImage) {
                showNotification('Le mode I2V (Image-to-Video) nÃ©cessite une image. Utilisez les boutons ðŸ“ Fichier ou ðŸ“¸ Photo pour en ajouter une.', 'warning', 'Image requise');
                return;
            }

            showLoading(true, 'Envoi...');
            try {
                let content = buildContent(text);
                let tags = [['application', 'UPlanet']];

                if (locationEnabled && currentLat !== null) {
                    tags.push(['latitude', currentLat.toFixed(2)], ['longitude', currentLon.toFixed(2)]);
                    tags.push(['g', `${currentLat.toFixed(6)};${currentLon.toFixed(6)}`]);
                }

                if (isConversation) {
                    tags.push(['expiration', (Math.floor(Date.now() / 1000) + 10).toString()]);
                }

                if (pendingReplyTo) {
                    const relay = (allRelays && allRelays[0]) ? allRelays[0] : '';
                    tags.push(['e', pendingReplyTo.eventId, relay, 'reply']);
                    tags.push(['p', pendingReplyTo.authorPubkey]);
                }

                if (selectedImage) {
                    showLoading(true, 'Upload image...');
                    try {
                        const result = await uploadNip96(selectedImage);
                        if (result.url) {
                            // Normalize URL to use correct IPFS gateway (myIPFS)
                            const normalizedUrl = normalizeIpfsUrl(result.url);
                            content += '\n' + normalizedUrl;
                            if (result.tags) tags = tags.concat(result.tags);
                            log(`âœ… Image uploaded: ${normalizedUrl.substring(0, 50)}...`);
                        }
                    } catch (e) { 
                        log(`âŒ Upload error: ${e.message}`);
                        showNotification(`Erreur upload: ${e.message}`, 'warning');
                        // Continue without image
                    }
                }

                const event = {
                    kind: 1,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags,
                    content
                };

                showLoading(true, 'Signature...');
                const signed = await window.nostr.signEvent(event);

                showLoading(true, 'Publication...');
                let success = 0;
                await Promise.all(allRelays.map(async r => { if (await publishToRelay(r, signed)) success++; }));

                if (success > 0) {
                    log(`Published to ${success} relays`);
                    $('#messageInput').val('').css('height', 'auto');
                    clearImage();
                    clearReplyTo();
                    if (currentService === 'n' || currentService === 'n2') {
                        setTimeout(() => fetchNFeed(currentService), 2000);
                    } else {
                        setTimeout(fetchMessages, 3000);
                    }
                }
            } catch (e) {
                log(`Send error: ${e.message}`);
            } finally {
                showLoading(false);
            }
        }

        // Delete message: publish kind 5 (NIP-09)
        async function deleteMessage(eventId) {
            if (!publicKey || !eventId) return;
            showLoading(true, 'Deleting...');
            try {
                const event = {
                    kind: 5,
                    pubkey: publicKey,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [['e', eventId]],
                    content: ''
                };
                const signed = await window.nostr.signEvent(event);
                let success = 0;
                await Promise.all(allRelays.map(async r => { if (await publishToRelay(r, signed)) success++; }));
                if (success > 0) {
                    log(`Deleted (kind 5) on ${success} relays`);
                    showNotification('Deletion published (kind 5)', 'info');
                    setTimeout(fetchMessages, 1500);
                } else {
                    showNotification('Failed to publish deletion', 'error');
                }
            } catch (e) {
                log(`Delete error: ${e.message}`);
                showNotification('Delete error: ' + e.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function copyMessageToDraft($msg) {
            const content = ($msg && $msg.length) ? ($msg.attr('data-copy-content') || '').trim() : '';
            if (!content) {
                showNotification('Nothing to copy', 'info');
                return;
            }
            const $input = $('#messageInput');
            const current = $input.val().trim();
            $input.val(current ? current + '\n\n' + content : content);
            $input[0].style.height = 'auto';
            $input[0].style.height = Math.min($input[0].scrollHeight, 150) + 'px';
            $input.focus();
            showNotification('Copied to draft', 'info');
        }

        function buildContent(text) {
            let prefix = '#BRO ';
            const svc = currentInputService;
            if (svc === 'image') prefix += '#image ';
            else if (svc === 'video') prefix += '#video ';
            else if (svc === 'music') prefix += '#music ';
            else if (svc === 'search') prefix += '#search ';
            else if (svc === 'nature') prefix += '#plantnet ';
            return prefix + text;
        }

        // === UI ===
        function updateInputHint(svc) {
            let hint = '';
            if (svc === 'video') {
                const tier = getTierFromDid(userDid);
                if (videoMode === 'i2v') {
                    if (tier === 'constellation') {
                        hint = 'ðŸŒŸ I2V: Joignez une image + dÃ©crivez l\'animation souhaitÃ©e';
                    } else if (tier === 'satellite') {
                        hint = 'ðŸ”’ I2V rÃ©servÃ© Constellation - Utilisez T2V avec votre abonnement Satellite';
            } else {
                        hint = 'ðŸ”’ RÃ©servÃ© aux sociÃ©taires Constellation';
                    }
                } else {
                    if (tier !== 'visitor') {
                        hint = 'â­ T2V: DÃ©crivez la scÃ¨ne vidÃ©o Ã  gÃ©nÃ©rer';
                    } else {
                        hint = 'ðŸ”’ RÃ©servÃ© aux sociÃ©taires - Devenez membre pour gÃ©nÃ©rer des vidÃ©os';
                    }
                }
            } else {
                const hints = {
                    chat: 'ðŸ’¬ Ask your IA â€¢ #url links â€¢ #status #whoami',
                    image: 'ðŸ–¼ï¸ DÃ©crivez l\'image Ã  gÃ©nÃ©rer',
                    music: 'ðŸŽµ Style: "jazz piano 80bpm"',
                    search: 'ðŸ” Recherche web',
                    nature: 'ðŸŒ¿ Joignez une photo Ã  identifier'
                };
                hint = hints[svc] || hints.chat;
            }
            $('#serviceHint').text(hint);
            // Show BRO commands help only in chat/conversation mode
            $('#broCommandsHelp').toggle(svc === 'chat' || !svc);
        }

        function setMode(conversation) {
            isConversation = conversation;
            $('#btnConversation').toggleClass('active', conversation);
            $('#btnPublic').toggleClass('active warn', !conversation);
        }

        // Open webcam upload page
        function openWebcamUpload() {
            if (!publicKey) {
                log('Please connect to NOSTR first');
                showNotification('Connectez-vous d\'abord Ã  NOSTR pour ajouter une vidÃ©o', 'connect');
                return;
            }
            window.open('/webcam', '_blank');
        }

        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => {
                    selectedImage = ev.target.result;
                    $('#imgPreview').attr('src', selectedImage);
                    $('#imgPreviewWrap').addClass('visible');
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            selectedImage = null;
            $('#imgPreview').attr('src', '#');
            $('#imgPreviewWrap').removeClass('visible');
            $('#imgInput').val('');
            $('#i2vImgInput').val('');
            updateI2vStatus();
        }
        
        // I2V Image handling
        function handleI2vImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => {
                    selectedImage = ev.target.result;
                    $('#imgPreview').attr('src', selectedImage);
                    $('#imgPreviewWrap').addClass('visible');
                    updateI2vStatus();
                    log(`I2V: Image selected (${(file.size / 1024).toFixed(1)} KB)`);
                };
                reader.readAsDataURL(file);
            }
        }
        
        function updateI2vStatus() {
            const $status = $('#i2vStatus');
            const $btns = $('.i2v-btn');
            
            if (selectedImage) {
                $status.text('âœ… Image prÃªte').addClass('ok');
                $btns.addClass('has-image');
            } else {
                $status.text('âš ï¸ Image requise').removeClass('ok');
                $btns.removeClass('has-image');
            }
        }
        
        // Camera capture for I2V
        async function openI2vCamera() {
            // Create camera modal
            const $modal = $(`
                <div class="camera-modal" style="
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(0,0,0,0.95); z-index: 1100;
                    display: flex; flex-direction: column; align-items: center; justify-content: center;
                ">
                    <video id="cameraPreview" autoplay playsinline style="
                        max-width: 90%; max-height: 60vh; border-radius: 8px;
                        border: 2px solid var(--accent-cyan);
                    "></video>
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                        <button id="btnCapture" style="
                            padding: 12px 24px; background: var(--accent-cyan);
                            border: none; border-radius: 8px; color: var(--bg-void);
                            font-size: 1rem; cursor: pointer; font-family: inherit;
                        ">ðŸ“¸ Capturer</button>
                        <button id="btnCancelCamera" style="
                            padding: 12px 24px; background: var(--bg-hover);
                            border: 1px solid var(--border); border-radius: 8px;
                            color: var(--text-primary); font-size: 1rem; cursor: pointer; font-family: inherit;
                        ">âŒ Annuler</button>
                    </div>
                    <canvas id="captureCanvas" style="display: none;"></canvas>
                </div>
            `);
            
            $('body').append($modal);
            
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('captureCanvas');
            let stream = null;
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
                log('I2V: Camera opened');
            } catch (err) {
                log(`I2V Camera error: ${err.message}`);
                showNotification('Impossible d\'accÃ©der Ã  la camÃ©ra: ' + err.message, 'error');
                $modal.remove();
                return;
            }
            
            // Capture button
            $('#btnCapture').on('click', () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                selectedImage = canvas.toDataURL('image/jpeg', 0.85);
                $('#imgPreview').attr('src', selectedImage);
                $('#imgPreviewWrap').addClass('visible');
                updateI2vStatus();
                log('I2V: Photo captured');
                
                // Cleanup
                stream.getTracks().forEach(track => track.stop());
                $modal.remove();
            });
            
            // Cancel button
            $('#btnCancelCamera').on('click', () => {
                stream.getTracks().forEach(track => track.stop());
                $modal.remove();
                log('I2V: Camera cancelled');
            });
        }

        function showLoading(show, text) {
            $('#loadingBar').toggleClass('visible', show);
            $('#loadingText').text(text || '');
            $('#btnSend').prop('disabled', show || !publicKey);
        }

        function openLightbox(src) {
            $('#lightboxImg').attr('src', src);
            $('#lightbox').addClass('active');
        }

        function closeLightbox() { $('#lightbox').removeClass('active'); }

        // === LOCATION ===
        function getLocation() {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(
                pos => {
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    $('#latInput').val(currentLat.toFixed(2));
                    $('#lonInput').val(currentLon.toFixed(2));
                    $('#btnLocation').addClass('active');
                    log(`Location: ${currentLat.toFixed(2)}, ${currentLon.toFixed(2)}`);
                },
                () => { locationEnabled = false; $('#btnLocation').removeClass('active'); },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function initMiniMap() {
            const lat = currentLat || 0, lon = currentLon || 0;
            $('#mapContainer').show();
            miniMap = L.map('mini-map').setView([lat, lon], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
            miniMap.marker = L.marker([lat, lon], { draggable: true }).addTo(miniMap);
            miniMap.marker.on('dragend', e => {
                const p = e.target.getLatLng();
                currentLat = p.lat; currentLon = p.lng;
                $('#latInput').val(currentLat.toFixed(2));
                $('#lonInput').val(currentLon.toFixed(2));
            });
        }

        // === UTILS ===
        function getPool() {
            if (!pool) pool = new NostrTools.SimplePool({ getTimeout: 6000, listTimeout: 6000 });
            return pool;
        }

        function detectMediaType(url) {
            const l = url.toLowerCase();
            
            // Check file extensions first (works for any URL)
            if (/\.(jpg|jpeg|png|webp|avif)(\?|#|$)/i.test(l)) return 'image';
            if (/\.gif(\?|#|$)/i.test(l)) return 'gif';
            if (/\.(mp4|webm|mov)(\?|#|$)/i.test(l)) return 'video';
            if (/\.(mp3|wav|ogg|m4a)(\?|#|$)/i.test(l)) return 'audio';
            if (/\.(html|htm|pdf)(\?|#|$)/i.test(l)) return 'webpage';
            
            // Check for IPFS/IPNS URLs (gateway URLs or relative paths)
            if (/ipfs\.|\/ipfs\/|\/ipns\//i.test(l)) {
                // Check patterns in filename/path
                if (/video_|_video|\.mp4|\.webm|\.mov/i.test(l)) return 'video';
                if (/audio_|_audio|music_|_music|\.mp3|\.wav|\.ogg/i.test(l)) return 'audio';
                if (/\.gif/i.test(l)) return 'gif';
                if (/image_|_image|photo_|_photo|\.(jpg|jpeg|png|webp|avif)/i.test(l)) return 'image';
                
                // IPFS URL ending with a CID (no file extension) = webpage/document
                // CIDv0: Qm followed by 44 base58 chars (total 46)
                // CIDv1: bafy/bafk followed by base32 chars
                if (/\/(Qm[1-9A-HJ-NP-Za-km-z]{44,46}|baf[yk][a-zA-Z2-7]{50,})\/?$/i.test(l)) {
                    return 'webpage';
                }
                
                // IPFS URL ending with path without extension (likely a directory/document)
                if (/\/ipfs\/[^\/]+\/?$/i.test(l) || /\/ipns\/[^\/]+\/?$/i.test(l)) {
                    return 'webpage';
                }
                
                // Fallback: if it's an IPFS URL without clear type, treat as webpage
                return 'webpage';
            }
            
            return null;
        }

        function extractTags(content) {
            // Extract ALL hashtags from content
            const hashtagMatches = content.match(/#[a-zA-Z0-9_Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§]+/gi) || [];
            // Return unique tags (lowercase for deduplication, keep original case for display)
            const seen = new Set();
            return hashtagMatches.map(t => t.substring(1)) // Remove # prefix
                .filter(t => {
                    const lower = t.toLowerCase();
                    if (seen.has(lower)) return false;
                    seen.add(lower);
                    return true;
                });
        }
        
        // Get special tag class for known service tags
        function getTagClass(tag) {
            const lower = tag.toLowerCase();
            if (['image', 'photo', 'img'].includes(lower)) return 'image';
            if (['video', 'film', 'movie'].includes(lower)) return 'video';
            if (['music', 'audio', 'sound', 'musique'].includes(lower)) return 'music';
            if (['search', 'recherche'].includes(lower)) return 'search';
            if (['plantnet', 'inventory', 'nature', 'plant'].includes(lower)) return 'nature';
            return 'generic';
        }

        function extractMediaUrls(content) {
            // Extract full URLs (http/https)
            const httpUrls = content.match(/(https?:\/\/[^\s<>"]+)/gi) || [];
            
            // Extract relative IPFS paths (/ipfs/Qm... or /ipns/...)
            const ipfsPaths = content.match(/(\/ipfs\/[^\s<>"]+|\/ipns\/[^\s<>"]+)/gi) || [];
            
            // Return original URLs (not normalized) for proper matching in cleanContent
            // We'll normalize them only when displaying
            return [...httpUrls, ...ipfsPaths]
                .filter(u => detectMediaType(u)); // Keep only media types (including 'webpage')
        }
        
        // Build the correct URL for IPFS webpages
        function buildWebpageUrl(url) {
            // If URL already ends with .html or .htm, use as-is
            if (/\.(html|htm)(\?|$)/i.test(url)) {
                return url;
            }
            // Add trailing slash if needed
            const baseUrl = url.endsWith('/') ? url : url + '/';
            return baseUrl;
        }

        function cleanContent(content, mediaUrls) {
            let text = content;
            
            // Remove ALL occurrences of media URLs (original form) from display
            mediaUrls.forEach(u => { 
                // Escape special regex characters in URL
                const escaped = u.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                text = text.replace(new RegExp(escaped, 'gi'), '');
            });
            
            // Remove any remaining IPFS paths that might have different formats
            text = text.replace(/(\/ipfs\/[^\s<>"]+|\/ipns\/[^\s<>"]+)/gi, '');
            
            // Remove any remaining media file URLs (various extensions)
            text = text.replace(/(https?:\/\/[^\s<>"]+\.(mp4|webm|mov|mp3|wav|ogg|m4a|jpg|jpeg|png|gif|webp|avif|html|htm)([^\s<>"]*)?)/gi, '');
            
            // Remove IPFS gateway URLs that weren't caught
            text = text.replace(/(https?:\/\/ipfs[^\s<>"]+)/gi, '');
            
            // Remove hashtags
            text = text.replace(/#(BRO|BOT|image|video|music|search|plantnet|inventory|mem|reset)\s*/gi, '');
            
            // Clean up multiple spaces and trim
            return text.replace(/\s+/g, ' ').trim();
        }

        function linkify(text) {
            return text.replace(/(https?:\/\/[^\s<>"]+)/gi, '<a href="$1">$1</a>');
        }

        function getExpiration(event) {
            const t = event.tags?.find(t => t[0] === 'expiration');
            return t ? parseInt(t[1], 10) : null;
        }

        function formatExpiry(ts) {
            const rem = ts - Math.floor(Date.now() / 1000);
            if (rem <= 0) return 'ExpirÃ©';
            const m = Math.floor(rem / 60);
            return m < 60 ? `${m}min` : `${Math.floor(m/60)}h`;
        }

        async function uploadNip96(dataUrl) {
            // Convert dataUrl to File
            const b64 = dataUrl.split(',')[1];
            const mime = dataUrl.split(',')[0].split(':')[1].split(';')[0];
            const bin = atob(b64);
            const arr = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
            const file = new File([new Blob([arr], { type: mime })], `img-${Date.now()}.png`, { type: mime });
            
            // Use uploadPhotoToIPFS from common.js if available (handles auth + correct URL)
            if (typeof uploadPhotoToIPFS === 'function') {
                log('Using common.js uploadPhotoToIPFS...');
                const result = await uploadPhotoToIPFS(file);
                if (result.success && result.url) {
                    // Build tags from result metadata
                    const tags = [];
                    if (result.cid) tags.push(['x', result.cid]);
                    if (result.fileName) tags.push(['filename', result.fileName]);
                    if (result.thumbnail_ipfs) tags.push(['thumb', `${getIpfsGateway()}/ipfs/${result.thumbnail_ipfs}`]);
                    if (result.gifanim_ipfs) tags.push(['gifanim', `${getIpfsGateway()}/ipfs/${result.gifanim_ipfs}`]);
                    return { 
                        url: result.url, 
                        tags: tags 
                    };
                }
                throw new Error(result.error || 'Upload failed - no URL returned');
            }
            
            // Fallback to NIP-96 with HTTPS fix
            log('Fallback to NIP-96 upload...');
            const res = await fetch('/.well-known/nostr/nip96.json');
            const cfg = await res.json();
            
            // Fix mixed content: ensure api_url uses same protocol as page
            let apiUrl = cfg.api_url;
            if (location.protocol === 'https:' && apiUrl.startsWith('http://')) {
                apiUrl = apiUrl.replace('http://', 'https://');
                log(`Fixed mixed content: ${apiUrl}`);
            }
            
            const fd = new FormData();
            fd.append('file', file);
            
            // Add npub for authenticated upload
            if (STATE.pubkey) {
                fd.append('npub', STATE.pubkey);
            }
            
            const r = await fetch(apiUrl, { method: 'POST', body: fd });
            const data = await r.json();
            if (data.status === 'success' && data.nip94_event?.tags) {
                let url = data.nip94_event.tags.find(t => t[0] === 'url')?.[1];
                // Fix download URL protocol too
                let downloadUrl = cfg.download_url;
                if (location.protocol === 'https:' && downloadUrl?.startsWith('http://')) {
                    downloadUrl = downloadUrl.replace('http://', 'https://');
                }
                if (url?.startsWith('/ipfs/') && downloadUrl) {
                    url = downloadUrl.replace(/\/$/, '') + url;
                }
                return { url, tags: data.nip94_event.tags.filter(t => t[0] !== 'url') };
            }
            throw new Error('Upload failed');
        }

        async function publishToRelay(url, event) {
            return new Promise(resolve => {
                try {
                    const ws = new WebSocket(url);
                    const timeout = setTimeout(() => { ws.close(); resolve(false); }, 5000);
                    ws.onopen = () => ws.send(JSON.stringify(['EVENT', event]));
                    ws.onmessage = e => {
                        try {
                            const m = JSON.parse(e.data);
                            if (m[0] === 'OK' && m[1] === event.id) { clearTimeout(timeout); ws.close(); resolve(true); }
                        } catch {}
                    };
                    ws.onerror = () => { clearTimeout(timeout); resolve(false); };
                } catch { resolve(false); }
            });
        }
    </script>

    <!-- NOTIFICATION MODAL (Bootstrap) -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content" style="background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px;">
                <div class="modal-header" style="border-bottom: 1px solid var(--border); padding: 12px 16px;">
                    <h6 class="modal-title" id="notificationModalLabel" style="color: var(--accent-cyan); font-family: 'Orbitron', sans-serif; font-size: 0.85rem;">
                        <span id="notificationIcon">â„¹ï¸</span> <span id="notificationTitle">Notification</span>
                    </h6>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="font-size: 0.7rem;"></button>
                </div>
                <div class="modal-body" style="padding: 16px; color: var(--text-primary); font-size: 0.8rem;">
                    <p id="notificationMessage" style="margin: 0;"></p>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border); padding: 10px 16px;">
                    <button type="button" class="btn btn-sm" data-bs-dismiss="modal" 
                            style="background: var(--accent-cyan); color: var(--bg-void); border: none; border-radius: 6px; font-size: 0.75rem; padding: 6px 16px;">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
