<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé• Webcam Recorder with NOSTR Publishing</title>
    
    <!-- Nostr integration -->
    <script src="{{ myIPFS }}/ipfs/QmXEmaPRUaGcvhuyeG99mHHNyP43nn8GtNeuDok8jdpG4a/nostr.bundle.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="{{ myIPFS }}/ipns/copylaradio.com/leaflet.css"/>
    <!-- Leaflet JavaScript -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/leaflet.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e8e8e8;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        /* Compact Header */
        .header {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            color: #4ade80;
            margin: 0;
            font-size: 1.2em;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
            flex: 1;
            min-width: 150px;
        }
        
        /* Compact NOSTR Auth in Header */
        .nostr-header {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .nostr-header .auth-status {
            font-size: 0.8em;
            color: #94a3b8;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }
        
        .nostr-header button {
            padding: 6px 12px;
            font-size: 0.8em;
            margin: 0;
            border-radius: 6px;
        }
        
        /* Main Container - Centered */
        .main-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 0 15px;
            min-height: calc(100vh - 80px);
        }
        
        /* Webcam Section - Centered */
        .webcam-section {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 100%;
        }
        
        .webcam-title {
            color: #4ade80;
            font-size: 1.5em;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        #video-preview {
            width: 100%;
            max-width: 100%;
            height: auto;
            max-height: 50vh;
            border: 3px solid #4ade80;
            border-radius: 15px;
            margin: 15px auto;
            box-shadow: 0 0 20px rgba(74, 222, 128, 0.3);
            background: #000;
            object-fit: contain;
        }
        
        #timer {
            font-size: 3em;
            margin: 15px 0;
            color: #4ade80;
            text-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
            font-weight: bold;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            width: 100%;
        }
        
        .duration-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        input[type="range"] {
            width: 100%;
            max-width: 250px;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ade80;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }
        
        #duration-display {
            font-size: 1em;
            color: #4ade80;
            font-weight: 600;
            min-width: 100px;
            text-align: center;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
            max-width: 300px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #4f46e5, #4338ca);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        button:disabled {
            background: rgba(148, 163, 184, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .hidden {
            display: none;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            max-width: 800px;
            width: calc(100% - 20px);
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header h2 {
            color: #4ade80;
            margin: 0;
            font-size: 1.8em;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ef4444;
        }
        
        .modal-video-preview {
            width: 100%;
            max-width: 100%;
            max-height: 40vh;
            border-radius: 15px;
            margin: 15px auto;
            display: block;
            object-fit: contain;
            background: #000;
        }
        
        .form-group {
            margin: 15px 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.9em;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            color: #e2e8e8;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4ade80;
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
        }
        
        .location-section {
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.2);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
        }
        
        .location-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 12px;
            justify-content: center;
        }
        
        .coord-input {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 120px;
        }
        
        .coord-input label {
            font-weight: bold;
            color: #e2e8f0;
            margin: 0;
            min-width: 30px;
            font-size: 0.85em;
        }
        
        .coord-input input {
            flex: 1;
            min-width: 70px;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 0.85em;
        }
        
        .modal-map {
            height: 250px;
            width: 100%;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 12px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }
        
        .modal-actions button {
            flex: 1;
            min-width: 120px;
            max-width: 200px;
        }
        
        /* Expanded NOSTR Section (when clicking expand) */
        .nostr-section {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 300px;
            z-index: 200;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .nostr-section.expanded {
            display: block;
        }
        
        .auth-mode {
            margin: 10px 0;
        }
        
        .kind-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .kind-option {
            display: flex;
            align-items: center;
                gap: 5px;
            }
            
        .kind-option input[type="radio"] {
            width: auto;
            margin: 0;
        }
        
        .nsec-input {
            display: none;
            margin-top: 10px;
        }
        
        .nsec-input.visible {
            display: block;
        }
        
        /* Responsive */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .header {
                padding: 10px 15px;
                gap: 8px;
            }
            
            .header h1 {
                font-size: 1em;
            }
            
            .nostr-header {
                width: 100%;
                justify-content: flex-end;
            }
            
            .nostr-header .auth-status {
                font-size: 0.7em;
                padding: 3px 6px;
            }
            
            .nostr-header button {
                padding: 5px 10px;
                font-size: 0.7em;
            }
            
            .main-container {
                margin: 10px auto;
                padding: 0 10px;
            }
            
            .webcam-section {
                padding: 15px;
                border-radius: 15px;
            }
            
            .webcam-title {
                font-size: 1.2em;
                margin-bottom: 15px;
            }
            
            #video-preview {
                border-radius: 10px;
                margin: 10px auto;
                max-height: 40vh;
            }
            
            #timer {
                font-size: 2.5em;
                margin: 10px 0;
            }
            
            .controls {
                gap: 10px;
                margin: 15px 0;
            }
            
            .duration-control {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            
            .duration-control label {
                font-size: 0.9em;
            }
            
            input[type="range"] {
                max-width: 100%;
            }
            
            #duration-display {
                font-size: 0.9em;
            }
            
            button {
                padding: 10px 20px;
                font-size: 13px;
                max-width: 100%;
            }
            
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                padding: 15px;
                width: calc(100% - 10px);
                border-radius: 15px;
                max-height: 98vh;
            }
            
            .modal-header h2 {
                font-size: 1.3em;
            }
            
            .modal-video-preview {
                margin: 10px auto;
                max-height: 30vh;
                border-radius: 10px;
            }
            
            .location-section {
                padding: 12px;
            }
            
            .location-section label {
                font-size: 0.85em;
            }
            
            .location-controls {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            
            .coord-input {
                width: 100%;
                min-width: 100%;
            }
            
            .coord-input input {
                min-width: 0;
            }
            
            .location-controls button {
                width: 100%;
                max-width: 100%;
                padding: 10px 16px;
                font-size: 0.85em;
            }
            
            .modal-map {
                height: 200px;
            }
            
            .modal-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-actions button {
                width: 100%;
                max-width: 100%;
            }
            
            /* Expanded NOSTR Section - mobile */
            .nostr-section {
                min-width: calc(100vw - 40px);
                right: auto;
                left: 10px;
            }
            
            /* Video upload section - mobile */
            .controls > div {
                width: 100%;
            }
            
            .controls input[type="file"] {
                font-size: 0.85em;
                padding: 10px;
            }
        }
        
        /* Tablet adjustments */
        @media screen and (min-width: 769px) and (max-width: 1024px) {
            .main-container {
                max-width: 700px;
            }
            
            .webcam-section {
                padding: 25px;
            }
            
            .webcam-title {
                font-size: 1.6em;
            }
            
            #timer {
                font-size: 3.5em;
            }
        }
        
        /* Desktop large screens */
        @media screen and (min-width: 1025px) {
            .main-container {
                margin: 30px auto;
            }
            
            .webcam-section {
                padding: 30px;
            }
            
            #video-preview {
                max-height: 60vh;
            }
            
            .modal-video-preview {
                max-height: 50vh;
            }
            
            .modal-map {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <!-- Compact Header with NOSTR Auth -->
    <div class="header">
        <h1>üé• Webcam Recorder</h1>
        <div class="nostr-header" style="position: relative;">
            <div class="auth-status" id="header-auth-status">Not connected</div>
            <button id="header-connect-btn" class="btn-primary" onclick="toggleNostrExpanded()" style="padding: 6px 12px; font-size: 0.8em;">üîå Connect</button>
            <button id="header-profile-btn" onclick="openNostrProfile()" class="btn-secondary" style="display: none; padding: 6px 12px; font-size: 0.8em;">üë§ Profile</button>
            
            <!-- Expanded NOSTR Section -->
            <div class="nostr-section" id="nostr-expanded">
                <h3 style="margin: 0 0 10px 0; font-size: 1em;">üîê NOSTR Authentication</h3>
                
            <div class="auth-mode">
                    <label style="font-size: 0.9em;">Method:</label>
                <div class="kind-options">
                    <div class="kind-option">
                        <input type="radio" id="auth-extension" name="auth-mode" value="extension" checked>
                            <label for="auth-extension" style="font-size: 0.85em; margin: 0;">Extension</label>
                    </div>
                    <div class="kind-option">
                        <input type="radio" id="auth-nsec" name="auth-mode" value="nsec">
                            <label for="auth-nsec" style="font-size: 0.85em; margin: 0;">nsec</label>
                    </div>
                </div>
                
                <div id="nsec-input-container" class="nsec-input">
                        <input type="password" id="nsec-key" placeholder="nsec1..." style="margin-top: 8px; font-size: 0.85em; padding: 8px;">
                        <small style="color: #94a3b8; font-size: 0.75em;">‚ö†Ô∏è Never share your private key!</small>
                </div>
            </div>
            
                <button id="nostr-connect-btn" onclick="handleNostrConnect()" style="width: 100%; padding: 8px; font-size: 0.9em; margin-top: 10px;">Connect to NOSTR</button>
                <div id="auth-status" style="margin-top: 10px; font-size: 0.8em;"></div>
            </div>
        </div>
        </div>
        
    <!-- Main Container - Centered -->
    <div class="main-container">
        <!-- Webcam Recording Section -->
        <div class="webcam-section" id="webcam-section" style="display: none;">
            <h2 class="webcam-title">üé• Record Video</h2>

    <video id="video-preview" autoplay muted></video>

    <div id="timer" class="hidden">16</div>

            <div class="controls">
                <!-- Video Upload Option -->
                <div style="margin-bottom: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 10px; border: 1px solid rgba(99, 102, 241, 0.2);">
                    <label for="video-upload" style="display: block; margin-bottom: 10px; color: #e2e8f0; font-weight: 600;">
                        üìÅ Upload Video File (.mp4, .webm, .mov)
                    </label>
                    <input type="file" id="video-upload" accept="video/*,.mp4,.webm,.mov" 
                           style="width: 100%; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: #e2e8f0; cursor: pointer;">
                    <small style="color: #94a3b8; font-size: 0.85em; display: block; margin-top: 5px;">
                        Supported formats: MP4, WebM, MOV
                    </small>
                </div>
                
                <div style="text-align: center; margin: 20px 0; color: #94a3b8; font-size: 0.9em;">‚Äî OR ‚Äî</div>
                
                <!-- Recording Option -->
                <div class="duration-control">
                    <label for="duration-slider" style="color: #e2e8f0;">Duration:</label>
                    <input type="range" id="duration-slider" min="3" max="60" value="16">
                    <div id="duration-display">16 seconds</div>
                </div>
                
                <input type="hidden" id="player" name="player" value="">
                
                <button id="start-recording" class="btn-primary">üé¨ Start Recording</button>
                <button id="stop-recording" class="btn-danger hidden">‚èπÔ∏è Stop Recording</button>
            </div>
        </div>
                </div>
                
    <!-- Modal for Video Preview and Publishing -->
    <div id="video-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìπ Video Preview & Publish</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
                    </div>
            
            <video id="modal-video-preview" class="modal-video-preview" controls></video>
            
            <form id="publish-form">
                <div class="form-group">
                    <label for="video-title">Title:</label>
                    <input type="text" id="video-title" name="title" 
                           placeholder="Enter video title..." required>
                </div>
                
                <div class="form-group">
                    <label for="video-description">Description (optional):</label>
                    <textarea id="video-description" name="description" 
                              placeholder="Describe your video..." rows="3"></textarea>
                </div>
                
                <div class="location-section">
                    <label style="display: block; margin-bottom: 10px; color: #4ade80;">
                        üìç Geographic Location (for UMAP anchoring)
                    </label>
                    <div class="location-controls">
                            <div class="coord-input">
                                <label>Lat:</label>
                            <input type="number" id="modal-lat" step="0.01" min="-90" max="90" value="0.00">
                            </div>
                            <div class="coord-input">
                                <label>Lon:</label>
                            <input type="number" id="modal-lon" step="0.01" min="-180" max="180" value="0.00">
                            </div>
                        <button type="button" class="btn-secondary" onclick="getCurrentLocationForModal()" style="padding: 8px 16px; font-size: 0.9em;">üìç My Location</button>
                        </div>
                    <div id="modal-map" class="modal-map"></div>
                        </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="publish-nostr" name="publish_nostr" checked>
                        Publish to UPlanet (geolocalized <a href="/youtube" target="_blank" style="color:#4ade80;text-decoration:underline;">/youtube</a>)
                    </label>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-primary" id="publish-btn">
                        üì° Publish Video
                    </button>
                </div>
            </form>
            </div>
        </div>
        
    <!-- Hidden Container for old code compatibility -->
        <div id="webcam-container"></div>

    <!-- Common.js with enhanced webcam functions -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/common.js"></script>
    
    <script>
        // Global variables (non-conflicting with common.js)
        let mediaRecorder;
        let recordedChunks = [];
        let currentStream = null;
        let authMode = 'extension';
        let userEmail = null;
        // userPubkey and userPrivkey are declared in common.js
        
        // Mobile detection
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        let isAndroid = /Android/.test(navigator.userAgent);
        
        // Location and map variables
        let currentLocation = null;
        let miniMap = null;
        let miniMarker = null;
        let modalMap = null;
        let modalMarker = null;
        let userHasInteractedWithMap = false;
        
        // Auto-connect nsec (injected by upassport.sh when scanning SSSS with code 1111)
        const AUTO_CONNECT_NSEC = null;
        
        // Toggle NOSTR expanded section
        function toggleNostrExpanded() {
            const section = document.getElementById('nostr-expanded');
            if (!section) return;
            section.classList.toggle('expanded');
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('video-modal').classList.remove('active');
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }
        
        // Show modal with video
        function showVideoModal(videoBlob, filename = null) {
            const modal = document.getElementById('video-modal');
            const videoPreview = document.getElementById('modal-video-preview');
            const videoUrl = URL.createObjectURL(videoBlob);
            
            videoPreview.src = videoUrl;
            modal.classList.add('active');
            
            // Store filename for later use
            videoPreview.dataset.filename = filename || `webcam_${Date.now()}.webm`;
            
            // Initialize modal map
            setTimeout(() => {
                initializeModalMap();
            }, 100);
            
            // Handle form submission
            document.getElementById('publish-form').onsubmit = async (e) => {
                e.preventDefault();
                const filename = videoPreview.dataset.filename;
                await publishVideo(videoBlob, filename);
            };
        }
        
        // Initialize modal map
        function initializeModalMap() {
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded');
                return;
            }
            
            const lat = parseFloat(document.getElementById('modal-lat').value) || 0.00;
            const lon = parseFloat(document.getElementById('modal-lon').value) || 0.00;
            
            if (modalMap) {
                modalMap.remove();
            }
            
            const mapContainer = document.getElementById('modal-map');
            if (!mapContainer) return;
            
            modalMap = L.map('modal-map').setView([lat, lon], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(modalMap);
            
            modalMarker = L.marker([lat, lon], {
                draggable: true
            }).addTo(modalMap);
            
            modalMap.on('click', function(e) {
                updateModalCoordinates(e.latlng.lat, e.latlng.lng);
            });
            
            modalMarker.on('dragend', function(e) {
                updateModalCoordinates(e.target.getLatLng().lat, e.target.getLatLng().lng);
            });
            
            setTimeout(() => {
                if (modalMap) {
                    modalMap.invalidateSize();
                }
            }, 100);
        }
        
        function updateModalCoordinates(lat, lon) {
            const roundedLat = Math.round(lat * 100) / 100;
            const roundedLon = Math.round(lon * 100) / 100;
            
            document.getElementById('modal-lat').value = roundedLat.toFixed(2);
            document.getElementById('modal-lon').value = roundedLon.toFixed(2);
            
            if (modalMarker) {
                modalMarker.setLatLng([roundedLat, roundedLon]);
            }
        }
        
        function getCurrentLocationForModal() {
            if (navigator.geolocation) {
                const btn = event.target;
                btn.textContent = 'Getting...';
                btn.disabled = true;
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = Math.round(position.coords.latitude * 100) / 100;
                        const lon = Math.round(position.coords.longitude * 100) / 100;
                        
                        updateModalCoordinates(lat, lon);
                        if (modalMap) {
                            modalMap.setView([lat, lon], 13);
                        }
                        
                        btn.textContent = 'üìç My Location';
                        btn.disabled = false;
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        btn.textContent = 'üìç My Location';
                        btn.disabled = false;
                        alert('Failed to get location');
                    }
                );
            }
        }

        // Initialize webcam recording functionality
        function initWebcamFeatures() {
        const startButton = document.getElementById('start-recording');
            const stopButton = document.getElementById('stop-recording');
        const videoPreview = document.getElementById('video-preview');
        const timerDisplay = document.getElementById('timer');
        const durationSlider = document.getElementById('duration-slider');
        const durationDisplay = document.getElementById('duration-display');

            // Mobile optimization
        if (isMobile) {
                const defaultDuration = isIOS ? 10 : 15;
            durationSlider.value = defaultDuration;
            durationDisplay.textContent = `${defaultDuration} seconds`;
                durationSlider.max = 30;
        }

        durationSlider.addEventListener('input', () => {
                durationDisplay.textContent = `${durationSlider.value} seconds`;
        });

        startButton.addEventListener('click', async () => {
                try {
                    const videoConstraints = isMobile ? {
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 },
                        frameRate: { ideal: 24, max: 30 }
                    } : {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: videoConstraints,
                        audio: true 
                    });
                    
                    currentStream = stream;
            videoPreview.srcObject = stream;

                    let mimeType = 'video/webm;codecs=vp9,opus';
                    if (isIOS) {
                        mimeType = 'video/mp4;codecs=h264,aac';
                    } else if (isAndroid) {
                        mimeType = 'video/webm;codecs=vp8,opus';
                    }
                    
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'video/webm';
                    }

                    mediaRecorder = new MediaRecorder(stream, {
                        mimeType: mimeType
                    });
                    
                    recordedChunks = [];
                    
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                        showVideoModal(blob);
                        if (currentStream) {
                            currentStream.getTracks().forEach(track => track.stop());
                            currentStream = null;
                        }
            };

            mediaRecorder.start();
            startTimer(parseInt(durationSlider.value));
            startButton.disabled = true;
                    startButton.classList.add('hidden');
                    stopButton.classList.remove('hidden');
            timerDisplay.classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Error starting recording:', error);
                    alert('Error accessing webcam: ' + error.message);
                }
            });

            stopButton.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                stopButton.disabled = true;
                stopButton.textContent = 'Processing...';
            });
        }

        // Timer function
        function startTimer(duration) {
            let timer = duration;
            const timerDisplay = document.getElementById('timer');
            const countdown = setInterval(() => {
                timerDisplay.textContent = timer;
                if (--timer < 0) {
                    clearInterval(countdown);
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                    }
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                        currentStream = null;
                    }
                    timerDisplay.textContent = "Done! üåü";
                }
            }, 1000);
        }
        
        // Publish video
        async function publishVideo(videoBlob, filename = null) {
            try {
                const publishBtn = document.getElementById('publish-btn');
                publishBtn.disabled = true;
                publishBtn.textContent = 'Uploading to IPFS...';
                
                // Step 1: Upload video to IPFS via /api/fileupload
                const finalFilename = filename || document.getElementById('modal-video-preview').dataset.filename || `webcam_${Date.now()}.webm`;
                const videoFile = new File([videoBlob], finalFilename, { type: videoBlob.type || 'video/webm' });
                
                const uploadFormData = new FormData();
                uploadFormData.append('file', videoFile);
                uploadFormData.append('npub', userPubkey);
                
                console.log('üì§ Uploading video to IPFS via /api/fileupload...');
                const uploadResponse = await fetch('/api/fileupload', {
                    method: 'POST',
                    body: uploadFormData
                });
                
                if (!uploadResponse.ok) {
                    const errorData = await uploadResponse.json().catch(() => ({ detail: uploadResponse.statusText }));
                    throw new Error(errorData.detail || `Upload failed: ${uploadResponse.statusText}`);
                }
                
                const uploadResult = await uploadResponse.json();
                
                if (!uploadResult.success || !uploadResult.new_cid) {
                    throw new Error(uploadResult.message || 'IPFS upload failed - no CID returned');
                }
                
                console.log('‚úÖ Video uploaded to IPFS:', uploadResult.new_cid);
                
                // Step 2: Publish to NOSTR with IPFS CID
                publishBtn.textContent = 'Publishing to NOSTR...';
                
                const formData = new FormData();
                formData.append('player', userEmail || document.getElementById('player').value);
                formData.append('ipfs_cid', uploadResult.new_cid);  // Send CID instead of video_blob
                formData.append('title', document.getElementById('video-title').value);
                formData.append('description', document.getElementById('video-description').value);
                formData.append('publish_nostr', document.getElementById('publish-nostr').checked ? 'true' : 'false');
                
                // Get location from modal
                const lat = parseFloat(document.getElementById('modal-lat').value) || 0.00;
                const lon = parseFloat(document.getElementById('modal-lon').value) || 0.00;
                    formData.append('latitude', lat.toString());
                    formData.append('longitude', lon.toString());
                
                if (document.getElementById('publish-nostr').checked && userPubkey) {
                    formData.append('npub', userPubkey);
                }
                
                const response = await fetch('/webcam', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.text();
                    alert('‚úÖ Video published successfully! IPFS CID: ' + uploadResult.new_cid);
                    closeModal();
                    location.reload();
                } else {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error publishing video:', error);
                alert('Error publishing video: ' + error.message);
                document.getElementById('publish-btn').disabled = false;
                document.getElementById('publish-btn').textContent = 'üì° Publish Video';
            }
        }

        // Utility function to convert blob to base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Handle video file upload
        function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['video/mp4', 'video/webm', 'video/quicktime', 'video/x-msvideo'];
            const validExtensions = ['.mp4', '.webm', '.mov', '.avi'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            
            if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
                alert('‚ùå Invalid file type. Please upload a video file (.mp4, .webm, .mov)');
                return;
            }
            
            // Validate file size (max 500MB)
            const maxSize = 500 * 1024 * 1024; // 500MB
            if (file.size > maxSize) {
                alert('‚ùå File too large. Maximum size is 500MB');
                return;
            }
            
            // Create blob from file and show in modal
            const videoBlob = new Blob([file], { type: file.type });
            showVideoModal(videoBlob, file.name);
            
            // Reset file input
            event.target.value = '';
        }

        // Connect to NOSTR
        async function handleNostrConnect() {
            const statusDiv = document.getElementById('auth-status');
            const headerStatus = document.getElementById('header-auth-status');
            const connectBtn = document.getElementById('nostr-connect-btn');
            
            connectBtn.disabled = true;
            statusDiv.innerHTML = '<div style="color: #6366f1;">üîÑ Connecting...</div>';
            headerStatus.textContent = 'Connecting...';
            
            try {
                if (authMode === 'extension') {
                    if (typeof window.nostr === 'undefined' || typeof window.nostr.getPublicKey !== 'function') {
                        throw new Error("NOSTR extension not found. Please install a NOSTR extension (nos2x, Alby, etc.)");
                    }
                    
                    userPubkey = await window.nostr.getPublicKey();
                    
                } else if (authMode === 'nsec') {
                    const nsecKey = document.getElementById('nsec-key').value.trim();
                    if (!nsecKey) {
                        throw new Error("Please enter your private key (nsec)");
                    }
                    
                    try {
                        // Use common.js variable userPrivateKey instead of userPrivkey
                        userPrivateKey = NostrTools.nip19.decode(nsecKey).data;
                        userPubkey = NostrTools.getPublicKey(userPrivateKey);
                    } catch (e) {
                        throw new Error("Invalid nsec format. Please check your private key.");
                    }
                }
                
                await connectToRelay();
                await sendNIP42Auth(DEFAULT_RELAYS[0]);
                await fetchUserEmail();
                
                // Update UI
                headerStatus.textContent = `Connected: ${userPubkey.substring(0, 8)}...${userPubkey.substring(userPubkey.length - 4)}`;
                document.getElementById('header-connect-btn').style.display = 'none';
                document.getElementById('header-profile-btn').style.display = 'inline-block';
                document.getElementById('webcam-section').style.display = 'block';
                document.getElementById('nostr-expanded').classList.remove('expanded');
                
                statusDiv.innerHTML = `<div style="color: #4ade80;">‚úÖ Connected as ${userPubkey.substring(0, 8)}...${userPubkey.substring(userPubkey.length - 4)}${userEmail ? ` (${userEmail})` : ''}</div>`;
                
            } catch (error) {
                console.error("Connection error:", error);
                statusDiv.innerHTML = `<div style="color: #ef4444;">‚ùå ${error.message}</div>`;
                headerStatus.textContent = 'Connection failed';
                connectBtn.disabled = false;
            }
        }

        // Fetch user email from NOSTR DID document
        async function fetchUserEmail() {
            if (!userPubkey) return;
            
            try {
                userEmail = await fetchUserEmailWithFallback(userPubkey);
                if (userEmail === userPubkey) {
                    userEmail = null;
                }
                document.getElementById('player').value = userEmail || userPubkey;
            } catch (error) {
                console.error('Error fetching user email:', error);
                userEmail = null;
                document.getElementById('player').value = userPubkey;
            }
        }

        // Open NOSTR Profile
        function openNostrProfile() {
            if (!userPubkey) {
                alert("Please connect to NOSTR first");
                return;
            }
            
            const ipfsGateway = '{{ myIPFS }}';
            const profileURL = `${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${userPubkey}`;
            window.open(profileURL, '_blank');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-connect with nsec if provided
            if (AUTO_CONNECT_NSEC && AUTO_CONNECT_NSEC !== null && AUTO_CONNECT_NSEC.trim() !== '') {
                const nsecRadio = document.getElementById('auth-nsec');
                const nsecInput = document.getElementById('nsec-key');
                const nsecContainer = document.getElementById('nsec-input-container');
                
                if (nsecRadio && nsecInput && nsecContainer) {
                    nsecRadio.checked = true;
                    nsecContainer.classList.add('visible');
                    authMode = 'nsec';
                    nsecInput.value = AUTO_CONNECT_NSEC;
                    
                    setTimeout(() => {
                        handleNostrConnect();
                    }, 700);
                }
            }
            
            // Handle auth mode change
            const authRadios = document.querySelectorAll('input[name="auth-mode"]');
            authRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    authMode = this.value;
                    const nsecContainer = document.getElementById('nsec-input-container');
                    if (authMode === 'nsec') {
                        nsecContainer.classList.add('visible');
                    } else {
                        nsecContainer.classList.remove('visible');
                    }
                });
            });
            
            // Handle video file upload
            const videoUpload = document.getElementById('video-upload');
            if (videoUpload) {
                videoUpload.addEventListener('change', handleVideoUpload);
            }
            
            // Initialize webcam features
            initWebcamFeatures();
        });
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('video-modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
