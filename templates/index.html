<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astroport.ONE - Web3 Developer Platform</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="{{ myIPFS }}/ipns/copylaradio.com/fonts/bootstrap-icons.css">
    
    <style>
        :root {
            --primary: #059669;
            --secondary: #10b981;
            --dark: #1a202c;
            --light: #f7fafc;
            --code-bg: #2d3748;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .hero {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            color: white;
            padding: 4rem 0 2rem 0;
            margin-bottom: 2rem;
        }
        
        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .hero .lead {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .module-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .module-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .module-icon {
            font-size: 2.5rem;
            margin-right: 1rem;
            color: var(--primary);
        }
        
        .module-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }
        
        .test-area {
            background: #f7fafc;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .result-box {
            background: #1a202c;
            color: #48bb78;
            font-family: 'Monaco', 'Menlo', monospace;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            min-height: 60px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-indicator.connected {
            background: #48bb78;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.disconnected {
            background: #cbd5e0;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .code-example {
            background: var(--code-bg);
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }
        
        .code-example .comment {
            color: #718096;
        }
        
        .code-example .keyword {
            color: #90cdf4;
        }
        
        .code-example .string {
            color: #9ae6b4;
        }
        
        .btn-test {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
            color: white;
        }
        
        .badge-tech {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
            display: inline-block;
        }
        
        .file-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .file-type-btn {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-type-btn:hover {
            border-color: var(--primary);
            background: rgba(5, 150, 105, 0.05);
        }
        
        .file-type-btn.active {
            border-color: var(--primary);
            background: rgba(5, 150, 105, 0.1);
        }
        
        .user-info {
            background: rgba(5, 150, 105, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }
        
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .chat-message {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }
        
        .chat-message .author {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        
        .chat-message .content {
            margin-top: 0.25rem;
        }
        
        .chat-message .time {
            font-size: 0.75rem;
            color: #718096;
            margin-top: 0.25rem;
        }
        
        .footer {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            color: white;
            padding: 2rem 0;
            margin-top: 4rem;
        }
        
        /* Fixed connection indicator */
        .connection-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.25rem;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .connection-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
        }
        
        .connection-badge.authenticated {
            border-color: #059669;
            background: rgba(5, 150, 105, 0.2);
        }
        
        .connection-badge.connected-not-auth {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }
        
        .connection-badge.disconnected {
            border-color: #cbd5e0;
            background: rgba(107, 114, 128, 0.2);
        }
        
        .connection-badge .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e0;
        }
        
        .connection-badge.authenticated .status-dot {
            background: #059669;
            animation: pulse 2s infinite;
        }
        
        .connection-badge.connected-not-auth .status-dot {
            background: #f59e0b;
            animation: pulse-warning 2s infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .connection-badge .status-text {
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .connection-badge .user-npub {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            font-family: monospace;
        }
        
        .connection-badge .btn-connect {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .connection-badge .btn-connect:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }
        
        .connection-badge .btn-profile {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .connection-badge .btn-profile:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <!-- Fixed Connection Indicator -->
    <div id="connectionBadge" class="connection-badge disconnected">
        <div class="status-dot"></div>
        <div class="d-flex flex-column" id="connectionBadgeContent">
            <span class="status-text">Not Connected</span>
        </div>
        <button class="btn-connect" onclick="testMultipassLogin()" id="connectBtn">
            <i class="bi bi-key"></i> Connect
        </button>
    </div>
    
    <!-- Hero Section -->
    <div class="hero">
        <div class="container text-center">
            <h1><i class="bi bi-code-square"></i> Astroport.ONE Developer Platform</h1>
            <p class="lead">
                Build decentralized applications with MULTIPASS authentication, IPFS storage, and NOSTR social features
            </p>
            <p class="mt-3">
                <span class="status-indicator" id="nostrStatus"></span>
                <span id="connectionStatus">Checking connection...</span>
            </p>
        </div>
    </div>

    <div class="container">
        <!-- Module 1: MULTIPASS Authentication -->
        <div class="module-card">
            <div class="module-header">
                <div class="module-icon"><i class="bi bi-person-badge"></i></div>
                <div>
                    <h2 class="module-title">1. MULTIPASS Authentication</h2>
                    <div>
                        <span class="badge-tech">NOSTR</span>
                        <span class="badge-tech">NIP-07</span>
                        <span class="badge-tech">NIP-42</span>
                    </div>
                </div>
            </div>
            
            <p class="lead">Enable decentralized login with NOSTR keys. No passwords, no email, no central database.</p>
            
            <div class="test-area">
                <h5><i class="bi bi-play-circle"></i> Test Authentication</h5>
                
                <div class="alert alert-info mb-3">
                    <h6 class="mb-2"><i class="bi bi-info-circle"></i> How Authentication Works</h6>
                    <ol class="mb-0 small">
                        <li><strong>MULTIPASS Account:</strong> You need a MULTIPASS account registered on this relay</li>
                        <li><strong>Connect:</strong> Click the button below to connect your NOSTR wallet</li>
                        <li><strong>Authenticate:</strong> Your extension will automatically send a NIP-42 event (kind 22242)</li>
                        <li><strong>Relay Acceptance:</strong> The relay accepts your NIP-42 event if you have MULTIPASS</li>
                        <li><strong>Verify:</strong> The system checks for recent authentication (valid 24h)</li>
                        <li><strong>Upload:</strong> Once authenticated, you can upload files securely</li>
                    </ol>
                    <div class="alert alert-warning mt-2 mb-0">
                        <small><strong>‚ö†Ô∏è Important:</strong> If you don't have a MULTIPASS account yet, 
                        <a href="/g1" class="alert-link">create one here</a> first. Without MULTIPASS, 
                        the relay will reject your authentication events.</small>
                    </div>
                </div>
                
                <button class="btn btn-test w-100 mt-2" onclick="testMultipassLogin()">
                    <i class="bi bi-key"></i> Connect with MULTIPASS
                </button>
                <div class="result-box" id="authResult">Click button to test authentication...</div>
                
                <div id="userInfo" style="display:none;" class="user-info mt-3">
                    <strong><i class="bi bi-person-check"></i> Connected:</strong><br>
                    <small>npub: <code id="userNpub"></code></small><br>
                    <small>hex: <code id="userHex"></code></small><br><br>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <a href="#" onclick="viewProfile()" class="btn btn-sm btn-success">
                            <i class="bi bi-person-circle"></i> View My Profile
                        </a>
                        <button id="didStatusBtn" class="btn btn-sm btn-outline-secondary" onclick="checkDIDDocument()">
                            <i class="bi bi-file-earmark-text"></i> <span id="didBtnText">Check DID</span>
                        </button>
                        <button id="udriveBtn" class="btn btn-sm btn-outline-primary" style="display:none;" onclick="openUDrive()">
                            <i class="bi bi-cloud"></i> <span id="udriveBtnText">Open uDRIVE</span>
                        </button>
                    </div>
                    <div id="didInfo" class="alert alert-info mt-2" style="display:none;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong><i class="bi bi-shield-check"></i> DID Document (kind 30800)</strong>
                                <div id="didDetails" class="small mt-1"></div>
                            </div>
                            <button class="btn btn-sm btn-link" onclick="refreshDIDDocument()">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="code-example mt-3">
<span class="comment">// Simple integration example</span>
<span class="keyword">async function</span> connectMultipass() {
    <span class="comment">// Load common.js from IPFS</span>
    <span class="keyword">const</span> script = document.createElement(<span class="string">'script'</span>);
    script.src = <span class="string">'{{ myIPFS }}/ipns/copylaradio.com/common.js'</span>;
    document.head.appendChild(script);
    
    <span class="comment">// Connect to NOSTR</span>
    <span class="keyword">const</span> pubkey = <span class="keyword">await</span> connectNostr();
    console.log(<span class="string">'Connected:'</span>, pubkey);
    
    <span class="comment">// Use authenticated user</span>
    <span class="keyword">return</span> pubkey;
}
            </div>
        </div>

        <!-- Module 2: File Publishing -->
        <div class="module-card">
            <div class="module-header">
                <div class="module-icon"><i class="bi bi-cloud-upload"></i></div>
                <div>
                    <h2 class="module-title">2. Decentralized File Publishing</h2>
                    <div>
                        <span class="badge-tech">IPFS</span>
                        <span class="badge-tech">NIP-94</span>
                        <span class="badge-tech">NIP-71 (videos)</span>
                        <span class="badge-tech">SHA256 tracking</span>
                    </div>
                </div>
            </div>
            
            <p class="lead">Upload files to IPFS and publish metadata on NOSTR. View recent uploads from the community.</p>
            
            <div class="test-area">
                <h5><i class="bi bi-grid-3x2"></i> Recent Uploads</h5>
                <div id="recentUploads" class="row g-2 mb-3">
                    <div class="col-12 text-center text-muted">
                        <i class="bi bi-arrow-clockwise"></i> Loading recent files and videos...
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary mb-3" onclick="loadRecentUploads()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                
                <h5><i class="bi bi-file-earmark-arrow-up"></i> Upload File Test</h5>
                
                <div class="file-type-grid">
                    <div class="file-type-btn" onclick="selectFileType('image')">
                        <i class="bi bi-image" style="font-size:2rem;color:var(--primary);"></i>
                        <div class="mt-2">Image</div>
                        <small class="text-muted">NIP-94, kind 1063</small>
                    </div>
                    <div class="file-type-btn" onclick="selectFileType('video')">
                        <i class="bi bi-camera-video" style="font-size:2rem;color:var(--primary);"></i>
                        <div class="mt-2">Video</div>
                        <small class="text-muted">NIP-71, kind 21/22</small>
                    </div>
                    <div class="file-type-btn" onclick="selectFileType('audio')">
                        <i class="bi bi-music-note-beamed" style="font-size:2rem;color:var(--primary);"></i>
                        <div class="mt-2">Audio</div>
                        <small class="text-muted">NIP-94, kind 1063</small>
                    </div>
                    <div class="file-type-btn" onclick="selectFileType('document')">
                        <i class="bi bi-file-earmark-text" style="font-size:2rem;color:var(--primary);"></i>
                        <div class="mt-2">Document</div>
                        <small class="text-muted">NIP-94, kind 1063</small>
                    </div>
                </div>
                
                <input type="file" id="fileInput" class="form-control mt-3" style="display:none;" onchange="uploadFile()">
                <button class="btn btn-test w-100 mt-2" onclick="document.getElementById('fileInput').click()">
                    <i class="bi bi-upload"></i> Select & Upload File
                </button>
                
                <div class="result-box" id="uploadResult">Select a file type above and upload...</div>
                
                <div id="uploadLinks" style="display:none;" class="mt-3">
                    <h6><i class="bi bi-link-45deg"></i> Published Links:</h6>
                    <div class="alert alert-success">
                        <strong>IPFS URL:</strong><br>
                        <a href="#" id="ipfsLink" target="_blank" class="text-break"></a><br><br>
                        <strong>NOSTR Event ID:</strong><br>
                        <code id="nostrEventId" class="text-break"></code><br><br>
                        <strong>Info.json (metadata):</strong><br>
                        <a href="#" id="infoLink" target="_blank" class="text-break"></a>
                    </div>
                </div>
            </div>
            
            <div class="code-example mt-3">
<span class="comment">// File upload with automatic metadata</span>
<span class="keyword">async function</span> uploadToIPFS(file, npub) {
    <span class="keyword">const</span> formData = <span class="keyword">new</span> FormData();
    formData.append(<span class="string">'file'</span>, file);
    formData.append(<span class="string">'npub'</span>, npub);
    
    <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(<span class="string">'/api/fileupload'</span>, {
        method: <span class="string">'POST'</span>,
        body: formData
    });
    
    <span class="keyword">const</span> result = <span class="keyword">await</span> response.json();
    <span class="comment">// Returns: { cid, thumbnail_ipfs, info, fileName }</span>
    
    <span class="keyword">return</span> result;
}
            </div>
        </div>

        <!-- Module 3: Social Interactions -->
        <div class="module-card">
            <div class="module-header">
                <div class="module-icon"><i class="bi bi-heart"></i></div>
                <div>
                    <h2 class="module-title">3. Social Interactions</h2>
                    <div>
                        <span class="badge-tech">NIP-25</span>
                        <span class="badge-tech">Reactions</span>
                        <span class="badge-tech">Comments</span>
                    </div>
                </div>
            </div>
            
            <p class="lead">Add likes, reactions, comments, and shares to any content or URL. Comments and shares are linked to this page.</p>
            
            <div class="test-area">
                <h5><i class="bi bi-hand-thumbs-up"></i> Comments & Shares for this Page</h5>
                
                <div id="pageInteractions" class="mb-3">
                    <div class="text-center text-muted">
                        <i class="bi bi-arrow-clockwise"></i> Loading interactions...
                    </div>
                </div>
                
                <button class="btn btn-sm btn-outline-secondary mb-3" onclick="loadPageInteractions()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                
                <h5><i class="bi bi-pencil-square"></i> Test Actions</h5>
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="testComment()">
                        <i class="bi bi-chat"></i> Post Comment
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="testShare()">
                        <i class="bi bi-share"></i> Share Page
                    </button>
                </div>
                
                <div class="result-box" style="min-height:100px;" id="socialResult">Use buttons above to post comments or share this page...</div>
                
                <div class="alert alert-info mt-2">
                    <small><i class="bi bi-info-circle"></i> Note: Likes require an event ID. Comments and shares are attached to the current page URL.</small>
                </div>
            </div>
            
            <div class="code-example mt-3">
<span class="comment">// Send a like (NIP-25 reaction)</span>
<span class="keyword">async function</span> sendLike(eventId, authorPubkey) {
    <span class="comment">// Uses common.js function</span>
    <span class="keyword">const</span> result = <span class="keyword">await</span> sendLike(eventId, authorPubkey, <span class="string">"+"</span>);
    <span class="keyword">return</span> result;
}

<span class="comment">// Post a comment</span>
<span class="keyword">async function</span> postComment(content, url) {
    <span class="keyword">const</span> result = <span class="keyword">await</span> postComment(content, url);
    <span class="keyword">return</span> result;
}

<span class="comment">// Share to user's feed</span>
<span class="keyword">async function</span> shareContent(url, message) {
    <span class="keyword">const</span> result = <span class="keyword">await</span> shareCurrentPage(message);
    <span class="keyword">return</span> result;
}
            </div>
        </div>

        <!-- Module 4: Real-time Chat -->
        <div class="module-card">
            <div class="module-header">
                <div class="module-icon"><i class="bi bi-chat-dots"></i></div>
                <div>
                    <h2 class="module-title">4. Real-time Messaging</h2>
                    <div>
                        <span class="badge-tech">NIP-01</span>
                        <span class="badge-tech">WebSocket</span>
                        <span class="badge-tech">Live Chat</span>
                    </div>
                </div>
            </div>
            
            <p class="lead">Add real-time chat to any page. Messages are stored on NOSTR relays.</p>
            
            <div class="test-area">
                <h5><i class="bi bi-chat-square-text"></i> Live Chat Test</h5>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="text-center text-muted">
                        <i class="bi bi-arrow-clockwise"></i> Loading messages...
                    </div>
                </div>
                
                <div class="input-group mt-2">
                    <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                    <button class="btn btn-test" onclick="sendChatMessage()">
                        <i class="bi bi-send"></i> Send
                    </button>
                </div>
                
                <small class="text-muted">Messages are published to NOSTR with tag #AstroportDemo</small>
            </div>
            
            <div class="code-example mt-3">
<span class="comment">// Subscribe to real-time messages</span>
<span class="keyword">async function</span> subscribeToChat(hashtag) {
    <span class="keyword">const</span> relay = <span class="keyword">await</span> connectToRelay();
    
    <span class="keyword">const</span> sub = relay.sub([{
        kinds: [1],
        <span class="string">"#t"</span>: [hashtag],
        limit: 50
    }]);
    
    sub.on(<span class="string">'event'</span>, event => {
        displayChatMessage(event);
    });
}

<span class="comment">// Send message</span>
<span class="keyword">async function</span> sendMessage(content, hashtag) {
    <span class="keyword">await</span> publishNote(content, [[<span class="string">"t"</span>, hashtag]]);
}
            </div>
        </div>

        <!-- Module 5: Developer Examples -->
        <div class="module-card">
            <div class="module-header">
                <div class="module-icon"><i class="bi bi-code-slash"></i></div>
                <div>
                    <h2 class="module-title">5. Integration Examples</h2>
                    <div>
                        <span class="badge-tech">Templates</span>
                        <span class="badge-tech">Examples</span>
                        <span class="badge-tech">Docs</span>
                    </div>
                </div>
            </div>
            
            <p class="lead">Explore existing applications and learn from their implementation.</p>
            
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card p-3 mb-3">
                        <h5><i class="bi bi-youtube"></i> NostrTube</h5>
                        <p class="text-muted small">Decentralized video platform with IPFS storage and NOSTR social features.</p>
                        <a href="/youtube?html=1" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> View Demo
                        </a>
                        <a href="#" onclick="showCode('youtube')" class="btn btn-sm btn-link">
                            <i class="bi bi-code"></i> View Code
                        </a>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card p-3 mb-3">
                        <h5><i class="bi bi-play-circle"></i> Theater Mode</h5>
                        <p class="text-muted small">Immersive video player with live comments and reactions.</p>
                        <a href="/theater" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> View Demo
                        </a>
                        <a href="#" onclick="showCode('theater')" class="btn btn-sm btn-link">
                            <i class="bi bi-code"></i> View Code
                        </a>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card p-3 mb-3">
                        <h5><i class="bi bi-collection-play"></i> Playlists</h5>
                        <p class="text-muted small">Manage video playlists stored on NOSTR (NIP-51).</p>
                        <a href="/playlist" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-box-arrow-up-right"></i> View Demo
                        </a>
                        <a href="#" onclick="showCode('playlist')" class="btn btn-sm btn-link">
                            <i class="bi bi-code"></i> View Code
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info mt-3">
                <h6><i class="bi bi-book"></i> Documentation & Resources</h6>
                <ul class="mb-0">
                    <li><strong>File Contract:</strong> NIP-94 (images, audio, documents) and NIP-71 (videos)</li>
                    <li><strong>Common.js API:</strong> <code>{{ myIPFS }}/ipns/copylaradio.com/common.js</code></li>
                    <li><strong>Developer Guide:</strong> <a href="https://github.com/papiche/Astroport.ONE/blob/master/docs/README.NostrTube.DEV.md" target="_blank">NostrTube Developer Documentation</a></li>
                    <li><strong>Source Code Examples:</strong>
                        <ul>
                            <li><a href="https://github.com/papiche/UPassport/blob/main/templates/youtube.html" target="_blank">youtube.html</a> - Video platform</li>
                            <li><a href="https://github.com/papiche/UPassport/blob/main/templates/theater-modal.html" target="_blank">theater-modal.html</a> - Theater mode</li>
                            <li><a href="https://github.com/papiche/UPassport/blob/main/templates/playlist-manager.html" target="_blank">playlist-manager.html</a> - Playlist manager</li>
                        </ul>
                    </li>
                    <li><strong>GitHub Repository:</strong> <a href="https://github.com/papiche/Astroport.ONE" target="_blank">Astroport.ONE</a></li>
                    <li><strong>NOSTR NIPs:</strong> <a href="https://github.com/nostr-protocol/nips" target="_blank">Protocol Specifications</a></li>
                </ul>
            </div>
        </div>

        <!-- Quick Start -->
        <div class="module-card bg-light">
            <h3><i class="bi bi-rocket-takeoff"></i> Quick Start for Developers</h3>
            <p>Add MULTIPASS authentication to your website in 3 steps:</p>
            
            <div class="code-example">
<span class="comment">&lt;!-- 1. Include common.js --&gt;</span>
&lt;script src=<span class="string">"{{ myIPFS }}/ipns/copylaradio.com/common.js"</span>&gt;&lt;/script&gt;

<span class="comment">&lt;!-- 2. Add login button --&gt;</span>
&lt;button onclick=<span class="string">"loginWithMultipass()"</span>&gt;Connect with MULTIPASS&lt;/button&gt;

<span class="comment">&lt;!-- 3. Use the authenticated user --&gt;</span>
&lt;script&gt;
<span class="keyword">async function</span> loginWithMultipass() {
    <span class="keyword">const</span> pubkey = <span class="keyword">await</span> connectNostr();
    console.log(<span class="string">'User connected:'</span>, pubkey);
    
    <span class="comment">// Now you can use all NOSTR features</span>
    <span class="keyword">await</span> publishNote(<span class="string">'Hello from my app!'</span>);
    <span class="keyword">await</span> uploadPhotoToIPFS(file);
    <span class="keyword">await</span> sendLike(eventId, authorPubkey);
}
&lt;/script&gt;
            </div>
            
            <h4 class="mt-4"><i class="bi bi-shield-check"></i> Secure File Upload (NIP-42 Authentication)</h4>
            <p>Ensure proper authentication before uploading to prevent 403 errors:</p>
            
            <div class="alert alert-info mb-3">
                <h6><i class="bi bi-diagram-3"></i> Authentication Flow</h6>
                <pre class="mb-0" style="background: white; border: 1px solid #ddd; padding: 10px; font-size: 0.75rem; line-height: 1.3;">
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Browser    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ NOSTR Wallet ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ    Relay     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ   Backend    ‚îÇ
‚îÇ  (Connect)   ‚îÇ     ‚îÇ  (NIP-42)    ‚îÇ     ‚îÇ (MULTIPASS)  ‚îÇ     ‚îÇ   (Verify)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      Step 1:              Step 2:              Step 3:              Step 4:
  Click Connect      Send kind 22242      Check MULTIPASS    Check recent event
                     auth event           Accept/Reject       24h window

‚úÖ SUCCESS: User can upload files
‚ùå FAILURE: Create MULTIPASS account first (/g1)
                </pre>
            </div>
            
            <div class="code-example">
<span class="comment">// Method 1: Automatic authentication check (recommended)</span>
<span class="keyword">async function</span> uploadFile(file) {
    <span class="comment">// uploadPhotoToIPFS now automatically checks authentication</span>
    <span class="keyword">const</span> result = <span class="keyword">await</span> uploadPhotoToIPFS(file);
    console.log(<span class="string">'Uploaded to IPFS:'</span>, result.ipfs_url);
}

<span class="comment">// Method 2: Manual authentication check</span>
<span class="keyword">async function</span> uploadWithManualCheck(file) {
    <span class="comment">// Verify authentication before upload</span>
    <span class="keyword">const</span> isAuth = <span class="keyword">await</span> ensureAuthentication({
        forceCheck: <span class="keyword">true</span>,  <span class="comment">// Force API verification</span>
        showUI: <span class="keyword">true</span>        <span class="comment">// Show user notifications</span>
    });
    
    <span class="keyword">if</span> (!isAuth) {
        console.error(<span class="string">'Authentication failed'</span>);
        <span class="keyword">return</span>;
    }
    
    <span class="keyword">const</span> result = <span class="keyword">await</span> uploadPhotoToIPFS(file);
    console.log(<span class="string">'Upload successful!'</span>, result);
}

<span class="comment">// Method 3: Check authentication status via API</span>
<span class="keyword">async function</span> checkAuth() {
    <span class="keyword">const</span> status = <span class="keyword">await</span> verifyAuthenticationWithAPI(userPubkey);
    console.log(<span class="string">'Auth status:'</span>, status);
    <span class="comment">// Returns: { auth_verified: true/false, message: "...", ... }</span>
}
            </div>
            
            <div class="alert alert-info mt-3">
                <h6><i class="bi bi-info-circle"></i> Authentication Best Practices</h6>
                <ul class="mb-0">
                    <li><strong>MULTIPASS Required:</strong> The relay only accepts NIP-42 events from registered MULTIPASS accounts</li>
                    <li><strong>NIP-42 Events:</strong> Authentication requires kind 22242 events on the relay</li>
                    <li><strong>24-Hour Validity:</strong> Auth events are valid for 24 hours</li>
                    <li><strong>Automatic Verification:</strong> <code>uploadPhotoToIPFS()</code> now checks auth automatically</li>
                    <li><strong>Manual Checks:</strong> Use <code>ensureAuthentication()</code> for custom workflows</li>
                    <li><strong>Test API:</strong> Use <code>/api/test-nostr?npub=YOUR_KEY</code> to verify auth status</li>
                    <li><strong>Relay Policy:</strong> Users without MULTIPASS or not in amisOfAmis.txt are rejected by default</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container text-center">
            <p class="mb-2">
                <strong>Astroport.ONE Developer Platform</strong>
            </p>
            <p class="mb-2">
                Build with NOSTR, IPFS, and Web3 technologies
            </p>
            <p>
                <a href="https://github.com/papiche/Astroport.ONE" class="text-white me-3" target="_blank">
                    <i class="bi bi-github"></i> GitHub
                </a>
                <a href="/health" class="text-white" target="_blank">
                    <i class="bi bi-heart-pulse"></i> System Status
                </a>
            </p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.bundle.min.js"></script>
    <!-- NostrTools Bundle (required for common.js) -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js"></script>
    <!-- Common.js for NOSTR functions -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/common.js"></script>
    
    <script>
        // App namespace to avoid conflicts with common.js
        window.AstroportDemo = {
            userPubkey: null,
            userNpub: null,
            relayConnected: false,
            chatSubscription: null,
            likeCount: 0,
            selectedFileType: null
        };
        
        // Check NOSTR connection on load
        window.addEventListener('load', async () => {
            console.log('[LOAD] Page loaded, initializing...');
            await checkConnection();
            await loadChatMessages();
            await loadRecentUploads();
            await loadPageInteractions();
            
            // Check if user is already connected (from previous session)
            if (typeof window.nostr !== 'undefined') {
                try {
                    const pubkey = await window.nostr.getPublicKey();
                    if (pubkey) {
                        AstroportDemo.userPubkey = pubkey;
                        if (typeof window.NostrTools !== 'undefined') {
                            AstroportDemo.userNpub = window.NostrTools.nip19.npubEncode(pubkey);
                        }
                        updateConnectionBadge(true);
                        console.log('[AUTH] User already connected:', pubkey.substring(0, 16) + '...');
                        
                        // Check authentication in background
                        setTimeout(async () => {
                            console.log('[AUTH] Checking authentication status in background...');
                            const authCheck = await fetch('/api/test-nostr', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: new URLSearchParams({
                                    'npub': pubkey
                                })
                            });
                            
                            if (authCheck.ok) {
                                const authResult = await authCheck.json();
                                if (!authResult.auth_verified) {
                                    console.warn('[AUTH] ‚ö†Ô∏è User connected but not authenticated. NIP-42 event required.');
                                    // Update badge to show partial connection
                                    updateConnectionBadge(true, false); // connected but not authenticated
                                    // Show subtle notification
                                    const authResultDiv = document.getElementById('authResult');
                                    if (authResultDiv) {
                                        authResultDiv.textContent = '‚ö†Ô∏è You are connected but need to authenticate.\n';
                                        authResultDiv.textContent += 'Click "Connect with MULTIPASS" to send authentication event.\n';
                                        authResultDiv.textContent += 'This is required for file uploads.';
                                    }
                                } else {
                                    console.log('[AUTH] ‚úÖ User authenticated and ready to upload');
                                    updateConnectionBadge(true, true); // connected and authenticated
                                    const authResultDiv = document.getElementById('authResult');
                                    if (authResultDiv) {
                                        authResultDiv.textContent = '‚úÖ Connected and authenticated! You can upload files.';
                                    }
                                }
                            }
                        }, 1000);
                    }
                } catch (e) {
                    console.log('[AUTH] No previous connection found');
                }
            }
        });
        
        async function checkConnection() {
            try {
                console.log('[CONNECTION] Checking NOSTR connection...');
                const statusEl = document.getElementById('nostrStatus');
                const textEl = document.getElementById('connectionStatus');
                
                textEl.textContent = 'Checking NOSTR connection...';
                
                // Try to connect to relay
                if (typeof connectToRelay === 'function') {
                    console.log('[CONNECTION] connectToRelay function found, connecting...');
                    await connectToRelay();
                    statusEl.classList.add('connected');
                    textEl.textContent = 'NOSTR relay connected';
                    AstroportDemo.relayConnected = true;
                    console.log('[CONNECTION] ‚úÖ Connected to relay:', window.nostrRelay);
                } else {
                    console.warn('[CONNECTION] ‚ö†Ô∏è connectToRelay function not available yet');
                    statusEl.classList.add('disconnected');
                    textEl.textContent = 'NOSTR functions loading...';
                }
            } catch (error) {
                console.error('[CONNECTION] ‚ùå Connection check failed:', error);
                document.getElementById('nostrStatus').classList.add('disconnected');
                document.getElementById('connectionStatus').textContent = 'Connection error';
            }
        }
        
        // View user profile
        async function viewProfile() {
            if (!AstroportDemo.userPubkey) {
                alert('Please connect first');
                return;
            }
            
            console.log('[PROFILE] Opening profile viewer for:', AstroportDemo.userPubkey);
            const ipfsGateway = '{{ myIPFS }}';
            const profileUrl = `${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${AstroportDemo.userPubkey}`;
            window.open(profileUrl, '_blank');
        }
        
        // Check DID Document (kind 30800)
        async function checkDIDDocument() {
            if (!AstroportDemo.userPubkey) {
                alert('Please connect first');
                return;
            }
            
            const didBtn = document.getElementById('didStatusBtn');
            const didBtnText = document.getElementById('didBtnText');
            const didInfo = document.getElementById('didInfo');
            const didDetails = document.getElementById('didDetails');
            
            try {
                didBtnText.textContent = 'Checking...';
                didBtn.disabled = true;
                
                console.log('[DID] Fetching DID document (kind 30800) for:', AstroportDemo.userPubkey);
                
                // Check if relay is connected
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[DID] Connecting to relay...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                    }
                }
                
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    // Subscribe to kind 30800 DID document events with d tag "did"
                    const sub = window.nostrRelay.sub([{
                        kinds: [30800], // NIP-101: DID Document
                        authors: [AstroportDemo.userPubkey],
                        "#d": ["did"], // d tag identifies the DID document
                        limit: 1
                    }]);
                    
                    let didFound = false;
                    
                    sub.on('event', event => {
                        console.log('[DID] üìÑ Found DID document:', event);
                        didFound = true;
                        displayDIDInfo(event);
                        sub.unsub();
                    });
                    
                    sub.on('eose', () => {
                        if (!didFound) {
                            console.log('[DID] ‚ö†Ô∏è No DID document found');
                            didBtnText.textContent = 'No DID Found';
                            didBtn.classList.remove('btn-outline-secondary');
                            didBtn.classList.add('btn-outline-warning');
                            didDetails.innerHTML = `
                                <span class="text-warning">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    No DID document (kind 30800) found for this profile.
                                </span><br>
                                <small class="text-muted">
                                    Create a MULTIPASS account at <a href="/g1" target="_blank">/g1</a> to get your DID document.
                                </small>
                            `;
                            didInfo.style.display = 'block';
                            didInfo.classList.remove('alert-info');
                            didInfo.classList.add('alert-warning');
                        }
                        sub.unsub();
                        didBtn.disabled = false;
                    });
                    
                    // Timeout after 5 seconds
                    setTimeout(() => {
                        if (!didFound) {
                            sub.unsub();
                            didBtn.disabled = false;
                            if (didBtnText.textContent === 'Checking...') {
                                didBtnText.textContent = 'Check DID';
                            }
                        }
                    }, 5000);
                } else {
                    throw new Error('Relay not available');
                }
            } catch (error) {
                console.error('[DID] ‚ùå Error checking DID:', error);
                didBtnText.textContent = 'Check Failed';
                didBtn.classList.remove('btn-outline-secondary');
                didBtn.classList.add('btn-outline-danger');
                didDetails.innerHTML = `
                    <span class="text-danger">
                        <i class="bi bi-x-circle"></i> Error: ${error.message}
                    </span>
                `;
                didInfo.style.display = 'block';
                didInfo.classList.remove('alert-info');
                didInfo.classList.add('alert-danger');
                didBtn.disabled = false;
            }
        }
        
        // Display DID Document Information
        function displayDIDInfo(event) {
            const didBtn = document.getElementById('didStatusBtn');
            const didBtnText = document.getElementById('didBtnText');
            const didInfo = document.getElementById('didInfo');
            const didDetails = document.getElementById('didDetails');
            
            try {
                // Parse DID document from event content
                const didDoc = JSON.parse(event.content);
                
                // Update button to show success
                didBtnText.textContent = 'DID Found ‚úì';
                didBtn.classList.remove('btn-outline-secondary', 'btn-outline-warning', 'btn-outline-danger');
                didBtn.classList.add('btn-outline-success');
                
                // Extract key information
                const didId = didDoc.id || 'N/A';
                const created = didDoc.metadata?.created ? new Date(didDoc.metadata.created).toLocaleString() : 'Unknown';
                const updated = didDoc.metadata?.updated ? new Date(didDoc.metadata.updated).toLocaleString() : 'Unknown';
                const contractStatus = didDoc.metadata?.contractStatus || 'unknown';
                const storageQuota = didDoc.metadata?.storageQuota || 'N/A';
                const services = didDoc.service?.length || 0;
                const verificationMethods = didDoc.verificationMethod?.length || 0;
                
                // Check for MULTIPASS wallet
                const multipassWallet = didDoc.metadata?.multipassWallet?.g1pub || 'N/A';
                
                // Check for ZEN Card wallet
                const zencardWallet = didDoc.metadata?.zencardWallet?.g1pub || 'N/A';
                
                // Check for WoT verification
                const wotMember = didDoc.metadata?.wotDuniterMember?.g1pub || null;
                
                // Build display HTML
                let html = `
                    <div class="small">
                        <strong>DID ID:</strong> <code class="small">${didId.substring(0, 40)}...</code><br>
                        <strong>Status:</strong> <span class="badge bg-primary">${contractStatus}</span><br>
                        <strong>Storage:</strong> ${storageQuota}<br>
                        <strong>Created:</strong> ${created}<br>
                        <strong>Updated:</strong> ${updated}<br>
                        <strong>Services:</strong> ${services} endpoint(s)<br>
                        <strong>Keys:</strong> ${verificationMethods} verification method(s)<br>
                `;
                
                if (multipassWallet !== 'N/A') {
                    html += `<strong>MULTIPASS:</strong> <code class="small">${multipassWallet.substring(0, 12)}...</code><br>`;
                }
                
                if (zencardWallet !== 'N/A') {
                    html += `<strong>ZEN Card:</strong> <code class="small">${zencardWallet.substring(0, 12)}...</code><br>`;
                }
                
                if (wotMember) {
                    html += `<strong>WoT Member:</strong> <span class="badge bg-success"><i class="bi bi-check-circle"></i> Verified</span><br>`;
                }
                
                html += `
                        <div class="mt-2">
                            <a href="#" onclick="viewFullDIDDocument(); return false;" class="btn btn-xs btn-outline-primary">
                                <i class="bi bi-file-code"></i> View Full Document
                            </a>
                            <a href="https://www.w3.org/TR/did-core/" target="_blank" class="btn btn-xs btn-outline-secondary">
                                <i class="bi bi-book"></i> W3C DID Spec
                            </a>
                        </div>
                    </div>
                `;
                
                didDetails.innerHTML = html;
                didInfo.style.display = 'block';
                didInfo.classList.remove('alert-warning', 'alert-danger');
                didInfo.classList.add('alert-info');
                
                // Store DID document for later use
                AstroportDemo.userDID = didDoc;
                AstroportDemo.userDIDEvent = event;
                
            } catch (error) {
                console.error('[DID] Error parsing DID document:', error);
                didDetails.innerHTML = `
                    <span class="text-danger">
                        <i class="bi bi-x-circle"></i> Error parsing DID document: ${error.message}
                    </span>
                `;
                didInfo.style.display = 'block';
                didInfo.classList.remove('alert-info');
                didInfo.classList.add('alert-danger');
            }
        }
        
        // View Full DID Document
        function viewFullDIDDocument() {
            if (!AstroportDemo.userDID) {
                alert('No DID document loaded');
                return;
            }
            
            // Create a modal or new window to display the full JSON
            const didJson = JSON.stringify(AstroportDemo.userDID, null, 2);
            const win = window.open('', '_blank', 'width=800,height=600');
            win.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>DID Document - ${AstroportDemo.userDID.id}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { padding: 20px; background: #1a1a1a; color: #e0e0e0; }
                        pre { background: #2a2a2a; padding: 20px; border-radius: 8px; overflow-x: auto; }
                        .header { margin-bottom: 20px; }
                        .badge { font-size: 0.9rem; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h2><i class="bi bi-file-earmark-text"></i> DID Document</h2>
                            <p class="lead">Decentralized Identifier (W3C DID Core v1.1)</p>
                            <span class="badge bg-primary">Kind 30800</span>
                            <span class="badge bg-success">NIP-101</span>
                            <span class="badge bg-info">Event ID: ${AstroportDemo.userDIDEvent.id.substring(0, 16)}...</span>
                        </div>
                        <pre><code>${escapeHtml(didJson)}</code></pre>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${didJson.replace(/'/g, "\\'")}'); alert('Copied to clipboard!');">
                                <i class="bi bi-clipboard"></i> Copy JSON
                            </button>
                            <a href="https://www.w3.org/TR/did-core/" target="_blank" class="btn btn-secondary">
                                <i class="bi bi-book"></i> W3C DID Specification
                            </a>
                            <a href="https://github.com/nostr-protocol/nips/blob/master/README.md" target="_blank" class="btn btn-secondary">
                                <i class="bi bi-file-text"></i> NOSTR NIPs
                            </a>
                        </div>
                    </div>
                </body>
                </html>
            `);
            win.document.close();
        }
        
        // Refresh DID Document
        async function refreshDIDDocument() {
            const didInfo = document.getElementById('didInfo');
            didInfo.style.display = 'none';
            
            const didBtn = document.getElementById('didStatusBtn');
            const didBtnText = document.getElementById('didBtnText');
            didBtnText.textContent = 'Check DID';
            didBtn.classList.remove('btn-outline-success', 'btn-outline-warning', 'btn-outline-danger');
            didBtn.classList.add('btn-outline-secondary');
            
            await checkDIDDocument();
        }
        
        // Check NOSTR Profile (kind 0) and extract uDRIVE link
        async function checkNostrProfile() {
            if (!AstroportDemo.userPubkey) {
                console.warn('[PROFILE] No pubkey available');
                return null;
            }
            
            try {
                console.log('[PROFILE] Fetching NOSTR profile (kind 0) for:', AstroportDemo.userPubkey);
                
                // Check if relay is connected
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[PROFILE] Connecting to relay...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                    }
                }
                
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    // Subscribe to kind 0 profile metadata events
                    const sub = window.nostrRelay.sub([{
                        kinds: [0], // Profile metadata
                        authors: [AstroportDemo.userPubkey],
                        limit: 1
                    }]);
                    
                    return new Promise((resolve) => {
                        let profileFound = false;
                        
                        sub.on('event', event => {
                            console.log('[PROFILE] üìá Found profile:', event);
                            profileFound = true;
                            
                            try {
                                // Parse profile metadata
                                const metadata = JSON.parse(event.content);
                                console.log('[PROFILE] Metadata:', metadata);
                                
                                // Extract tags with identity information
                                const tags = event.tags || [];
                                const identities = {};
                                
                                tags.forEach(tag => {
                                    if (tag[0] === 'i' && tag[1]) {
                                        // Split only on the FIRST colon to handle URLs correctly
                                        const colonIndex = tag[1].indexOf(':');
                                        if (colonIndex > 0) {
                                            const key = tag[1].substring(0, colonIndex);
                                            const value = tag[1].substring(colonIndex + 1);
                                            identities[key] = value;
                                        }
                                    }
                                });
                                
                                console.log('[PROFILE] Identities found:', identities);
                                
                                // Store profile data
                                AstroportDemo.userProfile = {
                                    metadata: metadata,
                                    identities: identities,
                                    event: event
                                };
                                
                                resolve(identities);
                            } catch (error) {
                                console.error('[PROFILE] Error parsing profile:', error);
                                resolve(null);
                            }
                            
                            sub.unsub();
                        });
                        
                        sub.on('eose', () => {
                            if (!profileFound) {
                                console.log('[PROFILE] ‚ö†Ô∏è No profile found');
                                resolve(null);
                            }
                            sub.unsub();
                        });
                        
                        // Timeout after 5 seconds
                        setTimeout(() => {
                            if (!profileFound) {
                                sub.unsub();
                                resolve(null);
                            }
                        }, 5000);
                    });
                } else {
                    console.warn('[PROFILE] Relay not available');
                    return null;
                }
            } catch (error) {
                console.error('[PROFILE] ‚ùå Error checking profile:', error);
                return null;
            }
        }
        
        // Open uDRIVE from profile data
        async function openUDrive() {
            const udriveBtn = document.getElementById('udriveBtn');
            const udriveBtnText = document.getElementById('udriveBtnText');
            
            try {
                udriveBtnText.textContent = 'Opening...';
                udriveBtn.disabled = true;
                
                // Check if we already have profile data
                let identities = AstroportDemo.userProfile?.identities;
                
                if (!identities) {
                    console.log('[UDRIVE] Fetching profile data...');
                    identities = await checkNostrProfile();
                }
                
                if (!identities) {
                    alert('Could not retrieve profile data. Please try again.');
                    return;
                }
                
                // Look for IPNS vault link
                let ipnsVault = identities.ipns_vault;
                let ipfsGw = identities.ipfs_gw || '{{ myIPFS }}';
                const email = identities.email;
                
                console.log('[UDRIVE] Raw identities:', identities);
                console.log('[UDRIVE] ipfs_gw from profile:', identities.ipfs_gw);
                console.log('[UDRIVE] Template myIPFS:', '{{ myIPFS }}');
                console.log('[UDRIVE] ipns_vault from profile:', identities.ipns_vault);
                
                // Clean up ipnsVault - remove leading /ipns/ if present
                if (ipnsVault && ipnsVault.startsWith('/ipns/')) {
                    ipnsVault = ipnsVault.substring(6); // Remove "/ipns/"
                    console.log('[UDRIVE] Cleaned ipnsVault (removed /ipns/):', ipnsVault);
                }
                
                // Clean up ipfsGw
                // If ipfsGw is just "http" or looks incomplete, use template default
                if (!ipfsGw || ipfsGw === 'http' || ipfsGw === 'https' || ipfsGw.length < 10) {
                    console.log('[UDRIVE] ipfs_gw invalid, using template default');
                    ipfsGw = '{{ myIPFS }}';
                }
                
                // Remove trailing slashes
                ipfsGw = ipfsGw.replace(/\/+$/, '');
                
                // Ensure ipfsGw starts with http:// or https://
                if (!ipfsGw.startsWith('http://') && !ipfsGw.startsWith('https://')) {
                    ipfsGw = 'http://' + ipfsGw;
                }
                
                console.log('[UDRIVE] Final ipfsGw:', ipfsGw);
                console.log('[UDRIVE] Final ipnsVault:', ipnsVault);
                
                if (!ipnsVault) {
                    alert('No uDRIVE link found in your profile.\n\nMake sure your profile includes an "ipns_vault" tag.\nCreate a MULTIPASS at /g1 to get your uDRIVE.');
                    return;
                }
                
                if (!email) {
                    alert('No email found in your profile.\n\nThe email is required to build the uDRIVE path.\nMake sure your profile includes an "email" tag.');
                    return;
                }
                
                // Build uDRIVE URL: IPFS_GW/ipns/VAULT/EMAIL/APP/uDRIVE
                const udriveUrl = `${ipfsGw}/ipns/${ipnsVault}/${email}/APP/uDRIVE`;
                console.log('[UDRIVE] Final URL:', udriveUrl);
                
                // Open in new tab
                window.open(udriveUrl, '_blank');
                
                udriveBtnText.textContent = 'Open uDRIVE';
                
            } catch (error) {
                console.error('[UDRIVE] Error:', error);
                alert(`Error opening uDRIVE: ${error.message}`);
                udriveBtnText.textContent = 'Open uDRIVE';
            } finally {
                udriveBtn.disabled = false;
            }
        }
        
        // Check and show uDRIVE button after connection
        async function checkAndShowUDriveButton() {
            const udriveBtn = document.getElementById('udriveBtn');
            
            try {
                console.log('[UDRIVE] Checking for uDRIVE link...');
                const identities = await checkNostrProfile();
                
                if (identities && identities.ipns_vault) {
                    console.log('[UDRIVE] ‚úÖ uDRIVE link found:', identities.ipns_vault);
                    udriveBtn.style.display = 'inline-block';
                } else {
                    console.log('[UDRIVE] ‚ö†Ô∏è No uDRIVE link in profile');
                    udriveBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('[UDRIVE] Error checking uDRIVE:', error);
                udriveBtn.style.display = 'none';
            }
        }
        
        async function testMultipassLogin() {
            const resultEl = document.getElementById('authResult');
            const userInfoEl = document.getElementById('userInfo');
            
            try {
                resultEl.textContent = 'üîÑ Connecting to NOSTR...\n';
                
                // Connect using common.js with forceAuth = true to send NIP-42 event
                console.log('[AUTH] Connecting with forced NIP-42 authentication...');
                AstroportDemo.userPubkey = await connectNostr(true); // Force NIP-42 auth
                
                if (!AstroportDemo.userPubkey) {
                    throw new Error('No public key returned');
                }
                
                resultEl.textContent += '‚úÖ Connected successfully!\n\n';
                resultEl.textContent += `Public Key (hex):\n${AstroportDemo.userPubkey}\n\n`;
                
                // Convert to npub if possible
                if (typeof window.NostrTools !== 'undefined') {
                    AstroportDemo.userNpub = window.NostrTools.nip19.npubEncode(AstroportDemo.userPubkey);
                    resultEl.textContent += `Public Key (npub):\n${AstroportDemo.userNpub}\n`;
                }
                
                // Wait a bit for NIP-42 event to be sent and processed
                resultEl.textContent += '\n‚è≥ Sending authentication event (NIP-42)...\n';
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Verify authentication was successful
                resultEl.textContent += '\nüîç Verifying authentication...\n';
                const authCheck = await fetch('/api/test-nostr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'npub': AstroportDemo.userPubkey
                    })
                });
                
                if (authCheck.ok) {
                    const authResult = await authCheck.json();
                    if (authResult.auth_verified) {
                        resultEl.textContent += '‚úÖ Authentication verified! You can now upload files.\n';
                        updateConnectionBadge(true, true); // Fully authenticated
                    } else {
                        resultEl.textContent += '‚ö†Ô∏è Authentication pending. Please try again in a moment.\n';
                        updateConnectionBadge(true, false); // Connected but not authenticated
                    }
                } else {
                    updateConnectionBadge(true, false); // Connected but verification failed
                }
                
                // Show user info
                document.getElementById('userNpub').textContent = AstroportDemo.userNpub || 'N/A';
                document.getElementById('userHex').textContent = AstroportDemo.userPubkey;
                userInfoEl.style.display = 'block';
                
                // Update fixed connection badge
                updateConnectionBadge(true);
                
                // Auto-check DID document in background
                setTimeout(() => {
                    console.log('[AUTH] Auto-checking DID document...');
                    checkDIDDocument().catch(err => {
                        console.warn('[AUTH] Could not auto-check DID:', err);
                    });
                }, 1000);
                
                // Auto-check and show uDRIVE button
                setTimeout(() => {
                    console.log('[AUTH] Checking for uDRIVE link...');
                    checkAndShowUDriveButton().catch(err => {
                        console.warn('[AUTH] Could not check uDRIVE:', err);
                    });
                }, 1500);
                
            } catch (error) {
                resultEl.textContent = '‚ùå Connection failed\n\n';
                resultEl.textContent += `Error: ${error.message}\n\n`;
                resultEl.textContent += 'Make sure you have a NOSTR extension installed (nos2x, Alby, etc.)';
                console.error('Auth error:', error);
                
                // Update badge to show error
                updateConnectionBadge(false);
            }
        }
        
        // Update the fixed connection badge
        // authenticated: true/false - wallet connected
        // authVerified: true/false/undefined - NIP-42 authentication status
        function updateConnectionBadge(authenticated, authVerified) {
            const badge = document.getElementById('connectionBadge');
            const content = document.getElementById('connectionBadgeContent');
            const connectBtn = document.getElementById('connectBtn');
            
            // Clear all state classes
            badge.classList.remove('authenticated', 'connected-not-auth', 'disconnected');
            
            if (authenticated && AstroportDemo.userPubkey) {
                const npubShort = AstroportDemo.userNpub 
                    ? AstroportDemo.userNpub.substring(0, 12) + '...' 
                    : AstroportDemo.userPubkey.substring(0, 8) + '...';
                
                if (authVerified === true) {
                    // Fully authenticated (wallet connected + NIP-42 verified)
                    badge.classList.add('authenticated');
                    content.innerHTML = `
                        <span class="status-text">‚úÖ Authenticated</span>
                        <span class="user-npub">${npubShort}</span>
                    `;
                } else if (authVerified === false) {
                    // Connected but not authenticated (wallet connected, no NIP-42)
                    badge.classList.add('connected-not-auth');
                    content.innerHTML = `
                        <span class="status-text">‚ö†Ô∏è Not Authenticated</span>
                        <span class="user-npub">${npubShort}</span>
                    `;
                } else {
                    // Connected, auth status unknown
                    badge.classList.add('connected-not-auth');
                    content.innerHTML = `
                        <span class="status-text">Connected</span>
                        <span class="user-npub">${npubShort}</span>
                    `;
                }
                
                // Replace connect button with profile button
                if (connectBtn) {
                    connectBtn.outerHTML = `
                        <button class="btn-profile" onclick="viewProfile()">
                            <i class="bi bi-person-circle"></i> Profile
                        </button>
                    `;
                }
            } else {
                // Not connected at all
                badge.classList.add('disconnected');
                content.innerHTML = `
                    <span class="status-text">Not Connected</span>
                `;
                
                // Restore connect button if it was replaced
                if (!connectBtn) {
                    const btnProfile = badge.querySelector('.btn-profile');
                    if (btnProfile) {
                        btnProfile.outerHTML = `
                            <button class="btn-connect" onclick="testMultipassLogin()" id="connectBtn">
                                <i class="bi bi-key"></i> Connect
                            </button>
                        `;
                    }
                }
            }
        }
        
        function selectFileType(type) {
            AstroportDemo.selectedFileType = type;
            
            // Update UI
            document.querySelectorAll('.file-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.file-type-btn').classList.add('active');
            
            document.getElementById('uploadResult').textContent = `üìÅ ${type.toUpperCase()} selected. Click "Select & Upload File" to continue...`;
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const resultEl = document.getElementById('uploadResult');
            const linksEl = document.getElementById('uploadLinks');
            
            if (!file) {
                resultEl.textContent = '‚ùå No file selected';
                return;
            }
            
            if (!AstroportDemo.userPubkey && !AstroportDemo.userNpub) {
                resultEl.textContent = '‚ùå Please connect with MULTIPASS first';
                return;
            }
            
            try {
                resultEl.textContent = `üîÑ Uploading ${file.name}...\n`;
                resultEl.textContent += `Size: ${(file.size / 1024 / 1024).toFixed(2)} MB\n`;
                resultEl.textContent += `Type: ${file.type}\n\n`;
                
                // Verify authentication before upload
                resultEl.textContent += 'üîê Verifying authentication...\n';
                const authCheck = await fetch('/api/test-nostr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'npub': AstroportDemo.userPubkey || AstroportDemo.userNpub
                    })
                });
                
                if (!authCheck.ok) {
                    throw new Error('Authentication verification failed');
                }
                
                const authResult = await authCheck.json();
                console.log('[AUTH] Authentication check result:', authResult);
                
                if (!authResult.auth_verified) {
                    // Auto-retry authentication instead of showing error
                    resultEl.textContent += '‚ö†Ô∏è No recent NIP-42 event found\n';
                    resultEl.textContent += 'üîÑ Sending authentication event automatically...\n\n';
                    
                    console.log('[UPLOAD] Auto-sending NIP-42 authentication...');
                    
                    try {
                        // Force NIP-42 authentication
                        if (typeof connectNostr === 'function') {
                            await connectNostr(true); // true = force NIP-42 auth
                            
                            // Wait for event to be processed
                            resultEl.textContent += '‚è≥ Waiting for relay to process authentication...\n';
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            
                            // Verify again
                            resultEl.textContent += 'üîç Verifying authentication...\n';
                            const recheckAuth = await fetch('/api/test-nostr', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: new URLSearchParams({
                                    'npub': AstroportDemo.userPubkey || AstroportDemo.userNpub
                                })
                            });
                            
                            if (recheckAuth.ok) {
                                const recheckResult = await recheckAuth.json();
                                if (recheckResult.auth_verified) {
                                    resultEl.textContent += '‚úÖ Authentication successful!\n\n';
                                    updateConnectionBadge(true, true); // Update badge
                                } else {
                                    throw new Error('Authentication still not verified after retry');
                                }
                            } else {
                                throw new Error('Authentication recheck failed');
                            }
                        } else {
                            throw new Error('connectNostr function not available');
                        }
                    } catch (authError) {
                        console.error('[UPLOAD] Auto-authentication failed:', authError);
                        resultEl.textContent += `‚ùå Authentication failed: ${authError.message}\n\n`;
                        
                        // Show detailed help
                        if (authResult.status === 'partial' && authResult.relay_connected) {
                            resultEl.textContent += '‚ö†Ô∏è Possible causes:\n';
                            resultEl.textContent += '   1. You need a MULTIPASS account (create at /g1)\n';
                            resultEl.textContent += '   2. The relay rejected your NIP-42 event\n';
                            resultEl.textContent += '   3. Your NOSTR extension blocked the request\n\n';
                        }
                        
                        resultEl.textContent += 'üëâ Please click "Connect with MULTIPASS" button above and try again.';
                        
                        // Update badge to show not authenticated
                        updateConnectionBadge(true, false);
                        
                        return;
                    }
                } else {
                    resultEl.textContent += '‚úÖ Authentication verified!\n\n';
                }
                
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                formData.append('npub', AstroportDemo.userNpub || AstroportDemo.userPubkey);
                
                // Upload to API
                resultEl.textContent += 'üì§ Uploading to IPFS...\n';
                const response = await fetch('/api/fileupload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${response.statusText} - ${errorText}`);
                }
                
                const result = await response.json();
                
                resultEl.textContent += '‚úÖ Upload successful!\n\n';
                resultEl.textContent += `üì¶ IPFS CID: ${result.new_cid || result.cid}\n\n`;
                
                if (result.thumbnail_ipfs) {
                    resultEl.textContent += `üñºÔ∏è Thumbnail: ${result.thumbnail_ipfs}\n`;
                }
                if (result.gifanim_ipfs) {
                    resultEl.textContent += `üé¨ Animated GIF: ${result.gifanim_ipfs}\n`;
                }
                if (result.info) {
                    resultEl.textContent += `üìã Info.json: ${result.info}\n`;
                }
                
                // Show links
                const gateway = '{{ myIPFS }}';
                const ipfsUrl = `${gateway}/ipfs/${result.new_cid || result.cid}/${result.fileName || file.name}`;
                const infoUrl = result.info ? `${gateway}/ipfs/${result.info}` : '#';
                
                document.getElementById('ipfsLink').href = ipfsUrl;
                document.getElementById('ipfsLink').textContent = ipfsUrl;
                document.getElementById('infoLink').href = infoUrl;
                document.getElementById('infoLink').textContent = infoUrl;
                document.getElementById('nostrEventId').textContent = result.event_id || 'Published (check relay)';
                
                linksEl.style.display = 'block';
                
                // Reload uploads after a delay
                setTimeout(() => loadRecentUploads(), 2000);
                
            } catch (error) {
                resultEl.textContent = `‚ùå Upload failed\n\n${error.message}`;
                console.error('Upload error:', error);
            }
        }
        
        
        async function testComment() {
            const resultEl = document.getElementById('socialResult');
            
            if (!AstroportDemo.userPubkey) {
                resultEl.textContent = '‚ùå Please connect with MULTIPASS first';
                return;
            }
            
            const comment = prompt('Enter your comment:');
            if (!comment) return;
            
            try {
                console.log('[COMMENT] Publishing comment:', comment);
                resultEl.textContent = 'üîÑ Publishing comment...\n\n';
                
                // Publish comment using common.js
                if (typeof publishNote === 'function') {
                    await publishNote(comment, [['r', window.location.href]]);
                    console.log('[COMMENT] ‚úÖ Comment published');
                    resultEl.textContent += '‚úÖ Comment published!\n\n';
                    resultEl.textContent += `Content: "${comment}"\n`;
                    resultEl.textContent += `URL: ${window.location.href}`;
                    
                    // Reload interactions after a delay
                    setTimeout(() => loadPageInteractions(), 1000);
                } else {
                    console.error('[COMMENT] ‚ùå publishNote not available');
                    resultEl.textContent += '‚ùå publishNote function not available';
                }
                
            } catch (error) {
                console.error('[COMMENT] ‚ùå Error:', error);
                resultEl.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        async function testShare() {
            const resultEl = document.getElementById('socialResult');
            
            if (!AstroportDemo.userPubkey) {
                resultEl.textContent = '‚ùå Please connect with MULTIPASS first';
                return;
            }
            
            try {
                console.log('[SHARE] Sharing page...');
                resultEl.textContent = 'üîÑ Sharing to your feed...\n\n';
                
                const shareMessage = 'Check out this Astroport.ONE developer platform! ' + window.location.href;
                
                // Share using common.js - post as note with URL reference
                if (typeof publishNote === 'function') {
                    await publishNote(shareMessage, [['r', window.location.href]]);
                    console.log('[SHARE] ‚úÖ Shared successfully');
                    resultEl.textContent += '‚úÖ Shared to your NOSTR feed!\n\n';
                    resultEl.textContent += 'Your followers can now see this content.';
                    
                    // Reload interactions after a delay
                    setTimeout(() => loadPageInteractions(), 1000);
                } else {
                    console.error('[SHARE] ‚ùå publishNote not available');
                    resultEl.textContent += '‚ùå publishNote function not available';
                }
                
            } catch (error) {
                console.error('[SHARE] ‚ùå Error:', error);
                resultEl.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        async function loadChatMessages() {
            const messagesEl = document.getElementById('chatMessages');
            
            try {
                console.log('[CHAT] Loading chat messages...');
                console.log('[CHAT] nostrRelay available:', typeof window.nostrRelay !== 'undefined');
                console.log('[CHAT] isNostrConnected:', window.isNostrConnected);
                
                // Wait for relay connection if needed
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[CHAT] Waiting for relay connection...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                        console.log('[CHAT] Relay connected');
                    }
                }
                
                // Subscribe to messages with hashtag #AstroportDemo
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    console.log('[CHAT] Subscribing to #AstroportDemo messages...');
                    const sub = window.nostrRelay.sub([{
                        kinds: [1],
                        "#t": ["AstroportDemo"],
                        limit: 20
                    }]);
                    
                    sub.on('event', event => {
                        console.log('[CHAT] üì® New message received:', event);
                        displayChatMessage(event);
                    });
                    
                    sub.on('eose', () => {
                        console.log('[CHAT] ‚úÖ End of stored events');
                        if (messagesEl.innerHTML.includes('Loading messages')) {
                            messagesEl.innerHTML = '<div class="text-center text-muted">No messages yet. Be the first to send one!</div>';
                        }
                    });
                    
                    AstroportDemo.chatSubscription = sub;
                    console.log('[CHAT] Subscription created:', sub);
                } else {
                    console.warn('[CHAT] ‚ö†Ô∏è Relay not available');
                    messagesEl.innerHTML = '<div class="text-center text-muted">Connect to NOSTR to view messages</div>';
                }
            } catch (error) {
                console.error('[CHAT] ‚ùå Error loading chat:', error);
                messagesEl.innerHTML = '<div class="text-center text-muted">Error loading chat</div>';
            }
        }
        
        function displayChatMessage(event) {
            const messagesEl = document.getElementById('chatMessages');
            
            // Clear loading message
            if (messagesEl.innerHTML.includes('Loading messages')) {
                messagesEl.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            const authorShort = event.pubkey ? event.pubkey.substring(0, 8) + '...' : 'Unknown';
            const time = new Date(event.created_at * 1000).toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="author">${authorShort}</div>
                <div class="content">${escapeHtml(event.content)}</div>
                <div class="time">${time}</div>
            `;
            
            messagesEl.insertBefore(messageDiv, messagesEl.firstChild);
            
            // Keep only last 10 messages
            while (messagesEl.children.length > 10) {
                messagesEl.removeChild(messagesEl.lastChild);
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            
            if (!content) return;
            
            if (!AstroportDemo.userPubkey) {
                alert('Please connect with MULTIPASS first');
                return;
            }
            
            try {
                console.log('[CHAT] Sending message:', content);
                // Publish message with hashtag
                if (typeof publishNote === 'function') {
                    await publishNote(content, [['t', 'AstroportDemo']]);
                    console.log('[CHAT] ‚úÖ Message sent successfully');
                    input.value = '';
                } else {
                    console.error('[CHAT] ‚ùå publishNote function not available');
                    alert('Chat function not loaded yet');
                }
            } catch (error) {
                console.error('[CHAT] ‚ùå Error sending message:', error);
                alert('Error sending message: ' + error.message);
            }
        }
        
        // Load recent file uploads (NIP-94 and NIP-71)
        async function loadRecentUploads() {
            const uploadsEl = document.getElementById('recentUploads');
            
            try {
                console.log('[UPLOADS] Loading recent uploads...');
                
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[UPLOADS] Waiting for relay...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                    }
                }
                
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    console.log('[UPLOADS] Fetching NIP-94 (kind 1063) and NIP-71 (kinds 21, 22) events...');
                    
                    const sub = window.nostrRelay.sub([{
                        kinds: [1063, 21, 22], // NIP-94 (files with info.json), NIP-71 (videos: 21=short, 22=long)
                        limit: 50 // Get more events to have enough of each type
                    }]);
                    
                    const events = [];
                    
                    sub.on('event', event => {
                        console.log('[UPLOADS] üì¶ Received event (kind', event.kind + '):', event);
                        events.push(event);
                    });
                    
                    sub.on('eose', () => {
                        console.log('[UPLOADS] ‚úÖ Loaded', events.length, 'total events');
                        displayRecentUploads(events);
                        sub.unsub();
                    });
                } else {
                    console.warn('[UPLOADS] ‚ö†Ô∏è Relay not available');
                    uploadsEl.innerHTML = '<div class="col-12 text-center text-muted">Relay not connected</div>';
                }
            } catch (error) {
                console.error('[UPLOADS] ‚ùå Error loading uploads:', error);
                uploadsEl.innerHTML = '<div class="col-12 text-center text-muted">Error loading files</div>';
            }
        }
        
        function displayRecentUploads(events) {
            const uploadsEl = document.getElementById('recentUploads');
            
            if (events.length === 0) {
                uploadsEl.innerHTML = '<div class="col-12 text-center text-muted">No recent uploads found</div>';
                return;
            }
            
            // Separate events by type
            const fileEvents = []; // kind 1063 (NIP-94: all files with info.json metadata)
            const shortVideoEvents = []; // kind 21 (NIP-71: short videos)
            const longVideoEvents = []; // kind 22 (NIP-71: long videos)
            
            events.forEach(event => {
                if (event.kind === 1063) fileEvents.push(event);
                else if (event.kind === 21) shortVideoEvents.push(event);
                else if (event.kind === 22) longVideoEvents.push(event);
            });
            
            console.log('[UPLOADS] Categorized events:');
            console.log('  - Files/NIP-94 (1063):', fileEvents.length, '(images, audio, documents, videos)');
            console.log('  - Short videos/NIP-71 (21):', shortVideoEvents.length);
            console.log('  - Long videos/NIP-71 (22):', longVideoEvents.length);
            
            // Take only 3 most recent of each type
            const selectedEvents = [
                ...fileEvents.slice(0, 3),
                ...shortVideoEvents.slice(0, 3),
                ...longVideoEvents.slice(0, 3)
            ];
            
            console.log('[UPLOADS] Displaying', selectedEvents.length, 'events total (max 3 per type)');
            
            if (selectedEvents.length === 0) {
                uploadsEl.innerHTML = '<div class="col-12 text-center text-muted">No recent uploads found</div>';
                return;
            }
            
            uploadsEl.innerHTML = '';
            
            // Get IPFS gateway from global or use default
            const ipfsGateway = '{{ myIPFS }}';
            
            selectedEvents.forEach(event => {
                // Extract file info from tags
                let fileUrl = '';
                let fileName = 'Unknown';
                let fileType = '';
                let typeLabel = '';
                let gifanimUrl = '';
                let thumbnailUrl = '';
                
                if (event.tags) {
                    const urlTag = event.tags.find(t => t[0] === 'url');
                    const nameTag = event.tags.find(t => t[0] === 'name' || t[0] === 'title');
                    const typeTag = event.tags.find(t => t[0] === 'm' || t[0] === 'type');
                    const gifanimTag = event.tags.find(t => t[0] === 'gifanim' || t[0] === 'gif');
                    const thumbnailTag = event.tags.find(t => t[0] === 'thumbnail' || t[0] === 'thumb');
                    
                    if (urlTag && urlTag[1]) {
                        fileUrl = urlTag[1];
                        // Add IPFS gateway if URL starts with /ipfs/
                        if (fileUrl.startsWith('/ipfs/')) {
                            fileUrl = ipfsGateway + fileUrl;
                        }
                    }
                    if (nameTag && nameTag[1]) fileName = nameTag[1];
                    if (typeTag && typeTag[1]) fileType = typeTag[1];
                    if (gifanimTag && gifanimTag[1]) {
                        gifanimUrl = gifanimTag[1];
                        if (gifanimUrl.startsWith('/ipfs/')) {
                            gifanimUrl = ipfsGateway + gifanimUrl;
                        }
                    }
                    if (thumbnailTag && thumbnailTag[1]) {
                        thumbnailUrl = thumbnailTag[1];
                        if (thumbnailUrl.startsWith('/ipfs/')) {
                            thumbnailUrl = ipfsGateway + thumbnailUrl;
                        }
                    }
                }
                
                // Determine icon and type label based on kind and file type
                let icon = 'bi-file-earmark';
                let clickAction = '';
                let previewHtml = '';
                
                if (event.kind === 21 || event.kind === 22) {
                    // Video events (NIP-71) ‚Üí Open in theater mode
                    icon = event.kind === 21 ? 'bi-camera-video-fill' : 'bi-film';
                    typeLabel = event.kind === 21 ? 'Short Video' : 'Long Video';
                    clickAction = `window.open('/theater?video=${event.id}', '_blank')`;
                    
                    // Use gifanim if available, otherwise thumbnail, otherwise icon
                    if (gifanimUrl) {
                        previewHtml = `<img src="${gifanimUrl}" alt="Preview" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                    } else if (thumbnailUrl) {
                        previewHtml = `<img src="${thumbnailUrl}" alt="Thumbnail" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                    } else {
                        previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                    }
                } else if (event.kind === 1063) {
                    // NIP-94 with info.json metadata (SHA256 hash tracking)
                    if (fileType.startsWith('image/')) {
                        icon = 'bi-image';
                        typeLabel = 'Image';
                        previewHtml = `<img src="${fileUrl}" alt="Image" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                    } else if (fileType.startsWith('video/')) {
                        icon = 'bi-camera-video';
                        typeLabel = 'Video';
                        clickAction = `window.open('/theater?video=${event.id}', '_blank')`;
                        if (gifanimUrl) {
                            previewHtml = `<img src="${gifanimUrl}" alt="Preview" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                        } else if (thumbnailUrl) {
                            previewHtml = `<img src="${thumbnailUrl}" alt="Thumbnail" style="width:100%;height:150px;object-fit:cover;border-radius:8px;">`;
                        } else {
                            previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                        }
                    } else if (fileType.startsWith('audio/')) {
                        icon = 'bi-music-note-beamed';
                        typeLabel = 'Audio';
                        previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                    } else if (fileType.startsWith('text/') || fileType === 'application/pdf') {
                        icon = 'bi-file-earmark-text';
                        typeLabel = 'Document';
                        previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                    } else {
                        icon = 'bi-file-earmark';
                        typeLabel = 'File';
                        previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                    }
                    
                    // Default action: open file in new tab
                    if (!clickAction) {
                        clickAction = `window.open('${fileUrl}', '_blank')`;
                    }
                }
                
                // Default preview if not set
                if (!previewHtml) {
                    previewHtml = `<i class="bi ${icon}" style="font-size:3rem;color:var(--primary);"></i>`;
                }
                
                const authorShort = event.pubkey ? event.pubkey.substring(0, 8) + '...' : 'Unknown';
                const profileUrl = `${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${event.pubkey}`;
                
                const cardHtml = `
                    <div class="col-md-4 col-sm-6">
                        <div class="card p-2" style="cursor:pointer;" onclick="${clickAction}">
                            <div class="text-center mb-2">
                                ${previewHtml}
                            </div>
                            <h6 class="text-truncate" title="${fileName}">${fileName}</h6>
                            <small class="text-muted d-block">
                                <span class="badge bg-secondary">${typeLabel}</span> 
                                <span class="badge bg-info">kind ${event.kind}</span>
                            </small>
                            <small class="text-muted">
                                <i class="bi bi-person"></i> <a href="${profileUrl}" onclick="event.stopPropagation(); return true;" target="_blank">${authorShort}</a>
                            </small>
                        </div>
                    </div>
                `;
                
                uploadsEl.innerHTML += cardHtml;
            });
        }
        
        // Load page interactions (comments and shares)
        async function loadPageInteractions() {
            const interactionsEl = document.getElementById('pageInteractions');
            
            try {
                console.log('[INTERACTIONS] Loading page interactions...');
                
                if (typeof window.nostrRelay === 'undefined' || !window.nostrRelay) {
                    console.log('[INTERACTIONS] Waiting for relay...');
                    if (typeof connectToRelay === 'function') {
                        await connectToRelay();
                    }
                }
                
                if (typeof window.nostrRelay !== 'undefined' && window.nostrRelay) {
                    const pageUrl = window.location.href;
                    console.log('[INTERACTIONS] Fetching interactions for:', pageUrl);
                    
                    const sub = window.nostrRelay.sub([{
                        kinds: [1], // Text notes
                        "#r": [pageUrl], // Referenced URL
                        limit: 20
                    }]);
                    
                    const events = [];
                    
                    sub.on('event', event => {
                        console.log('[INTERACTIONS] üí¨ Received interaction:', event);
                        events.push(event);
                    });
                    
                    sub.on('eose', () => {
                        console.log('[INTERACTIONS] ‚úÖ Loaded', events.length, 'interactions');
                        displayPageInteractions(events);
                        sub.unsub();
                    });
                } else {
                    console.warn('[INTERACTIONS] ‚ö†Ô∏è Relay not available');
                    interactionsEl.innerHTML = '<div class="text-center text-muted">Relay not connected</div>';
                }
            } catch (error) {
                console.error('[INTERACTIONS] ‚ùå Error loading interactions:', error);
                interactionsEl.innerHTML = '<div class="text-center text-muted">Error loading interactions</div>';
            }
        }
        
        function displayPageInteractions(events) {
            const interactionsEl = document.getElementById('pageInteractions');
            
            if (events.length === 0) {
                interactionsEl.innerHTML = '<div class="text-center text-muted">No comments or shares yet. Be the first!</div>';
                return;
            }
            
            interactionsEl.innerHTML = '';
            
            events.forEach(event => {
                const authorShort = event.pubkey ? event.pubkey.substring(0, 8) + '...' : 'Unknown';
                const time = new Date(event.created_at * 1000).toLocaleString();
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                const ipfsGateway = '{{ myIPFS }}';
                messageDiv.innerHTML = `
                    <div class="author">
                        <a href="#" onclick="window.open('${ipfsGateway}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${event.pubkey}', '_blank'); return false;">${authorShort}</a>
                    </div>
                    <div class="content">${escapeHtml(event.content)}</div>
                    <div class="time">${time}</div>
                `;
                
                interactionsEl.appendChild(messageDiv);
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showCode(template) {
            const urls = {
                'youtube': 'https://github.com/papiche/UPassport/blob/main/templates/youtube.html',
                'theater': 'https://github.com/papiche/UPassport/blob/main/templates/theater-modal.html',
                'playlist': 'https://github.com/papiche/UPassport/blob/main/templates/playlist-manager.html'
            };
            
            window.open(urls[template], '_blank');
        }
        
        // Expose functions to global scope for onclick attributes
        window.testMultipassLogin = testMultipassLogin;
        window.viewProfile = viewProfile;
        window.selectFileType = selectFileType;
        window.uploadFile = uploadFile;
        window.testComment = testComment;
        window.testShare = testShare;
        window.sendChatMessage = sendChatMessage;
        window.loadRecentUploads = loadRecentUploads;
        window.loadPageInteractions = loadPageInteractions;
        window.showCode = showCode;
        
        // Expose new common.js functions globally for easy testing
        window.verifyAuthenticationWithAPI = typeof verifyAuthenticationWithAPI !== 'undefined' ? verifyAuthenticationWithAPI : null;
        window.ensureAuthentication = typeof ensureAuthentication !== 'undefined' ? ensureAuthentication : null;
    </script>
</body>
</html>
