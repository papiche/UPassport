<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âcole de la Vie - WoTx2 | UPlanet</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="{{ myIPFS }}/ipns/copylaradio.com/fonts/bootstrap-icons.css">
    
    <style>
        :root {
            --primary: #059669;
            --secondary: #10b981;
            --accent: #06b6d4;
            --dark: #1a202c;
            --light: #f7fafc;
            --water-blue: #0ea5e9;
            --water-dark: #0284c7;
        }
        
        body {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding-top: 80px;
        }
        
        .hero {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--water-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .hero h1 i {
            font-size: 3rem;
            color: var(--water-blue);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--water-blue), var(--water-dark));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.25rem;
            font-weight: 600;
        }
        
        .instructor-card {
            border-left: 4px solid var(--water-blue);
        }
        
        .instructor-card .card-body {
            padding: 1.5rem;
        }
        
        .badge-competency {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 0.25rem;
            display: inline-block;
        }
        
        .badge-new {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--water-blue), var(--water-dark));
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
        }
        
        .progress {
            height: 25px;
            border-radius: 15px;
            background: #e2e8f0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--water-blue), var(--water-dark));
            border-radius: 15px;
        }
        
        .virtuous-circle {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .circle-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin: 1rem 0;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 15px;
            border-left: 4px solid var(--water-blue);
        }
        
        .circle-step i {
            font-size: 2rem;
            color: var(--water-blue);
        }
        
        .connection-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.25rem;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        
        .connection-badge:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .connection-badge.authenticated {
            border-color: var(--primary);
            background: rgba(5, 150, 105, 0.2);
        }
        
        .connection-badge.connected-not-auth {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }
        
        .connection-badge.connecting {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }
        
        .connection-badge.disconnected {
            border-color: #94a3b8;
            background: rgba(156, 163, 175, 0.2);
        }
        
        .connection-badge .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e0;
        }
        
        .connection-badge.authenticated .status-dot {
            background: var(--primary);
            animation: pulse 2s infinite;
        }
        
        #connection-badge-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .status-text {
            font-size: 0.75em;
            font-weight: 600;
            color: #ffffff;
        }
        
        .user-npub {
            font-size: 0.65em;
            color: #94a3b8;
        }
        
        .btn-connect,
        .btn-profile {
            padding: 4px 10px;
            font-size: 0.75em;
            border: none;
            border-radius: 12px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-connect:hover,
        .btn-profile:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-connect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Connection Panel (Dropdown) */
        .connection-panel {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            width: 400px;
            max-width: 90vw;
            background: rgba(24, 24, 24, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .connection-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-header h6 {
            margin: 0;
            font-size: 0.95em;
            font-weight: 600;
            color: #ffffff;
        }
        
        .panel-status-icon {
            font-size: 1.2em;
        }
        
        /* Connection Steps */
        .connection-step {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .connection-step.pending {
            border-left-color: #94a3b8;
        }
        
        .connection-step.in-progress {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .connection-step.success {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .connection-step.error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .step-icon {
            font-size: 1.2em;
        }
        
        .step-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #ffffff;
        }
        
        .step-description {
            font-size: 0.8em;
            color: #94a3b8;
            margin-left: 32px;
            margin-bottom: 8px;
        }
        
        .step-action {
            margin-left: 32px;
        }
        
        .step-action button {
            padding: 6px 14px;
            font-size: 0.75em;
            border: none;
            border-radius: 6px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .step-action button:hover:not(:disabled) {
            background: #2563eb;
        }
        
        .step-action button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* User Info Panel */
        .user-info-panel {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin: 4px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.85em;
            color: #e2e8f0;
        }
        
        .info-row i {
            color: #3b82f6;
        }
        
        .info-row a {
            color: #3ea6ff;
            text-decoration: none;
        }
        
        .info-row a:hover {
            text-decoration: underline;
        }
        
        .info-row span {
            cursor: pointer;
        }
        
        .info-row span:hover {
            color: #3ea6ff;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stats-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--water-blue);
        }
        
        .stats-card .label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--water-blue), var(--water-dark));
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--water-blue);
            box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.25);
        }
        
        .alert {
            border-radius: 15px;
            border: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #cbd5e0;
            margin-bottom: 1rem;
        }
        
        .permit-card {
            border-left: 4px solid var(--water-blue);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .permit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <!-- Connection Badge (MULTIPASS) -->
    <div id="connectionBadge" class="connection-badge disconnected" onclick="toggleConnectionPanel()" style="position: relative;">
        <div id="connection-badge-content">
            <span class="status-text">‚ö´ Non connect√©</span>
        </div>
        <button class="btn-connect" onclick="event.stopPropagation(); connectMULTIPASS()" id="connectBtn">
            <i class="bi bi-key"></i> Connecter
        </button>
        
        <!-- Connection Panel (Dropdown) -->
        <div id="connectionPanel" class="connection-panel">
            <div class="panel-header">
                <h6 id="panelTitle">√âtat de Connexion</h6>
                <span class="panel-status-icon" id="panelStatusIcon">‚ö´</span>
            </div>
            
            <!-- Step 1: Relay Connection -->
            <div id="step1" class="connection-step pending">
                <div class="step-header">
                    <span class="step-icon">üåê</span>
                    <span class="step-title">1. Connexion au Relay</span>
                </div>
                <div class="step-description" id="step1-desc">Relay NOSTR - Lecture publique</div>
                <div class="step-action">
                    <button onclick="manualConnectRelay()" id="step1-btn">Connecter au Relay</button>
                </div>
            </div>
            
            <!-- Step 2: NIP-42 Authentication -->
            <div id="step2" class="connection-step pending">
                <div class="step-header">
                    <span class="step-icon">üîê</span>
                    <span class="step-title">2. Authentification Personnelle</span>
                </div>
                <div class="step-description" id="step2-desc">NIP-42 Auth - Acc√®s uDRIVE & GPS</div>
                <div class="step-action">
                    <button onclick="connectMULTIPASS()" id="step2-btn" disabled>Authentifier avec MULTIPASS</button>
                    <button onclick="connectMULTIPASS()" id="step2-reauth-btn" style="display: none; margin-left: 8px;" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-arrow-clockwise"></i> R√©-authentifier
                    </button>
                </div>
            </div>
            
            <!-- User Info (After Connection) -->
            <div id="user-info-panel" class="user-info-panel" style="display: none;">
                <div class="info-row">
                    <i class="bi bi-person-circle"></i>
                    <span id="user-pubkey-display" title="Cliquer pour copier">...</span>
                </div>
                <div class="info-row" id="udrive-row" style="display: none;">
                    <i class="bi bi-folder-fill"></i>
                    <a href="#" onclick="openUserDrive(); return false;">Ouvrir uDRIVE</a>
                </div>
                <div class="info-row" id="gps-row" style="display: none;">
                    <i class="bi bi-geo-alt-fill"></i>
                    <span id="gps-coords" title="Coordonn√©es UMAP">...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Permit Selector & New Button -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <label class="form-label"><strong>Choisir une profession :</strong></label>
                        <select class="form-select" id="permitSelector" onchange="switchPermit()">
                            <option value="">Chargement...</option>
                        </select>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success btn-lg w-100" onclick="showNewPermitModal()">
                            <i class="bi bi-plus-circle"></i> Cr√©er une Nouvelle Profession
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Mode Tabs (Local/Global) -->
        <div class="card mb-3" id="viewModeCard" style="display: none;">
            <div class="card-body">
                <ul class="nav nav-tabs" id="viewModeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-view" 
                                type="button" role="tab" onclick="switchViewMode('local')">
                            <i class="bi bi-house-door"></i> Vue Locale
                            <span class="badge bg-primary ms-2" id="local-badge">Cette station</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" id="global-tab-item" style="display: none;">
                        <button class="nav-link" id="global-tab" data-bs-toggle="tab" data-bs-target="#global-view" 
                                type="button" role="tab" onclick="switchViewMode('global')">
                            <i class="bi bi-globe"></i> Vue Globale
                            <span class="badge bg-success ms-2" id="global-badge">Constellation</span>
                            <span class="badge bg-warning ms-1" id="primary-badge" style="display: none;">
                                <i class="bi bi-star-fill"></i> Primaire
                            </span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- All Permits List (similar to oracle.html) -->
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-list-ul"></i> Tous les Permis Disponibles
                    <span id="view-mode-indicator" class="badge bg-info ms-2"></span>
                </h4>
            </div>
            <div class="card-body">
                <div id="all-permits-list" class="row g-4">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 text-muted">Chargement des permis...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hero Section -->
        <div class="hero" id="permitHero">
            <h1>
                <i class="bi bi-mortarboard"></i>
                <span id="permitTitle">√âcole de la Vie - WoTx2</span>
                <span id="permitLevelBadge" class="badge bg-primary ms-2" style="display: none;"></span>
            </h1>
            <p class="lead" id="permitDescription">
                <strong>L'apprentissage d√©centralis√© par la pratique</strong> - Cr√©ez des professions, trouvez des ma√Ætres pr√®s de vous, 
                transf√©rez vos comp√©tences aux apprentis, et d√©couvrez de nouveaux talents. 
                Un syst√®me de certification par les pairs qui remplace √©coles et syndicats traditionnels.
            </p>
            <div id="progressionWorkflow" style="display: none;" class="mt-3">
                <div class="alert alert-info">
                    <h6><i class="bi bi-diagram-3"></i> Workflow de Progression Automatique :</h6>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-warning" style="font-size: 1rem;">X1</div>
                                <p class="small mt-1 mb-0">1 signature</p>
                            </div>
                        </div>
                        <div class="col-md-1 text-center">
                            <i class="bi bi-arrow-right"></i>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-info" style="font-size: 1rem;">X2</div>
                                <p class="small mt-1 mb-0">2 comp√©tences<br>2 signatures</p>
                            </div>
                        </div>
                        <div class="col-md-1 text-center">
                            <i class="bi bi-arrow-right"></i>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-success" style="font-size: 1rem;">X3+</div>
                                <p class="small mt-1 mb-0">Progression continue</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="number" id="totalHolders">0</div>
                        <div class="label">Professionnels Certifi√©s</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="number" id="totalRequests">0</div>
                        <div class="label">Apprentis en Formation</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="number" id="minAttestations">1</div>
                        <div class="label">Attestations Requises</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap Instructions -->
        <div class="card mb-4" id="bootstrapInstructions" style="display: none;">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-seed"></i> Initialisation d'une Nouvelle Profession - Mode Bootstrap
            </div>
            <div class="card-body">
                <h5>Comment d√©marrer une nouvelle profession :</h5>
                <ol>
                    <li><strong>2 personnes</strong> se connectent avec leur <strong>MULTIPASS</strong> (sur 2 navigateurs diff√©rents)</li>
                    <li>Chacun cr√©e sa <strong>demande d'apprentissage</strong> (kind 30501)</li>
                    <li>Chacun <strong>devient ma√Ætre de l'autre</strong> en cr√©ant une <strong>attestation</strong> (kind 30502)</li>
                    <li>Par cette <strong>attestation r√©ciproque</strong>, le syst√®me valide les comp√©tences</li>
                    <li>Les <strong>certificats professionnels</strong> (kind 30503) sont √©mis automatiquement</li>
                    <li>La profession est maintenant <strong>ouverte √† tous</strong> - d'autres peuvent rejoindre comme apprentis ou ma√Ætres</li>
                </ol>
                <div class="alert alert-info mt-3">
                    <i class="bi bi-lightbulb"></i> <strong>Astuce :</strong> C'est le "Block 0" de votre profession - seulement 2 ma√Ætres suffisent pour d√©marrer, puis le syst√®me √©volue naturellement !
                </div>
            </div>
        </div>

        <!-- Virtuous Circle Explanation -->
        <div class="virtuous-circle">
            <h3 class="mb-4">
                <i class="bi bi-arrow-repeat"></i> Le Cercle Vertueux de l'Apprentissage
            </h3>
            <div class="circle-step">
                <i class="bi bi-person-check"></i>
                <div>
                    <strong>L'Apprenti</strong>
                    <p class="mb-0">Cherche un ma√Ætre, apprend par la pratique, et peut devenir ma√Ætre √† son tour</p>
                </div>
            </div>
            <div class="circle-step">
                <i class="bi bi-person-badge"></i>
                <div>
                    <strong>Le Ma√Ætre</strong>
                    <p class="mb-0">Transf√®re ses comp√©tences, d√©couvre de nouveaux talents, et enrichit la profession</p>
                </div>
            </div>
            <div class="circle-step">
                <i class="bi bi-stars"></i>
                <div>
                    <strong>Comp√©tences R√©v√©l√©es</strong>
                    <p class="mb-0">Nouvelles comp√©tences d√©couvertes lors des attestations qui enrichissent la profession</p>
                </div>
            </div>
            <div class="alert alert-success mt-3">
                <i class="bi bi-geo-alt"></i> <strong>G√©olocalisation :</strong> Trouvez des ma√Ætres pr√®s de vous, cr√©ez des r√©seaux locaux d'apprentissage, 
                et d√©centralisez l'√©ducation sans √©coles ni syndicats centralis√©s.
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-md-4">
                <button class="btn btn-primary btn-lg w-100" onclick="showRequestModal()" 
                    data-bs-toggle="tooltip" data-bs-placement="top" 
                    title="L'extension Nostr avec la cl√© de votre MULTIPASS est requise pour la connexion.">
                    <i class="bi bi-person-plus"></i> Devenir Apprenti
                </button>
                <small class="text-muted d-block mt-2 text-center">Cr√©er ma demande d'apprentissage</small>
            </div>
            <div class="col-md-4">
                <button class="btn btn-success btn-lg w-100" onclick="loadInstructors()">
                    <i class="bi bi-search"></i> Trouver un Ma√Ætre
                </button>
                <small class="text-muted d-block mt-2 text-center">Voir les professionnels certifi√©s</small>
            </div>
            <div class="col-md-4">
                <button class="btn btn-warning btn-lg w-100" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                </button>
                <small class="text-muted d-block mt-2 text-center">Recharger les donn√©es</small>
            </div>
        </div>

        <!-- Instructors List -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-people"></i> Ma√Ætres Certifi√©s - Pr√™ts √† Enseigner
            </div>
            <div class="card-body" id="instructorsList">
                <div class="empty-state">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Chargement des ma√Ætres...</p>
                </div>
            </div>
        </div>

        <!-- Pending Requests -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Apprentis Cherchant un Ma√Ætre
            </div>
            <div class="card-body" id="pendingRequestsList">
                <div class="empty-state">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Chargement des apprentis...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Permit Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus"></i> Devenir Apprenti - Cr√©er ma Demande d'Apprentissage
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="requestForm">
                        <div class="mb-3">
                            <label class="form-label"><strong>Choisir la profession :</strong> <span class="text-danger">*</span></label>
                            <select class="form-select" id="requestPermitSelect" required onchange="updateRequestAttestationsInfo(this.value)">
                                <option value="">-- S√©lectionner une profession --</option>
                            </select>
                            <small class="text-muted">S√©lectionnez la profession pour laquelle vous souhaitez cr√©er une demande d'apprentissage</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Votre d√©claration d'apprentissage <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="statement" rows="4" 
                                placeholder="D√©crivez pourquoi vous souhaitez apprendre cette profession, votre motivation, et ce que vous apporterez √† la communaut√©..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comp√©tence r√©clam√©e <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="requestedCompetency" 
                                placeholder="Ex: Natation, Sauvetage, Aqua-fitness..." required>
                            <small class="text-muted">Indiquez la comp√©tence principale que vous souhaitez acqu√©rir dans cette profession</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Preuves de motivation (liens IPFS, photos, r√©alisations)</label>
                            <input type="text" class="form-control" id="evidence" 
                                placeholder="ipfs://Qm... (optionnel)">
                            <small class="text-muted">Vous pouvez ajouter plusieurs liens s√©par√©s par des virgules</small>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Workflow de validation :</strong>
                            <ol class="mb-0 mt-2">
                                <li>Vous cr√©ez cette demande (30501) avec votre comp√©tence r√©clam√©e</li>
                                <li>Votre demande appara√Æt dans "Apprentis Cherchant un Ma√Ætre"</li>
                                <li>Un ma√Ætre certifi√© vous atteste (30502) - <strong id="requestRequiredAttestations">1</strong> attestation(s) requise(s)</li>
                                <li>ORACLE.refresh.sh valide et √©met votre credential (30503)</li>
                                <li>Votre demande dispara√Æt et vous apparaissez dans "Ma√Ætres Certifi√©s"</li>
                            </ol>
                            <p class="mb-0 mt-2"><strong>Note :</strong> Pour les professions auto-proclam√©es (PERMIT_PROFESSION_X1), le syst√®me cr√©era automatiquement le niveau X2 apr√®s validation du X1.</p>
                            <p class="mb-0 mt-2"><small><strong>G√©olocalisation :</strong> Votre position sera enregistr√©e pour que les ma√Ætres pr√®s de vous puissent vous trouver.</small></p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="submitRequest()">
                        <i class="bi bi-send"></i> Cr√©er ma Demande d'Apprentissage
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Permit Modal -->
    <div class="modal fade" id="newPermitModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> Cr√©er une Nouvelle Profession WoTx2
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Profession Auto-Proclam√©e :</strong> Si aucun permit n'existe pour votre profession, 
                        vous pouvez cr√©er une profession auto-proclam√©e qui d√©marrera au niveau X1 (1 signature requise).
                        Le syst√®me √©voluera automatiquement vers X2, X3, etc. au fur et √† mesure des validations.
                    </div>
                    
                    <form id="newPermitForm">
                        <div class="mb-3">
                            <label class="form-label">
                                <input type="checkbox" id="autoProclaimedPermit" checked onchange="togglePermitType()">
                                <strong>Profession Auto-Proclam√©e</strong> (ID g√©n√©r√© automatiquement)
                            </label>
                            <small class="text-muted d-block mt-1">
                                L'ID sera calcul√© automatiquement : <code id="autoPermitIdPreview">PERMIT_PROFESSION_X1</code>
                            </small>
                        </div>
                        
                        <div class="mb-3" id="manualPermitIdSection" style="display: none;">
                            <label class="form-label">ID du Permit <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newPermitId" 
                                placeholder="PERMIT_EXAMPLE"
                                pattern="^PERMIT_[A-Z0-9_]+$"
                                title="Format: PERMIT_MAJUSCULES_UNDERSCORES">
                            <small class="text-muted">Format: PERMIT_MAJUSCULES_UNDERSCORES (ex: PERMIT_DE_NAGER)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nom de la Profession <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newPermitName" 
                                placeholder="Ex: Ma√Ætre Nageur" required
                                oninput="updateAutoPermitId()">
                            <small class="text-muted">Ce nom sera utilis√© pour g√©n√©rer l'ID si "Profession Auto-Proclam√©e" est coch√©</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="newPermitDescription" rows="3" 
                                placeholder="D√©crivez cette profession en quelques mots..." required></textarea>
                        </div>
                        
                        <div class="alert alert-success">
                            <i class="bi bi-lightbulb"></i> 
                            <strong>Niveau X1 - D√©marrage :</strong> 
                            <ul class="mb-0 mt-2">
                                <li>1 signature requise pour valider le niveau X1</li>
                                <li>Apr√®s validation, le syst√®me cr√©era automatiquement le niveau X2 (2 comp√©tences, 2 signatures)</li>
                                <li>Puis X3, X4... avec progression automatique</li>
                            </ul>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success" onclick="submitNewPermit()">
                        <i class="bi bi-check-circle"></i> Cr√©er le Permit (30500)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attestation Modal -->
    <div class="modal fade" id="attestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> Attester une Demande - Transf√©rer vos Comp√©tences
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="attestForm">
                        <div class="mb-3">
                            <label class="form-label">Votre d√©claration d'attestation</label>
                            <textarea class="form-control" id="attestStatement" rows="4" 
                                placeholder="Je certifie que cette personne poss√®de les comp√©tences n√©cessaires..."></textarea>
                        </div>
                        
                        <!-- Competencies Selection (if holder has 30503) -->
                        <div class="mb-3" id="competenciesTransferSection" style="display: none;">
                            <label class="form-label">
                                <i class="bi bi-list-check"></i> Comp√©tences √† transf√©rer
                            </label>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                S√©lectionnez les comp√©tences que vous souhaitez transf√©rer √† cet apprenti. 
                                Ces comp√©tences seront ajout√©es √† son credential 30503.
                            </div>
                            <div id="competenciesCheckboxes" class="mb-3">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nouvelles comp√©tences r√©v√©l√©es (optionnel)</label>
                            <input type="text" class="form-control" id="revealedCompetencies" 
                                placeholder="Ex: Natation synchronis√©e, Sauvetage en eau vive, Aqua-fitness...">
                            <small class="text-muted">D√©crivez les comp√©tences suppl√©mentaires que vous avez observ√©es (seront ajout√©es au syst√®me)</small>
                        </div>
                        
                        <!-- Geolocation -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-geo-alt"></i> G√©olocalisation (optionnel)
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="attestLatitude" 
                                        step="0.000001" placeholder="Latitude">
                                </div>
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="attestLongitude" 
                                        step="0.000001" placeholder="Longitude">
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="getCurrentLocation()">
                                <i class="bi bi-crosshair"></i> Utiliser ma position actuelle
                            </button>
                            <small class="text-muted d-block mt-1">
                                Permet de d√©centraliser √©coles et syndicats - trouver des ma√Ætres pr√®s de vous
                            </small>
                        </div>
                        
                        <input type="hidden" id="attestRequestId">
                        <input type="hidden" id="attestApplicantNpub">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success" onclick="submitAttestation()">
                        <i class="bi bi-check-circle"></i> Attester & Transf√©rer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.bundle.min.js"></script>
    
    <!-- NostrTools Bundle (required for common.js) -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js"></script>
    
    <!-- Common.js - UPlanet NOSTR utilities -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/common.js"></script>
    
    <script>
        const uSPOT = "{{ uSPOT }}";
        const myIPFS = "{{ myIPFS }}";
        const IPFSNODEID = "{{ IPFSNODEID }}";  // IPFS Node ID for filtering events by Astroport
        const isPrimaryStation = {{ is_primary_station | tojson }};  // True if this is the primary station (ORACLE des ORACLES)
        // Variables will be set by common.js (userPubkey, nostrRelay, isNostrConnected)
        // We use local aliases for compatibility
        let userHEX = null;  // Will be set from userPubkey (common.js)
        let relay = null;     // Will be set from nostrRelay (common.js)
        // Permit data from server (only 30500 definitions)
        const permitDataRaw = {{ permit_data | tojson }};
        let permitData = permitDataRaw || {};
        // All permits list (from 30500 events)
        const allPermitsRaw = {{ all_permits | tojson }};
        const allPermits = allPermitsRaw || [];
        let selectedPermitId = "{{ selected_permit_id }}" || "PERMIT_DE_NAGER";
        
        // View mode: 'local' (this station only) or 'global' (all stations in constellation)
        let viewMode = 'local';  // Default to local view
        
        // Data loaded from Nostr (30501 requests, 30502 attestations, 30503 credentials)
        let permitRequests = [];  // kind 30501
        let permitCredentials = [];  // kind 30503

        // Wait for NOSTR functions to load from common.js
        async function waitForNostrFunctions() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (typeof connectToRelay === 'function' && typeof connectNostr === 'function') {
                        clearInterval(checkInterval);
                        console.log('[WoTx2] ‚úÖ NOSTR functions loaded from common.js');
                        resolve();
                    }
                }, 100);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    clearInterval(checkInterval);
                    console.warn('[WoTx2] ‚ö†Ô∏è Timeout waiting for NOSTR functions');
                    resolve();
                }, 10000);
            });
        }
        
        // Auto-connect to relay (public read access)
        async function autoConnectRelay() {
            try {
                console.log('[WoTx2] üåê Connecting to NOSTR relay...');
                updateStep(1, 'in-progress', 'Connexion au relay en cours...');
                
                if (typeof connectToRelay === 'function') {
                    await connectToRelay();
                    // Update local relay reference from common.js global
                    if (typeof nostrRelay !== 'undefined') {
                        relay = nostrRelay;
                    }
                    console.log('[WoTx2] ‚úÖ Connected to relay');
                    updateStep(1, 'success', 'Connect√© au relay NOSTR');
                    // Enable step 2
                    const step2Btn = document.getElementById('step2-btn');
                    if (step2Btn) {
                        step2Btn.disabled = false;
                    }
                    return true;
                } else {
                    console.warn('[WoTx2] ‚ö†Ô∏è connectToRelay function not available');
                    updateStep(1, 'error', 'Fonction connectToRelay non disponible');
                    return false;
                }
            } catch (error) {
                console.error('[WoTx2] ‚ùå Relay connection failed:', error);
                updateStep(1, 'error', 'Erreur de connexion au relay');
                return false;
            }
        }
        
        // Auto-connect user
        async function autoConnectUser() {
            try {
                console.log('[WoTx2] üîê Auto-connecting user...');
                updateStep(2, 'in-progress', 'Authentification en cours...');
                
                // Try to get pubkey from extension (no forced NIP-42 initially)
                if (typeof connectNostr === 'function') {
                    const pubkey = await connectNostr(false); // No force NIP-42
                    
                    if (pubkey) {
                        userHEX = pubkey;
                        // Update from common.js global if available
                        if (typeof userPubkey !== 'undefined') {
                            userHEX = userPubkey;
                        }
                        console.log('[WoTx2] ‚úÖ User pubkey retrieved:', userHEX.substring(0, 12) + '...');
                        updateStep(2, 'success', 'Authentifi√© avec MULTIPASS');
                        updateConnectionBadge(true, userHEX);
                        return true;
                    } else {
                        updateStep(2, 'pending', 'NIP-42 Auth - Acc√®s uDRIVE & GPS');
                    }
                }
                return false;
            } catch (error) {
                console.error('[WoTx2] ‚ùå User auto-connect failed:', error);
                updateStep(2, 'error', 'Erreur d\'authentification');
                return false;
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for common.js to load
            await waitForNostrFunctions();
            
            // Initialize view mode tabs
            initializeViewModeTabs();
            
            // Close connection panel when clicking outside
            document.addEventListener('click', function(event) {
                const badge = document.getElementById('connectionBadge');
                const panel = document.getElementById('connectionPanel');
                if (panel && badge && !badge.contains(event.target) && !panel.contains(event.target)) {
                    panel.classList.remove('show');
                }
            });
            
            // Step 1: Auto-connect to relay (public read access)
            const relayConnected = await autoConnectRelay();
            
            if (relayConnected) {
                // Step 2: Check for saved user and try auto-connect
                const savedPubkey = localStorage.getItem('nostr_pubkey');
                if (savedPubkey && typeof window.nostr !== 'undefined') {
                    console.log('[WoTx2] üîê Found saved pubkey, attempting auto-connect...');
                    await autoConnectUser();
                } else {
                    // Try to connect anyway
                    await autoConnectUser();
                }
                
                // Load data from Nostr
                await loadNostrData();
            }
            
            // Load UI components
            loadPermitSelector();
            
            // Always call loadData to initialize UI, even if relay is not connected
            loadData();
            
            // If relay is connected, loadNostrData will update the UI
            // If not connected, loadData will show empty states
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
        
        // Switch view mode (local/global)
        async function switchViewMode(mode) {
            viewMode = mode;
            
            // Update tab active state
            document.getElementById('local-tab').classList.toggle('active', mode === 'local');
            document.getElementById('global-tab').classList.toggle('active', mode === 'global');
            
            // Update view mode indicator
            const indicator = document.getElementById('view-mode-indicator');
            if (indicator) {
                if (mode === 'local') {
                    indicator.textContent = 'Vue Locale';
                    indicator.className = 'badge bg-primary ms-2';
                } else {
                    indicator.textContent = 'Vue Globale (Constellation)';
                    indicator.className = 'badge bg-success ms-2';
                }
            }
            
            // Reload data with new filters
            if (permitData && permitData.id) {
                await loadNostrData();
                loadData();
            }
            
            // Reload permits list
            await renderAllPermitsList();
        }
        
        // Initialize view mode tabs
        function initializeViewModeTabs() {
            const viewModeCard = document.getElementById('viewModeCard');
            const globalTabItem = document.getElementById('global-tab-item');
            const primaryBadge = document.getElementById('primary-badge');
            const viewModeIndicator = document.getElementById('view-mode-indicator');
            
            if (!viewModeCard) return;
            
            // Show tabs if primary station or if we want to show global view option
            // For now, only show global tab if primary station
            if (isPrimaryStation) {
                viewModeCard.style.display = 'block';
                if (globalTabItem) {
                    globalTabItem.style.display = 'block';
                }
                if (primaryBadge) {
                    primaryBadge.style.display = 'inline-block';
                }
                console.log('[WoTx2] ‚≠ê Primary station detected - Global view enabled');
            } else {
                // Hide global tab for non-primary stations
                viewModeCard.style.display = 'none';
                if (globalTabItem) {
                    globalTabItem.style.display = 'none';
                }
                console.log('[WoTx2] Standard station - Local view only');
            }
            
            // Update view mode indicator
            if (viewModeIndicator) {
                viewModeIndicator.textContent = 'Vue Locale';
                viewModeIndicator.className = 'badge bg-primary ms-2';
            }
        }
        
        // Load data from Nostr (30501 requests, 30502 attestations, 30503 credentials)
        async function loadNostrData() {
            if (!permitData || !permitData.id) {
                // Even if no permit data, show empty state
                loadInstructors();
                loadPendingRequests(1);
                return;
            }
            
            try {
                // Build filters - only filter by IPFSNODEID in local mode
                const requestFilters = {
                    '#l': [permitData.id, 'permit_type']
                };
                if (viewMode === 'local' && IPFSNODEID) {
                    requestFilters['#ipfs_node'] = [IPFSNODEID];
                }
                // In global mode, don't filter by IPFSNODEID (get all events from constellation)
                
                // Load permit requests (kind 30501) for selected permit
                const requests = await fetchNostrEvents(30501, requestFilters);
                permitRequests = requests.map(parsePermitRequest).filter(r => r !== null);
                
                // Build filters for credentials
                const credentialFilters = {
                    '#l': [permitData.id, 'permit_type']
                };
                if (viewMode === 'local' && IPFSNODEID) {
                    credentialFilters['#ipfs_node'] = [IPFSNODEID];
                }
                // In global mode, don't filter by IPFSNODEID
                
                // Load permit credentials (kind 30503) for selected permit
                const credentials = await fetchNostrEvents(30503, credentialFilters);
                permitCredentials = credentials.map(parsePermitCredential).filter(c => c !== null);
                
                // Calculate required attestations
                const requiredAttestations = permitData.min_attestations || 1;
                
                // Update UI
                loadInstructors();
                loadPendingRequests(requiredAttestations);
            } catch (e) {
                console.error('Error loading Nostr data:', e);
                // Even on error, show empty state
                permitRequests = [];
                permitCredentials = [];
                loadInstructors();
                loadPendingRequests(permitData?.min_attestations || 1);
            }
        }
        
        // Fetch events from Nostr relay (using common.js nostrRelay)
        async function fetchNostrEvents(kind, filters = {}) {
            // Use nostrRelay from common.js if available
            if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                return new Promise((resolve) => {
                    const events = [];
                    let resolved = false;
                    let sub = null;
                    
                    const closeSubscription = () => {
                        if (sub) {
                            try {
                                if (typeof sub.unsub === 'function') {
                                    sub.unsub();
                                } else if (typeof sub.close === 'function') {
                                    sub.close();
                                }
                            } catch (e) {
                                console.warn('Error closing subscription:', e);
                            }
                        }
                    };
                    
                    try {
                        // Try with callbacks first (if supported)
                        if (typeof nostrRelay.sub === 'function') {
                            try {
                                sub = nostrRelay.sub([{ kind, ...filters }], {
                            onevent: (event) => {
                                events.push(event);
                            },
                            oneose: () => {
                                        if (!resolved) {
                                            resolved = true;
                                            closeSubscription();
                                resolve(events);
                            }
                                    }
                        });
                            } catch (e) {
                                // If callback syntax fails, try without callbacks and use .on()
                                console.log('[WoTx2] Callback syntax not supported, trying .on() syntax');
                                sub = nostrRelay.sub([{ kind, ...filters }]);
                                
                                if (sub && typeof sub.on === 'function') {
                                    sub.on('event', (event) => {
                                        events.push(event);
                                    });
                                    
                                    sub.on('eose', () => {
                                        if (!resolved) {
                                            resolved = true;
                                            closeSubscription();
                                            resolve(events);
                                        }
                                    });
                                } else {
                                    // Fallback: just wait for timeout
                                    console.warn('[WoTx2] Subscription object does not support .on() method');
                                }
                            }
                        }
                        
                        // Timeout after 3 seconds
                        setTimeout(() => {
                            if (!resolved) {
                                resolved = true;
                                closeSubscription();
                            resolve(events);
                            }
                        }, 3000);
                    } catch (e) {
                        console.error('Error fetching events:', e);
                        if (!resolved) {
                            resolved = true;
                            closeSubscription();
                        resolve(events);
                        }
                    }
                });
            } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                // Fallback: Use user's configured relays
                try {
                    const relays = await window.nostr.getRelays();
                    const relayUrls = Object.keys(relays);
                    
                    if (relayUrls.length === 0) {
                        console.warn('No relays configured, cannot fetch events');
                        return [];
                    }
                    
                    const events = [];
                    for (const relayUrl of relayUrls) {
                        try {
                            const relay = new Relay(relayUrl);
                            await relay.connect();
                            const sub = relay.subscribe([{ kind, ...filters }], {
                                onevent: (event) => events.push(event),
                                oneose: () => relay.close()
                            });
                            await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2s for events
                            relay.close();
                        } catch (e) {
                            console.warn(`Failed to fetch from ${relayUrl}:`, e);
                        }
                    }
                    return events;
                } catch (e) {
                    console.error('Error fetching from user relays:', e);
                    return [];
                }
            }
            return [];
        }
        
        // Parse permit request event (kind 30501)
        function parsePermitRequest(event) {
            try {
                const content = JSON.parse(event.content);
                return {
                    id: content.request_id || event.id,
                    applicant_npub: event.pubkey,
                    permit_definition_id: content.permit_definition_id,
                    statement: content.statement,
                    requested_competency: content.requested_competency || null, // Competency claimed
                    evidence: content.evidence || [],
                    status: content.status || 'pending',
                    created_at: new Date(event.created_at * 1000).toISOString(),
                    event_id: event.id,
                    attestations_count: 0  // Will be calculated from 30502 events
                };
            } catch (e) {
                console.error('Error parsing permit request:', e);
                return null;
            }
        }
        
        // Parse permit credential event (kind 30503)
        function parsePermitCredential(event) {
            try {
                const content = JSON.parse(event.content);
                return {
                    id: content.credential_id || event.id,
                    holder_npub: content.holder_npub || event.pubkey,
                    permit_definition_id: content.permit_definition_id,
                    issued_at: content.issued_at,
                    expires_at: content.expires_at,
                    attestations_count: content.attestations || 0,
                    event_id: event.id
                };
            } catch (e) {
                console.error('Error parsing permit credential:', e);
                return null;
            }
        }
        
        // Count attestations for a request (kind 30502)
        async function countAttestations(requestId) {
            const filters = {
                '#e': [requestId]
            };
            // Only filter by IPFSNODEID in local mode
            if (viewMode === 'local' && IPFSNODEID) {
                filters['#ipfs_node'] = [IPFSNODEID];
            }
            const attestations = await fetchNostrEvents(30502, filters);
            return attestations.length;
        }

        // MULTIPASS Connection using common.js (similar to youtube.html)
        async function checkMULTIPASSConnection() {
            try {
                // Use common.js connectNostr if available
                if (typeof connectNostr === 'function') {
                    try {
                        const pubkey = await connectNostr(false); // No force NIP-42 initially
                        if (pubkey) {
                            userHEX = pubkey;
                            // Sync with common.js global
                            if (typeof userPubkey !== 'undefined') {
                                userHEX = userPubkey;
                            }
                            updateConnectionBadge(true, userHEX);
                            return;
                        }
                    } catch (e) {
                        console.log('common.js connectNostr failed:', e);
                    }
                }
                
                // Fallback: Check if window.nostr is available
                if (window.nostr) {
                    try {
                        userHEX = await window.nostr.getPublicKey();
                        if (userHEX) {
                            updateConnectionBadge(true, userHEX);
                            return;
                        }
                    } catch (e) {
                        console.log('NOSTR extension not connected');
                    }
                }
                
                // Check URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const npubParam = urlParams.get('npub');
                if (npubParam) {
                    userHEX = npubParam;
                    updateConnectionBadge(true, npubParam);
                    return;
                }
                
                updateConnectionBadge(false, null);
            } catch (e) {
                console.error('Error checking MULTIPASS:', e);
                updateConnectionBadge(false, null);
            }
        }

        function updateConnectionBadge(authenticated, npub) {
            const badge = document.getElementById('connectionBadge');
            const content = document.getElementById('connection-badge-content');
            const connectBtn = document.getElementById('connectBtn');
            const panelStatusIcon = document.getElementById('panelStatusIcon');
            
            if (!badge || !content) return;
            
            // Remove all state classes
            badge.className = 'connection-badge';
            
            if (authenticated && npub) {
                badge.classList.add('authenticated');
                content.innerHTML = `
                    <span class="status-text">‚úÖ Authentifi√©</span>
                    <span class="user-npub">${npub.substring(0, 12)}...</span>
                `;
                // Replace connect button with profile button
                if (connectBtn) {
                    connectBtn.outerHTML = `
                        <button class="btn-profile" onclick="event.stopPropagation(); openUserProfile()">
                            <i class="bi bi-person-circle"></i>
                        </button>
                    `;
                }
                if (panelStatusIcon) {
                    panelStatusIcon.textContent = '‚úÖ';
                }
                // Update user info panel
                updateUserInfoPanel(npub);
            } else {
                badge.classList.add('disconnected');
                content.innerHTML = `
                    <span class="status-text">‚ö´ Non connect√©</span>
                `;
                // Restore connect button if it was replaced
                const profileBtn = badge.querySelector('.btn-profile');
                if (profileBtn) {
                    profileBtn.outerHTML = `
                        <button class="btn-connect" onclick="event.stopPropagation(); connectMULTIPASS()" id="connectBtn">
                            <i class="bi bi-key"></i> Connecter
                        </button>
                    `;
                } else if (connectBtn) {
                    connectBtn.style.display = 'block';
                    connectBtn.disabled = false;
                }
                if (panelStatusIcon) {
                    panelStatusIcon.textContent = '‚ö´';
                }
                // Hide user info panel
                const userInfoPanel = document.getElementById('user-info-panel');
                if (userInfoPanel) {
                    userInfoPanel.style.display = 'none';
                }
            }
        }
        
        // Toggle connection panel
        function toggleConnectionPanel() {
            const panel = document.getElementById('connectionPanel');
            if (panel) {
                panel.classList.toggle('show');
            }
        }
        
        // Update step status
        function updateStep(stepNum, status, description) {
            const step = document.getElementById(`step${stepNum}`);
            const desc = document.getElementById(`step${stepNum}-desc`);
            const btn = document.getElementById(`step${stepNum}-btn`);
            const reauthBtn = document.getElementById(`step${stepNum}-reauth-btn`);
            
            if (!step || !desc) return;
            
            // Remove all status classes
            step.className = 'connection-step';
            
            // Add new status
            step.classList.add(status);
            
            // Update description
            desc.textContent = description;
            
            // Update button state
            if (btn) {
                if (status === 'success') {
                    if (stepNum === 2) {
                        btn.disabled = true;
                        btn.textContent = '‚úì Termin√©';
                        if (reauthBtn) {
                            reauthBtn.style.display = 'inline-block';
                        }
                    } else {
                        btn.disabled = true;
                        btn.textContent = '‚úì Termin√©';
                    }
                } else if (status === 'in-progress') {
                    btn.disabled = true;
                    btn.textContent = '‚è≥ En cours...';
                    if (reauthBtn) {
                        reauthBtn.style.display = 'none';
                    }
                } else if (status === 'error') {
                    btn.disabled = false;
                    btn.textContent = 'R√©essayer';
                    if (reauthBtn) {
                        reauthBtn.style.display = 'none';
                    }
                } else {
                    // pending
                    btn.disabled = stepNum === 2;
                    btn.textContent = stepNum === 1 ? 'Connecter au Relay' : 'Authentifier avec MULTIPASS';
                    if (reauthBtn) {
                        reauthBtn.style.display = 'none';
                    }
                }
            }
        }
        
        // Update user info panel
        async function updateUserInfoPanel(npub) {
            const userInfoPanel = document.getElementById('user-info-panel');
            const pubkeyDisplay = document.getElementById('user-pubkey-display');
            const udriveRow = document.getElementById('udrive-row');
            const gpsRow = document.getElementById('gps-row');
            const gpsCoords = document.getElementById('gps-coords');
            
            if (!userInfoPanel || !pubkeyDisplay) return;
            
            // Show panel
            userInfoPanel.style.display = 'block';
            
            // Update pubkey display
            pubkeyDisplay.textContent = npub;
            pubkeyDisplay.onclick = () => {
                navigator.clipboard.writeText(npub).then(() => {
                    alert('‚úÖ Cl√© publique copi√©e !');
                });
            };
            
            // Try to get email from npub
            const email = await getEmailFromNpub(npub);
            if (email) {
                // Show uDRIVE link
                if (udriveRow) {
                    udriveRow.style.display = 'flex';
                }
                
                // Try to get GPS/UMAP info
                try {
                    const gpsInfo = await getGPSInfo(email);
                    if (gpsInfo && gpsRow && gpsCoords) {
                        gpsRow.style.display = 'flex';
                        gpsCoords.textContent = `UMAP: ${gpsInfo.latitude}, ${gpsInfo.longitude}`;
                    }
                } catch (e) {
                    console.log('GPS info not available:', e);
                }
            }
        }
        
        // Get email from npub (helper function)
        async function getEmailFromNpub(npub) {
            // Try to use common.js function if available
            if (typeof getEmailFromPubkey === 'function') {
                try {
                    return await getEmailFromPubkey(npub);
                } catch (e) {
                    console.log('getEmailFromPubkey error:', e);
                }
            }
            
            // Fallback: try to get from localStorage or URL
            const savedEmail = localStorage.getItem('user_email');
            if (savedEmail) {
                return savedEmail;
            }
            
            return null;
        }
        
        // Get GPS info (helper function)
        async function getGPSInfo(email) {
            if (!email) return null;
            
            // Try to get GPS from common.js if available
            if (typeof getUserGPS === 'function') {
                try {
                    return await getUserGPS(email);
                } catch (e) {
                    console.log('getUserGPS error:', e);
                }
            }
            
            // Try to get from localStorage
            const savedGPS = localStorage.getItem(`gps_${email}`);
            if (savedGPS) {
                try {
                    return JSON.parse(savedGPS);
                } catch (e) {
                    console.log('Error parsing saved GPS:', e);
                }
            }
            
            return null;
        }
        
        // Open user drive
        function openUserDrive() {
            if (!userHEX) {
                alert('‚ùå Non connect√©');
                return;
            }
            
            // Try to get email from npub
            getEmailFromNpub(userHEX).then(email => {
                if (email) {
                    const udriveUrl = `${myIPFS}/ipns/${email}/APP/uDRIVE`;
                    console.log('[WoTx2] üìÅ Opening uDRIVE:', udriveUrl);
                    window.open(udriveUrl, '_blank');
                } else {
                    alert('‚ùå Impossible de trouver votre uDRIVE');
                }
            });
        }
        
        // Open user profile
        function openUserProfile() {
            if (!userHEX) {
                alert('‚ùå Non connect√©');
                return;
            }
            
            // Open profile in new window using common.js if available
            if (typeof openProfileModal === 'function') {
                openProfileModal(userHEX, 'Mon Profil');
            } else {
                // Fallback: open in new tab
                const profileUrl = `${myIPFS}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${userHEX}`;
                window.open(profileUrl, '_blank');
            }
        }
        
        // Manual connect relay
        async function manualConnectRelay() {
            updateStep(1, 'in-progress', 'Connexion au relay en cours...');
            try {
                if (typeof connectToRelay === 'function') {
                    await connectToRelay();
                    if (typeof nostrRelay !== 'undefined') {
                        relay = nostrRelay;
                    }
                    updateStep(1, 'success', 'Connect√© au relay NOSTR');
                    // Enable step 2
                    const step2Btn = document.getElementById('step2-btn');
                    if (step2Btn) {
                        step2Btn.disabled = false;
                    }
                } else {
                    throw new Error('connectToRelay function not available');
                }
            } catch (error) {
                console.error('Error connecting to relay:', error);
                updateStep(1, 'error', 'Erreur de connexion au relay');
            }
        }

        async function connectMULTIPASS() {
            // Ensure relay connection first
            if (!isNostrConnected || !nostrRelay) {
                updateStep(1, 'in-progress', 'Connexion au relay en cours...');
                if (typeof connectToRelay === 'function') {
                    try {
                        await connectToRelay();
                        // Update local relay reference
                        if (typeof nostrRelay !== 'undefined') {
                            relay = nostrRelay;
                        }
                        updateStep(1, 'success', 'Connect√© au relay NOSTR');
                    } catch (error) {
                        console.error('Error connecting to relay:', error);
                        updateStep(1, 'error', 'Erreur de connexion au relay');
                        alert('‚ùå Erreur lors de la connexion au relay.');
                        return;
                    }
                }
            }
            
            // Update step 2 to in-progress
            updateStep(2, 'in-progress', 'Authentification NIP-42 en cours...');
            
            // Use common.js connectNostr if available
            if (typeof connectNostr === 'function') {
                try {
                    const pubkey = await connectNostr(true); // forceAuth = true (NIP-42)
                    if (pubkey) {
                        userHEX = pubkey;
                        // Sync with common.js global
                        if (typeof userPubkey !== 'undefined') {
                            userHEX = userPubkey;
                        }
                        localStorage.setItem('nostr_pubkey', userHEX);
                        updateStep(2, 'success', 'Authentifi√© avec MULTIPASS');
                        updateConnectionBadge(true, userHEX);
                        
                        // Update URL with npub
                        const url = new URL(window.location);
                        url.searchParams.set('npub', userHEX);
                        window.history.pushState({}, '', url);
                        
                        // Reload data after connection
                        setTimeout(async () => {
                            await loadNostrData();
                            loadData();
                        }, 500);
                    } else {
                        updateStep(2, 'error', 'Connexion requise');
                        alert('‚ùå Connexion requise. Veuillez vous connecter avec NOSTR.');
                    }
                } catch (e) {
                    console.error('common.js connection error:', e);
                    updateStep(2, 'error', 'Erreur d\'authentification');
                    alert('Erreur de connexion MULTIPASS: ' + e.message);
                }
            } else if (window.nostr) {
                // Fallback to direct nostr extension
                try {
                    userHEX = await window.nostr.getPublicKey();
                    if (userHEX) {
                        localStorage.setItem('nostr_pubkey', userHEX);
                        updateStep(2, 'success', 'Connect√© avec extension NOSTR');
                        updateConnectionBadge(true, userHEX);
                        // Update URL with npub
                        const url = new URL(window.location);
                        url.searchParams.set('npub', userHEX);
                        window.history.pushState({}, '', url);
                    }
                } catch (e) {
                    updateStep(2, 'error', 'Erreur de connexion');
                    alert('Erreur de connexion MULTIPASS: ' + e.message);
                }
            } else {
                updateStep(2, 'error', 'Extension NOSTR non trouv√©e');
                alert('Extension NOSTR non trouv√©e. Installez une extension NOSTR pour vous connecter.');
            }
        }

        // Load permit data
        function loadData() {
            if (permitData && permitData.id) {
                // Check if bootstrap mode (no holders yet)
                const totalHolders = permitCredentials?.length || 0;
                const isBootstrap = totalHolders === 0;
                
                // WoTx2: Start with 1 attestation minimum, grows with competencies
                // Each level (x1, x2, x3, x4) adds competencies via 30502
                let requiredAttestations = permitData.min_attestations || 1;
                
                // Count competencies from all credentials (30503) to determine current level
                const allCompetencies = new Set();
                if (permitCredentials && permitCredentials.length > 0) {
                permitCredentials.forEach(cred => {
                        try {
                            const credContent = typeof cred.content === 'string' ? JSON.parse(cred.content) : cred.content || {};
                    const competencies = credContent.credentialSubject?.competencies || [];
                    competencies.forEach(c => allCompetencies.add(c));
                        } catch (e) {
                            console.warn('Error parsing credential content:', e);
                        }
                });
                }
                
                // If competencies exist, require more attestations (1 per competency, minimum 1)
                if (allCompetencies.size > 0) {
                    requiredAttestations = Math.max(1, allCompetencies.size);
                }
                
                // Update stats (use data from Nostr)
                const totalHoldersEl = document.getElementById('totalHolders');
                const totalRequestsEl = document.getElementById('totalRequests');
                const minAttestationsEl = document.getElementById('minAttestations');
                const requiredAttestationsEl = document.getElementById('requiredAttestations');
                
                if (totalHoldersEl) totalHoldersEl.textContent = permitCredentials?.length || 0;
                if (totalRequestsEl) totalRequestsEl.textContent = permitRequests?.length || 0;
                if (minAttestationsEl) minAttestationsEl.textContent = requiredAttestations;
                if (requiredAttestationsEl) requiredAttestationsEl.textContent = requiredAttestations;
                
                // Show bootstrap indicator if applicable
                if (isBootstrap) {
                    const statsCard = document.querySelector('.stats-card:last-child');
                    if (statsCard) {
                        statsCard.innerHTML = `
                            <div class="number" id="minAttestations">${requiredAttestations}</div>
                            <div class="label">Attestations requises <span class="badge bg-warning">Bootstrap</span></div>
                        `;
                    }
                    // Show bootstrap instructions
                    const bootstrapInstructions = document.getElementById('bootstrapInstructions');
                    if (bootstrapInstructions) {
                        bootstrapInstructions.style.display = 'block';
                    }
                }
                
                // Load instructors (from Nostr 30503) - always call to update UI
                loadInstructors();
                
                // Load pending requests (from Nostr 30501) - always call to update UI
                loadPendingRequests(requiredAttestations);
            } else {
                // No permit data, show empty states
                loadInstructors();
                loadPendingRequests(1);
            }
        }

        function loadInstructors() {
            const listEl = document.getElementById('instructorsList');
            if (!listEl) return;
            
            // Ensure permitCredentials is initialized
            if (!permitCredentials) {
                permitCredentials = [];
            }
            
            // Use credentials from Nostr (30503)
            if (permitCredentials.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-people"></i>
                        <p><strong>0</strong> professionnel certifi√© pour le moment.</p>
                        <p class="text-muted">Soyez le premier √† obtenir le permis !</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            permitCredentials.forEach(holder => {
                // Check if this permit is auto-proclaimed and get level
                const permit = allPermits.find(p => p.id === holder.permit_definition_id);
                const levelMatch = holder.permit_definition_id?.match(/_X(\d+)$/);
                const levelBadge = levelMatch ? `<span class="badge bg-primary ms-2">Niveau ${levelMatch[1]}</span>` : '';
                
                html += `
                    <div class="instructor-card card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="mb-2">
                                        <i class="bi bi-person-badge text-primary"></i>
                                        Professionnel Certifi√©
                                        ${levelBadge}
                                    </h5>
                                    <p class="text-muted mb-1">
                                        <code>${holder.holder_npub.substring(0, 16)}...</code>
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-check-circle"></i> 
                                        ${holder.attestations_count || 0} attestation(s)
                                    </small>
                                    ${permit && permit.id.match(/^PERMIT_PROFESSION_/) ? `
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle"></i> 
                                                Profession auto-proclam√©e - Peut attester d'autres apprentis
                                    </small>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="text-end">
                                    ${userHEX && userHEX !== holder.holder_npub ? `
                                        <button class="btn btn-sm btn-success" onclick="showAttestModal('${holder.holder_npub}')">
                                            <i class="bi bi-chat-dots"></i> Contacter
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }

        async function loadPendingRequests(requiredAttestations) {
            const listEl = document.getElementById('pendingRequestsList');
            if (!listEl) return;
            
            // Ensure permitRequests is initialized
            if (!permitRequests) {
                permitRequests = [];
            }
            
            // Filter requests: only show those without 30503 credentials (still apprentices)
            const pendingRequests = [];
            for (const request of permitRequests) {
                // Check if this applicant already has a 30503 credential for this permit
                const hasCredential = permitCredentials.some(cred => 
                    cred.holder_npub === request.applicant_npub && 
                    cred.permit_definition_id === request.permit_definition_id
                );
                
                // Only include requests without credentials (still apprentices)
                if (!hasCredential) {
                    pendingRequests.push(request);
                }
            }
            
            // Use requests from Nostr (30501) - only those without 30503
            if (pendingRequests.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p><strong>0</strong> demande en attente.</p>
                        <p class="text-muted">Aucun apprenti ne cherche de ma√Ætre pour le moment.</p>
                        <p class="text-muted small">Les demandes valid√©es (avec 30503) apparaissent dans "Ma√Ætres Certifi√©s".</p>
                    </div>
                `;
                return;
            }
            
            // Use provided requiredAttestations or fallback to min_attestations
            const reqAttest = requiredAttestations || permitData.min_attestations || 1;
            
            let html = '';
            for (const request of pendingRequests) {
                // Count attestations for this request
                const attestCount = await countAttestations(request.id);
                request.attestations_count = attestCount;
                const progress = (request.attestations_count / reqAttest) * 100;
                const isMyRequest = userHEX && userHEX === request.applicant_npub;
                const canAttest = userHEX && userHEX !== request.applicant_npub;
                
                html += `
                    <div class="card mb-3 ${isMyRequest ? 'border-primary' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">
                                        ${isMyRequest ? '<i class="bi bi-person-check text-primary"></i> ' : ''}
                                        Demande #${request.id.substring(0, 8)}
                                        ${isMyRequest ? '<span class="badge bg-primary ms-2">Ma demande</span>' : ''}
                                    </h6>
                                    <p class="text-muted mb-1">
                                        <code>${request.applicant_npub.substring(0, 16)}...</code>
                                    </p>
                                    <p class="mb-0">${request.statement}</p>
                                    ${request.requested_competency ? `
                                        <div class="mt-2">
                                            <span class="badge bg-info">
                                                <i class="bi bi-star"></i> Comp√©tence r√©clam√©e: ${request.requested_competency}
                                            </span>
                                        </div>
                                    ` : ''}
                                    ${request.created_at ? `
                                        <small class="text-muted d-block mt-2">
                                            <i class="bi bi-clock"></i> Cr√©√©e le ${new Date(request.created_at).toLocaleString('fr-FR')}
                                        </small>
                                    ` : ''}
                                </div>
                                <span class="badge bg-${request.status === 'attesting' ? 'warning' : request.status === 'validated' ? 'success' : 'secondary'}">
                                    ${request.status}
                                </span>
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Attestations: ${request.attestations_count} / ${reqAttest}</small>
                                    <small>${Math.round(progress)}%</small>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar ${progress >= 100 ? 'bg-success' : ''}" style="width: ${Math.min(progress, 100)}%"></div>
                                </div>
                            </div>
                            ${isMyRequest ? `
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>Votre demande</strong> - Vous √™tes apprenti, cherchez un ma√Ætre !
                                    ${request.attestations_count >= reqAttest ? 
                                        ' <strong>Seuil atteint !</strong> Le credential 30503 sera √©mis par ORACLE.refresh.sh' : 
                                        ' Il vous faut encore ' + (reqAttest - request.attestations_count) + ' ma√Ætre(s) pour vous attester (30502).'
                                    }
                                </div>
                            ` : ''}
                            ${canAttest ? `
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-success" onclick="showAttestModal('${request.applicant_npub}', '${request.id}')">
                                        <i class="bi bi-check-circle"></i> 
                                        ${request.attestations_count < reqAttest ? 
                                            'üë®‚Äçüè´ Devenir Ma√Ætre (Attester)' : 
                                            'Attester cette demande (30502)'}
                                    </button>
                                    <small class="text-muted d-block mt-1">
                                        ${request.attestations_count < reqAttest ? 
                                            'üí° <strong>Apprenti cherche ma√Ætre</strong> - Transf√©rez vos comp√©tences en l\'attestant' : 
                                            'En attestant, vous cr√©ez un kind 30502 qui permettra √† ORACLE.refresh.sh de valider cette demande'}
                                    </small>
                                </div>
                            ` : ''}
                            ${!userHEX ? `
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="connectMULTIPASS()">
                                        <i class="bi bi-wallet2"></i> Connecter MULTIPASS pour attester
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            listEl.innerHTML = html;
        }

        function showRequestModal() {
            if (!userHEX) {
                // Show tooltip instead of alert
                const btn = event?.target?.closest('button') || document.querySelector('[onclick="showRequestModal()"]');
                if (btn) {
                    const tooltip = bootstrap.Tooltip.getInstance(btn);
                    if (tooltip) {
                        tooltip.show();
                    } else {
                        // Create tooltip if it doesn't exist
                        new bootstrap.Tooltip(btn, {
                            title: 'L\'extension Nostr avec la cl√© de votre MULTIPASS est requise pour la connexion.',
                            placement: 'top'
                        }).show();
                    }
                }
                connectMULTIPASS();
                return;
            }
            
            // Populate permit selector
            const permitSelect = document.getElementById('requestPermitSelect');
            if (permitSelect && allPermits && allPermits.length > 0) {
                permitSelect.innerHTML = '<option value="">-- S√©lectionner une profession --</option>';
                allPermits.forEach(permit => {
                    const option = document.createElement('option');
                    option.value = permit.id;
                    // Show level if it's an auto-proclaimed profession
                    const levelMatch = permit.id.match(/_X(\d+)$/);
                    const levelBadge = levelMatch ? ` [Niveau ${levelMatch[1]}]` : '';
                    option.textContent = `${permit.name}${levelBadge} (${permit.min_attestations || 1} attestation(s) requise(s))`;
                    permitSelect.appendChild(option);
                });
                
                // Pre-select current permit if available
                if (permitData && permitData.id) {
                    permitSelect.value = permitData.id;
                    updateRequestAttestationsInfo(permitData.id);
                }
            } else {
                permitSelect.innerHTML = '<option value="">Aucun permit disponible</option>';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('requestModal'));
            modal.show();
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Update required attestations info when permit is selected
        function updateRequestAttestationsInfo(permitId) {
            const permit = allPermits.find(p => p.id === permitId);
            const attestationsEl = document.getElementById('requestRequiredAttestations');
            if (attestationsEl && permit) {
                attestationsEl.textContent = permit.min_attestations || 1;
            }
        }

        async function submitRequest() {
            if (!userHEX || !window.nostr) {
                // Show tooltip instead of alert
                const btn = document.querySelector('[onclick="submitRequest()"]');
                if (btn) {
                    const tooltip = bootstrap.Tooltip.getInstance(btn);
                    if (!tooltip) {
                        new bootstrap.Tooltip(btn, {
                            title: 'L\'extension Nostr avec la cl√© de votre MULTIPASS est requise pour la connexion.',
                            placement: 'top'
                        }).show();
                    } else {
                        tooltip.show();
                    }
                }
                return;
            }
            
            // Get selected permit
            const permitSelect = document.getElementById('requestPermitSelect');
            const selectedPermitId = permitSelect ? permitSelect.value : null;
            
            if (!selectedPermitId) {
                alert('Veuillez s√©lectionner une profession.');
                permitSelect?.focus();
                return;
            }
            
            // Find permit data
            const selectedPermit = allPermits.find(p => p.id === selectedPermitId);
            if (!selectedPermit) {
                alert('Erreur: Profession non trouv√©e.');
                return;
            }
            
            const statement = document.getElementById('statement').value;
            const evidenceInput = document.getElementById('evidence').value;
            const evidence = evidenceInput ? evidenceInput.split(',').map(e => e.trim()).filter(e => e) : [];
            
            if (!statement || statement.length < 20) {
                alert('Veuillez fournir une d√©claration d\'au moins 20 caract√®res.');
                return;
            }
            
            try {
                // Generate request ID
                const requestId = await window.nostr.getPublicKey().then(pubkey => {
                    return btoa(pubkey + ':' + selectedPermitId + ':' + Date.now()).substring(0, 16);
                });
                
                // Get geolocation if available
                let location = null;
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                        });
                        location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            timestamp: new Date().toISOString()
                        };
                    } catch (e) {
                        console.log('Geolocation not available:', e);
                    }
                }
                
                // Get requested competency
                const requestedCompetency = document.getElementById('requestedCompetency').value.trim();
                if (!requestedCompetency) {
                    alert('Veuillez indiquer la comp√©tence que vous souhaitez acqu√©rir.');
                    return;
                }
                
                // Create permit request event (kind 30501)
                const requestContent = {
                    request_id: requestId,
                    permit_definition_id: selectedPermitId,
                    applicant_did: `did:nostr:${userHEX}`,
                    statement: statement,
                    requested_competency: requestedCompetency, // Competency claimed by the applicant
                    evidence: evidence,
                    status: 'pending',
                    location: location
                };
                
                const eventTags = [
                    ['d', requestId],
                    ['l', selectedPermitId, 'permit_type'],
                    ['p', userHEX],
                    ['t', 'permit'],
                    ['t', 'request']
                ];
                
                // Add IPFSNODEID tag to filter events by Astroport (prevents conflicts in multi-station constellations)
                if (IPFSNODEID) {
                    eventTags.push(['ipfs_node', IPFSNODEID]);
                }
                
                // Add geolocation tags if available
                if (location) {
                    eventTags.push(['g', location.latitude.toString(), location.longitude.toString()]);
                }
                
                const event = {
                    kind: 30501,
                    content: JSON.stringify(requestContent),
                    tags: eventTags,
                    created_at: Math.floor(Date.now() / 1000)
                };
                
                // Sign and publish event
                const signedEvent = await window.nostr.signEvent(event);
                
                // Publish to relays (use common.js nostrRelay if available)
                if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                    try {
                        await nostrRelay.publish(signedEvent);
                        console.log('[WoTx2] ‚úÖ Event published to relay');
                    } catch (e) {
                        console.error('Error publishing to relay:', e);
                        // Fallback to user's relays
                        if (window.nostr && typeof window.nostr.getRelays === 'function') {
                            const relays = await window.nostr.getRelays();
                            const relayUrls = Object.keys(relays);
                            for (const relayUrl of relayUrls) {
                                try {
                                    const relay = new Relay(relayUrl);
                                    await relay.connect();
                                    await relay.publish(signedEvent);
                                    relay.close();
                                } catch (err) {
                                    console.warn(`Failed to publish to ${relayUrl}:`, err);
                                }
                            }
                        }
                    }
                } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                    // Use user's configured relays
                    const relays = await window.nostr.getRelays();
                    const relayUrls = Object.keys(relays);
                    
                    for (const relayUrl of relayUrls) {
                        try {
                            const relay = new Relay(relayUrl);
                            await relay.connect();
                            await relay.publish(signedEvent);
                            relay.close();
                        } catch (e) {
                            console.warn(`Failed to publish to ${relayUrl}:`, e);
                        }
                    }
                } else {
                    console.error('No relay available for publishing');
                    alert('Erreur : Aucun relay disponible pour publier l\'√©v√©nement.');
                }
                
                // Determine required attestations
                const reqAttest = selectedPermit.min_attestations || 1;
                
                const message = `‚úÖ Demande 30501 cr√©√©e avec succ√®s !\n\n` +
                    `Profession: ${selectedPermit.name}\n` +
                    `ID de demande: ${requestId}\n` +
                    `Event ID: ${signedEvent.id}\n\n` +
                    `üìã Prochaines √©tapes :\n` +
                    `1. Votre demande appara√Æt maintenant dans la liste\n` +
                    `2. Une autre personne doit vous attester (kind 30502)\n` +
                    `3. Vous devez obtenir ${reqAttest} attestation(s)\n` +
                    `4. ORACLE.refresh.sh validera et √©mettra le credential 30503\n\n` +
                    `üí° Astuce : Ouvrez cette page dans un autre navigateur avec un autre MULTIPASS pour tester l'attestation r√©ciproque !`;
                
                alert(message);
                bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                
                // Reset form
                document.getElementById('requestForm').reset();
                
                // Reload data from Nostr and switch to selected permit
                // Switch to the selected permit if different from current
                const currentPermitId = permitData?.id || selectedPermitId;
                if (selectedPermitId !== currentPermitId) {
                    window.location.href = `/wotx2?permit_id=${encodeURIComponent(selectedPermitId)}`;
                } else {
                    // Reload data for current permit
                await loadNostrData();
                    loadData();
                }
            } catch (e) {
                console.error('Error submitting request:', e);
                alert('Erreur lors de la soumission: ' + e.message);
            }
        }

        async function showAttestModal(applicantNpub, requestId) {
            if (!userHEX) {
                alert('Veuillez vous connecter avec votre MULTIPASS pour attester.');
                connectMULTIPASS();
                return;
            }
            
            document.getElementById('attestRequestId').value = requestId || '';
            document.getElementById('attestApplicantNpub').value = applicantNpub || '';
            
            // Check if user has a 30503 credential for this permit
            const userCredentials = permitCredentials.filter(c => c.holder_npub === userHEX && c.permit_definition_id === permitData.id);
            
            if (userCredentials.length > 0) {
                // User has credential - show competencies transfer section
                const section = document.getElementById('competenciesTransferSection');
                const checkboxes = document.getElementById('competenciesCheckboxes');
                
                // Get competencies from permit definition
                const permitCompetencies = permitData.metadata?.competencies || [];
                
                if (permitCompetencies.length > 0) {
                    section.style.display = 'block';
                    checkboxes.innerHTML = '';
                    
                    permitCompetencies.forEach(comp => {
                        const div = document.createElement('div');
                        div.className = 'form-check mb-2';
                        div.innerHTML = `
                            <input class="form-check-input competency-checkbox" type="checkbox" 
                                value="${comp}" id="comp_${comp.replace(/\s+/g, '_')}">
                            <label class="form-check-label" for="comp_${comp.replace(/\s+/g, '_')}">
                                ${comp}
                            </label>
                        `;
                        checkboxes.appendChild(div);
                    });
                }
            } else {
                // User doesn't have credential - hide competencies section
                document.getElementById('competenciesTransferSection').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('attestModal'));
            modal.show();
        }
        
        // Get current geolocation
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('attestLatitude').value = position.coords.latitude.toFixed(6);
                        document.getElementById('attestLongitude').value = position.coords.longitude.toFixed(6);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert('Impossible d\'obtenir votre position. Vous pouvez la saisir manuellement.');
                    }
                );
            } else {
                alert('La g√©olocalisation n\'est pas support√©e par votre navigateur.');
            }
        }

        async function submitAttestation() {
            if (!userHEX || !window.nostr) {
                alert('Veuillez vous connecter avec votre MULTIPASS.');
                return;
            }
            
            const requestId = document.getElementById('attestRequestId').value;
            const statement = document.getElementById('attestStatement').value;
            const revealedCompetencies = document.getElementById('revealedCompetencies').value;
            const latitude = document.getElementById('attestLatitude').value;
            const longitude = document.getElementById('attestLongitude').value;
            
            if (!requestId) {
                alert('ID de demande manquant.');
                return;
            }
            
            if (!statement || statement.length < 10) {
                alert('Veuillez fournir une d√©claration d\'attestation.');
                return;
            }
            
            // Collect competencies to transfer (if user has 30503)
            const competenciesToTransfer = [];
            document.querySelectorAll('.competency-checkbox:checked').forEach(checkbox => {
                competenciesToTransfer.push(checkbox.value);
            });
            
            // Add revealed competencies to statement if provided
            let fullStatement = statement;
            if (revealedCompetencies) {
                fullStatement += '\n\nComp√©tences suppl√©mentaires r√©v√©l√©es: ' + revealedCompetencies;
            }
            if (competenciesToTransfer.length > 0) {
                fullStatement += '\n\nComp√©tences transf√©r√©es: ' + competenciesToTransfer.join(', ');
            }
            
            try {
                // Generate attestation ID
                const attestationId = await window.nostr.getPublicKey().then(pubkey => {
                    return btoa(pubkey + ':' + requestId + ':' + Date.now()).substring(0, 16);
                });
                
                // Create permit attestation event (kind 30502)
                const attestationContent = {
                    attestation_id: attestationId,
                    request_id: requestId,
                    attester_did: `did:nostr:${userHEX}`,
                    statement: fullStatement,
                    competencies_transferred: competenciesToTransfer,
                    revealed_competencies: revealedCompetencies ? revealedCompetencies.split(',').map(c => c.trim()) : [],
                    location: (latitude && longitude) ? {
                        latitude: parseFloat(latitude),
                        longitude: parseFloat(longitude),
                        timestamp: new Date().toISOString()
                    } : null,
                    signature: await window.nostr.getPublicKey().then(pubkey => {
                        return btoa(pubkey + ':' + fullStatement + ':' + Date.now()).substring(0, 32);
                    })
                };
                
                const eventTags = [
                    ['d', attestationId],
                    ['e', requestId],
                    ['p', userHEX],
                    ['t', 'permit'],
                    ['t', 'attestation']
                ];
                
                // Add IPFSNODEID tag to filter events by Astroport (prevents conflicts in multi-station constellations)
                if (IPFSNODEID) {
                    eventTags.push(['ipfs_node', IPFSNODEID]);
                }
                
                // Add geolocation tags if provided
                if (latitude && longitude) {
                    eventTags.push(['g', latitude, longitude]);
                }
                
                // Add competencies tags
                competenciesToTransfer.forEach(comp => {
                    eventTags.push(['competency', comp]);
                });
                
                const event = {
                    kind: 30502,
                    content: JSON.stringify(attestationContent),
                    tags: eventTags,
                    created_at: Math.floor(Date.now() / 1000)
                };
                
                // Sign and publish event
                const signedEvent = await window.nostr.signEvent(event);
                
                // Publish to relays (use common.js nostrRelay if available)
                if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                    try {
                        await nostrRelay.publish(signedEvent);
                        console.log('[WoTx2] ‚úÖ Event published to relay');
                    } catch (e) {
                        console.error('Error publishing to relay:', e);
                        // Fallback to user's relays
                        if (window.nostr && typeof window.nostr.getRelays === 'function') {
                            const relays = await window.nostr.getRelays();
                            const relayUrls = Object.keys(relays);
                            for (const relayUrl of relayUrls) {
                                try {
                                    const relay = new Relay(relayUrl);
                                    await relay.connect();
                                    await relay.publish(signedEvent);
                                    relay.close();
                                } catch (err) {
                                    console.warn(`Failed to publish to ${relayUrl}:`, err);
                                }
                            }
                        }
                    }
                } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                    // Use user's configured relays
                    const relays = await window.nostr.getRelays();
                    const relayUrls = Object.keys(relays);
                    
                    for (const relayUrl of relayUrls) {
                        try {
                            const relay = new Relay(relayUrl);
                            await relay.connect();
                            await relay.publish(signedEvent);
                            relay.close();
                        } catch (e) {
                            console.warn(`Failed to publish to ${relayUrl}:`, e);
                        }
                    }
                } else {
                    console.error('No relay available for publishing');
                    alert('Erreur : Aucun relay disponible pour publier l\'√©v√©nement.');
                }
                
                // Count attestations
                const attestationsCount = await countAttestations(requestId);
                
                let message = `‚úÖ Attestation 30502 soumise avec succ√®s !\n\n` +
                    `ID d'attestation: ${attestationId}\n` +
                    `Event ID: ${signedEvent.id}\n` +
                    `Attestations totales: ${attestationsCount}\n\n`;
                
                if (competenciesToTransfer.length > 0) {
                    message += `üìö Comp√©tences transf√©r√©es : ${competenciesToTransfer.join(', ')}\n` +
                        `Ces comp√©tences seront ajout√©es au credential 30503 de l'apprenti.\n\n`;
                }
                
                if (revealedCompetencies) {
                    message += `üåü Nouvelles comp√©tences r√©v√©l√©es : ${revealedCompetencies}\n` +
                        `Ces comp√©tences seront ajout√©es au syst√®me WoTx2.\n\n`;
                }
                
                if (latitude && longitude) {
                    message += `üìç G√©olocalisation : ${latitude}, ${longitude}\n` +
                        `Permet de trouver des ma√Ætres pr√®s de vous.\n\n`;
                }
                
                message += `üìã Prochaines √©tapes :\n` +
                    `1. L'attestation est maintenant visible sur la demande\n` +
                    `2. ORACLE.refresh.sh v√©rifiera le seuil d'attestations\n` +
                    `3. Si le seuil est atteint, le credential 30503 sera √©mis automatiquement\n` +
                    `4. Actualisez la page pour voir les mises √† jour`;
                
                alert(message);
                bootstrap.Modal.getInstance(document.getElementById('attestModal')).hide();
                
                // Reload data from Nostr
                await loadNostrData();
            } catch (e) {
                console.error('Error submitting attestation:', e);
                alert('Erreur lors de l\'attestation: ' + e.message);
            }
        }

        // Load permit selector dropdown
        function loadPermitSelector() {
            const selector = document.getElementById('permitSelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            
            if (allPermits.length === 0) {
                selector.innerHTML = '<option value="">Aucun permit disponible</option>';
                return;
            }
            
            allPermits.forEach(permit => {
                const option = document.createElement('option');
                option.value = permit.id;
                // Show level if it's an auto-proclaimed profession
                const levelMatch = permit.id.match(/_X(\d+)$/);
                const levelBadge = levelMatch ? ` [Niveau ${levelMatch[1]}]` : '';
                option.textContent = `${permit.name}${levelBadge} (${permit.holders_count} titulaires, ${permit.pending_count} en attente)`;
                if (permit.id === selectedPermitId) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            // Update UI with selected permit
            updatePermitUI();
            
            // Also render the permits list
            renderAllPermitsList();
        }
        
        // Render all permits list (similar to oracle.html)
        async function renderAllPermitsList() {
            const container = document.getElementById('all-permits-list');
            if (!container) return;
            
            if (allPermits.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle"></i> Aucun permis disponible pour le moment.
                        </div>
                    </div>
                `;
                return;
            }
            
            // For each permit, check if user is creator and if 30503 exists
            let html = '';
            const userPubkeyHex = userHEX ? npubToHex(userHEX) : null;
            
            for (const permit of allPermits) {
                // Check if user is the creator (need to fetch the 30500 event)
                const permit30500 = await fetchPermitDefinition(permit.id);
                const isCreator = permit30500 && userPubkeyHex && permit30500.pubkey === userPubkeyHex;
                
                // Check if any 30503 credentials exist
                const has30503 = permit.holders_count > 0 || (await checkHas30503Credentials(permit.id));
                
                // Can delete only if creator and no 30503 exists
                const canDelete = isCreator && !has30503;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card permit-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 style="color: var(--water-blue); margin: 0;">
                                        <i class="bi bi-award"></i> ${permit.name}
                                    </h5>
                                    ${canDelete ? `
                                        <button class="btn btn-sm btn-danger" onclick="deletePermit('${permit.id}')" title="Supprimer ce permis (kind 5)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <p class="text-muted small mb-0">
                                        <code>${permit.id}</code>
                                    </p>
                                    ${permit.id.match(/_X\d+$/) ? `
                                        <span class="badge bg-primary">
                                            Niveau ${permit.id.match(/_X(\d+)$/)[1]}
                                        </span>
                                    ` : ''}
                                </div>
                                
                                <p class="mb-3" style="min-height: 60px;">
                                    ${permit.description || 'Aucune description disponible.'}
                                </p>
                                
                                ${permit.id.match(/_X\d+$/) ? `
                                    <div class="alert alert-info mb-3" style="font-size: 0.85rem;">
                                        <i class="bi bi-arrow-right-circle"></i> 
                                        <strong>Progression automatique :</strong> 
                                        ${permit.id.endsWith('_X1') ? '1 signature ‚Üí X2 (2 comp√©tences, 2 signatures)' : ''}
                                        ${permit.id.endsWith('_X2') ? '2 signatures + 2 comp√©tences ‚Üí X3 (3 comp√©tences, 3 signatures)' : ''}
                                        ${permit.id.endsWith('_X3') ? '3 signatures + 3 comp√©tences ‚Üí X4 (4 comp√©tences, 4 signatures)' : ''}
                                        ${permit.id.endsWith('_X4') ? 'Niveau ma√Ætre atteint' : ''}
                                    </div>
                                ` : ''}
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted small">
                                            <i class="bi bi-people"></i> Titulaires
                                        </span>
                                        <span class="badge bg-success">${permit.holders_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted small">
                                            <i class="bi bi-hourglass-split"></i> Demandes en attente
                                        </span>
                                        <span class="badge bg-warning">${permit.pending_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted small">
                                            <i class="bi bi-pen"></i> Signatures requises
                                        </span>
                                        <span class="badge bg-info">${permit.min_attestations || 1}</span>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <a href="/wotx2?permit_id=${permit.id}" class="btn btn-primary btn-sm">
                                        <i class="bi bi-eye"></i> Voir les d√©tails
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Fetch permit definition (kind 30500) from Nostr
        async function fetchPermitDefinition(permitId) {
            try {
                const filters = {
                    '#d': [permitId]
                };
                // Only filter by IPFSNODEID in local mode
                if (viewMode === 'local' && IPFSNODEID) {
                    filters['#ipfs_node'] = [IPFSNODEID];
                }
                const events = await fetchNostrEvents(30500, filters);
                if (events.length > 0) {
                    // Sort by created_at descending to get the most recent
                    events.sort((a, b) => b.created_at - a.created_at);
                    return events[0];
                }
            } catch (e) {
                console.error('Error fetching permit definition:', e);
            }
            return null;
        }
        
        // Check if any 30503 credentials exist for this permit
        async function checkHas30503Credentials(permitId) {
            try {
                const filters = {
                    '#l': [permitId, 'permit_type']
                };
                // Only filter by IPFSNODEID in local mode
                if (viewMode === 'local' && IPFSNODEID) {
                    filters['#ipfs_node'] = [IPFSNODEID];
                }
                const events = await fetchNostrEvents(30503, filters);
                return events.length > 0;
            } catch (e) {
                console.error('Error checking 30503 credentials:', e);
                return false;
            }
        }
        
        // Convert npub to hex pubkey
        function npubToHex(npub) {
            if (!npub) return null;
            if (!npub.startsWith('npub')) return npub; // Already hex
            if (typeof NostrTools !== 'undefined' && NostrTools.nip19) {
                try {
                    const decoded = NostrTools.nip19.decode(npub);
                    return decoded.data;
                } catch (e) {
                    console.error('Error decoding npub:', e);
                    return null;
                }
            }
            return null;
        }
        
        // Delete permit (kind 5) - only if creator and no 30503 exists
        async function deletePermit(permitId) {
            if (!userHEX || !window.nostr) {
                alert('Veuillez vous connecter avec votre MULTIPASS pour supprimer un permis.');
                connectMULTIPASS();
                return;
            }
            
            // Verify user is creator
            const permit30500 = await fetchPermitDefinition(permitId);
            if (!permit30500) {
                alert('Erreur: Impossible de trouver la d√©finition du permis.');
                return;
            }
            
            // Convert userHEX to hex if needed
            const userPubkeyHex = npubToHex(userHEX);
            if (!userPubkeyHex) {
                alert('Erreur: Impossible de d√©coder votre cl√© publique.');
                return;
            }
            
            if (permit30500.pubkey !== userPubkeyHex) {
                alert('Erreur: Vous n\'√™tes pas le cr√©ateur de ce permis. Seul le cr√©ateur peut le supprimer.');
                return;
            }
            
            // Check if any 30503 credentials exist
            const has30503 = await checkHas30503Credentials(permitId);
            if (has30503) {
                alert('Erreur: Ce permis ne peut pas √™tre supprim√© car des credentials (30503) ont d√©j√† √©t√© √©mis.');
                return;
            }
            
            // Confirm deletion
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer le permis "${permitId}" ?\n\nCette action est irr√©versible et enverra un √©v√©nement kind 5 (delete) sur Nostr.`)) {
                return;
            }
            
            try {
                // Create kind 5 delete event
                const deleteEvent = {
                    kind: 5,
                    content: '',
                    tags: [
                        ['e', permit30500.id] // Reference to the 30500 event to delete
                    ],
                    created_at: Math.floor(Date.now() / 1000)
                };
                
                // Add IPFSNODEID tag to filter events by Astroport
                if (IPFSNODEID) {
                    deleteEvent.tags.push(['ipfs_node', IPFSNODEID]);
                }
                
                // Sign and publish event
                const signedEvent = await window.nostr.signEvent(deleteEvent);
                
                // Publish to relays
                if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                    try {
                        await nostrRelay.publish(signedEvent);
                        console.log('[WoTx2] ‚úÖ Delete event published to relay');
                    } catch (e) {
                        console.error('Error publishing to relay:', e);
                        // Fallback to user's relays
                        if (window.nostr && typeof window.nostr.getRelays === 'function') {
                            const relays = await window.nostr.getRelays();
                            const relayUrls = Object.keys(relays);
                            for (const relayUrl of relayUrls) {
                                try {
                                    const relay = new Relay(relayUrl);
                                    await relay.connect();
                                    await relay.publish(signedEvent);
                                    relay.close();
                                } catch (err) {
                                    console.warn(`Failed to publish to ${relayUrl}:`, err);
                                }
                            }
                        }
                    }
                } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                    // Use user's configured relays
                    const relays = await window.nostr.getRelays();
                    const relayUrls = Object.keys(relays);
                    
                    for (const relayUrl of relayUrls) {
                        try {
                            const relay = new Relay(relayUrl);
                            await relay.connect();
                            await relay.publish(signedEvent);
                            relay.close();
                        } catch (e) {
                            console.warn(`Failed to publish to ${relayUrl}:`, e);
                        }
                    }
                } else {
                    console.error('No relay available for publishing');
                    alert('Erreur : Aucun relay disponible pour publier l\'√©v√©nement.');
                    return;
                }
                
                alert(`‚úÖ √âv√©nement de suppression (kind 5) publi√© avec succ√®s !\n\nEvent ID: ${signedEvent.id}\n\nLe permis sera supprim√© une fois l'√©v√©nement propag√© sur les relays.`);
                
                // Reload page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (e) {
                console.error('Error deleting permit:', e);
                alert('Erreur lors de la suppression: ' + e.message);
            }
        }

        // Switch to different permit
        function switchPermit() {
            const selector = document.getElementById('permitSelector');
            if (!selector) return;
            
            const newPermitId = selector.value;
            if (newPermitId && newPermitId !== selectedPermitId) {
                window.location.href = `/wotx2?permit_id=${encodeURIComponent(newPermitId)}`;
            }
        }

        // Update UI with current permit info
        function updatePermitUI() {
            const selectedPermit = allPermits.find(p => p.id === selectedPermitId);
            if (selectedPermit) {
                const titleEl = document.getElementById('permitTitle');
                const levelBadge = document.getElementById('permitLevelBadge');
                const progressionWorkflow = document.getElementById('progressionWorkflow');
                
                if (titleEl) {
                    titleEl.textContent = selectedPermit.name + ' - WoTx2';
                }
                
                // Show level badge if it's an auto-proclaimed profession
                const levelMatch = selectedPermit.id.match(/_X(\d+)$/);
                if (levelMatch && levelBadge) {
                    levelBadge.textContent = `Niveau ${levelMatch[1]}`;
                    levelBadge.style.display = 'inline-block';
                } else if (levelBadge) {
                    levelBadge.style.display = 'none';
                }
                
                // Show progression workflow for auto-proclaimed professions
                if (selectedPermit.id.match(/^PERMIT_PROFESSION_/) && progressionWorkflow) {
                    progressionWorkflow.style.display = 'block';
                } else if (progressionWorkflow) {
                    progressionWorkflow.style.display = 'none';
                }
            }
        }

        // Show new permit modal
        function showNewPermitModal() {
            if (!userHEX) {
                // Show tooltip instead of alert
                const btn = event?.target?.closest('button') || document.querySelector('[onclick="showNewPermitModal()"]');
                if (btn) {
                    const tooltip = bootstrap.Tooltip.getInstance(btn);
                    if (tooltip) {
                        tooltip.show();
                    }
                }
                connectMULTIPASS();
                return;
            }
            
            // Reset form
            document.getElementById('newPermitForm').reset();
            document.getElementById('autoProclaimedPermit').checked = true;
            togglePermitType();
            updateAutoPermitId();
            
            const modal = new bootstrap.Modal(document.getElementById('newPermitModal'));
            modal.show();
        }
        
        // Toggle between auto-proclaimed and manual permit ID
        function togglePermitType() {
            const isAuto = document.getElementById('autoProclaimedPermit').checked;
            const manualSection = document.getElementById('manualPermitIdSection');
            const permitIdInput = document.getElementById('newPermitId');
            
            if (isAuto) {
                manualSection.style.display = 'none';
                permitIdInput.removeAttribute('required');
                updateAutoPermitId();
            } else {
                manualSection.style.display = 'block';
                permitIdInput.setAttribute('required', 'required');
            }
        }
        
        // Update auto-generated permit ID preview
        function updateAutoPermitId() {
            const isAuto = document.getElementById('autoProclaimedPermit').checked;
            if (!isAuto) return;
            
            const permitName = document.getElementById('newPermitName').value.trim();
            const preview = document.getElementById('autoPermitIdPreview');
            
            if (permitName) {
                // Convert to uppercase, replace spaces with underscores, remove special chars
                let permitId = permitName.toUpperCase()
                    .replace(/[^A-Z0-9\s]/g, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 50); // Limit length
                
                // Ensure it starts with PERMIT_PROFESSION_
                if (!permitId.startsWith('PERMIT_PROFESSION_')) {
                    permitId = 'PERMIT_PROFESSION_' + permitId;
                }
                
                // Add _X1 suffix
                if (!permitId.endsWith('_X1')) {
                    permitId = permitId.replace(/_X\d+$/, '') + '_X1';
                }
                
                preview.textContent = permitId;
            } else {
                preview.textContent = 'PERMIT_PROFESSION_X1';
            }
        }

        // Add competency field
        function addCompetency() {
            const list = document.getElementById('competenciesList');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="text" class="form-control competency-input" 
                    placeholder="Ex: Swimming instruction">
                <button type="button" class="btn btn-outline-danger" onclick="removeCompetency(this)">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            list.appendChild(div);
        }

        // Remove competency field
        function removeCompetency(btn) {
            const list = document.getElementById('competenciesList');
            if (list.children.length > 1) {
                btn.closest('.input-group').remove();
            } else {
                alert('Au moins une comp√©tence est requise.');
            }
        }

        // Add responsible field
        function addResponsible() {
            const list = document.getElementById('responsibleForList');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="text" class="form-control responsible-input" 
                    placeholder="Ex: Swimming lessons">
                <button type="button" class="btn btn-outline-danger" onclick="removeResponsible(this)">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            list.appendChild(div);
        }

        // Remove responsible field
        function removeResponsible(btn) {
            const list = document.getElementById('responsibleForList');
            if (list.children.length > 1) {
                btn.closest('.input-group').remove();
            } else {
                alert('Au moins une responsabilit√© est requise.');
            }
        }

        // Add bootstrap email field
        function addBootstrapEmail() {
            const list = document.getElementById('bootstrapEmailsList');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="email" class="form-control bootstrap-email-input" 
                    placeholder="email@example.com">
                <button type="button" class="btn btn-outline-danger" onclick="removeBootstrapEmail(this)">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            list.appendChild(div);
        }

        // Remove bootstrap email field
        function removeBootstrapEmail(btn) {
            const list = document.getElementById('bootstrapEmailsList');
            if (list.children.length > 2) {
                btn.closest('.input-group').remove();
            } else {
                alert('Au moins 2 emails sont requis pour le bootstrap.');
            }
        }

        // Submit new permit
        async function submitNewPermit() {
            if (!userHEX) {
                alert('Vous devez √™tre connect√© avec MULTIPASS.');
                return;
            }

            const permitName = document.getElementById('newPermitName').value.trim();
            const permitDescription = document.getElementById('newPermitDescription').value.trim();
            const isAutoProclaimed = document.getElementById('autoProclaimedPermit').checked;

            // Validate required fields
            if (!permitName || !permitDescription) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }

            // Generate or get permit ID
            let permitId;
            if (isAutoProclaimed) {
                // Auto-generate ID from profession name
                permitId = permitName.toUpperCase()
                    .replace(/[^A-Z0-9\s]/g, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 50);
                
                if (!permitId.startsWith('PERMIT_PROFESSION_')) {
                    permitId = 'PERMIT_PROFESSION_' + permitId;
                }
                
                if (!permitId.endsWith('_X1')) {
                    permitId = permitId.replace(/_X\d+$/, '') + '_X1';
                }
            } else {
                permitId = document.getElementById('newPermitId').value.trim();
                if (!permitId) {
                    alert('Veuillez saisir un ID de permit ou cocher "Profession Auto-Proclam√©e".');
                    return;
                }
                
                // Validate permit ID format
            if (!/^[A-Z0-9_]+$/.test(permitId)) {
                alert('L\'ID du permit doit contenir uniquement des majuscules, chiffres et underscores');
                return;
            }
            
            // Warn if doesn't start with PERMIT_ (but allow it)
            if (!permitId.startsWith('PERMIT_')) {
                if (!confirm(`L'ID "${permitId}" ne commence pas par "PERMIT_". Voulez-vous continuer ?`)) {
                    return;
                }
                }
            }

            // WoTx2: Auto-proclaimed professions start at X1 with 1 attestation
            // System will auto-create X2, X3, X4 as permits are validated
            const minAttestations = 1; // X1 requires 1 signature
            const level = isAutoProclaimed ? 'X1' : 'X1'; // Always start at X1 for auto-proclaimed

            // Build metadata for auto-proclaimed profession
            const metadata = {
                category: "auto_proclaimed",
                competencies: [], // Will be added progressively via 30502 attestations
                responsible_for: [], // Will be added progressively via 30502 attestations
                auto_proclaimed: isAutoProclaimed,
                level: level,
                evolving_system: {
                    type: "WoTx2_AutoProclaimed",
                    description: "Auto-proclaimed profession that evolves automatically: X1 (1 signature) ‚Üí X2 (2 competencies, 2 signatures) ‚Üí X3 ‚Üí X4...",
                    discovery_mechanism: "attestation_revealed_competencies",
                    auto_progression: true,
                    progression_rules: {
                        x1: { signatures: 1, competencies: 0, next_level: "X2" },
                        x2: { signatures: 2, competencies: 2, next_level: "X3" },
                        x3: { signatures: 3, competencies: 3, next_level: "X4" },
                        x4: { signatures: 4, competencies: 4, next_level: null }
                    },
                    virtuous_circle: {
                        student: "Receives instruction and can become instructor",
                        instructor: "Teaches and discovers new talents",
                        revealed_talents: "New competencies discovered through attestations expand the permit"
                    }
                }
            };

            // Build request (minimal)
            const requestData = {
                permit: {
                    id: permitId,
                    name: permitName,
                    description: permitDescription,
                    min_attestations: minAttestations,
                    required_license: null,
                    valid_duration_days: 0, // Unlimited
                    revocable: true,
                    verification_method: "peer_attestation",
                    metadata: metadata
                },
                npub: userHEX,
                bootstrap_emails: null // No bootstrap needed, system starts with 1 signature
            };

            try {
                const response = await fetch(`${uSPOT}/api/permit/define`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.success) {
                    let message = `‚úÖ Permit ${permitId} cr√©√© avec succ√®s !\n\n`;
                    message += `üìã Niveau X1 - D√©marrage\n`;
                    message += `üìù Attestations requises: 1\n\n`;
                    if (isAutoProclaimed) {
                        message += `üîÑ Progression automatique activ√©e :\n`;
                        message += `   ‚Ä¢ X1 ‚Üí X2 : Apr√®s validation (2 comp√©tences, 2 signatures)\n`;
                        message += `   ‚Ä¢ X2 ‚Üí X3 : Apr√®s validation (3 comp√©tences, 3 signatures)\n`;
                        message += `   ‚Ä¢ X3 ‚Üí X4 : Apr√®s validation (4 comp√©tences, 4 signatures)\n\n`;
                    }
                    message += `üí° Vous pouvez maintenant cr√©er une demande d'apprentissage (30501) pour ce permit.`;
                    alert(message);
                    
                    bootstrap.Modal.getInstance(document.getElementById('newPermitModal')).hide();
                    
                    // Reload page to show new permit
                    setTimeout(() => {
                        window.location.href = `/wotx2?permit_id=${encodeURIComponent(permitId)}`;
                    }, 1000);
                } else {
                    alert('Erreur: ' + (result.detail || result.message || '√âchec de la cr√©ation'));
                }
            } catch (e) {
                console.error('Error creating permit:', e);
                alert('Erreur lors de la cr√©ation: ' + e.message);
            }
        }
    </script>
</body>
</html>

