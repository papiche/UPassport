<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validaton du Savoir Faire - WoTx2 | UPlanet</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="{{ myIPFS }}/ipns/copylaradio.com/fonts/bootstrap-icons.css">
    
    <style>
        :root {
            --primary: #059669;
            --secondary: #10b981;
            --accent: #06b6d4;
            --dark: #1a202c;
            --light: #f7fafc;
            --water-blue: #0ea5e9;
            --water-dark: #0284c7;
        }
        
        body {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #0369a1 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding-top: 80px;
        }
        
        .hero {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }
        
        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--water-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .hero h1 i {
            font-size: 3rem;
            color: var(--water-blue);
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--water-blue), var(--water-dark));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1.25rem;
            font-weight: 600;
        }
        
        .instructor-card {
            border-left: 4px solid var(--water-blue);
        }
        
        .instructor-card .card-body {
            padding: 1.5rem;
        }
        
        .badge-competency {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 0.25rem;
            display: inline-block;
        }
        
        .badge-new {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--water-blue), var(--water-dark));
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(14, 165, 233, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
        }
        
        .progress {
            height: 25px;
            border-radius: 15px;
            background: #e2e8f0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--water-blue), var(--water-dark));
            border-radius: 15px;
        }
        
        .virtuous-circle {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .circle-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin: 1rem 0;
            background: rgba(14, 165, 233, 0.1);
            border-radius: 15px;
        }
        
        /* Tree view styles with Bootstrap */
        .tree-view {
            font-size: 0.95rem;
        }
        
        .tree-node {
            position: relative;
        }
        
        .tree-children {
            border-left: 3px solid rgba(14, 165, 233, 0.4);
            padding-left: 1.5rem;
            margin-left: 1rem;
            position: relative;
        }
        
        .tree-children::before {
            content: '';
            position: absolute;
            left: -3px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, rgba(14, 165, 233, 0.4), rgba(14, 165, 233, 0.1));
        }
        
        .tree-item {
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }
        
        .tree-item:hover {
            transform: translateX(5px);
        }
        
        .tree-root {
            border-left: none;
        }
        
        .event-badge {
            font-size: 0.75rem;
            padding: 0.35rem 0.65rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .event-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .event-card:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .event-card-30500 {
            border-left-color: #0d6efd;
        }
        
        .event-card-30501 {
            border-left-color: #0dcaf0;
        }
        
        .event-card-30502 {
            border-left-color: #198754;
        }
        
        .event-card-30503 {
            border-left-color: #ffc107;
        }
        
        .collapse-toggle {
            cursor: pointer;
            user-select: none;
        }
        
        .collapse-toggle:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .circle-step i {
            font-size: 2rem;
            color: var(--water-blue);
        }
        
        .connection-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1.25rem;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        
        .connection-badge:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .connection-badge.authenticated {
            border-color: var(--primary);
            background: rgba(5, 150, 105, 0.2);
        }
        
        .connection-badge.connected-not-auth {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.2);
        }
        
        .connection-badge.connecting {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }
        
        .connection-badge.disconnected {
            border-color: #94a3b8;
            background: rgba(156, 163, 175, 0.2);
        }
        
        .connection-badge .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cbd5e0;
        }
        
        .connection-badge.authenticated .status-dot {
            background: var(--primary);
            animation: pulse 2s infinite;
        }
        
        #connection-badge-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .status-text {
            font-size: 0.75em;
            font-weight: 600;
            color: #ffffff;
        }
        
        .user-npub {
            font-size: 0.65em;
            color: #94a3b8;
        }
        
        .btn-connect,
        .btn-profile {
            padding: 4px 10px;
            font-size: 0.75em;
            border: none;
            border-radius: 12px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-connect:hover,
        .btn-profile:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-connect:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Connection Panel (Dropdown) */
        .connection-panel {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            width: 400px;
            max-width: 90vw;
            background: rgba(24, 24, 24, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }
        
        .connection-panel.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-header h6 {
            margin: 0;
            font-size: 0.95em;
            font-weight: 600;
            color: #ffffff;
        }
        
        .panel-status-icon {
            font-size: 1.2em;
        }
        
        /* Connection Steps */
        .connection-step {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .connection-step.pending {
            border-left-color: #94a3b8;
        }
        
        .connection-step.in-progress {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .connection-step.success {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .connection-step.error {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .step-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        
        .step-icon {
            font-size: 1.2em;
        }
        
        .step-title {
            font-size: 0.9em;
            font-weight: 600;
            color: #ffffff;
        }
        
        .step-description {
            font-size: 0.8em;
            color: #94a3b8;
            margin-left: 32px;
            margin-bottom: 8px;
        }
        
        .step-action {
            margin-left: 32px;
        }
        
        .step-action button {
            padding: 6px 14px;
            font-size: 0.75em;
            border: none;
            border-radius: 6px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .step-action button:hover:not(:disabled) {
            background: #2563eb;
        }
        
        .step-action button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* User Info Panel */
        .user-info-panel {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin: 4px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            font-size: 0.85em;
            color: #e2e8f0;
        }
        
        .info-row i {
            color: #3b82f6;
        }
        
        .info-row a {
            color: #3ea6ff;
            text-decoration: none;
        }
        
        .info-row a:hover {
            text-decoration: underline;
        }
        
        .info-row span {
            cursor: pointer;
        }
        
        .info-row span:hover {
            color: #3ea6ff;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .stats-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--water-blue);
        }
        
        .stats-card .label {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--water-blue), var(--water-dark));
            color: white;
            border-radius: 15px 15px 0 0;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--water-blue);
            box-shadow: 0 0 0 0.2rem rgba(14, 165, 233, 0.25);
        }
        
        .alert {
            border-radius: 15px;
            border: none;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #cbd5e0;
            margin-bottom: 1rem;
        }
        
        .permit-card {
            border-left: 4px solid var(--water-blue);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .permit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <!-- Connection Badge (MULTIPASS) -->
    <div id="connectionBadge" class="connection-badge disconnected" onclick="toggleConnectionPanel()">
        <div id="connection-badge-content">
            <span class="status-text">‚ö´ Non connect√©</span>
        </div>
        <button class="btn-connect" onclick="event.stopPropagation(); connectMULTIPASS()" id="connectBtn">
            <i class="bi bi-key"></i> Connecter
        </button>
        
        <!-- Connection Panel (Dropdown) -->
        <div id="connectionPanel" class="connection-panel">
            <div class="panel-header">
                <h6 id="panelTitle">√âtat de Connexion</h6>
                <span class="panel-status-icon" id="panelStatusIcon">‚ö´</span>
            </div>
            
            <!-- Step 1: Relay Connection -->
            <div id="step1" class="connection-step pending">
                <div class="step-header">
                    <span class="step-icon">üåê</span>
                    <span class="step-title">1. Connexion au Relay</span>
                </div>
                <div class="step-description" id="step1-desc">Relay NOSTR - Lecture publique</div>
                <div class="step-action">
                    <button onclick="manualConnectRelay()" id="step1-btn">Connecter au Relay</button>
                </div>
            </div>
            
            <!-- Step 2: NIP-42 Authentication -->
            <div id="step2" class="connection-step pending">
                <div class="step-header">
                    <span class="step-icon">üîê</span>
                    <span class="step-title">2. Authentification Personnelle</span>
                </div>
                <div class="step-description" id="step2-desc">NIP-42 Auth - Acc√®s uDRIVE & GPS</div>
                <div class="step-action">
                    <button onclick="connectMULTIPASS()" id="step2-btn" disabled>Authentifier avec MULTIPASS</button>
                    <button onclick="connectMULTIPASS()" id="step2-reauth-btn" style="display: none; margin-left: 8px;" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-arrow-clockwise"></i> R√©-authentifier
                    </button>
                </div>
            </div>
            
            <!-- User Info (After Connection) -->
            <div id="user-info-panel" class="user-info-panel" style="display: none;">
                <div class="info-row">
                    <i class="bi bi-person-circle"></i>
                    <span id="user-pubkey-display" title="Cliquer pour copier">...</span>
                </div>
                <div class="info-row" id="udrive-row" style="display: none;">
                    <i class="bi bi-folder-fill"></i>
                    <a href="#" onclick="openUserDrive(); return false;">Ouvrir uDRIVE</a>
                </div>
                <div class="info-row" id="gps-row" style="display: none;">
                    <i class="bi bi-geo-alt-fill"></i>
                    <span id="gps-coords" title="Coordonn√©es UMAP">...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Permit Selector & New Button -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <label class="form-label"><strong>Choisir une ma√Ætrise :</strong></label>
                        <select class="form-select" id="permitSelector" onchange="switchPermit()">
                            <option value="">Chargement...</option>
                        </select>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success btn-lg w-100" onclick="showNewPermitModal()">
                            <i class="bi bi-plus-circle"></i> Cr√©er une Nouvelle Ma√Ætrise
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Mode Tabs (Local/Global) -->
        <div class="card mb-3" id="viewModeCard" style="display: none;">
            <div class="card-body">
                <ul class="nav nav-tabs" id="viewModeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="local-tab" data-bs-toggle="tab" data-bs-target="#local-view" 
                                type="button" role="tab" onclick="switchViewMode('local')">
                            <i class="bi bi-house-door"></i> Vue Locale
                            <span class="badge bg-primary ms-2" id="local-badge">Cette station</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation" id="global-tab-item" style="display: none;">
                        <button class="nav-link" id="global-tab" data-bs-toggle="tab" data-bs-target="#global-view" 
                                type="button" role="tab" onclick="switchViewMode('global')">
                            <i class="bi bi-globe"></i> Vue Globale
                            <span class="badge bg-success ms-2" id="global-badge">Constellation</span>
                            <span class="badge bg-warning ms-1" id="primary-badge" style="display: none;">
                                <i class="bi bi-star-fill"></i> Primaire
                            </span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <!-- All Permits List (similar to oracle.html) -->
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-list-ul"></i> Tous les Permis Disponibles
                    <span id="view-mode-indicator" class="badge bg-info ms-2"></span>
                </h4>
            </div>
            <div class="card-body">
                <div id="all-permits-list" class="row g-4">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 text-muted">Chargement des permis...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hero Section -->
        <div class="hero" id="permitHero">
            <h1>
                <i class="bi bi-mortarboard"></i>
                <span id="permitTitle">Savoir Faire - WoTx2</span>
                <span id="permitLevelBadge" class="badge bg-primary ms-2" style="display: none;"></span>
            </h1>
            <p class="lead" id="permitDescription">
                <strong>Apprenez et enseignez librement, sans √©coles ni dipl√¥mes</strong><br>
                Cr√©ez votre ma√Ætrise, trouvez des ma√Ætres pr√®s de chez vous, partagez vos savoir-faire, 
                et construisez ensemble une communaut√© de comp√©tences valid√©es par vos pairs.
            </p>
            <div id="progressionWorkflow" style="display: none;" class="mt-3">
                <div class="alert alert-info">
                    <h6><i class="bi bi-diagram-3"></i> Workflow de Progression Automatique :</h6>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-warning" style="font-size: 1rem;">X1</div>
                                <p class="small mt-1 mb-0">1 signature</p>
                            </div>
                        </div>
                        <div class="col-md-1 text-center">
                            <i class="bi bi-arrow-right"></i>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-info" style="font-size: 1rem;">X2</div>
                                <p class="small mt-1 mb-0">2 comp√©tences<br>2 signatures</p>
                            </div>
                        </div>
                        <div class="col-md-1 text-center">
                            <i class="bi bi-arrow-right"></i>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-success" style="font-size: 1rem;">X3+</div>
                                <p class="small mt-1 mb-0">Progression continue</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="number" id="totalHolders">0</div>
                        <div class="label">Ma√Ætres Certifi√©s</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="number" id="totalRequests">0</div>
                        <div class="label">Apprentis en Formation</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <div class="number" id="minAttestations">1</div>
                        <div class="label">Attestations Requises</div>
                    </div>
                </div>
            </div>
            
            <!-- Delete Permit Button (only if creator and no 30503) -->
            <div id="deletePermitSection" style="display: none;" class="mt-3">
                <div class="alert alert-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-exclamation-triangle"></i> 
                            <strong>Vous √™tes le cr√©ateur de cette ma√Ætrise</strong>
                            <p class="mb-0 small mt-1">Vous pouvez supprimer cette ma√Ætrise et toutes les demandes associ√©es tant qu'aucun certificat n'a encore √©t√© d√©livr√©.</p>
                        </div>
                        <button class="btn btn-danger" id="deletePermitBtn">
                            <i class="bi bi-trash"></i> Supprimer ce Permit
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mastery Levels Navigation & Progress -->
            <div id="masteryLevelsSection" style="display: none;" class="mt-4">
                <div class="card" style="background: rgba(255, 255, 255, 0.95);">
                    <div class="card-header" style="background: linear-gradient(135deg, var(--water-blue), var(--water-dark)); color: white;">
                        <h5 class="mb-0">
                            <i class="bi bi-diagram-3"></i> Niveaux de Ma√Ætrise Disponibles
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="masteryLevelsNav" class="d-flex flex-wrap gap-2 justify-content-center mb-3">
                            <!-- Will be populated dynamically -->
                        </div>
                        <div id="userProgressIndicator" style="display: none;" class="mt-3">
                            <div class="alert alert-info mb-2">
                                <i class="bi bi-person-check"></i> <strong>Votre progression :</strong>
                                <span id="userCurrentLevel">-</span>
                            </div>
                            <div class="progress" style="height: 30px;">
                                <div id="userProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%">
                                    <span id="userProgressText">0%</span>
                                </div>
                            </div>
                            <small class="text-muted d-block mt-2 text-center" id="userProgressDetails">
                                Connectez-vous pour voir votre progression
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap Instructions -->
        <div class="card mb-4" id="bootstrapInstructions" style="display: none;">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-seed"></i> üöÄ D√©marrer une Nouvelle Ma√Ætrise
            </div>
            <div class="card-body">
                <h5>üí° Comment cr√©er votre premi√®re ma√Ætrise :</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-success">
                            <strong>‚úÖ Option Simple (Recommand√©e) :</strong>
                            <p class="mb-0 mt-2">Cr√©ez votre ma√Ætrise ci-dessus ‚Üí Le syst√®me cr√©e automatiquement votre demande et votre auto-attestation. Vous √™tes pr√™t !</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <strong>üë• Option avec Partenaire :</strong>
                            <ol class="mb-0 mt-2" style="padding-left: 1.2rem;">
                                <li>2 personnes se connectent avec leur MULTIPASS</li>
                                <li>Chacun cr√©e sa demande d'apprentissage</li>
                                <li>Chacun atteste l'autre ‚Üí Certificats automatiques !</li>
                                <li>La ma√Ætrise est ouverte √† tous</li>
                </ol>
                        </div>
                    </div>
                </div>
                <div class="alert alert-warning mt-3">
                    <i class="bi bi-star"></i> <strong>Avantage :</strong> D√®s que 2 ma√Ætres sont certifi√©s, votre ma√Ætrise devient visible et accessible √† toute la communaut√© UPlanet !
                </div>
            </div>
        </div>

        <!-- Benefits Section -->
        <div class="virtuous-circle">
            <h3 class="mb-4">
                <i class="bi bi-heart"></i> Pourquoi utiliser WoTx2 ?
            </h3>
            <div class="circle-step">
                <i class="bi bi-person-check"></i>
                <div>
                    <strong>üéì Pour Vous : Apprenez Librement</strong>
                    <p class="mb-0">Trouvez des ma√Ætres pr√®s de chez vous, apprenez par la pratique, et obtenez une certification reconnue par la communaut√©. Plus besoin d'√©coles co√ªteuses !</p>
                </div>
            </div>
            <div class="circle-step">
                <i class="bi bi-person-badge"></i>
                <div>
                    <strong>üë®‚Äçüè´ Pour Vous : Partagez vos Talents</strong>
                    <p class="mb-0">Enseignez ce que vous savez, d√©couvrez de nouveaux talents, et construisez votre r√©putation de ma√Ætre. Votre savoir-faire devient votre capital social.</p>
                </div>
            </div>
            <div class="circle-step">
                <i class="bi bi-globe"></i>
                <div>
                    <strong>üåç Pour la Communaut√© UPlanet</strong>
                    <p class="mb-0">Cr√©ez des r√©seaux locaux d'apprentissage, d√©centralisez l'√©ducation, et construisez ensemble une √©conomie bas√©e sur les comp√©tences r√©elles plut√¥t que les dipl√¥mes.</p>
                </div>
            </div>
            <div class="alert alert-success mt-3">
                <i class="bi bi-geo-alt"></i> <strong>üìç G√©olocalisation :</strong> Trouvez des ma√Ætres dans votre r√©gion, cr√©ez des rencontres locales, et construisez des communaut√©s d'apprentissage pr√®s de chez vous.
            </div>
        </div>

        <!-- Quick Help Card -->
        <div class="card mb-4" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.05)); border: 2px solid rgba(251, 191, 36, 0.3);">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-2">
                            <i class="bi bi-rocket-takeoff-fill text-warning"></i> 
                            <strong>Comment obtenir votre certification ?</strong>
                        </h6>
                        <ol class="mb-0 small" style="padding-left: 1.2rem;">
                            <li><strong>Cr√©ez votre demande</strong> avec la comp√©tence que vous souhaitez apprendre</li>
                            <li><strong>Trouvez un ma√Ætre</strong> qui valide vos comp√©tences - il vous faut <span id="helpRequiredAttestations">1</span> validation(s)</li>
                            <li><strong>Recevez votre certificat</strong> automatiquement - vous devenez ma√Ætre certifi√© !</li>
                            <li><strong>Progressez vers les niveaux sup√©rieurs</strong> (X2, X3, X4...) en accumulant comp√©tences et validations</li>
                        </ol>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="alert alert-info mb-0" style="font-size: 0.85rem;">
                            <i class="bi bi-star-fill"></i> <strong>Avantage</strong><br>
                            <small>Chaque validation r√©v√®le de nouvelles comp√©tences qui enrichissent automatiquement la ma√Ætrise pour tous</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
            <div class="col-md-4">
                <button class="btn btn-primary btn-lg w-100" onclick="showRequestModal()" 
                    data-bs-toggle="tooltip" data-bs-placement="top" 
                    title="L'extension Nostr avec la cl√© de votre MULTIPASS est requise pour la connexion."
                    id="btnBecomeApprentice">
                    <i class="bi bi-person-plus"></i> Devenir Apprenti
                </button>
                <small class="text-muted d-block mt-2 text-center">
                    <i class="bi bi-info-circle"></i> D√©marrez votre apprentissage
                </small>
            </div>
            <div class="col-md-4">
                <button class="btn btn-success btn-lg w-100" onclick="loadInstructors()" id="btnFindMaster">
                    <i class="bi bi-search"></i> Trouver un Ma√Ætre
                </button>
                <small class="text-muted d-block mt-2 text-center">
                    <i class="bi bi-people"></i> D√©couvrir les ma√Ætres certifi√©s
                </small>
            </div>
            <div class="col-md-4">
                <button class="btn btn-warning btn-lg w-100" onclick="location.reload()" id="btnRefresh">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                </button>
                <small class="text-muted d-block mt-2 text-center">
                    <i class="bi bi-arrow-repeat"></i> Recharger les donn√©es depuis Nostr
                </small>
            </div>
        </div>

        <!-- Instructors List -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-people"></i> Ma√Ætres Certifi√©s - Pr√™ts √† Enseigner
            </div>
            <div class="card-body" id="instructorsList">
                <div class="empty-state">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Chargement des ma√Ætres...</p>
                </div>
            </div>
        </div>

        <!-- Pending Requests -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Apprentis Cherchant un Ma√Ætre
            </div>
            <div class="card-body" id="pendingRequestsList">
                <div class="empty-state">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Chargement des apprentis...</p>
                </div>
            </div>
        </div>

        <!-- Events Tree View -->
        <div class="card mb-4" id="eventsTreeCard">
            <div class="card-header" style="background: linear-gradient(135deg, var(--water-blue), var(--water-dark)); color: white;">
                <h5 class="mb-0">
                    <i class="bi bi-diagram-3"></i> Vue Arborescente des √âv√©nements
                </h5>
            </div>
            <div class="card-body">
                <div id="eventsTreeView">
                    <div class="text-center text-muted">
                        <i class="bi bi-hourglass-split"></i> Chargement de la vue arborescente...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Permit Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-person-plus"></i> Devenir Apprenti - Cr√©er ma Demande d'Apprentissage
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="requestForm">
                        <div class="mb-3">
                            <label class="form-label"><strong>Choisir la ma√Ætrise :</strong> <span class="text-danger">*</span></label>
                            <select class="form-select" id="requestPermitSelect" required onchange="updateRequestAttestationsInfo(this.value)">
                                <option value="">-- S√©lectionner une ma√Ætrise --</option>
                            </select>
                            <small class="text-muted">S√©lectionnez la ma√Ætrise pour laquelle vous souhaitez cr√©er une demande d'apprentissage</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Votre d√©claration d'apprentissage <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="statement" rows="4" 
                                placeholder="D√©crivez pourquoi vous souhaitez apprendre cette ma√Ætrise, votre motivation, et ce que vous apporterez √† la communaut√©..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Comp√©tence r√©clam√©e <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="requestedCompetency" 
                                placeholder="Ex: Natation, Sauvetage, Aqua-fitness..." required>
                            <small class="text-muted">Indiquez la comp√©tence principale que vous souhaitez acqu√©rir dans cette ma√Ætrise</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Preuves de motivation (liens IPFS, photos, r√©alisations)</label>
                            <input type="text" class="form-control" id="evidence" 
                                placeholder="ipfs://Qm... (optionnel)">
                            <small class="text-muted">Vous pouvez ajouter plusieurs liens s√©par√©s par des virgules</small>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Comment √ßa se passe ?</strong>
                            <ol class="mb-0 mt-2">
                                <li>Vous cr√©ez votre demande avec la comp√©tence que vous voulez apprendre</li>
                                <li>Votre demande appara√Æt dans "Apprentis Cherchant un Ma√Ætre"</li>
                                <li>Un ma√Ætre certifi√© valide vos comp√©tences - il vous faut <strong id="requestRequiredAttestations">1</strong> validation(s)</li>
                                <li>Vous recevez automatiquement votre certificat de ma√Ætrise</li>
                                <li>Vous apparaissez dans "Ma√Ætres Certifi√©s" et pouvez √† votre tour enseigner</li>
                            </ol>
                            <p class="mb-0 mt-2"><strong>üí° Progression automatique :</strong> Une fois certifi√© niveau X1, le syst√®me cr√©e automatiquement le niveau X2, puis X3, X4... Vous progressez naturellement !</p>
                            <p class="mb-0 mt-2"><small><strong>üìç G√©olocalisation :</strong> Votre position permet aux ma√Ætres pr√®s de chez vous de vous trouver et de cr√©er des rencontres locales.</small></p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="submitRequest()">
                        <i class="bi bi-send"></i> Cr√©er ma Demande d'Apprentissage
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Permit Modal -->
    <div class="modal fade" id="newPermitModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-plus-circle"></i> Cr√©er une Nouvelle Ma√Ætrise WoTx2
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Ma√Ætrise Auto-Proclam√©e :</strong> Si aucun permit n'existe pour votre ma√Ætrise, 
                        vous pouvez cr√©er une ma√Ætrise auto-proclam√©e qui d√©marrera au niveau X1 (1 signature requise).
                        Le syst√®me √©voluera automatiquement vers X2, X3, etc. au fur et √† mesure des validations.
                    </div>
                    
                    <form id="newPermitForm">
                        <div class="mb-3">
                            <label class="form-label">
                                <strong>Ma√Ætrise Auto-Proclam√©e</strong> (ID g√©n√©r√© automatiquement)
                            </label>
                            <small class="text-muted d-block mt-1">
                                L'ID sera calcul√© automatiquement : <code id="autoPermitIdPreview">PERMIT_X1</code>
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nom de la Ma√Ætrise <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newPermitName" 
                                placeholder="Ex: Ma√Ætre Nageur" required
                                oninput="updateAutoPermitId()">
                            <small class="text-muted">Ce nom sera utilis√© pour g√©n√©rer l'ID automatiquement</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="newPermitDescription" rows="3" 
                                placeholder="D√©crivez cette ma√Ætrise en quelques mots..." required></textarea>
                        </div>
                        
                        <div class="alert alert-success">
                            <i class="bi bi-star"></i> 
                            <strong>üéØ Niveau X1 - Votre Point de D√©part :</strong> 
                            <ul class="mb-0 mt-2">
                                <li><strong>1 validation</strong> suffit pour obtenir votre certificat X1</li>
                                <li><strong>Progression automatique :</strong> Apr√®s X1, le syst√®me cr√©e X2 (2 comp√©tences), puis X3, X4...</li>
                                <li><strong>Illimit√© :</strong> Vous pouvez progresser jusqu'au niveau ma√Ætre (X4) et au-del√†</li>
                            </ul>
                            <p class="mb-0 mt-2"><strong>üí° Avantage :</strong> Plus vous progressez, plus votre ma√Ætrise devient riche en comp√©tences et reconnue par la communaut√© !</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success" onclick="submitNewPermit()">
                        <i class="bi bi-check-circle"></i> Cr√©er ma Ma√Ætrise
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attestation Modal -->
    <div class="modal fade" id="attestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> Attester une Demande - Transf√©rer vos Comp√©tences
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="attestForm">
                        <div class="mb-3">
                            <label class="form-label">Votre d√©claration d'attestation</label>
                            <textarea class="form-control" id="attestStatement" rows="4" 
                                placeholder="Je certifie que cette personne poss√®de les comp√©tences n√©cessaires..."></textarea>
                        </div>
                        
                        <!-- Competencies Selection (if holder has 30503) -->
                        <div class="mb-3" id="competenciesTransferSection" style="display: none;">
                            <label class="form-label">
                                <i class="bi bi-list-check"></i> Comp√©tences √† transf√©rer
                            </label>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> 
                                S√©lectionnez les comp√©tences que vous souhaitez transmettre √† cet apprenti. 
                                Ces comp√©tences seront ajout√©es √† son certificat de ma√Ætrise.
                            </div>
                            <div id="competenciesCheckboxes" class="mb-3">
                                <!-- Will be populated dynamically -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nouvelles comp√©tences r√©v√©l√©es (optionnel)</label>
                            <input type="text" class="form-control" id="revealedCompetencies" 
                                placeholder="Ex: Natation synchronis√©e, Sauvetage en eau vive, Aqua-fitness...">
                            <small class="text-muted">D√©crivez les comp√©tences suppl√©mentaires que vous avez observ√©es (seront ajout√©es au syst√®me)</small>
                        </div>
                        
                        <!-- Geolocation -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-geo-alt"></i> G√©olocalisation (optionnel)
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="attestLatitude" 
                                        step="0.000001" placeholder="Latitude">
                                </div>
                                <div class="col-md-6">
                                    <input type="number" class="form-control" id="attestLongitude" 
                                        step="0.000001" placeholder="Longitude">
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="getCurrentLocation()">
                                <i class="bi bi-crosshair"></i> Utiliser ma position actuelle
                            </button>
                            <small class="text-muted d-block mt-1">
                                Permet de d√©centraliser √©coles et syndicats - trouver des ma√Ætres pr√®s de vous
                            </small>
                        </div>
                        
                        <input type="hidden" id="attestRequestId">
                        <input type="hidden" id="attestApplicantNpub">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-success" onclick="submitAttestation()">
                        <i class="bi bi-check-circle"></i> Attester & Transf√©rer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.bundle.min.js"></script>
    
    <!-- NostrTools Bundle (required for common.js) -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js"></script>
    
    <!-- Common.js - UPlanet NOSTR utilities -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/common.js"></script>
    
    <script>
        // Use getAPIBaseUrl() from common.js instead of template variable
        // const uSPOT = "{{ uSPOT }}";  // Replaced by getAPIBaseUrl() from common.js
        const myIPFS = "{{ myIPFS }}";
        const IPFSNODEID = "{{ IPFSNODEID }}";  // IPFS Node ID for filtering events by Astroport
        const isPrimaryStation = {{ is_primary_station | tojson }};  // True if this is the primary station (ORACLE des ORACLES)
        // Variables will be set by common.js (userPubkey, nostrRelay, isNostrConnected)
        // We use local aliases for compatibility
        let userHEX = null;  // Will be set from userPubkey (common.js)
        let relay = null;     // Will be set from nostrRelay (common.js)
        
        // Helper function to get API base URL (uses common.js detection)
        function getWoTx2APIBaseUrl() {
            // Use getAPIBaseUrl() from common.js if available (detects API URL automatically)
            if (typeof window.getAPIBaseUrl === 'function') {
                try {
                    return window.getAPIBaseUrl();
                } catch (e) {
                    console.warn('[WoTx2] Error calling getAPIBaseUrl():', e);
                }
            }
            // Fallback to template variable or current origin if common.js not loaded
            const fallbackUrl = "{{ uSPOT }}" || window.location.origin;
            console.log('[WoTx2] Using fallback API URL:', fallbackUrl);
            return fallbackUrl;
        }
        // Permit data from server (only 30500 definitions)
        const permitDataRaw = {{ permit_data | tojson }};
        let permitData = permitDataRaw || {};
        // All permits list (from 30500 events)
        const allPermitsRaw = {{ all_permits | tojson }};
        const allPermits = allPermitsRaw || [];
        let selectedPermitId = "{{ selected_permit_id }}" || "PERMIT_DE_NAGER";
        
        // View mode: 'local' (this station only) or 'global' (all stations in constellation)
        let viewMode = 'local';  // Default to local view
        
        // Data loaded from Nostr (30501 requests, 30502 attestations, 30503 credentials)
        let permitRequests = [];  // kind 30501
        let permitAttestations = [];  // kind 30502
        let permitCredentials = [];  // kind 30503

        // Wait for NOSTR functions to load from common.js
        async function waitForNostrFunctions() {
            return new Promise((resolve) => {
                // Check if functions are already available
                    if (typeof connectToRelay === 'function' && typeof connectNostr === 'function') {
                    console.log('[WoTx2] ‚úÖ NOSTR functions already loaded from common.js');
                    resolve();
                    return;
                }
                
                const checkInterval = setInterval(() => {
                    // Check both window and global scope
                    const hasConnectToRelay = typeof connectToRelay === 'function' || typeof window.connectToRelay === 'function';
                    const hasConnectNostr = typeof connectNostr === 'function' || typeof window.connectNostr === 'function';
                    
                    if (hasConnectToRelay && hasConnectNostr) {
                        clearInterval(checkInterval);
                        console.log('[WoTx2] ‚úÖ NOSTR functions loaded from common.js');
                        resolve();
                    }
                }, 100);
                
                // Timeout after 15 seconds (increased from 10)
                setTimeout(() => {
                    clearInterval(checkInterval);
                    // Check one more time before warning
                    const hasConnectToRelay = typeof connectToRelay === 'function' || typeof window.connectToRelay === 'function';
                    const hasConnectNostr = typeof connectNostr === 'function' || typeof window.connectNostr === 'function';
                    
                    if (hasConnectToRelay && hasConnectNostr) {
                        console.log('[WoTx2] ‚úÖ NOSTR functions loaded (after timeout check)');
                    } else {
                        console.warn('[WoTx2] ‚ö†Ô∏è Timeout waiting for NOSTR functions - continuing anyway');
                    }
                    resolve();
                }, 15000);
            });
        }
        
        // Auto-connect to relay (public read access)
        async function autoConnectRelay() {
            try {
                console.log('[WoTx2] üåê Connecting to NOSTR relay...');
                updateStep(1, 'in-progress', 'Connexion au relay en cours...');
                
                if (typeof connectToRelay === 'function') {
                    await connectToRelay();
                    // Update local relay reference from common.js global
                    if (typeof nostrRelay !== 'undefined') {
                        relay = nostrRelay;
                    }
                    console.log('[WoTx2] ‚úÖ Connected to relay');
                    updateStep(1, 'success', 'Connect√© au relay NOSTR');
                    // Enable step 2
                    const step2Btn = document.getElementById('step2-btn');
                    if (step2Btn) {
                        step2Btn.disabled = false;
                    }
                    return true;
                } else {
                    console.warn('[WoTx2] ‚ö†Ô∏è connectToRelay function not available');
                    updateStep(1, 'error', 'Fonction connectToRelay non disponible');
                    return false;
                }
            } catch (error) {
                console.error('[WoTx2] ‚ùå Relay connection failed:', error);
                updateStep(1, 'error', 'Erreur de connexion au relay');
                return false;
            }
        }
        
        // Auto-connect user
        async function autoConnectUser() {
            try {
                console.log('[WoTx2] üîê Auto-connecting user...');
                updateStep(2, 'in-progress', 'Authentification en cours...');
                
                // Try to get pubkey from extension (no forced NIP-42 initially)
                if (typeof connectNostr === 'function') {
                    const pubkey = await connectNostr(false); // No force NIP-42
                    
                    if (pubkey) {
                        userHEX = pubkey;
                        // Update from common.js global if available
                        if (typeof userPubkey !== 'undefined') {
                            userHEX = userPubkey;
                        }
                        console.log('[WoTx2] ‚úÖ User pubkey retrieved:', userHEX.substring(0, 12) + '...');
                        updateStep(2, 'success', 'Authentifi√© avec MULTIPASS');
                        updateConnectionBadge(true, userHEX);
                        return true;
                    } else {
                        updateStep(2, 'pending', 'NIP-42 Auth - Acc√®s uDRIVE & GPS');
                    }
                }
                return false;
            } catch (error) {
                console.error('[WoTx2] ‚ùå User auto-connect failed:', error);
                updateStep(2, 'error', 'Erreur d\'authentification');
                return false;
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for common.js to load
            await waitForNostrFunctions();
            
            // Initialize view mode tabs
            initializeViewModeTabs();
            
            // Close connection panel when clicking outside
            document.addEventListener('click', function(event) {
                const badge = document.getElementById('connectionBadge');
                const panel = document.getElementById('connectionPanel');
                if (panel && badge && !badge.contains(event.target) && !panel.contains(event.target)) {
                    panel.classList.remove('show');
                }
            });
            
            // Step 1: Auto-connect to relay (public read access)
            const relayConnected = await autoConnectRelay();
            
            if (relayConnected) {
                // Step 2: Check for saved user and try auto-connect
                const savedPubkey = localStorage.getItem('nostr_pubkey');
                if (savedPubkey && typeof window.nostr !== 'undefined') {
                    console.log('[WoTx2] üîê Found saved pubkey, attempting auto-connect...');
                    await autoConnectUser();
                } else {
                    // Try to connect anyway
                    await autoConnectUser();
                }
                
                // Load data from Nostr
                await loadNostrData();
            }
            
            // Load UI components
            loadPermitSelector();
            
            // Always call loadData to initialize UI, even if relay is not connected
            loadData();
            
            // If relay is connected, loadNostrData will update the UI
            // If not connected, loadData will show empty states
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
        
        // Switch view mode (local/global)
        async function switchViewMode(mode) {
            viewMode = mode;
            
            // Update tab active state
            document.getElementById('local-tab').classList.toggle('active', mode === 'local');
            document.getElementById('global-tab').classList.toggle('active', mode === 'global');
            
            // Update view mode indicator
            const indicator = document.getElementById('view-mode-indicator');
            if (indicator) {
                if (mode === 'local') {
                    indicator.textContent = 'Vue Locale';
                    indicator.className = 'badge bg-primary ms-2';
                } else {
                    indicator.textContent = 'Vue Globale (Constellation)';
                    indicator.className = 'badge bg-success ms-2';
                }
            }
            
            // Reload data with new filters
            if (permitData && permitData.id) {
                await loadNostrData();
                loadData();
            }
            
            // Reload permits list
            await renderAllPermitsList();
        }
        
        // Initialize view mode tabs
        function initializeViewModeTabs() {
            const viewModeCard = document.getElementById('viewModeCard');
            const globalTabItem = document.getElementById('global-tab-item');
            const primaryBadge = document.getElementById('primary-badge');
            const viewModeIndicator = document.getElementById('view-mode-indicator');
            
            if (!viewModeCard) return;
            
            // Show tabs if primary station or if we want to show global view option
            // For now, only show global tab if primary station
            if (isPrimaryStation) {
                viewModeCard.style.display = 'block';
                if (globalTabItem) {
                    globalTabItem.style.display = 'block';
                }
                if (primaryBadge) {
                    primaryBadge.style.display = 'inline-block';
                }
                console.log('[WoTx2] ‚≠ê Primary station detected - Global view enabled');
            } else {
                // Hide global tab for non-primary stations
                viewModeCard.style.display = 'none';
                if (globalTabItem) {
                    globalTabItem.style.display = 'none';
                }
                console.log('[WoTx2] Standard station - Local view only');
            }
            
            // Update view mode indicator
            if (viewModeIndicator) {
                viewModeIndicator.textContent = 'Vue Locale';
                viewModeIndicator.className = 'badge bg-primary ms-2';
            }
        }
        
        // Load data from Nostr (30501 requests, 30502 attestations, 30503 credentials)
        async function loadNostrData() {
            if (!permitData || !permitData.id) {
                // Even if no permit data, show empty state
                loadInstructors();
                loadPendingRequests(1);
                return;
            }
            
            try {
                console.log('[WoTx2] Loading Nostr data for permit:', permitData.id);
                
                // Show loading indicators
                showLoadingIndicator('instructorsList', 'Chargement des ma√Ætres certifi√©s...');
                showLoadingIndicator('pendingRequestsList', 'Chargement des demandes...');
                
                // Build filters - only filter by IPFSNODEID in local mode
                const requestFilters = {
                    '#l': [permitData.id, 'permit_type']
                };
                if (viewMode === 'local' && IPFSNODEID) {
                    requestFilters['#ipfs_node'] = [IPFSNODEID];
                }
                // In global mode, don't filter by IPFSNODEID (get all events from constellation)
                
                // Load permit requests (kind 30501) for selected permit
                let requests = [];
                try {
                    const requestsRaw = await fetchNostrEvents(30501, requestFilters);
                    permitRequests = requestsRaw.map(parsePermitRequest).filter(r => r !== null);
                    requests = permitRequests;
                } catch (error) {
                    console.error('[WoTx2] Error loading requests:', error);
                    permitRequests = [];
                    // Continue with empty requests
                }
                
                // Build filters for credentials
                const credentialFilters = {
                    '#l': [permitData.id, 'permit_type']
                };
                if (viewMode === 'local' && IPFSNODEID) {
                    credentialFilters['#ipfs_node'] = [IPFSNODEID];
                }
                // In global mode, don't filter by IPFSNODEID
                
                // Load permit credentials (kind 30503) for selected permit
                let credentials = [];
                try {
                    const credentialsRaw = await fetchNostrEvents(30503, credentialFilters);
                    permitCredentials = credentialsRaw.map(parsePermitCredential).filter(c => c !== null);
                    credentials = permitCredentials;
                } catch (error) {
                    console.error('[WoTx2] Error loading credentials:', error);
                    permitCredentials = [];
                    // Continue with empty credentials
                }
                
                // Load permit attestations (kind 30502) for selected permit
                // We need to load all attestations and filter by permit later
                let attestations = [];
                try {
                    const attestationFilters = {};
                    if (viewMode === 'local' && IPFSNODEID) {
                        attestationFilters['#ipfs_node'] = [IPFSNODEID];
                    }
                    const attestationsRaw = await fetchNostrEvents(30502, attestationFilters);
                    permitAttestations = attestationsRaw.map(parsePermitAttestation).filter(a => a !== null);
                    attestations = permitAttestations;
                } catch (error) {
                    console.error('[WoTx2] Error loading attestations:', error);
                    permitAttestations = [];
                    // Continue with empty attestations
                }
                
                // Calculate required attestations
                const requiredAttestations = permitData.min_attestations || 1;
                
                console.log(`[WoTx2] Loaded ${requests.length} requests, ${attestations.length} attestations, and ${credentials.length} credentials`);
                
                // Update UI
                loadInstructors();
                loadPendingRequests(requiredAttestations);
                loadEventsTreeView();
                
                // Update mastery levels navigation and user progress
                if (permitData && permitData.id) {
                    updateMasteryLevelsNavigation({ id: permitData.id });
                    updateUserProgressIndicator({ id: permitData.id });
                    updateDeletePermitButton(permitData.id);
                }
            } catch (e) {
                console.error('[WoTx2] Error loading Nostr data:', e);
                // Show error messages
                showError('instructorsList',
                    'Impossible de charger les ma√Ætres certifi√©s. V√©rifiez votre connexion au relay NOSTR.',
                    '() => loadNostrData()'
                );
                showError('pendingRequestsList',
                    'Impossible de charger les demandes. V√©rifiez votre connexion au relay NOSTR.',
                    '() => loadNostrData()'
                );
                // Even on error, initialize empty arrays
                permitRequests = [];
                permitCredentials = [];
            }
        }
        
        // Fetch events from Nostr relay (using common.js nostrRelay)
        async function fetchNostrEvents(kind, filters = {}) {
            // Use nostrRelay from common.js if available
            if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                return new Promise((resolve, reject) => {
                    const events = [];
                    let resolved = false;
                    let sub = null;
                    
                    const closeSubscription = () => {
                        if (sub) {
                            try {
                                if (typeof sub.unsub === 'function') {
                                    sub.unsub();
                                } else if (typeof sub.close === 'function') {
                                    sub.close();
                                }
                            } catch (e) {
                                console.warn('[WoTx2] Error closing subscription:', e);
                            }
                        }
                    };
                    
                    // Timeout handler
                    const timeoutId = setTimeout(() => {
                        if (!resolved) {
                            resolved = true;
                            closeSubscription();
                            // Return what we have so far (might be empty, but better than error)
                            console.log(`[WoTx2] Timeout fetching kind ${kind}, returning ${events.length} events`);
                            resolve(events);
                        }
                    }, 1500);
                    
                    try {
                        // Try with callbacks first (if supported)
                        if (typeof nostrRelay.sub === 'function') {
                            try {
                                sub = nostrRelay.sub([{ kind, ...filters }], {
                            onevent: (event) => {
                                        if (event && event.id) {
                                events.push(event);
                                        }
                            },
                            oneose: () => {
                                        if (!resolved) {
                                            resolved = true;
                                            clearTimeout(timeoutId);
                                            closeSubscription();
                                resolve(events);
                            }
                                    },
                                    onerror: (error) => {
                                        console.error(`[WoTx2] Relay error for kind ${kind}:`, error);
                                        if (!resolved) {
                                            resolved = true;
                                            clearTimeout(timeoutId);
                                            closeSubscription();
                                            // Return what we have so far
                                resolve(events);
                            }
                                    }
                        });
                            } catch (e) {
                                // If callback syntax fails, try without callbacks and use .on()
                                console.log('[WoTx2] Callback syntax not supported, trying .on() syntax');
                                sub = nostrRelay.sub([{ kind, ...filters }]);
                                
                                if (sub && typeof sub.on === 'function') {
                                    sub.on('event', (event) => {
                                        if (event && event.id) {
                                        events.push(event);
                                        }
                                    });
                                    
                                    sub.on('eose', () => {
                                        if (!resolved) {
                                            resolved = true;
                                            clearTimeout(timeoutId);
                                            closeSubscription();
                                            resolve(events);
                                        }
                                    });
                                    
                                    sub.on('error', (error) => {
                                        console.error(`[WoTx2] Relay subscription error for kind ${kind}:`, error);
                            if (!resolved) {
                                resolved = true;
                                            clearTimeout(timeoutId);
                                closeSubscription();
                            resolve(events);
                            }
                                    });
                                } else {
                                    // Fallback: just wait for timeout
                                    console.warn('[WoTx2] Subscription object does not support .on() method');
                                }
                            }
                        } else {
                            console.warn('[WoTx2] nostrRelay.sub is not a function');
                            clearTimeout(timeoutId);
                            resolve([]);
                        }
                    } catch (e) {
                        console.error(`[WoTx2] Error fetching events kind ${kind}:`, e);
                        clearTimeout(timeoutId);
                        if (!resolved) {
                            resolved = true;
                            closeSubscription();
                            // Return empty array on error rather than rejecting
                            resolve([]);
                        }
                    }
                });
            } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                // Fallback: Use user's configured relays
                try {
                    const relays = await window.nostr.getRelays();
                    const relayUrls = Object.keys(relays);
                    
                    if (relayUrls.length === 0) {
                        console.warn('[WoTx2] No relays configured, cannot fetch events');
                        return [];
                    }
                    
                    const events = [];
                    for (const relayUrl of relayUrls) {
                        try {
                            const relay = new Relay(relayUrl);
                            await relay.connect();
                            const sub = relay.subscribe([{ kind, ...filters }], {
                                onevent: (event) => {
                                    if (event && event.id) {
                                        events.push(event);
                                    }
                                },
                                oneose: () => relay.close(),
                                onerror: (error) => {
                                    console.warn(`[WoTx2] Error from ${relayUrl}:`, error);
                                }
                            });
                            await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2s for events
                            relay.close();
                        } catch (e) {
                            console.warn(`[WoTx2] Failed to fetch from ${relayUrl}:`, e);
                        }
                    }
                    return events;
                } catch (e) {
                    console.error('[WoTx2] Error fetching from user relays:', e);
                    return [];
                }
            } else {
                console.warn('[WoTx2] No relay connection available');
            return [];
            }
        }
        
        // Parse permit request event (kind 30501)
        function parsePermitRequest(event) {
            try {
                const content = JSON.parse(event.content);
                return {
                    id: content.request_id || event.id,
                    applicant_npub: event.pubkey,
                    permit_definition_id: content.permit_definition_id,
                    statement: content.statement,
                    requested_competency: content.requested_competency || null, // Competency claimed
                    evidence: content.evidence || [],
                    status: content.status || 'pending',
                    created_at: new Date(event.created_at * 1000).toISOString(),
                    event_id: event.id,
                    attestations_count: 0  // Will be calculated from 30502 events
                };
            } catch (e) {
                console.error('Error parsing permit request:', e);
                return null;
            }
        }
        
        // Parse permit credential event (kind 30503)
        function parsePermitCredential(event) {
            try {
                const content = JSON.parse(event.content);
                return {
                    id: content.credential_id || event.id,
                    holder_npub: content.holder_npub || event.pubkey,
                    permit_definition_id: content.permit_definition_id,
                    issued_at: content.issued_at,
                    expires_at: content.expires_at,
                    attestations_count: content.attestations || 0,
                    event_id: event.id
                };
            } catch (e) {
                console.error('Error parsing permit credential:', e);
                return null;
            }
        }
        
        // Parse permit attestation event (kind 30502)
        function parsePermitAttestation(event) {
            try {
                const content = JSON.parse(event.content);
                // Get request_id from e tag (references the 30501 event)
                const eTag = event.tags.find(t => t[0] === 'e');
                const requestEventId = eTag ? eTag[1] : null;
                
                return {
                    id: content.attestation_id || event.id,
                    request_id: content.request_id || requestEventId,
                    request_event_id: requestEventId, // The Nostr event ID of the 30501
                    attester_npub: event.pubkey,
                    statement: content.statement,
                    competencies_transferred: content.competencies_transferred || [],
                    revealed_competencies: content.revealed_competencies || [],
                    location: content.location,
                    created_at: new Date(event.created_at * 1000).toISOString(),
                    event_id: event.id
                };
            } catch (e) {
                console.error('Error parsing permit attestation:', e);
                return null;
            }
        }
        
        // Count attestations for a request (kind 30502)
        async function countAttestations(requestId) {
            const filters = {
                '#e': [requestId]
            };
            // Only filter by IPFSNODEID in local mode
            if (viewMode === 'local' && IPFSNODEID) {
                filters['#ipfs_node'] = [IPFSNODEID];
            }
            const attestations = await fetchNostrEvents(30502, filters);
            return attestations.length;
        }
        
        // Count attestations for multiple requests in batch (optimized)
        async function countAttestationsBatch(requestIds) {
            if (!requestIds || requestIds.length === 0) return {};
            
            try {
                const filters = {
                    '#e': requestIds
                };
                // Only filter by IPFSNODEID in local mode
                if (viewMode === 'local' && IPFSNODEID) {
                    filters['#ipfs_node'] = [IPFSNODEID];
                }
                
                // Fetch all attestations at once
                const attestations = await fetchNostrEvents(30502, filters);
                
                // Group by request ID
                const counts = {};
                requestIds.forEach(id => counts[id] = 0);
                
                if (attestations && Array.isArray(attestations)) {
                    attestations.forEach(attestation => {
                        // Find which request this attestation references
                        const eTag = attestation.tags?.find(t => t[0] === 'e');
                        if (eTag && eTag[1]) {
                            const requestId = eTag[1];
                            if (counts.hasOwnProperty(requestId)) {
                                counts[requestId]++;
                            }
                        }
                    });
                }
                
                return counts;
            } catch (error) {
                console.error('[WoTx2] Error counting attestations batch:', error);
                // Return empty counts on error (better than crashing)
                const counts = {};
                requestIds.forEach(id => counts[id] = 0);
                return counts;
            }
        }
        
        // Utility: Show loading indicator
        function showLoadingIndicator(containerId, message = 'Chargement...') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = `
                <div class="col-12 text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">${message}</span>
                    </div>
                    <p class="mt-2 text-muted">${message}</p>
                </div>
            `;
        }
        
        // Utility: Show error message
        function showError(containerId, message, retryCallback = null) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let retryButton = '';
            if (retryCallback) {
                // Escape the callback to prevent XSS and ensure proper function call
                const escapedCallback = retryCallback.replace(/"/g, '&quot;');
                retryButton = `
                    <button class="btn btn-primary btn-sm mt-2" onclick="try { ${escapedCallback}(); } catch(e) { console.error('Retry error:', e); }">
                        <i class="bi bi-arrow-clockwise"></i> R√©essayer
                    </button>
                `;
            }
            
            // Escape message to prevent XSS
            const escapedMessage = message.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Erreur :</strong> ${escapedMessage}
                        ${retryButton}
                    </div>
                </div>
            `;
        }

        // MULTIPASS Connection using common.js (similar to youtube.html)
        async function checkMULTIPASSConnection() {
            try {
                // Use common.js connectNostr if available
                if (typeof connectNostr === 'function') {
                    try {
                        const pubkey = await connectNostr(false); // No force NIP-42 initially
                        if (pubkey) {
                            userHEX = pubkey;
                            // Sync with common.js global
                            if (typeof userPubkey !== 'undefined') {
                                userHEX = userPubkey;
                            }
                            updateConnectionBadge(true, userHEX);
                            return;
                        }
                    } catch (e) {
                        console.log('common.js connectNostr failed:', e);
                    }
                }
                
                // Fallback: Check if window.nostr is available
                if (window.nostr) {
                    try {
                        userHEX = await window.nostr.getPublicKey();
                        if (userHEX) {
                            updateConnectionBadge(true, userHEX);
                            return;
                        }
                    } catch (e) {
                        console.log('NOSTR extension not connected');
                    }
                }
                
                // Check URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const npubParam = urlParams.get('npub');
                if (npubParam) {
                    userHEX = npubParam;
                    updateConnectionBadge(true, npubParam);
                    return;
                }
                
                updateConnectionBadge(false, null);
            } catch (e) {
                console.error('Error checking MULTIPASS:', e);
                updateConnectionBadge(false, null);
            }
        }

        function updateConnectionBadge(authenticated, npub) {
            const badge = document.getElementById('connectionBadge');
            const content = document.getElementById('connection-badge-content');
            const connectBtn = document.getElementById('connectBtn');
            const panelStatusIcon = document.getElementById('panelStatusIcon');
            
            if (!badge || !content) return;
            
            // Remove all state classes
            badge.className = 'connection-badge';
            
            if (authenticated && npub) {
                badge.classList.add('authenticated');
                content.innerHTML = `
                    <span class="status-text">‚úÖ Authentifi√©</span>
                    <span class="user-npub">${npub.substring(0, 12)}...</span>
                `;
                // Replace connect button with profile button
                if (connectBtn) {
                    connectBtn.outerHTML = `
                        <button class="btn-profile" onclick="event.stopPropagation(); openUserProfile()">
                            <i class="bi bi-person-circle"></i>
                        </button>
                    `;
                }
                if (panelStatusIcon) {
                    panelStatusIcon.textContent = '‚úÖ';
                }
                // Update user info panel
                updateUserInfoPanel(npub);
            } else {
                badge.classList.add('disconnected');
                content.innerHTML = `
                    <span class="status-text">‚ö´ Non connect√©</span>
                `;
                // Restore connect button if it was replaced
                const profileBtn = badge.querySelector('.btn-profile');
                if (profileBtn) {
                    profileBtn.outerHTML = `
                        <button class="btn-connect" onclick="event.stopPropagation(); connectMULTIPASS()" id="connectBtn">
                            <i class="bi bi-key"></i> Connecter
                        </button>
                    `;
                } else if (connectBtn) {
                    connectBtn.style.display = 'block';
                    connectBtn.disabled = false;
                }
                if (panelStatusIcon) {
                    panelStatusIcon.textContent = '‚ö´';
                }
                // Hide user info panel
                const userInfoPanel = document.getElementById('user-info-panel');
                if (userInfoPanel) {
                    userInfoPanel.style.display = 'none';
                }
            }
        }
        
        // Toggle connection panel
        function toggleConnectionPanel() {
            const panel = document.getElementById('connectionPanel');
            if (panel) {
                panel.classList.toggle('show');
            }
        }
        
        // Update step status
        function updateStep(stepNum, status, description) {
            const step = document.getElementById(`step${stepNum}`);
            const desc = document.getElementById(`step${stepNum}-desc`);
            const btn = document.getElementById(`step${stepNum}-btn`);
            const reauthBtn = document.getElementById(`step${stepNum}-reauth-btn`);
            
            if (!step || !desc) return;
            
            // Remove all status classes
            step.className = 'connection-step';
            
            // Add new status
            step.classList.add(status);
            
            // Update description
            desc.textContent = description;
            
            // Update button state
            if (btn) {
                if (status === 'success') {
                    if (stepNum === 2) {
                        btn.disabled = true;
                        btn.textContent = '‚úì Termin√©';
                        if (reauthBtn) {
                            reauthBtn.style.display = 'inline-block';
                        }
                    } else {
                        btn.disabled = true;
                        btn.textContent = '‚úì Termin√©';
                    }
                } else if (status === 'in-progress') {
                    btn.disabled = true;
                    btn.textContent = '‚è≥ En cours...';
                    if (reauthBtn) {
                        reauthBtn.style.display = 'none';
                    }
                } else if (status === 'error') {
                    btn.disabled = false;
                    btn.textContent = 'R√©essayer';
                    if (reauthBtn) {
                        reauthBtn.style.display = 'none';
                    }
                } else {
                    // pending
                    btn.disabled = stepNum === 2;
                    btn.textContent = stepNum === 1 ? 'Connecter au Relay' : 'Authentifier avec MULTIPASS';
                    if (reauthBtn) {
                        reauthBtn.style.display = 'none';
                    }
                }
            }
        }
        
        // Update user info panel
        async function updateUserInfoPanel(npub) {
            const userInfoPanel = document.getElementById('user-info-panel');
            const pubkeyDisplay = document.getElementById('user-pubkey-display');
            const udriveRow = document.getElementById('udrive-row');
            const gpsRow = document.getElementById('gps-row');
            const gpsCoords = document.getElementById('gps-coords');
            
            if (!userInfoPanel || !pubkeyDisplay) return;
            
            // Show panel
            userInfoPanel.style.display = 'block';
            
            // Update pubkey display
            pubkeyDisplay.textContent = npub;
            pubkeyDisplay.onclick = () => {
                navigator.clipboard.writeText(npub).then(() => {
                    alert('‚úÖ Cl√© publique copi√©e !');
                });
            };
            
            // Try to get email from npub
            const email = await getEmailFromNpub(npub);
            if (email) {
                // Show uDRIVE link
                if (udriveRow) {
                    udriveRow.style.display = 'flex';
                }
                
                // Try to get GPS/UMAP info
                try {
                    const gpsInfo = await getGPSInfo(email);
                    if (gpsInfo && gpsRow && gpsCoords) {
                        gpsRow.style.display = 'flex';
                        gpsCoords.textContent = `UMAP: ${gpsInfo.latitude}, ${gpsInfo.longitude}`;
                    }
                } catch (e) {
                    console.log('GPS info not available:', e);
                }
            }
        }
        
        // Get email from npub (helper function)
        async function getEmailFromNpub(npub) {
            // Try to use common.js function if available
            if (typeof getEmailFromPubkey === 'function') {
                try {
                    return await getEmailFromPubkey(npub);
                } catch (e) {
                    console.log('getEmailFromPubkey error:', e);
                }
            }
            
            // Fallback: try to get from localStorage or URL
            const savedEmail = localStorage.getItem('user_email');
            if (savedEmail) {
                return savedEmail;
            }
            
            return null;
        }
        
        // Get GPS info (helper function)
        async function getGPSInfo(email) {
            if (!email) return null;
            
            // Try to get GPS from common.js if available
            if (typeof getUserGPS === 'function') {
                try {
                    return await getUserGPS(email);
                } catch (e) {
                    console.log('getUserGPS error:', e);
                }
            }
            
            // Try to get from localStorage
            const savedGPS = localStorage.getItem(`gps_${email}`);
            if (savedGPS) {
                try {
                    return JSON.parse(savedGPS);
                } catch (e) {
                    console.log('Error parsing saved GPS:', e);
                }
            }
            
            return null;
        }
        
        // Open user drive
        function openUserDrive() {
            if (!userHEX) {
                alert('‚ùå Non connect√©');
                return;
            }
            
            // Try to get email from npub
            getEmailFromNpub(userHEX).then(email => {
                if (email) {
                    const udriveUrl = `${myIPFS}/ipns/${email}/APP/uDRIVE`;
                    console.log('[WoTx2] üìÅ Opening uDRIVE:', udriveUrl);
                    window.open(udriveUrl, '_blank');
                } else {
                    alert('‚ùå Impossible de trouver votre uDRIVE');
                }
            });
        }
        
        // Open user profile
        function openUserProfile() {
            if (!userHEX) {
                alert('‚ùå Non connect√©');
                return;
            }
            
            // Open profile in new window using common.js if available
            if (typeof openProfileModal === 'function') {
                openProfileModal(userHEX, 'Mon Profil');
            } else {
                // Fallback: open in new tab
                const profileUrl = `${myIPFS}/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${userHEX}`;
                window.open(profileUrl, '_blank');
            }
        }
        
        // Manual connect relay
        async function manualConnectRelay() {
            updateStep(1, 'in-progress', 'Connexion au relay en cours...');
            try {
                if (typeof connectToRelay === 'function') {
                    await connectToRelay();
                    if (typeof nostrRelay !== 'undefined') {
                        relay = nostrRelay;
                    }
                    updateStep(1, 'success', 'Connect√© au relay NOSTR');
                    // Enable step 2
                    const step2Btn = document.getElementById('step2-btn');
                    if (step2Btn) {
                        step2Btn.disabled = false;
                    }
                } else {
                    throw new Error('connectToRelay function not available');
                }
            } catch (error) {
                console.error('Error connecting to relay:', error);
                updateStep(1, 'error', 'Erreur de connexion au relay');
            }
        }

        async function connectMULTIPASS() {
            // Ensure relay connection first
            if (!isNostrConnected || !nostrRelay) {
                updateStep(1, 'in-progress', 'Connexion au relay en cours...');
                if (typeof connectToRelay === 'function') {
                    try {
                        await connectToRelay();
                        // Update local relay reference
                        if (typeof nostrRelay !== 'undefined') {
                            relay = nostrRelay;
                        }
                        updateStep(1, 'success', 'Connect√© au relay NOSTR');
                    } catch (error) {
                        console.error('Error connecting to relay:', error);
                        updateStep(1, 'error', 'Erreur de connexion au relay');
                        alert('‚ùå Erreur lors de la connexion au relay.');
                        return;
                    }
                }
            }
            
            // Update step 2 to in-progress
            updateStep(2, 'in-progress', 'Authentification NIP-42 en cours...');
            
            // Use common.js connectNostr if available
            if (typeof connectNostr === 'function') {
                try {
                    const pubkey = await connectNostr(true); // forceAuth = true (NIP-42)
                    if (pubkey) {
                        userHEX = pubkey;
                        // Sync with common.js global
                        if (typeof userPubkey !== 'undefined') {
                            userHEX = userPubkey;
                        }
                        localStorage.setItem('nostr_pubkey', userHEX);
                        updateStep(2, 'success', 'Authentifi√© avec MULTIPASS');
                        updateConnectionBadge(true, userHEX);
                        
                        // Update URL with npub
                        const url = new URL(window.location);
                        url.searchParams.set('npub', userHEX);
                        window.history.pushState({}, '', url);
                        
                        // Reload data after connection
                        setTimeout(async () => {
                            await loadNostrData();
                            loadData();
                        }, 500);
                    } else {
                        updateStep(2, 'error', 'Connexion requise');
                        alert('‚ùå Connexion requise. Veuillez vous connecter avec NOSTR.');
                    }
                } catch (e) {
                    console.error('common.js connection error:', e);
                    updateStep(2, 'error', 'Erreur d\'authentification');
                    alert('Erreur de connexion MULTIPASS: ' + e.message);
                }
            } else if (window.nostr) {
                // Fallback to direct nostr extension
                try {
                    userHEX = await window.nostr.getPublicKey();
                    if (userHEX) {
                        localStorage.setItem('nostr_pubkey', userHEX);
                        updateStep(2, 'success', 'Connect√© avec extension NOSTR');
                        updateConnectionBadge(true, userHEX);
                        // Update URL with npub
                        const url = new URL(window.location);
                        url.searchParams.set('npub', userHEX);
                        window.history.pushState({}, '', url);
                    }
                } catch (e) {
                    updateStep(2, 'error', 'Erreur de connexion');
                    alert('Erreur de connexion MULTIPASS: ' + e.message);
                }
            } else {
                updateStep(2, 'error', 'Extension NOSTR non trouv√©e');
                alert('Extension NOSTR non trouv√©e. Installez une extension NOSTR pour vous connecter.');
            }
        }

        // Load permit data
        function loadData() {
            if (permitData && permitData.id) {
                // Check if bootstrap mode (no holders yet)
                const totalHolders = permitCredentials?.length || 0;
                const isBootstrap = totalHolders === 0;
                
                // WoTx2: Start with 1 attestation minimum, grows with competencies
                // Each level (x1, x2, x3, x4) adds competencies via 30502
                let requiredAttestations = permitData.min_attestations || 1;
                
                // Count competencies from all credentials (30503) to determine current level
                const allCompetencies = new Set();
                if (permitCredentials && permitCredentials.length > 0) {
                permitCredentials.forEach(cred => {
                        try {
                            const credContent = typeof cred.content === 'string' ? JSON.parse(cred.content) : cred.content || {};
                    const competencies = credContent.credentialSubject?.competencies || [];
                    competencies.forEach(c => allCompetencies.add(c));
                        } catch (e) {
                            console.warn('Error parsing credential content:', e);
                        }
                });
                }
                
                // If competencies exist, require more attestations (1 per competency, minimum 1)
                if (allCompetencies.size > 0) {
                    requiredAttestations = Math.max(1, allCompetencies.size);
                }
                
                // Update stats (use data from Nostr)
                const totalHoldersEl = document.getElementById('totalHolders');
                const totalRequestsEl = document.getElementById('totalRequests');
                const minAttestationsEl = document.getElementById('minAttestations');
                const requiredAttestationsEl = document.getElementById('requiredAttestations');
                const helpRequiredAttestations = document.getElementById('helpRequiredAttestations');
                
                if (totalHoldersEl) totalHoldersEl.textContent = permitCredentials?.length || 0;
                if (totalRequestsEl) totalRequestsEl.textContent = permitRequests?.length || 0;
                if (minAttestationsEl) minAttestationsEl.textContent = requiredAttestations;
                if (requiredAttestationsEl) requiredAttestationsEl.textContent = requiredAttestations;
                if (helpRequiredAttestations) helpRequiredAttestations.textContent = requiredAttestations;
                
                // Show bootstrap indicator if applicable
                if (isBootstrap) {
                    const statsCard = document.querySelector('.stats-card:last-child');
                    if (statsCard) {
                        statsCard.innerHTML = `
                            <div class="number" id="minAttestations">${requiredAttestations}</div>
                            <div class="label">Attestations requises <span class="badge bg-warning">Bootstrap</span></div>
                        `;
                    }
                    // Show bootstrap instructions
                    const bootstrapInstructions = document.getElementById('bootstrapInstructions');
                    if (bootstrapInstructions) {
                        bootstrapInstructions.style.display = 'block';
                    }
                }
                
                // Load instructors (from Nostr 30503) - always call to update UI
                loadInstructors();
                
                // Load pending requests (from Nostr 30501) - always call to update UI
                loadPendingRequests(requiredAttestations);
                
                // Load events tree view
                loadEventsTreeView();
            } else {
                // No permit data, show empty states
                loadInstructors();
                loadPendingRequests(1);
                // Hide tree view if no permit data
                const treeCard = document.getElementById('eventsTreeCard');
                if (treeCard) {
                    treeCard.style.display = 'none';
                }
            }
        }

        function loadInstructors() {
            const listEl = document.getElementById('instructorsList');
            if (!listEl) return;
            
            // Ensure permitCredentials is initialized
            if (!permitCredentials) {
                permitCredentials = [];
            }
            
            // Use credentials from Nostr (30503)
            if (permitCredentials.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-people"></i>
                        <p><strong>0</strong> ma√Ætre certifi√© pour le moment.</p>
                        <p class="text-muted">Soyez le premier √† obtenir le permis !</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            permitCredentials.forEach(holder => {
                // Check if this permit is auto-proclaimed and get level
                const permit = allPermits.find(p => p.id === holder.permit_definition_id);
                const levelMatch = holder.permit_definition_id?.match(/_X(\d+)$/);
                const levelBadge = levelMatch ? `<span class="badge bg-primary ms-2">Niveau ${levelMatch[1]}</span>` : '';
                
                html += `
                    <div class="instructor-card card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    <h5 class="mb-2">
                                        <i class="bi bi-person-badge text-primary"></i>
                                        Ma√Ætre Certifi√©
                                        ${levelBadge}
                                    </h5>
                                    <p class="text-muted mb-1">
                                        <code>${holder.holder_npub.substring(0, 16)}...</code>
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-check-circle"></i> 
                                        ${holder.attestations_count || 0} attestation(s)
                                    </small>
                                    ${permit && permit.id.match(/^PERMIT_/) ? `
                                        <div class="mt-2">
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle"></i> 
                                                Ma√Ætrise auto-proclam√©e - Peut attester d'autres apprentis
                                    </small>
                                        </div>
                                    ` : ''}
                                    
                                    <!-- Badge NIP-58 -->
                                    <div class="mt-3">
                                        <small class="d-block mb-2" style="color: #6b7280;">
                                            <i class="bi bi-award-fill"></i> Badge :
                                        </small>
                                        <div id="badge-${holder.holder_npub}-${holder.permit_definition_id}" class="instructor-badge-container" style="min-height: 64px;">
                                            <div style="text-align: center; color: #94a3b8; font-size: 0.85rem;">
                                                <i class="bi bi-hourglass-split"></i> Chargement...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-end">
                                    ${userHEX && userHEX !== holder.holder_npub ? `
                                        <button class="btn btn-sm btn-success" onclick="showAttestModal('${holder.holder_npub}')">
                                            <i class="bi bi-chat-dots"></i> Contacter
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
            
            // Load badges for each instructor after rendering
            permitCredentials.forEach(holder => {
                loadInstructorBadge(holder.holder_npub, holder.permit_definition_id);
            });
        }
        
        // Load badge for a specific instructor
        async function loadInstructorBadge(holderNpub, permitId) {
            const container = document.getElementById(`badge-${holderNpub}-${permitId}`);
            if (!container) return;
            
            try {
                // Fetch user badges
                if (typeof window.fetchUserBadges === 'function') {
                    const badges = await window.fetchUserBadges(holderNpub, window.DEFAULT_RELAYS);
                    
                    // Find badge for this permit
                    const permitBadge = badges.find(badge => {
                        const badgePermitId = badge.metadata?.permitId;
                        return badgePermitId === permitId;
                    });
                    
                    if (permitBadge && permitBadge.metadata) {
                        const badgeHtml = window.renderBadge(permitBadge, { 
                            size: 'medium', 
                            showName: true, 
                            showTooltip: true 
                        });
                        container.innerHTML = badgeHtml;
                    } else {
                        // Try to load badge definition directly
                        const badgeId = permitId.toLowerCase().replace('permit_', '').replace(/_/g, '_');
                        const officialBadges = {
                            'ore_v1': 'ore_verifier',
                            'driver': 'driver_license',
                            'medical_first_aid': 'first_aid_provider',
                            'building_artisan': 'building_artisan',
                            'wot_dragon': 'wot_dragon'
                        };
                        const finalBadgeId = officialBadges[badgeId] || `permit_${badgeId}`;
                        
                        if (typeof window.fetchBadgeDefinition === 'function') {
                            const badgeDef = await window.fetchBadgeDefinition(finalBadgeId, null, window.DEFAULT_RELAYS);
                            if (badgeDef) {
                                const metadata = window.parseBadgeDefinition(badgeDef);
                                if (metadata && metadata.image) {
                                    const badgeHtml = window.renderBadge({
                                        awardEvent: null,
                                        definitionEvent: badgeDef,
                                        metadata: metadata,
                                        badgeId: finalBadgeId
                                    }, { size: 'medium', showName: true, showTooltip: true });
                                    container.innerHTML = badgeHtml;
                                } else {
                                    container.innerHTML = '<div style="text-align: center; color: #94a3b8; font-size: 0.85rem;">Badge non disponible</div>';
                                }
                            } else {
                                container.innerHTML = '<div style="text-align: center; color: #94a3b8; font-size: 0.85rem;">Badge √† venir</div>';
                            }
                        } else {
                            container.innerHTML = '<div style="text-align: center; color: #94a3b8; font-size: 0.85rem;">Fonctions badges non charg√©es</div>';
                        }
                    }
                } else {
                    container.innerHTML = '<div style="text-align: center; color: #94a3b8; font-size: 0.85rem;">Fonctions badges non charg√©es</div>';
                }
            } catch (error) {
                console.error(`Error loading badge for ${holderNpub}:`, error);
                container.innerHTML = '<div style="text-align: center; color: #ef4444; font-size: 0.85rem;">Erreur chargement badge</div>';
            }
        }

        async function loadPendingRequests(requiredAttestations) {
            const listEl = document.getElementById('pendingRequestsList');
            if (!listEl) return;
            
            try {
                // Show loading indicator
                showLoadingIndicator('pendingRequestsList', 'Chargement des demandes d\'apprentissage...');
            
            // Ensure permitRequests is initialized
            if (!permitRequests) {
                permitRequests = [];
            }
            
            // Filter requests: only show those without 30503 credentials (still apprentices)
            const pendingRequests = [];
            for (const request of permitRequests) {
                // Check if this applicant already has a 30503 credential for this permit
                const hasCredential = permitCredentials.some(cred => 
                    cred.holder_npub === request.applicant_npub && 
                    cred.permit_definition_id === request.permit_definition_id
                );
                
                // Only include requests without credentials (still apprentices)
                if (!hasCredential) {
                    pendingRequests.push(request);
                }
            }
            
            // Use requests from Nostr (30501) - only those without 30503
            if (pendingRequests.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p><strong>0</strong> demande en attente.</p>
                        <p class="text-muted">Aucun apprenti ne cherche de ma√Ætre pour le moment.</p>
                        <p class="text-muted small">Les demandes valid√©es (avec 30503) apparaissent dans "Ma√Ætres Certifi√©s".</p>
                    </div>
                `;
                return;
            }
            
            // Use provided requiredAttestations or fallback to min_attestations
            const reqAttest = requiredAttestations || permitData.min_attestations || 1;
                
                // Show progress: counting attestations
                showLoadingIndicator('pendingRequestsList', `Comptage des attestations (${pendingRequests.length} demande(s))...`);
                
                // Optimize: Count all attestations in batch instead of one by one
                const requestIds = pendingRequests.map(r => r.id);
                let attestationCounts = {};
                
                try {
                    attestationCounts = await countAttestationsBatch(requestIds);
                } catch (error) {
                    console.error('[WoTx2] Error counting attestations:', error);
                    // Continue with empty counts rather than failing completely
                    requestIds.forEach(id => attestationCounts[id] = 0);
                }
            
            let html = '';
            for (const request of pendingRequests) {
                // Get attestation count from batch result
                const attestCount = attestationCounts[request.id] || 0;
                request.attestations_count = attestCount;
                const progress = (request.attestations_count / reqAttest) * 100;
                const isMyRequest = userHEX && userHEX === request.applicant_npub;
                const canAttest = userHEX && userHEX !== request.applicant_npub;
                
                html += `
                    <div class="card mb-3 ${isMyRequest ? 'border-primary' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-1">
                                        ${isMyRequest ? '<i class="bi bi-person-check text-primary"></i> ' : ''}
                                        Demande #${request.id.substring(0, 8)}
                                        ${isMyRequest ? '<span class="badge bg-primary ms-2">Ma demande</span>' : ''}
                                    </h6>
                                    <p class="text-muted mb-1">
                                        <code>${request.applicant_npub.substring(0, 16)}...</code>
                                    </p>
                                    <p class="mb-0">${request.statement}</p>
                                    ${request.requested_competency ? `
                                        <div class="mt-2">
                                            <span class="badge bg-info">
                                                <i class="bi bi-star"></i> Comp√©tence r√©clam√©e: ${request.requested_competency}
                                            </span>
                                        </div>
                                    ` : ''}
                                    ${request.created_at ? `
                                        <small class="text-muted d-block mt-2">
                                            <i class="bi bi-clock"></i> Cr√©√©e le ${new Date(request.created_at).toLocaleString('fr-FR')}
                                        </small>
                                    ` : ''}
                                </div>
                                <span class="badge bg-${request.status === 'attesting' ? 'warning' : request.status === 'validated' ? 'success' : 'secondary'}">
                                    ${request.status}
                                </span>
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <small>Attestations: ${request.attestations_count} / ${reqAttest}</small>
                                    <small>${Math.round(progress)}%</small>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar ${progress >= 100 ? 'bg-success' : ''}" style="width: ${Math.min(progress, 100)}%"></div>
                                </div>
                            </div>
                            ${isMyRequest ? `
                                <div class="alert alert-info mt-3 mb-0">
                                    <i class="bi bi-info-circle"></i> 
                                    <strong>Votre demande</strong> - Vous √™tes apprenti, cherchez un ma√Ætre !
                                    ${request.attestations_count >= reqAttest ? 
                                        ' <strong>‚úÖ Seuil atteint !</strong> Votre certificat sera d√©livr√© automatiquement dans les prochaines heures.' : 
                                        ' Il vous reste ' + (reqAttest - request.attestations_count) + ' validation(s) √† obtenir pour recevoir votre certificat.'
                                    }
                                </div>
                            ` : ''}
                            ${canAttest ? `
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-success" onclick="showAttestModal('${request.applicant_npub}', '${request.id}')"
                                            data-bs-toggle="tooltip" 
                                            data-bs-placement="top"
                                            title="En tant que ma√Ætre certifi√©, vous pouvez attester cet apprenti et transf√©rer vos comp√©tences">
                                        <i class="bi bi-check-circle"></i> 
                                        ${request.attestations_count < reqAttest ? 
                                            'üë®‚Äçüè´ Valider cet Apprenti' : 
                                            'Valider cette Demande'}
                                    </button>
                                    <small class="text-muted d-block mt-1">
                                        ${request.attestations_count < reqAttest ? 
                                            'üí° <strong>Apprenti cherche ma√Ætre</strong> - Validez ses comp√©tences et r√©v√©lez de nouveaux talents que vous avez observ√©s. Vous enrichissez la ma√Ætrise pour toute la communaut√© !' : 
                                            'En validant cet apprenti, vous lui permettez d\'obtenir son certificat automatiquement. Vous contribuez √† construire une communaut√© de comp√©tences reconnues.'}
                                    </small>
                                </div>
                            ` : ''}
                            ${!userHEX ? `
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-primary" onclick="connectMULTIPASS()">
                                        <i class="bi bi-wallet2"></i> Connecter MULTIPASS pour attester
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            listEl.innerHTML = html;
            } catch (error) {
                console.error('[WoTx2] Error loading pending requests:', error);
                const reqAttest = requiredAttestations || 1;
                showError('pendingRequestsList', 
                    'Impossible de charger les demandes d\'apprentissage. V√©rifiez votre connexion au relay NOSTR.',
                    `() => loadPendingRequests(${reqAttest})`
                );
            }
        }
        
        // Load events tree view (arborescente)
        async function loadEventsTreeView() {
            const treeViewEl = document.getElementById('eventsTreeView');
            if (!treeViewEl) return;
            
            // Show tree view card only if we have permit data
            const treeCard = document.getElementById('eventsTreeCard');
            if (treeCard) {
                if (permitData && permitData.id) {
                    treeCard.style.display = 'block';
                } else {
                    treeCard.style.display = 'none';
                    return;
                }
            }
            
            try {
                // Filter attestations for this permit
                const permitAttestationsFiltered = permitAttestations.filter(att => {
                    // Find the request this attestation references
                    const request = permitRequests.find(req => req.event_id === att.request_event_id);
                    return request && request.permit_definition_id === permitData.id;
                });
                
                // Filter requests for this permit
                const permitRequestsFiltered = permitRequests.filter(req => req.permit_definition_id === permitData.id);
                
                // Filter credentials for this permit
                const permitCredentialsFiltered = permitCredentials.filter(cred => cred.permit_definition_id === permitData.id);
                
                if (permitRequestsFiltered.length === 0 && permitCredentialsFiltered.length === 0) {
                    treeViewEl.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-inbox"></i>
                            <p class="mt-2">Aucun √©v√©nement pour cette ma√Ætrise pour le moment.</p>
                            <p class="small">Cr√©ez une demande d'apprentissage pour commencer !</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="tree-view">';
                
                // Root: PERMIT (30500) with Bootstrap Accordion
                const permitStats = {
                    requests: permitRequestsFiltered.length,
                    attestations: permitAttestationsFiltered.length,
                    credentials: permitCredentialsFiltered.length
                };
                
                html += `
                    <div class="tree-node tree-root mb-4">
                        <div class="tree-item card event-card event-card-30500 shadow-sm">
                            <div class="card-header bg-primary bg-gradient text-white d-flex justify-content-between align-items-center collapse-toggle" 
                                 data-bs-toggle="collapse" 
                                 data-bs-target="#permitDetails" 
                                 aria-expanded="true"
                                 style="cursor: pointer;">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-shield-check fs-4"></i>
                                    <div>
                                        <div class="d-flex align-items-center gap-2">
                                            <strong class="fs-5">PERMIT (30500)</strong>
                                            <span class="badge bg-light text-dark event-badge">${permitData.name}</span>
                                        </div>
                                        <small class="text-white-50 d-block mt-1">
                                            <i class="bi bi-diagram-3"></i> ${permitStats.requests} demande(s) ‚Ä¢ ${permitStats.attestations} attestation(s) ‚Ä¢ ${permitStats.credentials} certificat(s)
                                        </small>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <code class="text-white-50 small">${permitData.id}</code>
                                    <i class="bi bi-chevron-down text-white-50"></i>
                                </div>
                            </div>
                            <div id="permitDetails" class="collapse show">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <p class="mb-2">
                                                <i class="bi bi-file-text text-primary"></i> 
                                                <strong>Description :</strong>
                                            </p>
                                            <p class="text-muted mb-0">${permitData.description || 'N/A'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex flex-column gap-2">
                                                <div>
                                                    <span class="badge bg-info event-badge">
                                                        <i class="bi bi-check-circle"></i> ${permitData.min_attestations || 1} attestation(s) requise(s)
                                                    </span>
                                                </div>
                                                ${permitData.metadata?.category === 'auto_proclaimed' ? `
                                                    <div>
                                                        <span class="badge bg-warning text-dark event-badge">
                                                            <i class="bi bi-stars"></i> Ma√Ætrise Auto-Proclam√©e
                                                        </span>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;
                
                // Children: Requests (30501) with Bootstrap Accordion
                if (permitRequestsFiltered.length > 0) {
                    html += '<div class="tree-children ms-4 mt-3">';
                    
                    permitRequestsFiltered.forEach((request, reqIndex) => {
                        // Find attestations for this request
                        const requestAttestations = permitAttestationsFiltered.filter(att => 
                            att.request_event_id === request.event_id
                        );
                        
                        // Find credential for this request
                        const requestCredential = permitCredentialsFiltered.find(cred => {
                            // Check if credential references this request
                            return cred.holder_npub === request.applicant_npub;
                        });
                        
                        // Check if user can delete this request (must be creator and no 30503)
                        const canDelete = userHEX && 
                            request.applicant_npub === userHEX && 
                            !requestCredential;
                        
                        const isMyRequest = userHEX && request.applicant_npub === userHEX;
                        const progressPercent = Math.min(100, (requestAttestations.length / (permitData.min_attestations || 1)) * 100);
                        const requestId = `request-${reqIndex}`;
                        
                        html += `
                            <div class="tree-node mb-3">
                                <div class="tree-item card event-card event-card-30501 shadow-sm">
                                    <div class="card-header bg-info bg-gradient text-white d-flex justify-content-between align-items-center collapse-toggle" 
                                         data-bs-toggle="collapse" 
                                         data-bs-target="#${requestId}" 
                                         aria-expanded="${reqIndex === 0 ? 'true' : 'false'}"
                                         style="cursor: pointer;">
                                        <div class="d-flex align-items-center gap-2 flex-grow-1">
                                            <i class="bi bi-file-earmark-text fs-5"></i>
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <strong>Demande (30501)</strong>
                                                    <span class="badge bg-light text-dark event-badge">
                                                        <i class="bi bi-people"></i> ${requestAttestations.length}/${permitData.min_attestations || 1}
                                                    </span>
                                                    ${requestCredential ? `
                                                        <span class="badge bg-success event-badge">
                                                            <i class="bi bi-award"></i> Certifi√©
                                                        </span>
                                                    ` : `
                                                        <span class="badge bg-warning text-dark event-badge">
                                                            <i class="bi bi-clock"></i> En attente
                                                        </span>
                                                    `}
                                                    ${isMyRequest ? `
                                                        <span class="badge bg-primary event-badge">
                                                            <i class="bi bi-person-check"></i> Ma demande
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                <div class="mt-1">
                                                    <small class="text-white-50">
                                                        <i class="bi bi-person"></i> ${request.applicant_npub.substring(0, 16)}...
                                                        <span class="ms-2">
                                                            <i class="bi bi-calendar"></i> ${new Date(request.created_at).toLocaleDateString('fr-FR')}
                                                        </span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            ${canDelete ? `
                                                <button class="btn btn-sm btn-danger" 
                                                        onclick="event.stopPropagation(); deleteEvent('30501', '${request.event_id}', '${request.id}')" 
                                                        data-bs-toggle="tooltip" 
                                                        data-bs-placement="top"
                                                        title="Supprimer cette demande">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            ` : ''}
                                            <i class="bi bi-chevron-down text-white-50"></i>
                                        </div>
                                    </div>
                                    <div id="${requestId}" class="collapse ${reqIndex === 0 ? 'show' : ''}">
                                        <div class="card-body">
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-6">
                                                    <p class="mb-2">
                                                        <i class="bi bi-chat-quote text-info"></i> 
                                                        <strong>D√©claration :</strong>
                                                    </p>
                                                    <p class="text-muted mb-0">${request.statement || 'N/A'}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    ${request.requested_competency ? `
                                                        <p class="mb-2">
                                                            <i class="bi bi-star text-warning"></i> 
                                                            <strong>Comp√©tence r√©clam√©e :</strong>
                                                        </p>
                                                        <span class="badge bg-warning text-dark">${request.requested_competency}</span>
                                                    ` : ''}
                                                    <p class="mb-0 mt-2">
                                                        <i class="bi bi-clock-history text-muted"></i> 
                                                        <small class="text-muted">
                                                            Cr√©√©e le ${new Date(request.created_at).toLocaleString('fr-FR')}
                                                        </small>
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            ${!requestCredential ? `
                                                <div class="mb-3">
                                                    <div class="d-flex justify-content-between mb-1">
                                                        <small class="text-muted">
                                                            <i class="bi bi-check-circle"></i> Progression des attestations
                                                        </small>
                                                        <small class="text-muted">${Math.round(progressPercent)}%</small>
                                                    </div>
                                                    <div class="progress" style="height: 25px;">
                                                        <div class="progress-bar ${progressPercent >= 100 ? 'bg-success' : 'bg-info'} progress-bar-striped ${progressPercent >= 100 ? '' : 'progress-bar-animated'}" 
                                                             role="progressbar" 
                                                             style="width: ${progressPercent}%">
                                                            ${requestAttestations.length} / ${permitData.min_attestations || 1}
                                                        </div>
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            <div class="d-flex gap-2 flex-wrap">
                                                ${!requestCredential && userHEX && userHEX !== request.applicant_npub ? `
                                                    <button class="btn btn-success btn-sm" 
                                                            onclick="addAttestationToRequest('${request.event_id}', '${request.id}')"
                                                            data-bs-toggle="tooltip"
                                                            data-bs-placement="top"
                                                            title="Attester cette demande et valider les comp√©tences de l'apprenti">
                                                        <i class="bi bi-check-circle"></i> Ajouter ma signature
                                                    </button>
                                                ` : ''}
                                                ${requestCredential ? `
                                                    <span class="badge bg-success fs-6 p-2">
                                                        <i class="bi bi-award"></i> Certificat d√©livr√© le ${requestCredential.issued_at ? new Date(requestCredential.issued_at).toLocaleDateString('fr-FR') : 'N/A'}
                                                    </span>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        `;
                        
                        // Children: Attestations (30502) with Bootstrap List Group
                        if (requestAttestations.length > 0) {
                            html += `
                                <div class="tree-children ms-4 mt-2">
                                    <div class="card border-success border-2">
                                        <div class="card-header bg-success bg-gradient text-white py-2">
                                            <small>
                                                <i class="bi bi-list-check"></i> 
                                                <strong>${requestAttestations.length} Attestation(s) (30502)</strong>
                                            </small>
                                        </div>
                                        <div class="list-group list-group-flush">
                            `;
                            
                            requestAttestations.forEach((attestation, attIndex) => {
                                // Check if user can delete this attestation (must be creator and no 30503)
                                const canDeleteAtt = userHEX && 
                                    attestation.attester_npub === userHEX && 
                                    !requestCredential;
                                
                                const isMyAttestation = userHEX && attestation.attester_npub === userHEX;
                                const attestationId = `attestation-${reqIndex}-${attIndex}`;
                                
                                html += `
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center gap-2 mb-2">
                                                    <i class="bi bi-check-circle-fill text-success fs-5"></i>
                                                    <strong>Attestation (30502)</strong>
                                                    ${isMyAttestation ? `
                                                        <span class="badge bg-primary event-badge">
                                                            <i class="bi bi-person-check"></i> Ma validation
                                                        </span>
                                                    ` : ''}
                                                    <span class="badge bg-secondary event-badge">
                                                        <i class="bi bi-calendar"></i> ${new Date(attestation.created_at).toLocaleDateString('fr-FR')}
                                                    </span>
                                                </div>
                                                <p class="mb-2">
                                                    <i class="bi bi-person-badge text-success"></i> 
                                                    <strong>Attesteur :</strong> 
                                                    <code class="small">${attestation.attester_npub.substring(0, 16)}...</code>
                                                </p>
                                                ${attestation.statement ? `
                                                    <div class="alert alert-light py-2 mb-2">
                                                        <i class="bi bi-chat-quote text-muted"></i> 
                                                        <small>${attestation.statement}</small>
                                                    </div>
                                                ` : ''}
                                                <div class="d-flex flex-wrap gap-2">
                                                    ${attestation.competencies_transferred && attestation.competencies_transferred.length > 0 ? `
                                                        <div>
                                                            <small class="text-muted d-block mb-1">
                                                                <i class="bi bi-arrow-right-circle"></i> Comp√©tences transf√©r√©es :
                                                            </small>
                                                            ${attestation.competencies_transferred.map(comp => `
                                                                <span class="badge bg-info text-dark me-1 mb-1">${comp}</span>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                    ${attestation.revealed_competencies && attestation.revealed_competencies.length > 0 ? `
                                                        <div>
                                                            <small class="text-muted d-block mb-1">
                                                                <i class="bi bi-star"></i> Nouvelles comp√©tences r√©v√©l√©es :
                                                            </small>
                                                            ${attestation.revealed_competencies.map(comp => `
                                                                <span class="badge bg-warning text-dark me-1 mb-1">${comp}</span>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            ${canDeleteAtt ? `
                                                <button class="btn btn-sm btn-outline-danger ms-2" 
                                                        onclick="deleteEvent('30502', '${attestation.event_id}', '${attestation.id}')" 
                                                        data-bs-toggle="tooltip"
                                                        data-bs-placement="left"
                                                        title="Supprimer cette attestation">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            html += `
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Child: Credential (30503) if exists - Bootstrap Alert with success
                        if (requestCredential) {
                            const expiresAt = requestCredential.expires_at ? new Date(requestCredential.expires_at) : null;
                            const now = new Date();
                            const isExpired = expiresAt && expiresAt < now;
                            const daysUntilExpiry = expiresAt ? Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24)) : null;
                            
                            html += `
                                <div class="tree-children ms-4 mt-2">
                                    <div class="alert alert-success border-3 shadow-sm mb-0">
                                        <div class="d-flex align-items-start gap-3">
                                            <div class="flex-shrink-0">
                                                <i class="bi bi-award-fill fs-1 text-success"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h5 class="alert-heading mb-2">
                                                    <i class="bi bi-shield-check"></i> Validation (30503) - Certificat D√©livr√©
                                                </h5>
                                                <hr>
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <p class="mb-2">
                                                            <i class="bi bi-person-badge text-success"></i> 
                                                            <strong>D√©tenteur :</strong>
                                                        </p>
                                                        <code class="small">${requestCredential.holder_npub.substring(0, 16)}...</code>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <p class="mb-2">
                                                            <i class="bi bi-calendar-check text-success"></i> 
                                                            <strong>D√©livr√© le :</strong>
                                                        </p>
                                                        <span class="badge bg-success">${requestCredential.issued_at ? new Date(requestCredential.issued_at).toLocaleString('fr-FR') : 'N/A'}</span>
                                                    </div>
                                                </div>
                                                ${expiresAt ? `
                                                    <div class="mt-3">
                                                        <p class="mb-1">
                                                            <i class="bi bi-calendar-x ${isExpired ? 'text-danger' : daysUntilExpiry <= 30 ? 'text-warning' : 'text-success'}"></i> 
                                                            <strong>Expire le :</strong>
                                                        </p>
                                                        <span class="badge ${isExpired ? 'bg-danger' : daysUntilExpiry <= 30 ? 'bg-warning text-dark' : 'bg-success'}">
                                                            ${new Date(requestCredential.expires_at).toLocaleString('fr-FR')}
                                                            ${!isExpired && daysUntilExpiry ? ` (${daysUntilExpiry} jour(s))` : ''}
                                                        </span>
                                                    </div>
                                                ` : `
                                                    <div class="mt-3">
                                                        <span class="badge bg-info">
                                                            <i class="bi bi-infinity"></i> Aucune expiration
                                                        </span>
                                                    </div>
                                                `}
                                                <div class="mt-3">
                                                    <span class="badge bg-success fs-6 p-2">
                                                        <i class="bi bi-check-circle-fill"></i> ${requestCredential.attestations_count || requestAttestations.length} attestation(s) valid√©e(s)
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div>';
                }
                
                html += '</div></div>';
                
                treeViewEl.innerHTML = html;
                
                // Initialize Bootstrap tooltips
                const tooltipTriggerList = [].slice.call(treeViewEl.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            } catch (error) {
                console.error('[WoTx2] Error loading events tree view:', error);
                treeViewEl.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Erreur lors du chargement de la vue arborescente : ${error.message}
                    </div>
                `;
            }
        }
        
        // Add attestation to a request (from tree view)
        async function addAttestationToRequest(requestEventId, requestId) {
            // Find the request
            const request = permitRequests.find(req => req.event_id === requestEventId);
            if (!request) {
                alert('Erreur: Demande non trouv√©e.');
                return;
            }
            
            // Check if user is already attested
            const existingAttestation = permitAttestations.find(att => 
                att.request_event_id === requestEventId && 
                att.attester_npub === userHEX
            );
            
            if (existingAttestation) {
                alert('Vous avez d√©j√† attest√© cette demande.');
                return;
            }
            
            // Show attestation modal for this request
            showAttestModal(request.applicant_npub, requestId, requestEventId);
        }
        
        // Delete an event (30501 or 30502) - only if not certified by 30503
        async function deleteEvent(eventKind, eventId, eventDisplayId) {
            if (!userHEX || !window.nostr) {
                alert('Veuillez vous connecter avec votre MULTIPASS pour supprimer un √©v√©nement.');
                connectMULTIPASS();
                return;
            }
            
            // Verify user is creator of this event
            let event = null;
            if (eventKind === '30501') {
                event = permitRequests.find(req => req.event_id === eventId);
            } else if (eventKind === '30502') {
                event = permitAttestations.find(att => att.event_id === eventId);
            }
            
            if (!event) {
                alert('Erreur: √âv√©nement non trouv√©.');
                return;
            }
            
            // Check if user is creator
            const userPubkeyHex = npubToHex(userHEX);
            if (!userPubkeyHex) {
                alert('Erreur: Impossible de d√©coder votre cl√© publique.');
                return;
            }
            
            let creatorPubkey = null;
            if (eventKind === '30501') {
                creatorPubkey = event.applicant_npub;
            } else if (eventKind === '30502') {
                creatorPubkey = event.attester_npub;
            }
            
            if (creatorPubkey !== userPubkeyHex) {
                alert('Erreur: Vous n\'√™tes pas le cr√©ateur de cet √©v√©nement.');
                return;
            }
            
            // For 30501, check if credential exists
            if (eventKind === '30501') {
                const hasCredential = permitCredentials.some(cred => 
                    cred.holder_npub === event.applicant_npub && 
                    cred.permit_definition_id === event.permit_definition_id
                );
                
                if (hasCredential) {
                    alert('Erreur: Cette demande ne peut pas √™tre supprim√©e car un certificat (30503) a d√©j√† √©t√© d√©livr√©.');
                    return;
                }
            }
            
            // For 30502, check if the related request has a credential
            if (eventKind === '30502') {
                const relatedRequest = permitRequests.find(req => req.event_id === event.request_event_id);
                if (relatedRequest) {
                    const hasCredential = permitCredentials.some(cred => 
                        cred.holder_npub === relatedRequest.applicant_npub && 
                        cred.permit_definition_id === relatedRequest.permit_definition_id
                    );
                    
                    if (hasCredential) {
                        alert('Erreur: Cette attestation ne peut pas √™tre supprim√©e car un certificat (30503) a d√©j√† √©t√© d√©livr√© pour la demande associ√©e.');
                        return;
                    }
                }
            }
            
            // Confirm deletion
            const confirmMessage = `√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ${eventKind} ?\n\n` +
                `ID : ${eventDisplayId}\n\n` +
                `Cette action est irr√©versible.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // Create kind 5 delete event (NIP-09)
                const deleteEvent = {
                    kind: 5,
                    content: `Suppression de l'√©v√©nement ${eventKind} ${eventDisplayId}`,
                    tags: [
                        ['e', eventId],
                        ['k', eventKind]
                    ],
                    created_at: Math.floor(Date.now() / 1000)
                };
                
                // Add IPFSNODEID tag
                if (IPFSNODEID) {
                    deleteEvent.tags.push(['ipfs_node', IPFSNODEID]);
                }
                
                // Sign and publish
                const signedEvent = await window.nostr.signEvent(deleteEvent);
                
                // Publish to relays
                if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                    await nostrRelay.publish(signedEvent);
                } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                    const relays = await window.nostr.getRelays();
                    const relayUrls = Object.keys(relays);
                    for (const relayUrl of relayUrls) {
                        try {
                            const relay = new Relay(relayUrl);
                            await relay.connect();
                            await relay.publish(signedEvent);
                            relay.close();
                        } catch (e) {
                            console.warn(`Failed to publish to ${relayUrl}:`, e);
                        }
                    }
                }
                
                alert('‚úÖ √âv√©nement supprim√© avec succ√®s ! La page va se recharger.');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                console.error('[WoTx2] Error deleting event:', error);
                alert('Erreur lors de la suppression : ' + error.message);
            }
        }

        function showRequestModal() {
            if (!userHEX) {
                // Show tooltip instead of alert
                const btn = event?.target?.closest('button') || document.querySelector('[onclick="showRequestModal()"]');
                if (btn) {
                    const tooltip = bootstrap.Tooltip.getInstance(btn);
                    if (tooltip) {
                        tooltip.show();
                    } else {
                        // Create tooltip if it doesn't exist
                        new bootstrap.Tooltip(btn, {
                            title: 'L\'extension Nostr avec la cl√© de votre MULTIPASS est requise pour la connexion.',
                            placement: 'top'
                        }).show();
                    }
                }
                connectMULTIPASS();
                return;
            }
            
            // Populate permit selector
            const permitSelect = document.getElementById('requestPermitSelect');
            if (permitSelect && allPermits && allPermits.length > 0) {
                permitSelect.innerHTML = '<option value="">-- S√©lectionner une ma√Ætrise --</option>';
                allPermits.forEach(permit => {
                    const option = document.createElement('option');
                    option.value = permit.id;
                    // Show level if it's an auto-proclaimed ma√Ætrise
                    const levelMatch = permit.id.match(/_X(\d+)$/);
                    const levelBadge = levelMatch ? ` [Niveau ${levelMatch[1]}]` : '';
                    option.textContent = `${permit.name}${levelBadge} (${permit.min_attestations || 1} attestation(s) requise(s))`;
                    permitSelect.appendChild(option);
                });
                
                // Pre-select current permit if available
                if (permitData && permitData.id) {
                    permitSelect.value = permitData.id;
                    updateRequestAttestationsInfo(permitData.id);
                }
            } else {
                permitSelect.innerHTML = '<option value="">Aucun permit disponible</option>';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('requestModal'));
            modal.show();
            
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Update required attestations info when permit is selected
        function updateRequestAttestationsInfo(permitId) {
            const permit = allPermits.find(p => p.id === permitId);
            const attestationsEl = document.getElementById('requestRequiredAttestations');
            if (attestationsEl && permit) {
                attestationsEl.textContent = permit.min_attestations || 1;
            }
        }

        async function submitRequest() {
            if (!userHEX || !window.nostr) {
                // Show tooltip instead of alert
                const btn = document.querySelector('[onclick="submitRequest()"]');
                if (btn) {
                    const tooltip = bootstrap.Tooltip.getInstance(btn);
                    if (!tooltip) {
                        new bootstrap.Tooltip(btn, {
                            title: 'L\'extension Nostr avec la cl√© de votre MULTIPASS est requise pour la connexion.',
                            placement: 'top'
                        }).show();
                    } else {
                        tooltip.show();
                    }
                }
                return;
            }
            
            // Get selected permit
            const permitSelect = document.getElementById('requestPermitSelect');
            const selectedPermitId = permitSelect ? permitSelect.value : null;
            
            if (!selectedPermitId) {
                alert('Veuillez s√©lectionner une ma√Ætrise.');
                permitSelect?.focus();
                return;
            }
            
            // Find permit data
            const selectedPermit = allPermits.find(p => p.id === selectedPermitId);
            if (!selectedPermit) {
                alert('Erreur: Ma√Ætrise non trouv√©e.');
                return;
            }
            
            const statement = document.getElementById('statement').value;
            const evidenceInput = document.getElementById('evidence').value;
            const evidence = evidenceInput ? evidenceInput.split(',').map(e => e.trim()).filter(e => e) : [];
            
            if (!statement || statement.length < 20) {
                alert('Veuillez fournir une d√©claration d\'au moins 20 caract√®res.');
                return;
            }
            
            try {
                // Generate request ID
                const requestId = await window.nostr.getPublicKey().then(pubkey => {
                    return btoa(pubkey + ':' + selectedPermitId + ':' + Date.now()).substring(0, 16);
                });
                
                // Get geolocation if available
                let location = null;
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                        });
                        location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            timestamp: new Date().toISOString()
                        };
                    } catch (e) {
                        console.log('Geolocation not available:', e);
                    }
                }
                
                // Get requested competency
                const requestedCompetency = document.getElementById('requestedCompetency').value.trim();
                if (!requestedCompetency) {
                    alert('Veuillez indiquer la comp√©tence que vous souhaitez acqu√©rir.');
                    return;
                }
                
                // Create permit request event (kind 30501)
                const requestContent = {
                    request_id: requestId,
                    permit_definition_id: selectedPermitId,
                    applicant_did: `did:nostr:${userHEX}`,
                    statement: statement,
                    requested_competency: requestedCompetency, // Competency claimed by the applicant
                    evidence: evidence,
                    status: 'pending',
                    location: location
                };
                
                const eventTags = [
                    ['d', requestId],
                    ['l', selectedPermitId, 'permit_type'],
                    ['p', userHEX],
                    ['t', 'permit'],
                    ['t', 'request']
                ];
                
                // Add IPFSNODEID tag to filter events by Astroport (prevents conflicts in multi-station constellations)
                if (IPFSNODEID) {
                    eventTags.push(['ipfs_node', IPFSNODEID]);
                }
                
                // Add geolocation tags if available
                if (location) {
                    eventTags.push(['g', location.latitude.toString(), location.longitude.toString()]);
                }
                
                const event = {
                    kind: 30501,
                    content: JSON.stringify(requestContent),
                    tags: eventTags,
                    created_at: Math.floor(Date.now() / 1000)
                };
                
                // Sign and publish event
                const signedEvent = await window.nostr.signEvent(event);
                
                // Publish to relays (use common.js nostrRelay if available)
                if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                    try {
                        await nostrRelay.publish(signedEvent);
                        console.log('[WoTx2] ‚úÖ Event published to relay');
                    } catch (e) {
                        console.error('Error publishing to relay:', e);
                        // Fallback to user's relays
                        if (window.nostr && typeof window.nostr.getRelays === 'function') {
                            const relays = await window.nostr.getRelays();
                            const relayUrls = Object.keys(relays);
                            for (const relayUrl of relayUrls) {
                                try {
                                    const relay = new Relay(relayUrl);
                                    await relay.connect();
                                    await relay.publish(signedEvent);
                                    relay.close();
                                } catch (err) {
                                    console.warn(`Failed to publish to ${relayUrl}:`, err);
                                }
                            }
                        }
                    }
                } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                    // Use user's configured relays
                    const relays = await window.nostr.getRelays();
                    const relayUrls = Object.keys(relays);
                    
                    for (const relayUrl of relayUrls) {
                        try {
                            const relay = new Relay(relayUrl);
                            await relay.connect();
                            await relay.publish(signedEvent);
                            relay.close();
                        } catch (e) {
                            console.warn(`Failed to publish to ${relayUrl}:`, e);
                        }
                    }
                } else {
                    console.error('No relay available for publishing');
                    alert('Erreur : Aucun relay disponible pour publier l\'√©v√©nement.');
                }
                
                // Determine required attestations
                const reqAttest = selectedPermit.min_attestations || 1;
                
                const message = `‚úÖ Votre demande d'apprentissage a √©t√© cr√©√©e !\n\n` +
                    `üéØ Ma√Ætrise : ${selectedPermit.name}\n\n` +
                    `üìã Prochaines √©tapes :\n` +
                    `1. Votre demande appara√Æt dans "Apprentis Cherchant un Ma√Ætre"\n` +
                    `2. Un ma√Ætre certifi√© validera vos comp√©tences\n` +
                    `3. Vous devez obtenir ${reqAttest} validation(s)\n` +
                    `4. Votre certificat sera d√©livr√© automatiquement\n\n` +
                    `üí° Avantage : Une fois certifi√©, vous pourrez √† votre tour enseigner et valider d'autres apprentis !`;
                
                alert(message);
                bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                
                // Reset form
                document.getElementById('requestForm').reset();
                
                // Reload data from Nostr and switch to selected permit
                // Switch to the selected permit if different from current
                const currentPermitId = permitData?.id || selectedPermitId;
                if (selectedPermitId !== currentPermitId) {
                    window.location.href = `/wotx2?permit_id=${encodeURIComponent(selectedPermitId)}`;
                } else {
                    // Reload data for current permit
                await loadNostrData();
                    loadData();
                }
            } catch (e) {
                console.error('Error submitting request:', e);
                alert('Erreur lors de la soumission: ' + e.message);
            }
        }

        async function showAttestModal(applicantNpub, requestId) {
            if (!userHEX) {
                alert('Veuillez vous connecter avec votre MULTIPASS pour attester.');
                connectMULTIPASS();
                return;
            }
            
            document.getElementById('attestRequestId').value = requestId || '';
            // Store requestEventId if provided (for tree view)
            if (requestEventId) {
                document.getElementById('attestRequestId').setAttribute('data-event-id', requestEventId);
            }
            document.getElementById('attestApplicantNpub').value = applicantNpub || '';
            
            // Check if user has a 30503 credential for this permit
            const userCredentials = permitCredentials.filter(c => c.holder_npub === userHEX && c.permit_definition_id === permitData.id);
            
            if (userCredentials.length > 0) {
                // User has credential - show competencies transfer section
                const section = document.getElementById('competenciesTransferSection');
                const checkboxes = document.getElementById('competenciesCheckboxes');
                
                // Get competencies from permit definition
                const permitCompetencies = permitData.metadata?.competencies || [];
                
                if (permitCompetencies.length > 0) {
                    section.style.display = 'block';
                    checkboxes.innerHTML = '';
                    
                    permitCompetencies.forEach(comp => {
                        const div = document.createElement('div');
                        div.className = 'form-check mb-2';
                        div.innerHTML = `
                            <input class="form-check-input competency-checkbox" type="checkbox" 
                                value="${comp}" id="comp_${comp.replace(/\s+/g, '_')}">
                            <label class="form-check-label" for="comp_${comp.replace(/\s+/g, '_')}">
                                ${comp}
                            </label>
                        `;
                        checkboxes.appendChild(div);
                    });
                }
            } else {
                // User doesn't have credential - hide competencies section
                document.getElementById('competenciesTransferSection').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('attestModal'));
            modal.show();
        }
        
        // Get current geolocation
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('attestLatitude').value = position.coords.latitude.toFixed(6);
                        document.getElementById('attestLongitude').value = position.coords.longitude.toFixed(6);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert('Impossible d\'obtenir votre position. Vous pouvez la saisir manuellement.');
                    }
                );
            } else {
                alert('La g√©olocalisation n\'est pas support√©e par votre navigateur.');
            }
        }

        async function submitAttestation() {
            if (!userHEX || !window.nostr) {
                alert('Veuillez vous connecter avec votre MULTIPASS.');
                return;
            }
            
            const requestId = document.getElementById('attestRequestId').value;
            const statement = document.getElementById('attestStatement').value;
            const revealedCompetencies = document.getElementById('revealedCompetencies').value;
            const latitude = document.getElementById('attestLatitude').value;
            const longitude = document.getElementById('attestLongitude').value;
            
            if (!requestId) {
                alert('ID de demande manquant.');
                return;
            }
            
            if (!statement || statement.length < 10) {
                alert('Veuillez fournir une d√©claration d\'attestation.');
                return;
            }
            
            // Find the 30501 request event to get its event ID (required for tag 'e')
            // First try to get from data attribute (if called from tree view)
            let requestEventId = document.getElementById('attestRequestId').getAttribute('data-event-id');
            
            if (!requestEventId) {
                // Fallback: find from permitRequests
                const requestEvent = permitRequests.find(r => r.id === requestId);
                if (!requestEvent || !requestEvent.event_id) {
                    console.error('[WoTx2] Request event not found or missing event_id:', requestId);
                    alert('Erreur : Impossible de trouver l\'√©v√©nement 30501 correspondant. Veuillez actualiser la page.');
                    return;
                }
                requestEventId = requestEvent.event_id; // This is the Nostr event ID (64-char hex)
            }
            
            // Collect competencies to transfer (if user has 30503)
            const competenciesToTransfer = [];
            document.querySelectorAll('.competency-checkbox:checked').forEach(checkbox => {
                competenciesToTransfer.push(checkbox.value);
            });
            
            // Add revealed competencies to statement if provided
            let fullStatement = statement;
            if (revealedCompetencies) {
                fullStatement += '\n\nComp√©tences suppl√©mentaires r√©v√©l√©es: ' + revealedCompetencies;
            }
            if (competenciesToTransfer.length > 0) {
                fullStatement += '\n\nComp√©tences transf√©r√©es: ' + competenciesToTransfer.join(', ');
            }
            
            try {
                // Generate attestation ID
                const attestationId = await window.nostr.getPublicKey().then(pubkey => {
                    return btoa(pubkey + ':' + requestId + ':' + Date.now()).substring(0, 16);
                });
                
                // Create permit attestation event (kind 30502)
                const attestationContent = {
                    attestation_id: attestationId,
                    request_id: requestId,
                    attester_did: `did:nostr:${userHEX}`,
                    statement: fullStatement,
                    competencies_transferred: competenciesToTransfer,
                    revealed_competencies: revealedCompetencies ? revealedCompetencies.split(',').map(c => c.trim()) : [],
                    location: (latitude && longitude) ? {
                        latitude: parseFloat(latitude),
                        longitude: parseFloat(longitude),
                        timestamp: new Date().toISOString()
                    } : null,
                    signature: await window.nostr.getPublicKey().then(pubkey => {
                        return btoa(pubkey + ':' + fullStatement + ':' + Date.now()).substring(0, 32);
                    })
                };
                
                // CRITICAL: Tag 'e' must reference the 30501 event ID (64-char hex), not the request_id
                const eventTags = [
                    ['d', attestationId],
                    ['e', requestEventId], // Use the 30501 event ID, not requestId
                    ['p', userHEX],
                    ['t', 'permit'],
                    ['t', 'attestation']
                ];
                
                // Add IPFSNODEID tag to filter events by Astroport (prevents conflicts in multi-station constellations)
                if (IPFSNODEID) {
                    eventTags.push(['ipfs_node', IPFSNODEID]);
                }
                
                // Add geolocation tags if provided
                if (latitude && longitude) {
                    eventTags.push(['g', latitude, longitude]);
                }
                
                // Add competencies tags
                competenciesToTransfer.forEach(comp => {
                    eventTags.push(['competency', comp]);
                });
                
                const event = {
                    kind: 30502,
                    content: JSON.stringify(attestationContent),
                    tags: eventTags,
                    created_at: Math.floor(Date.now() / 1000)
                };
                
                // Sign and publish event
                const signedEvent = await window.nostr.signEvent(event);
                
                // Publish to relays (use common.js nostrRelay if available)
                if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                    try {
                        await nostrRelay.publish(signedEvent);
                        console.log('[WoTx2] ‚úÖ Event published to relay');
                    } catch (e) {
                        console.error('Error publishing to relay:', e);
                        // Fallback to user's relays
                        if (window.nostr && typeof window.nostr.getRelays === 'function') {
                            const relays = await window.nostr.getRelays();
                            const relayUrls = Object.keys(relays);
                            for (const relayUrl of relayUrls) {
                                try {
                                    const relay = new Relay(relayUrl);
                                    await relay.connect();
                                    await relay.publish(signedEvent);
                                    relay.close();
                                } catch (err) {
                                    console.warn(`Failed to publish to ${relayUrl}:`, err);
                                }
                            }
                        }
                    }
                } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                    // Use user's configured relays
                    const relays = await window.nostr.getRelays();
                    const relayUrls = Object.keys(relays);
                    
                    for (const relayUrl of relayUrls) {
                        try {
                            const relay = new Relay(relayUrl);
                            await relay.connect();
                            await relay.publish(signedEvent);
                            relay.close();
                        } catch (e) {
                            console.warn(`Failed to publish to ${relayUrl}:`, e);
                        }
                    }
                } else {
                    console.error('No relay available for publishing');
                    alert('Erreur : Aucun relay disponible pour publier l\'√©v√©nement.');
                }
                
                // Count attestations
                const attestationsCount = await countAttestations(requestId);
                
                let message = `‚úÖ Validation envoy√©e avec succ√®s !\n\n` +
                    `üìä Validations totales : ${attestationsCount}\n\n`;
                
                if (competenciesToTransfer.length > 0) {
                    message += `üìö Comp√©tences transmises : ${competenciesToTransfer.join(', ')}\n` +
                        `Ces comp√©tences seront ajout√©es au certificat de l'apprenti.\n\n`;
                }
                
                if (revealedCompetencies) {
                    message += `üåü Nouvelles comp√©tences r√©v√©l√©es : ${revealedCompetencies}\n` +
                        `Ces comp√©tences enrichissent la ma√Ætrise pour toute la communaut√© !\n\n`;
                }
                
                if (latitude && longitude) {
                    message += `üìç G√©olocalisation enregistr√©e\n` +
                        `Permet aux autres de trouver des ma√Ætres pr√®s de chez eux.\n\n`;
                }
                
                message += `üìã Prochaines √©tapes :\n` +
                    `1. Votre validation est maintenant visible\n` +
                    `2. Si le seuil est atteint, le certificat sera d√©livr√© automatiquement\n` +
                    `3. L'apprenti appara√Ætra dans "Ma√Ætres Certifi√©s"\n` +
                    `4. Actualisez la page pour voir les mises √† jour\n\n` +
                    `üí° Merci de contribuer √† construire une communaut√© de comp√©tences reconnues !`;
                
                alert(message);
                bootstrap.Modal.getInstance(document.getElementById('attestModal')).hide();
                
                // Reload data from Nostr
                await loadNostrData();
            } catch (e) {
                console.error('Error submitting attestation:', e);
                alert('Erreur lors de l\'attestation: ' + e.message);
            }
        }

        // Load permit selector dropdown
        function loadPermitSelector() {
            const selector = document.getElementById('permitSelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            
            if (allPermits.length === 0) {
                selector.innerHTML = '<option value="">Aucun permit disponible</option>';
                return;
            }
            
            allPermits.forEach(permit => {
                const option = document.createElement('option');
                option.value = permit.id;
                // Show level if it's an auto-proclaimed profession
                const levelMatch = permit.id.match(/_X(\d+)$/);
                const levelBadge = levelMatch ? ` [Niveau ${levelMatch[1]}]` : '';
                option.textContent = `${permit.name}${levelBadge} (${permit.holders_count} titulaires, ${permit.pending_count} en attente)`;
                if (permit.id === selectedPermitId) {
                    option.selected = true;
                }
                selector.appendChild(option);
            });
            
            // Update UI with selected permit
            updatePermitUI();
            
            // Also render the permits list
            renderAllPermitsList();
        }
        
        // Render all permits list (similar to oracle.html)
        async function renderAllPermitsList() {
            const container = document.getElementById('all-permits-list');
            if (!container) return;
            
            try {
            if (allPermits.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle"></i> Aucun permis disponible pour le moment.
                        </div>
                    </div>
                `;
                return;
            }
                
                // Show loading indicator
                showLoadingIndicator('all-permits-list', `Chargement des ${allPermits.length} permis...`);
            
            // For each permit, check if user is creator and if 30503 exists
            let html = '';
            const userPubkeyHex = userHEX ? npubToHex(userHEX) : null;
                
                // Optimize: Pre-fetch all permit definitions in batch
                const permitIds = allPermits.map(p => p.id);
                const permitDefinitionsMap = {};
                const has30503Map = {};
                
                // Fetch all permit definitions in parallel (limit to 5 concurrent requests)
                let batchNumber = 0;
                const totalBatches = Math.ceil(permitIds.length / 5);
                
                for (let i = 0; i < permitIds.length; i += 5) {
                    batchNumber++;
                    const batch = permitIds.slice(i, i + 5);
                    
                    // Update loading message with progress
                    if (container) {
                        showLoadingIndicator('all-permits-list', 
                            `Chargement des permis... (${batchNumber}/${totalBatches})`
                        );
                    }
                    
                    const batchPromises = batch.map(async (permitId) => {
                        try {
                            const def = await fetchPermitDefinition(permitId);
                            if (def) {
                                permitDefinitionsMap[permitId] = def;
                            }
                            // Also check for 30503 in parallel
                            const has30503 = allPermits.find(p => p.id === permitId)?.holders_count > 0 || 
                                            (await checkHas30503Credentials(permitId));
                            has30503Map[permitId] = has30503;
                        } catch (error) {
                            console.error(`[WoTx2] Error fetching permit ${permitId}:`, error);
                            // Continue with defaults on error
                            has30503Map[permitId] = allPermits.find(p => p.id === permitId)?.holders_count > 0 || false;
                        }
                    });
                    
                    // Wait for this batch before starting next batch
                    await Promise.all(batchPromises);
                }
            
            for (const permit of allPermits) {
                // Use pre-fetched data
                const permit30500 = permitDefinitionsMap[permit.id];
                const isCreator = permit30500 && userPubkeyHex && permit30500.pubkey === userPubkeyHex;
                const has30503 = has30503Map[permit.id] || false;
                
                // Can delete only if creator and no 30503 exists
                const canDelete = isCreator && !has30503;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card permit-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 style="color: var(--water-blue); margin: 0;">
                                        <i class="bi bi-award"></i> ${permit.name}
                                    </h5>
                                    ${canDelete ? `
                                        <button class="btn btn-sm btn-danger" onclick="deletePermit('${permit.id}')" title="Supprimer ce permis (kind 5)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <p class="text-muted small mb-0">
                                        <code>${permit.id}</code>
                                    </p>
                                    ${permit.id.match(/_X\d+$/) ? `
                                        <span class="badge bg-primary">
                                            Niveau ${permit.id.match(/_X(\d+)$/)[1]}
                                        </span>
                                    ` : ''}
                                </div>
                                
                                <p class="mb-3" style="min-height: 60px;">
                                    ${permit.description || 'Aucune description disponible.'}
                                </p>
                                
                                ${permit.id.match(/_X\d+$/) ? `
                                    <div class="alert alert-info mb-3" style="font-size: 0.85rem;">
                                        <i class="bi bi-arrow-right-circle"></i> 
                                        <strong>Progression automatique :</strong> 
                                        ${permit.id.endsWith('_X1') ? '1 signature ‚Üí X2 (2 comp√©tences, 2 signatures)' : ''}
                                        ${permit.id.endsWith('_X2') ? '2 signatures + 2 comp√©tences ‚Üí X3 (3 comp√©tences, 3 signatures)' : ''}
                                        ${permit.id.endsWith('_X3') ? '3 signatures + 3 comp√©tences ‚Üí X4 (4 comp√©tences, 4 signatures)' : ''}
                                        ${permit.id.endsWith('_X4') ? 'Niveau ma√Ætre atteint' : ''}
                                    </div>
                                    ${(() => {
                                        // Extract base permit name (without _X1, _X2, etc.)
                                        const basePermitId = permit.id.replace(/_X\d+$/, '');
                                        const currentLevel = permit.id.match(/_X(\d+)$/)?.[1] || '1';
                                        const nextLevel = parseInt(currentLevel) + 1;
                                        const prevLevel = parseInt(currentLevel) - 1;
                                        
                                        // Find related levels
                                        const relatedLevels = allPermits.filter(p => 
                                            p.id.startsWith(basePermitId + '_X') && p.id !== permit.id
                                        ).sort((a, b) => {
                                            const aLevel = parseInt(a.id.match(/_X(\d+)$/)?.[1] || '0');
                                            const bLevel = parseInt(b.id.match(/_X(\d+)$/)?.[1] || '0');
                                            return aLevel - bLevel;
                                        });
                                        
                                        if (relatedLevels.length > 0) {
                                            let navHtml = '<div class="mb-3"><div class="d-flex flex-wrap gap-2 align-items-center">';
                                            navHtml += '<small class="text-muted me-2"><i class="bi bi-layers"></i> Autres niveaux :</small>';
                                            
                                            relatedLevels.forEach(relatedPermit => {
                                                const relatedLevel = relatedPermit.id.match(/_X(\d+)$/)?.[1] || '?';
                                                const isNext = parseInt(relatedLevel) === nextLevel;
                                                const isPrev = parseInt(relatedLevel) === prevLevel;
                                                const badgeClass = isNext ? 'bg-success' : isPrev ? 'bg-info' : 'bg-secondary';
                                                const icon = isNext ? 'bi-arrow-up-circle' : isPrev ? 'bi-arrow-down-circle' : 'bi-circle';
                                                
                                                navHtml += `<a href="/wotx2?permit_id=${relatedPermit.id}" 
                                                    class="badge ${badgeClass} text-decoration-none" 
                                                    title="${relatedPermit.name}">
                                                    <i class="bi ${icon}"></i> X${relatedLevel}
                                                </a>`;
                                            });
                                            
                                            navHtml += '</div></div>';
                                            return navHtml;
                                        }
                                        return '';
                                    })()}
                                ` : ''}
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted small">
                                            <i class="bi bi-people"></i> Titulaires
                                        </span>
                                        <span class="badge bg-success">${permit.holders_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted small">
                                            <i class="bi bi-hourglass-split"></i> Demandes en attente
                                        </span>
                                        <span class="badge bg-warning">${permit.pending_count || 0}</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted small">
                                            <i class="bi bi-pen"></i> Signatures requises
                                        </span>
                                        <span class="badge bg-info">${permit.min_attestations || 1}</span>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <a href="/wotx2?permit_id=${permit.id}" class="btn btn-primary btn-sm">
                                        <i class="bi bi-eye"></i> Voir les d√©tails
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            } catch (error) {
                console.error('[WoTx2] Error rendering permits list:', error);
                showError('all-permits-list',
                    'Impossible de charger la liste des permis. V√©rifiez votre connexion au relay NOSTR.',
                    '() => renderAllPermitsList()'
                );
            }
        }
        
        // Fetch permit definition (kind 30500) from Nostr
        async function fetchPermitDefinition(permitId) {
            try {
                const filters = {
                    '#d': [permitId]
                };
                // Only filter by IPFSNODEID in local mode
                if (viewMode === 'local' && IPFSNODEID) {
                    filters['#ipfs_node'] = [IPFSNODEID];
                }
                const events = await fetchNostrEvents(30500, filters);
                if (events.length > 0) {
                    // Sort by created_at descending to get the most recent
                    events.sort((a, b) => b.created_at - a.created_at);
                    return events[0];
                }
            } catch (e) {
                console.error('Error fetching permit definition:', e);
            }
            return null;
        }
        
        // Check if any 30503 credentials exist for this permit
        async function checkHas30503Credentials(permitId) {
            try {
                const filters = {
                    '#l': [permitId, 'permit_type']
                };
                // Only filter by IPFSNODEID in local mode
                if (viewMode === 'local' && IPFSNODEID) {
                    filters['#ipfs_node'] = [IPFSNODEID];
                }
                const events = await fetchNostrEvents(30503, filters);
                return events.length > 0;
            } catch (e) {
                console.error('Error checking 30503 credentials:', e);
                return false;
            }
        }
        
        // Convert npub to hex pubkey
        function npubToHex(npub) {
            if (!npub) return null;
            if (!npub.startsWith('npub')) return npub; // Already hex
            if (typeof NostrTools !== 'undefined' && NostrTools.nip19) {
                try {
                    const decoded = NostrTools.nip19.decode(npub);
                    return decoded.data;
                } catch (e) {
                    console.error('Error decoding npub:', e);
                    return null;
                }
            }
            return null;
        }
        
        // Delete permit (kind 5) - only if creator and no 30503 exists
        // Deletes all related events: 30500, 30501, and 30502
        async function deletePermit(permitId) {
            if (!userHEX || !window.nostr) {
                alert('Veuillez vous connecter avec votre MULTIPASS pour supprimer un permis.');
                connectMULTIPASS();
                return;
            }
            
            // Verify user is creator
            const permit30500 = await fetchPermitDefinition(permitId);
            if (!permit30500) {
                alert('Erreur: Impossible de trouver la d√©finition du permis.');
                return;
            }
            
            // Convert userHEX to hex if needed
            const userPubkeyHex = npubToHex(userHEX);
            if (!userPubkeyHex) {
                alert('Erreur: Impossible de d√©coder votre cl√© publique.');
                return;
            }
            
            if (permit30500.pubkey !== userPubkeyHex) {
                alert('Erreur: Vous n\'√™tes pas le cr√©ateur de ce permis. Seul le cr√©ateur peut le supprimer.');
                return;
            }
            
            // Check if any 30503 credentials exist
            const has30503 = await checkHas30503Credentials(permitId);
            if (has30503) {
                alert('Erreur: Ce permis ne peut pas √™tre supprim√© car des credentials (30503) ont d√©j√† √©t√© √©mis.');
                return;
            }
            
            // Find all related events (30501 and 30502) created by the user
            console.log('[WoTx2] üîç Searching for related events to delete...');
            
            // Find 30501 events for this permit created by the user
            const filters30501 = {
                '#l': [permitId, 'permit_type']
            };
            if (viewMode === 'local' && IPFSNODEID) {
                filters30501['#ipfs_node'] = [IPFSNODEID];
            }
            const events30501 = await fetchNostrEvents(30501, filters30501);
            const user30501Events = events30501.filter(e => e.pubkey === userPubkeyHex);
            
            // Find 30502 events for this permit created by the user
            // We need to find attestations that reference the 30501 events OR are tagged with bootstrap
            const events30502 = [];
            
            // Method 1: Find attestations that reference the 30501 events
            for (const reqEvent of user30501Events) {
                const filters30502 = {
                    '#e': [reqEvent.id]
                };
                if (viewMode === 'local' && IPFSNODEID) {
                    filters30502['#ipfs_node'] = [IPFSNODEID];
                }
                const attestations = await fetchNostrEvents(30502, filters30502);
                const userAttestations = attestations.filter(e => e.pubkey === userPubkeyHex);
                events30502.push(...userAttestations);
            }
            
            // Method 2: Also find bootstrap attestations (self-attestations) for this permit
            // These might not have the 'e' tag pointing to a 30501, but have the bootstrap tag
            const filters30502Bootstrap = {
                '#t': ['bootstrap']
            };
            if (viewMode === 'local' && IPFSNODEID) {
                filters30502Bootstrap['#ipfs_node'] = [IPFSNODEID];
            }
            const bootstrapAttestations = await fetchNostrEvents(30502, filters30502Bootstrap);
            const userBootstrapAttestations = bootstrapAttestations.filter(e => {
                // Check if this attestation is for this permit (check content or tags)
                try {
                    const content = JSON.parse(e.content);
                    if (content.request_id && user30501Events.some(req => {
                        const reqContent = JSON.parse(req.content);
                        return reqContent.request_id === content.request_id;
                    })) {
                        return e.pubkey === userPubkeyHex;
                    }
                } catch (err) {
                    // Ignore parse errors
                }
                return false;
            });
            
            // Add bootstrap attestations that aren't already in the list
            userBootstrapAttestations.forEach(att => {
                if (!events30502.some(e => e.id === att.id)) {
                    events30502.push(att);
                }
            });
            
            // Count events to delete
            const eventCount = 1 + user30501Events.length + events30502.length; // 30500 + 30501s + 30502s
            
            // Confirm deletion with details
            const confirmMessage = `√ätes-vous s√ªr de vouloir supprimer la ma√Ætrise "${permitId}" ?\n\n` +
                `Cette action est irr√©versible et supprimera :\n` +
                `‚Ä¢ La d√©finition de la ma√Ætrise\n` +
                `‚Ä¢ ${user30501Events.length} demande(s) d'apprentissage\n` +
                `‚Ä¢ ${events30502.length} validation(s)\n\n` +
                `Total : ${eventCount} √©l√©ment(s) seront supprim√©s.\n\n` +
                `‚ö†Ô∏è Cette ma√Ætrise dispara√Ætra pour toute la communaut√© UPlanet.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // Build tags for kind 5 delete event (NIP-09)
                const deleteTags = [];
                
                // Add 30500 event
                deleteTags.push(['e', permit30500.id]);
                
                // Add 30501 events
                user30501Events.forEach(event => {
                    deleteTags.push(['e', event.id]);
                });
                
                // Add 30502 events
                events30502.forEach(event => {
                    deleteTags.push(['e', event.id]);
                });
                
                // Add kind tags (NIP-09 requirement)
                deleteTags.push(['k', '30500']);
                if (user30501Events.length > 0) {
                    deleteTags.push(['k', '30501']);
                }
                if (events30502.length > 0) {
                    deleteTags.push(['k', '30502']);
                }
                
                // Create kind 5 delete event
                const deleteEvent = {
                    kind: 5,
                    content: `Suppression du permit ${permitId} et de tous ses √©v√©nements associ√©s (30500, 30501, 30502)`,
                    tags: deleteTags,
                    created_at: Math.floor(Date.now() / 1000)
                };
                
                // Add IPFSNODEID tag to filter events by Astroport
                if (IPFSNODEID) {
                    deleteEvent.tags.push(['ipfs_node', IPFSNODEID]);
                }
                
                console.log('[WoTx2] üìù Creating delete event for', eventCount, 'events:', {
                    '30500': 1,
                    '30501': user30501Events.length,
                    '30502': events30502.length
                });
                
                // Sign and publish event
                const signedEvent = await window.nostr.signEvent(deleteEvent);
                
                // Publish to relays
                if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                    try {
                        await nostrRelay.publish(signedEvent);
                        console.log('[WoTx2] ‚úÖ Delete event published to relay');
                    } catch (e) {
                        console.error('Error publishing to relay:', e);
                        // Fallback to user's relays
                        if (window.nostr && typeof window.nostr.getRelays === 'function') {
                            const relays = await window.nostr.getRelays();
                            const relayUrls = Object.keys(relays);
                            for (const relayUrl of relayUrls) {
                                try {
                                    const relay = new Relay(relayUrl);
                                    await relay.connect();
                                    await relay.publish(signedEvent);
                                    relay.close();
                                } catch (err) {
                                    console.warn(`Failed to publish to ${relayUrl}:`, err);
                                }
                            }
                        }
                    }
                } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                    // Use user's configured relays
                    const relays = await window.nostr.getRelays();
                    const relayUrls = Object.keys(relays);
                    
                    for (const relayUrl of relayUrls) {
                        try {
                            const relay = new Relay(relayUrl);
                            await relay.connect();
                            await relay.publish(signedEvent);
                            relay.close();
                        } catch (e) {
                            console.warn(`Failed to publish to ${relayUrl}:`, e);
                        }
                    }
                } else {
                    console.error('No relay available for publishing');
                    alert('Erreur : Aucun relay disponible pour publier l\'√©v√©nement.');
                    return;
                }
                
                let successMessage = `‚úÖ Suppression effectu√©e avec succ√®s !\n\n`;
                successMessage += `üìä √âl√©ments supprim√©s :\n`;
                successMessage += `‚Ä¢ La d√©finition de la ma√Ætrise\n`;
                successMessage += `‚Ä¢ ${user30501Events.length} demande(s) d'apprentissage\n`;
                successMessage += `‚Ä¢ ${events30502.length} validation(s)\n\n`;
                successMessage += `Total : ${eventCount} √©l√©ment(s)\n\n`;
                successMessage += `Cette ma√Ætrise dispara√Ætra de la communaut√© UPlanet dans les prochaines heures.`;
                
                alert(successMessage);
                
                // Reload page after a short delay
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (e) {
                console.error('Error deleting permit:', e);
                alert('Erreur lors de la suppression: ' + e.message);
            }
        }

        // Switch to different permit
        function switchPermit() {
            const selector = document.getElementById('permitSelector');
            if (!selector) return;
            
            const newPermitId = selector.value;
            if (newPermitId && newPermitId !== selectedPermitId) {
                window.location.href = `/wotx2?permit_id=${encodeURIComponent(newPermitId)}`;
            }
        }

        // Update UI with current permit info
        function updatePermitUI() {
            const selectedPermit = allPermits.find(p => p.id === selectedPermitId);
            if (selectedPermit) {
                const titleEl = document.getElementById('permitTitle');
                const levelBadge = document.getElementById('permitLevelBadge');
                const progressionWorkflow = document.getElementById('progressionWorkflow');
                
                if (titleEl) {
                    titleEl.textContent = selectedPermit.name + ' - WoTx2';
                }
                
                // Show level badge if it's an auto-proclaimed ma√Ætrise
                const levelMatch = selectedPermit.id.match(/_X(\d+)$/);
                if (levelMatch && levelBadge) {
                    levelBadge.textContent = `Niveau ${levelMatch[1]}`;
                    levelBadge.style.display = 'inline-block';
                } else if (levelBadge) {
                    levelBadge.style.display = 'none';
                }
                
                // Show progression workflow for auto-proclaimed ma√Ætrises
                if (selectedPermit.id.match(/^PERMIT_/) && progressionWorkflow) {
                    progressionWorkflow.style.display = 'block';
                } else if (progressionWorkflow) {
                    progressionWorkflow.style.display = 'none';
                }
                
                // Show mastery levels navigation if this is part of a multi-level ma√Ætrise
                updateMasteryLevelsNavigation(selectedPermit);
                
                // Update user progress indicator
                updateUserProgressIndicator(selectedPermit);
                
                // Update delete permit button
                updateDeletePermitButton(selectedPermit.id);
            }
        }
        
        // Update mastery levels navigation
        function updateMasteryLevelsNavigation(permit) {
            const section = document.getElementById('masteryLevelsSection');
            const nav = document.getElementById('masteryLevelsNav');
            
            if (!section || !nav) return;
            
            // Extract base permit name (without _X1, _X2, etc.)
            const basePermitId = permit.id.replace(/_X\d+$/, '');
            
            // Find all related levels
            const relatedLevels = allPermits.filter(p => 
                p.id.startsWith(basePermitId + '_X') || 
                (p.id === basePermitId && !p.id.match(/_X\d+$/))
            ).sort((a, b) => {
                const aLevel = parseInt(a.id.match(/_X(\d+)$/)?.[1] || '0');
                const bLevel = parseInt(b.id.match(/_X(\d+)$/)?.[1] || '0');
                return aLevel - bLevel;
            });
            
            if (relatedLevels.length > 1) {
                section.style.display = 'block';
                
                let html = '';
                relatedLevels.forEach((levelPermit, index) => {
                    const level = levelPermit.id.match(/_X(\d+)$/)?.[1] || '0';
                    const isCurrent = levelPermit.id === permit.id;
                    const badgeClass = isCurrent ? 'bg-primary' : 
                                      parseInt(level) < parseInt(permit.id.match(/_X(\d+)$/)?.[1] || '0') ? 'bg-success' : 
                                      'bg-secondary';
                    const icon = isCurrent ? 'bi-check-circle-fill' : 
                                parseInt(level) < parseInt(permit.id.match(/_X(\d+)$/)?.[1] || '0') ? 'bi-check-circle' : 
                                'bi-circle';
                    
                    html += `
                        <a href="/wotx2?permit_id=${levelPermit.id}" 
                           class="btn ${isCurrent ? 'btn-primary' : 'btn-outline-primary'} position-relative"
                           style="min-width: 80px; ${isCurrent ? 'font-weight: bold;' : ''}"
                           title="${levelPermit.name} - ${levelPermit.min_attestations || 1} attestation(s) requise(s)">
                            <i class="bi ${icon}"></i> X${level}
                            ${isCurrent ? '<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">Actuel</span>' : ''}
                        </a>
                    `;
                });
                
                nav.innerHTML = html;
            } else {
                section.style.display = 'none';
            }
        }
        
        // Update delete permit button visibility
        async function updateDeletePermitButton(permitId) {
            const section = document.getElementById('deletePermitSection');
            const button = document.getElementById('deletePermitBtn');
            
            if (!section || !userHEX) {
                if (section) section.style.display = 'none';
                return;
            }
            
            try {
                // Check if user is creator
                const permit30500 = await fetchPermitDefinition(permitId);
                if (!permit30500) {
                    section.style.display = 'none';
                    return;
                }
                
                const userPubkeyHex = npubToHex(userHEX);
                if (!userPubkeyHex || permit30500.pubkey !== userPubkeyHex) {
                    section.style.display = 'none';
                    return;
                }
                
                // Check if any 30503 credentials exist
                const has30503 = await checkHas30503Credentials(permitId);
                if (has30503) {
                    section.style.display = 'none';
                    return;
                }
                
                // Show delete button
                section.style.display = 'block';
                if (button) {
                    button.onclick = () => deletePermit(permitId);
                }
            } catch (e) {
                console.error('[WoTx2] Error checking delete permission:', e);
                section.style.display = 'none';
            }
        }
        
        // Update user progress indicator
        function updateUserProgressIndicator(permit) {
            const indicator = document.getElementById('userProgressIndicator');
            const currentLevelEl = document.getElementById('userCurrentLevel');
            const progressBar = document.getElementById('userProgressBar');
            const progressText = document.getElementById('userProgressText');
            const progressDetails = document.getElementById('userProgressDetails');
            
            if (!indicator || !userHEX) {
                if (indicator) indicator.style.display = 'none';
                return;
            }
            
            // Check if user has credentials for this permit or related levels
            const basePermitId = permit.id.replace(/_X\d+$/, '');
            const userCredentials = permitCredentials.filter(c => 
                c.holder_npub === userHEX && 
                c.permit_definition_id.startsWith(basePermitId)
            );
            
            if (userCredentials.length === 0) {
                // Check if user has pending requests
                const userRequests = permitRequests.filter(r => 
                    r.applicant_npub === userHEX && 
                    r.permit_definition_id.startsWith(basePermitId)
                );
                
                if (userRequests.length > 0) {
                    indicator.style.display = 'block';
                    const request = userRequests[0];
                    const requiredAttestations = permit.min_attestations || 1;
                    const progress = Math.min((request.attestations_count / requiredAttestations) * 100, 100);
                    
                    if (currentLevelEl) {
                        currentLevelEl.textContent = `En cours d'apprentissage (${request.attestations_count}/${requiredAttestations} attestations)`;
                    }
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                        progressBar.className = `progress-bar progress-bar-striped ${progress >= 100 ? 'bg-success' : 'bg-warning'}`;
                    }
                    if (progressText) {
                        progressText.textContent = Math.round(progress) + '%';
                    }
                    if (progressDetails) {
                        progressDetails.textContent = `Il vous reste ${requiredAttestations - request.attestations_count} attestation(s) pour obtenir votre credential X1`;
                    }
                } else {
                    indicator.style.display = 'none';
                }
            } else {
                // User has credentials - show highest level
                indicator.style.display = 'block';
                const highestCredential = userCredentials.sort((a, b) => {
                    const aLevel = parseInt(a.permit_definition_id.match(/_X(\d+)$/)?.[1] || '0');
                    const bLevel = parseInt(b.permit_definition_id.match(/_X(\d+)$/)?.[1] || '0');
                    return bLevel - aLevel;
                })[0];
                
                const level = highestCredential.permit_definition_id.match(/_X(\d+)$/)?.[1] || '1';
                const maxLevel = 4; // Assuming max level is X4
                const progress = (parseInt(level) / maxLevel) * 100;
                
                if (currentLevelEl) {
                    currentLevelEl.textContent = `Ma√Ætre certifi√© niveau X${level}`;
                }
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                    progressBar.className = 'progress-bar progress-bar-striped bg-success';
                }
                if (progressText) {
                    progressText.textContent = `X${level}/X${maxLevel}`;
                }
                if (progressDetails) {
                    if (parseInt(level) < maxLevel) {
                        const nextLevel = parseInt(level) + 1;
                        progressDetails.textContent = `Prochain objectif : Niveau X${nextLevel} (${nextLevel} comp√©tences, ${nextLevel} signatures requises)`;
                    } else {
                        progressDetails.textContent = `üéâ F√©licitations ! Vous avez atteint le niveau ma√Ætre (X${maxLevel})`;
                    }
                }
            }
        }

        // Show new permit modal
        function showNewPermitModal() {
            if (!userHEX) {
                // Show tooltip instead of alert
                const btn = event?.target?.closest('button') || document.querySelector('[onclick="showNewPermitModal()"]');
                if (btn) {
                    const tooltip = bootstrap.Tooltip.getInstance(btn);
                    if (tooltip) {
                        tooltip.show();
                    }
                }
                connectMULTIPASS();
                return;
            }
            
            // Reset form
            document.getElementById('newPermitForm').reset();
            updateAutoPermitId();
            
            const modal = new bootstrap.Modal(document.getElementById('newPermitModal'));
            modal.show();
        }
        
        // Update auto-generated permit ID preview
        function updateAutoPermitId() {
            const permitName = document.getElementById('newPermitName').value.trim();
            const preview = document.getElementById('autoPermitIdPreview');
            
            if (permitName) {
                // Convert to uppercase, replace spaces with underscores, remove special chars
                let permitId = permitName.toUpperCase()
                    .replace(/[^A-Z0-9\s]/g, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 50); // Limit length
                
                // Ensure it starts with PERMIT_
                if (!permitId.startsWith('PERMIT_')) {
                    permitId = 'PERMIT_' + permitId;
                }
                
                // Add _X1 suffix
                if (!permitId.endsWith('_X1')) {
                    permitId = permitId.replace(/_X\d+$/, '') + '_X1';
                }
                
                preview.textContent = permitId;
            } else {
                preview.textContent = 'PERMIT_X1';
            }
        }

        // Add competency field
        function addCompetency() {
            const list = document.getElementById('competenciesList');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="text" class="form-control competency-input" 
                    placeholder="Ex: Swimming instruction">
                <button type="button" class="btn btn-outline-danger" onclick="removeCompetency(this)">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            list.appendChild(div);
        }

        // Remove competency field
        function removeCompetency(btn) {
            const list = document.getElementById('competenciesList');
            if (list.children.length > 1) {
                btn.closest('.input-group').remove();
            } else {
                alert('Au moins une comp√©tence est requise.');
            }
        }

        // Add responsible field
        function addResponsible() {
            const list = document.getElementById('responsibleForList');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="text" class="form-control responsible-input" 
                    placeholder="Ex: Swimming lessons">
                <button type="button" class="btn btn-outline-danger" onclick="removeResponsible(this)">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            list.appendChild(div);
        }

        // Remove responsible field
        function removeResponsible(btn) {
            const list = document.getElementById('responsibleForList');
            if (list.children.length > 1) {
                btn.closest('.input-group').remove();
            } else {
                alert('Au moins une responsabilit√© est requise.');
            }
        }

        // Add bootstrap email field
        function addBootstrapEmail() {
            const list = document.getElementById('bootstrapEmailsList');
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="email" class="form-control bootstrap-email-input" 
                    placeholder="email@example.com">
                <button type="button" class="btn btn-outline-danger" onclick="removeBootstrapEmail(this)">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            list.appendChild(div);
        }

        // Remove bootstrap email field
        function removeBootstrapEmail(btn) {
            const list = document.getElementById('bootstrapEmailsList');
            if (list.children.length > 2) {
                btn.closest('.input-group').remove();
            } else {
                alert('Au moins 2 emails sont requis pour le bootstrap.');
            }
        }

        // Submit new permit
        async function submitNewPermit() {
            if (!userHEX) {
                alert('Vous devez √™tre connect√© avec MULTIPASS.');
                return;
            }

            const permitName = document.getElementById('newPermitName').value.trim();
            const permitDescription = document.getElementById('newPermitDescription').value.trim();

            // Validate required fields
            if (!permitName || !permitDescription) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }

            // Auto-generate ID from ma√Ætrise name (always auto-proclaimed)
            let permitId = permitName.toUpperCase()
                    .replace(/[^A-Z0-9\s]/g, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 50);
                
            if (!permitId.startsWith('PERMIT_')) {
                permitId = 'PERMIT_' + permitId;
                }
                
                if (!permitId.endsWith('_X1')) {
                    permitId = permitId.replace(/_X\d+$/, '') + '_X1';
                }

            // WoTx2: Auto-proclaimed ma√Ætrises start at X1 with 1 attestation
            // System will auto-create X2, X3, X4 as permits are validated
            const minAttestations = 1; // X1 requires 1 signature
            const level = 'X1'; // Always start at X1

            // Build metadata for auto-proclaimed ma√Ætrise
            const metadata = {
                category: "auto_proclaimed",
                competencies: [], // Will be added progressively via 30502 attestations
                responsible_for: [], // Will be added progressively via 30502 attestations
                auto_proclaimed: true,
                level: level,
                evolving_system: {
                    type: "WoTx2_AutoProclaimed",
                    description: "Auto-proclaimed ma√Ætrise that evolves automatically: X1 (1 signature) ‚Üí X2 (2 competencies, 2 signatures) ‚Üí X3 ‚Üí X4...",
                    discovery_mechanism: "attestation_revealed_competencies",
                    auto_progression: true,
                    progression_rules: {
                        x1: { signatures: 1, competencies: 0, next_level: "X2" },
                        x2: { signatures: 2, competencies: 2, next_level: "X3" },
                        x3: { signatures: 3, competencies: 3, next_level: "X4" },
                        x4: { signatures: 4, competencies: 4, next_level: null }
                    },
                    virtuous_circle: {
                        student: "Receives instruction and can become instructor",
                        instructor: "Teaches and discovers new talents",
                        revealed_talents: "New competencies discovered through attestations expand the permit"
                    }
                }
            };

            // Build request (minimal)
            const requestData = {
                permit: {
                    id: permitId,
                    name: permitName,
                    description: permitDescription,
                    min_attestations: minAttestations,
                    required_license: null,
                    valid_duration_days: 0, // Unlimited
                    revocable: true,
                    verification_method: "peer_attestation",
                    metadata: metadata
                },
                npub: userHEX,
                bootstrap_emails: null // No bootstrap needed, system starts with 1 signature
            };

            try {
                // Use getAPIBaseUrl() from common.js to detect correct API URL
                const apiBaseUrl = getWoTx2APIBaseUrl();
                const response = await fetch(`${apiBaseUrl}/api/permit/define`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.success) {
                    console.log('[WoTx2] ‚úÖ Permit 30500 cr√©√©:', permitId);
                    
                    // Automatically create a 30501 request for the creator
                    // This makes the permit immediately usable and visible in "Apprentis Cherchant un Ma√Ætre"
                    try {
                        // Generate request ID
                        const requestId = await window.nostr.getPublicKey().then(pubkey => {
                            return btoa(pubkey + ':' + permitId + ':' + Date.now()).substring(0, 16);
                        });
                        
                        // Use permit name as default competency (can be refined later)
                        const defaultCompetency = permitName;
                        const defaultStatement = `Je souhaite apprendre ${permitName} et devenir ma√Ætre dans cette ma√Ætrise.`;
                        
                        // Get geolocation if available (with better error handling)
                        let location = null;
                        if (navigator.geolocation) {
                            try {
                                const position = await new Promise((resolve, reject) => {
                                    navigator.geolocation.getCurrentPosition(
                                        resolve, 
                                        reject, 
                                        { 
                                            timeout: 5000, // Increased timeout
                                            enableHighAccuracy: false, // Don't require high accuracy
                                            maximumAge: 60000 // Accept cached position up to 1 minute old
                                        }
                                    );
                                });
                                location = {
                                    latitude: position.coords.latitude,
                                    longitude: position.coords.longitude,
                                    timestamp: new Date().toISOString()
                                };
                                console.log('[WoTx2] ‚úÖ Geolocation obtained:', location);
                            } catch (e) {
                                // Silently fail - geolocation is optional
                                if (e.code === 1) {
                                    console.log('[WoTx2] Geolocation permission denied');
                                } else if (e.code === 2) {
                                    console.log('[WoTx2] Geolocation position unavailable');
                                } else if (e.code === 3) {
                                    console.log('[WoTx2] Geolocation timeout - continuing without location');
                                } else {
                                    console.log('[WoTx2] Geolocation error:', e.message);
                                }
                            }
                        } else {
                            console.log('[WoTx2] Geolocation not supported by browser');
                        }
                        
                        // Create permit request event (kind 30501)
                        const requestContent = {
                            request_id: requestId,
                            permit_definition_id: permitId,
                            applicant_did: `did:nostr:${userHEX}`,
                            statement: defaultStatement,
                            requested_competency: defaultCompetency,
                            evidence: [],
                            status: 'pending',
                            location: location
                        };
                        
                        const eventTags = [
                            ['d', requestId],
                            ['l', permitId, 'permit_type'],
                            ['p', userHEX],
                            ['t', 'permit'],
                            ['t', 'request']
                        ];
                        
                        // Add IPFSNODEID tag to filter events by Astroport
                        if (IPFSNODEID) {
                            eventTags.push(['ipfs_node', IPFSNODEID]);
                        }
                        
                        // Add geolocation tags if available
                        if (location) {
                            eventTags.push(['g', location.latitude.toString(), location.longitude.toString()]);
                        }
                        
                        const requestEvent = {
                            kind: 30501,
                            content: JSON.stringify(requestContent),
                            tags: eventTags,
                            created_at: Math.floor(Date.now() / 1000)
                        };
                        
                        // Sign and publish 30501 event
                        const signedRequestEvent = await window.nostr.signEvent(requestEvent);
                        
                        // Publish to relays (use common.js nostrRelay if available)
                        if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                            try {
                                await nostrRelay.publish(signedRequestEvent);
                                console.log('[WoTx2] ‚úÖ Event 30501 published to relay');
                            } catch (e) {
                                console.error('[WoTx2] Error publishing 30501 to relay:', e);
                                // Fallback to user's relays
                                if (window.nostr && typeof window.nostr.getRelays === 'function') {
                                    const relays = await window.nostr.getRelays();
                                    const relayUrls = Object.keys(relays);
                                    for (const relayUrl of relayUrls) {
                                        try {
                                            const relay = new Relay(relayUrl);
                                            await relay.connect();
                                            await relay.publish(signedRequestEvent);
                                            relay.close();
                                        } catch (err) {
                                            console.warn(`[WoTx2] Failed to publish 30501 to ${relayUrl}:`, err);
                                        }
                                    }
                                }
                            }
                        } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                            // Use user's configured relays
                            const relays = await window.nostr.getRelays();
                            const relayUrls = Object.keys(relays);
                            
                            for (const relayUrl of relayUrls) {
                                try {
                                    const relay = new Relay(relayUrl);
                                    await relay.connect();
                                    await relay.publish(signedRequestEvent);
                                    relay.close();
                                } catch (e) {
                                    console.warn(`[WoTx2] Failed to publish 30501 to ${relayUrl}:`, e);
                                }
                            }
                        }
                        
                        console.log('[WoTx2] ‚úÖ Request 30501 created automatically');
                        
                        // For X1 bootstrap: Create automatic self-attestation (30502)
                        // Oracle allows creator to attest for X1 in bootstrap mode (ORACLE.refresh.sh line 294-309)
                        try {
                            // Generate attestation ID
                            const attestationId = await window.nostr.getPublicKey().then(pubkey => {
                                return btoa(pubkey + ':' + requestId + ':' + Date.now() + '_bootstrap').substring(0, 16);
                            });
                            
                            const bootstrapStatement = `Auto-attestation bootstrap X1 : En tant que cr√©ateur de cette ma√Ætrise ${permitName}, je m'atteste pour d√©marrer le syst√®me. Cette attestation est valide uniquement pour le niveau X1 en mode bootstrap.`;
                            
                            // Create permit attestation event (kind 30502) - self-attestation for bootstrap
                            const attestationContent = {
                                attestation_id: attestationId,
                                request_id: requestId,
                                attester_did: `did:nostr:${userHEX}`,
                                statement: bootstrapStatement,
                                competencies_transferred: [],
                                revealed_competencies: [defaultCompetency], // Reveal the competency from the request
                                location: location,
                                signature: await window.nostr.getPublicKey().then(pubkey => {
                                    return btoa(pubkey + ':' + bootstrapStatement + ':' + Date.now()).substring(0, 32);
                                })
                            };
                            
                            // CRITICAL: Tag 'e' must reference the 30501 event ID (64-char hex), not the request_id
                            // The request_id is stored in the content, but the tag 'e' needs the Nostr event ID
                            const attestationTags = [
                                ['d', attestationId],
                                ['e', signedRequestEvent.id], // Use the 30501 event ID, not requestId
                                ['p', userHEX],
                                ['t', 'permit'],
                                ['t', 'attestation'],
                                ['t', 'bootstrap'] // Tag to indicate bootstrap mode
                            ];
                            
                            // Add IPFSNODEID tag
                            if (IPFSNODEID) {
                                attestationTags.push(['ipfs_node', IPFSNODEID]);
                            }
                            
                            // Add geolocation tags if available
                            if (location) {
                                attestationTags.push(['g', location.latitude.toString(), location.longitude.toString()]);
                            }
                            
                            const attestationEvent = {
                                kind: 30502,
                                content: JSON.stringify(attestationContent),
                                tags: attestationTags,
                                created_at: Math.floor(Date.now() / 1000)
                            };
                            
                            // Sign and publish 30502 event (self-attestation for bootstrap)
                            const signedAttestationEvent = await window.nostr.signEvent(attestationEvent);
                            
                            // Publish to relays
                            if (typeof nostrRelay !== 'undefined' && nostrRelay && isNostrConnected) {
                                try {
                                    await nostrRelay.publish(signedAttestationEvent);
                                    console.log('[WoTx2] ‚úÖ Event 30502 (bootstrap) published to relay');
                                } catch (e) {
                                    console.error('[WoTx2] Error publishing 30502 to relay:', e);
                                    // Fallback to user's relays
                                    if (window.nostr && typeof window.nostr.getRelays === 'function') {
                                        const relays = await window.nostr.getRelays();
                                        const relayUrls = Object.keys(relays);
                                        for (const relayUrl of relayUrls) {
                                            try {
                                                const relay = new Relay(relayUrl);
                                                await relay.connect();
                                                await relay.publish(signedAttestationEvent);
                                                relay.close();
                                            } catch (err) {
                                                console.warn(`[WoTx2] Failed to publish 30502 to ${relayUrl}:`, err);
                                            }
                                        }
                                    }
                                }
                            } else if (window.nostr && typeof window.nostr.getRelays === 'function') {
                                // Use user's configured relays
                                const relays = await window.nostr.getRelays();
                                const relayUrls = Object.keys(relays);
                                
                                for (const relayUrl of relayUrls) {
                                    try {
                                        const relay = new Relay(relayUrl);
                                        await relay.connect();
                                        await relay.publish(signedAttestationEvent);
                                        relay.close();
                                    } catch (e) {
                                        console.warn(`[WoTx2] Failed to publish 30502 to ${relayUrl}:`, e);
                                    }
                                }
                            }
                            
                            console.log('[WoTx2] ‚úÖ Attestation 30502 (bootstrap) created automatically');
                            
                let message = `‚úÖ Ma√Ætrise "${permitName}" cr√©√©e avec succ√®s !\n\n`;
                message += `üéØ Niveau X1 - Votre Point de D√©part\n`;
                message += `üìù 1 validation requise pour obtenir votre certificat\n\n`;
                message += `‚úÖ Tout est pr√™t !\n`;
                message += `   ‚Ä¢ Votre demande d'apprentissage a √©t√© cr√©√©e\n`;
                message += `   ‚Ä¢ Votre auto-validation a √©t√© enregistr√©e\n`;
                message += `   ‚Ä¢ Comp√©tence r√©v√©l√©e : ${defaultCompetency}\n\n`;
                message += `üîÑ Prochaines √©tapes automatiques :\n`;
                message += `   ‚Ä¢ Votre certificat X1 sera d√©livr√© dans les prochaines heures\n`;
                message += `   ‚Ä¢ Le niveau X2 sera cr√©√© automatiquement\n`;
                message += `   ‚Ä¢ Vous pourrez progresser vers X3, X4...\n\n`;
                message += `üí° Avantage : Votre ma√Ætrise est maintenant visible par toute la communaut√© UPlanet !`;
                alert(message);
                            
                        } catch (e) {
                            console.error('[WoTx2] Error creating automatic 30502:', e);
                            // Still show success message even if 30502 creation failed
                            let message = `‚úÖ Ma√Ætrise "${permitName}" cr√©√©e avec succ√®s !\n\n`;
                    message += `üìã Niveau X1 - D√©marrage\n`;
                            message += `üìù 1 validation requise pour votre certificat\n\n`;
                            message += `‚úÖ Votre demande d'apprentissage a √©t√© cr√©√©e !\n`;
                            message += `   ‚Ä¢ Comp√©tence : ${defaultCompetency}\n\n`;
                            message += `üí° Prochaine √©tape : Trouvez un ma√Ætre qui validera vos comp√©tences, ou cr√©ez une validation manuellement.\n\n`;
                            message += `üîÑ Progression automatique :\n`;
                            message += `   ‚Ä¢ X1 ‚Üí X2 : Apr√®s validation (2 comp√©tences)\n`;
                            message += `   ‚Ä¢ X2 ‚Üí X3 : Apr√®s validation (3 comp√©tences)\n`;
                            message += `   ‚Ä¢ X3 ‚Üí X4 : Niveau ma√Ætre atteint`;
                            alert(message);
                        }
                        
                    } catch (e) {
                        console.error('[WoTx2] Error creating automatic 30501:', e);
                        // Still show success message even if 30501 creation failed
                        let message = `‚úÖ Ma√Ætrise "${permitName}" cr√©√©e avec succ√®s !\n\n`;
                        message += `üí° Vous pouvez maintenant cr√©er votre demande d'apprentissage depuis cette page.\n\n`;
                        message += `üìã Niveau X1 - D√©marrage\n`;
                        message += `üìù 1 validation requise pour obtenir votre certificat`;
                    alert(message);
                    }
                    
                    bootstrap.Modal.getInstance(document.getElementById('newPermitModal')).hide();
                    
                    // Reload page to show new permit and request
                    setTimeout(() => {
                        window.location.href = `/wotx2?permit_id=${encodeURIComponent(permitId)}`;
                    }, 1000);
                } else {
                    alert('Erreur: ' + (result.detail || result.message || '√âchec de la cr√©ation'));
                }
            } catch (e) {
                console.error('Error creating permit:', e);
                alert('Erreur lors de la cr√©ation: ' + e.message);
            }
        }
    </script>
</body>
</html>

