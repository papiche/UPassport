<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê UPlanet Oracle - Permit Management</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="{{ myIPFS }}/ipns/copylaradio.com/fonts/bootstrap-icons.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="{{ myIPFS }}/ipns/copylaradio.com/leaflet.css"/>
    
    <!-- Bootstrap 5 JS Bundle -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/bootstrap.bundle.min.js"></script>
    
    <!-- NOSTR integration -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/nostr.bundle.js"></script>
    <!-- Leaflet JavaScript -->
    <script src="{{ myIPFS }}/ipns/copylaradio.com/leaflet.js"></script>
    
    <style>
        :root {
            --bs-primary: #4ade80;
            --bs-success: #22c55e;
            --bs-warning: #fbbf24;
            --bs-dark: #0f172a;
            --accent: #4ade80;
            --accent-hover: #22c55e;
            --muted: #64748b;
            --text: #e8e8e8;
            --border: rgba(74, 222, 128, 0.3);
            --error: #ef4444;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #e8e8e8;
            min-height: 100vh;
            padding-top: 70px;
        }

        .navbar {
            background: rgba(15, 23, 42, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(74, 222, 128, 0.3);
        }

        .navbar-brand {
            color: #4ade80 !important;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .nav-link {
            color: #cbd5e1 !important;
            transition: all 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            color: #4ade80 !important;
            background: rgba(74, 222, 128, 0.1);
            border-radius: 8px;
        }

        .card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 15px;
            color: #e8e8e8;
        }

        .card-header {
            background: rgba(74, 222, 128, 0.1);
            border-bottom: 1px solid rgba(74, 222, 128, 0.3);
            color: #4ade80;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            border: none;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4);
        }

        .btn-outline-primary {
            border-color: #4ade80;
            color: #4ade80;
        }

        .btn-outline-primary:hover {
            background: #4ade80;
            border-color: #4ade80;
            color: #0f172a;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .badge {
            font-size: 0.9rem;
            padding: 0.5em 0.75em;
        }

        .alert {
            border-radius: 8px;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #22c55e;
            color: #22c55e;
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .alert-info {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid #6366f1;
            color: #6366f1;
        }

        /* Tab System using Bootstrap Nav */
        .nav-tabs {
            border-bottom: 2px solid rgba(74, 222, 128, 0.3);
        }

        .nav-tabs .nav-link {
            color: #64748b;
            border: none;
            border-radius: 8px 8px 0 0;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-tabs .nav-link:hover {
            color: #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .nav-tabs .nav-link.active {
            color: #4ade80;
            background: rgba(74, 222, 128, 0.15);
            border-bottom: 3px solid #4ade80;
        }

        .tab-content {
            padding-top: 20px;
        }

        .permit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* Modal using Bootstrap */
        .modal-content {
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 15px;
            color: #e8e8e8;
        }

        .modal-header {
            border-bottom: 1px solid rgba(74, 222, 128, 0.3);
        }

        .modal-footer {
            border-top: 1px solid rgba(74, 222, 128, 0.3);
        }

        .btn-close {
            filter: invert(1);
        }

        /* Loading spinner */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading::after {
            content: '‚è≥';
            font-size: 48px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Progress bar customization */
        .progress {
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #4ade80, #fbbf24);
            border-radius: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding-top: 60px;
            }

            .permit-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs .nav-link {
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bootstrap -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-shield-lock"></i> ORACLE</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="bi bi-house"></i> Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/plantnet.html">
                            <i class="bi bi-flower1"></i> Flora Quest (ORE)
                        </a>
                    </li>
                </ul>
                <div id="nostr-header-actions">
                    <button class="btn btn-outline-primary me-2" id="nav-menu-connect" onclick="connectToNOSTR()">
                        <i class="bi bi-key"></i> Connexion
                    </button>
                    <span id="nav-user-status" class="text-success" style="display: none;">
                        <i class="bi bi-person-check"></i> <span id="nav-user-npub"></span>
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid" style="padding-top: 30px;">
        <div class="container">
            <!-- Header Info Section -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h1 class="display-4 fw-bold text-success mb-3">
                        <i class="bi bi-shield-lock"></i> UPlanet Oracle
                    </h1>
                    <p class="lead text-warning">Web of Trust ‚Ä¢ Competence Certification ‚Ä¢ Verifiable Credentials</p>
                </div>
            </div>

        <!-- Information Section -->
        <div class="info-section" id="info-section">
            <!-- Oracle Data Summary (if preloaded) -->
            {% if oracle_data %}
            <div style="background: rgba(74, 222, 128, 0.1); border: 1px solid var(--accent); border-radius: 12px; padding: 20px; margin-bottom: 30px;">
                <h3 style="color: var(--accent); margin-bottom: 15px; text-align: center;">
                    üìä Oracle System Status
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                    {% if oracle_data.total_definitions is defined %}
                    <div>
                        <div style="font-size: 2em; color: var(--accent); font-weight: 700;">
                            {{ oracle_data.total_definitions }}
                        </div>
                        <div style="color: var(--muted); font-size: 0.9em;">Permit Definitions</div>
                    </div>
                    {% endif %}
                    {% if oracle_data.total_requests is defined %}
                    <div>
                        <div style="font-size: 2em; color: var(--warning); font-weight: 700;">
                            {{ oracle_data.total_requests }}
                        </div>
                        <div style="color: var(--muted); font-size: 0.9em;">Pending Requests</div>
                    </div>
                    {% endif %}
                    {% if oracle_data.total_credentials is defined %}
                    <div>
                        <div style="font-size: 2em; color: var(--success); font-weight: 700;">
                            {{ oracle_data.total_credentials }}
                        </div>
                        <div style="color: var(--muted); font-size: 0.9em;">Issued Credentials</div>
                    </div>
                    {% endif %}
                    <div>
                        <div style="font-size: 1.2em; color: var(--text); font-weight: 700;">
                            {{ oracle_data.timestamp[:19] if oracle_data.timestamp else 'N/A' }}
                        </div>
                        <div style="color: var(--muted); font-size: 0.9em;">Last Updated</div>
                    </div>
                </div>
                {% if oracle_data.filters and (oracle_data.filters.type or oracle_data.filters.npub) %}
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border); text-align: center; color: var(--muted); font-size: 0.9em;">
                    <strong>Active Filters:</strong>
                    {% if oracle_data.filters.type %}
                    Type: <span style="color: var(--accent);">{{ oracle_data.filters.type }}</span>
                    {% endif %}
                    {% if oracle_data.filters.npub %}
                    | NPUB: <span style="color: var(--accent); font-family: monospace;">{{ oracle_data.filters.npub[:12] }}...</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <h2 style="color: var(--accent); margin-bottom: 20px; text-align: center;">
                üåê What is the Oracle System?
            </h2>
            
            <p style="color: var(--text); line-height: 1.8; margin-bottom: 20px; text-align: center; max-width: 800px; margin-left: auto; margin-right: auto;">
                The UPlanet Oracle extends the <strong>ƒû1 Web of Trust</strong> from identity verification to 
                <strong>competence certification</strong>. It's a decentralized system where community members 
                attest to each other's skills and expertise, creating verifiable professional credentials 
                stored on NOSTR and validated through multi-signature consensus.
            </p>

            <div class="info-grid">
                <div class="info-card">
                    <div class="info-card-icon">üë•</div>
                    <div class="info-card-title">Peer Attestation</div>
                    <div class="info-card-text">
                        Permits are validated by trusted community members who already hold the same credential, 
                        creating a self-governing meritocracy based on competence.
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-card-icon">üîê</div>
                    <div class="info-card-title">NOSTR Native</div>
                    <div class="info-card-text">
                        All permit requests, attestations, and credentials are stored as NOSTR events 
                        (kinds 30500-30503), ensuring transparency, auditability, and censorship resistance.
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-card-icon">‚úÖ</div>
                    <div class="info-card-title">W3C Compliant</div>
                    <div class="info-card-text">
                        Issued permits are W3C Verifiable Credentials (VCs) that can be independently 
                        verified by any party without relying on a central authority.
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-card-icon">üíé</div>
                    <div class="info-card-title">Economic Incentives</div>
                    <div class="info-card-text">
                        Permit holders receive ·∫êen rewards from the cooperative's R&D fund, 
                        incentivizing expertise, validation work, and positive contributions.
                    </div>
                </div>
            </div>

            <button class="toggle-button" onclick="toggleTechnicalDetails()">
                üîß Show Technical Details
            </button>

            <div id="technical-details" class="collapsible-content">
                <h3 style="color: var(--accent); margin: 20px 0 15px;">
                    üìä How It Works: The Permit Lifecycle
                </h3>

                <div class="flow-diagram">
                    <div class="flow-step">
                        <div class="flow-step-number">1</div>
                        <div class="flow-step-title">Request</div>
                        <div class="flow-step-desc">
                            User submits a permit request (NOSTR kind 30501) with statement & evidence
                        </div>
                    </div>

                    <div class="flow-arrow">‚Üí</div>

                    <div class="flow-step">
                        <div class="flow-step-number">2</div>
                        <div class="flow-step-title">Attest</div>
                        <div class="flow-step-desc">
                            Permit holders review and sign attestations (NOSTR kind 30502)
                        </div>
                    </div>

                    <div class="flow-arrow">‚Üí</div>

                    <div class="flow-step">
                        <div class="flow-step-number">3</div>
                        <div class="flow-step-title">Validate</div>
                        <div class="flow-step-desc">
                            Oracle checks signatures & issues W3C VC (NOSTR kind 30503)
                        </div>
                    </div>

                    <div class="flow-arrow">‚Üí</div>

                    <div class="flow-step">
                        <div class="flow-step-number">4</div>
                        <div class="flow-step-title">Reward</div>
                        <div class="flow-step-desc">
                            Holder receives ·∫êen from UPLANETNAME.RnD fund
                        </div>
                    </div>
                </div>

                <h3 style="color: var(--accent); margin: 30px 0 15px;">
                    üì° NOSTR Event Types
                </h3>

                <table class="nostr-kinds-table">
                    <thead>
                        <tr>
                            <th>Kind</th>
                            <th>Purpose</th>
                            <th>Signed By</th>
                            <th>Replaceability</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="kind-badge">30500</span></td>
                            <td>Permit Definition</td>
                            <td>UPLANETNAME.G1</td>
                            <td>Parameterized Replaceable</td>
                        </tr>
                        <tr>
                            <td><span class="kind-badge">30501</span></td>
                            <td>Permit Request</td>
                            <td>Applicant</td>
                            <td>Parameterized Replaceable</td>
                        </tr>
                        <tr>
                            <td><span class="kind-badge">30502</span></td>
                            <td>Permit Attestation</td>
                            <td>Attester</td>
                            <td>Parameterized Replaceable</td>
                        </tr>
                        <tr>
                            <td><span class="kind-badge">30503</span></td>
                            <td>Verifiable Credential</td>
                            <td>UPLANETNAME.G1</td>
                            <td>Parameterized Replaceable</td>
                        </tr>
                    </tbody>
                </table>

                <h3 style="color: var(--accent); margin: 30px 0 15px;">
                    üéØ Use Cases
                </h3>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-card-icon">üå±</div>
                        <div class="info-card-title">ORE Verifier</div>
                        <div class="info-card-text">
                            Certify field auditors who verify environmental obligations (ORE) 
                            compliance for UMAP parcels.
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-icon">üöÄ</div>
                        <div class="info-card-title">Relay Captain</div>
                        <div class="info-card-text">
                            Designate trusted operators for NOSTR relays and station infrastructure 
                            management.
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-icon">üêâ</div>
                        <div class="info-card-title">WoT Dragon</div>
                        <div class="info-card-text">
                            Highest authority permit for managing UPlanet infrastructure, 
                            issuing VCs, and acting as trusted oracle.
                        </div>
                    </div>

                    <div class="info-card">
                        <div class="info-card-icon">üéì</div>
                        <div class="info-card-title">Skill Certification</div>
                        <div class="info-card-text">
                            Any competence can become a permit: technical skills, artistic abilities, 
                            professional licenses, etc.
                        </div>
                    </div>
                </div>

                <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); border-radius: 12px; padding: 20px; margin: 20px 0;">
                    <h4 style="color: var(--warning); margin-bottom: 10px;">
                        ‚ö° Key Innovation: WoT Bootstrap
                    </h4>
                    <p style="color: var(--text); line-height: 1.6;">
                        New permit types require a "Block 0" initialization where N+1 founding members 
                        cross-attest each other (e.g., 13 members for a permit requiring 12 signatures). 
                        This creates the initial Web of Trust without centralized gatekeepers.
                    </p>
                </div>
            </div>
            </div>
        </div>

            <!-- Authentication Section -->
            <div class="card mb-4" id="auth-section">
                <div class="card-body">
                    <div id="auth-content">
                        <button class="btn btn-primary btn-lg" id="connect-btn" onclick="connectToNOSTR()">
                            <i class="bi bi-plug"></i> Connect with NOSTR
                        </button>
                        <div id="auth-status" class="mt-3"></div>
                    </div>
                </div>
            </div>

        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <!-- Tabs using Bootstrap Nav Tabs -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="permits-tab" data-bs-toggle="tab" data-bs-target="#permits" type="button">
                        <i class="bi bi-file-text"></i> Available Permits
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="my-permits-tab" data-bs-toggle="tab" data-bs-target="#my-permits" type="button">
                        <i class="bi bi-award"></i> My Permits
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pending-requests-tab" data-bs-toggle="tab" data-bs-target="#pending-requests" type="button">
                        <i class="bi bi-hourglass-split"></i> Pending Requests
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="my-attestations-tab" data-bs-toggle="tab" data-bs-target="#my-attestations" type="button">
                        <i class="bi bi-pen"></i> My Attestations
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ore-contracts-tab" data-bs-toggle="tab" data-bs-target="#ore-contracts" type="button">
                        <i class="bi bi-flower1"></i> ORE Contracts
                    </button>
                </li>
                <li class="nav-item" role="presentation" id="admin-tab-nav" style="display: none;">
                    <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button">
                        <i class="bi bi-gear"></i> Admin (Captain)
                    </button>
                </li>
            </ul>

            <!-- Tab Content using Bootstrap -->
            <div class="tab-content" id="mainTabsContent">

                <!-- Tab Pane: Available Permits -->
                <div class="tab-pane fade show active" id="permits" role="tabpanel">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <label class="fw-bold">Filter by type:</label>
                                <select id="permit-filter" class="form-select w-auto" onchange="filterPermits()">
                                    <option value="all">All Permits</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="permits-list" class="loading"></div>
                </div>

                <!-- Tab Pane: My Permits -->
                <div class="tab-pane fade" id="my-permits" role="tabpanel">
                    <div class="mb-3">
                        <button class="btn btn-primary" onclick="openRequestModal()">
                            <i class="bi bi-plus-circle"></i> Request New Permit
                        </button>
                    </div>
                    <div id="my-permits-list" class="loading"></div>
                </div>

                <!-- Tab Pane: Pending Requests -->
                <div class="tab-pane fade" id="pending-requests" role="tabpanel">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div class="d-flex align-items-center gap-2">
                                    <label class="fw-bold">Filter by permit:</label>
                                    <select id="request-filter" class="form-select w-auto" onchange="filterRequests()">
                                        <option value="all">All Requests</option>
                                    </select>
                                </div>
                                <button class="btn btn-secondary" onclick="refreshRequests()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="pending-requests-list" class="loading"></div>
                </div>

                <!-- Tab Pane: My Attestations -->
                <div class="tab-pane fade" id="my-attestations" role="tabpanel">
                    <div id="my-attestations-list" class="loading"></div>
                </div>

                <!-- Tab Pane: ORE Contracts -->
                <div class="tab-pane fade" id="ore-contracts" role="tabpanel">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div class="d-flex align-items-center gap-2">
                                    <label class="fw-bold">Filter:</label>
                                    <select id="ore-filter" class="form-select w-auto" onchange="filterOREContracts()">
                                        <option value="all">All UMAPs</option>
                                        <option value="active">Active Contracts</option>
                                        <option value="pending">Pending Validation</option>
                                    </select>
                                </div>
                                <button class="btn btn-secondary" onclick="refreshOREContracts()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                <!-- Map for ORE visualization -->
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">
                        üó∫Ô∏è ORE Contracts Map
                    </h3>
                    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
                    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
                    <div id="ore-map" style="height: 500px; border-radius: 12px;"></div>
                    <div style="margin-top: 15px; padding: 15px; background: rgba(74, 222, 128, 0.05); border-radius: 8px;">
                        <strong style="color: var(--accent);">Map Legend:</strong>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li><span style="color: #fbbf24;">üèÜ Yellow</span> - Active ORE Contract (8+ plants)</li>
                            <li><span style="color: #22c55e;">üü¢ Green</span> - Validated UMAP (1-7 plants)</li>
                            <li><span style="color: #3b82f6;">üîµ Blue</span> - UMAP DID exists</li>
                        </ul>
                    </div>
                </div>
                <div id="ore-contracts-list" class="loading"></div>
            </div>

            <!-- Tab Content: Admin (Captain) -->
            <div id="admin-tab-content" class="tab-content">
                <div class="info-section" style="background: rgba(239, 68, 68, 0.1); border-color: var(--error);">
                    <h3 style="color: var(--error); margin-bottom: 15px;">
                        üîê Captain Administration Panel
                    </h3>
                    <p style="color: var(--text); margin-bottom: 20px;">
                        You are authenticated as the station captain. You have administrative privileges to manage the Oracle system.
                    </p>
                </div>

                <!-- Admin Actions Grid -->
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-card-icon">üöÄ</div>
                        <div class="info-card-title">Issue Credentials</div>
                        <div class="info-card-text">
                            Manually trigger credential issuance for validated permit requests.
                        </div>
                        <button class="btn" onclick="showPendingIssuance()" style="margin-top: 10px; width: 100%;">
                            View Pending
                        </button>
                    </div>

                    <div class="info-card">
                        <div class="info-card-icon">‚ùå</div>
                        <div class="info-card-title">Revoke Credentials</div>
                        <div class="info-card-text">
                            Revoke issued credentials in case of misconduct or false attestations.
                        </div>
                        <button class="btn btn-danger" onclick="showRevocationInterface()" style="margin-top: 10px; width: 100%;">
                            Manage Revocations
                        </button>
                    </div>

                    <div class="info-card">
                        <div class="info-card-icon">‚è±Ô∏è</div>
                        <div class="info-card-title">Expire Old Requests</div>
                        <div class="info-card-text">
                            Mark stale requests (> 90 days) as expired to clean up the system.
                        </div>
                        <button class="btn btn-secondary" onclick="expireOldRequests()" style="margin-top: 10px; width: 100%;">
                            Run Expiration
                        </button>
                    </div>

                    <div class="info-card">
                        <div class="info-card-icon">üå±</div>
                        <div class="info-card-title">Activate ORE Contracts</div>
                        <div class="info-card-text">
                            Activate ORE contracts for UMAPs that have reached the 8-plant threshold.
                        </div>
                        <button class="btn" onclick="showOREActivation()" style="margin-top: 10px; width: 100%;">
                            Activate Contracts
                        </button>
                    </div>
                </div>

                <!-- Admin Stats -->
                <div class="card" style="margin-top: 30px;">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">
                        üìä System Statistics
                    </h3>
                    <div id="admin-stats" class="info-grid">
                        <div class="info-card">
                            <div class="info-card-icon">üìã</div>
                            <div class="info-card-title">Total Requests</div>
                            <div class="info-card-text" id="stat-total-requests">Loading...</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-icon">‚úÖ</div>
                            <div class="info-card-title">Validated Requests</div>
                            <div class="info-card-text" id="stat-validated-requests">Loading...</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-icon">üé´</div>
                            <div class="info-card-title">Active Credentials</div>
                            <div class="info-card-text" id="stat-active-credentials">Loading...</div>
                        </div>
                        <div class="info-card">
                            <div class="info-card-icon">üå±</div>
                            <div class="info-card-title">Active ORE Contracts</div>
                            <div class="info-card-text" id="stat-ore-contracts">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Log -->
                <div class="card" style="margin-top: 20px;">
                    <h3 style="color: var(--accent); margin-bottom: 15px;">
                        üìú Recent Activity
                    </h3>
                    <div id="admin-activity-log" style="max-height: 400px; overflow-y: auto;">
                        <div class="loading"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Request Permit -->
        <div id="request-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Request a Permit</h2>
                    <span class="modal-close" onclick="closeRequestModal()">&times;</span>
                </div>
                <form id="request-form" onsubmit="submitRequest(event)">
                    <div class="form-group">
                        <label for="permit-select">Permit Type:</label>
                        <select id="permit-select" required>
                            <option value="">Select a permit...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="statement">Statement (why you need this permit):</label>
                        <textarea id="statement" required 
                                  placeholder="Explain your qualifications and reason for requesting this permit..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="evidence">Evidence (IPFS links, optional):</label>
                        <input type="text" id="evidence" 
                               placeholder="ipfs://... (comma-separated for multiple)">
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn">üöÄ Submit Request</button>
                        <button type="button" class="btn btn-secondary" onclick="closeRequestModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Attest Request -->
        <div id="attest-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Attest Permit Request</h2>
                    <span class="modal-close" onclick="closeAttestModal()">&times;</span>
                </div>
                <div id="attest-details"></div>
                <form id="attest-form" onsubmit="submitAttestation(event)">
                    <input type="hidden" id="attest-request-id">
                    <div class="form-group">
                        <label for="attest-statement">Your Attestation:</label>
                        <textarea id="attest-statement" required 
                                  placeholder="Confirm the applicant's competence and provide details..."></textarea>
                    </div>
                    <div class="action-buttons">
                        <button type="submit" class="btn">‚úçÔ∏è Sign & Submit Attestation</button>
                        <button type="button" class="btn btn-secondary" onclick="closeAttestModal()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let USPOT_API_BASE = '';
        let DEFAULT_RELAYS = [];
        let nostrRelay = null;
        let isNostrConnected = false;
        let userPubkey = null;
        let userNpub = null;
        let userEmail = null;
        let isCaptain = false; // Captain status (determined by NIP-42 auth)

        // Data caches
        let allPermitDefinitions = [];
        let allPermitRequests = [];
        let myPermitCredentials = [];
        let allOREContracts = []; // ORE contracts (kind 30312)
        let oreMap = null; // Leaflet map instance

        // Pre-loaded data from server (if available)
        let preloadedOracleData = null;
        // Jinja2 template injection - ignore linter warnings
        {% if oracle_data %}
        try {
            preloadedOracleData = {{ oracle_data | tojson | safe }};
            console.log('üì¶ Oracle data preloaded from server:', preloadedOracleData);
        } catch (e) {
            console.error('Failed to parse preloaded oracle data:', e);
        }
        {% endif %}

        // Detect uSPOT API
        function detectUSPOTAPI() {
            const currentURL = new URL(window.location.href);
            const hostname = currentURL.hostname;
            const protocol = currentURL.protocol.split(":")[0];

            let determinedRelay = '';
            let apiBase = '';

            if (hostname === "127.0.0.1") {
                determinedRelay = `ws://127.0.0.1:7777`;
                apiBase = `http://127.0.0.1:54321`;
            } else if (hostname.startsWith("ipfs.")) {
                const baseDomain = hostname.substring("ipfs.".length);
                determinedRelay = `wss://relay.${baseDomain}`;
                apiBase = `https://u.${baseDomain}`;
            } else if (hostname.startsWith("u.")) {
                const baseDomain = hostname.substring("u.".length);
                determinedRelay = `wss://relay.${baseDomain}`;
                apiBase = `https://u.${baseDomain}`;
            } else {
                determinedRelay = `wss://relay.copylaradio.com`;
                apiBase = `https://u.copylaradio.com`;
            }

            DEFAULT_RELAYS = [determinedRelay, 'wss://relay.damus.io', 'wss://nos.lol'];
            USPOT_API_BASE = apiBase;

            console.log(`uSPOT API Base: ${USPOT_API_BASE}`);
            console.log(`Default Relay: ${DEFAULT_RELAYS[0]}`);
        }

        // Connect to NOSTR
        async function connectToNOSTR() {
            const statusDiv = document.getElementById('auth-status');
            const connectBtn = document.getElementById('connect-btn');

            connectBtn.disabled = true;
            statusDiv.innerHTML = '<div class="status-message status-info">üîÑ Connecting to NOSTR...</div>';

            try {
                if (typeof window.nostr === 'undefined' || typeof window.nostr.getPublicKey !== 'function') {
                    throw new Error("NOSTR extension not found. Please install a NOSTR extension (nos2x, Alby, etc.)");
                }

                userPubkey = await window.nostr.getPublicKey();
                userNpub = NostrTools.nip19.npubEncode(userPubkey);
                console.log("Connected with public key:", userPubkey);

                // Connect to relay
                await connectToRelay();

                // Send NIP-42 auth
                await sendNIP42Auth();

                // Check if user is captain (via API)
                await checkCaptainStatus();

                // Fetch user email from DID
                userEmail = await fetchUserEmail(userPubkey);

                // Show success
                statusDiv.innerHTML = `
                    <div class="status-message status-success">
                        ‚úÖ Connected as ${userNpub.substring(0, 12)}...${userNpub.substring(userNpub.length - 4)}
                        ${userEmail ? `<br>üìß ${userEmail}` : ''}
                        ${isCaptain ? '<br>üëë <strong>Captain Access Granted</strong>' : ''}
                    </div>
                `;
                connectBtn.textContent = '‚úÖ Connected';
                connectBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';

                // Show admin tab if captain
                if (isCaptain) {
                    document.getElementById('admin-tab').style.display = 'block';
                }

                // Show main content
                document.getElementById('main-content').style.display = 'block';

                // Load data
                await loadAllData();

            } catch (error) {
                console.error("Connection error:", error);
                statusDiv.innerHTML = `<div class="status-message status-error">‚ùå ${error.message}</div>`;
                connectBtn.disabled = false;
            }
        }

        // Connect to relay
        async function connectToRelay() {
            const relayUrl = DEFAULT_RELAYS[0];

            if (nostrRelay && isNostrConnected) {
                console.log('‚úÖ Reusing existing relay connection');
                return;
            }

            console.log('Connecting to relay:', relayUrl);

            try {
                if (nostrRelay) {
                    try {
                        nostrRelay.close();
                    } catch (e) {
                        console.warn('Error closing existing relay:', e);
                    }
                }

                nostrRelay = NostrTools.relayInit(relayUrl);

                nostrRelay.on('connect', () => {
                    console.log('‚úÖ Connected to NOSTR relay:', relayUrl);
                    isNostrConnected = true;
                });

                nostrRelay.on('error', (error) => {
                    console.error('‚ùå Relay connection error:', error);
                    isNostrConnected = false;
                });

                nostrRelay.on('disconnect', () => {
                    console.log('üîå Relay disconnected');
                    isNostrConnected = false;
                });

                await nostrRelay.connect();
                isNostrConnected = true;

            } catch (error) {
                console.error('Failed to connect to relay:', error);
                isNostrConnected = false;
                throw error;
            }
        }

        // Send NIP-42 authentication
        async function sendNIP42Auth() {
            if (!userPubkey || !nostrRelay || !isNostrConnected) {
                console.warn('Cannot send NIP-42 auth: missing requirements');
                return;
            }

            try {
                console.log('üìù Sending NIP-42 authentication event...');

                const authEvent = {
                    kind: 22242,
                    created_at: Math.floor(Date.now() / 1000),
                    tags: [
                        ['relay', DEFAULT_RELAYS[0]],
                        ['challenge', 'auth-' + Date.now()]
                    ],
                    content: '',
                    pubkey: userPubkey
                };

                const signedEvent = await window.nostr.signEvent(authEvent);

                if (!signedEvent || !signedEvent.id) {
                    console.error('‚ùå Failed to sign NIP-42 event');
                    return;
                }

                console.log('‚úÖ NIP-42 event signed:', signedEvent.id);

                await nostrRelay.publish(signedEvent);
                console.log('‚úÖ NIP-42 event published');

                // Also send AUTH message
                try {
                    let ws = nostrRelay._ws || nostrRelay.ws || nostrRelay.socket;
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        const authMessage = JSON.stringify(['AUTH', signedEvent]);
                        ws.send(authMessage);
                        console.log('‚úÖ NIP-42 AUTH message sent');
                    }
                } catch (authError) {
                    console.warn('‚ö†Ô∏è Could not send AUTH message:', authError);
                }

            } catch (error) {
                console.error('‚ùå Failed to send NIP-42 auth:', error);
            }
        }

        // Fetch user email from DID
        async function fetchUserEmail(pubkey) {
            try {
                const filter = {
                    kinds: [30800],  // DID documents (NIP-101)
                    authors: [pubkey],
                    '#d': ['did'],
                    limit: 1
                };

                return new Promise((resolve) => {
                    const sub = nostrRelay.sub([filter]);
                    let didDocument = null;

                    const timeout = setTimeout(() => {
                        sub.unsub();
                        if (didDocument) {
                            try {
                                const didData = JSON.parse(didDocument.content);
                                resolve(didData.metadata?.email || null);
                            } catch (e) {
                                resolve(null);
                            }
                        } else {
                            resolve(null);
                        }
                    }, 3000);

                    sub.on('event', (event) => {
                        didDocument = event;
                    });

                    sub.on('eose', () => {
                        clearTimeout(timeout);
                        sub.unsub();
                        if (didDocument) {
                            try {
                                const didData = JSON.parse(didDocument.content);
                                resolve(didData.metadata?.email || null);
                            } catch (e) {
                                resolve(null);
                            }
                        } else {
                            resolve(null);
                        }
                    });
                });
            } catch (error) {
                console.error('Error fetching user email:', error);
                return null;
            }
        }

        // Load all data
        async function loadAllData() {
            await loadPermitDefinitions();
            await loadPermitRequests();
            await loadMyPermitCredentials();
            await loadMyAttestations();
            await loadOREContracts(); // Load ORE contracts
            if (isCaptain) {
                await loadAdminStats(); // Load admin statistics
            }
        }

        // Check captain status via API
        async function checkCaptainStatus() {
            try {
                // The server will check NIP-42 auth and determine if user is captain
                // For now, we check if the user has PERMIT_WOT_DRAGON credential
                const response = await fetch(`${USPOT_API_BASE}/api/permit/list?type=credentials&npub=${userNpub}`);
                const data = await response.json();
                
                if (data.credentials) {
                    // Check if user has WoT Dragon permit
                    isCaptain = data.credentials.some(c => 
                        c.permit_definition_id === 'PERMIT_WOT_DRAGON' && 
                        c.status === 'active'
                    );
                }
                
                console.log('Captain status:', isCaptain);
            } catch (error) {
                console.error('Error checking captain status:', error);
                isCaptain = false;
            }
        }

        // Load ORE contracts from NOSTR (kind 30312)
        async function loadOREContracts() {
            try {
                console.log('üì° Fetching ORE contracts from NOSTR...');
                const filter = {
                    kinds: [30312],  // ORE Meeting Space
                    '#t': ['ORE'],
                    limit: 500
                };

                allOREContracts = [];
                const sub = nostrRelay.sub([filter]);

                const timeout = setTimeout(() => {
                    sub.unsub();
                    renderOREContracts();
                    if (oreMap) {
                        displayOREOnMap();
                    } else {
                        initializeOREMap();
                    }
                }, 10000);

                sub.on('event', (event) => {
                    allOREContracts.push(event);
                });

                sub.on('eose', () => {
                    clearTimeout(timeout);
                    sub.unsub();
                    console.log(`‚úÖ Loaded ${allOREContracts.length} ORE contracts`);
                    renderOREContracts();
                    if (oreMap) {
                        displayOREOnMap();
                    } else {
                        initializeOREMap();
                    }
                });

            } catch (error) {
                console.error('Error loading ORE contracts:', error);
                document.getElementById('ore-contracts-list').innerHTML = 
                    '<div class="status-message status-error">‚ùå Failed to load ORE contracts</div>';
            }
        }

        // Initialize ORE map
        function initializeOREMap() {
            if (typeof L === 'undefined') {
                console.warn('Leaflet not loaded');
                return;
            }

            const mapEl = document.getElementById('ore-map');
            if (!mapEl) {
                console.warn('Map element not found');
                return;
            }

            // Initialize map centered on France
            oreMap = L.map('ore-map').setView([46.0, 2.0], 6);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(oreMap);

            // Display ORE contracts on map
            displayOREOnMap();
        }

        // Display ORE contracts on map
        function displayOREOnMap() {
            if (!oreMap) return;

            // Clear existing markers
            oreMap.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                    oreMap.removeLayer(layer);
                }
            });

            // Add markers for each ORE contract
            allOREContracts.forEach(contract => {
                const geoTag = contract.tags.find(t => t[0] === 'g');
                if (!geoTag || !geoTag[1]) return;

                const [lat, lon] = geoTag[1].split(',').map(parseFloat);
                if (isNaN(lat) || isNaN(lon)) return;

                // Parse contract content to determine status
                let plantCount = 0;
                try {
                    const content = JSON.parse(contract.content || '{}');
                    plantCount = content.plants_count || 0;
                } catch (e) {
                    // Try to extract from content string
                    const match = contract.content.match(/(\d+)\s+plant/i);
                    if (match) plantCount = parseInt(match[1]);
                }

                // Determine marker color based on plant count
                let color, status;
                if (plantCount >= 8) {
                    color = '#fbbf24'; // Gold - Active ORE contract
                    status = 'Active ORE Contract';
                } else if (plantCount > 0) {
                    color = '#22c55e'; // Green - Validated UMAP
                    status = 'Validated UMAP';
                } else {
                    color = '#3b82f6'; // Blue - DID exists
                    status = 'UMAP DID';
                }

                const marker = L.circleMarker([lat, lon], {
                    radius: plantCount >= 8 ? 12 : 8,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(oreMap);

                const date = new Date(contract.created_at * 1000).toLocaleDateString();
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <strong style="color: ${color};">${status}</strong><br>
                        <small>UMAP: ${geoTag[1]}</small><br>
                        <strong>Plants:</strong> ${plantCount}<br>
                        <small style="color: #888;">Created: ${date}</small><br>
                        <button onclick="viewOREContract('${contract.id}')" 
                           class="btn btn-sm" 
                           style="background: ${color}; color: white; border: none; margin-top: 5px; padding: 4px 8px;">
                            View Details
                        </button>
                    </div>
                `);
            });

            // Fit map to show all markers
            if (allOREContracts.length > 0) {
                const markers = [];
                oreMap.eachLayer(layer => {
                    if (layer instanceof L.CircleMarker) {
                        markers.push(layer);
                    }
                });
                if (markers.length > 0) {
                    const group = new L.featureGroup(markers);
                    oreMap.fitBounds(group.getBounds().pad(0.1));
                }
            }
        }

        // Render ORE contracts list
        function renderOREContracts() {
            const container = document.getElementById('ore-contracts-list');

            if (allOREContracts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üå±</div>
                        <p>No ORE contracts found</p>
                        <p style="color: var(--muted); font-size: 0.9em;">
                            ORE contracts are created when UMAPs reach 8+ plant observations
                        </p>
                    </div>
                `;
                return;
            }

            // Group contracts by status
            const activeContracts = [];
            const pendingContracts = [];
            const otherContracts = [];

            allOREContracts.forEach(contract => {
                let plantCount = 0;
                try {
                    const content = JSON.parse(contract.content || '{}');
                    plantCount = content.plants_count || 0;
                } catch (e) {
                    const match = contract.content.match(/(\d+)\s+plant/i);
                    if (match) plantCount = parseInt(match[1]);
                }

                if (plantCount >= 8) {
                    activeContracts.push({ ...contract, plantCount });
                } else if (plantCount >= 5) {
                    pendingContracts.push({ ...contract, plantCount });
                } else {
                    otherContracts.push({ ...contract, plantCount });
                }
            });

            container.innerHTML = `
                ${activeContracts.length > 0 ? `
                    <h3 style="color: #fbbf24; margin: 20px 0 15px;">
                        üèÜ Active ORE Contracts (${activeContracts.length})
                    </h3>
                    <div class="permit-grid">
                        ${activeContracts.map(c => renderOREContractCard(c)).join('')}
                    </div>
                ` : ''}
                
                ${pendingContracts.length > 0 ? `
                    <h3 style="color: var(--warning); margin: 20px 0 15px;">
                        ‚è≥ Pending Validation (${pendingContracts.length})
                    </h3>
                    <div class="permit-grid">
                        ${pendingContracts.map(c => renderOREContractCard(c)).join('')}
                    </div>
                ` : ''}
                
                ${otherContracts.length > 0 ? `
                    <h3 style="color: var(--muted); margin: 20px 0 15px;">
                        üìç Other UMAPs (${otherContracts.length})
                    </h3>
                    <div class="permit-grid">
                        ${otherContracts.map(c => renderOREContractCard(c)).join('')}
                    </div>
                ` : ''}
            `;
        }

        // Render ORE contract card
        function renderOREContractCard(contract) {
            const geoTag = contract.tags.find(t => t[0] === 'g');
            const umapCoords = geoTag ? geoTag[1] : 'Unknown';
            const date = new Date(contract.created_at * 1000).toLocaleDateString();
            const plantCount = contract.plantCount || 0;
            const status = plantCount >= 8 ? 'active' : plantCount >= 5 ? 'pending' : 'inactive';
            const statusColor = status === 'active' ? '#fbbf24' : status === 'pending' ? 'var(--warning)' : 'var(--muted)';

            return `
                <div class="permit-card">
                    <div class="permit-header">
                        <div>
                            <div class="permit-title" style="color: ${statusColor};">
                                UMAP ${umapCoords}
                            </div>
                            <div class="permit-id">${contract.id.substring(0, 16)}...</div>
                        </div>
                        <span class="badge" style="background: rgba(${status === 'active' ? '251, 191, 36' : status === 'pending' ? '245, 158, 11' : '100, 116, 139'}, 0.2); border-color: ${statusColor}; color: ${statusColor};">
                            ${status.toUpperCase()}
                        </span>
                    </div>
                    <div class="permit-meta">
                        <span class="badge">
                            üå± ${plantCount} plants
                        </span>
                        <span class="badge badge-info">
                            üìÖ ${date}
                        </span>
                    </div>
                    <div class="permit-description" style="font-size: 0.9em; color: var(--text); margin: 10px 0;">
                        ${contract.content ? contract.content.substring(0, 150) + (contract.content.length > 150 ? '...' : '') : 'No description'}
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="viewOREContract('${contract.id}')">
                            üìÑ View Details
                        </button>
                        <button class="btn" onclick="centerMapOnUMAP('${umapCoords}')">
                            üó∫Ô∏è Show on Map
                        </button>
                        ${isCaptain && status === 'pending' ? `
                            <button class="btn" onclick="activateOREContract('${contract.id}')">
                                ‚úÖ Activate Contract
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // View ORE contract details
        function viewOREContract(contractId) {
            const contract = allOREContracts.find(c => c.id === contractId);
            if (!contract) {
                alert('Contract not found');
                return;
            }

            // Open in new window/modal with full details
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>ORE Contract Details</h2>
                        <span class="modal-close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="card">
                        <h3>Contract ID</h3>
                        <p style="font-family: monospace; word-break: break-all;">${contract.id}</p>
                        
                        <h3>Location</h3>
                        <p>${contract.tags.find(t => t[0] === 'g')?.[1] || 'Unknown'}</p>
                        
                        <h3>Created</h3>
                        <p>${new Date(contract.created_at * 1000).toLocaleString()}</p>
                        
                        <h3>Content</h3>
                        <pre style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; overflow-x: auto; color: var(--text);">${contract.content || 'No content'}</pre>
                        
                        <h3>Tags</h3>
                        <pre style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; overflow-x: auto; color: var(--text);">${JSON.stringify(contract.tags, null, 2)}</pre>
                    </div>
                    <div class="action-buttons" style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Center map on UMAP
        function centerMapOnUMAP(umapCoords) {
            if (!oreMap) {
                // Switch to ORE contracts tab first
                switchTab('ore-contracts');
                setTimeout(() => {
                    if (!oreMap) initializeOREMap();
                    setTimeout(() => centerMapOnUMAP(umapCoords), 500);
                }, 500);
                return;
            }

            const [lat, lon] = umapCoords.split(',').map(parseFloat);
            if (!isNaN(lat) && !isNaN(lon)) {
                oreMap.setView([lat, lon], 13);
            }
        }

        // Refresh ORE contracts
        async function refreshOREContracts() {
            document.getElementById('ore-contracts-list').innerHTML = '<div class="loading"></div>';
            await loadOREContracts();
        }

        // Filter ORE contracts
        function filterOREContracts() {
            // TODO: Implement filtering based on dropdown selection
            renderOREContracts();
        }

        // Admin functions
        async function loadAdminStats() {
            try {
                // Count total requests
                const totalRequests = allPermitRequests.length;
                const validatedRequests = allPermitRequests.filter(r => r.status === 'validated').length;
                const activeCredentials = myPermitCredentials.filter(c => c.status === 'active').length;
                const activeOREContracts = allOREContracts.filter(c => {
                    let plantCount = 0;
                    try {
                        const content = JSON.parse(c.content || '{}');
                        plantCount = content.plants_count || 0;
                    } catch (e) {
                        const match = c.content.match(/(\d+)\s+plant/i);
                        if (match) plantCount = parseInt(match[1]);
                    }
                    return plantCount >= 8;
                }).length;

                document.getElementById('stat-total-requests').textContent = totalRequests;
                document.getElementById('stat-validated-requests').textContent = validatedRequests;
                document.getElementById('stat-active-credentials').textContent = activeCredentials;
                document.getElementById('stat-ore-contracts').textContent = activeOREContracts;

                // Load activity log
                await loadAdminActivityLog();
            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }

        async function loadAdminActivityLog() {
            const logContainer = document.getElementById('admin-activity-log');
            
            // Combine all activities
            const activities = [];
            
            // Recent requests
            allPermitRequests.slice(0, 10).forEach(req => {
                activities.push({
                    time: req.created_at,
                    type: 'request',
                    text: `New permit request: ${req.permit_definition_id}`,
                    icon: 'üìù'
                });
            });
            
            // Recent credentials
            myPermitCredentials.slice(0, 10).forEach(cred => {
                activities.push({
                    time: new Date(cred.issued_at).getTime() / 1000,
                    type: 'credential',
                    text: `Credential issued: ${cred.permit_definition_id}`,
                    icon: '‚úÖ'
                });
            });
            
            // Sort by time (most recent first)
            activities.sort((a, b) => b.time - a.time);
            
            logContainer.innerHTML = activities.slice(0, 20).map(act => `
                <div style="padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid var(--accent);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-size: 1.2em; margin-right: 8px;">${act.icon}</span>
                            <span style="color: var(--text);">${act.text}</span>
                        </div>
                        <span style="color: var(--muted); font-size: 0.85em;">
                            ${new Date(act.time * 1000).toLocaleString()}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Admin actions
        function showPendingIssuance() {
            const pending = allPermitRequests.filter(r => r.status === 'validated' && !r.credential_id);
            
            if (pending.length === 0) {
                alert('No pending credential issuance');
                return;
            }
            
            alert(`There are ${pending.length} requests ready for credential issuance.`);
            // TODO: Implement full interface for manual issuance
        }

        function showRevocationInterface() {
            alert('Revocation interface - coming soon');
            // TODO: Implement revocation interface
        }

        async function expireOldRequests() {
            if (!confirm('This will mark all requests older than 90 days as expired. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch(`${USPOT_API_BASE}/api/permit/expire/all`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to expire old requests');
                }
                
                alert('‚úÖ Old requests expired successfully');
                await loadPermitRequests();
            } catch (error) {
                console.error('Error expiring requests:', error);
                alert('‚ùå Failed to expire requests: ' + error.message);
            }
        }

        function showOREActivation() {
            // Filter pending ORE contracts (5-7 plants)
            const pending = allOREContracts.filter(c => {
                let plantCount = 0;
                try {
                    const content = JSON.parse(c.content || '{}');
                    plantCount = content.plants_count || 0;
                } catch (e) {
                    const match = c.content.match(/(\d+)\s+plant/i);
                    if (match) plantCount = parseInt(match[1]);
                }
                return plantCount >= 5 && plantCount < 8;
            });
            
            if (pending.length === 0) {
                alert('No UMAPs ready for ORE activation');
                return;
            }
            
            alert(`There are ${pending.length} UMAPs pending ORE activation (5-7 plants).`);
            // Switch to ORE contracts tab
            switchTab('ore-contracts');
        }

        async function activateOREContract(contractId) {
            if (!confirm('Activate this ORE contract?')) {
                return;
            }
            
            // TODO: Call API to activate ORE contract
            alert('ORE contract activation - coming soon');
        }

        // Load permit definitions (kind 30500)
        async function loadPermitDefinitions() {
            try {
                // Use preloaded data if available
                if (preloadedOracleData && preloadedOracleData.definitions) {
                    console.log('‚úÖ Using preloaded permit definitions');
                    allPermitDefinitions = preloadedOracleData.definitions;
                } else {
                    console.log('üì° Fetching permit definitions from API');
                    const response = await fetch(`${USPOT_API_BASE}/api/permit/definitions`);
                    const data = await response.json();
                    allPermitDefinitions = data.definitions || [];
                }
                
                renderPermitDefinitions();
                populatePermitFilters();
            } catch (error) {
                console.error('Error loading permit definitions:', error);
                document.getElementById('permits-list').innerHTML = 
                    '<div class="status-message status-error">‚ùå Failed to load permits</div>';
            }
        }

        // Render permit definitions
        function renderPermitDefinitions() {
            const container = document.getElementById('permits-list');
            
            if (allPermitDefinitions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <p>No permit definitions available</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="permit-grid">
                    ${allPermitDefinitions.map(permit => `
                        <div class="permit-card">
                            <div class="permit-header">
                                <div>
                                    <div class="permit-title">${permit.name}</div>
                                    <div class="permit-id">${permit.id}</div>
                                </div>
                            </div>
                            <div class="permit-description">${permit.description}</div>
                            <div class="permit-meta">
                                <span class="badge">
                                    ‚úçÔ∏è ${permit.min_attestations} attestations required
                                </span>
                                <span class="badge badge-info">
                                    ‚è±Ô∏è Valid for ${permit.valid_duration_days === 0 ? 'unlimited' : permit.valid_duration_days + ' days'}
                                </span>
                                ${permit.revocable ? '<span class="badge badge-warning">‚ö†Ô∏è Revocable</span>' : ''}
                            </div>
                            <div class="action-buttons">
                                <button class="btn" onclick="showPermitHolders('${permit.id}')">
                                    üë• View Holders
                                </button>
                                <button class="btn btn-secondary" onclick="requestPermit('${permit.id}')">
                                    ‚ûï Request This Permit
                                </button>
                            </div>
                            <div id="holders-${permit.id}" class="holders-list" style="display: none;"></div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Show permit holders
        async function showPermitHolders(permitId) {
            const holdersDiv = document.getElementById(`holders-${permitId}`);
            
            if (holdersDiv.style.display === 'block') {
                holdersDiv.style.display = 'none';
                return;
            }

            holdersDiv.innerHTML = '<div class="loading">Loading holders...</div>';
            holdersDiv.style.display = 'block';

            try {
                // Fetch credentials (kind 30503) for this permit type
                const filter = {
                    kinds: [30503],
                    '#permit_id': [permitId],
                    limit: 100
                };

                const holders = [];
                const sub = nostrRelay.sub([filter]);

                const timeout = setTimeout(() => {
                    sub.unsub();
                    renderHolders(holders, holdersDiv);
                }, 5000);

                sub.on('event', (event) => {
                    holders.push(event);
                });

                sub.on('eose', () => {
                    clearTimeout(timeout);
                    sub.unsub();
                    renderHolders(holders, holdersDiv);
                });

            } catch (error) {
                console.error('Error loading holders:', error);
                holdersDiv.innerHTML = '<div class="status-message status-error">‚ùå Failed to load holders</div>';
            }
        }

        // Render holders
        function renderHolders(holders, container) {
            if (holders.length === 0) {
                container.innerHTML = '<div style="padding: 10px; color: var(--muted);">No holders yet</div>';
                return;
            }

            container.innerHTML = holders.map(holder => {
                const npub = NostrTools.nip19.npubEncode(holder.pubkey);
                const date = new Date(holder.created_at * 1000).toLocaleDateString();
                return `
                    <div class="holder-item">
                        <a href="/nostr_profile_viewer?hex=${holder.pubkey}" target="_blank" class="npub-link">
                            ${npub.substring(0, 12)}...${npub.substring(npub.length - 4)}
                        </a>
                        <span style="color: var(--muted); font-size: 0.85em;">
                            Issued: ${date}
                        </span>
                    </div>
                `;
            }).join('');
        }

        // Load permit requests (kind 30501)
        async function loadPermitRequests() {
            try {
                // Use preloaded data if available
                if (preloadedOracleData && preloadedOracleData.requests) {
                    console.log('‚úÖ Using preloaded permit requests');
                    allPermitRequests = preloadedOracleData.requests;
                } else {
                    console.log('üì° Fetching permit requests from API');
                    const response = await fetch(`${USPOT_API_BASE}/api/permit/list?type=requests`);
                    const data = await response.json();
                    allPermitRequests = data.requests || [];
                }
                
                renderPendingRequests();
            } catch (error) {
                console.error('Error loading permit requests:', error);
                document.getElementById('pending-requests-list').innerHTML = 
                    '<div class="status-message status-error">‚ùå Failed to load requests</div>';
            }
        }

        // Render pending requests
        function renderPendingRequests() {
            const container = document.getElementById('pending-requests-list');
            
            // Filter requests that need attestation from user's permits
            const requestsNeedingAttestation = allPermitRequests.filter(req => {
                // Check if user has the required permit to attest
                const permitDef = allPermitDefinitions.find(p => p.id === req.permit_definition_id);
                if (!permitDef || !permitDef.required_license) return false;
                
                // Check if user has this credential
                const hasCredential = myPermitCredentials.some(c => c.permit_definition_id === permitDef.required_license);
                
                // Check if user hasn't already attested
                const alreadyAttested = req.attestations?.some(a => a.attester_npub === userNpub);
                
                return hasCredential && !alreadyAttested && req.status === 'attesting';
            });

            if (requestsNeedingAttestation.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úÖ</div>
                        <p>No pending requests that need your attestation</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="request-list">
                    ${requestsNeedingAttestation.map(req => renderRequestCard(req)).join('')}
                </div>
            `;
        }

        // Render request card
        function renderRequestCard(req) {
            const permitDef = allPermitDefinitions.find(p => p.id === req.permit_definition_id);
            const progress = (req.attestations?.length || 0) / (permitDef?.min_attestations || 1) * 100;
            const applicantNpub = req.applicant_npub || NostrTools.nip19.npubEncode(req.applicant_did.split(':').pop());
            
            return `
                <div class="request-card">
                    <div class="request-header">
                        <div>
                            <div class="permit-title">${permitDef?.name || req.permit_definition_id}</div>
                            <div style="color: var(--muted); font-size: 0.9em; margin-top: 5px;">
                                Applicant: <a href="/nostr_profile_viewer?hex=${req.applicant_did.split(':').pop()}" 
                                              target="_blank" class="npub-link">
                                    ${applicantNpub.substring(0, 12)}...${applicantNpub.substring(applicantNpub.length - 4)}
                                </a>
                            </div>
                        </div>
                        <span class="badge">${req.status}</span>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <strong>Statement:</strong>
                        <p style="margin-top: 5px; color: var(--text);">${req.statement}</p>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: var(--muted); margin-bottom: 5px;">
                            <span>Attestations: ${req.attestations?.length || 0} / ${permitDef?.min_attestations || 0}</span>
                            <span>${Math.round(progress)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    
                    ${req.attestations && req.attestations.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong style="font-size: 0.9em; color: var(--muted);">Attestations:</strong>
                            ${req.attestations.map(att => `
                                <div class="attestation-item">
                                    <div style="font-size: 0.85em; color: var(--muted);">
                                        ${NostrTools.nip19.npubEncode(att.attester_npub).substring(0, 12)}...
                                    </div>
                                    <div style="margin-top: 5px;">${att.statement}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="action-buttons">
                        <button class="btn" onclick="openAttestModal('${req.request_id}')">
                            ‚úçÔ∏è Attest This Request
                        </button>
                    </div>
                </div>
            `;
        }

        // Load my permit credentials (kind 30503)
        async function loadMyPermitCredentials() {
            try {
                // Use preloaded data if available
                if (preloadedOracleData && preloadedOracleData.credentials) {
                    console.log('‚úÖ Using preloaded permit credentials');
                    myPermitCredentials = preloadedOracleData.credentials;
                } else {
                    console.log('üì° Fetching permit credentials from API');
                    const response = await fetch(`${USPOT_API_BASE}/api/permit/list?type=credentials&npub=${userNpub}`);
                    const data = await response.json();
                    myPermitCredentials = data.credentials || [];
                }
                
                renderMyPermits();
            } catch (error) {
                console.error('Error loading my permits:', error);
                document.getElementById('my-permits-list').innerHTML = 
                    '<div class="status-message status-error">‚ùå Failed to load your permits</div>';
            }
        }

        // Render my permits
        function renderMyPermits() {
            const container = document.getElementById('my-permits-list');
            
            if (myPermitCredentials.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéØ</div>
                        <p>You don't have any permits yet</p>
                        <button class="btn" onclick="openRequestModal()" style="margin-top: 20px;">
                            ‚ûï Request Your First Permit
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="permit-grid">
                    ${myPermitCredentials.map(cred => {
                        const permitDef = allPermitDefinitions.find(p => p.id === cred.permit_definition_id);
                        const issueDate = new Date(cred.issued_at).toLocaleDateString();
                        const expiryDate = cred.expires_at ? new Date(cred.expires_at).toLocaleDateString() : 'Never';
                        
                        return `
                            <div class="permit-card">
                                <div class="permit-header">
                                    <div>
                                        <div class="permit-title">${permitDef?.name || cred.permit_definition_id}</div>
                                        <div class="permit-id">${cred.credential_id}</div>
                                    </div>
                                    <span class="badge">${cred.status}</span>
                                </div>
                                <div class="permit-meta">
                                    <span class="badge badge-info">
                                        Issued: ${issueDate}
                                    </span>
                                    <span class="badge ${cred.expires_at ? 'badge-warning' : ''}">
                                        Expires: ${expiryDate}
                                    </span>
                                </div>
                                <div class="action-buttons">
                                    <button class="btn btn-secondary" onclick="viewCredential('${cred.credential_id}')">
                                        üìÑ View Credential
                                    </button>
                                    ${cred.expires_at ? `
                                        <button class="btn" onclick="renewPermit('${cred.permit_definition_id}')">
                                            üîÑ Renew
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Load my attestations
        async function loadMyAttestations() {
            const container = document.getElementById('my-attestations-list');
            
            // Filter requests where user has attested
            const myAttestations = allPermitRequests.filter(req => 
                req.attestations?.some(a => a.attester_npub === userNpub)
            );

            if (myAttestations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚úçÔ∏è</div>
                        <p>You haven't attested any requests yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="request-list">
                    ${myAttestations.map(req => {
                        const permitDef = allPermitDefinitions.find(p => p.id === req.permit_definition_id);
                        const myAttestation = req.attestations.find(a => a.attester_npub === userNpub);
                        const applicantNpub = req.applicant_npub || NostrTools.nip19.npubEncode(req.applicant_did.split(':').pop());
                        
                        return `
                            <div class="request-card">
                                <div class="request-header">
                                    <div>
                                        <div class="permit-title">${permitDef?.name || req.permit_definition_id}</div>
                                        <div style="color: var(--muted); font-size: 0.9em; margin-top: 5px;">
                                            For: ${applicantNpub.substring(0, 12)}...
                                        </div>
                                    </div>
                                    <span class="badge">${req.status}</span>
                                </div>
                                <div style="margin: 15px 0;">
                                    <strong>Your Attestation:</strong>
                                    <div class="attestation-item">
                                        ${myAttestation.statement}
                                    </div>
                                </div>
                                <div style="color: var(--muted); font-size: 0.85em;">
                                    Attested: ${new Date(myAttestation.created_at).toLocaleDateString()}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Populate permit filters
        function populatePermitFilters() {
            const permitFilter = document.getElementById('permit-filter');
            const requestFilter = document.getElementById('request-filter');
            const permitSelect = document.getElementById('permit-select');
            
            const options = allPermitDefinitions.map(p => 
                `<option value="${p.id}">${p.name}</option>`
            ).join('');
            
            if (permitFilter) {
                permitFilter.innerHTML += options;
            }
            if (requestFilter) {
                requestFilter.innerHTML += options;
            }
            if (permitSelect) {
                permitSelect.innerHTML += options;
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            const tabMap = {
                'permits': 'permits-tab',
                'my-permits': 'my-permits-tab',
                'pending-requests': 'pending-requests-tab',
                'my-attestations': 'my-attestations-tab',
                'ore-contracts': 'ore-contracts-tab',
                'admin': 'admin-tab-content'
            };
            
            document.getElementById(tabMap[tabName]).classList.add('active');
            event.target.classList.add('active');

            // Initialize map when ORE contracts tab is opened
            if (tabName === 'ore-contracts' && !oreMap) {
                setTimeout(() => initializeOREMap(), 300);
            }
        }

        // Open request modal
        function openRequestModal() {
            document.getElementById('request-modal').classList.add('active');
        }

        // Close request modal
        function closeRequestModal() {
            document.getElementById('request-modal').classList.remove('active');
            document.getElementById('request-form').reset();
        }

        // Submit request
        async function submitRequest(event) {
            event.preventDefault();
            
            const permitId = document.getElementById('permit-select').value;
            const statement = document.getElementById('statement').value;
            const evidence = document.getElementById('evidence').value.split(',').map(e => e.trim()).filter(e => e);
            
            try {
                const response = await fetch(`${USPOT_API_BASE}/api/permit/request`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        permit_definition_id: permitId,
                        applicant_email: userEmail || userNpub,
                        statement: statement,
                        evidence: evidence
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to submit request');
                }
                
                const result = await response.json();
                alert('‚úÖ Permit request submitted successfully!');
                closeRequestModal();
                
                // Reload data
                await loadAllData();
                switchTab('my-permits');
                
            } catch (error) {
                console.error('Error submitting request:', error);
                alert('‚ùå Failed to submit request: ' + error.message);
            }
        }

        // Open attest modal
        async function openAttestModal(requestId) {
            const request = allPermitRequests.find(r => r.request_id === requestId);
            if (!request) {
                alert('Request not found');
                return;
            }
            
            const permitDef = allPermitDefinitions.find(p => p.id === request.permit_definition_id);
            const applicantNpub = request.applicant_npub || NostrTools.nip19.npubEncode(request.applicant_did.split(':').pop());
            
            document.getElementById('attest-request-id').value = requestId;
            document.getElementById('attest-details').innerHTML = `
                <div class="card">
                    <div class="permit-title">${permitDef?.name || request.permit_definition_id}</div>
                    <div style="margin: 10px 0;">
                        <strong>Applicant:</strong> ${applicantNpub.substring(0, 12)}...
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Statement:</strong>
                        <p style="margin-top: 5px;">${request.statement}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('attest-modal').classList.add('active');
        }

        // Close attest modal
        function closeAttestModal() {
            document.getElementById('attest-modal').classList.remove('active');
            document.getElementById('attest-form').reset();
        }

        // Submit attestation
        async function submitAttestation(event) {
            event.preventDefault();
            
            const requestId = document.getElementById('attest-request-id').value;
            const statement = document.getElementById('attest-statement').value;
            
            try {
                const response = await fetch(`${USPOT_API_BASE}/api/permit/attest`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        request_id: requestId,
                        attester_email: userEmail || userNpub,
                        statement: statement
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to submit attestation');
                }
                
                const result = await response.json();
                alert('‚úÖ Attestation submitted successfully!');
                closeAttestModal();
                
                // Reload data
                await loadAllData();
                
            } catch (error) {
                console.error('Error submitting attestation:', error);
                alert('‚ùå Failed to submit attestation: ' + error.message);
            }
        }

        // Request permit (shortcut)
        function requestPermit(permitId) {
            document.getElementById('permit-select').value = permitId;
            openRequestModal();
        }

        // Renew permit
        function renewPermit(permitId) {
            requestPermit(permitId);
        }

        // View credential
        async function viewCredential(credentialId) {
            window.open(`${USPOT_API_BASE}/api/permit/credential/${credentialId}`, '_blank');
        }

        // Refresh requests
        async function refreshRequests() {
            document.getElementById('pending-requests-list').innerHTML = '<div class="loading"></div>';
            await loadPermitRequests();
        }

        // Filter permits
        function filterPermits() {
            // TODO: Implement filtering
        }

        // Filter requests
        function filterRequests() {
            // TODO: Implement filtering
        }

        // Toggle technical details
        function toggleTechnicalDetails() {
            const details = document.getElementById('technical-details');
            const button = event.target;
            
            if (details.classList.contains('active')) {
                details.classList.remove('active');
                button.textContent = 'üîß Show Technical Details';
            } else {
                details.classList.add('active');
                button.textContent = 'üîß Hide Technical Details';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            detectUSPOTAPI();
        });
    </script>
</body>
</html>

